## å®ç°æ•´é¡¹CRUD

### updatejson  å·²å®ç°



### ç–‘é—®ç‚¹ï¼š

```js
<script data-main="../../js/gx/gx_layuitable.js" src='../../sys/require.min.js'></script>
```

- `<script data-main = "" src="">` æ ‡ç­¾ä¸­çš„data-main ä»£è¡¨çš„æ˜¯ä¸»è¦çš„æ•°æ®æ¥æºå—ï¼Ÿ å›ºå®šå†™æ³•ï¼Ÿsrcä¸­çš„å†…å®¹æ›¿æ¢ä¸ºdata-mainä¸­çš„å†…å®¹ä¹Ÿå¯ä»¥æ‰§è¡Œ



## MyRule ï¼ˆé€‚åˆå¤æ‚çš„CRUDï¼‰

ç°æœ‰çš„æ¶ˆæ¯ç±»å‹ä¸èƒ½æ»¡è¶³ä¸šåŠ¡éœ€æ±‚

![image-20250728113537312](06.crudã€å¤æ‚è§„åˆ™myruleå’ŒDButilç±».assets/image-20250728113537312.png)

### åŸºæœ¬æ ¼å¼è¯´æ˜ï¼š

- å£°æ˜äº†myruleæ¶ˆæ¯ç±»å‹å  éœ€è¦ç´§è·Ÿä¸€ä¸ª classMethod  ä¸ºäº†è§„èŒƒ åŒ…ä¸‹wrulesä¸‹çš„åˆ›å»ºçš„ç±»çš„æ–¹æ³• 

- éœ€è¦æ³¨æ„çš„æ˜¯è¿™ä¸ªç±»éœ€è¦å®ç°Ruleæ¥å£(æ–‡æ¡£é‡Œé¢è¦æ±‚)ï¼šå¦‚ä¸‹

  ```java
  public static String getMenuList(String[] p, String[] cp, HttpServletRequest request, HttpServletResponse response) 
  ```

  éœ€è¦æ³¨æ„çš„æ˜¯  è¿™ä¸ªæ¥å£é‡Œé¢çš„æ–¹æ³•çš„å‚æ•°éƒ½æ˜¯å•¥æ„æ€?  è¿˜æœ‰ä¸ºä»€ä¹ˆè¦ä½¿ç”¨staticï¼Ÿ  å¯åŠ¨å‰å°±åŠ è½½  ä¸æ˜¯å¾ˆæµªè´¹å†…å­˜å—ï¼Ÿ

  > å‚æ•°ï¼š
  >
  > p:   ä½¿ç”¨äº†myruleæ¶ˆæ¯ä½“çš„è¯ï¼Œå‰ç«¯è¯·æ±‚äº†æ¥å£  æ­¤æ—¶ä¼šå°†ä¼ é€’çš„å‚æ•°ç»™åˆ°msgwhere(è¿™é‡Œä¼ é€’çš„æ˜¯id)
  >
  > ä¹Ÿå°±è¯´æ˜äº†å‰ç«¯è¯·æ±‚çš„æ˜¯$.msgwhere(objwhere)
  >
  > ![image-20250728140339890](06.crudã€å¤æ‚è§„åˆ™myruleå’ŒDButilç±».assets/image-20250728140339890.png)
  >
  > å¯¹äºåç«¯ï¼Œè¯¥å¦‚ä½•è§£æä»è€Œå¾—åˆ°è¦çš„å‚æ•°å‘¢ï¼Ÿ
  >
  > é€šè¿‡æŸ¥çœ‹ `DeptRule.java` å¾—åˆ°ä¼šä½¿ç”¨`JSONObject(p[0]).optJSONOBject("msg_where")` æ¥å¾—åˆ°æˆ‘ä»¬æƒ³è¦çš„å‚æ•°å¯¹è±¡ï¼Œå†é€æ­¥è·å–æƒ³è¦çš„å€¼  å†ä½¿ç”¨
  >
  > cp  ä¸€èˆ¬ä¼šæºå¸¦å¯¹åº”çš„æ•°æ®åº“ç±»å‹

### ç–‘é—®ï¼š

1. $.msgwhere(obj1,obj2)  å¯ä»¥ä¼ é€’ä¸¤ä¸ªå¯¹è±¡ï¼Œç›®å‰åªçŸ¥é“ç¬¬ä¸€ä¸ªobjçš„æ¥æ”¶å’Œè·å–æ•°æ®ï¼Œå³ä½¿ä¼ é€’äº†åœ¨æ‰“å°å°è·å–ä¸äº†ç›¸åº”çš„å¯¹è±¡ï¼Œåˆæ­¥åˆ¤æ–­åŸå› æ˜¯ æ¶ˆæ¯å†…å®¹éƒ¨åˆ†ä½¿ç”¨çš„æ˜¯   #0#  ä½†æ˜¯ä½¿ç”¨16%åˆ†å‰² ç„¶åä½¿ç”¨#1# å»å ä½è¿˜æ˜¯è·å–ä¸åˆ°ç›¸åº”çš„å€¼ï¼Ÿ
2. 

### ç¤ºä¾‹ä¸åŸºæœ¬æ­¥éª¤

![image-20250728113925295](06.crudã€å¤æ‚è§„åˆ™myruleå’ŒDButilç±».assets/image-20250728113925295.png)

- ä½¿ç”¨string æˆ–è€…stringBuilder  å†æˆ–è€…stringBuffer å»å­˜å‚¨sqlè¯­å¥
- å¯¼å…¥DButilå·¥å…·ç±»  ä½¿ç”¨å·¥å…·ç±»ä¸­çš„æ–¹æ³•   å…¶ä¸­çš„å¾ˆå¤šé‡è¦æ–¹æ³•å‚è€ƒ ğŸ‰[DButil](https://apifox.com/apidoc/shared/98badc4f-73a4-4f9c-ac97-0248ed8f5d2f/doc-4861017)

### è¿”å›è¯´æ˜

é¦–å…ˆéœ€è¦new ä¸€ä¸ª JSONObjectå¯¹è±¡

è®¾ç½®çŠ¶æ€ç 

è®¾ç½®msg

è®¾ç½®éœ€è¦è¿”å›çš„æ•°æ®

## ä»Šæ—¥ä»£ç 

```js
// é…ç½®å¥½åŸºç¡€çš„æ¨¡å—
// æ·»åŠ gx.htmlé‡Œé¢çš„ç‚¹å‡»äº‹ä»¶
// å‘åç«¯å‘é€æ¶ˆæ¯
require.config({
    paths: {
        jquery: '../../sys/jquery',
        system: '../../sys/system',
        layui: "../../layui-btkj/layui",
    },
    shim: {
        "system": {
            deps: ["jquery"]
        },
        "layui": {
            deps: ["jquery", "system"]
        },
        "config": {
            deps: ["layui"]
        }
    },
    waitSeconds: 0
});

require(["jquery", "system", "layui"], function () {
    layui.use(['table'], function () {

        // myruleçš„ä½¿ç”¨
        $("#btnMyRule").click(function () {
            // æ‹¿åˆ°è¾“å…¥æˆ–è€…è¦ä¼ é€’çš„å‚æ•°
            objwhere ={}
            objwhere.category_name = ["é›¶"];
            objwhere.id = [];

            objwheretest = {}
            objwheretest.id = [Arg("id") || 5];
            
            $.sm(function (re, err) {
                if (err) {
                    layui.msg(err);
                }
                console.log(re);
            }, ["gx.myrule", $.msgArrwhere(objwhere,objwheretest)])  // å½“æœ‰å¤šä¸ªå‚æ•°æ—¶ï¼Œå¯ä»¥åœ¨å‰é¢å£°æ˜å˜é‡ æ­¤å¤„ç”¨äºå­¦ä¹ 
        });
    });
});
```

```xml
   <msg id="gx.myrule" type="myrule" v="#0#16%#1#" classMethod="com.btkj.admin.wrules.MenuRule.getMenuList">
        </msg>
```

```java
package com.btkj.admin.wrules;

import com.whoami.db.DBUtil;
import com.whoami.service.Rule;
import com.whoami.util.StringUtil;
import lombok.extern.slf4j.Slf4j;
import org.json.JSONArray;
import org.json.JSONException;
import org.json.JSONObject;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import java.util.Arrays;

@Slf4j
public class MenuRule implements Rule {

    public static String getMenuList(String[] p, String[] cp, HttpServletRequest request, HttpServletResponse response) throws JSONException
    {
        JSONObject rsp = new JSONObject();

        String sqlSelectProductByCategoryName =
                " select pro.product_name, pr.cost_price,pr.sale_price,cat.category_name from product_price pr " +
                " join product_category cat on cat.id = pr.id " +
                " join product pro on pro.category3_id = cat.id " +
                " where pr.isdel=1 ";

        JSONObject msgwhere = new JSONObject(p[0]).optJSONObject("msg_where");
        JSONArray categoryName = msgwhere.optJSONArray("category_name"); // æ³¨æ„è¿™æ˜¯å‰ç«¯ä¼ é€’è¿‡æ¥çš„ id å‡å¦‚æœ‰å¤šä¸ªå‚æ•°å‘¢ï¼Ÿ
        JSONArray productId = msgwhere.optJSONArray("id"); // å…·ä½“å•†å“id

        if (null != categoryName && !categoryName.isEmpty()) {
            // è·å–å‚æ•°
            String keyword = categoryName.optString(0);  // è·å–å‚æ•°
            if (!StringUtil.isEmpty(keyword)) {
                sqlSelectProductByCategoryName  += " and  cat.category_name like '%" + keyword + "%'";
            }
        }

        if(null != productId && !productId.isEmpty()){
            String categoryId = productId.optString(0);
            if(!StringUtil.isEmpty(categoryId)){
                sqlSelectProductByCategoryName += " and pro.id = '" + productId + "'";
            }
        }

        rsp.put("code", 0);
        rsp.put("msg", "æˆåŠŸ");
        JSONArray data = DBUtil.selectArray("w", "", sqlSelectProductByCategoryName); // è¿”å›æ•°æ®
        rsp.put("data", data);

        return rsp.toString();
    }
}
```

## DButilå·¥å…·ç±»æ–¹æ³•åˆ†æ

### 1ã€æ‰¹é‡æŸ¥è¯¢æŸ¥è¯¢(selectResultSetJSON)

#### æ–¹æ³•è§£è¯»

**1ã€å‚æ•°å¤„ç†ä¸æ•°æ®åº“è¿æ¥ï¼š**

â€‹	æ¥æ”¶dtypeï¼ˆæ•°æ®åº“ç±»å‹ï¼‰ã€didï¼ˆæ•°æ®åº“æ ‡è¯†ï¼‰å’Œsqlï¼ˆSQLè¯­å¥ï¼‰ä½œä¸ºå‚æ•°ã€‚

â€‹	è°ƒç”¨DB.getConè·å–æ•°æ®åº“è¿æ¥ï¼Œè‹¥è¿æ¥å¤±è´¥åˆ™è¿”å›ç©ºåˆ—è¡¨ã€‚

**2ã€æ‰§è¡ŒSQLå¹¶å¤„ç†ç»“æœé›†ï¼š**

â€‹	ä½¿ç”¨CallableStatementæ‰§è¡ŒSQLè¯­å¥ã€‚

â€‹	éå†ç»“æœé›†ï¼Œ**å°†æ¯ä¸€è¡Œæ•°æ®è½¬æ¢ä¸ºJSONObjectï¼Œå¹¶å­˜å‚¨åœ¨JSONArrayä¸­ã€‚**

â€‹	å°†JSONArrayåŠç›¸å…³å…ƒä¿¡æ¯å°è£…ä¸ºJSONObjectï¼Œæ·»åŠ åˆ°ç»“æœåˆ—è¡¨ã€‚

**3ã€å¼‚å¸¸å¤„ç†ä¸èµ„æºé‡Šæ”¾ï¼š**

â€‹	æ•è·å¼‚å¸¸å¹¶è®°å½•é”™è¯¯æ—¥å¿—ã€‚

â€‹	åœ¨finallyå—ä¸­å…³é—­æ•°æ®åº“èµ„æºï¼ˆCallableStatementã€ResultSetã€Connectionï¼‰ã€‚

**4ã€è¿”å›å€¼ï¼š**

â€‹	è¿”å›åŒ…å«JSONå¯¹è±¡çš„åˆ—è¡¨ï¼Œæ¯ä¸ªå¯¹è±¡åŒ…å«ç»“æœé›†æ•°æ®åŠå…¶é•¿åº¦ã€‚

### 2ã€æ‰¹é‡æ‰§è¡Œsql(ExecuteSqls)

#### æ–¹æ³•è§£è¯»

1. åˆå§‹åŒ–é˜¶æ®µ
å…³é—­æ•°æ®åº“è¿æ¥çš„è‡ªåŠ¨æäº¤åŠŸèƒ½ï¼Œå¼€å¯äº‹åŠ¡æ§åˆ¶
åˆ›å»º ArrayList ç”¨äºå­˜å‚¨æ‰§è¡Œç»“æœ
2. æ‰¹é‡å¤„ç†é˜¶æ®µ
éå†ä¼ å…¥çš„ SQL è¯­å¥åˆ—è¡¨ sqllist
å¯¹æ¯æ¡ SQL è¯­å¥ï¼š
å°†å…¶æ·»åŠ åˆ°æ‰¹å¤„ç†å‘½ä»¤ä¸­ï¼ˆaddBatchï¼‰
åŒæ—¶è¿½åŠ åˆ° sql å­—ç¬¦ä¸²ä¸­ï¼ˆç”¨äºæ—¥å¿—è®°å½•ï¼‰
3. æ‰§è¡Œé˜¶æ®µ
è°ƒç”¨ executeBatch() æ‰§è¡Œæ‰€æœ‰æ‰¹å¤„ç†è¯­å¥
è·å–æ¯æ¡è¯­å¥å½±å“çš„è¡Œæ•°æ•°ç»„ results
å°†ç»“æœå°è£…ä¸º JSON å¯¹è±¡å¹¶æ·»åŠ åˆ°è¿”å›åˆ—è¡¨ä¸­
4. äº‹åŠ¡å¤„ç†
è‹¥æ‰§è¡ŒæˆåŠŸï¼šæäº¤äº‹åŠ¡ï¼ˆcommitï¼‰
è‹¥å‡ºç°å¼‚å¸¸ï¼šå›æ»šäº‹åŠ¡ï¼ˆrollbackï¼‰å¹¶è®°å½•é”™è¯¯æ—¥å¿—
5. èµ„æºæ¸…ç†
æœ€ç»ˆå…³é—­æ•°æ®åº“è¿æ¥



























