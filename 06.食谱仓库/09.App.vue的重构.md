文件对于不同的平台没有很好的分离，代码可读性太低了，可以将不同的平台的执行代码封装到一个方法当中，然后针对不同的平台进行调用 @D:/gongxi_work/workspace/warehouse/uni-warehouse/App.vue





```vue
<script>
	import {
		aesEncrypt
	} from "@/common/ase.js"
	import global from './globaldata'
	import util from "./common/util.js"
	import smutil from './util/smutil.js'

	let _this

	export default {
		data() {
			return {}
		},

		onLaunch: async function() {
			_this = this
			this.initializeApp()
		},

		globalData: {
			inventoryTagList: null,
			waitlogin: true,
			code: '',
			headers: {},
			services: {
				auth: ''
			},
			objuserinfo: null,
			sysinfo: null,
			navHeight: 0,
			navTop: 0,
			windowHeight: 0,

			loginByToken(token, cb) {
				if (token) {
					const param = {
						zhtype: _this.globalData.xcxtype,
						logintype: "autologin",
						token: token
					}
					_this.globalData.applogin(param, null, cb)
				} else {
					cb && cb()
				}
			},

			getUserInfoBack(obj) {
				console.log(obj)

				if (obj && obj.sid) {
					uni.setStorageSync('curmobile', obj.objuser.mobile)
					uni.setStorageSync('token', obj.token)
					if (obj.openid || obj.objuser.openid_xcx) {
						uni.setStorageSync('curopenid', obj.openid || obj.objuser.openid_xcx)
					}

					// #ifdef MP-WEIXIN
					_this.globalData.headers['Cookie'] = 'JSESSIONID=' + obj.sid
					// #endif

					_this.globalData.objuserinfo = obj.objuser
					_this.globalData.code = obj.code
					console.log("objuserinfo", _this.globalData.objuserinfo)

					_this.globalData.waitlogin = false

					if (_this.globalData.userInfoReadyCallback) {
						_this.globalData.userInfoReadyCallback()
						_this.globalData.userInfoReadyCallback = null
					}
				}
			},

			getCurBindStu(cb) {
				const userid = _this.globalData.objuserinfo.id

				this.sm(
					(re, err) => {
						if (err) return uni.msg(err)
						_this.globalData.objuserinfo.curstu = re
						cb && cb()
					},
					["stu.selectcurbingstu", userid], {
						route: uni.svs.zxx_home_biz
					}
				)
			},

			applogin(param, succb, errcb) {
				const pobj = {
					route: uni.svs.auth,
					action: 'login/applogin',
					method: 'POST',
					datastring: true
				}

				this.smaction((re, err, obj) => {
					uni.hideLoading()

					if (err) {
						// #ifdef MP-WEIXIN
						if (obj.sid) {
							_this.globalData.headers['Cookie'] = 'JSESSIONID=' + obj.sid
						}
						// #endif

						if (param.logintype === "autologin" && errcb) {
							errcb()
						} else {
							console.log('未登录:', obj)
							if (getCurrentPages()[0].route !== 'pages/login/login') {
								setTimeout(() => {
									uni.reLaunch({
										url: "/pages/login/login"
									})
								}, 1000)
							}
						}
					} else {
						_this.globalData.getUserInfoBack(re)
						succb && succb()
					}
				}, param, pobj)
			},

			geturl(route, action) {
				if (_this.globalData.selfsevice && _this.globalData.selfsevice["/" + route]) {
					return _this.globalData.selfsevice["/" + route].target + '/' + action
				}
				return _this.globalData.requrl + '/' + action
			},

			smaction(cb, param, pobj) {
				if (typeof cb === 'object') {
					[cb, param] = [param, cb]
				}

				if (!pobj || !pobj.action) {
					return cb(null, '路由不能为空')
				}

				const token = uni.getStorageSync('token')
				if (token) {
					param.Authorization = 'Bearer ' + token
				}

				const url = '/' + pobj.route + '/' + pobj.action

				uni.request({
					url: _this.globalData.geturl(pobj.route || "", pobj.action),
					method: pobj.method || "GET",
					data: pobj.datastring ? JSON.stringify(param) : param,
					header: _this.globalData.headers,
					success(res) {
						if (!res.data) {
							return cb(null, '请求失败')
						}

						if (res.data.code) {
							const result = res.data.data ? JSON.parse(res.data.data) : {}
							if (res.data.code === 200) {
								return cb(result || res.data.msg, null, result || res.data.msg)
							} else {
								return cb(null, res.data.msg, result)
							}
						}

						const strtype = Object.prototype.toString.apply(res.data.data)

						if (strtype === '[object Array]') {
							cb(res.data)
						} else if (strtype === '[object Object]') {
							if (res.data.error || res.data.code === 500) {
								console.log('请求数据', param)
								console.log('请求服务', pobj)
								console.log(res.data)

								if (res.data.error === "nologin") {
									return uni.navigateTo({
										url: "/pages/login/login"
									})
								}

								cb(res.data, res.data.error || res.data.msg, res.data)
							} else {
								cb(res.data.re || res.data, res.data.error, res.data)
							}
						} else {
							cb(null, res.data.error || res.data.msg, res.data)
						}
					},
					fail() {
						cb(null, '请求失败')
					}
				})
			},

			sm(cb, arr, pobj) {
				if (typeof cb === 'object') {
					[cb, arr] = [arr, cb]
				}

				let strp = ''
				let ismul = 0
				let msgid = ''

				if (typeof arr[0] === 'object') {
					ismul = 1
					const arr2 = []

					for (let i = 0; i < arr.length; i++) {
						for (let j = 0; j < arr[i].length; j++) {
							if (typeof arr[i][j] === 'object') {
								arr[i][j] = JSON.stringify(arr[i][j])
							}
						}
						arr2.push(smutil.encodeArr(arr[i]).join('%15'))
					}

					strp = arr2.join('%18')
				} else {
					for (let j = 0; j < arr.length; j++) {
						if (typeof arr[j] === 'object') {
							arr[j] = JSON.stringify(arr[j])
						}
					}
					msgid = arr[0]
					strp = smutil.encodeArr(arr).join('%15')
				}

				const data = {
					"isspChar": 1,
					arr: strp,
					lan: 'zh'
				}

				if (ismul) {
					data.ismul = ismul
				}

				if (!pobj) {
					pobj = {}
				}

				data.msgid = (pobj && pobj.msgid) || msgid || ''

				if (pobj && pobj.trans) {
					data.trans = pobj.trans
				}

				if (pobj && pobj.rpc) {
					data.rpc = pobj.rpc
				}

				const token = uni.getStorageSync('token')
				if (token) {
					data.Authorization = 'Bearer ' + token
				}

				let url = '/Enter'
				if (pobj && pobj.route) {
					url = '/' + pobj.route + url
				}

				uni.request({
					// #ifdef H5
					url: url,
					// #endif
					// #ifndef H5
					url: _this.globalData.geturl(pobj.route || "", "Enter"),
					// #endif
					data: data,
					// #ifndef H5
					header: _this.globalData.headers,
					// #endif
					success(res) {
						console.log(res)

						if (!res.data) {
							return cb(null, '请求失败')
						}

						if (res.data.code) {
							if (res.data.code === 200) {
								const result = JSON.parse(res.data.data)
								return cb(result, null, result)
							} else {
								return cb(null, res.data)
							}
						}

						const strtype = Object.prototype.toString.apply(res.data)

						if (strtype === '[object Array]') {
							cb(res.data)
						} else if (strtype === '[object Object]') {
							if (res.data.error || res.data.code === 500) {
								console.log(strp)
								console.log(res.data)

								if (res.data.error === "nologin") {
									return uni.navigateTo({
										url: "/pages/login/login"
									})
								}

								cb(res.data, res.data.error || res.data.msg, res.data)
							} else {
								cb(res.data.re || res.data, res.data.error, res.data)
							}
						} else {
							cb(null, res.data.error || res.data.msg, res.data)
						}
					},
					fail() {
						cb(null, '请求失败')
					}
				})
			},

			smsync(arr, pobj) {
				let strp = ''
				let ismul = 0
				let msgid = ''

				if (typeof arr[0] === 'object') {
					ismul = 1
					const arr2 = []

					for (let i = 0; i < arr.length; i++) {
						for (let j = 0; j < arr[i].length; j++) {
							if (typeof arr[i][j] === 'object') {
								arr[i][j] = JSON.stringify(arr[i][j])
							}
						}
						arr2.push(smutil.encodeArr(arr[i]).join('%15'))
					}

					strp = arr2.join('%18')
				} else {
					for (let j = 0; j < arr.length; j++) {
						if (typeof arr[j] === 'object') {
							arr[j] = JSON.stringify(arr[j])
						}
					}
					msgid = arr[0]
					strp = smutil.encodeArr(arr).join('%15')
				}

				const data = {
					arr: strp,
					lan: 'zh'
				}

				if (ismul) {
					data.ismul = ismul
				}

				data.msgid = (pobj && pobj.msgid) || msgid || ''

				if (pobj && pobj.trans) {
					data.trans = pobj.trans
				}

				if (pobj && pobj.rpc) {
					data.rpc = pobj.rpc
				}

				const token = uni.getStorageSync('token')
				if (token) {
					data.Authorization = 'Bearer ' + token
				}

				let url = '/Enter'

				return new Promise(function(resolve, reject) {
					if (pobj && pobj.route) {
						url = '/' + pobj.route + url
					} else {
						reject({
							re: null,
							err: '路由不能为空',
							obj: null
						})
						return
					}

					uni.request({
						// #ifdef H5
						url: url,
						// #endif
						// #ifndef H5
						url: _this.globalData.geturl(pobj.route, "Enter"),
						// #endif
						data: data,
						// #ifndef H5
						header: _this.globalData.headers,
						// #endif
						success(res) {
							if (!res.data) {
								uni.showToast({
									title: '请求失败',
									icon: 'none',
									duration: 2000
								})
								reject({
									re: null,
									err: '请求失败'
								})
								return
							}

							if (res.data.code) {
								if (res.data.code === 200) {
									const result = JSON.parse(res.data.data)
									resolve({
										re: result,
										err: null,
										obj: res.data
									})
								} else {
									reject({
										re: null,
										err: res.data.msg,
										obj: res.data
									})
								}
								return
							}

							const strtype = Object.prototype.toString.apply(res.data)

							if (strtype === '[object Array]') {
								resolve({
									re: res.data
								})
							} else if (strtype === '[object Object]') {
								if (res.data.error || res.data.code === 500) {
									console.error(strp)
									console.error(res.data)
									uni.showToast({
										title: res.data.error,
										icon: 'none',
										duration: 2000
									})
									reject({
										re: null,
										err: res.data.error || res.data.msg,
										obj: res.data
									})
								} else {
									resolve({
										re: res.data.re || res.data,
										err: res.data.error || res.data.msg,
										obj: res.data
									})
								}
							} else {
								resolve({
									re: null,
									err: null,
									obj: res.data
								})
							}
						},
						fail() {
							uni.showToast({
								title: '请求失败',
								icon: 'none',
								duration: 2000
							})
							reject({
								re: null,
								err: '请求失败'
							})
						}
					})
				})
			},

			confirm(p1, p2, p3) {
				if (p3) {
					this.alert(p1, p2, p3, true)
				} else {
					this.alert('提示', p1, p2, true, false)
				}
			},

			prompt(p1, p2, p3) {
				if (p3) {
					this.alert(p1, p2, p3, true, true)
				} else {
					this.alert('提示', p1, p2, true, true)
				}
			},

			alert(p1, p2, p3, showCancel, editable) {
				let title = '提示'
				let content = ''
				let cb = null

				if (!p1) {
					return
				}

				if (!p2 && p2 !== "") {
					content = p1
				} else {
					if (!p3) {
						if (typeof p2 === 'string') {
							title = p1
							content = p2
						} else {
							content = p1
							cb = p2
						}
					} else {
						title = p1
						content = p2
						cb = p3
					}
				}

				uni.showModal({
					title: title,
					content: content + '',
					showCancel: showCancel || false,
					editable: editable || false,
					success(res) {
						if (res.confirm) {
							if (cb) {
								cb(res)
							}
						}
					}
				})
			},

			msg(title) {
				uni.showToast({
					title: title + '',
					icon: 'none',
					style: "z-index: 99999;",
					duration: 2000
				})
			},

			getPrePage(n = -1) {
				n = n < -1 ? n : -1
				const pages = getCurrentPages()
				let beforePage = pages[pages.length - (-(n - 1))]

				// #ifndef H5
				beforePage = beforePage.$vm
				// #endif

				return beforePage
			},

			msgwhere(obj1, obj2) {
				let obj = {}
				if (obj1) {
					obj = Object.assign(obj, obj1)
				}
				if (obj2) {
					obj = Object.assign(obj, obj2)
				}
				return JSON.stringify({
					msg_where: obj
				})
			},

			msgArrwhere(arr) {
				return JSON.stringify({
					msg_where: arr
				})
			},

			msgpJoin(arr) {
				const arrnew = []
				for (let i = 0; i < arr.length; i++) {
					arrnew.push([arr[i]])
				}
				return arrnew
			}
		},

		methods: {
			initializeApp() {
				this.checkUpdate()
				this.initGlobalData()
				this.registerGlobalMethods()

				const credentials = this.getStoredCredentials()
				this.logCredentials(credentials)

				this.performLogin(credentials)
				this.initSystemInfo()
			},

			initGlobalData() {
				Object.keys(global).forEach(key => {
					if (Object.hasOwnProperty.call(global, key)) {
						this.globalData[key] = global[key]
					}
				})
			},

			registerGlobalMethods() {
				uni.sm = this.globalData.sm
				uni.smsync = this.globalData.smsync
				uni.smaction = this.globalData.smaction
				uni.alert = this.globalData.alert
				uni.msg = this.globalData.msg
				uni.confirm = this.globalData.confirm
				uni.prompt = this.globalData.prompt
				uni.getPrePage = this.globalData.getPrePage
				uni.msgwhere = this.globalData.msgwhere
				uni.msgArrwhere = this.globalData.msgArrwhere
				uni.msgpJoin = this.globalData.msgpJoin
				uni.svs = this.globalData.services
			},

			getStoredCredentials() {
				return {
					mobile: uni.getStorageSync('curmobile') || "",
					openid: uni.getStorageSync('curopenid') || "",
					token: uni.getStorageSync('token') || ""
				}
			},

			logCredentials({
				mobile,
				openid,
				token
			}) {
				console.log("mobile:", mobile)
				console.log("openid:", openid)
				console.log("token:", token)
			},

			performLogin({
				token,
				openid
			}) {
				_this.globalData.loginByToken(token, () => {
					this.handlePlatformLogin(openid)
				})
			},

			handlePlatformLogin(openid) {
				// #ifdef MP-WEIXIN
				this.wechatMiniProgramLogin()
				// #endif

				// #ifndef MP-WEIXIN
				this.otherPlatformLogin(openid)
				// #endif
			},

			wechatMiniProgramLogin() {
				uni.login({
					success: async (res) => {
						console.log(JSON.stringify(res))

						const param = {
							zhtype: _this.globalData.xcxtype,
							logintype: "loginBycode",
							logincode: res.code
						}

						_this.globalData.applogin(param)
					}
				})
			},

			otherPlatformLogin(openid) {
				const param = {
					zhtype: _this.globalData.xcxtype,
					logintype: "loginByopenid",
					openid: openid
				}

				_this.globalData.applogin(param)
			},

			initSystemInfo() {
				this.globalData.sysinfo = uni.getSystemInfoSync()

				// #ifdef MP-WEIXIN
				this.initWechatNavigationBar()
				// #endif
			},

			initWechatNavigationBar() {
				const menuButtonObject = uni.getMenuButtonBoundingClientRect()
				const statusBarHeight = this.globalData.sysinfo.statusBarHeight
				const navTop = menuButtonObject.top
				const navHeight = statusBarHeight + menuButtonObject.height +
					(menuButtonObject.top - statusBarHeight) * 2

				this.globalData.navHeight = navHeight
				this.globalData.navTop = navTop
				this.globalData.windowHeight = this.globalData.sysinfo.windowHeight
			},

			checkLogin() {
				return _this.globalData.code === 0
			},

			checkUpdate() {
				// #ifdef MP-WEIXIN
				this.wechatCheckUpdate()
				// #endif
			},

			wechatCheckUpdate() {
				const updateManager = uni.getUpdateManager()

				updateManager.onCheckForUpdate((res) => {
					console.log("是否有更新:", res.hasUpdate)
				})

				updateManager.onUpdateReady(() => {
					uni.showModal({
						title: '更新提示',
						content: '新版本已经准备好，是否重启应用？',
						success(res) {
							if (res.confirm) {
								updateManager.applyUpdate()
							}
						}
					})
				})

				updateManager.onUpdateFailed((res) => {
					console.error('新的版本下载失败', res)
				})
			}
		}
	}
</script>

<style lang="scss">
	@import '@/uni_modules/uni-scss/index.scss';

	/* #ifndef APP-NVUE */
	@import '@/static/customicons.css';
	@import '@/static/iconfont.css';
	@import '@/static/weui.css';
	@import '@/common/fui-app.css';
	@import '@/components/firstui/fui-theme/fui-theme.css';

	page {
		background-color: #f5f5f5;
	}

	/* #endif */

	.example-info {
		font-size: 14px;
		color: #333;
		padding: 10px;
	}
</style>
```

