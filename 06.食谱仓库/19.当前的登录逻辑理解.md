我来为你详细讲解这个登录系统的逻辑架构：

## 整体登录逻辑流程

### 1. **应用启动流程 (App.vue - onLaunch)**

```
应用启动
  ↓
读取本地存储(mobile, openid, token)
  ↓
尝试通过token自动登录 → loginByToken()
  ↓
登录成功 → getUserInfoBack() → 设置全局用户信息
  ↓
登录失败 → 跳转到登录页面
```

### 2. **Token登录机制 (loginByToken)**

当前代码中，这部分逻辑**被注释掉了**：

```javascript
// 原本应该执行的逻辑:
loginByToken(token, cb){
    if(token){
        // 1. 设置Authorization请求头
        _this.globalData.headers['Authorization'] = 'Bearer ' + token;
        
        // 2. 调用自动登录接口
        var param = {
            zhtype: _this.globalData.xcxtype, 
            logintype: "autologin"  // 关键：自动登录类型
        }
        _this.globalData.applogin(param, null, cb);
    } else {
        cb && cb();
    }
}
```

**问题所在**：注释后，即使有token也不会自动登录，导致页面刷新后用户信息丢失。

### 3. **登录页面逻辑 (login.vue)**

支持三种登录方式：

#### A. 账号密码登录

```
用户输入账号+密码
  ↓
调用 handleAccountLogin()
  ↓
参数: {
    zhtype: 'xxx',
    logintype: "loginByPassword",
    username: "用户名",
    password: "密码"
}
  ↓
调用 app.globalData.applogin()
  ↓
成功 → getUserInfoBack() → 存储token到本地
```

#### B. 二维码登录

```
生成二维码(virtualUnionId + timestamp)
  ↓
用户扫码
  ↓
后端识别二维码内容
  ↓
返回登录信息
```

#### C. 人脸登录（未实现）

### 4. **核心登录方法 applogin()**

```javascript
applogin: function(param, succb, errcb) {
    // 1. 发送POST请求到 /login/login 接口
    this.smaction((re, err, obj) => {
        if (err) {
            // 登录失败 → 跳转登录页
            uni.reLaunch({ url: "/pages/login/login" })
        } else {
            // 登录成功 → 保存用户信息
            _this.globalData.getUserInfoBack(re);
            succb && succb();
        }
    }, param, {
        route: uni.svs.auth,
        action: 'login/login',
        method: 'POST',
        datastring: true
    })
}
```

### 5. **登录成功后的处理 getUserInfoBack()**

```javascript
getUserInfoBack: function(obj) {
    if (obj && obj.sid) {
        // 1. 存储到本地
        uni.setStorageSync('curmobile', obj.objuser.mobile);
        uni.setStorageSync('token', obj.token);
        uni.setStorageSync('curopenid', obj.openid || obj.objuser.openid_xcx);
        
        // 2. 设置全局请求头
        _this.globalData.headers['Authorization'] = 'Bearer ' + obj.token;
        _this.globalData.headers['Cookie'] = 'JSESSIONID=' + obj.sid;
        
        // 3. 设置全局用户信息
        _this.globalData.objuserinfo = obj.objuser;
        _this.globalData.code = obj.code;
        _this.globalData.waitlogin = false;
        
        // 4. 执行回调
        if (_this.globalData.userInfoReadyCallback) {
            _this.globalData.userInfoReadyCallback();
        }
    }
}
```

## 当前存在的问题

### 问题1: Token自动登录被注释

**现象**: 页面刷新后需要重新登录

**原因**:

```javascript
// onLaunch中这段代码执行了，但loginByToken内部逻辑被注释
_this.globalData.loginByToken(token, function(){
    // 这里的微信登录代码也被注释了
})
```

### 问题2: 修改密码后无提示

**可能原因**:

1. 修改密码接口返回的是token相关信息，而不是成功提示
2. 前端没有正确处理修改密码的响应
3. 控制台报token错误，说明可能修改密码后token失效了

## 如何调通登录逻辑

### 方案A: 恢复Token自动登录（推荐）

```javascript
// 在 App.vue 的 loginByToken 方法中
loginByToken(token, cb){
    if(token){
        _this.globalData.headers['Authorization'] = 'Bearer ' + token;
        var param = {
            zhtype: _this.globalData.xcxtype, 
            logintype: "autologin"
        }
        _this.globalData.applogin(param, 
            () => {
                // 成功回调
                console.log('Token自动登录成功');
                cb && cb();
            },
            () => {
                // 失败回调
                console.log('Token自动登录失败，清除本地token');
                uni.removeStorageSync('token');
                cb && cb();
            }
        );
    } else {
        cb && cb();
    }
}
```

### 方案B: 检查后端接口

需要确认：

1. **autologin接口**是否支持通过token自动登录
2. 接口返回的数据结构是否正确
3. token是否有过期时间

### 方案C: 修改密码问题

修改密码成功后应该：

```javascript
// 1. 清除旧token
uni.removeStorageSync('token');

// 2. 提示用户
uni.showToast({
    title: '密码修改成功，请重新登录',
    icon: 'success'
});

// 3. 跳转到登录页
setTimeout(() => {
    uni.reLaunch({ url: '/pages/login/login' });
}, 1500);
```

## 建议的调试步骤

1. **先确认后端接口**
   - 测试 `logintype: "autologin"` 是否可用
   - 确认返回的数据结构
2. **逐步恢复代码**
   - 先恢复 `loginByToken` 的核心逻辑
   - 添加详细的日志输出
   - 观察控制台错误信息
3. **处理边界情况**
   - Token过期的处理
   - 网络错误的处理
   - 登录失败的降级方案

你想先从哪个问题开始解决？我可以帮你写具体的修改代码。