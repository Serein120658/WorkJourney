# UniScan 扫描接口文档

## 概述

UniScan 是一个用于 uni-app 的原生扫描模块，封装了 Android 平台的扫描功能。本文档详细说明了如何在 uni-app 项目中集成和使用 UniScan 扫描功能。

**模块名称**: `UniScan`
 **类名**: `io.clound.pda.scan.UniScansManager`
 **平台**: Android

------

## 配置说明

### 1. nativeplugins 配置

在项目的 `nativeplugins/UniScan/package.json` 中配置：

```json
{
  "name": "UniScan",
  "id": "UniScan",
  "version": "1.0.0",
  "description": "扫描模块",
  "_dp_type": "nativeplugin",
  "_dp_nativeplugin": {
    "android": {
      "plugins": [
        {
          "type": "module",
          "name": "UniScan",
          "class": "io.clound.pda.scan.UniScansManager"
        }
      ],
      "integrateType": "aar"
    }
  }
}
```

### 2. manifest.json 配置

在 `manifest.json` 的 App 模块配置中引入：

```json
{
  "nativePlugins": {
    "UniScan": {
      "type": "module",
      "name": "UniScan",
      "class": "io.clound.pda.scan.UniScansManager"
    }
  }
}
```

------

## 使用方法

### 初始化模块

```javascript
const scanModule = uni.requireNativePlugin('UniScan');
```

------

## 核心接口

### 1. 基础扫描功能

#### 1.1 初始化扫描管理器

```javascript
/**
 * 初始化扫描管理器
 * @returns {Boolean} 是否初始化成功
 */
scanModule.initScanManager();
```

#### 1.2 开启/关闭扫描功能

```javascript
/**
 * 开启或关闭扫描功能
 * @param {Number} isopen - 0: 关闭, 非0: 开启
 * @returns {Number} 操作结果码
 */
scanModule.openScan(1); // 开启扫描
scanModule.openScan(0); // 关闭扫描
```

#### 1.3 检查扫描状态

```javascript
/**
 * 检查扫描功能是否已开启
 * @returns {Boolean} true: 已开启, false: 未开启
 */
const isOpen = scanModule.isOpenScan();
```

#### 1.4 开始扫描

```javascript
/**
 * 开始扫描操作
 * @returns {Number} 操作结果码
 */
scanModule.startScan();
```

#### 1.5 停止扫描

```javascript
/**
 * 停止扫描操作
 * @returns {Number} 操作结果码
 */
scanModule.stopScan();
```

------

### 2. 扫描输出设置

#### 2.1 输入模式

```javascript
/**
 * 设置输入模式
 * @param {Number} mode - 输入模式值
 */
scanModule.setInputMode(mode);

/**
 * 获取当前输入模式
 * @returns {Number} 当前输入模式
 */
const mode = scanModule.getInputMode();
```

#### 2.2 前缀和后缀

```javascript
/**
 * 设置扫描结果前缀
 * @param {String} prefix - 前缀字符串
 */
scanModule.setPrefix("PREFIX_");

/**
 * 获取扫描结果前缀
 * @returns {String} 前缀字符串
 */
const prefix = scanModule.getPrefix();

/**
 * 设置扫描结果后缀
 * @param {String} suffix - 后缀字符串
 */
scanModule.setSuffix("_SUFFIX");

/**
 * 获取扫描结果后缀
 * @returns {String} 后缀字符串
 */
const suffix = scanModule.getSuffix();
```

#### 2.3 过滤器

```javascript
/**
 * 设置扫描结果过滤器
 * @param {String} filter - 过滤规则
 */
scanModule.setFilter(filter);

/**
 * 获取扫描结果过滤器
 * @returns {String} 过滤规则
 */
const filter = scanModule.getFilter();
```

------

### 3. 提示音和震动设置

#### 3.1 震动提示

```javascript
/**
 * 设置解码成功震动提示
 * @param {Boolean} isopen - true: 开启, false: 关闭
 */
scanModule.setDecodeTipVibrator(true);

/**
 * 获取震动提示状态
 * @returns {Boolean} 震动提示是否开启
 */
const vibratorStatus = scanModule.getDecodeTipVibrator();
```

#### 3.2 音频提示

```javascript
/**
 * 设置解码成功音频提示
 * @param {Boolean} isopen - true: 开启, false: 关闭
 */
scanModule.setDecodeTipAudio(true);

/**
 * 获取音频提示状态
 * @returns {Boolean} 音频提示是否开启
 */
const audioStatus = scanModule.getDecodeTipAudio();

/**
 * 设置提示音模式
 * @param {Number} mode - 音频模式
 */
scanModule.setTipAudioMode(mode);

/**
 * 获取提示音模式
 * @returns {Number} 当前音频模式
 */
const audioMode = scanModule.getTipAudioMode();
```

#### 3.3 LED 通知

```javascript
/**
 * 设置 LED 通知
 * @param {Boolean} ledMode - true: 开启, false: 关闭
 */
scanModule.setLedNotify(true);

/**
 * 获取 LED 通知状态
 * @returns {Boolean} LED 通知是否开启
 */
const ledStatus = scanModule.getLedNotify();
```

------

### 4. 扫描参数设置

#### 4.1 扫描超时

```javascript
/**
 * 设置扫描超时时间（毫秒）
 * @param {Number} timeout - 超时时间
 */
scanModule.setScannerTimeout(5000);

/**
 * 获取扫描超时时间
 * @returns {Number} 超时时间（毫秒）
 */
const timeout = scanModule.getScannerTimeout();
```

#### 4.2 瞄准功能

```javascript
/**
 * 设置瞄准功能
 * @param {Boolean} isopen - true: 开启, false: 关闭
 */
scanModule.setAim(true);

/**
 * 获取瞄准功能状态
 * @returns {Boolean} 瞄准功能是否开启
 */
const aimStatus = scanModule.isAimOpen();
```

#### 4.3 照明功能

```javascript
/**
 * 设置照明功能
 * @param {Boolean} isopen - true: 开启, false: 关闭
 */
scanModule.setIll(true);

/**
 * 获取照明功能状态
 * @returns {Boolean} 照明功能是否开启
 */
const illStatus = scanModule.isIllOpen();

/**
 * 设置照明功率等级
 * @param {Number} level - 功率等级
 */
scanModule.setIllPowerLevel(5);

/**
 * 获取照明功率等级
 * @returns {Number} 功率等级
 */
const level = scanModule.getIllPowerLevel();
```

#### 4.4 屏幕扫描模式

```javascript
/**
 * 开启/关闭屏幕扫描模式
 * @param {Boolean} isopen - true: 开启, false: 关闭
 */
scanModule.openScreenMode(true);

/**
 * 获取屏幕扫描模式状态
 * @returns {Boolean} 屏幕扫描模式是否开启
 */
const screenMode = scanModule.isScreenMode();
```

------

### 5. 广播设置

#### 5.1 广播名称

```javascript
/**
 * 设置广播名称
 * @param {String} broacastName - 广播名称
 */
scanModule.SetBroacastName("com.example.SCAN_RESULT");

/**
 * 获取广播名称
 * @returns {String} 广播名称
 */
const broadcastName = scanModule.getBroacastName();
```

#### 5.2 广播设置

```javascript
/**
 * 设置设备类型广播
 * @param {Number} devicetype - 设备类型
 * @param {Number} value - 设置值
 */
scanModule.setBroacastSetting(devicetype, value);

/**
 * 获取设备类型广播设置
 * @param {Number} devicetype - 设备类型
 * @returns {Boolean} 广播设置状态
 */
const broadcastSetting = scanModule.getBroacastSetting(devicetype);
```

------

### 6. 条码类型设置

```javascript
/**
 * 获取指定条码类型的设置
 * @param {Number} codetype - 条码类型
 * @returns {Boolean} 该条码类型是否启用
 */
const codeEnabled = scanModule.getCodeSetting(codetype);

/**
 * 设置指定条码类型
 * @param {Number} codetype - 条码类型
 * @param {Number} value - 设置值（0: 禁用, 1: 启用）
 */
scanModule.setCodeSetting(codetype, 1);
```

------

### 7. 高级功能

#### 7.1 数据裁剪

```javascript
/**
 * 设置右侧裁剪字符数
 * @param {String} num - 裁剪字符数
 */
scanModule.setRightCut("2");

/**
 * 获取右侧裁剪字符数
 * @returns {Number} 裁剪字符数
 */
const rightCut = scanModule.getRightCut();

/**
 * 设置左侧裁剪字符数
 * @param {String} num - 裁剪字符数
 */
scanModule.setLeftCut("1");

/**
 * 获取左侧裁剪字符数
 * @returns {Number} 裁剪字符数
 */
const leftCut = scanModule.getLeftCut();
```

#### 7.2 编码设置

```javascript
/**
 * 设置解码编码
 * @param {Number} encode - 编码类型
 */
scanModule.setDecodeEncode(encode);

/**
 * 获取解码编码
 * @returns {Number} 编码类型
 */
const encode = scanModule.getDecodeEncode();
```

#### 7.3 触摸屏区域扫描

```javascript
/**
 * 设置触摸屏区域扫描
 * @param {Boolean} isEnable - 是否启用
 * @param {Number} startX - 起始X坐标
 * @param {Number} startY - 起始Y坐标
 * @param {Number} endX - 结束X坐标
 * @param {Number} endY - 结束Y坐标
 */
scanModule.setCtpAreaTouch(true, 0, 0, 1080, 1920);

/**
 * 获取触摸屏区域扫描设置
 * @returns {Object} 区域设置对象
 */
const areaSetting = scanModule.getCtpAreaTouch();
```

#### 7.4 系统设置

```javascript
/**
 * 重置所有扫描设置为默认值
 */
scanModule.reset();

/**
 * 获取设备型号名称
 * @returns {String} 设备型号
 */
const modelName = scanModule.getDeviceModelName();

/**
 * 获取 SIM 卡 ICCID
 * @returns {String} ICCID
 */
const iccid = scanModule.getSimICCID();
```

------

## 完整使用示例

```javascript
export default {
  data() {
    return {
      scanModule: null,
      isScanning: false,
      scanResult: ''
    }
  },
  
  onLoad() {
    // 初始化扫描模块
    this.scanModule = uni.requireNativePlugin('UniScan');
    this.initScanner();
    
    // 监听扫描结果广播
    this.listenScanBroadcast();
  },
  
  methods: {
    // 初始化扫描器
    initScanner() {
      // 初始化扫描管理器
      const initResult = this.scanModule.initScanManager();
      console.log('扫描管理器初始化:', initResult);
      
      // 开启扫描功能
      this.scanModule.openScan(1);
      
      // 配置扫描参数
      this.scanModule.setDecodeTipVibrator(true);  // 开启震动
      this.scanModule.setDecodeTipAudio(true);     // 开启提示音
      this.scanModule.setScannerTimeout(5000);      // 设置超时5秒
      this.scanModule.setPrefix("");                 // 设置前缀
      this.scanModule.setSuffix("");                 // 设置后缀
      
      // 设置广播名称
      this.scanModule.SetBroacastName("com.example.scan");
    },
    
    // 开始扫描
    startScan() {
      if (this.isScanning) {
        console.log('正在扫描中...');
        return;
      }
      
      const result = this.scanModule.startScan();
      if (result === 0) {
        this.isScanning = true;
        console.log('开始扫描');
      } else {
        console.error('启动扫描失败:', result);
      }
    },
    
    // 停止扫描
    stopScan() {
      if (!this.isScanning) {
        return;
      }
      
      const result = this.scanModule.stopScan();
      if (result === 0) {
        this.isScanning = false;
        console.log('停止扫描');
      } else {
        console.error('停止扫描失败:', result);
      }
    },
    
    // 监听扫描结果广播（需要配合原生广播接收）
    listenScanBroadcast() {
      // 注意：实际的广播接收需要在原生层实现
      // 这里只是示例代码结构
      uni.$on('scanResult', (data) => {
        this.scanResult = data.result;
        console.log('扫描结果:', this.scanResult);
        this.handleScanResult(this.scanResult);
      });
    },
    
    // 处理扫描结果
    handleScanResult(result) {
      // 处理扫描结果的业务逻辑
      uni.showToast({
        title: '扫描成功: ' + result,
        icon: 'success'
      });
    }
  },
  
  onUnload() {
    // 页面卸载时关闭扫描
    if (this.scanModule) {
      this.scanModule.stopScan();
      this.scanModule.openScan(0);
    }
  }
}
```

------

## 注意事项

1. **初始化顺序**: 必须先调用 `initScanManager()` 初始化扫描管理器，然后再调用其他方法
2. **权限要求**: 确保应用具有相机和扫描相关权限
3. **广播接收**: 扫描结果通过 Android 广播发送，需要在原生层实现广播接收器
4. **线程安全**: 所有方法都标记为 `uiThread = false`，可以在子线程调用
5. **资源释放**: 页面销毁时应该停止扫描并关闭扫描功能，避免资源泄漏
6. **设备兼容性**: 不同设备的扫描功能可能有差异，建议在目标设备上充分测试

------

## 常见问题

### Q1: 如何接收扫描结果？

A: 扫描结果通过 Android 广播发送，需要在原生层实现广播接收器，或者通过 plus.globalEvent 监听系统广播。

### Q2: 扫描没有声音和震动？

A: 检查是否调用了 `setDecodeTipVibrator(true)` 和 `setDecodeTipAudio(true)`，并确保设备音量和震动设置正常。

### Q3: startScan() 返回非0值？

A: 确保已经调用 `initScanManager()` 和 `openScan(1)`，并且设备扫描功能可用。

### Q4: 如何设置只扫描特定类型的条码？

A: 使用 `setCodeSetting(codetype, value)` 方法启用或禁用特定的条码类型。

------

## 版本历史

- **v1.0.0** - 初始版本，包含基础扫描功能

