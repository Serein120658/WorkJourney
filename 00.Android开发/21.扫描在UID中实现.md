## è¾“å…¥æ¡†ç±»å‹æ˜¾ç¤ºæ‰«æåˆ°çš„å†…å®¹

### ä»£ç 

```vue
<template>
	<view class="page">
		<!-- é¡¶éƒ¨ç»Ÿè®¡ä¿¡æ¯ -->
		<view class="stats-bar">
			<view class="stat-item">
				<text class="stat-value">{{ totalScans }}</text>
				<text class="stat-label">æ‰«ææ€»æ•°</text>
			</view>
			<view class="stat-divider"></view>
			<view class="stat-item">
				<text class="stat-value">{{ uniqueScans }}</text>
				<text class="stat-label">ä¸åŒç¼–ç </text>
			</view>
			<view class="stat-divider"></view>
			<view class="stat-item">
				<text class="stat-value" :class="lightsOn ? 'text-success' : 'text-muted'">
					{{ lightsOn ? 'å·²å¼€å¯' : 'å·²å…³é—­' }}
				</text>
				<text class="stat-label">ç¯å…‰çŠ¶æ€</text>
			</view>
		</view>

		<!-- ä¸»å†…å®¹åŒº -->
		<view class="main-content">
			<!-- æ‰«ææ˜¾ç¤ºåŒºåŸŸ -->
			<view class="scan-display-card">
				<view class="display-header">
					<view class="header-left">
						<text class="input-icon">ğŸ“±</text>
						<text class="input-title">æ‰«æåŒºåŸŸ</text>
					</view>
					<view class="header-right">
						<!-- ç¯å…‰å¼€å…³ -->
						<view class="light-switch" @click="toggleLights">
							<text class="light-icon">{{ lightsOn ? 'ğŸ’¡' : 'ğŸ”¦' }}</text>
							<text class="light-text">{{ lightsOn ? 'å…³ç¯' : 'å¼€ç¯' }}</text>
						</view>
						<!-- æ¸…ç©ºæŒ‰é’® -->
						<view class="clear-btn" @click="clearData">
							<text class="clear-icon">ğŸ—‘ï¸</text>
							<text class="clear-text">æ¸…ç©º</text>
						</view>
					</view>
				</view>
				
				<!-- å½“å‰æ‰«æç»“æœ -->
				<view class="current-result" v-if="currentScanData">
					<view class="result-content">
						<text class="result-data">{{ currentScanData }}</text>
					</view>
					<view class="result-footer">
						<text class="result-time">{{ currentScanTime }}</text>
					</view>
				</view>
				
				<!-- ç­‰å¾…æ‰«æçŠ¶æ€ -->
				<view class="waiting-state" v-else>
					<text class="waiting-icon">ğŸ“·</text>
					<text class="waiting-text">ç­‰å¾…æ‰«æ...</text>
					<text class="waiting-hint">æŒ‰ä¸‹æ‰‹æŸ„æ‰«æé”®å¼€å§‹æ‰«ææ ‡ç­¾</text>
				</view>
			</view>
			
			<!-- æ‰«æå†å² -->
			<view class="history-section" v-if="scanHistory.length > 0">
				<view class="section-header">
					<text class="section-title">æ‰«æå†å²</text>
					<text class="section-count">å…± {{ uniqueScans }} ç§ç¼–ç </text>
				</view>
				
				<scroll-view class="history-scroll" scroll-y="true">
					<view 
						class="history-card" 
						v-for="(item, index) in scanHistory" 
						:key="index"
					>
						<view class="history-number">{{ index + 1 }}</view>
						<view class="history-info">
							<text class="history-data">{{ item.data }}</text>
							<text class="history-time">é¦–æ¬¡: {{ item.firstTime }}</text>
							<text class="history-time" v-if="item.count > 1">æœ€è¿‘: {{ item.lastTime }}</text>
						</view>
						<view class="history-count" v-if="item.count > 1">
							<text class="count-text">Ã—{{ item.count }}</text>
						</view>
					</view>
				</scroll-view>
			</view>
			
			<!-- ç©ºçŠ¶æ€ -->
			<view class="empty-state" v-if="!currentScanData && scanHistory.length === 0">
				<text class="empty-icon">ğŸ“¦</text>
				<text class="empty-text">æš‚æ— æ‰«æè®°å½•</text>
				<text class="empty-hint">æŒ‰ä¸‹æ‰‹æŸ„æ‰«æé”®å¼€å§‹æ‰«ææ ‡ç­¾</text>
			</view>
		</view>

		<!-- éšè—çš„è¾“å…¥æ¡†ç”¨äºæ¥æ”¶æ‰«ææ•°æ® -->
		<input 
			ref="scanInput"
			v-model="scanInputValue"
			@input="onScanInput"
			@confirm="onScanConfirm"
			@blur="refocusInput"
			type="text"
			class="hidden-input"
			:focus="autoFocus"
			:adjust-position="false"
			:show-confirm-bar="false"
			:hold-keyboard="true"
		/>
	</view>
</template>

<script>
// å¼•å…¥æ‰«ææ’ä»¶
const plugin = uni.requireNativePlugin('UniScan');

export default {
	name: 'ScanPage',
	
	data() {
		return {
			// æ‰«æç›¸å…³
			currentScanData: '',      // å½“å‰æ‰«æçš„æ•°æ®
			currentScanTime: '',      // å½“å‰æ‰«ææ—¶é—´
			scanHistory: [],          // æ‰«æå†å²è®°å½•ï¼ˆåˆå¹¶ç›¸åŒç¼–ç ï¼‰
			scanInputValue: '',       // æ‰«æè¾“å…¥æ¡†çš„å€¼ï¼ˆéšè—ï¼‰
			autoFocus: false,         // è‡ªåŠ¨èšç„¦ï¼ˆåˆå§‹ä¸ºfalseï¼Œé¿å…å¼¹å‡ºé”®ç›˜ï¼‰
			
			// ç¯å…‰æ§åˆ¶
			lightsOn: true,           // ç¯å…‰æ˜¯å¦å¼€å¯ï¼ˆé»˜è®¤å¼€å¯ï¼‰
			
			// è®¾ç½®
			settings: {
				vibrate: true,        // éœ‡åŠ¨åé¦ˆ
				sound: true,          // æç¤ºéŸ³
				scanInterval: 1000,   // é˜²æŠ–é—´éš”(æ¯«ç§’)
			},
			
			// é˜²æŠ–ç›¸å…³
			lastScanData: '',         // ä¸Šæ¬¡æ‰«æçš„æ•°æ®
			lastScanTime: 0,          // ä¸Šæ¬¡æ‰«æçš„æ—¶é—´æˆ³
			
			// Androidå¹¿æ’­ç›¸å…³
			main: null,
			receiver: null,
			filter: null,
			
			// æ‰«æè¾“å…¥ç›‘å¬
			scanInputTimer: null,     // æ‰«æè¾“å…¥è®¡æ—¶å™¨
			
			// é¡µé¢çŠ¶æ€
			isPageActive: false,      // é¡µé¢æ˜¯å¦æ¿€æ´»
			
			// è‡ªåŠ¨é‡æ–°èšç„¦
			refocusTimer: null        // é‡æ–°èšç„¦è®¡æ—¶å™¨
		}
	},
	
	computed: {
		// è®¡ç®—æ€»æ‰«ææ¬¡æ•°
		totalScans() {
			return this.scanHistory.reduce((sum, item) => sum + item.count, 0);
		},
		// è®¡ç®—ä¸åŒç¼–ç æ•°é‡
		uniqueScans() {
			return this.scanHistory.length;
		}
	},
	
	// é¡µé¢æ˜¾ç¤ºæ—¶è§¦å‘
	onShow() {
		console.log('é¡µé¢æ˜¾ç¤º - åˆå§‹åŒ–æ‰«ææ’ä»¶');
		this.isPageActive = true;
		this.initScanPlugin();
		this.registerScanKeyListener();
		this.loadSettings();
		
		// é»˜è®¤å¼€å¯ç¯å…‰
		this.turnOnLight();
		
		// å»¶è¿Ÿè®¾ç½®ç„¦ç‚¹ï¼Œé¿å…å¼¹å‡ºé”®ç›˜
		this.$nextTick(() => {
			setTimeout(() => {
				this.focusInputSilently();
			}, 500);
		});
	},
	
	// é¡µé¢éšè—æ—¶è§¦å‘(åˆ‡æ¢åˆ°å…¶ä»–tab)
	onHide() {
		console.log('é¡µé¢éšè— - æ¸…ç†èµ„æº');
		this.isPageActive = false;
		this.cleanupResources();
	},
	
	// é¡µé¢å¸è½½æ—¶è§¦å‘
	onUnload() {
		console.log('é¡µé¢å¸è½½ - å®Œå…¨æ¸…ç†');
		this.isPageActive = false;
		this.cleanupResources();
	},
	
	methods: {
		/**
		 * é™é»˜èšç„¦è¾“å…¥æ¡†ï¼ˆä¸å¼¹å‡ºé”®ç›˜ï¼‰
		 */
		focusInputSilently() {
			// #ifdef APP-PLUS
			try {
				// åœ¨Appä¸­ï¼Œé€šè¿‡åŸç”Ÿæ–¹æ³•éšè—é”®ç›˜
				plus.key.hideSoftKeybord();
			} catch (e) {
				console.log('éšè—é”®ç›˜å¤±è´¥:', e);
			}
			// #endif
			
			this.autoFocus = true;
			console.log('è¾“å…¥æ¡†å·²èšç„¦ï¼ˆé™é»˜æ¨¡å¼ï¼‰');
		},
		
		/**
		 * è¾“å…¥æ¡†å¤±ç„¦æ—¶è‡ªåŠ¨é‡æ–°èšç„¦
		 */
		refocusInput() {
			if (!this.isPageActive) {
				return;
			}
			
			// æ¸…é™¤ä¹‹å‰çš„å®šæ—¶å™¨
			if (this.refocusTimer) {
				clearTimeout(this.refocusTimer);
			}
			
			// å»¶è¿Ÿé‡æ–°èšç„¦ï¼Œç¡®ä¿æ‰«æåŠŸèƒ½æŒç»­å¯ç”¨
			this.refocusTimer = setTimeout(() => {
				console.log('è‡ªåŠ¨é‡æ–°èšç„¦è¾“å…¥æ¡†');
				this.focusInputSilently();
			}, 100);
		},
		
		/**
		 * åˆå§‹åŒ–æ‰«ææ’ä»¶
		 */
		initScanPlugin() {
			try {
				// æ£€æŸ¥æ‰«æåŠŸèƒ½æ˜¯å¦å¯ç”¨
				let result = plugin.isOpenScan();
				
				if (result) {
					// é…ç½®æ‰«æå‚æ•°
					plugin.setDecodeTipVibrator(this.settings.vibrate);
					
					console.log('âœ“ æ‰«ææ’ä»¶åˆå§‹åŒ–æˆåŠŸ');
				} else {
					console.error('âœ— æ‰«æåŠŸèƒ½æœªå¼€å¯');
					uni.showToast({
						title: 'æ‰«æåŠŸèƒ½ä¸å¯ç”¨',
						icon: 'none'
					});
				}
			} catch (e) {
				console.error('åˆå§‹åŒ–æ‰«ææ’ä»¶å¤±è´¥:', e);
				uni.showModal({
					title: 'åˆå§‹åŒ–å¤±è´¥',
					content: 'æ‰«æåŠŸèƒ½åˆå§‹åŒ–å¤±è´¥,è¯·é‡å¯åº”ç”¨',
					showCancel: false
				});
			}
		},
		
		/**
		 * æ³¨å†Œæ‰‹æŸ„æŒ‰é”®ç›‘å¬
		 */
		registerScanKeyListener() {
			// #ifdef APP-PLUS
			try {
				let _this = this;
				
				this.main = plus.android.runtimeMainActivity();
				
				var IntentFilter = plus.android.importClass('android.content.IntentFilter');
				this.filter = new IntentFilter();
				this.filter.addAction("com.pda.keycode.broacast");
				
				this.receiver = plus.android.implements('io.dcloud.feature.internal.reflect.BroadcastReceiver', {
					onReceive: function(context, intent) {
						plus.android.importClass(intent);
						
						const action = intent.getAction();
						
						if (action === "com.pda.keycode.broacast") {
							const keycode = intent.getIntExtra("keycode", 0);
							const isKeyDown = intent.getBooleanExtra("isdown", false);
							
							// åªåœ¨é¡µé¢æ¿€æ´»æ—¶å¤„ç†æ‰«æäº‹ä»¶
							if (keycode === 292 && isKeyDown && _this.isPageActive) {
								console.log('æ‰‹æŸ„æ‰«æé”®æŒ‰ä¸‹');
								// ç¡®ä¿è¾“å…¥æ¡†è·å–ç„¦ç‚¹
								_this.focusInputSilently();
							}
						}
					}
				});
				
				this.main.registerReceiver(this.receiver, this.filter);
				console.log('âœ“ æ‰‹æŸ„æŒ‰é”®ç›‘å¬å·²æ³¨å†Œ');
			} catch (e) {
				console.error('âœ— æ³¨å†Œæ‰‹æŸ„æŒ‰é”®ç›‘å¬å¤±è´¥:', e);
			}
			// #endif
		},
		
		/**
		 * æ³¨é”€æ‰‹æŸ„æŒ‰é”®ç›‘å¬
		 */
		unregisterScanKeyListener() {
			// #ifdef APP-PLUS
			try {
				if (this.main && this.receiver) {
					this.main.unregisterReceiver(this.receiver);
					this.main = null;
					this.receiver = null;
					this.filter = null;
					console.log('âœ“ æ‰‹æŸ„æŒ‰é”®ç›‘å¬å·²æ³¨é”€');
				}
			} catch (e) {
				console.error('âœ— æ³¨é”€æ‰‹æŸ„æŒ‰é”®ç›‘å¬å¼‚å¸¸:', e);
			}
			// #endif
		},
		
		/**
		 * æ¸…ç†èµ„æº
		 */
		cleanupResources() {
			// æ³¨é”€ç›‘å¬å™¨
			this.unregisterScanKeyListener();
			
			// æ¸…ç†å®šæ—¶å™¨
			if (this.scanInputTimer) {
				clearTimeout(this.scanInputTimer);
				this.scanInputTimer = null;
			}
			
			if (this.refocusTimer) {
				clearTimeout(this.refocusTimer);
				this.refocusTimer = null;
			}
			
			// å…³é—­ç¯å…‰
			if (this.lightsOn) {
				try {
					plugin.setIllPowerLevel(0);
					plugin.setAim(false);
					this.lightsOn = false;
				} catch (e) {
					console.error('å…³é—­ç¯å…‰å¤±è´¥:', e);
				}
			}
			
			// ä¿å­˜è®¾ç½®
			this.saveSettings();
			
			// é‡ç½®ç„¦ç‚¹çŠ¶æ€
			this.autoFocus = false;
		},
		
		/**
		 * å¤„ç†æ‰«ææ•°æ®(å¸¦é˜²æŠ–å’Œåˆå¹¶)
		 */
		handleScanData(scanData) {
			console.log('handleScanData è¢«è°ƒç”¨, æ•°æ®:', scanData);
			
			// æ£€æŸ¥é¡µé¢æ˜¯å¦æ¿€æ´»
			if (!this.isPageActive) {
				console.log('é¡µé¢æœªæ¿€æ´»,å¿½ç•¥æ‰«æ');
				return;
			}
			
			const now = Date.now();
			
			// é˜²æŠ–:é¿å…åœ¨é˜²æŠ–æ—¶é—´å†…é‡å¤æ‰«æç›¸åŒæ•°æ®
			if (scanData === this.lastScanData && 
				now - this.lastScanTime < this.settings.scanInterval) {
				console.log('å¿½ç•¥é‡å¤æ‰«æ(é˜²æŠ–)');
				return;
			}
			
			// æ›´æ–°é˜²æŠ–è®°å½•
			this.lastScanData = scanData;
			this.lastScanTime = now;
			
			// æ›´æ–°å½“å‰æ‰«ææ•°æ®
			this.currentScanData = scanData;
			this.currentScanTime = this.formatDateTime(new Date());
			
			console.log('æ›´æ–°å½“å‰æ‰«ææ•°æ®:', this.currentScanData);
			
			// æŸ¥æ‰¾å†å²è®°å½•ä¸­æ˜¯å¦å·²å­˜åœ¨ç›¸åŒç¼–ç 
			const existingIndex = this.scanHistory.findIndex(item => item.data === scanData);
			
			if (existingIndex !== -1) {
				// å­˜åœ¨ç›¸åŒç¼–ç ,æ›´æ–°è®¡æ•°å’Œæœ€è¿‘æ—¶é—´
				console.log('æ‰¾åˆ°ç›¸åŒç¼–ç ï¼Œæ›´æ–°è®¡æ•°');
				this.scanHistory[existingIndex].count++;
				this.scanHistory[existingIndex].lastTime = this.formatDateTime(new Date());
				
				// å°†è¯¥è®°å½•ç§»åˆ°æœ€å‰é¢
				const item = this.scanHistory.splice(existingIndex, 1)[0];
				this.scanHistory.unshift(item);
			} else {
				// æ–°ç¼–ç ,æ·»åŠ åˆ°å†å²è®°å½•
				console.log('æ–°ç¼–ç ï¼Œæ·»åŠ åˆ°å†å²');
				this.scanHistory.unshift({
					data: scanData,
					firstTime: this.formatDateTime(new Date()),
					lastTime: this.formatDateTime(new Date()),
					count: 1
				});
			}
			
			console.log('å½“å‰å†å²è®°å½•æ•°é‡:', this.scanHistory.length);
			
			// æ˜¾ç¤ºæ‰«ææˆåŠŸæç¤º
			if (this.settings.sound) {
				uni.showToast({
					title: 'æ‰«ææˆåŠŸ',
					icon: 'success',
					duration: 800
				});
			}
			
			// æ¸…ç©ºè¾“å…¥æ¡†
			this.scanInputValue = '';
			
			// ç¡®ä¿è¾“å…¥æ¡†ä¿æŒèšç„¦
			this.$nextTick(() => {
				this.focusInputSilently();
			});
			
			console.log('æ‰«æå¤„ç†å®Œæˆ');
		},
		
		/**
		 * ç›‘å¬æ‰«æè¾“å…¥
		 */
		onScanInput(e) {
			console.log('onScanInput è§¦å‘, è¾“å…¥å€¼:', e.detail.value);
			
			if (this.scanInputTimer) {
				clearTimeout(this.scanInputTimer);
			}
			
			this.scanInputTimer = setTimeout(() => {
				const value = e.detail.value.trim();
				console.log('å¤„ç†æ‰«ææ•°æ®:', value);
				if (value) {
					this.handleScanData(value);
				}
			}, 100);
		},
		
		/**
		 * æ‰«æç¡®è®¤(å›è½¦é”®)
		 */
		onScanConfirm(e) {
			console.log('onScanConfirm è§¦å‘, è¾“å…¥å€¼:', e.detail.value);
			const value = e.detail.value.trim();
			if (value) {
				this.handleScanData(value);
			}
		},
		
		/**
		 * æ ¼å¼åŒ–æ—¥æœŸæ—¶é—´
		 */
		formatDateTime(date) {
			const year = date.getFullYear();
			const month = String(date.getMonth() + 1).padStart(2, '0');
			const day = String(date.getDate()).padStart(2, '0');
			const hours = String(date.getHours()).padStart(2, '0');
			const minutes = String(date.getMinutes()).padStart(2, '0');
			const seconds = String(date.getSeconds()).padStart(2, '0');
			
			return year + '-' + month + '-' + day + ' ' + hours + ':' + minutes + ':' + seconds;
		},
		
		/**
		 * å¼€å¯ç¯å…‰
		 */
		turnOnLight() {
			try {
				plugin.setIllPowerLevel(5);
				plugin.setAim(true);
				this.lightsOn = true;
				console.log('ç¯å…‰å·²è‡ªåŠ¨å¼€å¯');
			} catch (e) {
				console.error('å¼€å¯ç¯å…‰å¤±è´¥:', e);
			}
		},
		
		/**
		 * åˆ‡æ¢ç¯å…‰
		 */
		toggleLights() {
			this.lightsOn = !this.lightsOn;
			
			try {
				if (this.lightsOn) {
					plugin.setIllPowerLevel(5);
					plugin.setAim(true);
					uni.showToast({
						title: 'ç¯å…‰å·²å¼€å¯',
						icon: 'none',
						duration: 1000
					});
				} else {
					plugin.setIllPowerLevel(0);
					plugin.setAim(false);
					uni.showToast({
						title: 'ç¯å…‰å·²å…³é—­',
						icon: 'none',
						duration: 1000
					});
				}
			} catch (e) {
				console.error('åˆ‡æ¢ç¯å…‰å¤±è´¥:', e);
				uni.showToast({
					title: 'ç¯å…‰æ§åˆ¶å¤±è´¥',
					icon: 'none'
				});
			}
			
			// ç¡®ä¿åˆ‡æ¢ç¯å…‰åè¾“å…¥æ¡†ä»ä¿æŒèšç„¦
			this.$nextTick(() => {
				this.focusInputSilently();
			});
		},
		
		/**
		 * æ¸…ç©ºæ•°æ®
		 */
		clearData() {
			var _this = this;
			
			if (this.scanHistory.length === 0 && !this.currentScanData) {
				uni.showToast({
					title: 'æš‚æ— æ•°æ®',
					icon: 'none'
				});
				return;
			}
			
			uni.showModal({
				title: 'ç¡®è®¤æ¸…ç©º',
				content: 'ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ‰«æè®°å½•å—?',
				success: function(res) {
					if (res.confirm) {
						_this.currentScanData = '';
						_this.currentScanTime = '';
						_this.scanHistory = [];
						_this.lastScanData = '';
						_this.lastScanTime = 0;
						_this.scanInputValue = '';
						
						uni.showToast({
							title: 'å·²æ¸…ç©º',
							icon: 'success'
						});
						
						// æ¸…ç©ºåé‡æ–°èšç„¦è¾“å…¥æ¡†
						_this.$nextTick(function() {
							_this.focusInputSilently();
						});
					}
				}
			});
		},
		
		/**
		 * åŠ è½½è®¾ç½®
		 */
		loadSettings() {
			try {
				const savedSettings = uni.getStorageSync('scan_settings');
				if (savedSettings) {
					this.settings = Object.assign({}, this.settings, JSON.parse(savedSettings));
				}
			} catch (e) {
				console.error('åŠ è½½è®¾ç½®å¤±è´¥:', e);
			}
		},
		
		/**
		 * ä¿å­˜è®¾ç½®
		 */
		saveSettings() {
			try {
				uni.setStorageSync('scan_settings', JSON.stringify(this.settings));
			} catch (e) {
				console.error('ä¿å­˜è®¾ç½®å¤±è´¥:', e);
			}
		}
	}
}
</script>

<style lang="scss" scoped>
	/* é¡µé¢å®¹å™¨ */
	.page {
		display: flex;
		flex-direction: column;
		height: 100vh;
		background: #f5f7fa;
	}
	
	/* éšè—çš„è¾“å…¥æ¡† */
	.hidden-input {
		position: fixed;
		left: -9999px;
		top: -9999px;
		width: 1px;
		height: 1px;
		opacity: 0;
		pointer-events: none;
	}
	
	/* é¡¶éƒ¨ç»Ÿè®¡æ  */
	.stats-bar {
		display: flex;
		background: white;
		padding: 30rpx;
		box-shadow: 0 2rpx 8rpx rgba(0, 0, 0, 0.06);
	}
	
	.stat-item {
		flex: 1;
		display: flex;
		flex-direction: column;
		align-items: center;
	}
	
	.stat-value {
		font-size: 40rpx;
		font-weight: bold;
		color: #409eff;
		margin-bottom: 8rpx;
	}
	
	.stat-label {
		font-size: 24rpx;
		color: #999;
	}
	
	.stat-divider {
		width: 2rpx;
		height: 60rpx;
		background: #e8e8e8;
		margin: 0 20rpx;
	}
	
	.text-success {
		color: #67c23a !important;
	}
	
	.text-muted {
		color: #909399 !important;
	}
	
	/* ä¸»å†…å®¹åŒº */
	.main-content {
		flex: 1;
		overflow-y: auto;
		padding: 20rpx;
	}
	
	/* æ‰«ææ˜¾ç¤ºå¡ç‰‡ */
	.scan-display-card {
		background: white;
		border-radius: 16rpx;
		padding: 30rpx;
		margin-bottom: 20rpx;
		box-shadow: 0 2rpx 12rpx rgba(0, 0, 0, 0.08);
	}
	
	.display-header {
		display: flex;
		justify-content: space-between;
		align-items: center;
		margin-bottom: 20rpx;
	}
	
	.header-left {
		display: flex;
		align-items: center;
	}
	
	.input-icon {
		font-size: 36rpx;
		margin-right: 12rpx;
	}
	
	.input-title {
		font-size: 32rpx;
		font-weight: bold;
		color: #333;
	}
	
	.header-right {
		display: flex;
		gap: 16rpx;
	}
	
	/* ç¯å…‰å¼€å…³ */
	.light-switch {
		display: flex;
		flex-direction: column;
		align-items: center;
		padding: 12rpx 20rpx;
		background: #f5f7fa;
		border-radius: 12rpx;
		transition: all 0.2s;
	}
	
	.light-switch:active {
		background: #e4e7ed;
		transform: scale(0.95);
	}
	
	.light-icon {
		font-size: 32rpx;
		margin-bottom: 4rpx;
	}
	
	.light-text {
		font-size: 22rpx;
		color: #666;
	}
	
	/* æ¸…ç©ºæŒ‰é’® */
	.clear-btn {
		display: flex;
		flex-direction: column;
		align-items: center;
		padding: 12rpx 20rpx;
		background: #fff5f5;
		border-radius: 12rpx;
		transition: all 0.2s;
	}
	
	.clear-btn:active {
		background: #fee;
		transform: scale(0.95);
	}
	
	.clear-icon {
		font-size: 32rpx;
		margin-bottom: 4rpx;
	}
	
	.clear-text {
		font-size: 22rpx;
		color: #f56c6c;
	}
	
	/* å½“å‰æ‰«æç»“æœ */
	.current-result {
		background: linear-gradient(135deg, #11cec2 0%, #26736d 100%);
		border-radius: 12rpx;
		padding: 24rpx;
	}
	
	.result-content {
		background: rgba(255, 255, 255, 0.15);
		padding: 24rpx;
		border-radius: 8rpx;
		margin-bottom: 16rpx;
	}
	
	.result-data {
		font-size: 32rpx;
		color: white;
		word-break: break-all;
		line-height: 1.6;
		font-weight: 500;
	}
	
	.result-footer {
		text-align: right;
	}
	
	.result-time {
		font-size: 24rpx;
		color: rgba(255, 255, 255, 0.7);
	}
	
	/* ç­‰å¾…æ‰«æçŠ¶æ€ */
	.waiting-state {
		display: flex;
		flex-direction: column;
		align-items: center;
		padding: 60rpx 40rpx;
		background: #f8f9fa;
		border-radius: 12rpx;
		border: 2rpx dashed #dcdfe6;
	}
	
	.waiting-icon {
		font-size: 80rpx;
		margin-bottom: 20rpx;
		opacity: 0.5;
	}
	
	.waiting-text {
		font-size: 28rpx;
		color: #909399;
		margin-bottom: 12rpx;
		font-weight: 500;
	}
	
	.waiting-hint {
		font-size: 24rpx;
		color: #c0c4cc;
		text-align: center;
		line-height: 1.6;
	}
	
	/* å†å²è®°å½• */
	.history-section {
		background: white;
		border-radius: 16rpx;
		padding: 30rpx;
		box-shadow: 0 2rpx 12rpx rgba(0, 0, 0, 0.08);
	}
	
	.section-header {
		display: flex;
		justify-content: space-between;
		align-items: center;
		margin-bottom: 20rpx;
		padding-bottom: 20rpx;
		border-bottom: 2rpx solid #f0f0f0;
	}
	
	.section-title {
		font-size: 32rpx;
		font-weight: bold;
		color: #333;
	}
	
	.section-count {
		font-size: 24rpx;
		color: #999;
	}
	
	.history-scroll {
		max-height: 600rpx;
	}
	
	.history-card {
		display: flex;
		align-items: center;
		padding: 24rpx;
		background: #f8f9fa;
		border-radius: 12rpx;
		margin-bottom: 16rpx;
		transition: all 0.2s;
	}
	
	.history-card:active {
		background: #e9ecef;
		transform: scale(0.98);
	}
	
	.history-number {
		width: 56rpx;
		height: 56rpx;
		background: linear-gradient(135deg, #11cec2 0%, #26736d 100%);
		color: white;
		border-radius: 50%;
		display: flex;
		align-items: center;
		justify-content: center;
		font-size: 24rpx;
		font-weight: bold;
		flex-shrink: 0;
		margin-right: 20rpx;
	}
	
	.history-info {
		flex: 1;
		display: flex;
		flex-direction: column;
		justify-content: center;
		min-width: 0;
	}
	
	.history-data {
		font-size: 28rpx;
		color: #333;
		word-break: break-all;
		margin-bottom: 8rpx;
		line-height: 1.5;
		font-weight: 500;
	}
	
	.history-time {
		font-size: 22rpx;
		color: #999;
		line-height: 1.4;
	}
	
	.history-count {
		flex-shrink: 0;
		margin-left: 16rpx;
		padding: 8rpx 16rpx;
		background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
		border-radius: 20rpx;
	}
	
	.count-text {
		font-size: 24rpx;
		color: white;
		font-weight: bold;
	}
	
	/* ç©ºçŠ¶æ€ */
	.empty-state {
		display: flex;
		flex-direction: column;
		align-items: center;
		justify-content: center;
		padding: 120rpx 40rpx;
		background: white;
		border-radius: 16rpx;
		box-shadow: 0 2rpx 12rpx rgba(0, 0, 0, 0.08);
	}
	
	.empty-icon {
		font-size: 120rpx;
		margin-bottom: 30rpx;
		opacity: 0.5;
	}
	
	.empty-text {
		font-size: 32rpx;
		color: #666;
		margin-bottom: 16rpx;
		font-weight: 500;
	}
	
	.empty-hint {
		font-size: 26rpx;
		color: #999;
		text-align: center;
		line-height: 1.6;
	}
</style>
```

### æ•ˆæœ

![image-20251107105241633](21.æ‰«æåœ¨UIDä¸­å®ç°.assets/image-20251107105241633.png)

### å­˜åœ¨çš„BUG

1. å¼€å…³ç¯å½±å“èšç„¦  å¯¼è‡´ç‚¹å‡»åæ‰«æä¸åˆ°
2. æ¸…ç©ºåå†æ¬¡æ‰«ï¼Œæ‰«æåˆ°ï¼ï¼ï¼



## ä½¿ç”¨å¹¿æ’­æ¨¡å¼æ˜¾ç¤ºæ‰«æåˆ°çš„å†…å®¹

è¿™ä¸ªå¹¿æ’­ä¸å¤ªå¥½ç†è§£  ä¸çŸ¥é“è®¾å¤‡æ”¯æŒé‚£äº›å¹¿æ’­ï¼ï¼ï¼ï¼

ä¹Ÿå°±æ˜¯å‘é€å¹¿æ’­  æ”¶åˆ°åæ˜¾ç¤º  

1. åŒé‡æ¥æ”¶æ–¹å¼ï¼š

   - ğŸ“¡ **å¹¿æ’­æ¥æ”¶**ï¼šç›‘å¬å¤šç§å¯èƒ½çš„å¹¿æ’­actionå’Œæ•°æ®key
   - ğŸ“ **è¾“å…¥æ¡†åå¤‡**ï¼šå¦‚æœå¹¿æ’­ä¸å·¥ä½œï¼Œè¾“å…¥æ¡†ä»å¯æ¥æ”¶æ•°æ®

2. è°ƒè¯•æŒ‰é’®ï¼ˆå³ä¸‹è§’è“è‰²åœ†å½¢æŒ‰é’® ğŸ”ï¼‰

   ï¼š ç‚¹å‡»å¯æŸ¥çœ‹ï¼š

   - å½“å‰ä½¿ç”¨çš„æ‰«ææ–¹å¼ï¼ˆå¹¿æ’­ or è¾“å…¥æ¡†ï¼‰
   - æ¥æ”¶åˆ°çš„æ‰€æœ‰å¹¿æ’­action
   - æ‰«æç»Ÿè®¡ä¿¡æ¯

3. ç›‘å¬çš„å¹¿æ’­actionsï¼š

   - `android.intent.ACTION_DECODE_DATA`
   - `com.scanner.broadcast`
   - `scan.rcv.message`
   - `nlscan.action.SCANNER_RESULT`
   - `com.android.server.scannerservice.broadcast`
   - `com.pda.keycode.broacast`

4. å°è¯•çš„æ•°æ®keysï¼š

   - `barcode`
   - `data`
   - `scannerdata`
   - `value`
   - `scan_data`
   - `SCAN_BARCODE1`
   - `SCAN_BARCODE2`

1. **è¿è¡Œä»£ç åï¼Œæ‰«æä¸€ä¸ªæ¡ç **

2. **ç‚¹å‡»å³ä¸‹è§’è°ƒè¯•æŒ‰é’® ğŸ”**

3. æŸ¥çœ‹è°ƒè¯•ä¿¡æ¯

   ï¼Œä¼šæ˜¾ç¤ºï¼š

   - å¦‚æœæ˜¾ç¤º `æ‰«ææ–¹å¼: input` â†’ è¯´æ˜æ˜¯é€šè¿‡è¾“å…¥æ¡†æ¥æ”¶çš„
   - å¦‚æœæ˜¾ç¤º `æ‰«ææ–¹å¼: broadcast:xxx:yyy` â†’ è¯´æ˜é€šè¿‡å¹¿æ’­æ¥æ”¶æˆåŠŸ
   - æ¥æ”¶åˆ°çš„å¹¿æ’­åˆ—è¡¨ â†’ å¯ä»¥çœ‹åˆ°ä½ çš„è®¾å¤‡å‘é€äº†å“ªäº›å¹¿æ’­

å½“å‰è®¾å¤‡ä¸æ”¯æŒ   åŒå¹¿æ’­ï¼ï¼

### è°ƒè¯•ä»£ç 

```vue
<template>
	<view class="page">
		<!-- é¡¶éƒ¨ç»Ÿè®¡ä¿¡æ¯ -->
		<view class="stats-bar">
			<view class="stat-item">
				<text class="stat-value">{{ totalScans }}</text>
				<text class="stat-label">æ‰«ææ€»æ•°</text>
			</view>
			<view class="stat-divider"></view>
			<view class="stat-item">
				<text class="stat-value">{{ uniqueScans }}</text>
				<text class="stat-label">ä¸åŒç¼–ç </text>
			</view>
			<view class="stat-divider"></view>
			<view class="stat-item">
				<text class="stat-value" :class="lightsOn ? 'text-success' : 'text-muted'">
					{{ lightsOn ? 'å·²å¼€å¯' : 'å·²å…³é—­' }}
				</text>
				<text class="stat-label">ç¯å…‰çŠ¶æ€</text>
			</view>
		</view>

		<!-- ä¸»å†…å®¹åŒº -->
		<view class="main-content">
			<!-- æ‰«ææ˜¾ç¤ºåŒºåŸŸ -->
			<view class="scan-display-card">
				<view class="display-header">
					<view class="header-left">
						<text class="input-icon">ğŸ“±</text>
						<text class="input-title">æ‰«æåŒºåŸŸ</text>
					</view>
					<view class="header-right">
						<!-- ç¯å…‰å¼€å…³ -->
						<view class="light-switch" @click="toggleLights">
							<text class="light-icon">{{ lightsOn ? 'ğŸ’¡' : 'ğŸ”¦' }}</text>
							<text class="light-text">{{ lightsOn ? 'å…³ç¯' : 'å¼€ç¯' }}</text>
						</view>
						<!-- æ¸…ç©ºæŒ‰é’® -->
						<view class="clear-btn" @click="clearData">
							<text class="clear-icon">ğŸ—‘ï¸</text>
							<text class="clear-text">æ¸…ç©º</text>
						</view>
					</view>
				</view>
				
				<!-- å½“å‰æ‰«æç»“æœ -->
				<view class="current-result" v-if="currentScanData">
					<view class="result-content">
						<text class="result-data">{{ currentScanData }}</text>
					</view>
					<view class="result-footer">
						<text class="result-time">{{ currentScanTime }}</text>
					</view>
				</view>
				
				<!-- ç­‰å¾…æ‰«æçŠ¶æ€ -->
				<view class="waiting-state" v-else>
					<text class="waiting-icon">ğŸ“·</text>
					<text class="waiting-text">ç­‰å¾…æ‰«æ...</text>
					<text class="waiting-hint">æŒ‰ä¸‹æ‰‹æŸ„æ‰«æé”®å¼€å§‹æ‰«ææ ‡ç­¾</text>
				</view>
			</view>
			
			<!-- æ‰«æå†å² -->
			<view class="history-section" v-if="scanHistory.length > 0">
				<view class="section-header">
					<text class="section-title">æ‰«æå†å²</text>
					<text class="section-count">å…± {{ uniqueScans }} ç§ç¼–ç </text>
				</view>
				
				<scroll-view class="history-scroll" scroll-y="true">
					<view 
						class="history-card" 
						v-for="(item, index) in scanHistory" 
						:key="index"
					>
						<view class="history-number">{{ index + 1 }}</view>
						<view class="history-info">
							<text class="history-data">{{ item.data }}</text>
							<text class="history-time">é¦–æ¬¡: {{ item.firstTime }}</text>
							<text class="history-time" v-if="item.count > 1">æœ€è¿‘: {{ item.lastTime }}</text>
						</view>
						<view class="history-count" v-if="item.count > 1">
							<text class="count-text">Ã—{{ item.count }}</text>
						</view>
					</view>
				</scroll-view>
			</view>
			
			<!-- ç©ºçŠ¶æ€ -->
			<view class="empty-state" v-if="!currentScanData && scanHistory.length === 0">
				<text class="empty-icon">ğŸ“¦</text>
				<text class="empty-text">æš‚æ— æ‰«æè®°å½•</text>
				<text class="empty-hint">æŒ‰ä¸‹æ‰‹æŸ„æ‰«æé”®å¼€å§‹æ‰«ææ ‡ç­¾</text>
			</view>
		</view>

		<!-- éšè—çš„è¾“å…¥æ¡†ç”¨äºæ¥æ”¶æ‰«ææ•°æ® - ä½œä¸ºåå¤‡æ–¹æ¡ˆ -->
		<input 
			v-model="scanInputValue"
			@input="onScanInput"
			@confirm="onScanConfirm"
			type="text"
			class="hidden-input"
			:focus="inputFocused"
			:adjust-position="false"
			:show-confirm-bar="false"
		/>
		
		<!-- è°ƒè¯•æŒ‰é’® -->
		<view class="debug-btn" @click="showDebugInfo">
			<text>ğŸ”</text>
		</view>
	</view>
</template>

<script>
// å¼•å…¥æ‰«ææ’ä»¶
const plugin = uni.requireNativePlugin('UniScan');

export default {
	name: 'ScanPage',
	
	data() {
		return {
			// æ‰«æç›¸å…³
			currentScanData: '',      // å½“å‰æ‰«æçš„æ•°æ®
			currentScanTime: '',      // å½“å‰æ‰«ææ—¶é—´
			scanHistory: [],          // æ‰«æå†å²è®°å½•ï¼ˆåˆå¹¶ç›¸åŒç¼–ç ï¼‰
			scanInputValue: '',       // è¾“å…¥æ¡†çš„å€¼ï¼ˆåå¤‡æ–¹æ¡ˆï¼‰
			inputFocused: false,      // è¾“å…¥æ¡†æ˜¯å¦èšç„¦
			
			// ç¯å…‰æ§åˆ¶
			lightsOn: true,           // ç¯å…‰æ˜¯å¦å¼€å¯ï¼ˆé»˜è®¤å¼€å¯ï¼‰
			
			// è®¾ç½®
			settings: {
				vibrate: true,        // éœ‡åŠ¨åé¦ˆ
				sound: true,          // æç¤ºéŸ³
				scanInterval: 1000,   // é˜²æŠ–é—´éš”(æ¯«ç§’)
			},
			
			// é˜²æŠ–ç›¸å…³
			lastScanData: '',         // ä¸Šæ¬¡æ‰«æçš„æ•°æ®
			lastScanTime: 0,          // ä¸Šæ¬¡æ‰«æçš„æ—¶é—´æˆ³
			
			// Androidå¹¿æ’­ç›¸å…³
			main: null,
			receiver: null,
			filter: null,
			
			// æ‰«æè¾“å…¥ç›‘å¬
			scanInputTimer: null,
			
			// é¡µé¢çŠ¶æ€
			isPageActive: false,
			
			// è°ƒè¯•ä¿¡æ¯
			debugInfo: {
				broadcastReceived: [],  // æ¥æ”¶åˆ°çš„å¹¿æ’­
				scanMethod: 'unknown'   // ä½¿ç”¨çš„æ‰«ææ–¹å¼
			}
		}
	},
	
	computed: {
		// è®¡ç®—æ€»æ‰«ææ¬¡æ•°
		totalScans() {
			return this.scanHistory.reduce(function(sum, item) {
				return sum + item.count;
			}, 0);
		},
		// è®¡ç®—ä¸åŒç¼–ç æ•°é‡
		uniqueScans() {
			return this.scanHistory.length;
		}
	},
	
	// é¡µé¢æ˜¾ç¤ºæ—¶è§¦å‘
	onShow() {
		console.log('é¡µé¢æ˜¾ç¤º - åˆå§‹åŒ–æ‰«ææ’ä»¶');
		this.isPageActive = true;
		this.initScanPlugin();
		this.registerBroadcastReceiver();
		this.loadSettings();
		
		// é»˜è®¤å¼€å¯ç¯å…‰
		this.turnOnLight();
		
		// å¯ç”¨è¾“å…¥æ¡†ä½œä¸ºåå¤‡æ–¹æ¡ˆ
		this.$nextTick(function() {
			var _this = this;
			setTimeout(function() {
				_this.inputFocused = true;
				console.log('è¾“å…¥æ¡†å·²å¯ç”¨ï¼ˆåå¤‡æ–¹æ¡ˆï¼‰');
			}, 300);
		});
	},
	
	// é¡µé¢éšè—æ—¶è§¦å‘(åˆ‡æ¢åˆ°å…¶ä»–tab)
	onHide() {
		console.log('é¡µé¢éšè— - æ¸…ç†èµ„æº');
		this.isPageActive = false;
		this.cleanupResources();
	},
	
	// é¡µé¢å¸è½½æ—¶è§¦å‘
	onUnload() {
		console.log('é¡µé¢å¸è½½ - å®Œå…¨æ¸…ç†');
		this.isPageActive = false;
		this.cleanupResources();
	},
	
	methods: {
		/**
		 * åˆå§‹åŒ–æ‰«ææ’ä»¶
		 */
		initScanPlugin() {
			try {
				var result = plugin.isOpenScan();
				
				if (result) {
					plugin.setDecodeTipVibrator(this.settings.vibrate);
					console.log('âœ“ æ‰«ææ’ä»¶åˆå§‹åŒ–æˆåŠŸ');
				} else {
					console.error('âœ— æ‰«æåŠŸèƒ½æœªå¼€å¯');
					uni.showToast({
						title: 'æ‰«æåŠŸèƒ½ä¸å¯ç”¨',
						icon: 'none'
					});
				}
			} catch (e) {
				console.error('åˆå§‹åŒ–æ‰«ææ’ä»¶å¤±è´¥:', e);
			}
		},
		
		/**
		 * æ³¨å†Œå¹¿æ’­æ¥æ”¶å™¨ - ç›‘å¬æ‰€æœ‰å¯èƒ½çš„æ‰«æå¹¿æ’­
		 */
		registerBroadcastReceiver() {
			// #ifdef APP-PLUS
			try {
				var _this = this;
				
				this.main = plus.android.runtimeMainActivity();
				var IntentFilter = plus.android.importClass('android.content.IntentFilter');
				
				this.filter = new IntentFilter();
				
				// æ·»åŠ å¤šä¸ªå¯èƒ½çš„å¹¿æ’­action
				var possibleActions = [
					"android.intent.ACTION_DECODE_DATA",  // é€šç”¨æ‰«ææ•°æ®
					"com.scanner.broadcast",               // å¸¸è§æ‰«æå¹¿æ’­
					"scan.rcv.message",                    // æŸäº›è®¾å¤‡ä½¿ç”¨
					"nlscan.action.SCANNER_RESULT",       // æ–°å¤§é™†æ‰«ææª
					"com.android.server.scannerservice.broadcast", // æŸäº›PDA
					"com.pda.keycode.broacast"            // æŒ‰é”®å¹¿æ’­
				];
				
				for (var i = 0; i < possibleActions.length; i++) {
					this.filter.addAction(possibleActions[i]);
				}
				
				this.receiver = plus.android.implements('io.dcloud.feature.internal.reflect.BroadcastReceiver', {
					onReceive: function(context, intent) {
						plus.android.importClass(intent);
						
						var action = intent.getAction();
						console.log('ğŸ“¡ æ¥æ”¶åˆ°å¹¿æ’­:', action);
						
						// è®°å½•æ¥æ”¶åˆ°çš„å¹¿æ’­
						_this.debugInfo.broadcastReceived.push({
							action: action,
							time: new Date().toLocaleTimeString()
						});
						
						// å°è¯•ä»ä¸åŒçš„keyè·å–æ‰«ææ•°æ®
						var scanData = null;
						var possibleKeys = [
							"barcode",           // æœ€å¸¸è§
							"data",              // é€šç”¨
							"scannerdata",       // æŸäº›è®¾å¤‡
							"value",             // æŸäº›è®¾å¤‡
							"scan_data",         // ä¸‹åˆ’çº¿æ ¼å¼
							"SCAN_BARCODE1",     // å¤§å†™æ ¼å¼
							"SCAN_BARCODE2"      
						];
						
						for (var j = 0; j < possibleKeys.length; j++) {
							try {
								var tempData = intent.getStringExtra(possibleKeys[j]);
								if (tempData && tempData.length > 0) {
									scanData = tempData;
									console.log('âœ“ ä»key "' + possibleKeys[j] + '" è·å–åˆ°æ•°æ®:', scanData);
									_this.debugInfo.scanMethod = 'broadcast:' + action + ':' + possibleKeys[j];
									break;
								}
							} catch (e) {
								// å¿½ç•¥é”™è¯¯ï¼Œç»§ç»­å°è¯•ä¸‹ä¸€ä¸ªkey
							}
						}
						
						// å¤„ç†æŒ‰é”®å¹¿æ’­
						if (action === "com.pda.keycode.broacast") {
							var keycode = intent.getIntExtra("keycode", 0);
							var isKeyDown = intent.getBooleanExtra("isdown", false);
							console.log('æŒ‰é”®ç :', keycode, 'æŒ‰ä¸‹:', isKeyDown);
						}
						
						// å¦‚æœè·å–åˆ°æ‰«ææ•°æ®ï¼Œåˆ™å¤„ç†
						if (scanData && _this.isPageActive) {
							console.log('âœ“ é€šè¿‡å¹¿æ’­æ¥æ”¶åˆ°æ‰«ææ•°æ®:', scanData);
							_this.handleScanData(scanData);
						}
					}
				});
				
				this.main.registerReceiver(this.receiver, this.filter);
				console.log('âœ“ å¹¿æ’­æ¥æ”¶å™¨å·²æ³¨å†Œï¼Œç›‘å¬å¤šä¸ªaction');
				
			} catch (e) {
				console.error('âœ— æ³¨å†Œå¹¿æ’­æ¥æ”¶å™¨å¤±è´¥:', e);
			}
			// #endif
		},
		
		/**
		 * æ³¨é”€å¹¿æ’­æ¥æ”¶å™¨
		 */
		unregisterBroadcastReceiver() {
			// #ifdef APP-PLUS
			try {
				if (this.main && this.receiver) {
					this.main.unregisterReceiver(this.receiver);
					this.main = null;
					this.receiver = null;
					this.filter = null;
					console.log('âœ“ å¹¿æ’­æ¥æ”¶å™¨å·²æ³¨é”€');
				}
			} catch (e) {
				console.error('âœ— æ³¨é”€å¹¿æ’­æ¥æ”¶å™¨å¼‚å¸¸:', e);
			}
			// #endif
		},
		
		/**
		 * æ¸…ç†èµ„æº
		 */
		cleanupResources() {
			this.unregisterBroadcastReceiver();
			
			if (this.scanInputTimer) {
				clearTimeout(this.scanInputTimer);
				this.scanInputTimer = null;
			}
			
			if (this.lightsOn) {
				try {
					plugin.setIllPowerLevel(0);
					plugin.setAim(false);
					this.lightsOn = false;
				} catch (e) {
					console.error('å…³é—­ç¯å…‰å¤±è´¥:', e);
				}
			}
			
			this.inputFocused = false;
			this.saveSettings();
		},
		
		/**
		 * å¤„ç†æ‰«ææ•°æ®(å¸¦é˜²æŠ–å’Œåˆå¹¶)
		 */
		handleScanData(scanData) {
			console.log('handleScanData è¢«è°ƒç”¨, æ•°æ®:', scanData);
			
			if (!this.isPageActive) {
				console.log('é¡µé¢æœªæ¿€æ´»,å¿½ç•¥æ‰«æ');
				return;
			}
			
			scanData = scanData.trim();
			
			if (!scanData) {
				console.log('æ‰«ææ•°æ®ä¸ºç©º,å¿½ç•¥');
				return;
			}
			
			var now = Date.now();
			
			if (scanData === this.lastScanData && 
				now - this.lastScanTime < this.settings.scanInterval) {
				console.log('å¿½ç•¥é‡å¤æ‰«æ(é˜²æŠ–)');
				return;
			}
			
			this.lastScanData = scanData;
			this.lastScanTime = now;
			
			this.currentScanData = scanData;
			this.currentScanTime = this.formatDateTime(new Date());
			
			console.log('æ›´æ–°å½“å‰æ‰«ææ•°æ®:', this.currentScanData);
			
			var existingIndex = -1;
			for (var i = 0; i < this.scanHistory.length; i++) {
				if (this.scanHistory[i].data === scanData) {
					existingIndex = i;
					break;
				}
			}
			
			if (existingIndex !== -1) {
				console.log('æ‰¾åˆ°ç›¸åŒç¼–ç ï¼Œæ›´æ–°è®¡æ•°');
				this.scanHistory[existingIndex].count++;
				this.scanHistory[existingIndex].lastTime = this.formatDateTime(new Date());
				
				var item = this.scanHistory.splice(existingIndex, 1)[0];
				this.scanHistory.unshift(item);
			} else {
				console.log('æ–°ç¼–ç ï¼Œæ·»åŠ åˆ°å†å²');
				this.scanHistory.unshift({
					data: scanData,
					firstTime: this.formatDateTime(new Date()),
					lastTime: this.formatDateTime(new Date()),
					count: 1
				});
			}
			
			console.log('å½“å‰å†å²è®°å½•æ•°é‡:', this.scanHistory.length);
			
			if (this.settings.sound) {
				uni.showToast({
					title: 'æ‰«ææˆåŠŸ',
					icon: 'success',
					duration: 800
				});
			}
			
			// æ¸…ç©ºè¾“å…¥æ¡†
			this.scanInputValue = '';
			
			console.log('æ‰«æå¤„ç†å®Œæˆ');
		},
		
		/**
		 * ç›‘å¬è¾“å…¥æ¡†è¾“å…¥ï¼ˆåå¤‡æ–¹æ¡ˆï¼‰
		 */
		onScanInput(e) {
			console.log('ğŸ“ è¾“å…¥æ¡†æ¥æ”¶åˆ°æ•°æ®:', e.detail.value);
			this.debugInfo.scanMethod = 'input';
			
			if (this.scanInputTimer) {
				clearTimeout(this.scanInputTimer);
			}
			
			var _this = this;
			this.scanInputTimer = setTimeout(function() {
				var value = e.detail.value.trim();
				if (value) {
					console.log('âœ“ é€šè¿‡è¾“å…¥æ¡†æ¥æ”¶åˆ°æ‰«ææ•°æ®:', value);
					_this.handleScanData(value);
				}
			}, 100);
		},
		
		/**
		 * è¾“å…¥æ¡†ç¡®è®¤
		 */
		onScanConfirm(e) {
			console.log('ğŸ“ è¾“å…¥æ¡†ç¡®è®¤:', e.detail.value);
			var value = e.detail.value.trim();
			if (value) {
				this.handleScanData(value);
			}
		},
		
		/**
		 * æ˜¾ç¤ºè°ƒè¯•ä¿¡æ¯
		 */
		showDebugInfo() {
			var broadcastList = 'æ— ';
			if (this.debugInfo.broadcastReceived.length > 0) {
				broadcastList = '\n';
				for (var i = 0; i < this.debugInfo.broadcastReceived.length; i++) {
					var item = this.debugInfo.broadcastReceived[i];
					broadcastList += item.time + ': ' + item.action + '\n';
				}
			}
			
			var content = 'æ‰«ææ–¹å¼: ' + this.debugInfo.scanMethod + '\n\n' +
						  'æ¥æ”¶åˆ°çš„å¹¿æ’­:' + broadcastList + '\n' +
						  'æ€»æ‰«ææ¬¡æ•°: ' + this.totalScans + '\n' +
						  'ä¸åŒç¼–ç æ•°: ' + this.uniqueScans;
			
			uni.showModal({
				title: 'è°ƒè¯•ä¿¡æ¯',
				content: content,
				showCancel: true,
				cancelText: 'å¤åˆ¶',
				confirmText: 'å…³é—­',
				success: function(res) {
					if (res.cancel) {
						// å¤åˆ¶åˆ°å‰ªè´´æ¿
						uni.setClipboardData({
							data: content,
							success: function() {
								uni.showToast({
									title: 'å·²å¤åˆ¶',
									icon: 'success'
								});
							}
						});
					}
				}
			});
		},
		
		/**
		 * æ ¼å¼åŒ–æ—¥æœŸæ—¶é—´
		 */
		formatDateTime(date) {
			var year = date.getFullYear();
			var month = String(date.getMonth() + 1).padStart(2, '0');
			var day = String(date.getDate()).padStart(2, '0');
			var hours = String(date.getHours()).padStart(2, '0');
			var minutes = String(date.getMinutes()).padStart(2, '0');
			var seconds = String(date.getSeconds()).padStart(2, '0');
			
			return year + '-' + month + '-' + day + ' ' + hours + ':' + minutes + ':' + seconds;
		},
		
		/**
		 * å¼€å¯ç¯å…‰
		 */
		turnOnLight() {
			try {
				plugin.setIllPowerLevel(5);
				plugin.setAim(true);
				this.lightsOn = true;
				console.log('ç¯å…‰å·²è‡ªåŠ¨å¼€å¯');
			} catch (e) {
				console.error('å¼€å¯ç¯å…‰å¤±è´¥:', e);
			}
		},
		
		/**
		 * åˆ‡æ¢ç¯å…‰
		 */
		toggleLights() {
			this.lightsOn = !this.lightsOn;
			
			try {
				if (this.lightsOn) {
					plugin.setIllPowerLevel(5);
					plugin.setAim(true);
					uni.showToast({
						title: 'ç¯å…‰å·²å¼€å¯',
						icon: 'none',
						duration: 1000
					});
				} else {
					plugin.setIllPowerLevel(0);
					plugin.setAim(false);
					uni.showToast({
						title: 'ç¯å…‰å·²å…³é—­',
						icon: 'none',
						duration: 1000
					});
				}
			} catch (e) {
				console.error('åˆ‡æ¢ç¯å…‰å¤±è´¥:', e);
				uni.showToast({
					title: 'ç¯å…‰æ§åˆ¶å¤±è´¥',
					icon: 'none'
				});
			}
		},
		
		/**
		 * æ¸…ç©ºæ•°æ®
		 */
		clearData() {
			var _this = this;
			
			if (this.scanHistory.length === 0 && !this.currentScanData) {
				uni.showToast({
					title: 'æš‚æ— æ•°æ®',
					icon: 'none'
				});
				return;
			}
			
			uni.showModal({
				title: 'ç¡®è®¤æ¸…ç©º',
				content: 'ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ‰«æè®°å½•å—?',
				success: function(res) {
					if (res.confirm) {
						_this.currentScanData = '';
						_this.currentScanTime = '';
						_this.scanHistory = [];
						_this.lastScanData = '';
						_this.lastScanTime = 0;
						_this.scanInputValue = '';
						
						uni.showToast({
							title: 'å·²æ¸…ç©º',
							icon: 'success'
						});
						
						console.log('æ•°æ®å·²æ¸…ç©ºï¼Œå¯ä»¥ç»§ç»­æ‰«æ');
					}
				}
			});
		},
		
		/**
		 * åŠ è½½è®¾ç½®
		 */
		loadSettings() {
			try {
				var savedSettings = uni.getStorageSync('scan_settings');
				if (savedSettings) {
					this.settings = Object.assign({}, this.settings, JSON.parse(savedSettings));
				}
			} catch (e) {
				console.error('åŠ è½½è®¾ç½®å¤±è´¥:', e);
			}
		},
		
		/**
		 * ä¿å­˜è®¾ç½®
		 */
		saveSettings() {
			try {
				uni.setStorageSync('scan_settings', JSON.stringify(this.settings));
			} catch (e) {
				console.error('ä¿å­˜è®¾ç½®å¤±è´¥:', e);
			}
		}
	}
}
</script>

<style lang="scss" scoped>
	/* é¡µé¢å®¹å™¨ */
	.page {
		display: flex;
		flex-direction: column;
		height: 100vh;
		background: #f5f7fa;
		position: relative;
	}
	
	/* éšè—çš„è¾“å…¥æ¡† */
	.hidden-input {
		position: fixed;
		left: -9999px;
		top: -9999px;
		width: 1px;
		height: 1px;
		opacity: 0;
		pointer-events: none;
	}
	
	/* è°ƒè¯•æŒ‰é’® */
	.debug-btn {
		position: fixed;
		right: 30rpx;
		bottom: 100rpx;
		width: 100rpx;
		height: 100rpx;
		background: rgba(64, 158, 255, 0.9);
		border-radius: 50%;
		display: flex;
		align-items: center;
		justify-content: center;
		font-size: 50rpx;
		box-shadow: 0 4rpx 12rpx rgba(0, 0, 0, 0.15);
		z-index: 999;
	}
	
	.debug-btn:active {
		transform: scale(0.95);
		background: rgba(64, 158, 255, 1);
	}
	
	/* é¡¶éƒ¨ç»Ÿè®¡æ  */
	.stats-bar {
		display: flex;
		background: white;
		padding: 30rpx;
		box-shadow: 0 2rpx 8rpx rgba(0, 0, 0, 0.06);
	}
	
	.stat-item {
		flex: 1;
		display: flex;
		flex-direction: column;
		align-items: center;
	}
	
	.stat-value {
		font-size: 40rpx;
		font-weight: bold;
		color: #409eff;
		margin-bottom: 8rpx;
	}
	
	.stat-label {
		font-size: 24rpx;
		color: #999;
	}
	
	.stat-divider {
		width: 2rpx;
		height: 60rpx;
		background: #e8e8e8;
		margin: 0 20rpx;
	}
	
	.text-success {
		color: #67c23a !important;
	}
	
	.text-muted {
		color: #909399 !important;
	}
	
	/* ä¸»å†…å®¹åŒº */
	.main-content {
		flex: 1;
		overflow-y: auto;
		padding: 20rpx;
	}
	
	/* æ‰«ææ˜¾ç¤ºå¡ç‰‡ */
	.scan-display-card {
		background: white;
		border-radius: 16rpx;
		padding: 30rpx;
		margin-bottom: 20rpx;
		box-shadow: 0 2rpx 12rpx rgba(0, 0, 0, 0.08);
	}
	
	.display-header {
		display: flex;
		justify-content: space-between;
		align-items: center;
		margin-bottom: 20rpx;
	}
	
	.header-left {
		display: flex;
		align-items: center;
	}
	
	.input-icon {
		font-size: 36rpx;
		margin-right: 12rpx;
	}
	
	.input-title {
		font-size: 32rpx;
		font-weight: bold;
		color: #333;
	}
	
	.header-right {
		display: flex;
		gap: 16rpx;
	}
	
	/* ç¯å…‰å¼€å…³ */
	.light-switch {
		display: flex;
		flex-direction: column;
		align-items: center;
		padding: 12rpx 20rpx;
		background: #f5f7fa;
		border-radius: 12rpx;
		transition: all 0.2s;
	}
	
	.light-switch:active {
		background: #e4e7ed;
		transform: scale(0.95);
	}
	
	.light-icon {
		font-size: 32rpx;
		margin-bottom: 4rpx;
	}
	
	.light-text {
		font-size: 22rpx;
		color: #666;
	}
	
	/* æ¸…ç©ºæŒ‰é’® */
	.clear-btn {
		display: flex;
		flex-direction: column;
		align-items: center;
		padding: 12rpx 20rpx;
		background: #fff5f5;
		border-radius: 12rpx;
		transition: all 0.2s;
	}
	
	.clear-btn:active {
		background: #fee;
		transform: scale(0.95);
	}
	
	.clear-icon {
		font-size: 32rpx;
		margin-bottom: 4rpx;
	}
	
	.clear-text {
		font-size: 22rpx;
		color: #f56c6c;
	}
	
	/* å½“å‰æ‰«æç»“æœ */
	.current-result {
		background: linear-gradient(135deg, #11cec2 0%, #26736d 100%);
		border-radius: 12rpx;
		padding: 24rpx;
	}
	
	.result-content {
		background: rgba(255, 255, 255, 0.15);
		padding: 24rpx;
		border-radius: 8rpx;
		margin-bottom: 16rpx;
	}
	
	.result-data {
		font-size: 32rpx;
		color: white;
		word-break: break-all;
		line-height: 1.6;
		font-weight: 500;
	}
	
	.result-footer {
		text-align: right;
	}
	
	.result-time {
		font-size: 24rpx;
		color: rgba(255, 255, 255, 0.7);
	}
	
	/* ç­‰å¾…æ‰«æçŠ¶æ€ */
	.waiting-state {
		display: flex;
		flex-direction: column;
		align-items: center;
		padding: 60rpx 40rpx;
		background: #f8f9fa;
		border-radius: 12rpx;
		border: 2rpx dashed #dcdfe6;
	}
	
	.waiting-icon {
		font-size: 80rpx;
		margin-bottom: 20rpx;
		opacity: 0.5;
	}
	
	.waiting-text {
		font-size: 28rpx;
		color: #909399;
		margin-bottom: 12rpx;
		font-weight: 500;
	}
	
	.waiting-hint {
		font-size: 24rpx;
		color: #c0c4cc;
		text-align: center;
		line-height: 1.6;
	}
	
	/* å†å²è®°å½• */
	.history-section {
		background: white;
		border-radius: 16rpx;
		padding: 30rpx;
		box-shadow: 0 2rpx 12rpx rgba(0, 0, 0, 0.08);
	}
	
	.section-header {
		display: flex;
		justify-content: space-between;
		align-items: center;
		margin-bottom: 20rpx;
		padding-bottom: 20rpx;
		border-bottom: 2rpx solid #f0f0f0;
	}
	
	.section-title {
		font-size: 32rpx;
		font-weight: bold;
		color: #333;
	}
	
	.section-count {
		font-size: 24rpx;
		color: #999;
	}
	
	.history-scroll {
		max-height: 600rpx;
	}
	
	.history-card {
		display: flex;
		align-items: center;
		padding: 24rpx;
		background: #f8f9fa;
		border-radius: 12rpx;
		margin-bottom: 16rpx;
		transition: all 0.2s;
	}
	
	.history-card:active {
		background: #e9ecef;
		transform: scale(0.98);
	}
	
	.history-number {
		width: 56rpx;
		height: 56rpx;
		background: linear-gradient(135deg, #11cec2 0%, #26736d 100%);
		color: white;
		border-radius: 50%;
		display: flex;
		align-items: center;
		justify-content: center;
		font-size: 24rpx;
		font-weight: bold;
		flex-shrink: 0;
		margin-right: 20rpx;
	}
	
	.history-info {
		flex: 1;
		display: flex;
		flex-direction: column;
		justify-content: center;
		min-width: 0;
	}
	
	.history-data {
		font-size: 28rpx;
		color: #333;
		word-break: break-all;
		margin-bottom: 8rpx;
		line-height: 1.5;
		font-weight: 500;
	}
	
	.history-time {
		font-size: 22rpx;
		color: #999;
		line-height: 1.4;
	}
	
	.history-count {
		flex-shrink: 0;
		margin-left: 16rpx;
		padding: 8rpx 16rpx;
		background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
		border-radius: 20rpx;
	}
	
	.count-text {
		font-size: 24rpx;
		color: white;
		font-weight: bold;
	}
	
	/* ç©ºçŠ¶æ€ */
	.empty-state {
		display: flex;
		flex-direction: column;
		align-items: center;
		justify-content: center;
		padding: 120rpx 40rpx;
		background: white;
		border-radius: 16rpx;
		box-shadow: 0 2rpx 12rpx rgba(0, 0, 0, 0.08);
	}
	
	.empty-icon {
		font-size: 120rpx;
		margin-bottom: 30rpx;
		opacity: 0.5;
	}
	
	.empty-text {
		font-size: 32rpx;
		color: #666;
		margin-bottom: 16rpx;
		font-weight: 500;
	}
	
	.empty-hint {
		font-size: 26rpx;
		color: #999;
		text-align: center;
		line-height: 1.6;
	}
	
</style>
```

### æ•ˆæœ





### å­˜åœ¨çš„BUG