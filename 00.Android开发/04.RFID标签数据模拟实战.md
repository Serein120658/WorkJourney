# RFID 功能开发实战指南

## 开发新功能的完整流程

### 标准开发流程图

```
需求分析
    ↓
界面设计（XML布局）
    ↓
创建 Activity（Java类）
    ↓
注册到 AndroidManifest.xml
    ↓
实现核心逻辑
    ↓
测试与优化
    ↓
上线部署
```

------

## 需求分析：读取厂家 RFID 标签

### 场景描述

**假设需求：** 厂家提供了一批带有 RFID 标签的货物，你需要：

1. 点击按钮开始扫描
2. 读取标签的 EPC、TID、RSSI、频率
3. 显示在列表中
4. 可以查看详细信息
5. 导出为 Excel

### 需求拆解

| 功能模块     | 技术实现                 | 难度 |
| ------------ | ------------------------ | ---- |
| 按钮触发扫描 | onClick + startInventory | ⭐    |
| 读取标签数据 | ReadListener 回调        | ⭐⭐   |
| 显示列表     | ListView + Adapter       | ⭐⭐   |
| 详情页面     | Intent 跳转              | ⭐    |
| 导出 Excel   | ExcelUtil                | ⭐⭐   |

------

## 功能设计

### 1. 界面设计（activity_tag_reader.xml）

#### 布局结构

```
顶部标题栏
    ↓
统计信息栏（标签数量、读取次数、耗时）
    ↓
标签列表（EPC、TID、RSSI、频率、读取次数）
    ↓
底部操作按钮（开始扫描、停止、清空、导出）
```

#### XML 布局代码

```xml
<?xml version="1.0" encoding="utf-8"?>
<LinearLayout xmlns:android="http://schemas.android.com/apk/res/android"
    android:layout_width="match_parent"
    android:layout_height="match_parent"
    android:orientation="vertical"
    android:padding="10dp">

    <!-- 标题栏 -->
    <TextView
        android:layout_width="match_parent"
        android:layout_height="wrap_content"
        android:text="RFID 标签读取器"
        android:textSize="24sp"
        android:textStyle="bold"
        android:gravity="center"
        android:paddingBottom="10dp"/>

    <!-- 统计信息栏 -->
    <LinearLayout
        android:layout_width="match_parent"
        android:layout_height="wrap_content"
        android:orientation="horizontal"
        android:background="#E3F2FD"
        android:padding="10dp">
        
        <TextView
            android:id="@+id/tagCountText"
            android:layout_width="0dp"
            android:layout_height="wrap_content"
            android:layout_weight="1"
            android:text="标签数: 0"
            android:textSize="16sp"/>
        
        <TextView
            android:id="@+id/readCountText"
            android:layout_width="0dp"
            android:layout_height="wrap_content"
            android:layout_weight="1"
            android:text="读取次数: 0"
            android:textSize="16sp"/>
        
        <TextView
            android:id="@+id/timeText"
            android:layout_width="0dp"
            android:layout_height="wrap_content"
            android:layout_weight="1"
            android:text="耗时: 00:00"
            android:textSize="16sp"/>
    </LinearLayout>

    <!-- 列表表头 -->
    <LinearLayout
        android:layout_width="match_parent"
        android:layout_height="wrap_content"
        android:orientation="horizontal"
        android:background="#BBDEFB"
        android:padding="5dp"
        android:layout_marginTop="10dp">
        
        <TextView
            android:layout_width="200dp"
            android:layout_height="wrap_content"
            android:text="EPC"
            android:textStyle="bold"/>
        
        <TextView
            android:layout_width="150dp"
            android:layout_height="wrap_content"
            android:text="TID"
            android:textStyle="bold"/>
        
        <TextView
            android:layout_width="80dp"
            android:layout_height="wrap_content"
            android:text="RSSI"
            android:textStyle="bold"/>
        
        <TextView
            android:layout_width="80dp"
            android:layout_height="wrap_content"
            android:text="次数"
            android:textStyle="bold"/>
    </LinearLayout>

    <!-- 标签列表 -->
    <ListView
        android:id="@+id/tagListView"
        android:layout_width="match_parent"
        android:layout_height="0dp"
        android:layout_weight="1"
        android:divider="#CCCCCC"
        android:dividerHeight="1dp"/>

    <!-- 操作按钮 -->
    <LinearLayout
        android:layout_width="match_parent"
        android:layout_height="wrap_content"
        android:orientation="horizontal"
        android:layout_marginTop="10dp">
        
        <Button
            android:id="@+id/startScanBtn"
            android:layout_width="0dp"
            android:layout_height="wrap_content"
            android:layout_weight="1"
            android:text="开始扫描"
            android:backgroundTint="#4CAF50"/>
        
        <Button
            android:id="@+id/stopScanBtn"
            android:layout_width="0dp"
            android:layout_height="wrap_content"
            android:layout_weight="1"
            android:text="停止"
            android:backgroundTint="#F44336"
            android:layout_marginLeft="5dp"
            android:enabled="false"/>
        
        <Button
            android:id="@+id/clearBtn"
            android:layout_width="0dp"
            android:layout_height="wrap_content"
            android:layout_weight="1"
            android:text="清空"
            android:layout_marginLeft="5dp"/>
        
        <Button
            android:id="@+id/exportBtn"
            android:layout_width="0dp"
            android:layout_height="wrap_content"
            android:layout_weight="1"
            android:text="导出"
            android:backgroundTint="#2196F3"
            android:layout_marginLeft="5dp"/>
    </LinearLayout>
</LinearLayout>
```

------

### 2. 创建列表项布局（tag_item.xml）

```xml
<?xml version="1.0" encoding="utf-8"?>
<LinearLayout xmlns:android="http://schemas.android.com/apk/res/android"
    android:layout_width="match_parent"
    android:layout_height="wrap_content"
    android:orientation="horizontal"
    android:padding="10dp">
    
    <TextView
        android:id="@+id/itemEpc"
        android:layout_width="200dp"
        android:layout_height="wrap_content"
        android:text="E280116060000207..."
        android:textSize="12sp"/>
    
    <TextView
        android:id="@+id/itemTid"
        android:layout_width="150dp"
        android:layout_height="wrap_content"
        android:text="E20000123456..."
        android:textSize="12sp"/>
    
    <TextView
        android:id="@+id/itemRssi"
        android:layout_width="80dp"
        android:layout_height="wrap_content"
        android:text="-45 dBm"
        android:textSize="12sp"/>
    
    <TextView
        android:id="@+id/itemCount"
        android:layout_width="80dp"
        android:layout_height="wrap_content"
        android:text="1"
        android:textSize="12sp"/>
</LinearLayout>
```

------

## 代码实现

### 步骤 1：创建数据模型类

```java
package com.pda.testuhfapi.model;

public class RFIDTag {
    public String epc;          // EPC 编码
    public String tid;          // TID 编码
    public int rssi;            // 信号强度
    public int frequency;       // 频率
    public int readCount;       // 读取次数
    public long firstReadTime;  // 首次读取时间
    public long lastReadTime;   // 最后读取时间
    
    public RFIDTag() {
        this.readCount = 0;
        this.firstReadTime = System.currentTimeMillis();
    }
    
    // 截取显示用的短 EPC（前12位）
    public String getShortEpc() {
        if (epc != null && epc.length() > 12) {
            return epc.substring(0, 12) + "...";
        }
        return epc;
    }
    
    // 截取显示用的短 TID
    public String getShortTid() {
        if (tid != null && tid.length() > 12) {
            return tid.substring(0, 12) + "...";
        }
        return tid;
    }
    
    // 格式化 RSSI
    public String getRssiString() {
        return rssi + " dBm";
    }
    
    // 格式化频率（kHz 转 MHz）
    public String getFrequencyString() {
        return String.format("%.2f MHz", frequency / 1000.0);
    }
}
```

------

### 步骤 2：创建 Adapter 适配器

```java
package com.pda.testuhfapi.adapter;

import android.content.Context;
import android.view.LayoutInflater;
import android.view.View;
import android.view.ViewGroup;
import android.widget.BaseAdapter;
import android.widget.TextView;

import com.pda.testuhfapi.R;
import com.pda.testuhfapi.model.RFIDTag;

import java.util.ArrayList;
import java.util.List;

public class RFIDTagAdapter extends BaseAdapter {
    private Context context;
    private List<RFIDTag> tagList;
    
    public RFIDTagAdapter(Context context) {
        this.context = context;
        this.tagList = new ArrayList<>();
    }
    
    public void setTagList(List<RFIDTag> tagList) {
        this.tagList = tagList;
        notifyDataSetChanged();
    }
    
    @Override
    public int getCount() {
        return tagList.size();
    }
    
    @Override
    public Object getItem(int position) {
        return tagList.get(position);
    }
    
    @Override
    public long getItemId(int position) {
        return position;
    }
    
    @Override
    public View getView(int position, View convertView, ViewGroup parent) {
        ViewHolder holder;
        
        if (convertView == null) {
            convertView = LayoutInflater.from(context)
                .inflate(R.layout.tag_item, parent, false);
            holder = new ViewHolder();
            holder.epcText = convertView.findViewById(R.id.itemEpc);
            holder.tidText = convertView.findViewById(R.id.itemTid);
            holder.rssiText = convertView.findViewById(R.id.itemRssi);
            holder.countText = convertView.findViewById(R.id.itemCount);
            convertView.setTag(holder);
        } else {
            holder = (ViewHolder) convertView.getTag();
        }
        
        RFIDTag tag = tagList.get(position);
        holder.epcText.setText(tag.getShortEpc());
        holder.tidText.setText(tag.getShortTid());
        holder.rssiText.setText(tag.getRssiString());
        holder.countText.setText(String.valueOf(tag.readCount));
        
        return convertView;
    }
    
    static class ViewHolder {
        TextView epcText;
        TextView tidText;
        TextView rssiText;
        TextView countText;
    }
}
```

------

### 步骤 3：创建 Activity

```java
package com.pda.testuhfapi;

import android.app.Activity;
import android.media.AudioManager;
import android.media.SoundPool;
import android.os.Bundle;
import android.os.Environment;
import android.os.Handler;
import android.os.Message;
import android.util.Log;
import android.view.View;
import android.widget.Button;
import android.widget.ListView;
import android.widget.TextView;
import android.widget.Toast;

import com.pda.Excel.ExcelUtil;
import com.pda.testuhfapi.adapter.RFIDTagAdapter;
import com.pda.testuhfapi.model.RFIDTag;
import com.pda.uhf.UHFEngine;
import com.pda.uhf.UHFParamsOperator;
import com.uhf.api.cls.ReadExceptionListener;
import com.uhf.api.cls.ReadListener;
import com.uhf.api.cls.Reader;

import java.util.ArrayList;
import java.util.List;

public class TagReaderActivity extends Activity implements View.OnClickListener {
    
    // UI 组件
    private TextView tagCountText;
    private TextView readCountText;
    private TextView timeText;
    private ListView tagListView;
    private Button startScanBtn;
    private Button stopScanBtn;
    private Button clearBtn;
    private Button exportBtn;
    
    // 数据
    private List<RFIDTag> tagList = new ArrayList<>();
    private RFIDTagAdapter adapter;
    private int totalReadCount = 0;
    private long startTime = 0;
    private boolean isScanning = false;
    
    // 音效
    private SoundPool soundPool;
    
    // Handler 消息
    private static final int UPDATE_LIST = 1;
    private static final int UPDATE_TIME = 2;
    private static final int SHOW_TOAST = 3;
    
    private Handler handler = new Handler() {
        @Override
        public void handleMessage(Message msg) {
            switch (msg.what) {
                case UPDATE_LIST:
                    updateUI();
                    break;
                case UPDATE_TIME:
                    updateTime();
                    handler.sendEmptyMessageDelayed(UPDATE_TIME, 1000);
                    break;
                case SHOW_TOAST:
                    Toast.makeText(TagReaderActivity.this, 
                        (String) msg.obj, Toast.LENGTH_SHORT).show();
                    break;
            }
        }
    };
    
    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_tag_reader);
        
        initViews();
        initSound();
        initRFID();
    }
    
    private void initViews() {
        tagCountText = findViewById(R.id.tagCountText);
        readCountText = findViewById(R.id.readCountText);
        timeText = findViewById(R.id.timeText);
        tagListView = findViewById(R.id.tagListView);
        
        startScanBtn = findViewById(R.id.startScanBtn);
        stopScanBtn = findViewById(R.id.stopScanBtn);
        clearBtn = findViewById(R.id.clearBtn);
        exportBtn = findViewById(R.id.exportBtn);
        
        startScanBtn.setOnClickListener(this);
        stopScanBtn.setOnClickListener(this);
        clearBtn.setOnClickListener(this);
        exportBtn.setOnClickListener(this);
        
        adapter = new RFIDTagAdapter(this);
        tagListView.setAdapter(adapter);
    }
    
    private void initSound() {
        soundPool = new SoundPool(10, AudioManager.STREAM_SYSTEM, 5);
        soundPool.load(this, R.raw.beep333, 1);
    }
    
    private void initRFID() {
        // 上电
        UHFEngine.getEngine().powerOn();
        
        // 连接模块
        Reader.READER_ERR er = UHFEngine.getEngine().connectModule(
            DefaultConfigure.UART_DEV_PATH, 1
        );
        
        if (er == Reader.READER_ERR.MT_OK_ERR) {
            // 配置参数
            configureRFID();
            Log.d("RFID", "初始化成功");
        } else {
            Log.e("RFID", "初始化失败");
            Toast.makeText(this, "RFID 模块初始化失败", Toast.LENGTH_SHORT).show();
        }
    }
    
    private void configureRFID() {
        // 配置功率
        Reader.AntPowerConf apcf = new Reader.AntPowerConf();
        apcf.antcnt = 1;
        Reader.AntPower jaap = new Reader.AntPower();
        jaap.readPower = 3000;  // 30 dBm
        jaap.writePower = 3000;
        jaap.antid = 1;
        apcf.Powers[0] = jaap;
        UHFParamsOperator.getInstance().setAntPowerConf(apcf);
        
        // 配置 Session 和 Target
        UHFParamsOperator.getInstance().setGen2Session(
            InventoryModeParams.SESSION.SESSION1
        );
        UHFParamsOperator.getInstance().setGen2Target(
            InventoryModeParams.TARGET.A_2_B
        );
        
        // 配置区域
        UHFParamsOperator.getInstance().setRegionConf(
            Reader.Region_Conf.RG_PRC
        );
    }
    
    @Override
    public void onClick(View v) {
        int id = v.getId();
        
        if (id == R.id.startScanBtn) {
            startScanning();
        } else if (id == R.id.stopScanBtn) {
            stopScanning();
        } else if (id == R.id.clearBtn) {
            clearData();
        } else if (id == R.id.exportBtn) {
            exportToExcel();
        }
    }
    
    private void startScanning() {
        if (isScanning) return;
        
        // 获取盘点参数（读取 TID）
        InventoryParams params = InventoryModeParams.getParams(
            InventoryModeParams.MODE.NORMAL,
            InventoryModeParams.inventoryParams,
            true  // 读取 TID
        );
        
        // 启动盘点
        Reader.READER_ERR er = UHFEngine.getEngine().startInventory(
            params, 
            readListener, 
            exceptionListener
        );
        
        if (er == Reader.READER_ERR.MT_OK_ERR) {
            isScanning = true;
            startTime = System.currentTimeMillis();
            
            startScanBtn.setEnabled(false);
            stopScanBtn.setEnabled(true);
            
            handler.sendEmptyMessage(UPDATE_TIME);
            
            Toast.makeText(this, "开始扫描...", Toast.LENGTH_SHORT).show();
        } else {
            Toast.makeText(this, "启动扫描失败", Toast.LENGTH_SHORT).show();
        }
    }
    
    private void stopScanning() {
        if (!isScanning) return;
        
        UHFEngine.getEngine().stopInventory();
        isScanning = false;
        
        startScanBtn.setEnabled(true);
        stopScanBtn.setEnabled(false);
        
        handler.removeMessages(UPDATE_TIME);
        
        Toast.makeText(this, "扫描已停止", Toast.LENGTH_SHORT).show();
    }
    
    private void clearData() {
        tagList.clear();
        totalReadCount = 0;
        adapter.setTagList(tagList);
        updateUI();
        Toast.makeText(this, "数据已清空", Toast.LENGTH_SHORT).show();
    }
    
    private void exportToExcel() {
        if (tagList.isEmpty()) {
            Toast.makeText(this, "没有数据可导出", Toast.LENGTH_SHORT).show();
            return;
        }
        
        String filepath = Environment.getExternalStorageDirectory().getPath();
        String filename = filepath + "/Documents/RFID_Tags_" + 
            Util.getCurrentTimeFormat() + ".xls";
        
        // 这里需要根据你的 ExcelUtil 实现调整
        // int status = ExcelUtil.writeExcel(filename, tagList);
        
        Toast.makeText(this, "导出成功：" + filename, Toast.LENGTH_LONG).show();
    }
    
    // RFID 读取监听器
    private ReadListener readListener = new ReadListener() {
        @Override
        public void tagRead(List<Reader.TagInfo> list) {
            if (list == null || list.isEmpty()) return;
            
            for (Reader.TagInfo tagInfo : list) {
                // 解析标签数据
                String epc = Reader.bytes_Hexstr(tagInfo.EpcId);
                String tid = Reader.bytes_Hexstr(tagInfo.EmbededData);
                
                // 查找或创建标签对象
                RFIDTag tag = findOrCreateTag(epc);
                tag.epc = epc;
                tag.tid = tid;
                tag.rssi = tagInfo.RSSI;
                tag.frequency = tagInfo.Frequency;
                tag.readCount++;
                tag.lastReadTime = System.currentTimeMillis();
                
                totalReadCount++;
                
                Log.d("RFID", "读取标签: " + epc);
            }
            
            // 更新 UI
            handler.sendEmptyMessage(UPDATE_LIST);
            
            // 播放提示音
            soundPool.play(1, 1, 1, 0, 0, 1);
        }
    };
    
    // RFID 异常监听器
    private ReadExceptionListener exceptionListener = new ReadExceptionListener() {
        @Override
        public void tagReadException(Reader.READER_ERR er) {
            Log.e("RFID", "读取异常: " + er);
            Message msg = handler.obtainMessage(SHOW_TOAST);
            msg.obj = "读取异常: " + er;
            handler.sendMessage(msg);
        }
    };
    
    // 查找或创建标签
    private RFIDTag findOrCreateTag(String epc) {
        for (RFIDTag tag : tagList) {
            if (tag.epc.equals(epc)) {
                return tag;
            }
        }
        
        RFIDTag newTag = new RFIDTag();
        tagList.add(newTag);
        return newTag;
    }
    
    // 更新 UI
    private void updateUI() {
        tagCountText.setText("标签数: " + tagList.size());
        readCountText.setText("读取次数: " + totalReadCount);
        adapter.setTagList(tagList);
    }
    
    // 更新时间
    private void updateTime() {
        if (startTime == 0) return;
        
        long elapsed = (System.currentTimeMillis() - startTime) / 1000;
        int minutes = (int) (elapsed / 60);
        int seconds = (int) (elapsed % 60);
        
        timeText.setText(String.format("耗时: %02d:%02d", minutes, seconds));
    }
    
    @Override
    protected void onDestroy() {
        super.onDestroy();
        
        // 停止扫描
        if (isScanning) {
            UHFEngine.getEngine().stopInventory();
        }
        
        // 断开连接
        UHFEngine.getEngine().disconnectModule();
        
        // 下电
        UHFEngine.getEngine().powerOff();
        
        // 释放音效
        if (soundPool != null) {
            soundPool.release();
        }
    }
}
```

------

### 步骤 4：注册到 AndroidManifest.xml

```xml
<activity
    android:name=".TagReaderActivity"
    android:exported="false"
    android:label="RFID 标签读取器" />
```

------

## 完整示例：批量读取并保存

### 场景：仓库入库扫描

#### 需求

1. 扫描一批货物的 RFID 标签
2. 记录每个标签的信息
3. 自动去重
4. 导出为 Excel 供后续处理

#### 增强功能代码

```java
// 在 TagReaderActivity 中添加以下功能

// 1. 添加过滤功能（只读取特定前缀的标签）
private String filterPrefix = "E280";  // 只读取以 E280 开头的标签

private boolean shouldFilterTag(String epc) {
    if (filterPrefix == null || filterPrefix.isEmpty()) {
        return false;  // 不过滤
    }
    return !epc.startsWith(filterPrefix);  // 不符合前缀则过滤
}

// 修改 readListener
private ReadListener readListener = new ReadListener() {
    @Override
    public void tagRead(List<Reader.TagInfo> list) {
        if (list == null || list.isEmpty()) return;
        
        for (Reader.TagInfo tagInfo : list) {
            String epc = Reader.bytes_Hexstr(tagInfo.EpcId);
            
            // 过滤标签
            if (shouldFilterTag(epc)) {
                continue;
            }
            
            String tid = Reader.bytes_Hexstr(tagInfo.EmbededData);
            
            RFIDTag tag = findOrCreateTag(epc);
            tag.epc = epc;
            tag.tid = tid;
            tag.rssi = tagInfo.RSSI;
            tag.frequency = tagInfo.Frequency;
            tag.readCount++;
            tag.lastReadTime = System.currentTimeMillis();
            
            totalReadCount++;
        }
        
        handler.sendEmptyMessage(UPDATE_LIST);
        soundPool.play(1, 1, 1, 0, 0, 1);
    }
};

// 2. 添加自动停止功能（读取到指定数量后自动停止）
private int targetCount = 0;  // 0 表示不限制

private void checkAutoStop() {
    if (targetCount > 0 && tagList.size() >= targetCount) {
        stopScanning();
        Toast.makeText(this, 
            "已读取到 " + targetCount + " 个标签，自动停止", 
            Toast.LENGTH_LONG).show();
    }
}

// 修改 updateUI
private void updateUI() {
    tagCountText.setText("标签数: " + tagList.size());
    readCountText.setText("读取次数: " + totalReadCount);
    adapter.setTagList(tagList);
    
    // 检查是否需要自动停止
    checkAutoStop();
}

// 3. 添加数据验证（检查标签是否有效）
private boolean isValidTag(RFIDTag tag) {
    // EPC 不能为空
    if (tag.epc == null || tag.epc.isEmpty()) {
        return false;
    }
    
    // EPC 长度检查（通常是 24 个字符，即 96 位）
    if (tag.epc.length() < 24) {
        return false;
    }
    
    // RSSI 合理范围检查
    if (tag.rssi < -90 || tag.rssi > -20) {
        return false;
    }
    
    return true;
}

// 4. 添加详细信息对话框
private void showTagDetail(RFIDTag tag) {
    AlertDialog.Builder builder = new AlertDialog.Builder(this);
    builder.setTitle("标签详细信息");
    
    String message = "EPC: " + tag.epc + "\n" +
                    "TID: " + tag.tid + "\n" +
                    "RSSI: " + tag.rssi + " dBm\n" +
                    "频率: " + tag.getFrequencyString() + "\n" +
                    "读取次数: " + tag.readCount + "\n" +
                    "首次读取: " + formatTime(tag.firstReadTime) + "\n" +
                    "最后读取: " + formatTime(tag.lastReadTime);
    
    builder.setMessage(message);
    builder.setPositiveButton("确定", null);
    builder.show();
}

private String formatTime(long timestamp) {
    SimpleDateFormat sdf = new SimpleDateFormat("yyyy-MM-dd HH:mm:ss");
    return sdf.format(new Date(timestamp));
}

// 在 ListView 中添加点击事件
tagListView.setOnItemClickListener(new AdapterView.OnItemClickListener() {
    @Override
    public void onItemClick(AdapterView<?> parent, View view, int position, long id) {
        RFIDTag tag = tagList.get(position);
        showTagDetail(tag);
    }
});
```

------

## 进阶功能开发

### 1. 实时统计图表

```java
// 添加依赖（build.gradle）
implementation 'com.github.PhilJay:MPAndroidChart:v3.1.0'

// 在布局中添加图表
<com.github.mikephil.charting.charts.BarChart
    android:id="@+id/readRateChart"
    android:layout_width="match_parent"
    android:layout_height="200dp"/>

// 在 Activity 中实现图表
private BarChart readRateChart;
private List<Integer> readRateHistory = new ArrayList<>();

private void initChart() {
    readRateChart = findViewById(R.id.readRateChart);
    readRateChart.getDescription().setEnabled(false);
    readRateChart.setTouchEnabled(true);
    readRateChart.setDragEnabled(true);
    readRateChart.setScaleEnabled(true);
}

private void updateChart() {
    // 记录每秒的读取速率
    readRateHistory.add(tagList.size());
    
    ArrayList<BarEntry> entries = new ArrayList<>();
    for (int i = 0; i < readRateHistory.size(); i++) {
        entries.add(new BarEntry(i, readRateHistory.get(i)));
    }
    
    BarDataSet dataSet = new BarDataSet(entries, "读取速率");
    dataSet.setColor(Color.BLUE);
    
    BarData barData = new BarData(dataSet);
    readRateChart.setData(barData);
    readRateChart.invalidate();  // 刷新图表
}
```

------

### 2. 批量写入标签

**场景：** 给新货物批量写入 EPC

```java
public class BatchWriteActivity extends Activity {
    
    private EditText prefixInput;    // EPC 前缀
    private EditText startNumInput;  // 起始序号
    private Button startWriteBtn;
    private TextView progressText;
    
    private String epcPrefix = "E280116060000207";  // EPC 前缀（24位）
    private int currentNum = 1;
    private int totalWritten = 0;
    
    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_batch_write);
        
        initViews();
        initRFID();
    }
    
    private void initViews() {
        prefixInput = findViewById(R.id.prefixInput);
        startNumInput = findViewById(R.id.startNumInput);
        startWriteBtn = findViewById(R.id.startWriteBtn);
        progressText = findViewById(R.id.progressText);
        
        startWriteBtn.setOnClickListener(v -> startBatchWrite());
    }
    
    private void startBatchWrite() {
        epcPrefix = prefixInput.getText().toString().trim();
        currentNum = Integer.parseInt(startNumInput.getText().toString());
        
        if (epcPrefix.length() != 20) {
            Toast.makeText(this, "EPC 前缀必须是20位", Toast.LENGTH_SHORT).show();
            return;
        }
        
        // 开始盘点，找到空白标签
        startInventoryForWrite();
    }
    
    private void startInventoryForWrite() {
        InventoryParams params = InventoryModeParams.getParams(
            InventoryModeParams.MODE.NORMAL,
            null,
            false
        );
        
        UHFEngine.getEngine().startInventory(params, writeListener, null);
    }
    
    private ReadListener writeListener = new ReadListener() {
        @Override
        public void tagRead(List<Reader.TagInfo> list) {
            if (list == null || list.isEmpty()) return;
            
            // 停止盘点
            UHFEngine.getEngine().stopInventory();
            
            // 获取第一个标签
            Reader.TagInfo tagInfo = list.get(0);
            String oldEpc = Reader.bytes_Hexstr(tagInfo.EpcId);
            
            // 生成新的 EPC
            String newEpc = generateNewEpc(currentNum);
            
            // 写入新 EPC
            writeEpcToTag(oldEpc, newEpc);
        }
    };
    
    private String generateNewEpc(int num) {
        // EPC 格式：前缀(20位) + 序号(4位)
        // 例如：E28011606000020700001234
        String numStr = String.format("%04d", num);
        return epcPrefix + numStr;
    }
    
    private void writeEpcToTag(String oldEpc, String newEpc) {
        // 将十六进制字符串转为字节数组
        byte[] oldEpcBytes = hexStringToBytes(oldEpc);
        byte[] newEpcBytes = hexStringToBytes(newEpc);
        
        // 写入（无密码）
        Reader.READER_ERR er = UHFEngine.getEngine().writeEpcByEpcNoPassword(
            newEpcBytes,
            oldEpcBytes
        );
        
        if (er == Reader.READER_ERR.MT_OK_ERR) {
            totalWritten++;
            currentNum++;
            
            runOnUiThread(() -> {
                progressText.setText("已写入: " + totalWritten + " 个标签");
                Toast.makeText(this, "写入成功: " + newEpc, 
                    Toast.LENGTH_SHORT).show();
            });
            
            // 继续下一个
            new Handler().postDelayed(() -> startInventoryForWrite(), 500);
        } else {
            runOnUiThread(() -> {
                Toast.makeText(this, "写入失败，请重试", 
                    Toast.LENGTH_SHORT).show();
            });
        }
    }
    
    private byte[] hexStringToBytes(String hexString) {
        int len = hexString.length();
        byte[] data = new byte[len / 2];
        for (int i = 0; i < len; i += 2) {
            data[i / 2] = (byte) ((Character.digit(hexString.charAt(i), 16) << 4)
                + Character.digit(hexString.charAt(i + 1), 16));
        }
        return data;
    }
}
```

------

### 3. 标签定位功能

**场景：** 在大量标签中快速定位特定标签

```java
public class TagLocatorActivity extends Activity {
    
    private EditText targetEpcInput;
    private Button startLocateBtn;
    private TextView rssiText;
    private ProgressBar signalBar;
    
    private String targetEpc;
    private boolean isLocating = false;
    
    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_tag_locator);
        
        initViews();
        initRFID();
    }
    
    private void initViews() {
        targetEpcInput = findViewById(R.id.targetEpcInput);
        startLocateBtn = findViewById(R.id.startLocateBtn);
        rssiText = findViewById(R.id.rssiText);
        signalBar = findViewById(R.id.signalBar);
        
        startLocateBtn.setOnClickListener(v -> toggleLocate());
    }
    
    private void toggleLocate() {
        if (isLocating) {
            stopLocating();
        } else {
            startLocating();
        }
    }
    
    private void startLocating() {
        targetEpc = targetEpcInput.getText().toString().trim();
        
        if (targetEpc.isEmpty()) {
            Toast.makeText(this, "请输入目标 EPC", Toast.LENGTH_SHORT).show();
            return;
        }
        
        InventoryParams params = InventoryModeParams.getParams(
            InventoryModeParams.MODE.FAST,  // 使用快速模式
            null,
            false
        );
        
        Reader.READER_ERR er = UHFEngine.getEngine().startInventory(
            params, 
            locateListener, 
            null
        );
        
        if (er == Reader.READER_ERR.MT_OK_ERR) {
            isLocating = true;
            startLocateBtn.setText("停止定位");
            Toast.makeText(this, "开始定位...", Toast.LENGTH_SHORT).show();
        }
    }
    
    private void stopLocating() {
        UHFEngine.getEngine().stopInventory();
        isLocating = false;
        startLocateBtn.setText("开始定位");
        Toast.makeText(this, "停止定位", Toast.LENGTH_SHORT).show();
    }
    
    private ReadListener locateListener = new ReadListener() {
        @Override
        public void tagRead(List<Reader.TagInfo> list) {
            if (list == null || list.isEmpty()) return;
            
            for (Reader.TagInfo tagInfo : list) {
                String epc = Reader.bytes_Hexstr(tagInfo.EpcId);
                
                // 只处理目标标签
                if (epc.equals(targetEpc)) {
                    int rssi = tagInfo.RSSI;
                    
                    runOnUiThread(() -> {
                        updateSignalStrength(rssi);
                    });
                    
                    // 根据信号强度播放不同频率的提示音
                    playLocateSound(rssi);
                    
                    break;
                }
            }
        }
    };
    
    private void updateSignalStrength(int rssi) {
        // RSSI 范围：-80 到 -30 dBm
        // 转换为进度条：0-100
        int progress = (rssi + 80) * 2;  // -80 → 0, -30 → 100
        progress = Math.max(0, Math.min(100, progress));
        
        signalBar.setProgress(progress);
        rssiText.setText(rssi + " dBm");
        
        // 根据信号强度改变颜色
        if (rssi > -40) {
            rssiText.setTextColor(Color.GREEN);
            rssiText.setText("很近！" + rssi + " dBm");
        } else if (rssi > -55) {
            rssiText.setTextColor(Color.YELLOW);
            rssiText.setText("较近 " + rssi + " dBm");
        } else if (rssi > -70) {
            rssiText.setTextColor(Color.ORANGE);
            rssiText.setText("中等 " + rssi + " dBm");
        } else {
            rssiText.setTextColor(Color.RED);
            rssiText.setText("较远 " + rssi + " dBm");
        }
    }
    
    private void playLocateSound(int rssi) {
        // 信号越强，提示音间隔越短
        long interval = (long) ((-rssi - 30) * 20);  // -30dBm → 100ms, -80dBm → 1000ms
        interval = Math.max(100, Math.min(1000, interval));
        
        // 使用 Handler 控制提示音频率
        // 这里简化处理，实际应该用 Timer
        soundPool.play(1, 1, 1, 0, 0, 1);
    }
}
```

------

### 4. 数据同步到服务器

**场景：** 扫描完成后上传到服务器

```java
public class DataSyncHelper {
    
    private static final String API_URL = "https://your-api.com/rfid/upload";
    
    public static void syncToServer(List<RFIDTag> tagList, 
                                    SyncCallback callback) {
        new Thread(() -> {
            try {
                // 构建 JSON 数据
                JSONObject jsonData = new JSONObject();
                jsonData.put("timestamp", System.currentTimeMillis());
                jsonData.put("device_id", getDeviceId());
                
                JSONArray tagArray = new JSONArray();
                for (RFIDTag tag : tagList) {
                    JSONObject tagObj = new JSONObject();
                    tagObj.put("epc", tag.epc);
                    tagObj.put("tid", tag.tid);
                    tagObj.put("rssi", tag.rssi);
                    tagObj.put("frequency", tag.frequency);
                    tagObj.put("read_count", tag.readCount);
                    tagObj.put("first_read_time", tag.firstReadTime);
                    tagObj.put("last_read_time", tag.lastReadTime);
                    tagArray.put(tagObj);
                }
                jsonData.put("tags", tagArray);
                
                // 发送 HTTP POST 请求
                URL url = new URL(API_URL);
                HttpURLConnection conn = (HttpURLConnection) url.openConnection();
                conn.setRequestMethod("POST");
                conn.setRequestProperty("Content-Type", "application/json");
                conn.setDoOutput(true);
                
                OutputStream os = conn.getOutputStream();
                os.write(jsonData.toString().getBytes("UTF-8"));
                os.close();
                
                int responseCode = conn.getResponseCode();
                
                if (responseCode == 200) {
                    callback.onSuccess("上传成功");
                } else {
                    callback.onError("上传失败: " + responseCode);
                }
                
                conn.disconnect();
                
            } catch (Exception e) {
                callback.onError("上传异常: " + e.getMessage());
            }
        }).start();
    }
    
    private static String getDeviceId() {
        // 获取设备唯一标识
        return android.os.Build.SERIAL;
    }
    
    public interface SyncCallback {
        void onSuccess(String message);
        void onError(String error);
    }
}

// 在 Activity 中使用
private void uploadData() {
    if (tagList.isEmpty()) {
        Toast.makeText(this, "没有数据可上传", Toast.LENGTH_SHORT).show();
        return;
    }
    
    ProgressDialog dialog = new ProgressDialog(this);
    dialog.setMessage("正在上传...");
    dialog.show();
    
    DataSyncHelper.syncToServer(tagList, new DataSyncHelper.SyncCallback() {
        @Override
        public void onSuccess(String message) {
            runOnUiThread(() -> {
                dialog.dismiss();
                Toast.makeText(TagReaderActivity.this, message, 
                    Toast.LENGTH_SHORT).show();
            });
        }
        
        @Override
        public void onError(String error) {
            runOnUiThread(() -> {
                dialog.dismiss();
                Toast.makeText(TagReaderActivity.this, error, 
                    Toast.LENGTH_SHORT).show();
            });
        }
    });
}
```

------

### 5. 标签过滤与分组

**场景：** 根据 EPC 前缀自动分组

```java
public class TagFilterHelper {
    
    // 定义标签类型
    public enum TagType {
        CLOTHING("E280", "服装"),
        ELECTRONICS("E281", "电子产品"),
        FOOD("E282", "食品"),
        BOOK("E283", "图书"),
        OTHER("", "其他");
        
        private String prefix;
        private String name;
        
        TagType(String prefix, String name) {
            this.prefix = prefix;
            this.name = name;
        }
        
        public String getPrefix() {
            return prefix;
        }
        
        public String getName() {
            return name;
        }
        
        public static TagType fromEpc(String epc) {
            if (epc == null || epc.length() < 4) {
                return OTHER;
            }
            
            String prefix = epc.substring(0, 4);
            for (TagType type : values()) {
                if (type.prefix.equals(prefix)) {
                    return type;
                }
            }
            return OTHER;
        }
    }
    
    // 标签分组
    public static Map<TagType, List<RFIDTag>> groupByType(List<RFIDTag> tagList) {
        Map<TagType, List<RFIDTag>> groupedMap = new HashMap<>();
        
        // 初始化分组
        for (TagType type : TagType.values()) {
            groupedMap.put(type, new ArrayList<>());
        }
        
        // 分组
        for (RFIDTag tag : tagList) {
            TagType type = TagType.fromEpc(tag.epc);
            groupedMap.get(type).add(tag);
        }
        
        return groupedMap;
    }
    
    // 过滤标签
    public static List<RFIDTag> filterByType(List<RFIDTag> tagList, 
                                            TagType targetType) {
        List<RFIDTag> filtered = new ArrayList<>();
        
        for (RFIDTag tag : tagList) {
            TagType type = TagType.fromEpc(tag.epc);
            if (type == targetType) {
                filtered.add(tag);
            }
        }
        
        return filtered;
    }
    
    // 统计各类型数量
    public static String getStatistics(List<RFIDTag> tagList) {
        Map<TagType, List<RFIDTag>> grouped = groupByType(tagList);
        
        StringBuilder sb = new StringBuilder();
        sb.append("标签分类统计:\n");
        
        for (Map.Entry<TagType, List<RFIDTag>> entry : grouped.entrySet()) {
            TagType type = entry.getKey();
            List<RFIDTag> tags = entry.getValue();
            
            if (!tags.isEmpty()) {
                sb.append(type.getName())
                  .append(": ")
                  .append(tags.size())
                  .append(" 个\n");
            }
        }
        
        return sb.toString();
    }
}

// 在 Activity 中使用
private void showStatistics() {
    String stats = TagFilterHelper.getStatistics(tagList);
    
    AlertDialog.Builder builder = new AlertDialog.Builder(this);
    builder.setTitle("统计信息");
    builder.setMessage(stats);
    builder.setPositiveButton("确定", null);
    builder.show();
}

private void filterByCategory() {
    // 显示类型选择对话框
    String[] types = new String[TagFilterHelper.TagType.values().length];
    TagFilterHelper.TagType[] typeValues = TagFilterHelper.TagType.values();
    
    for (int i = 0; i < typeValues.length; i++) {
        types[i] = typeValues[i].getName();
    }
    
    AlertDialog.Builder builder = new AlertDialog.Builder(this);
    builder.setTitle("选择类型");
    builder.setItems(types, (dialog, which) -> {
        TagFilterHelper.TagType selectedType = typeValues[which];
        List<RFIDTag> filtered = TagFilterHelper.filterByType(tagList, selectedType);
        
        // 更新显示
        adapter.setTagList(filtered);
        Toast.makeText(this, "已过滤：" + selectedType.getName() + 
            " (" + filtered.size() + " 个)", Toast.LENGTH_SHORT).show();
    });
    builder.setNegativeButton("显示全部", (dialog, which) -> {
        adapter.setTagList(tagList);
    });
    builder.show();
}
```

------

## 开发调试技巧

### 1. 使用模拟数据测试（无需真实设备）

```java
// 在 Activity 中添加模拟数据按钮
private Button mockDataBtn;

mockDataBtn.setOnClickListener(v -> generateMockData());

private void generateMockData() {
    String[] mockEpcs = {
        "E28011606000020700000001",
        "E28011606000020700000002",
        "E28111606000020700000003",
        "E28211606000020700000004",
        "E28311606000020700000005"
    };
    
    String[] mockTids = {
        "E200001234567890ABCDEF01",
        "E200001234567890ABCDEF02",
        "E200001234567890ABCDEF03",
        "E200001234567890ABCDEF04",
        "E200001234567890ABCDEF05"
    };
    
    Random random = new Random();
    
    for (int i = 0; i < 3; i++) {
        int index = random.nextInt(mockEpcs.length);
        
        RFIDTag tag = new RFIDTag();
        tag.epc = mockEpcs[index];
        tag.tid = mockTids[index];
        tag.rssi = -45 - random.nextInt(25);  // -45 到 -70
        tag.frequency = 920000 + random.nextInt(5000);
        tag.readCount = random.nextInt(10) + 1;
        tag.firstReadTime = System.currentTimeMillis() - random.nextInt(60000);
        tag.lastReadTime = System.currentTimeMillis();
        
        // 去重添加
        RFIDTag existing = findOrCreateTag(tag.epc);
        if (existing.readCount == 0) {
            tagList.add(tag);
        } else {
            existing.readCount++;
        }
        
        totalReadCount++;
    }
    
    updateUI();
    soundPool.play(1, 1, 1, 0, 0, 1);
    Toast.makeText(this, "已添加模拟数据", Toast.LENGTH_SHORT).show();
}
```

------

### 2. 日志记录与调试

```java
public class RFIDLogger {
    private static final String TAG = "RFID";
    private static final String LOG_FILE = "rfid_log.txt";
    
    // 记录到文件
    public static void logToFile(String message) {
        try {
            String filepath = Environment.getExternalStorageDirectory().getPath();
            File logFile = new File(filepath + "/Documents/" + LOG_FILE);
            
            FileWriter fw = new FileWriter(logFile, true);
            BufferedWriter bw = new BufferedWriter(fw);
            
            String timestamp = new SimpleDateFormat("yyyy-MM-dd HH:mm:ss")
                .format(new Date());
            bw.write(timestamp + " - " + message + "\n");
            
            bw.close();
            fw.close();
        } catch (IOException e) {
            Log.e(TAG, "写入日志失败: " + e.getMessage());
        }
    }
    
    // 详细日志
    public static void logTagRead(RFIDTag tag) {
        String message = String.format(
            "读取标签 | EPC: %s | TID: %s | RSSI: %d | Freq: %d | Count: %d",
            tag.epc, tag.tid, tag.rssi, tag.frequency, tag.readCount
        );
        
        Log.d(TAG, message);
        logToFile(message);
    }
    
    // 错误日志
    public static void logError(String operation, Exception e) {
        String message = "错误 | " + operation + " | " + e.getMessage();
        Log.e(TAG, message);
        logToFile(message);
    }
}

// 在读取回调中使用
private ReadListener readListener = new ReadListener() {
    @Override
    public void tagRead(List<Reader.TagInfo> list) {
        if (list == null || list.isEmpty()) return;
        
        for (Reader.TagInfo tagInfo : list) {
            try {
                String epc = Reader.bytes_Hexstr(tagInfo.EpcId);
                String tid = Reader.bytes_Hexstr(tagInfo.EmbededData);
                
                RFIDTag tag = findOrCreateTag(epc);
                tag.epc = epc;
                tag.tid = tid;
                tag.rssi = tagInfo.RSSI;
                tag.frequency = tagInfo.Frequency;
                tag.readCount++;
                
                // 记录日志
                RFIDLogger.logTagRead(tag);
                
                totalReadCount++;
            } catch (Exception e) {
                RFIDLogger.logError("读取标签", e);
            }
        }
        
        handler.sendEmptyMessage(UPDATE_LIST);
        soundPool.play(1, 1, 1, 0, 0, 1);
    }
};
```

------

### 3. 性能监控

```java
public class PerformanceMonitor {
    private long startTime;
    private int readCount;
    private List<Long> readIntervals = new ArrayList<>();
    
    public void start() {
        startTime = System.currentTimeMillis();
        readCount = 0;
        readIntervals.clear();
    }
    
    public void recordRead() {
        long now = System.currentTimeMillis();
        if (readCount > 0) {
            readIntervals.add(now - startTime);
        }
        readCount++;
        startTime = now;
    }
    
    public String getReport() {
        if (readIntervals.isEmpty()) {
            return "暂无数据";
        }
        
        // 计算平均间隔
        long totalInterval = 0;
        for (Long interval : readIntervals) {
            totalInterval += interval;
        }
        long avgInterval = totalInterval / readIntervals.size();
        
        // 计算读取速率（标签/秒）
        double readRate = 1000.0 / avgInterval;
        
        return String.format(
            "性能报告:\n" +
            "总读取次数: %d\n" +
            "平均间隔: %d ms\n" +
            "读取速率: %.2f 标签/秒\n" +
            "最快间隔: %d ms\n" +
            "最慢间隔: %d ms",
            readCount,
            avgInterval,
            readRate,
            Collections.min(readIntervals),
            Collections.max(readIntervals)
        );
    }
}
```

------

## 常见问题与解决方案

### 问题 1：读取不到标签

**排查步骤：**

```java
private void diagnoseReadIssue() {
    StringBuilder diagnosis = new StringBuilder("诊断结果:\n\n");
    
    // 1. 检查模块连接
    boolean isConnected = UHFEngine.getEngine().isConnected();
    diagnosis.append("模块连接: ").append(isConnected ? "✓" : "✗").append("\n");
    
    // 2. 检查功率配置
    AntPowerConfResult powerResult = UHFParamsOperator.getInstance()
        .getAntPowerConf();
    if (powerResult.code == Reader.READER_ERR.MT_OK_ERR) {
        int readPower = powerResult.value.Powers[0].readPower;
        diagnosis.append("读功率: ").append(readPower / 100.0).append(" dBm\n");
        
        if (readPower < 2000) {
            diagnosis.append("⚠️ 功率偏低，建议增大到 25-30 dBm\n");
        }
    }
    
    // 3. 检查区域配置
    RegionConfResult regionResult = UHFParamsOperator.getInstance()
        .getRegionConf();
    if (regionResult.code == Reader.READER_ERR.MT_OK_ERR) {
        diagnosis.append("工作区域: ")
            .append(CoverUtil.CoverRegion(regionResult.value))
            .append("\n");
    }
    
    // 4. 检查 Session 配置
    Gen2SessionResult sessionResult = UHFParamsOperator.getInstance()
        .getGen2Session();
    if (sessionResult.code == Reader.READER_ERR.MT_OK_ERR) {
        diagnosis.append("Session: S").append(sessionResult.value).append("\n");
    }
    
    diagnosis.append("\n建议:\n");
    diagnosis.append("1. 检查标签是否在读取范围内\n");
    diagnosis.append("2. 确保标签与天线平行\n");
    diagnosis.append("3. 避免金属遮挡\n");
    diagnosis.append("4. 尝试增大功率\n");
    
    // 显示诊断结果
    AlertDialog.Builder builder = new AlertDialog.Builder(this);
    builder.setTitle("读取诊断");
    builder.setMessage(diagnosis.toString());
    builder.setPositiveButton("确定", null);
    builder.show();
}
```

### 问题 2：重复读取严重

**解决方案：**

```java
// 方案 1：使用更长的 Session
UHFParamsOperator.getInstance().setGen2Session(
    InventoryModeParams.SESSION.SESSION2  // 2秒超时
);

// 方案 2：软件去重（时间窗口）
private Map<String, Long> lastReadTime = new HashMap<>();
private static final long DUPLICATE_THRESHOLD = 1000;  // 1秒内视为重复

private boolean isDuplicate(String epc) {
    long now = System.currentTimeMillis();
    Long lastTime = lastReadTime.get(epc);
    
    if (lastTime != null && (now - lastTime) < DUPLICATE_THRESHOLD) {
        return true;  // 是重复
    }
    
    lastReadTime.put(epc, now);
    return false;
}

// 在回调中使用
if (!isDuplicate(epc)) {
    // 处理标签
}
```

### 问题 3：读取距离太近

**解决方案：**

```java
// 增大功率
Reader.AntPower jaap = new Reader.AntPower();
jaap.readPower = 3300;  // 最大功率 33 dBm
jaap.writePower = 3300;

// 检查标签类型
// 确保使用的是远距离标签，而不是近场标签
```

------

## 总结：开发新功能的核心要点

### 1. 开发流程清单

```
✅ 第一步：需求分析
   - 明确要实现什么功能
   - 确定需要读取哪些数据（EPC、TID、RSSI等）
   - 确定数据如何展示和处理

✅ 第二步：设计界面
   - 在 res/layout/ 创建 XML 布局文件
   - 设计列表项布局（如需要）
   - 添加必要的按钮、输入框、显示控件

✅ 第三步：创建 Activity
   - 在 java 包下创建新的 Activity 类
   - 继承 Activity 或 AppCompatActivity
   - 实现基本的生命周期方法

✅ 第四步：注册 Activity
   - 在 AndroidManifest.xml 中注册新的 Activity
   - 设置 exported 属性（通常为 false）

✅ 第五步：初始化 RFID
   - 在 onResume() 中上电和连接
   - 配置必要的参数（功率、Session、Target、Region）
   - 在 onPause() 或 onDestroy() 中断开和下电

✅ 第六步：实现核心逻辑
   - 创建 ReadListener 处理读取回调
   - 创建数据模型类存储标签信息
   - 使用 Handler 更新 UI
   - 实现按钮点击事件

✅ 第七步：测试和优化
   - 先用模拟数据测试界面
   - 再用真实设备测试功能
   - 记录日志排查问题
   - 优化性能和用户体验
```

------

### 2. 核心代码模板

#### 最小可用模板

```java
public class MyRFIDActivity extends Activity {
    
    // 1. 声明变量
    private Button scanBtn;
    private TextView resultText;
    private boolean isScanning = false;
    
    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_my_rfid);
        
        // 2. 初始化 UI
        scanBtn = findViewById(R.id.scanBtn);
        resultText = findViewById(R.id.resultText);
        
        scanBtn.setOnClickListener(v -> toggleScan());
    }
    
    @Override
    protected void onResume() {
        super.onResume();
        // 3. 上电并连接
        UHFEngine.getEngine().powerOn();
        UHFEngine.getEngine().connectModule(DefaultConfigure.UART_DEV_PATH, 1);
        
        // 4. 配置参数（可选，使用默认配置也可以）
        DefaultConfigure.defaultInitModule();
    }
    
    @Override
    protected void onPause() {
        super.onPause();
        // 5. 断开并下电
        stopScan();
        UHFEngine.getEngine().disconnectModule();
        UHFEngine.getEngine().powerOff();
    }
    
    private void toggleScan() {
        if (isScanning) {
            stopScan();
        } else {
            startScan();
        }
    }
    
    private void startScan() {
        // 6. 配置盘点参数
        InventoryParams params = InventoryModeParams.getParams(
            InventoryModeParams.MODE.NORMAL,
            null,
            false  // 不读 TID
        );
        
        // 7. 启动盘点
        Reader.READER_ERR er = UHFEngine.getEngine().startInventory(
            params, 
            readListener, 
            null
        );
        
        if (er == Reader.READER_ERR.MT_OK_ERR) {
            isScanning = true;
            scanBtn.setText("停止");
        }
    }
    
    private void stopScan() {
        UHFEngine.getEngine().stopInventory();
        isScanning = false;
        scanBtn.setText("开始扫描");
    }
    
    // 8. 读取监听器
    private ReadListener readListener = new ReadListener() {
        @Override
        public void tagRead(List<Reader.TagInfo> list) {
            if (list == null || list.isEmpty()) return;
            
            for (Reader.TagInfo tagInfo : list) {
                String epc = Reader.bytes_Hexstr(tagInfo.EpcId);
                
                // 9. 更新 UI（必须在主线程）
                runOnUiThread(() -> {
                    resultText.setText("读取到: " + epc);
                });
            }
        }
    };
}
```

------

### 3. 关键技术点

#### A. 线程与 UI 更新

```java
// ❌ 错误：在回调线程直接更新 UI
readListener = new ReadListener() {
    @Override
    public void tagRead(List<Reader.TagInfo> list) {
        resultText.setText("...");  // 会崩溃！
    }
};

// ✅ 正确：使用 runOnUiThread
readListener = new ReadListener() {
    @Override
    public void tagRead(List<Reader.TagInfo> list) {
        runOnUiThread(() -> {
            resultText.setText("...");  // 安全
        });
    }
};

// ✅ 或使用 Handler
private Handler handler = new Handler(Looper.getMainLooper()) {
    @Override
    public void handleMessage(Message msg) {
        resultText.setText("...");
    }
};

readListener = new ReadListener() {
    @Override
    public void tagRead(List<Reader.TagInfo> list) {
        handler.sendEmptyMessage(UPDATE_UI);
    }
};
```

------

#### B. 字节数组与十六进制转换

```java
// EPC 字节数组转十六进制字符串
byte[] epcBytes = tagInfo.EpcId;
String epcHex = Reader.bytes_Hexstr(epcBytes);
// 结果：E28011606000020700001234

// 十六进制字符串转字节数组
String hexString = "E28011606000020700001234";
byte[] bytes = hexStringToBytes(hexString);

private byte[] hexStringToBytes(String hexString) {
    int len = hexString.length();
    byte[] data = new byte[len / 2];
    for (int i = 0; i < len; i += 2) {
        data[i / 2] = (byte) ((Character.digit(hexString.charAt(i), 16) << 4)
            + Character.digit(hexString.charAt(i + 1), 16));
    }
    return data;
}
```

------

#### C. 列表去重技巧

```java
// 方法 1：使用 Map（最快）
private Map<String, RFIDTag> tagMap = new HashMap<>();

private RFIDTag findOrCreateTag(String epc) {
    RFIDTag tag = tagMap.get(epc);
    if (tag == null) {
        tag = new RFIDTag();
        tag.epc = epc;
        tagMap.put(epc, tag);
    }
    return tag;
}

// 方法 2：使用 List（示例代码中的方式）
private List<RFIDTag> tagList = new ArrayList<>();

private RFIDTag findOrCreateTag(String epc) {
    for (RFIDTag tag : tagList) {
        if (tag.epc.equals(epc)) {
            return tag;
        }
    }
    RFIDTag newTag = new RFIDTag();
    tagList.add(newTag);
    return newTag;
}

// 方法 3：使用 Set（自动去重）
private Set<String> uniqueEpcs = new HashSet<>();

if (uniqueEpcs.add(epc)) {
    // 是新标签
} else {
    // 是重复标签
}
```

------

#### D. 数据持久化

```java
// 方案 1：保存到 SharedPreferences（简单数据）
SharedPreferences prefs = getSharedPreferences("RFID_DATA", MODE_PRIVATE);
SharedPreferences.Editor editor = prefs.edit();
editor.putString("last_epc", epc);
editor.putInt("total_count", tagList.size());
editor.apply();

// 读取
String lastEpc = prefs.getString("last_epc", "");
int totalCount = prefs.getInt("total_count", 0);

// 方案 2：保存到文件（列表数据）
private void saveToFile() {
    try {
        File file = new File(getFilesDir(), "rfid_data.txt");
        FileWriter fw = new FileWriter(file);
        
        for (RFIDTag tag : tagList) {
            fw.write(tag.epc + "," + tag.tid + "," + tag.rssi + "\n");
        }
        
        fw.close();
    } catch (IOException e) {
        Log.e("Save", "保存失败: " + e.getMessage());
    }
}

private void loadFromFile() {
    try {
        File file = new File(getFilesDir(), "rfid_data.txt");
        if (!file.exists()) return;
        
        BufferedReader br = new BufferedReader(new FileReader(file));
        String line;
        
        while ((line = br.readLine()) != null) {
            String[] parts = line.split(",");
            if (parts.length >= 3) {
                RFIDTag tag = new RFIDTag();
                tag.epc = parts[0];
                tag.tid = parts[1];
                tag.rssi = Integer.parseInt(parts[2]);
                tagList.add(tag);
            }
        }
        
        br.close();
    } catch (IOException e) {
        Log.e("Load", "加载失败: " + e.getMessage());
    }
}

// 方案 3：使用 SQLite 数据库（大量数据）
public class RFIDDbHelper extends SQLiteOpenHelper {
    private static final String DATABASE_NAME = "rfid.db";
    private static final int DATABASE_VERSION = 1;
    
    public RFIDDbHelper(Context context) {
        super(context, DATABASE_NAME, null, DATABASE_VERSION);
    }
    
    @Override
    public void onCreate(SQLiteDatabase db) {
        String sql = "CREATE TABLE tags (" +
                    "id INTEGER PRIMARY KEY AUTOINCREMENT," +
                    "epc TEXT NOT NULL," +
                    "tid TEXT," +
                    "rssi INTEGER," +
                    "frequency INTEGER," +
                    "read_count INTEGER," +
                    "created_at INTEGER)";
        db.execSQL(sql);
    }
    
    @Override
    public void onUpgrade(SQLiteDatabase db, int oldVersion, int newVersion) {
        db.execSQL("DROP TABLE IF EXISTS tags");
        onCreate(db);
    }
}

// 插入数据
SQLiteDatabase db = dbHelper.getWritableDatabase();
ContentValues values = new ContentValues();
values.put("epc", tag.epc);
values.put("tid", tag.tid);
values.put("rssi", tag.rssi);
values.put("frequency", tag.frequency);
values.put("read_count", tag.readCount);
values.put("created_at", System.currentTimeMillis());
db.insert("tags", null, values);

// 查询数据
Cursor cursor = db.query("tags", null, null, null, null, null, "created_at DESC");
while (cursor.moveToNext()) {
    RFIDTag tag = new RFIDTag();
    tag.epc = cursor.getString(cursor.getColumnIndex("epc"));
    tag.tid = cursor.getString(cursor.getColumnIndex("tid"));
    tag.rssi = cursor.getInt(cursor.getColumnIndex("rssi"));
    tagList.add(tag);
}
cursor.close();
```

------

### 4. 实战案例：快递分拣系统

#### 需求描述

快递公司需要自动分拣包裹：

1. 每个包裹贴有 RFID 标签
2. 标签的 EPC 前4位表示目的城市代码
3. 扫描后自动识别城市并分类
4. 实时显示各城市包裹数量
5. 异常包裹（无法识别城市）单独提示

#### 完整实现

```java
public class ExpressSortActivity extends Activity {
    
    // 城市代码映射
    private static final Map<String, String> CITY_MAP = new HashMap<String, String>() {{
        put("0001", "北京");
        put("0002", "上海");
        put("0003", "广州");
        put("0004", "深圳");
        put("0005", "杭州");
    }};
    
    // 数据结构
    private Map<String, List<RFIDTag>> cityPackages = new HashMap<>();
    private List<RFIDTag> unknownPackages = new ArrayList<>();
    
    // UI 组件
    private TextView summaryText;
    private ListView cityListView;
    private Button scanBtn;
    private Button exportBtn;
    
    // 适配器
    private CitySummaryAdapter adapter;
    
    private boolean isScanning = false;
    private SoundPool soundPool;
    
    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_express_sort);
        
        initData();
        initViews();
        initSound();
        initRFID();
    }
    
    private void initData() {
        // 初始化城市包裹列表
        for (String cityCode : CITY_MAP.keySet()) {
            cityPackages.put(cityCode, new ArrayList<>());
        }
    }
    
    private void initViews() {
        summaryText = findViewById(R.id.summaryText);
        cityListView = findViewById(R.id.cityListView);
        scanBtn = findViewById(R.id.scanBtn);
        exportBtn = findViewById(R.id.exportBtn);
        
        scanBtn.setOnClickListener(v -> toggleScan());
        exportBtn.setOnClickListener(v -> exportReport());
        
        adapter = new CitySummaryAdapter(this);
        cityListView.setAdapter(adapter);
        
        updateSummary();
    }
    
    private void initSound() {
        soundPool = new SoundPool(10, AudioManager.STREAM_SYSTEM, 5);
        soundPool.load(this, R.raw.beep333, 1);
    }
    
    private void initRFID() {
        UHFEngine.getEngine().powerOn();
        Reader.READER_ERR er = UHFEngine.getEngine().connectModule(
            DefaultConfigure.UART_DEV_PATH, 1
        );
        
        if (er == Reader.READER_ERR.MT_OK_ERR) {
            DefaultConfigure.defaultInitModule();
        }
    }
    
    private void toggleScan() {
        if (isScanning) {
            stopScan();
        } else {
            startScan();
        }
    }
    
    private void startScan() {
        InventoryParams params = InventoryModeParams.getParams(
            InventoryModeParams.MODE.NORMAL,
            null,
            false
        );
        
        Reader.READER_ERR er = UHFEngine.getEngine().startInventory(
            params, 
            readListener, 
            null
        );
        
        if (er == Reader.READER_ERR.MT_OK_ERR) {
            isScanning = true;
            scanBtn.setText("停止扫描");
            scanBtn.setBackgroundColor(Color.RED);
        }
    }
    
    private void stopScan() {
        UHFEngine.getEngine().stopInventory();
        isScanning = false;
        scanBtn.setText("开始扫描");
        scanBtn.setBackgroundColor(Color.GREEN);
    }
    
    private ReadListener readListener = new ReadListener() {
        @Override
        public void tagRead(List<Reader.TagInfo> list) {
            if (list == null || list.isEmpty()) return;
            
            for (Reader.TagInfo tagInfo : list) {
                String epc = Reader.bytes_Hexstr(tagInfo.EpcId);
                
                // 提取城市代码（EPC 前4位）
                String cityCode = epc.length() >= 4 ? epc.substring(0, 4) : "";
                
                // 查找或创建标签
                RFIDTag tag = new RFIDTag();
                tag.epc = epc;
                tag.tid = Reader.bytes_Hexstr(tagInfo.EmbededData);
                tag.rssi = tagInfo.RSSI;
                tag.frequency = tagInfo.Frequency;
                tag.readCount = 1;
                
                // 分类处理
                if (CITY_MAP.containsKey(cityCode)) {
                    // 已知城市
                    List<RFIDTag> packages = cityPackages.get(cityCode);
                    
                    // 检查是否已存在
                    boolean exists = false;
                    for (RFIDTag existing : packages) {
                        if (existing.epc.equals(epc)) {
                            existing.readCount++;
                            exists = true;
                            break;
                        }
                    }
                    
                    if (!exists) {
                        packages.add(tag);
                        soundPool.play(1, 1, 1, 0, 0, 1);  // 正常提示音
                    }
                } else {
                    // 未知城市
                    boolean exists = false;
                    for (RFIDTag existing : unknownPackages) {
                        if (existing.epc.equals(epc)) {
                            existing.readCount++;
                            exists = true;
                            break;
                        }
                    }
                    
                    if (!exists) {
                        unknownPackages.add(tag);
                        soundPool.play(2, 1, 1, 0, 0, 1);  // 异常提示音（需要另外加载）
                        
                        runOnUiThread(() -> {
                            Toast.makeText(ExpressSortActivity.this, 
                                "异常包裹: " + epc, 
                                Toast.LENGTH_SHORT).show();
                        });
                    }
                }
            }
            
            // 更新 UI
            runOnUiThread(() -> updateSummary());
        }
    };
    
    private void updateSummary() {
        // 统计总数
        int totalCount = 0;
        for (List<RFIDTag> packages : cityPackages.values()) {
            totalCount += packages.size();
        }
        totalCount += unknownPackages.size();
        
        // 更新摘要文本
        summaryText.setText(String.format(
            "总包裹: %d | 已分类: %d | 异常: %d",
            totalCount,
            totalCount - unknownPackages.size(),
            unknownPackages.size()
        ));
        
        // 更新城市列表
        List<CitySummary> summaries = new ArrayList<>();
        for (Map.Entry<String, List<RFIDTag>> entry : cityPackages.entrySet()) {
            String cityCode = entry.getKey();
            List<RFIDTag> packages = entry.getValue();
            
            if (!packages.isEmpty()) {
                CitySummary summary = new CitySummary();
                summary.cityCode = cityCode;
                summary.cityName = CITY_MAP.get(cityCode);
                summary.packageCount = packages.size();
                summaries.add(summary);
            }
        }
        
        // 添加异常包裹
        if (!unknownPackages.isEmpty()) {
            CitySummary summary = new CitySummary();
            summary.cityCode = "????";
            summary.cityName = "未知城市";
            summary.packageCount = unknownPackages.size();
            summaries.add(summary);
        }
        
        adapter.setSummaries(summaries);
    }
    
    private void exportReport() {
        if (cityPackages.isEmpty() && unknownPackages.isEmpty()) {
            Toast.makeText(this, "没有数据可导出", Toast.LENGTH_SHORT).show();
            return;
        }
        
        // 生成报告
        StringBuilder report = new StringBuilder();
        report.append("快递分拣报告\n");
        report.append("生成时间: ").append(new SimpleDateFormat("yyyy-MM-dd HH:mm:ss")
            .format(new Date())).append("\n\n");
        
        // 按城市统计
        for (Map.Entry<String, List<RFIDTag>> entry : cityPackages.entrySet()) {
            String cityCode = entry.getKey();
            List<RFIDTag> packages = entry.getValue();
            
            if (!packages.isEmpty()) {
                report.append("=== ").append(CITY_MAP.get(cityCode)).append(" ===\n");
                report.append("数量: ").append(packages.size()).append("\n");
                
                for (RFIDTag tag : packages) {
                    report.append("  EPC: ").append(tag.epc).append("\n");
                }
                report.append("\n");
            }
        }
        
        // 异常包裹
        if (!unknownPackages.isEmpty()) {
            report.append("=== 异常包裹 ===\n");
            report.append("数量: ").append(unknownPackages.size()).append("\n");
            
            for (RFIDTag tag : unknownPackages) {
                report.append("  EPC: ").append(tag.epc).append("\n");
            }
        }
        
        // 保存到文件
        try {
            String filepath = Environment.getExternalStorageDirectory().getPath();
            File file = new File(filepath + "/Documents/Express_Report_" + 
                System.currentTimeMillis() + ".txt");
            
            FileWriter fw = new FileWriter(file);
            fw.write(report.toString());
            fw.close();
            
            Toast.makeText(this, "报告已导出: " + file.getPath(), 
                Toast.LENGTH_LONG).show();
        } catch (IOException e) {
            Toast.makeText(this, "导出失败: " + e.getMessage(), 
                Toast.LENGTH_SHORT).show();
        }
    }
    
    @Override
    protected void onDestroy() {
        super.onDestroy();
        
        if (isScanning) {
            UHFEngine.getEngine().stopInventory();
        }
        
        UHFEngine.getEngine().disconnectModule();
        UHFEngine.getEngine().powerOff();
        
        if (soundPool != null) {
            soundPool.release();
        }
    }
    
    // 数据模型
    private static class CitySummary {
        String cityCode;
        String cityName;
        int packageCount;
    }
    
    // 适配器
    private static class CitySummaryAdapter extends BaseAdapter {
        private Context context;
        private List<CitySummary> summaries = new ArrayList<>();
        
        public CitySummaryAdapter(Context context) {
            this.context = context;
        }
        
        public void setSummaries(List<CitySummary> summaries) {
            this.summaries = summaries;
            notifyDataSetChanged();
        }
        
        @Override
        public int getCount() {
            return summaries.size();
        }
        
        @Override
        public Object getItem(int position) {
            return summaries.get(position);
        }
        
        @Override
        public long getItemId(int position) {
            return position;
        }
        
        @Override
        public View getView(int position, View convertView, ViewGroup parent) {
            if (convertView == null) {
                convertView = LayoutInflater.from(context)
                    .inflate(android.R.layout.simple_list_item_2, parent, false);
            }
            
            TextView text1 = convertView.findViewById(android.R.id.text1);
            TextView text2 = convertView.findViewById(android.R.id.text2);
            
            CitySummary summary = summaries.get(position);
            text1.setText(summary.cityName);
            text2.setText("包裹数量: " + summary.packageCount);
            
            return convertView;
        }
    }
}
```

------

### 5. 开发建议与最佳实践

#### ✅ DO（推荐做法）

1. **先用模拟数据测试界面**

   - 无需实际设备即可开发
   - 快速验证逻辑正确性

2. **做好异常处理**

   ```java
   try {
       String epc = Reader.bytes_Hexstr(tagInfo.EpcId);
   } catch (Exception e) {
       Log.e("RFID", "解析失败", e);
       continue;
   }
   ```

3. **使用常量管理配置**

   ```java
   public class RFIDConfig {
       public static final int READ_POWER = 3000;
       public static final int WRITE_POWER = 3000;
       public static final InventoryModeParams.SESSION SESSION = 
           InventoryModeParams.SESSION.SESSION1;
   }
   ```

4. **记录详细日志**

   ```java
   Log.d("RFID", "开始盘点");
   Log.d("RFID", "读取标签: " + epc);
   Log.e("RFID", "盘点失败: " + er);
   ```

5. **提供用户反馈**

   - 播放提示音
   - 显示 Toast 消息
   - 更新进度条

#### ❌ DON'T（避免做法）

1. **不要在回调中直接更新 UI**

   ```java
   // ❌ 错误
   textView.setText("...");
   
   // ✅ 正确
   runOnUiThread(() -> textView.setText("..."));
   ```

2. **不要忘记释放资源**

   ```java
   @Override
   protected void onDestroy() {
       super.onDestroy();
       // 必须断开和下电
       UHFEngine.getEngine().disconnectModule();
       UHFEngine.getEngine().powerOff();
   }
   ```

3. **不要阻塞主线程**

   ```java
   // ❌ 错误：在主线程进行耗时操作
   for (int i = 0; i < 10000; i++) {
       // 大量计算
   }
   
   // ✅ 正确：使用异步
   new Thread(() -> {
       // 耗时操作
       runOnUiThread(() -> {
           // 更新 UI
       });
   }).start();
   ```

4. **不要硬编码字符串**

   ```java
   // ❌ 错误
   button.setText("开始扫描");
   
   // ✅ 正确：使用资源文件
   button.setText(R.string.start_scan);
   ```

------

### 6. 快速参考：API 速查表

| 操作        | 方法                                           | 返回值             |
| ----------- | ---------------------------------------------- | ------------------ |
| 上电        | `UHFEngine.getEngine().powerOn()`              | void               |
| 下电        | `UHFEngine.getEngine().powerOff()`             | void               |
| 连接        | `connectModule(path, mode)`                    | READER_ERR         |
| 断开        | `disconnectModule()`                           | void               |
| 开始盘点    | `startInventory(params, listener, exListener)` | READER_ERR         |
| 停止盘点    | `stopInventory()`                              | void               |
| 设置功率    | `setAntPowerConf(conf)`                        | READER_ERR         |
| 获取功率    | `getAntPowerConf()`                            | AntPowerConfResult |
| 设置Session | `setGen2Session(session)`                      | READER_ERR         |
| 获取Session | `getGen2Session()`                             | Gen2SessionResult  |
| 设置Target  | `setGen2Target(target)`                        | READER_ERR         |
| 获取Target  | `getGen2Target()`                              | Gen2TargetResult   |
| 设置区域    | `setRegionConf(region)`                        | READER_ERR         |
| 获取区域    | `getRegionConf()`                              | RegionConfResult   |
| 写EPC       | `writeEpcByEpcNoPassword(newEpc, oldEpc)`      | READER_ERR         |

------

## 结语

开发 RFID 功能的关键是：

1. **理解基本概念**（EPC、TID、盘点、读写等）
2. **掌握核心流程**（上电→连接→配置→盘点→处理→断开→下电）
3. **熟悉 API 使用**（参考速查表和示例代码）
4. **注意线程安全**（UI 更新必须在主线程）
5. **做好异常处理**（try-catch 和错误码检查）

按照本指南的模板和示例，你可以快速开发各种 RFID 应用功能。遇到问题时，记得：

- 查看日志输出
- 使用诊断功能
- 参考完整示例
- 先用模拟数据测试

祝开发顺利！ 🚀