```java
//
// Source code recreated from a .class file by IntelliJ IDEA
// (powered by FernFlower decompiler)
//

package com.whoami.db;

import com.whoami.core.Enter;
import com.whoami.core.Global;
import com.whoami.util.StringUtil;
import java.sql.CallableStatement;
import java.sql.Connection;
import java.sql.DatabaseMetaData;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.ResultSetMetaData;
import java.sql.SQLException;
import java.sql.Statement;
import java.util.ArrayList;
import java.util.Collections;
import java.util.Comparator;
import java.util.HashMap;
import java.util.Iterator;
import java.util.LinkedHashMap;
import java.util.List;
import java.util.Map;
import java.util.Objects;
import java.util.concurrent.locks.ReentrantReadWriteLock;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import org.apache.logging.log4j.LogManager;
import org.apache.logging.log4j.Logger;
import org.json.JSONArray;
import org.json.JSONObject;

public class DBUtil {
    static Logger log = LogManager.getLogger(DBUtil.class);
    public static HashMap HMLock = new HashMap();
    public static JSONObject objColumnType = new JSONObject();

    public static JSONObject doMsg(JSONArray arr, String trans, String rpc, HttpServletRequest request, HttpServletResponse response) {
        JSONObject objre = new JSONObject();

        try {
            if (arr.length() == 0) {
                objre.put("error", "消息参数不全");
                return objre;
            }

            String ismul = "0";
            String first = arr.optString(0);
            String strarr;
            if (first.startsWith("[") && first.endsWith("]")) {
                ismul = "1";
                JSONArray arr2 = new JSONArray();

                for(int i = 0; i < arr.length(); ++i) {
                    arr2.put(Global.encodeArr(arr.optJSONArray(i)).join("%15"));
                }

                strarr = arr2.join("%18");
            } else {
                strarr = Global.encodeArr(arr).join("%15");
            }

            String res = Enter.doMsg(strarr, ismul, trans, "1", rpc, request, response);
            objre = new JSONObject(res);
        } catch (Exception e) {
            log.error("Exception", e);
            objre.put("error", "程序异常");
        }

        return objre;
    }

    public static List<JSONObject> selectResultSetJSON(String dtype, String did, String sql) {
        List<JSONObject> resultList = new ArrayList();
        did = StringUtil.notNull(did) ? did : "";
        Connection con = DB.getCon(dtype, did);
        if (con == null) {
            return resultList;
        } else {
            CallableStatement cstmt = null;
            ResultSet rs = null;

            Object result;
            try {
                log.info(dtype + " " + did + " " + sql);
                cstmt = con.prepareCall(sql);

                for(boolean oprFlg = cstmt.execute(); oprFlg; oprFlg = cstmt.getMoreResults()) {
                    new ArrayList();
                    rs = cstmt.getResultSet();
                    JSONObject object = new JSONObject();
                    JSONArray arr = new JSONArray();
                    ResultSetMetaData rsmd = rs.getMetaData();

                    while(rs.next()) {
                        JSONObject obj = new JSONObject();
                        getType(rs, rsmd, obj, (JSONObject)null);
                        arr.put(obj);
                    }

                    object.put("arrdata", arr);
                    object.put("length", arr.length());
                    resultList.add(object);
                }

                result = resultList;
                return (List<JSONObject>)result;
            } catch (Exception e) {
                log.error(dtype + " " + did + " " + sql, e);
                result = resultList;
            } finally {
                DB.close(cstmt);
                DB.close(rs);
                DB.close(con);
            }

            return (List<JSONObject>)result;
        }
    }

    public static String ExecuteSqls(List<String> InsertSqls, Connection con, Statement st) {
        try {
            con.setAutoCommit(false);
            StringBuilder sql = new StringBuilder();

            for(int i = 0; i < InsertSqls.size(); ++i) {
                String onesql = (String)InsertSqls.get(i);
                sql.append(onesql);
                st.addBatch(onesql);
            }

            log.info("批量语句ExecuteSqls:" + sql);
            st.executeBatch();
            con.commit();
            return "{\"re\":\"执行成功！\"}";
        } catch (SQLException e) {
            e.printStackTrace();
            log.error("sqlException", e);

            try {
                con.rollback();
            } catch (SQLException e1) {
                log.error("sqlException", e1);
            }

            return "{\"error\":\"执行语句出错！\"}";
        }
    }

    public static JSONObject selectJSON(String dtype, String did, String sql, JSONObject objmsg, HttpServletRequest request) {
        did = StringUtil.notNull(did) ? did : "";
        JSONObject object = new JSONObject();
        object.put("length", 0);
        if (StringUtil.isNull(dtype)) {
            object.put("code", 1);
            object.put("msg", "数据库类型不能为空");
            return object;
        } else {
            Connection con = DB.getCon(dtype, did);
            if (con == null) {
                object.put("code", 2);
                object.put("msg", "数据库连接失败");
                return object;
            } else {
                Statement st = null;
                ResultSet rs = null;

                JSONObject rsmd;
                try {
                    st = con.createStatement();
                    sql = fixselectsql(sql, objmsg, request);
                    log.info(dtype + " " + did + " " + sql);
                    rs = st.executeQuery(sql);
                    JSONArray arr = new JSONArray();
                    ResultSetMetaData rsmd = rs.getMetaData();

                    while(rs.next()) {
                        JSONObject obj = new JSONObject();
                        getType(rs, rsmd, obj, objmsg);
                        arr.put(obj);
                    }

                    object.put("arrdata", arr);
                    object.put("length", arr.length());
                    JSONObject var20 = object;
                    return var20;
                } catch (SQLException e) {
                    log.error("Exception", e);
                    log.error(dtype + " " + did + " " + sql + " " + e.getMessage());
                    object.put("code", 3);
                    object.put("msg", "执行语句出错");
                    object.put("ex", e);
                    rsmd = object;
                } finally {
                    DB.close(rs);
                    DB.close(st);
                    DB.close(con);
                }

                return rsmd;
            }
        }
    }

    public static JSONObject selectOneJSON(String dtype, String did, String sql) {
        return selectOneJSON(dtype, did, sql, (JSONObject)null, (HttpServletRequest)null);
    }

    public static JSONObject selectOneJSON(String dtype, String did, String sql, JSONObject objmsg, HttpServletRequest request) {
        did = StringUtil.notNull(did) ? did : "";
        JSONObject object = new JSONObject();
        object.put("length", 0);
        if (StringUtil.isNull(dtype)) {
            object.put("code", 1);
            object.put("msg", "数据库类型不能为空");
            return object;
        } else {
            Connection con = DB.getCon(dtype, did);
            if (con == null) {
                object.put("code", 2);
                object.put("msg", "数据库连接失败");
                return object;
            } else {
                Statement st = null;
                ResultSet rs = null;

                JSONObject index;
                try {
                    st = con.createStatement();
                    sql = fixselectsql(sql, objmsg, request);
                    log.info(dtype + " " + did + " " + sql);
                    rs = st.executeQuery(sql);
                    ResultSetMetaData rsmd = rs.getMetaData();

                    for(index = 0; rs.next(); ++index) {
                        if (index == 0) {
                            getType(rs, rsmd, object, objmsg);
                        }
                    }

                    object.put("length", index);
                    JSONObject var11 = object;
                    return var11;
                } catch (SQLException e) {
                    e.printStackTrace();
                    log.error(dtype + " " + did + " " + sql + " ", e);
                    object.put("code", 3);
                    object.put("msg", "执行语句出错");
                    object.put("ex", e);
                    index = object;
                } finally {
                    DB.close(rs);
                    DB.close(st);
                    DB.close(con);
                }

                return index;
            }
        }
    }

    public static JSONObject select(String dtype, String did, String sql, JSONObject objmsg, HttpServletRequest request) {
        return select(dtype, did, sql, objmsg, request, true);
    }

    public static JSONObject selectJSON(String dtype, String did, String sql) {
        return selectJSON(dtype, did, sql, (JSONObject)null, (HttpServletRequest)null);
    }

    public static JSONArray selectArray(String dtype, String did, String sql) {
        return selectArray(dtype, did, sql, (JSONObject)null, (HttpServletRequest)null);
    }

    public static JSONArray selectArray(String dtype, String did, String sql, JSONObject objmsg, HttpServletRequest request) {
        JSONObject objre = selectJSON(dtype, did, sql, objmsg, request);
        return objre.has("arrdata") ? objre.getJSONArray("arrdata") : new JSONArray();
    }

    public static JSONObject select(String dtype, String did, String sql) {
        return select(dtype, did, sql, (JSONObject)null, (HttpServletRequest)null, true);
    }

    public static JSONObject select(String dtype, String did, String sql, JSONObject objmsg, HttpServletRequest request, boolean useseer) {
        JSONObject object = new JSONObject();
        object.put("length", 0);
        if (StringUtil.isNull(dtype)) {
            object.put("code", 1);
            object.put("msg", "数据库类型不能为空");
            return object;
        } else {
            Connection con = DB.getCon(dtype, did);
            if (con == null) {
                object.put("code", 2);
                object.put("msg", "数据库连接失败");
                return object;
            } else {
                Statement st = null;
                ResultSet rs = null;

                JSONObject rsmd;
                try {
                    st = con.createStatement();
                    if (useseer) {
                        sql = fixselectsql(sql, objmsg, request);
                    }

                    if (Global.islog) {
                        log.info(dtype + " " + did + " " + sql);
                    }

                    rs = st.executeQuery(sql);
                    JSONArray arr = new JSONArray();
                    ResultSetMetaData rsmd = rs.getMetaData();
                    int numCols = rsmd.getColumnCount();

                    while(rs.next()) {
                        JSONArray arrson = new JSONArray();

                        for(int j = 0; j < numCols; ++j) {
                            String val = rs.getString(j + 1);
                            if (StringUtil.notNull(val)) {
                                arrson.put(rs.getString(j + 1));
                            } else {
                                arrson.put("");
                            }
                        }

                        arr.put(arrson);
                    }

                    object.put("arrdata", arr);
                    object.put("length", arr.length());
                    JSONObject var22 = object;
                    return var22;
                } catch (SQLException e) {
                    e.printStackTrace();
                    log.error("Exception", e);
                    object.put("code", 3);
                    object.put("msg", "执行语句出错");
                    object.put("ex", e);
                    rsmd = object;
                } finally {
                    DB.close(rs);
                    DB.close(st);
                    DB.close(con);
                }

                return rsmd;
            }
        }
    }

    public static JSONObject insertSql(String dtype, String did, String sqls) {
        JSONObject object = new JSONObject();
        if (StringUtil.isNull(dtype)) {
            object.put("code", 1);
            object.put("msg", "数据库类型不能为空");
            return object;
        } else {
            Connection con = DB.getCon(dtype, did);
            if (con == null) {
                object.put("code", 2);
                object.put("msg", "数据库连接失败");
            } else {
                ResultSet rsu = null;
                PreparedStatement pstmt = null;

                try {
                    log.info(dtype + " " + did + " " + sqls);
                    pstmt = con.prepareStatement(sqls, 1);
                    pstmt.executeUpdate();
                    rsu = pstmt.getGeneratedKeys();
                    String res = "";
                    int re = 0;

                    while(rsu.next()) {
                        re = rsu.getInt(1);
                        object.put("re", re);
                    }
                } catch (SQLException e) {
                    e.printStackTrace();
                    log.error("Exception", e);
                    object.put("code", 3);
                    object.put("msg", "执行语句出错");
                    object.put("ex", e);
                } finally {
                    DB.close(rsu);
                    DB.close(pstmt);
                    DB.close(con);
                }
            }

            return object;
        }
    }

    public static JSONObject insert(String dtype, String did, String tablename, LinkedHashMap<String, ?> map, String where, HttpServletRequest request) {
        JSONObject object = new JSONObject();
        if (StringUtil.isNull(dtype)) {
            object.put("code", 1);
            object.put("msg", "数据库类型不能为空");
            return object;
        } else {
            Connection con = DB.getCon(dtype, did);
            if (con == null) {
                object.put("code", 2);
                object.put("msg", "数据库连接失败");
                return object;
            } else {
                Statement st = null;
                ResultSet rs = null;
                ResultSet rsi = null;
                ResultSet rsu = null;
                PreparedStatement pstmt = null;
                boolean isinsert = false;

                try {
                    if (StringUtil.notNull(where)) {
                        String sqlselect = "select count(1) from " + tablename + " where " + where;
                        log.info(sqlselect);
                        st = con.createStatement();
                        rs = st.executeQuery(sqlselect);
                        int count = 0;
                        if (rs.next()) {
                            count = rs.getInt(1);
                        }

                        if (count > 0) {
                            String exp = " ";

                            for(String key : map.keySet()) {
                                exp = exp + key + "=" + map.get(key) + ",";
                            }

                            if (exp.length() > 0) {
                                exp = exp.substring(0, exp.length() - 1);
                                log.info(exp);
                            }

                            String sqlupdate = "";
                            if (!exp.contains(" altime=") && !exp.contains(",altime=")) {
                                sqlupdate = "update " + tablename + " set " + exp + ",altime=current_timestamp where " + where;
                            } else {
                                sqlupdate = "update " + tablename + " set " + exp + " where " + where;
                            }

                            log.info(sqlupdate);
                            pstmt = con.prepareStatement(sqlupdate, 1);
                            pstmt.executeUpdate();
                            rsu = pstmt.getGeneratedKeys();
                            String res = "";

                            int re;
                            int id;
                            for(re = 0; rsu.next(); re = id) {
                                id = rsu.getInt(1);
                                res = res + id + ",";
                            }

                            if (res.length() <= 0) {
                                object.put("code", 4);
                                object.put("msg", "无结果");
                                JSONObject var45 = object;
                                return var45;
                            }

                            res = res.substring(0, res.length() - 1);
                            log.info(res);
                            object.put("re", re);
                            JSONObject departno = object;
                            return departno;
                        }

                        isinsert = true;
                    } else {
                        isinsert = true;
                    }

                    if (!isinsert) {
                        object.put("code", 6);
                        object.put("msg", "无结果");
                    } else {
                        String strfiled = "";
                        String strvalue = "";
                        Iterator<String> it = map.keySet().iterator();

                        for(int flag = 1; it.hasNext(); ++flag) {
                            String key = (String)it.next();
                            if (flag == 1) {
                                strfiled = strfiled + key;
                                strvalue = strvalue + map.get(key);
                            } else {
                                strfiled = strfiled + "," + key;
                                strvalue = strvalue + "," + map.get(key);
                            }
                        }

                        if (null != request) {
                            Object objuid = request.getSession().getAttribute("uid");
                            String uid = "";
                            if (null != objuid) {
                                uid = objuid.toString();
                            }

                            Object objdepartno = request.getSession().getAttribute("departno");
                            String departno = "";
                            if (null != objdepartno) {
                                departno = (String)objdepartno;
                            }

                            Object objlan = request.getSession().getAttribute("lan");
                            String lan = "";
                            if (null != objlan) {
                                lan = (String)objlan;
                            }

                            if (StringUtil.notNull(uid)) {
                                strfiled = strfiled + ",uid";
                                strvalue = strvalue + "," + uid;
                            }

                            if (StringUtil.notNull(departno)) {
                                strfiled = strfiled + ",departno";
                                strvalue = strvalue + ",'" + departno + "'";
                            }

                            if (StringUtil.notNull(lan)) {
                                strfiled = strfiled + ",lan";
                                strvalue = strvalue + ",'" + lan + "'";
                            }
                        }

                        String sqlinsert = "insert into " + tablename + " (" + strfiled + ") values (" + strvalue + ")";
                        log.info(sqlinsert);
                        pstmt = con.prepareStatement(sqlinsert, 1);
                        pstmt.executeUpdate();
                        rsi = pstmt.getGeneratedKeys();
                        if (rsi.next()) {
                            object.put("re", rsi.getInt(1));
                        } else {
                            object.put("code", 5);
                            object.put("msg", "无结果");
                        }
                    }

                    JSONObject var31 = object;
                    return var31;
                } catch (SQLException e) {
                    e.printStackTrace();
                    log.error("Exception", e);
                    object.put("code", 3);
                    object.put("msg", "执行语句出错");
                    object.put("ex", e);
                    JSONObject count = object;
                    return count;
                } finally {
                    DB.close(rs);
                    DB.close(rsi);
                    DB.close(rsu);
                    DB.close(st);
                    DB.close(pstmt);
                    DB.close(con);
                }
            }
        }
    }

    public static JSONObject getSessionObj(HttpServletRequest request) {
        JSONObject obj = new JSONObject();
        if (null != request) {
            Object objuid = request.getSession().getAttribute("uid");
            String uid = "";
            if (null != objuid) {
                uid = objuid.toString();
                obj.put("uid", uid);
            }

            Object objdepartno = request.getSession().getAttribute("departno");
            String departno = "";
            if (null != objdepartno) {
                departno = (String)objdepartno;
                obj.put("departno", departno);
            }

            Object objlan = request.getSession().getAttribute("lan");
            String lan = "";
            if (null != objlan) {
                lan = (String)objlan;
                obj.put("lan", lan);
            }
        }

        return obj;
    }

    public static JSONObject insert(String dtype, String did, String tablename, String strField, String strvalue) {
        return insert(dtype, did, tablename, strField, strvalue, "", new JSONObject());
    }

    public static JSONObject insert(String dtype, String did, String tablename, String strField, String strvalue, String where) {
        return insert(dtype, did, tablename, strField, strvalue, where, new JSONObject());
    }

    public static JSONObject insert(String dtype, String did, String tablename, String strField, String strvalue, String where, HttpServletRequest request) {
        return insert(dtype, did, tablename, strField, strvalue, where, getSessionObj(request));
    }

    public static String handStrValue(String str) {
        return str.replace(",", "____");
    }

    public static JSONObject insert(String dtype, String did, String tablename, String strField, String strValue, String where, JSONObject obj) {
        did = StringUtil.isNull(did) ? "" : did;
        JSONObject object = new JSONObject();
        if (StringUtil.isNull(dtype)) {
            object.put("code", 1);
            object.put("msg", "数据库类型不能为空");
            return object;
        } else {
            String[] arrField = strField.split(",");
            String[] arrVal = strValue.split(",");
            if (arrField.length != arrVal.length) {
                object.put("code", 7);
                object.put("msg", "字段和字段值数目不一致");
                log.info(strField);
                log.info(strValue);
                log.error("字段" + arrField.length + "和字段值数目" + arrVal.length + "不一致");
                return object;
            } else {
                Connection con = DB.getCon(dtype, did);
                if (con == null) {
                    object.put("code", 2);
                    object.put("msg", "数据库连接失败");
                    log.info("数据库连接失败：" + did);
                    return object;
                } else {
                    Statement st = null;
                    ResultSet rs = null;
                    ResultSet rsi = null;
                    ResultSet rsu = null;
                    PreparedStatement pstmt = null;
                    boolean isinsert = false;

                    try {
                        String uid = obj.has("uid") ? obj.optString("uid") : "";
                        String departno = obj.has("departno") ? obj.optString("departno") : "";
                        String lan = obj.has("lan") ? obj.optString("lan") : "";
                        if (StringUtil.notNull(where)) {
                            String sqlselect = "select count(1) from " + tablename + " where " + where;
                            log.info(dtype + " " + did + " " + sqlselect);
                            st = con.createStatement();
                            rs = st.executeQuery(sqlselect);
                            int count = 0;
                            if (rs.next()) {
                                count = rs.getInt(1);
                            }

                            if (count > 0) {
                                String exp = " ";

                                for(int i = 0; i < arrField.length; ++i) {
                                    if (i != 0) {
                                        exp = exp + ",";
                                    }

                                    exp = exp + arrField[i] + "=" + arrVal[i].replace("____", ",");
                                }

                                if (StringUtil.notNull(uid) && !exp.contains(" alterid=") && !exp.contains(",alterid=") && !exp.contains(" alterid ") && !exp.contains(",alterid ")) {
                                    exp = exp + ",alterid=" + uid;
                                }

                                if (StringUtil.notNull(departno) && !exp.contains(" departno=") && !exp.contains(",departno=") && !exp.contains(" departno ") && !exp.contains(",departno ")) {
                                    exp = exp + ",departno='" + departno + "'";
                                }

                                String sqlupdate = "";
                                if (!exp.contains(" altime=") && !exp.contains(",altime=")) {
                                    sqlupdate = "update " + tablename + " set " + exp + ",altime=current_timestamp where " + where;
                                } else {
                                    sqlupdate = "update " + tablename + " set " + exp + " where " + where;
                                }

                                log.info(dtype + " " + did + " " + sqlupdate);
                                pstmt = con.prepareStatement(sqlupdate, 1);
                                pstmt.executeUpdate();
                                rsu = pstmt.getGeneratedKeys();
                                String res = "";

                                int re;
                                int id;
                                for(re = 0; rsu.next(); re = id) {
                                    id = rsu.getInt(1);
                                    res = res + id + ",";
                                }

                                if (res.length() <= 0) {
                                    object.put("code", 4);
                                    object.put("msg", "无结果");
                                    JSONObject var44 = object;
                                    return var44;
                                }

                                res = res.substring(0, res.length() - 1);
                                log.info(res);
                                object.put("re", re);
                                JSONObject var43 = object;
                                return var43;
                            }

                            isinsert = true;
                        } else {
                            isinsert = true;
                        }

                        if (isinsert) {
                            if (StringUtil.notNull(uid)) {
                                strField = strField + ",uid";
                                strValue = strValue + "," + uid;
                            }

                            if (StringUtil.notNull(departno)) {
                                strField = strField + ",departno";
                                strValue = strValue + ",'" + departno + "'";
                            }

                            if (StringUtil.notNull(lan)) {
                                strField = strField + ",lan";
                                strValue = strValue + ",'" + lan + "'";
                            }

                            String sqlinsert = "insert into " + tablename + " (" + strField + ") values (" + strValue.replace("____", ",") + ")";
                            log.info(dtype + " " + did + " " + sqlinsert);
                            pstmt = con.prepareStatement(sqlinsert, 1);
                            pstmt.executeUpdate();
                            rsi = pstmt.getGeneratedKeys();
                            if (rsi.next()) {
                                object.put("re", rsi.getInt(1));
                            } else {
                                object.put("code", 5);
                                object.put("msg", "无结果");
                            }
                        } else {
                            object.put("code", 6);
                            object.put("msg", "无结果");
                        }

                        JSONObject var39 = object;
                        return var39;
                    } catch (SQLException e) {
                        e.printStackTrace();
                        log.error("insert sqlexception:", e);
                        object.put("code", 3);
                        object.put("msg", "执行语句出错");
                        object.put("ex", e);
                        JSONObject var36 = object;
                        return var36;
                    } catch (Exception e) {
                        e.printStackTrace();
                        log.error("insert exception:", e);
                        object.put("code", 3);
                        object.put("msg", "执行语句出错");
                        object.put("ex", e);
                        JSONObject departno = object;
                        return departno;
                    } finally {
                        DB.close(rs);
                        DB.close(rsi);
                        DB.close(rsu);
                        DB.close(st);
                        DB.close(pstmt);
                        DB.close(con);
                    }
                }
            }
        }
    }

    public static JSONObject insert(String dtype, String did, String tablename, String strField, String strValue, String where, JSONObject obj, boolean locked) {
        JSONObject reobject = new JSONObject();
        if (locked) {
            if (tablename.equals("empkaoqin") && !HMLock.containsKey(did + "_" + tablename)) {
                HMLock.put(did + "_" + tablename, new ReentrantReadWriteLock());
            }

            ReentrantReadWriteLock lock = null;
            if (tablename.equals("empkaoqin")) {
                lock = (ReentrantReadWriteLock)HMLock.get(did + "_" + tablename);
            }

            try {
                if (lock != null) {
                    lock.writeLock().lock();
                }

                reobject = insert(dtype, did, tablename, strField, strValue, where, obj);
            } catch (Exception e) {
                e.printStackTrace();
                log.error("Exception", e);
            } finally {
                if (lock != null) {
                    lock.writeLock().unlock();
                }

            }
        } else {
            reobject = insert(dtype, did, tablename, strField, strValue, where, obj);
        }

        return reobject;
    }

    public static JSONObject update(String dtype, String did, String tablename, String str, String where) {
        return update(dtype, did, tablename, str, where, "request", (JSONObject)null);
    }

    public static JSONObject update(String dtype, String did, String tablename, String str, String where, HttpServletRequest request) {
        return update(dtype, did, tablename, str, where, "request", getSessionObj(request));
    }

    public static JSONObject SelectInert(String dtype, String did, String sql) {
        did = StringUtil.isNull(did) ? "" : did;
        JSONObject object = new JSONObject();
        if (StringUtil.isNull(dtype)) {
            object.put("code", 1);
            object.put("error", "数据库类型不能为空");
            object.put("msg", "数据库类型不能为空");
            return object;
        } else {
            Connection con = DB.getCon(dtype, did);
            ResultSet rs = null;
            ResultSet rsi = null;
            ResultSet rsu = null;
            PreparedStatement pstmt = null;
            Statement st = null;
            String returnre = "";

            try {
                st = con.createStatement();
                log.info(sql);
                pstmt = con.prepareStatement(sql, 1);
                pstmt.executeUpdate();
                rsi = pstmt.getGeneratedKeys();
                if (rsi.next()) {
                    returnre = "{\"re\":\"" + rsi.getString(1) + "\"}";
                } else {
                    returnre = "{\"error\":\"执行没有返回结果\"}";
                }

                DB.close(pstmt);
            } catch (SQLException e) {
                e.printStackTrace();
                log.error("Exception", e);
                returnre = "{\"error\":\"执行语句出错\",\"sql\":\"" + sql + "\"}";
            } finally {
                DB.close(rs);
                DB.close(rsi);
                DB.close(rsu);
                DB.close(st);
                DB.close(pstmt);
                DB.close(con);
            }

            return new JSONObject(returnre);
        }
    }

    public static JSONObject delete(String dtype, String did, String tablename, String where) {
        did = StringUtil.isNull(did) ? "" : did;
        JSONObject object = new JSONObject();
        if (StringUtil.isNull(dtype)) {
            object.put("code", 1);
            object.put("error", "数据库类型不能为空");
            object.put("msg", "数据库类型不能为空");
            return object;
        } else if (StringUtil.isNull(where)) {
            object.put("code", 5);
            object.put("error", "where 条件不能为空");
            object.put("msg", "where 条件不能为空");
            return object;
        } else {
            Connection con = DB.getCon(dtype, did);
            if (con == null) {
                log.error("更新时未获取到链接");
                object.put("code", 2);
                object.put("error", "数据库连接失败");
                object.put("msg", "数据库连接失败");
            } else {
                Statement st = null;

                try {
                    st = con.createStatement();
                    String sqlupdate = "delete from " + tablename + " where " + where;
                    log.info(dtype + " " + did + " " + sqlupdate);
                    int re = st.executeUpdate(sqlupdate);
                    object.put("re", re);
                } catch (SQLException e) {
                    log.error("删除出错", e);
                    object.put("code", 3);
                    object.put("error", "执行出错");
                    object.put("msg", "执行出错");
                    object.put("ex", e);
                } finally {
                    DB.close(st);
                    DB.close(con);
                }
            }

            return object;
        }
    }

    public static JSONObject update(String dtype, String did, String tablename, String str, String where, String objfrom, JSONObject sessionObj) {
        did = StringUtil.isNull(did) ? "" : did;
        JSONObject object = new JSONObject();
        if (StringUtil.isNull(dtype)) {
            object.put("code", 1);
            object.put("error", "数据库类型不能为空");
            object.put("msg", "数据库类型不能为空");
            return object;
        } else if (StringUtil.isNull(where)) {
            object.put("code", 5);
            object.put("error", "where 条件不能为空");
            object.put("msg", "where 条件不能为空");
            return object;
        } else {
            Connection con = DB.getCon(dtype, did);
            if (con == null) {
                log.error("更新时未获取到链接");
                object.put("code", 2);
                object.put("error", "数据库连接失败");
                object.put("msg", "数据库连接失败");
            } else {
                ResultSet rsu = null;
                Statement st = null;

                try {
                    st = con.createStatement();
                    String sqlupdate = "";
                    String uid = sessionObj != null && sessionObj.has("uid") ? sessionObj.optString("uid") : "";
                    String departno = sessionObj != null && sessionObj.has("departno") ? sessionObj.optString("departno") : "";
                    if (StringUtil.notNull(uid) && !str.contains(" alterid=") && !str.contains(",alterid=") && !str.contains(" alterid ") && !str.contains(",alterid ")) {
                        str = str + ",alterid=" + uid;
                    }

                    if (StringUtil.notNull(departno) && !str.contains(" departno=") && !str.contains(",departno=") && !str.contains(" departno ") && !str.contains(",departno ")) {
                        str = str + ",departno='" + departno + "'";
                    }

                    if (!str.contains(" altime=") && !str.contains(",altime=")) {
                        sqlupdate = "update " + tablename + " set " + str + ",altime=current_timestamp where " + where;
                    } else {
                        sqlupdate = "update " + tablename + " set " + str + " where " + where;
                    }

                    log.info(dtype + " " + did + " " + sqlupdate);
                    int re = st.executeUpdate(sqlupdate);
                    object.put("re", re);
                } catch (SQLException e) {
                    log.error("更新出错", e);
                    object.put("code", 3);
                    object.put("error", "执行语句出错");
                    object.put("msg", "执行语句出错");
                    object.put("ex", e);
                } finally {
                    DB.close(rsu);
                    DB.close(st);
                    DB.close(con);
                }
            }

            return object;
        }
    }

    public static JSONObject ExecuteSqls(String dtype, String did, List<String> InsertSqls) {
        JSONObject object = new JSONObject();
        if (StringUtil.isNull(dtype)) {
            object.put("code", 1);
            object.put("msg", "数据库类型不能为空");
            object.put("error", "数据库类型不能为空");
            return object;
        } else {
            Connection con = DB.getCon(dtype, did);
            if (con == null) {
                object.put("code", 2);
                object.put("error", "数据库连接失败");
                object.put("msg", "数据库连接失败");
            } else {
                Statement st = null;

                try {
                    st = con.createStatement();
                    con.setAutoCommit(false);
                    String sql = "";

                    for(int i = 0; i < InsertSqls.size(); ++i) {
                        String onesql = (String)InsertSqls.get(i);
                        sql = sql + onesql;
                        st.addBatch(onesql);
                    }

                    log.info(dtype + " " + did + " 批量语句 " + sql);
                    st.executeBatch();
                    con.commit();
                    object.put("re", "执行成功");
                } catch (Exception e) {
                    e.printStackTrace();
                    log.error("Exception", e);

                    try {
                        con.rollback();
                    } catch (SQLException e1) {
                        log.error("Exception", e1);
                    }

                    object.put("error", "执行语句出错");
                } finally {
                    DB.close(st);
                    DB.close(con);
                }
            }

            return object;
        }
    }

    public static void getType(ResultSet rs, ResultSetMetaData rsmd, JSONObject obj, JSONObject objmsg) throws SQLException {
        int total_rows = rsmd.getColumnCount();
        String colnull = "";
        if (null != objmsg) {
            colnull = objmsg.optString("colnull");
        }

        boolean isnull = StringUtil.notNull(colnull) && colnull.equals("true");
        String colstr = "";
        if (null != objmsg) {
            colstr = objmsg.optString("colstr");
        }

        boolean isstr = StringUtil.notNull(colstr) && colstr.equals("true");

        for(int i = 0; i < total_rows; ++i) {
            String columnName = rsmd.getColumnLabel(i + 1);
            if (obj.has(columnName)) {
                columnName = columnName + "1";
            }

            if (isnull && Objects.isNull(rs.getObject(columnName))) {
                obj.put(columnName, "");
            } else if (isstr) {
                obj.put(columnName, rs.getString(columnName));
            } else {
                switch (rsmd.getColumnType(i + 1)) {
                    case -9:
                        obj.put(columnName, rs.getNString(columnName));
                        break;
                    case -6:
                        obj.put(columnName, rs.getInt(columnName));
                        break;
                    case -5:
                        obj.put(columnName, rs.getLong(columnName));
                        break;
                    case 1:
                    case 12:
                        if (StringUtil.isNull(rs.getString(columnName))) {
                            obj.put(columnName, "");
                        } else {
                            obj.put(columnName, rs.getString(columnName));
                        }
                        break;
                    case 2:
                        obj.put(columnName, rs.getBigDecimal(columnName));
                        break;
                    case 4:
                        obj.put(columnName, rs.getLong(columnName));
                        break;
                    case 5:
                        obj.put(columnName, rs.getInt(columnName));
                        break;
                    case 6:
                        obj.put(columnName, rs.getFloat(columnName));
                        break;
                    case 8:
                        obj.put(columnName, rs.getDouble(columnName));
                        break;
                    case 16:
                        obj.put(columnName, rs.getBoolean(columnName));
                        break;
                    case 91:
                        obj.put(columnName, rs.getDate(columnName));
                        break;
                    case 93:
                        obj.put(columnName, rs.getTimestamp(columnName));
                        break;
                    case 2003:
                        obj.put(columnName, rs.getArray(columnName));
                        break;
                    case 2004:
                        obj.put(columnName, rs.getBlob(columnName));
                        break;
                    default:
                        obj.put(columnName, rs.getObject(columnName));
                }
            }
        }

    }

    public static String fixInsertSql(String sql, HttpServletRequest request) {
        try {
            if (StringUtil.notNull((String)request.getSession().getAttribute("uid"))) {
                int indexvalues = sql.indexOf(") values");
                if (indexvalues < 1) {
                    indexvalues = sql.indexOf(")values");
                }

                if (indexvalues < 1) {
                    indexvalues = sql.indexOf(")  values");
                }

                if (indexvalues < 1) {
                    indexvalues = sql.indexOf(")   values");
                }

                if (indexvalues > 1) {
                    int indexlast = sql.lastIndexOf(")");
                    sql = sql.substring(0, indexvalues) + ",uid,departno" + sql.substring(indexvalues, indexlast) + "," + (String)request.getSession().getAttribute("uid") + ",'" + (String)request.getSession().getAttribute("departno") + "')";
                }
            }
        } catch (Exception e) {
            log.info("Exception", e);
        }

        return sql;
    }

    public static String fixselectsql(String sql, JSONObject objmsg, HttpServletRequest request) {
        String strseer = "";
        if (null != objmsg) {
            String xmlseer = objmsg.optString("seer");
            String maintable = objmsg.optString("maintable");
            strseer = getStrSeeLimit(xmlseer, maintable, request);
        }

        if (strseer.length() > 0) {
            int indexinsert = -1;
            int indexorder = sql.indexOf("order by");
            int indexgroup = sql.indexOf("group by");
            int indexlimit = sql.indexOf("limit");
            ArrayList<Integer> list = new ArrayList();
            if (indexorder > 1) {
                list.add(indexorder);
            }

            if (indexgroup > 1) {
                list.add(indexgroup);
            }

            if (indexlimit > 1) {
                list.add(indexlimit);
            }

            if (list.size() > 0) {
                Collections.sort(list, new Comparator<Integer>() {
                    public int compare(Integer o1, Integer o2) {
                        return o1 - o2;
                    }
                });
                indexinsert = (Integer)list.get(0);
            }

            if (indexinsert > 0) {
                sql = sql.substring(0, indexinsert) + " " + strseer + " " + sql.substring(indexinsert);
            } else {
                sql = sql + " " + strseer;
            }
        }

        return sql;
    }

    public static String getStrSeeLimit(String xmlseer, String maintable, HttpServletRequest request) {
        String seer = null;
        if (StringUtil.notNull(xmlseer)) {
            seer = xmlseer;
        } else {
            if (null == request) {
                return "";
            }

            String mid = request.getParameter("mid");
            if (StringUtil.notNull(mid)) {
                String key = "seer";
                if (null != request.getSession().getAttribute("openid")) {
                    key = "wxseer";
                }

                if (null != request.getSession().getAttribute(key) && !request.getSession().getAttribute(key).equals("-1")) {
                    Map<String, String> mapSeer = (Map)request.getSession().getAttribute(key);
                    if (null != mapSeer) {
                        seer = (String)mapSeer.get(mid);
                    }
                }
            }
        }

        String strseer = "";
        if (StringUtil.notNull(seer)) {
            String strMainTable = StringUtil.isNull(maintable) ? "" : maintable + ".";
            if (seer.equals("2")) {
                strseer = " and (" + strMainTable + "uid = " + request.getSession().getAttribute("uid") + " or " + strMainTable + "departno like '" + request.getSession().getAttribute("departno") + "%' )";
            } else if (seer.equals("3")) {
                strseer = " and (" + strMainTable + "uid = " + request.getSession().getAttribute("uid") + " or " + strMainTable + "departno = '" + request.getSession().getAttribute("departno") + "%' )";
            } else if (seer.equals("4")) {
                strseer = " and " + strMainTable + "uid = " + request.getSession().getAttribute("uid") + " ";
            }
        }

        return strseer;
    }

    public static String ExecuteSqlsTransaction(List<String[]> listArr) {
        List<Map<String, Object>> listcon = new ArrayList();
        Map<String, Integer> mapCon = new HashMap();
        Map<String, List> mapSql = new HashMap();
        boolean state = false;

        try {
            int idx = 0;

            for(int i = 0; i < listArr.size(); ++i) {
                String[] item = (String[])listArr.get(i);
                String key = item[1] + (StringUtil.isNull(item[2]) ? "" : item[2]);
                Connection con;
                Statement st;
                if (mapCon.containsKey(key)) {
                    int ii = (Integer)mapCon.get(key);
                    con = Objects.isNull(((Map)listcon.get(ii)).get("con")) ? null : (Connection)((Map)listcon.get(ii)).get("con");
                    st = Objects.isNull(((Map)listcon.get(ii)).get("st")) ? null : (Statement)((Map)listcon.get(ii)).get("st");
                } else {
                    con = DB.getCon(item[1], item[2]);
                    st = con.createStatement();
                    mapCon.put(key, idx);
                    Map<String, Object> mapzy = new HashMap();
                    mapzy.put("con", con);
                    mapzy.put("st", st);
                    listcon.add(mapzy);
                    ++idx;
                }

                JSONObject objre = getSql(con, st, item);
                if (!objre.has("re")) {
                    state = false;
                    break;
                }

                if (!mapSql.containsKey(key)) {
                    mapSql.put(key, new ArrayList());
                }

                ((List)mapSql.get(key)).add(objre.optString("re"));
                state = true;
            }

            if (state) {
                for(String key : mapSql.keySet()) {
                    List<String> one = (List)mapSql.get(key);
                    int ii = (Integer)mapCon.get(key);
                    Connection con = Objects.isNull(((Map)listcon.get(ii)).get("con")) ? null : (Connection)((Map)listcon.get(ii)).get("con");
                    Statement st = Objects.isNull(((Map)listcon.get(ii)).get("st")) ? null : (Statement)((Map)listcon.get(ii)).get("st");
                    if (null == con || null == st) {
                        state = false;
                        break;
                    }

                    con.setAutoCommit(false);

                    for(int j = 0; j < one.size(); ++j) {
                        st.addBatch((String)one.get(j));
                    }

                    st.executeBatch();
                    state = true;
                }
            }
        } catch (SQLException e) {
            state = false;
            e.printStackTrace();
            log.error("-------------------批量执行语句异常11:", e);
        } catch (Exception e) {
            state = false;
            e.printStackTrace();
            log.error("-------------------批量执行语句异常22:", e);
        }

        if (!state) {
            for(int i = 0; i < listcon.size(); ++i) {
                try {
                    ((Connection)((Map)listcon.get(i)).get("con")).rollback();
                    log.info("--------------------批量回滚第：" + i + "个");
                } catch (SQLException e) {
                    log.error("--------------------批量回滚异常11：", e);
                    e.printStackTrace();
                } catch (Exception e) {
                    log.error("--------------------批量回滚异常22：", e);
                    e.printStackTrace();
                }
            }

            destroyDB(listcon);
            return "{\"error\":\"执行语句出错！\"}";
        } else {
            String res = "";

            for(int i = 0; i < listcon.size(); ++i) {
                try {
                    ((Connection)((Map)listcon.get(i)).get("con")).commit();
                    res = "{\"re\":\"执行成功！\"}";
                } catch (SQLException e) {
                    log.error("-------------------执行commit出错：", e);
                    e.printStackTrace();
                    res = "{\"error\":\"执行语句出错！\"}";
                } catch (Exception e) {
                    log.error("--------------------执行commit出错：", e);
                    e.printStackTrace();
                    res = "{\"error\":\"执行语句出错！\"}";
                }
            }

            destroyDB(listcon);
            return res;
        }
    }

    public static void destroyDB(List<Map<String, Object>> list) {
        try {
            for(int i = 0; i < list.size(); ++i) {
                Connection con = Objects.isNull(((Map)list.get(i)).get("con")) ? null : (Connection)((Map)list.get(i)).get("con");
                Statement st = Objects.isNull(((Map)list.get(i)).get("st")) ? null : (Statement)((Map)list.get(i)).get("st");
                DB.close(con);
                DB.close(st);
            }
        } catch (Exception e) {
            log.error("Exception", e);
        }

    }

    public static JSONObject getSql(Connection con, Statement st, String[] arritem) {
        JSONObject objmap = new JSONObject();
        String type = arritem[0];
        String dtype = arritem[1];
        String did = arritem[2];
        String tablename = arritem[3];
        String strField = arritem[4];
        String strValue = "";
        String where = "";
        String returnsql = "";
        if (con == null) {
            log.error("数据库连接失败：" + did);
            objmap.put("error", "连接为空");
            return objmap;
        } else {
            if (type.equals("insert")) {
                strValue = arritem[5];
                where = arritem[6];
                String[] arrField = strField.split(",");
                String[] arrVal = strValue.split(",");
                if (arrField.length != arrVal.length) {
                    log.info(strField);
                    log.info(strValue);
                    log.error("字段" + arrField.length + "和字段值数目" + arrVal.length + "不一致");
                    objmap.put("error", "字段和字段值数目不一致");
                    return objmap;
                }

                ResultSet rs = null;
                boolean isinsert = false;

                try {
                    if (!StringUtil.notNull(where)) {
                        isinsert = true;
                    } else {
                        String sqlselect = "select count(1) from " + tablename + " where " + where;
                        log.info(dtype + " " + did + " " + sqlselect);
                        st = con.createStatement();
                        rs = st.executeQuery(sqlselect);
                        int count = 0;
                        if (rs.next()) {
                            count = rs.getInt(1);
                        }

                        if (count <= 0) {
                            isinsert = true;
                        } else {
                            String exp = " ";

                            for(int i = 0; i < arrField.length; ++i) {
                                if (i != 0) {
                                    exp = exp + ",";
                                }

                                exp = exp + arrField[i] + "=" + arrVal[i].replace("____", ",");
                            }

                            String sqlupdate = "";
                            if (!exp.contains(" altime=") && !exp.contains(",altime=")) {
                                sqlupdate = "update " + tablename + " set " + exp + ",altime=current_timestamp where " + where;
                            } else {
                                sqlupdate = "update " + tablename + " set " + exp + " where " + where;
                            }

                            returnsql = sqlupdate;
                            log.info(dtype + " " + did + " " + sqlupdate);
                        }
                    }

                    if (isinsert) {
                        JSONObject obj = new JSONObject();
                        String uid = obj.has("uid") ? obj.optString("uid") : "";
                        String departno = obj.has("departno") ? obj.optString("departno") : "";
                        String lan = obj.has("lan") ? obj.optString("lan") : "";
                        if (StringUtil.notNull(uid)) {
                            strField = strField + ",uid";
                            strValue = strValue + "," + uid;
                        }

                        if (StringUtil.notNull(departno)) {
                            strField = strField + ",departno";
                            strValue = strValue + ",'" + departno + "'";
                        }

                        if (StringUtil.notNull(lan)) {
                            strField = strField + ",lan";
                            strValue = strValue + ",'" + lan + "'";
                        }

                        String sqlinsert = "insert into " + tablename + " (" + strField + ") values (" + strValue.replace("____", ",") + ")";
                        returnsql = sqlinsert;
                        log.info(dtype + " " + did + " " + sqlinsert);
                    }

                    objmap.put("re", returnsql);
                } catch (SQLException e) {
                    e.printStackTrace();
                    log.error("执行语句出错", e);
                    DB.close(rs);
                    objmap.put("error", "执行语句出错");
                } finally {
                    DB.close(rs);
                }
            } else {
                where = arritem[5];

                try {
                    String sqlupdate;
                    if (!strField.contains(" altime=") && !strField.contains(",altime=")) {
                        sqlupdate = "update " + tablename + " set " + strField + ",altime=current_timestamp where " + where;
                    } else {
                        sqlupdate = "update " + tablename + " set " + strField + " where " + where;
                    }

                    log.info(dtype + " " + did + " " + sqlupdate);
                    objmap.put("re", sqlupdate);
                } catch (Exception e) {
                    log.error("获取更新sql出错", e);
                    objmap.put("error", "获取更新sql出错");
                }
            }

            return objmap;
        }
    }

    public static JSONObject ReturnInsertSql(String dtype, String did, String tablename, String strField, JSONObject objdata, String where, HttpServletRequest request) {
        JSONObject object = new JSONObject();
        Connection con = null;
        Statement st = null;
        ResultSet rs = null;

        try {
            con = DB.getCon(dtype, did);
            if (con == null) {
                object.put("code", 2);
                object.put("error", "数据库连接失败");
                object.put("msg", "数据库连接失败");
            } else {
                st = con.createStatement();
                String strvalue = getInsertValue(con, rs, tablename, strField, objdata, true);
                object = ReturnInsertSql(con, st, rs, tablename, strField, strvalue, where, request);
            }
        } catch (Exception e) {
            object.put("code", 3);
            object.put("error", "执行语句出错");
            object.put("msg", "执行语句出错");
            log.error("Exception", e);
        } finally {
            DB.close(con, st, rs);
        }

        return object;
    }

    public static JSONObject ReturnInsertSql(String dtype, String did, String tablename, String strField, String strvalue, String where, HttpServletRequest request) {
        JSONObject object = new JSONObject();
        Connection con = null;
        Statement st = null;
        ResultSet rs = null;

        try {
            con = DB.getCon(dtype, did);
            if (con == null) {
                object.put("code", 2);
                object.put("error", "数据库连接失败");
                object.put("msg", "数据库连接失败");
            } else {
                st = con.createStatement();
                object = ReturnInsertSql(con, st, rs, tablename, strField, strvalue, where, request);
            }
        } catch (Exception e) {
            object.put("code", 3);
            object.put("error", "执行语句出错");
            object.put("msg", "执行语句出错");
            log.error("Exception", e);
        } finally {
            DB.close(con, st, rs);
        }

        return object;
    }

    public static JSONObject ReturnInsertSql(Connection con, Statement st, ResultSet rs, String tablename, String strField, String strvalue, String where, HttpServletRequest request) {
        JSONObject object = new JSONObject();
        String[] arrField = strField.split(",");
        String[] arrVal = strvalue.split(",");
        if (arrField.length != arrVal.length) {
            object.put("msg", "字段和字段值数目不一致");
            return object;
        } else {
            DB.close(rs);
            boolean isinsert = false;

            try {
                if (StringUtil.notNull(where)) {
                    String sqlselect = "select count(1) from " + tablename + " where " + where;
                    st = con.createStatement();
                    rs = st.executeQuery(sqlselect);
                    int count = 0;
                    if (rs.next()) {
                        count = rs.getInt(1);
                    }

                    if (count > 0) {
                        String exp = " ";

                        for(int i = 0; i < arrField.length; ++i) {
                            if (i != 0) {
                                exp = exp + ",";
                            }

                            exp = exp + arrField[i] + "=" + arrVal[i].replace("____", ",");
                        }

                        String sqlupdate = "";
                        if (!exp.contains(" altime=") && !exp.contains(",altime=")) {
                            sqlupdate = "update " + tablename + " set " + exp + ",altime=current_timestamp where " + where;
                        } else {
                            sqlupdate = "update " + tablename + " set " + exp + " where " + where;
                        }

                        object.put("sql", sqlupdate);
                    } else {
                        isinsert = true;
                    }
                } else {
                    isinsert = true;
                }

                if (isinsert) {
                    if (null != request) {
                        Object objuid = request.getSession().getAttribute("uid");
                        String uid = "";
                        if (null != objuid) {
                            uid = objuid.toString();
                        }

                        Object objdepartno = request.getSession().getAttribute("departno");
                        String departno = "";
                        if (null != objdepartno) {
                            departno = (String)objdepartno;
                        }

                        Object objlan = request.getSession().getAttribute("lan");
                        String lan = "";
                        if (null != objlan) {
                            lan = (String)objlan;
                        }

                        if (StringUtil.notNull(uid)) {
                            strField = strField + ",uid";
                            strvalue = strvalue + "," + uid;
                        }

                        if (StringUtil.notNull(departno)) {
                            strField = strField + ",departno";
                            strvalue = strvalue + ",'" + departno + "'";
                        }

                        if (StringUtil.notNull(lan)) {
                            strField = strField + ",lan";
                            strvalue = strvalue + ",'" + lan + "'";
                        }
                    }

                    String sqlinsert = "insert into " + tablename + " (" + strField + ") values (" + strvalue.replace("____", ",") + ")";
                    object.put("sql", sqlinsert);
                } else {
                    object.put("msg", "无结果");
                }

                return object;
            } catch (Exception e) {
                log.error("Exception", e);
                e.printStackTrace();
                return object;
            }
        }
    }

    public static JSONObject getInsertValue(String dtype, String did, String tablename, String strField, JSONObject objdata, boolean isreplace) {
        JSONObject object = new JSONObject();
        Connection con = null;
        Statement st = null;
        ResultSet rs = null;

        try {
            con = DB.getCon(dtype, did);
            if (con == null) {
                object.put("code", 2);
                object.put("error", "数据库连接失败");
                object.put("msg", "数据库连接失败");
            } else {
                st = con.createStatement();
                String strvalue = getInsertValue(con, rs, tablename, strField, objdata, isreplace);
                object.put("code", 0);
                object.put("re", strvalue);
            }
        } catch (Exception e) {
            object.put("code", 3);
            object.put("error", "执行语句出错");
            object.put("msg", "执行语句出错");
            log.error("Exception", e);
        } finally {
            DB.close(con, st, rs);
        }

        return object;
    }

    public static String getInsertValue(Connection con, ResultSet colRet, String tablename, String strField, JSONObject objdata, boolean isreplace) {
        String strValue = "";

        try {
            String key = tablename + "____" + strField;
            JSONObject objColumn;
            if (objColumnType.has(key)) {
                objColumn = objColumnType.optJSONObject(key);
            } else {
                objColumn = new JSONObject();
                DatabaseMetaData DTtypes = con.getMetaData();

                String columnName;
                String type;
                for(colRet = DTtypes.getColumns((String)null, "%", tablename, "%"); colRet.next(); objColumn.put(columnName, type)) {
                    columnName = colRet.getString("COLUMN_NAME");
                    String DataType = colRet.getString("TYPE_NAME");
                    type = "1";
                    if (DataType.contains("int") || DataType.contains("decimal") || DataType.contains("serial") || DataType.contains("numeric")) {
                        type = "0";
                    }

                    if (DataType.contains("Date") || DataType.contains("timestamp")) {
                        type = "2";
                    }
                }

                objColumnType.put(key, objColumn);
                colRet.close();
            }

            String[] arrcolumns = strField.split(",");

            for(int i = 0; i < arrcolumns.length; ++i) {
                String column = arrcolumns[i].trim();
                String columnType = objColumn.optString(column);
                String columnValue = objdata.optString(column);
                columnValue = columnValue.replace("'", "''");
                if (columnType.equals("0")) {
                    strValue = strValue + (StringUtil.notNull(columnValue) ? columnValue + "," : "null,");
                } else if (columnType.equals("2")) {
                    strValue = strValue + (StringUtil.notNull(columnValue) ? "'" + columnValue + "'," : "null,");
                } else {
                    if (isreplace) {
                        columnValue = columnValue.replace(",", "____");
                    }

                    strValue = strValue + "'" + columnValue + "',";
                }
            }

            if (strValue.length() > 0) {
                strValue = strValue.substring(0, strValue.length() - 1);
            }
        } catch (Exception e) {
            log.error("getInsertValue:", e);
        }

        return strValue;
    }
}
```

## 使用样例：

```java
 public AjaxResult wxLogin(HttpServletRequest request, AppLoginBody appLoginBody) {
        log.info("wxLogin");
        JSONObject result = new JSONObject();
        result.put("sid", request.getSession().getId());
        String mobile = "";
        String openid = "";
        String logintype = appLoginBody.getLogintype();
        String systype = "xcxuid";
        String openidType = "xcx";//appLoginBody.getZhtype().equals("xcxcpmch") ? "xcx" : "gzh";
        try {
            log.info("++++++++++logintype:" + logintype);
            JSONObject objMobile;
            switch (logintype) {
                case "loginByMobile": //小程序 授权获取手机号
                    String logincode = appLoginBody.getLogincode();
                    if (StringUtil.notNull(logincode) && request.getSession().getAttribute("openid") == null) {
                        openid = getOpenid(appLoginBody.getZhtype(), logincode, request);
                    }
                    objMobile = xcxGetPhoneNumber(appLoginBody.getZhtype(), appLoginBody.getMobilecode());
                    mobile = objMobile.optString("mobile");
                    if (StringUtil.isNull(mobile)) {
                        return AjaxResult.error("登录失败", result.toString());
                    }
                    break;
                case "loginByVcode"://手机+验证码
                    mobile = appLoginBody.getMobile();
                    String vcode = appLoginBody.getVcode();
                    String servervcode = redisUtils.getCacheObject("uid_sms_" + mobile);
                    if (StringUtil.isNull(servervcode)) {
                        servervcode = Global.map.get("supervcode");
                    }
                    if (!vcode.equals(servervcode) || StringUtil.isNull(servervcode)) {//有验证码情况
                        return AjaxResult.error("验证码错误", result.toString());
                    }
                    break;
                case "autologin":// 自动登录验证
                    String token = appLoginBody.getToken();
                    mobile = redisUtils.getCacheObject("login_token:" + token);
                    redisUtils.deleteObject("login_token:" + token);
                    break;
                case "loginByopenid"://openid登录
                    openid = appLoginBody.getOpenid();
                    objMobile = DBUtil.selectOneJSON("w", "", "select mobile from xcxuser_loginlast where isdel=0 and openid ='" + openid + "' order by id desc");
                    mobile = objMobile.optString("mobile");
                    if (objMobile.optInt("length") == 0) {
                        return AjaxResult.error("自动登录失败", result.toString());
                    }
                    break;
                case "loginBycode"://小程序code登录
                    String wxcode = appLoginBody.getLogincode();
                    openid = getOpenid(appLoginBody.getZhtype(), wxcode, request);
                    objMobile = DBUtil.selectOneJSON("w", "", "select mobile from xcxuser_loginlast where isdel=0 and openid = '" + openid + "' order by id desc");
                    mobile = objMobile.optString("mobile");
                    if (objMobile.optInt("length") == 0 || StringUtil.isNull(mobile)) {
                        return AjaxResult.error("自动登录失败", result.toString());
                    }
                    break;
                default:
                    return AjaxResult.error("登录失败");
            }
            if (StringUtil.isNull(mobile)) {
                return AjaxResult.error("自动登录失败", result.toString());
            }
            // 登录前置校验，判断手机号是否符合规则（包括格式规则、黑白名单规则等规则）
            Pattern rs = Pattern.compile("^1(3[0-9]|4[01456879]|5[0-35-9]|6[2567]|7[0-8]|8[0-9]|9[0-35-9])\\d{8}$");  //手机号
            Matcher s = rs.matcher(mobile);
            if (mobile.equals("") || !s.matches()) {
                JSONObject objre = new JSONObject();
                objre.put("error", "自动登录失败");
                objre.put("code", 9);
                return AjaxResult.error("自动登录失败", objre.toString());
            }

            Map<String, Object> objuser = new HashMap<>();
            String fileds = "id,openid_xcx,unionid,mobile,nickname,userimg,sex,truename,idcard,sk";
            String sql = "select " + fileds + " from xcxuser where isdel=0 and status=0 and mobile='" + mobile + "'";
            JSONObject obj1 = DBUtil.selectOneJSON("w", "", sql);
            if (!obj1.has("id")) {//无用户情况
                if ((logintype.equals("loginByMobile") || logintype.equals("log inByVcode")) && !appLoginBody.getRetry()) {
                    DBUtil.insert("w", "", "xcxuser", "mobile", "'" + mobile + "'");
                    appLoginBody.setMobile(mobile);
                    appLoginBody.setRetry(true);
                    return wxLogin(request, appLoginBody);
                } else {
                    JSONObject objre = new JSONObject();
                    objre.put("error", "没有查到用户");
                    objre.put("code", 9);
                    return AjaxResult.error("没有查到用户", objre.toString());
                }
            } else {
                objuser = JsonToMap.jsonToMap(obj1);
            }

            String uid = objuser.get("id").toString();
            request.getSession().setAttribute("uid", uid);
            request.getSession().setAttribute("t", "w");
            String sessionId = request.getSession().getId();
            String md5sessionId = SHA1Encrypter.encodeByMD5(sessionId) + Math.random();
            String token = AESUtil.aesEncrypt(md5sessionId, sessionId.substring(0, 16));
            redisUtils.setCacheObject("login_token:" + token, mobile, 7 * 24 * 60 * 60, TimeUnit.SECONDS);

            if (StringUtil.isNull(openid) && request.getSession().getAttribute("openid") != null) {
                openid = request.getSession().getAttribute("openid").toString();
            }

            String userOpenid = (String) objuser.get("openid_" + openidType);
            String setuser = "";
            if (StringUtil.notNull(openid)) {
                if (StringUtil.isNull(userOpenid) || !userOpenid.equals(openid)) {
                    setuser = "openid_" + openidType + "='" + openid + "'";
                }
                //记录最后登录的手机号
                DBUtil.insert("w", "", "xcxuser_loginlast", "openid,mobile,zhtype", "'" + openid + "','" + mobile + "','" + openidType + "'", "isdel=0 and openid='" + openid + "'");
            }
            if (StringUtil.notNull(setuser)) {
                //更新下openid
                Long xcxuid = (Long) objuser.get("id");
                DBUtil.update("w", "", "xcxuser", "" + setuser, "id=" + xcxuid, request);
                objuser.put("openid_" + openidType, openid);
            }

            // 生成令牌
            result.put("sid", sessionId);
            result.put("token", token);
            result.put("objuser", objuser);
            result.put("openid", openid);
            result.put("code", 0);
            //将认证信息放到security中
            return AjaxResult.success("登录成功", result.toString());
        } catch (Exception e) {
            log.error(e.getMessage() + "{}", e);
            return AjaxResult.error(e.getMessage());
        }
    }
```

