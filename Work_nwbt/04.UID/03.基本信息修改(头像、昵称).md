## 头像

之前也是logo上传卡半天

现在小程序找到的工具类是uploadUtil.js 里面的uploadServer方法

![image-20250924133846399](03.基本信息修改(头像、昵称).assets/image-20250924133846399.png)



```
Object.assign(_this.xcxUserInfo, param);
```

### 期间遇到的问题

1. 小程序端直接传递图片到oss服务器上
   之前智能体也出现过相应的问题，这里的配置方法以及设置文件名称等

   修改  uploadServer 方法  不过需要注意的是  

   ![image-20250924152915587](03.基本信息修改(头像、昵称).assets/image-20250924152915587.png)

2. 之前遇到的修改昵称  明明有msg_where但就是没找到遇到的小问题

   修改的地方：
   ![image-20250924153102748](03.基本信息修改(头像、昵称).assets/image-20250924153102748.png)

## 代码优化

现在虽然实现了，但是代码冗余量太大，而且用户交互太差

之前的实现了，但是存在问题，而且获取OSS凭证 在vue中频繁出现，考虑将其放在一个工具类当中

### imageUploadUtil.js

将之前的获取oss签名以及对应的上传逻辑封装到imageUploadUtil.js中，再在vue文件中去使用

```js
/**
 * 图片上传工具类
 */
const uputil = require("./uploadUtil.js");
const app = getApp();

class ImageUploadUtil {

    /**
     * 显示头像选择弹窗
     * @param {Object} options - 配置选项
     * @param {Function} options.onSuccess - 成功回调，参数为图片路径
     * @param {Function} options.onCancel - 取消回调
     * @param {String} options.uploadPath - 上传路径，默认为 'upload/xcxuid/userimg'
     */
    static showAvatarPicker(options = {}) {
        const {
            onSuccess,
            onCancel,
            uploadPath = 'upload/xcxuid/userimg'
        } = options;

        uni.showActionSheet({
            itemList: ['用微信头像', '从相册选择', '拍照'],
            success: (res) => {
                switch(res.tapIndex) {
                    case 0:
                        this.useWechatAvatar(onSuccess);
                        break;
                    case 1:
                        this.chooseImage('album', uploadPath, onSuccess);
                        break;
                    case 2:
                        this.chooseImage('camera', uploadPath, onSuccess);
                        break;
                }
            },
            fail: () => {
                onCancel && onCancel();
            }
        });
    }

    /**
     * 使用微信头像
     * @param {Function} onSuccess - 成功回调
     */
    static useWechatAvatar(onSuccess) {
        // #ifdef MP-WEIXIN
        uni.getUserProfile({
            desc: '用于完善用户资料',
            success: (res) => {
                console.log('获取用户信息成功', res);
                // 微信头像直接返回，不需要上传到OSS
                this.showConfirmDialog(res.userInfo.avatarUrl, onSuccess);
            },
            fail: (err) => {
                console.log('获取用户信息失败', err);
                uni.showToast({
                    title: '获取微信头像失败',
                    icon: 'error'
                });
            }
        });
        // #endif

        // #ifndef MP-WEIXIN
        uni.showToast({
            title: '请在微信小程序中使用此功能',
            icon: 'none'
        });
        // #endif
    }

    /**
     * 选择图片
     * @param {String} sourceType - 图片来源类型 'album' | 'camera'
     * @param {String} uploadPath - 上传路径
     * @param {Function} onSuccess - 成功回调
     */
    static chooseImage(sourceType, uploadPath, onSuccess) {
        uni.chooseImage({
            count: 1,
            sizeType: ['compressed'], // 压缩图片
            sourceType: [sourceType],
            success: (res) => {
                // 显示预览和确认对话框
                this.showPreviewDialog(res, uploadPath, onSuccess);
            },
            fail: (err) => {
                console.log('选择图片失败', err);
                uni.showToast({
                    title: '选择图片失败',
                    icon: 'error'
                });
            }
        });
    }

    /**
     * 显示图片预览和确认对话框
     * @param {Object} imageRes - 图片选择结果
     * @param {String} uploadPath - 上传路径
     * @param {Function} onSuccess - 成功回调
     */
    static showPreviewDialog(imageRes, uploadPath, onSuccess) {
        // 创建预览页面的参数
        const previewData = {
            imagePath: imageRes.tempFilePaths[0],
            uploadPath: uploadPath
        };

        // 将数据存储到全局，供预览页面使用
        const app = getApp();
        app.globalData.tempPreviewData = {
            ...previewData,
            imageRes: imageRes,
            onSuccess: onSuccess
        };

        // 跳转到预览页面
        uni.navigateTo({
            url: '/pages/image-preview'
        });
    }

    /**
     * 显示确认对话框（用于微信头像）
     * @param {String} avatarUrl - 头像URL
     * @param {Function} onSuccess - 成功回调
     */
    static showConfirmDialog(avatarUrl, onSuccess) {
        uni.showModal({
            title: '确认使用微信头像？',
            content: '点击确定将保存微信头像',
            confirmText: '确定',
            cancelText: '取消',
            success: (res) => {
                if (res.confirm) {
                    onSuccess && onSuccess(avatarUrl);
                }
            }
        });
    }

    /**
     * 获取OSS签名
     * @param {String} uploadPath - 上传路径
     * @param {Function} callback - 回调函数
     */
    static getOSSSignature(uploadPath, callback) {
        uni.sm(function (re, err) {
            if (err) {
                uni.showToast({
                    title: '获取上传签名失败',
                    icon: 'error'
                });
                return;
            }

            if (re) {
                const osssignature = {
                    'key': re.dir,
                    'policy': re.policy,
                    'OSSAccessKeyId': re.accessid,
                    'success_action_status': '200', // 让服务端返回200,不然，默认会返回204
                    'signature': re.signature
                };
                callback && callback(osssignature);
            }
        }, ["oss.getsignature", uploadPath]);
    }

    /**
     * 上传图片到OSS (供外部调用的静态方法)
     * @param {Object} fileRes - 文件选择结果
     * @param {String} uploadPath - 上传路径
     * @param {Function} onSuccess - 成功回调
     */
    static uploadImageToOSS(fileRes, uploadPath, onSuccess) {
        // 显示上传进度
        uni.showLoading({
            title: '上传中...',
            mask: true
        });

        this.getOSSSignature(uploadPath, (osssignature) => {
            if (!osssignature) {
                uni.hideLoading();
                return;
            }

            try {
                console.log('开始上传图片:', fileRes);
                // 生成唯一文件名
                osssignature.key = osssignature.key + "/" + uputil.calculate_object_name(fileRes.tempFilePaths[0], 'random_name');

                uputil.uploadServer({
                    formData: osssignature,
                    arrfile: fileRes.tempFiles,
                    serverurl: app.globalData.ossPrefix,
                    complete: (arrpath) => {
                        uni.hideLoading();
                        console.log('上传成功，图片路径:', osssignature.key);
                        uni.showToast({
                            title: '上传成功',
                            icon: 'success'
                        });
                        // 回调返回OSS文件路径
                        onSuccess && onSuccess(osssignature.key);
                    },
                    fail: (error) => {
                        uni.hideLoading();
                        console.error('上传失败:', error);
                        uni.showToast({
                            title: '上传失败',
                            icon: 'error'
                        });
                    }
                });

            } catch (error) {
                uni.hideLoading();
                console.error('上传失败:', error);
                uni.showToast({
                    title: '上传失败',
                    icon: 'error'
                });
            }
        });
    }

    /**
     * 获取头像显示路径
     * @param {String} userimg - 用户头像路径
     * @param {String} defaultImg - 默认头像路径
     * @returns {String} 完整的头像URL
     */
    static getAvatarDisplayUrl(userimg, defaultImg = "/static/image/home/identity_img.png") {
        if (!userimg) {
            return defaultImg;
        }

        // 如果是微信头像（通常以http开头），直接返回
        if (userimg.startsWith('http')) {
            return userimg;
        }

        // 其他情况需要拼接OSS前缀
        return app.globalData.ossPrefix + userimg;
    }
}

module.exports = ImageUploadUtil;
```

### tabBar/mine/index.vue

```vue
<!-- pages/mine/index.vue -->
<template>
  <view>
    <view>
      <view class="top-bgview">
        <image src="/static/image/home/indexbg.png" style="width: 100%;height: 700rpx;"></image>
        <view style="text-align: center;position: absolute;top:30rpx;left: 0;right: 0;">
          <view class="weui-cell">
            <image :src="getAvatarSrc()" @click="changeAvatar"
                   style="width:121rpx;height: 121rpx; margin-right: 20rpx; border-radius: 50px;border: 1px solid #FFFFFF;">
            </image>
            <view class="weui-cell__bd"
                  style="align-items: flex-start;flex-direction: column; text-align: left;" @click="toBasicinfo">
              <view style="font-size: 48rpx;color: #FFFFFF;">
                {{ myinfo.truename || myinfo.nickname || myinfo.mobile || "XXXXX" }}
              </view>
            </view>
          </view>
        </view>
      </view>

      <view style="text-align: center;position: absolute;top:220rpx;left: 0;right: 0;">
        <view class="weui-cells panel-view noafter" style="box-shadow: 0px 3px 5px 1px #e8f6f4;">
          <view class="weui-cell" @click="toMyinfo">
            <view class="weui-cell__bd weui-flex" style="align-items: center;">
              <view class="weui-flex_center" style="width: 50rpx;margin-right: 20rpx;">
                <image src="/static/image/home/mineico01.png" style="width: 40rpx;height:40rpx;"></image>
              </view>
              <view>个人资料</view>
            </view>
            <view class="weui-cell__ft weui-cell__ft_in-access"></view>
          </view>
          <view class="weui-cell" @click="toFeeDback">
            <view class="weui-cell__bd weui-flex" style="align-items: center;">
              <view class="weui-flex_center" style="width: 50rpx;margin-right: 20rpx;">
                <image src="/static/image/home/mineico02.png" style="width: 40rpx;height:40rpx;"></image>
              </view>
              <view>意见反馈</view>
            </view>
            <view class="weui-cell__ft weui-cell__ft_in-access"></view>
          </view>
          <view class="weui-cell" @click="toHelpCenter">
            <view class="weui-cell__bd weui-flex" style="align-items: center;">
              <view class="weui-flex_center" style="width: 50rpx;margin-right: 20rpx;">
                <image src="/static/image/home/mineico03.png" style="width: 40rpx;height:40rpx;"></image>
              </view>
              <view>关于安全中心</view>
            </view>
            <view class="weui-cell__ft weui-cell__ft_in-access"></view>
          </view>
          <view class="weui-cell" @click="addToDesktop">
            <view class="weui-cell__bd weui-flex" style="align-items: center;">
              <view class="weui-flex_center" style="width: 50rpx;margin-right: 20rpx;">
                <image src="/static/image/home/mineico04.png" style="width: 40rpx;height:40rpx;"></image>
              </view>
              <view>添加桌面</view>
            </view>
            <view class="weui-cell__ft weui-cell__ft_in-access"></view>
          </view>
          <view class="weui-cell" @click="Subscribe()">
            <view class="weui-cell__bd weui-flex" style="align-items: center;">
              <view class="weui-flex_center" style="width: 50rpx;margin-right: 20rpx;">
                <image src="/static/image/home/mineico05.png" style="width: 40rpx;height:40rpx;"></image>
              </view>
              <view>设置</view>
            </view>
            <view class="weui-cell__ft weui-cell__ft_in-access"></view>
          </view>
        </view>
      </view>
    </view>
  </view>
</template>

<script>
const ImageUploadUtil = require("../../../common/imageUploadUtil.js");
const moment = require("../../../common/moment.min.js");
const util = require("../../../common/util.js");
const app = getApp();

export default {
  data() {
    return {
      myinfo: app.globalData.objuserinfo || {},
      pname: ''
    }
  },

  onLoad(params) {
    this.initData();
  },

  onShow() {
    // 页面显示时刷新用户信息
    this.myinfo = app.globalData.objuserinfo || {};
  },

  methods: {
    initData() {
      // 初始化数据
      this.myinfo = app.globalData.objuserinfo || {};
      console.log("initData", this.myinfo);
    },

    // 显示头像
    getAvatarSrc() {
      return ImageUploadUtil.getAvatarDisplayUrl(this.myinfo.userimg);
    },

    // 修改头像
    changeAvatar() {
      const _this = this;

      ImageUploadUtil.showAvatarPicker({
        uploadPath: 'upload/xcxuid/userimg',
        onSuccess: (imagePath) => {
          // 用户确认后，保存头像信息
          _this.saveUserInfo({
            userimg: imagePath
          });
        },
        onCancel: () => {
          console.log('用户取消了头像选择');
        }
      });
    },

    // 保存用户信息到服务器
    saveUserInfo(param) {
      console.log("saveUserInfo", param);
      const _this = this;

      uni.sm(function(re, err, obj) {
        if (err) {
          uni.msg(err);
          return;
        }

        uni.msg('保存成功');

        // 更新本地用户信息
        Object.assign(_this.myinfo, param);
        Object.assign(app.globalData.objuserinfo, param);

        console.log("保存用户信息成功", param);

      }, ['xcxuser.updateBasicInfo', JSON.stringify(param), uni.msgwhere({id: [this.myinfo.id]})]);
    },

    // 基本信息修改 头像，昵称
    toBasicinfo() {
      if (!this.myinfo || !this.myinfo.id) { // 未登录，跳转到登录页
        uni.navigateTo({
          url: "/pages/login/login"
        });
        return;
      }
      uni.navigateTo({
        url: "/pages/mine/mybasicinfo"
      });
    },

    // 个人信息 这是从别的系统调用获取到的
    toMyinfo() {
      if (!this.myinfo || !this.myinfo.id) { // 未登录，跳转到登录页
        uni.navigateTo({
          url: "/pages/login/login"
        });
        return;
      }
      uni.navigateTo({
        url: "/pages/mine/myinfo"
      });
    },

    // 帮助中心
    toHelpCenter() {
      if (!this.myinfo || !this.myinfo.id) { // 未登录，跳转到登录页
        uni.navigateTo({
          url: "/pages/login/login"
        });
        return;
      }
      uni.navigateTo({
        url: "/pages/mine/help_center"
      });
    },

    // 意见反馈
    toFeeDback() {
      if (!this.myinfo || !this.myinfo.id) { // 未登录，跳转到登录页
        uni.navigateTo({
          url: "/pages/login/login"
        });
        return;
      }
      uni.navigateTo({
        url: "/pages/mine/feedback"
      });
    },

    // 添加桌面
    addToDesktop() {
      if (!this.myinfo || !this.myinfo.id) { // 未登录，跳转到登录页
        uni.navigateTo({
          url: "/pages/login/login"
        });
        return;
      }
      // 添加桌面功能，可以根据需要实现
      uni.showToast({
        title: '添加桌面功能',
        icon: 'none'
      });
    },

    // 订阅消息/设置
    Subscribe(cb) {
      if (!this.myinfo || !this.myinfo.id) { // 未登录，跳转到登录页
        uni.navigateTo({
          url: "/pages/login/login"
        });
        return;
      }

      // #ifdef MP-WEIXIN
      uni.requestSubscribeMessage({
        // 此处填写刚才申请模板的模板ID
        tmplIds: ['SxWEPUY0eaZxFKGt-uyy31-WiCQRVJ6YYczIcfr5XS8'],
        success(res) {
          console.log(res);
          if (res.errMsg == 'requestSubscribeMessage:ok') {
            uni.showToast({
              title: '订阅成功+1',
              icon: 'none'
            });
          }
          cb && cb(res);
        }
      });
      // #endif
      // #ifndef MP-WEIXIN
      uni.showToast({
        title: '请在微信小程序操作！',
        icon: 'none'
      });
      cb && cb();
      // #endif
    },

    // 登录回调
    logincallback() {
      this.myinfo = app.globalData.objuserinfo;
      this.initData();
    }
  }
}
</script>

<style>
page {
  background: #ffffff;
}

.weui-cell__ft {
  color: #8C8C8C;
  font-size: 20rpx;
}

.weui-cell__ft_in-access:after {
  border-color: #8C8C8C;
}

.weui-cell {
  padding: 40rpx 30rpx;
}

.weui-cells:after {
  border-bottom: none;
}

.weui-cell::before {
  right: 30rpx;
  left: 30rpx;
}

.weui-cells:before {
  border-top: none;
}

.top-bgview {
  height: 887rpx;
  overflow: hidden;
}

/* 响应式布局 */
.weui-flex {
  display: flex;
}

.weui-flex_center {
  display: flex;
  align-items: center;
  justify-content: center;
}

.panel-view {
  margin: 0 30rpx;
  border-radius: 20rpx;
  overflow: hidden;
}

.noafter:after {
  display: none;
}

/* 用户头像点击效果 */
.weui-cell image {
  transition: transform 0.2s ease;
}

.weui-cell image:active {
  transform: scale(0.95);
}

/* 菜单项hover效果 */
.weui-cell:active {
  background-color: #f7f7f7;
}
</style>
```

### mine/mybasicinfo.vue

```vue
<template>
  <view>
    <view class="weui-cells weui-cells_after-title">
      <view class="weui-cell" style="height: 25px;" @click="changeAvatar">
        <view class="weui-cell__bd">头像</view>
        <view class="weui-cell__ft">
          <image :src="getAvatarSrc()" class="paymentico"></image>
        </view>
      </view>

      <view class="weui-cell" @click="changePrompt('昵称','nickname',xcxUserInfo.nickname)">
        <view class="weui-cell__bd">昵称</view>
        <view class="weui-cell__fts weui-cell__ft_in-access">{{xcxUserInfo.nickname || '请输入昵称'}}</view>
      </view>
    </view>
  </view>
</template>

<script>
const ImageUploadUtil = require("../../common/imageUploadUtil.js");
const app = getApp();

export default {
  data() {
    return {
      env_version: app.globalData.env_version,
      t: null,
      feedbackContent: '',
      myinfo: app.globalData.objuserinfo,
      selectedTypeId: 1,
      xcxUserInfo: {} // 存储用户信息
    }
  },

  onLoad: async function(params) {
    this.initXcxUserInfo();
  },

  methods: {
    initXcxUserInfo(){
      const _this = this;
      uni.sm(function(re, err){
        if(err){
          return uni.msg(err);
        }
        console.log(re);
        _this.xcxUserInfo = re[0];
      }, ["xcxuser.getInfo", this.myinfo.id], {route: uni.svs.auth})
    },

    // 获取头像路径
    getAvatarSrc() {
      return ImageUploadUtil.getAvatarDisplayUrl(this.xcxUserInfo.userimg);
    },

    // 修改头像
    changeAvatar() {
      const _this = this;

      ImageUploadUtil.showAvatarPicker({
        uploadPath: 'upload/xcxuid/userimg',
        onSuccess: (imagePath) => {
          // 用户确认后，保存头像信息
          _this.saveUserInfo({
            userimg: imagePath
          });
        },
        onCancel: () => {
          console.log('用户取消了头像选择');
        }
      });
    },

    // 保存用户信息
    saveUserInfo(param) {
      console.log("saveUserInfo param:", param);
      const _this = this;

      uni.sm(function(re, err){
        if(err){
          return uni.msg(err);
        }

        uni.msg('保存成功');

        // 更新本地数据
        Object.assign(_this.xcxUserInfo, param);

        // 同步更新全局用户信息
        if (param.userimg) {
          app.globalData.objuserinfo.userimg = param.userimg;
        }
        if (param.nickname) {
          app.globalData.objuserinfo.nickname = param.nickname;
        }
      }, ["xcxuser.updateBasicInfo", JSON.stringify(param), uni.msgwhere({id: [this.myinfo.id]})]);
    },

    // 弹框输入（参考myinfo.vue的实现）
    changePrompt: function(title, itype, _val) {
      const _this = this;
      uni.prompt(title || "输入", _val, function(res) {
        if (itype == "nickname" && res.content.length > 15) {
          setTimeout(function() {
            uni.alert("长度不能大于15位");
          }, 100);
          return;
        }

        // 先更新本地显示
        _this.xcxUserInfo[itype] = res.content;

        // 构造参数并保存
        const param = {};
        param[itype] = res.content;
        _this.saveUserInfo(param);
      })
    }
  }
}
</script>

<style>
page {
  background: #fff;
}

.weui-cell {
  padding: 15px;
}

.weui-cell .weui-cell__bd {
  font-size: 14px;
  color: #303030;
}

.weui-cell .weui-cell__ft {
  font-size: 14px;
  color: #303030;
}

.weui-cell .weui-cell__fts {
  font-size: 14px;
  color: #999999;
}

.weui-cell:before {
  right: 15px;
}

.weui-cells:after {
  right: 15px;
  left: 15px;
}

.paymentico {
  width: 72rpx;
  height: 72rpx;
  border-radius: 50px;
}

/* 菜单项hover效果 */
.weui-cell:active {
  background-color: #f7f7f7;
}
</style>
```



## 结构优化

现有的选择头像是通过uni.showActionSheet() 

组件去实现底部选择头像的，而本身这个组件是只能使用文本，就导致了，不能实现在使用微信登录的那一栏预览微信的头像后点击



两个问题：1.在index.vue中点击头像时没有判断是否登录，登录后才可以选择头像上传，然后点击区域不需要点击效果。2. 虽然这儿封装好了uni.showActionSheet()去实现底部弹出，但是我在真机模拟中它不是在底部弹出的，我也不想使用这个，因为它只能设置文本，所以这部分可以不用封装，也就是showAvatarPicker这个方法放到对应的vue文件中，我想要的效果是使用微信头像时效果应该是图中的效果，当然了从相册选择和拍照是可以封装的，但是不好关联到底部的这种弹出效果，你可以选择别的方案，最最重要的是得到微信头像那部分

### 效果：

![image-20250925114658832](03.基本信息修改(头像、昵称).assets/image-20250925114658832.png)









如果要添加图片裁剪，按照微信那种，中间是正方形，可以控制大小，确认后上传存储到OSS可以如何实现？



### 原始的

原始的是直接上传选择的图，这会导致如果选择的图特别大的话，依然还是原图走的，这会导致云存储的资源浪费比较严重，因此添加压缩机制



新的问题：

裁剪的和选择的不一致！！！ 原因裁剪的算法有问题

将图初始化后，得到图的大小，然后规定了正方形的大小  那么x_y方向上从0开始到正方形的边长就是现在image-preview中得到的头像区域，最终的截图也是就截取了这么一块 



而参考微信的头像算法

![image-20250925160749967](03.基本信息修改(头像、昵称).assets/image-20250925160749967.png)



还有一个逻辑问题：

重新选择重新从起始页组件进入到页面中进行操作？

没有头像的预览   也是一个问题 ！！！！





微信裁剪的逻辑是

中间固定一块方形  和咱们现在的效果一致，但是我们忽略了很多的细节问题



经过真机测试 上传头像没问题  修改昵称也没有问题  但是要连接同一局域网，而且需要将globaldata.js中的地址修改为本机的ip地址   裁剪图像有问题

![image-20250925160141439](03.基本信息修改(头像、昵称).assets/image-20250925160141439.png)

## 获取用户头像和昵称

之前使用的是uni.getUserProfile  在微信小程序中已经弃用， 哪怕请求返回的也是 微信用户和 白色头像

**需要使用button按钮 并配合着 open-type="chooseAvatar" 去使用**

### tabBer/mine/index.vue修改

使用这个组件之后原本的底部弹出层就不需要了，改呗 







## 使用新版API  button  open-type="onchooseAvatar"

上面谈到了使用uni.getUserProfile已经[白给](https://www.cnblogs.com/youmingkuang/p/17480698.html)了   现在使用新版api去适配

这次考虑将修改头像这部分封装到这个工具类当中

**新版组件压缩图比较严重**  看后续是否需要换

![image-20250925182941760](03.基本信息修改(头像、昵称).assets/image-20250925182941760.png)

而且

明天想要将前面的实现思路相结合  

### imageUploadUtil.js





### tabBar/mine/index.vue



### mine/mybasicinfo.vue

## bug

### 1、裁剪头像

在微信开发者工具中无法裁剪头像，直接就上传了  

![image-20250926110508745](03.基本信息修改(头像、昵称).assets/image-20250926110508745.png)

但是在真机中可以，就是选择从相册和拍照中是可以的
![image-20250926114506220](03.基本信息修改(头像、昵称).assets/image-20250926114506220.png)





