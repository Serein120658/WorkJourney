11.5开会我所需要确定的问题

## 1、标签读取距离









## 2、手柄按键的单独页面控制

关键代码：












## BUG

### 1、绑定标签时候的Bug

```vue
<template>
	<view class="content">	
		<!-- 统计信息 -->
		<view class="stats-container">
			<view class="stat-item">
				<text class="stat-label">标签数:</text>
				<text class="stat-value">{{ uniqueTagCount }}</text>
			</view>
			<view class="stat-item">
				<text class="stat-label">读取次数:</text>
				<text class="stat-value">{{ totalReadCount }}</text>
			</view>
			<view class="stat-item">
				<text class="stat-label">耗时:</text>
				<text class="stat-value">{{ formatTime(elapsedTime) }}</text>
			</view>
		</view>
		
		<!-- 表格 -->
		<view class="table-container">
			<view class="table">
				<!-- 表头 -->
				<view class="table-header">
					<view class="table-cell" style="flex: 2;">EPC</view>
					<view class="table-cell" style="flex: 1.5;">TID</view>
					<view class="table-cell" style="flex: 0.8;">RSSI</view>
					<view class="table-cell" style="flex: 0.8;">次数</view>
				</view>
				
				<!-- 表格内容 -->
				<scroll-view class="table-body" scroll-y="true">
					<view v-for="(tag, index) in tagList" :key="tag.epc" class="table-row">
						<view class="table-cell" style="flex: 2;">
							<text class="epc-text">{{ tag.epc }}</text>
							<text class="tid-text">{{ tag.tid }}</text>
						</view>
						<view class="table-cell" style="flex: 1.5;">
							<text class="cell-text">{{ tag.tid || '-' }}</text>
						</view>
						<view class="table-cell" style="flex: 0.8;">
							<text class="cell-text">{{ tag.rssi }}</text>
						</view>
						<view class="table-cell" style="flex: 0.8;">
							<text class="cell-text">{{ tag.count }}</text>
						</view>
					</view>
					
					<!-- 空状态 -->
					<view v-if="tagList.length === 0" class="empty-state">
						<text class="empty-text">{{ isScanning ? '正在扫描...' : '暂无数据' }}</text>
					</view>
				</scroll-view>
			</view>
		</view>
		
		<!-- 底部按钮 -->
		<view class="button-container">
			<button 
				class="btn btn-start" 
				:class="{ 'btn-active': isScanning }"
				@click="toggleScan"
			>
				{{ isScanning ? '停止' : '开始扫描' }}
			</button>
			<button class="btn btn-stop" @click="clearData">清空</button>
			<button class="btn btn-clear" @click="exportData">导出</button>
		</view>
	</view>
</template>

<script>
	/* TODO  整体存在的Bug  当点击了开始扫描 但是没有点停止  
	此时点击底部导航栏的别的栏目，会很卡，并伴有这个页面的TOAST
	再次点回这个页面的时候 在控制栏发现，标签是一直扫描着的  但是数据并没有更新  
	按钮虽然变回了开始扫描  但再次点击提示扫描停止！！！说明了广播和插件的初始化和卸下时机有问题
	后续的功能中会有出库，入库等操作，而出入库的配置是不一样的 
	入库是扫描到一些待绑定的标签   与    货物批量关联
	出库提到的是将标签的EPC部分清零    入库的时候给其一个新的
	
	盘库需要大功率的多标签扫描模式    配置和当前又是不一致的，等下看原型
	 
	 */
	const plugin = uni.requireNativePlugin('UniUHF');
	
	export default {
		data() {
			return {
				isScanning: false,          // 是否正在扫描
				tagMap: {},                 // 标签映射表 {epc: tagData}
				tagList: [],                // 标签列表（用于显示）
				totalReadCount: 0,          // 总读取次数
				uniqueTagCount: 0,          // 唯一标签数
				elapsedTime: 0,             // 已用时间（秒）
				timer: null,                // 计时器
				main: null,                 // Android主Activity
				receiver: null,             // 广播接收器
				filter: null                // 广播过滤器
			}
		},
		
		onLoad() {
			console.log('页面加载');
		},
		
		onShow() {
			console.log('页面显示');
			this.initUHF();
		},
		
		onHide() {
			console.log('页面隐藏');
			this.stopScan();
			this.uninitUHF();
		},
		
		onBackPress() {
			console.log('返回按钮');
			this.stopScan();
			this.uninitUHF();
		},
		
		beforeDestroy() {
			console.log('页面销毁');
			this.unregisterReceiver();
		},
		
		methods: {
			/**
			 * 初始化超高频模块
			 */
			initUHF() {
				// 初始化超高频模块
				const result = plugin.initUHFManager();
				
				if (result === 1 || result === true) {
					console.log('UHF初始化成功');
					
					// TODO 这部分后续需要创建一个配置文件  从配置中获取  这里就设置一个demo 配置参数
					plugin.setUHFPower(3300);           // 范围0 - 3300(中国区域的)  设置的功率基本可以模糊出相应的距离
					plugin.setUHFZone(6);               // 设置中国区域
					plugin.setUHFInventoryMode(2);      // 快速模式  0 单标签模式依然会读取很多   只能选择信号强度最大的那个了！！
					plugin.setUHFSession(1);            // Session 0  0适合动着的   1-适合大量静止的
					plugin.setAudioTip(true);           // 开启提示音
					
					// 注册广播接收器
					this.registerReceiver();
					
				} else {
					console.error('UHF初始化失败');
					uni.showToast({
						title: '初始化失败',
						icon: 'error',
						duration: 2000
					});
				}
			},
			
			/**
			 * 反初始化超高频模块
			 */
			uninitUHF() {
				if (plugin) {
					plugin.uninitUHFManager();
					console.log('UHF已反初始化');
				}
			},
			
			/**
			 * 注册广播接收器
			 */
			registerReceiver() {
				// #ifdef APP-PLUS
				this.main = plus.android.runtimeMainActivity();
				
				const IntentFilter = plus.android.importClass('android.content.IntentFilter');
				this.filter = new IntentFilter();
				this.filter.addAction("com.pda.keycode.broacast");    // 按键广播
				this.filter.addAction("uni.pda.uhf.data");            // 标签数据广播
				
				const _this = this;
				this.receiver = plus.android.implements('io.dcloud.feature.internal.reflect.BroadcastReceiver', {
					onReceive: function(context, intent) {
						plus.android.importClass(intent);
						const action = intent.getAction();
						
						// 处理按键广播
						if (action === "com.pda.keycode.broacast") {
							const keycode = intent.getIntExtra("keycode", 0);
							const isKeyDown = intent.getBooleanExtra("isdown", false);
							
							// 手柄按键292
							if (keycode === 292) {
								if (isKeyDown) {
									_this.startScan();
								} else {
									_this.stopScan();
								}
							}
						}
						// 处理标签数据广播
						else if (action === "uni.pda.uhf.data") {
							const uhfdata = intent.getStringExtra("uhfdata");
							_this.parseTagData(uhfdata);
						}
					}
				});
				
				this.main.registerReceiver(this.receiver, this.filter);
				console.log('广播接收器已注册');
				// #endif
			},
			
			/**
			 * 注销广播接收器
			 */
			unregisterReceiver() {
				// #ifdef APP-PLUS
				if (this.main && this.receiver) {
					this.main.unregisterReceiver(this.receiver);
					console.log('广播接收器已注销');
				}
				// #endif
			},
			
			/**
			 * 切换扫描状态
			 */
			toggleScan() {
				if (this.isScanning) {
					this.stopScan();
				} else {
					this.startScan();
				}
			},
			
			/**
			 * 开始扫描
			 */
			startScan() {
				if (this.isScanning) return;
				
				const result = plugin.startInventory();
				if (result) {
					this.isScanning = true;
					this.startTimer();
					console.log('开始盘点');
					
					uni.showToast({
						title: '开始扫描',
						icon: 'none',
						duration: 1000
					});
				} else {
					console.error('启动盘点失败');
					uni.showToast({
						title: '启动失败',
						icon: 'error'
					});
				}
			},
			
			/**
			 * 停止扫描
			 */
			stopScan() {
				if (!this.isScanning) return;
				
				const result = plugin.stopInventory();
				if (result) {
					this.isScanning = false;
					this.stopTimer();
					console.log('停止盘点');
					
					uni.showToast({
						title: '停止扫描',
						icon: 'none',
						duration: 1000
					});
				}
			},
			
			/**
			 * 开始计时
			 */
			startTimer() {
				this.elapsedTime = 0;
				this.timer = setInterval(() => {
					this.elapsedTime++;
				}, 1000);
			},
			
			/**
			 * 停止计时
			 */
			stopTimer() {
				if (this.timer) {
					clearInterval(this.timer);
					this.timer = null;
				}
			},
			
			/**
			 * 格式化时间
			 */
			formatTime(seconds) {
				const hours = Math.floor(seconds / 3600);
				const minutes = Math.floor((seconds % 3600) / 60);
				const secs = seconds % 60;
				
				return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
			},
			
			/**
			 * 解析标签数据
			 * 数据格式: [epc,tid,rssi,freq][epc,tid,rssi,freq]...
			 */
			parseTagData(uhfdata) {
				if (!uhfdata) return;
				
				console.log('接收标签数据:', uhfdata);
				
				// 使用正则表达式提取所有标签数据
				const tagPattern = /\[(.*?)\]/g;
				let match;
				
				while ((match = tagPattern.exec(uhfdata)) !== null) {
					const tagData = match[1].split(',');
					
					if (tagData.length >= 4) {
						const epc = tagData[0].trim();
						const tid = tagData[1].trim();
						const rssi = tagData[2].trim();
						const freq = tagData[3].trim();
						
						// 更新或添加标签
						this.updateTag(epc, tid, rssi, freq);
					}
				}
			},
			
			/**
			 * 更新标签数据
			 */
			updateTag(epc, tid, rssi, freq) {
				this.totalReadCount++;
				
				if (this.tagMap[epc]) {
					// 已存在，更新计数和RSSI
					this.tagMap[epc].count++;
					this.tagMap[epc].rssi = rssi;
					this.tagMap[epc].freq = freq;
				} else {
					// 新标签
					this.tagMap[epc] = {
						epc: epc,
						tid: tid,
						rssi: rssi,
						freq: freq,
						count: 1,
						timestamp: Date.now()
					};
					this.uniqueTagCount++;
				}
				
				// 更新列表（按时间倒序）
				this.updateTagList();
			},
			
			/**
			 * 更新标签列表
			 */
			updateTagList() {
				this.tagList = Object.values(this.tagMap).sort((a, b) => {
					return b.timestamp - a.timestamp;
				});
			},
			
			/**
			 * 清空数据
			 */
			clearData() {
				uni.showModal({
					title: '确认',
					content: '确定要清空所有数据吗？',
					success: (res) => {
						if (res.confirm) {
							this.tagMap = {};
							this.tagList = [];
							this.totalReadCount = 0;
							this.uniqueTagCount = 0;
							this.elapsedTime = 0;
							
							uni.showToast({
								title: '已清空',
								icon: 'success'
							});
						}
					}
				});
			},
			
			/**
			 * 导出数据
			 */
			exportData() {
				if (this.tagList.length === 0) {
					uni.showToast({
						title: '暂无数据',
						icon: 'none'
					});
					return;
				}
				
				// 生成CSV格式数据
				let csvContent = 'EPC,TID,RSSI,频率,读取次数\n';
				this.tagList.forEach(tag => {
					csvContent += `${tag.epc},${tag.tid},${tag.rssi},${tag.freq},${tag.count}\n`;
				});
				
				// 这里可以实现文件保存功能
				console.log('导出数据:', csvContent);
				
				uni.showToast({
					title: '导出成功',
					icon: 'success'
				});
			}
		}
	}
</script>

<style scoped>
	.content {
		display: flex;
		flex-direction: column;
		height: 100vh;
		background-color: #f5f5f5;
	}
	
	/* 统计信息 */
	.stats-container {
		display: flex;
		justify-content: space-around;
		padding: 30rpx 20rpx;
		background-color: #ffffff;
		margin: 20rpx;
		border-radius: 16rpx;
		box-shadow: 0 4rpx 12rpx rgba(0, 0, 0, 0.08);
	}
	
	.stat-item {
		display: flex;
		flex-direction: column;
		align-items: center;
	}
	
	.stat-label {
		font-size: 24rpx;
		color: #999999;
		margin-bottom: 8rpx;
	}
	
	.stat-value {
		font-size: 36rpx;
		font-weight: bold;
		color: #333333;
	}
	
	/* 表格容器 */
	.table-container {
		flex: 1;
		margin: 0 20rpx 20rpx;
		background-color: #ffffff;
		border-radius: 16rpx;
		overflow: hidden;
		box-shadow: 0 4rpx 12rpx rgba(0, 0, 0, 0.08);
	}
	
	.table {
		display: flex;
		flex-direction: column;
		height: 100%;
	}
	
	/* 表头 */
	.table-header {
		display: flex;
		background: #4dc3a6;
		padding: 24rpx 20rpx;
		border-bottom: 2rpx solid #e0e0e0;
	}
	
	.table-header .table-cell {
		color: #ffffff;
		font-size: 28rpx;
		font-weight: bold;
	}
	
	/* 表格内容 */
	.table-body {
		flex: 1;
		overflow-y: auto;
	}
	
	.table-row {
		display: flex;
		padding: 24rpx 20rpx;
		border-bottom: 1rpx solid #f0f0f0;
		transition: background-color 0.2s;
	}
	
	.table-row:active {
		background-color: #f8f8f8;
	}
	
	.table-cell {
		display: flex;
		flex-direction: column;
		justify-content: center;
		padding: 0 10rpx;
		word-break: break-all;
	}
	
	.epc-text {
		font-size: 26rpx;
		color: #333333;
		font-weight: 500;
		margin-bottom: 8rpx;
	}
	
	.tid-text {
		font-size: 22rpx;
		color: #999999;
	}
	
	.cell-text {
		font-size: 26rpx;
		color: #666666;
		text-align: center;
	}
	
	/* 空状态 */
	.empty-state {
		display: flex;
		justify-content: center;
		align-items: center;
		padding: 100rpx 0;
	}
	
	.empty-text {
		font-size: 28rpx;
		color: #999999;
	}
	
	/* 底部按钮 */
	.button-container {
		display: flex;
		padding: 20rpx;
		background-color: #ffffff;
		box-shadow: 0 -4rpx 12rpx rgba(0, 0, 0, 0.08);
	}
	
	.btn {
		flex: 1;
		height: 88rpx;
		line-height: 88rpx;
		margin: 0 10rpx;
		border-radius: 12rpx;
		font-size: 30rpx;
		font-weight: bold;
		border: none;
		transition: all 0.3s;
	}
	
	.btn-start {
	    background: #3fbf5d;
		color: #ffffff;
	}
	
	.btn-start.btn-active {
		background: #ea3c2c;
	}
	
	.btn-stop {
		background-color: #a8a8a8;
		color: #ffffff;
	}
	
	.btn-clear {
		background-color: #5555ff;
		color: #ffffff;
	}
	
	.btn:active {
		opacity: 0.8;
		transform: scale(0.98);
	}
</style>
```



















