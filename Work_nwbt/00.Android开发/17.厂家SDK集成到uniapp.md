# 思想

## 方案选择：uni-app 原生插件（本地插件）

由于你没有这方面经验，我推荐用**本地插件**方式，而不是云端插件，因为：

- ✅ 不需要上传到插件市场
- ✅ 调试方便，改完立即生效
- ✅ 适合新手上手

------

## 完整实操步骤（保姆级）

### 第一步：准备工作（10分钟）

#### 1.1 需要的工具

```
✅ Android Studio（最新版）
✅ HBuilderX（最新版）
✅ JDK 1.8
✅ 厂家提供的 SDK 文件（.aar 或 .jar）
```

#### 1.2 创建项目目录结构

```
你的uni-app项目/
├── nativeplugins/              ← 新建这个文件夹
│   └── YC-RFID/                ← 插件名称（随意取）
│       ├── android/
│       │   ├── libs/
│       │   │   └── uhfengine.aar    ← 厂家SDK放这里
│       │   ├── src/
│       │   │   └── io/
│       │   │       └── dcloud/
│       │   │           └── RFID/
│       │   │               └── RFIDModule.java  ← 我们要写的代码
│       │   ├── build.gradle
│       │   └── AndroidManifest.xml
│       └── package.json
└── pages/
    └── index/
        └── index.vue
```

------

### 第二步：创建插件基础文件（15分钟）

#### 2.1 创建 `package.json`

在 `nativeplugins/YC-RFID/package.json` 创建文件：

```json
{
  "name": "YC-RFID",
  "id": "YC-RFID",
  "version": "1.0.0",
  "description": "RFID标签读写插件",
  "_dp_type": "nativeplugin",
  "_dp_nativeplugin": {
    "android": {
      "plugins": [
        {
          "type": "module",
          "name": "YC-RFID",
          "class": "io.dcloud.RFID.RFIDModule"
        }
      ],
      "integrateType": "aar",
      "minSdkVersion": "21"
    }
  }
}
```

#### 2.2 创建 `AndroidManifest.xml`

在 `nativeplugins/YC-RFID/android/AndroidManifest.xml`：

```xml
<?xml version="1.0" encoding="utf-8"?>
<manifest xmlns:android="http://schemas.android.com/apk/res/android"
    package="io.dcloud.RFID">
    
    <!-- RFID 相关权限 -->
    <uses-permission android:name="android.permission.READ_EXTERNAL_STORAGE" />
    <uses-permission android:name="android.permission.WRITE_EXTERNAL_STORAGE" />
    
</manifest>
```

#### 2.3 创建 `build.gradle`

在 `nativeplugins/YC-RFID/android/build.gradle`：

```gradle
apply plugin: 'com.android.library'

android {
    compileSdkVersion 28
    
    defaultConfig {
        minSdkVersion 21
        targetSdkVersion 28
        versionCode 1
        versionName "1.0"
    }
    
    lintOptions {
        abortOnError false
    }
    
    // 支持 aar 文件
    repositories {
        flatDir {
            dirs 'libs'
        }
    }
}

dependencies {
    // uni-app 基础库（必须）
    compileOnly fileTree(dir: '../app/libs', include: ['uniapp-v8-release.aar'])
    compileOnly 'com.android.support:recyclerview-v7:28.0.0'
    compileOnly 'com.android.support:support-v4:28.0.0'
    compileOnly 'com.android.support:appcompat-v7:28.0.0'
    compileOnly 'com.alibaba:fastjson:1.1.46.android'
    
    // 厂家 SDK（根据实际情况调整）
    implementation(name: 'uhfengine', ext: 'aar')
    // 如果是 jar 文件，改成：
    // implementation files('libs/uhfengine.jar')
}
```

------

### 第三步：编写插件代码（最重要！30分钟）

#### 3.1 创建 `RFIDModule.java`

在 `nativeplugins/YC-RFID/android/src/io/dcloud/RFID/RFIDModule.java`：

```java
package io.dcloud.RFID;

import android.media.AudioManager;
import android.media.SoundPool;
import com.alibaba.fastjson.JSONArray;
import com.alibaba.fastjson.JSONObject;
import io.dcloud.feature.uniapp.annotation.UniJSMethod;
import io.dcloud.feature.uniapp.bridge.UniJSCallback;
import io.dcloud.feature.uniapp.common.UniModule;

// 导入厂家 SDK（根据实际包名修改）
import com.uhf.api.cls.Reader;
import com.uhf.api.cls.Reader.READER_ERR;

public class RFIDModule extends UniModule {
    
    private Reader reader;
    private SoundPool soundPool;
    private int beepSoundId;
    private boolean isScanning = false;
    private Thread scanThread;
    
    /**
     * 初始化 RFID
     */
    @UniJSMethod(uiThread = false)
    public void init(JSONObject params, UniJSCallback callback) {
        try {
            // 1. 初始化音效
            soundPool = new SoundPool(1, AudioManager.STREAM_MUSIC, 0);
            // 注意：这里假设你有音效文件，如果没有就注释掉
            // beepSoundId = soundPool.load(mUniSDKInstance.getContext(), R.raw.beep, 1);
            
            // 2. 获取 Reader 实例（根据厂家文档修改）
            reader = Reader.getEngine();
            
            // 3. 连接设备
            READER_ERR err = reader.connectModule(
                "/dev/ttyMT1",  // 串口路径，根据实际设备修改
                Reader.IReaderConfig.READER_TYPE_UNKNOWN,
                1
            );
            
            // 4. 返回结果
            JSONObject result = new JSONObject();
            if (err == READER_ERR.MT_OK_ERR) {
                result.put("success", true);
                result.put("message", "初始化成功");
            } else {
                result.put("success", false);
                result.put("message", "初始化失败: " + err.toString());
            }
            callback.invoke(result);
            
        } catch (Exception e) {
            JSONObject result = new JSONObject();
            result.put("success", false);
            result.put("message", "异常: " + e.getMessage());
            callback.invoke(result);
        }
    }
    
    /**
     * 开始扫描标签（单次扫描）
     */
    @UniJSMethod(uiThread = false)
    public void scanOnce(JSONObject params, UniJSCallback callback) {
        try {
            if (reader == null) {
                JSONObject result = new JSONObject();
                result.put("success", false);
                result.put("message", "请先初始化");
                callback.invoke(result);
                return;
            }
            
            // 读取标签
            String[] tags = reader.inventoryRealTime();
            
            JSONObject result = new JSONObject();
            if (tags != null && tags.length > 0) {
                // 播放提示音
                if (soundPool != null && beepSoundId > 0) {
                    soundPool.play(beepSoundId, 1, 1, 0, 0, 1);
                }
                
                result.put("success", true);
                result.put("tags", new JSONArray(tags));
                result.put("count", tags.length);
            } else {
                result.put("success", false);
                result.put("message", "未读取到标签");
            }
            callback.invoke(result);
            
        } catch (Exception e) {
            JSONObject result = new JSONObject();
            result.put("success", false);
            result.put("message", "扫描异常: " + e.getMessage());
            callback.invoke(result);
        }
    }
    
    /**
     * 开始连续扫描（持续回调）
     */
    @UniJSMethod(uiThread = false)
    public void startScan(UniJSCallback callback) {
        if (isScanning) {
            JSONObject result = new JSONObject();
            result.put("success", false);
            result.put("message", "已在扫描中");
            callback.invoke(result);
            return;
        }
        
        isScanning = true;
        final UniJSCallback finalCallback = callback;
        
        scanThread = new Thread(new Runnable() {
            @Override
            public void run() {
                while (isScanning) {
                    try {
                        String[] tags = reader.inventoryRealTime();
                        
                        if (tags != null && tags.length > 0) {
                            // 播放提示音
                            if (soundPool != null && beepSoundId > 0) {
                                soundPool.play(beepSoundId, 1, 1, 0, 0, 1);
                            }
                            
                            JSONObject result = new JSONObject();
                            result.put("success", true);
                            result.put("tags", new JSONArray(tags));
                            result.put("count", tags.length);
                            
                            // 持续回调（重要！）
                            finalCallback.invokeAndKeepAlive(result);
                        }
                        
                        // 间隔 200ms
                        Thread.sleep(200);
                        
                    } catch (Exception e) {
                        JSONObject result = new JSONObject();
                        result.put("success", false);
                        result.put("message", e.getMessage());
                        finalCallback.invoke(result);
                        isScanning = false;
                        break;
                    }
                }
            }
        });
        scanThread.start();
    }
    
    /**
     * 停止扫描
     */
    @UniJSMethod(uiThread = false)
    public void stopScan(UniJSCallback callback) {
        isScanning = false;
        if (scanThread != null) {
            scanThread.interrupt();
        }
        
        JSONObject result = new JSONObject();
        result.put("success", true);
        result.put("message", "已停止扫描");
        callback.invoke(result);
    }
    
    /**
     * 设置功率
     */
    @UniJSMethod(uiThread = false)
    public void setPower(JSONObject params, UniJSCallback callback) {
        try {
            int power = params.getIntValue("power"); // 0-30
            
            boolean success = reader.setPower(power);
            
            JSONObject result = new JSONObject();
            result.put("success", success);
            result.put("message", success ? "功率设置成功" : "功率设置失败");
            callback.invoke(result);
            
        } catch (Exception e) {
            JSONObject result = new JSONObject();
            result.put("success", false);
            result.put("message", e.getMessage());
            callback.invoke(result);
        }
    }
    
    /**
     * 断开连接
     */
    @UniJSMethod(uiThread = false)
    public void disconnect(UniJSCallback callback) {
        try {
            isScanning = false;
            
            if (reader != null) {
                reader.closeModule();
            }
            
            if (soundPool != null) {
                soundPool.release();
                soundPool = null;
            }
            
            JSONObject result = new JSONObject();
            result.put("success", true);
            result.put("message", "断开成功");
            callback.invoke(result);
            
        } catch (Exception e) {
            JSONObject result = new JSONObject();
            result.put("success", false);
            result.put("message", e.getMessage());
            callback.invoke(result);
        }
    }
}
```

------

### 第四步：在 uni-app 中使用（10分钟）

#### 4.1 修改 `pages/index/index.vue`

```vue
<template>
  <view class="container">
    <view class="header">
      <text class="title">RFID 标签扫描</text>
    </view>
    
    <!-- 操作按钮 -->
    <view class="btn-group">
      <button type="primary" @click="initRFID">初始化</button>
      <button type="default" @click="scanOnce">单次扫描</button>
      <button type="warn" @click="startScan" :disabled="isScanning">开始连续扫描</button>
      <button type="default" @click="stopScan" :disabled="!isScanning">停止扫描</button>
    </view>
    
    <!-- 状态显示 -->
    <view class="status">
      <text>状态: {{ statusText }}</text>
      <text>已扫描: {{ tagList.length }} 个标签</text>
    </view>
    
    <!-- 标签列表 -->
    <view class="tag-list">
      <view v-for="(tag, index) in tagList" :key="index" class="tag-item">
        <text class="tag-num">{{ index + 1 }}</text>
        <text class="tag-epc">{{ tag }}</text>
      </view>
    </view>
  </view>
</template>

<script>
export default {
  data() {
    return {
      rfidModule: null,        // 插件实例
      isScanning: false,       // 是否正在扫描
      statusText: '未初始化',   // 状态文本
      tagList: []              // 标签列表
    }
  },
  
  onLoad() {
    // 引入原生插件
    this.rfidModule = uni.requireNativePlugin('YC-RFID');
  },
  
  onUnload() {
    // 页面卸载时断开连接
    if (this.rfidModule) {
      this.rfidModule.disconnect(() => {});
    }
  },
  
  methods: {
    // 初始化 RFID
    initRFID() {
      uni.showLoading({ title: '初始化中...' });
      
      this.rfidModule.init({}, (res) => {
        uni.hideLoading();
        
        if (res.success) {
          this.statusText = '初始化成功';
          uni.showToast({
            title: '初始化成功',
            icon: 'success'
          });
        } else {
          this.statusText = '初始化失败';
          uni.showToast({
            title: res.message,
            icon: 'none',
            duration: 3000
          });
        }
      });
    },
    
    // 单次扫描
    scanOnce() {
      if (this.statusText === '未初始化') {
        uni.showToast({
          title: '请先初始化',
          icon: 'none'
        });
        return;
      }
      
      this.statusText = '扫描中...';
      
      this.rfidModule.scanOnce({}, (res) => {
        if (res.success) {
          this.statusText = `扫描到 ${res.count} 个标签`;
          
          // 添加到列表（去重）
          res.tags.forEach(tag => {
            if (!this.tagList.includes(tag)) {
              this.tagList.push(tag);
            }
          });
          
          uni.showToast({
            title: `扫描到 ${res.count} 个标签`,
            icon: 'success'
          });
        } else {
          this.statusText = '未扫描到标签';
          uni.showToast({
            title: res.message,
            icon: 'none'
          });
        }
      });
    },
    
    // 开始连续扫描
    startScan() {
      if (this.statusText === '未初始化') {
        uni.showToast({
          title: '请先初始化',
          icon: 'none'
        });
        return;
      }
      
      this.isScanning = true;
      this.statusText = '连续扫描中...';
      this.tagList = []; // 清空列表
      
      // 持续回调
      this.rfidModule.startScan((res) => {
        if (res.success) {
          // 添加到列表（去重）
          res.tags.forEach(tag => {
            if (!this.tagList.includes(tag)) {
              this.tagList.push(tag);
            }
          });
          
          this.statusText = `已扫描 ${this.tagList.length} 个标签`;
        } else {
          // 扫描出错，自动停止
          this.isScanning = false;
          this.statusText = '扫描异常';
          uni.showToast({
            title: res.message,
            icon: 'none'
          });
        }
      });
    },
    
    // 停止扫描
    stopScan() {
      this.rfidModule.stopScan((res) => {
        this.isScanning = false;
        this.statusText = `扫描结束，共 ${this.tagList.length} 个标签`;
        
        uni.showToast({
          title: '已停止扫描',
          icon: 'success'
        });
      });
    }
  }
}
</script>

<style>
.container {
  padding: 20px;
}

.header {
  text-align: center;
  margin-bottom: 30px;
}

.title {
  font-size: 36rpx;
  font-weight: bold;
}

.btn-group {
  margin-bottom: 30px;
}

.btn-group button {
  margin: 10px 0;
}

.status {
  background: #f5f5f5;
  padding: 20px;
  border-radius: 10px;
  margin-bottom: 20px;
}

.status text {
  display: block;
  margin: 5px 0;
  font-size: 28rpx;
}

.tag-list {
  max-height: 800rpx;
  overflow-y: auto;
}

.tag-item {
  display: flex;
  align-items: center;
  padding: 15px;
  background: #fff;
  border: 1px solid #eee;
  border-radius: 8px;
  margin-bottom: 10px;
}

.tag-num {
  width: 60rpx;
  height: 60rpx;
  line-height: 60rpx;
  text-align: center;
  background: #007aff;
  color: #fff;
  border-radius: 50%;
  margin-right: 20rpx;
  font-size: 24rpx;
}

.tag-epc {
  flex: 1;
  font-family: monospace;
  font-size: 26rpx;
  word-break: break-all;
}
</style>
```

------

### 第五步：打包测试（20分钟）

#### 5.1 配置 manifest.json

在 HBuilderX 中打开 `manifest.json`，切换到 "App原生插件配置"：

```json
{
  "nativePlugins": {
    "YC-RFID": {
      "android": true
    }
  }
}
```

#### 5.2 制作自定义基座（重要！）

```
1. HBuilderX 菜单 → 运行 → 运行到手机或模拟器 → 制作自定义调试基座

2. 等待云端打包（5-10分钟）

3. 下载 APK 并安装到 RFID 设备上
```

#### 5.3 运行调试

```
1. 连接 RFID 设备到电脑（USB 调试模式）

2. HBuilderX → 运行 → 运行到手机或模拟器 → 运行到自定义基座

3. 开始测试功能
```

------

## 常见问题解决（必看！）

### ❌ 问题1：找不到厂家的类（ClassNotFoundException）

**原因：** SDK 包名不对或没有正确引入

**解决：**

```java
// 查看 .aar 文件内容
1. 将 uhfengine.aar 改为 uhfengine.zip
2. 解压后查看 classes.jar
3. 用 jadx 工具查看包名和类名
4. 修改 import 语句
```

------

### ❌ 问题2：插件调用没反应

**原因：** package.json 配置错误

**检查清单：**

```json
{
  "class": "io.dcloud.RFID.RFIDModule"  // ← 必须与 Java 包名一致
}
```

------

### ❌ 问题3：自定义基座打包失败

**解决方案：**

```
1. 检查 build.gradle 中的依赖是否正确
2. 确认 minSdkVersion 不低于厂家要求
3. 查看云端打包日志（HBuilderX 控制台）
```

------

### ❌ 问题4：真机上无法连接 RFID 模块

**检查项：**

```
1. 串口路径是否正确（常见：/dev/ttyMT1, /dev/ttyS1）
2. 是否有串口权限
3. 厂家 SDK 是否需要特定初始化参数
```

**解决：** 联系厂家获取正确的连接参数

------

## 快速验证方案

如果上面步骤太复杂，你可以先用**最简单的方式**验证：

### 极简版插件（只测试能否调用）

```java
package io.dcloud.RFID;

import com.alibaba.fastjson.JSONObject;
import io.dcloud.feature.uniapp.annotation.UniJSMethod;
import io.dcloud.feature.uniapp.bridge.UniJSCallback;
import io.dcloud.feature.uniapp.common.UniModule;

public class RFIDModule extends UniModule {
    
    @UniJSMethod
    public void test(JSONObject params, UniJSCallback callback) {
        JSONObject result = new JSONObject();
        result.put("success", true);
        result.put("message", "插件调用成功！");
        callback.invoke(result);
    }
}
```

**测试代码：**

```javascript
const rfid = uni.requireNativePlugin('YC-RFID');
rfid.test({}, (res) => {
  console.log(res); // 输出: {success: true, message: "插件调用成功！"}
});
```



# 没成功   问厂家！！！！反正思想是这样的！！！！

![img](17.厂家SDK集成到uniapp.assets/647f7e900cacbe19c5dfb489f905f0e5.gif)



