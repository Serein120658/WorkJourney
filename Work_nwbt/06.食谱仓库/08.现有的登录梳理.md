# ç™»å½•ç³»ç»Ÿé€»è¾‘æ·±åº¦åˆ†ææ–‡æ¡£

## å‰è¨€

é’ˆå¯¹ å½“å‰æ¶æ„çš„ `app.vue`    `globaldata.js`   `start.vue`   `login.vue`

è¿™ç¯‡æ–‡æ¡£ä¸»è¦æ˜¯è§£å†³è¿™ä¸¤æ¬¡é‡åˆ°çš„é—®é¢˜

## ä¸€ã€é¡¹ç›®æ¶æ„å…¨æ™¯è§£æ

### 1.1 æ ¸å¿ƒæ–‡ä»¶èŒè´£çŸ©é˜µ

| æ–‡ä»¶            | ä»£ç è¡Œæ•° | æ ¸å¿ƒèŒè´£                                 | å…³é”®ä¾èµ–                     |
| --------------- | -------- | ---------------------------------------- | ---------------------------- |
| `globaldata.js` | 35è¡Œ     | ç¯å¢ƒé…ç½®ä¸­å¿ƒ                             | process.env                  |
| `App.vue`       | 600+è¡Œ   | åº”ç”¨ç”Ÿå‘½å‘¨æœŸã€å…¨å±€çŠ¶æ€ç®¡ç†ã€ç½‘ç»œè¯·æ±‚å°è£… | moment.js, ase.js, smutil.js |
| `start.vue`     | 70è¡Œ     | å¯åŠ¨é¡µ/åœºæ™¯è·¯ç”±åˆ†å‘                      | App.globalData               |
| `login.vue`     | 500+è¡Œ   | å¤šæ¨¡å¼ç™»å½•UI + ä¸šåŠ¡é€»è¾‘                  | verify.vue, uqrcode.vue      |

### 1.2 ç¯å¢ƒé…ç½®è¯¦è§£ (globaldata.js)

```javascript
// å¼€å‘ç¯å¢ƒ (å½“å‰ä½¿ç”¨)
var dev = {
    ossPrefix: 'https://btkjtest.oss-cn-beijing.aliyuncs.com/',
    requrl: 'http://192.168.1.37:8078',  // ğŸ‘ˆ ä½ çš„æœ¬åœ°IP
    updir: 'appuid',
    xcxtype: 'appuid',                   // å°ç¨‹åºç±»å‹æ ‡è¯†
    env_version: "develop"
}

// æµ‹è¯•ç¯å¢ƒ
var test = {
    requrl: 'https://testuniuid.bt-z.com',
    xcxtype: 'xcxuid',
    env_version: "trial"
}

// ç”Ÿäº§ç¯å¢ƒ
var prod = {
    requrl: 'https://uniuid.bt-z.com',
    xcxtype: 'xcxuid',
    env_version: "release"
}

// ç¯å¢ƒé€‰æ‹©é€»è¾‘
global = process.env.ENV_TYPE === 'test' ? test : 
         (process.env.NODE_ENV === 'development' ? dev : prod);
```

**ç¯å¢ƒåˆ‡æ¢æœºåˆ¶**:

- `process.env.NODE_ENV === 'development'` â†’ dev
- `process.env.ENV_TYPE === 'test'` â†’ test
- å…¶ä»– â†’ prod

------

## äºŒã€App.vue ç™»å½•ä½“ç³»å®Œæ•´è§£æ

### 2.1 åº”ç”¨å¯åŠ¨å®Œæ•´æµç¨‹å›¾

```mermaid
graph TD
    A[App.vue onLaunch] --> B[checkUpdate æ£€æŸ¥å°ç¨‹åºæ›´æ–°]
    B --> C[åˆå§‹åŒ– globalData]
    C --> D[æ³¨å†Œå…¨å±€æ–¹æ³• uni.sm/smactionç­‰]
    D --> E[è¯»å–æœ¬åœ°å­˜å‚¨]
    E --> F{Tokenå­˜åœ¨?}
    
    F -->|æ˜¯| G[loginByToken å°è¯•Tokenç™»å½•]
    F -->|å¦| H[è·³è¿‡Tokenç™»å½•]
    
    G --> I{Tokenæœ‰æ•ˆ?}
    I -->|æœ‰æ•ˆ| J[getUserInfoBack ä¿å­˜ç”¨æˆ·ä¿¡æ¯]
    I -->|æ— æ•ˆ| K[æ‰§è¡Œå¹³å°ç™»å½•]
    
    H --> K
    K --> L{å¹³å°åˆ¤æ–­}
    
    L -->|å¾®ä¿¡å°ç¨‹åº| M[uni.login è·å–code]
    M --> N[applogin logintype=loginBycode]
    
    L -->|å…¶ä»–å¹³å°| O[ä½¿ç”¨æœ¬åœ°openid]
    O --> P[applogin logintype=loginByopenid]
    
    N --> Q{ç™»å½•æˆåŠŸ?}
    P --> Q
    
    Q -->|æˆåŠŸ| J
    Q -->|å¤±è´¥| R[è·³è½¬ç™»å½•é¡µ]
    
    J --> S[è®¾ç½® waitlogin=false]
    S --> T[è§¦å‘ userInfoReadyCallback]
    T --> U[start.vue åˆå§‹åŒ–]
```

### 2.2 ç™»å½•æ–¹æ³•çŸ©é˜µ (App.vue æ ¸å¿ƒ)

#### 2.2.1 `loginByToken` - Tokenè‡ªåŠ¨ç™»å½• (ç¬¬111-125è¡Œ)

```javascript
loginByToken(token, cb) {
    if (token) {
        var param = {
            zhtype: _this.globalData.xcxtype,  // 'appuid' æˆ– 'xcxuid'
            logintype: "autologin",
            token: token
        }
        _this.globalData.applogin(param, null, cb);
    } else {
        cb && cb();  // æ— tokenç›´æ¥æ‰§è¡Œå›è°ƒ
    }
}
```

**è§¦å‘æ—¶æœº**: åº”ç”¨å¯åŠ¨æ—¶ (onLaunch ç¬¬57è¡Œ)
 **å‚æ•°æ¥æº**: `uni.getStorageSync('token')`
 **æˆåŠŸæ ‡å¿—**: è¿”å›ç”¨æˆ·ä¿¡æ¯å¹¶æ›´æ–° `globalData.objuserinfo`
 **å¤±è´¥å¤„ç†**: æ‰§è¡Œå›è°ƒ `cb`,è¿›å…¥å¹³å°ç‰¹å®šç™»å½•æµç¨‹

------

#### 2.2.2 `applogin` - ç»Ÿä¸€ç™»å½•å…¥å£ (ç¬¬151-178è¡Œ)

```javascript
applogin: function(param, succb, errcb) {
    var pobj = {
        route: uni.svs.auth,           // æœåŠ¡è·¯ç”± (ä» services é…ç½®)
        action: 'login/applogin',      // æ§åˆ¶å™¨è·¯å¾„
        method: 'POST',
        datastring: true               // ğŸ‘ˆ å‚æ•°ä¼šè¢« JSON.stringify
    }
    
    this.smaction((re, err, obj) => {
        uni.hideLoading();
        
        if (err) {
            // ç™»å½•å¤±è´¥å¤„ç†
            if (obj.sid) {
                // å³ä½¿å¤±è´¥ä¹Ÿä¿å­˜ session
                _this.globalData.headers['Cookie'] = 'JSESSIONID=' + obj.sid;
            }
            
            // Tokenç™»å½•å¤±è´¥ä¸”æœ‰ errcb â†’ ç»§ç»­å…¶ä»–ç™»å½•æ–¹å¼
            if (param.logintype == "autologin" && errcb) {
                errcb();  // å›åˆ° onLaunch ç»§ç»­å¾®ä¿¡/openidç™»å½•
            } else {
                // å…¶ä»–ç™»å½•å¤±è´¥ â†’ è·³è½¬ç™»å½•é¡µ
                console.log('æœªç™»å½•:', obj);
                if (getCurrentPages()[0].route != 'pages/login/login') {
                    setTimeout(function() {
                        uni.reLaunch({
                            url: "/pages/login/login"
                        })
                    }, 1000)
                }
            }
        } else {
            // ç™»å½•æˆåŠŸ
            _this.globalData.getUserInfoBack(re);
            succb && succb();
        }
    }, param, pobj)
}
```

**å…³é”®ç‰¹æ€§**:

1. **å‚æ•°åºåˆ—åŒ–**: `datastring: true` å¯¼è‡´ `param` ä¼šè¢«è½¬ä¸º JSON å­—ç¬¦ä¸²
2. **Sessionç®¡ç†**: å¤±è´¥æ—¶ä¹Ÿä¼šä¿å­˜ `JSESSIONID`
3. **é”™è¯¯åˆ†æµ**: Tokenç™»å½•å¤±è´¥ä¸è·³è½¬,å…¶ä»–ç™»å½•å¤±è´¥è·³ç™»å½•é¡µ
4. **å›è°ƒé“¾**: `succb` æˆåŠŸå›è°ƒ, `errcb` å¤±è´¥å›è°ƒ

------

#### 2.2.3 `getUserInfoBack` - ç™»å½•æˆåŠŸå¤„ç† (ç¬¬127-149è¡Œ)

```javascript
getUserInfoBack: function(obj) {
    console.log(obj);
    if (obj && obj.sid) {
        // 1. ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
        uni.setStorageSync('curmobile', obj.objuser.mobile);
        uni.setStorageSync('token', obj.token);
        if (obj.openid || obj.objuser.openid_xcx) {
            uni.setStorageSync('curopenid', obj.openid || obj.objuser.openid_xcx);
        }
        
        // 2. è®¾ç½®è¯·æ±‚å¤´
        _this.globalData.headers['Cookie'] = 'JSESSIONID=' + obj.sid;
        
        // 3. ä¿å­˜ç”¨æˆ·ä¿¡æ¯åˆ°å…¨å±€
        _this.globalData.objuserinfo = obj.objuser;
        _this.globalData.code = obj.code;
        
        console.log("objuserinfo", _this.globalData.objuserinfo);
        
        // 4. æ ‡è®°ç™»å½•å®Œæˆ
        _this.globalData.waitlogin = false;
        
        // 5. è§¦å‘å›è°ƒ (start.vue åœ¨ç­‰å¾…)
        if (_this.globalData.userInfoReadyCallback) {
            _this.globalData.userInfoReadyCallback();
            _this.globalData.userInfoReadyCallback = null;
        }
    } else {
        // é™é»˜å¤±è´¥,ä¸æç¤º
    }
}
```

**æ•°æ®æµè½¬**:

```
åç«¯å“åº” obj
â”œâ”€ obj.sid â†’ Cookie Header
â”œâ”€ obj.token â†’ localStorage
â”œâ”€ obj.objuser.mobile â†’ localStorage
â”œâ”€ obj.objuser â†’ globalData.objuserinfo
â””â”€ obj.code â†’ globalData.code
```

------

#### 2.2.4 `sm` / `smaction` - åŒè½¨è¯·æ±‚ç³»ç»Ÿ

##### A. `sm` æ–¹æ³• (ç¬¬251-335è¡Œ) - ä¼ ç»Ÿå‚æ•°ç¼–ç æ–¹å¼

```javascript
sm: function(cb, arr, pobj) {
    // å‚æ•°å®¹é”™å¤„ç†
    if (typeof cb == 'object') {
        var arrtemp = cb;
        cb = arr;
        arr = arrtemp;
    }
    
    // å‚æ•°ç¼–ç é€»è¾‘
    var strp = '';
    var ismul = 0;  // æ˜¯å¦å¤šæ¶ˆæ¯
    var msgid = '';
    
    if (typeof arr[0] == 'object') {
        // å¤šæ¶ˆæ¯æ¨¡å¼: [[msg1, p1, p2], [msg2, p3]]
        ismul = 1;
        var arr2 = [];
        for (var i = 0; i < arr.length; i++) {
            for (var j = 0; j < arr[i].length; j++) {
                if (typeof arr[i][j] == 'object') {
                    arr[i][j] = JSON.stringify(arr[i][j]);
                }
            }
            // %15 åˆ†éš”å‚æ•°, %18 åˆ†éš”æ¶ˆæ¯
            arr2.push(smutil.encodeArr(arr[i]).join('%15'));
        }
        strp = arr2.join('%18');
    } else {
        // å•æ¶ˆæ¯æ¨¡å¼: [msgid, p1, p2, ...]
        for (var j = 0; j < arr.length; j++) {
            if (typeof arr[j] == 'object') {
                arr[j] = JSON.stringify(arr[j]);
            }
        }
        msgid = arr[0];
        strp = smutil.encodeArr(arr).join('%15');
    }
    
    // æ„å»ºè¯·æ±‚æ•°æ®
    var data = {
        "isspChar": 1,  // ç‰¹æ®Šå­—ç¬¦æ ‡è®°
        arr: strp,
        lan: 'zh'
    };
    
    if (ismul) data.ismul = ismul;
    data.msgid = (pobj && pobj.msgid) || msgid || '';
    if (pobj && pobj.trans) data.trans = pobj.trans;
    if (pobj && pobj.rpc) data.rpc = pobj.rpc;
    
    // æ·»åŠ  Token
    var token = uni.getStorageSync('token');
    if (token) {
        data.Authorization = 'Bearer ' + token;
    }
    
    // å‘èµ·è¯·æ±‚
    var url = '/Enter';
    if (pobj && pobj.route) {
        url = '/' + pobj.route + url;
    }
    
    uni.request({
        url: _this.globalData.geturl(pobj.route || "", "Enter"),
        data: data,
        header: _this.globalData.headers,
        success: function(res) {
            // å“åº”è§£æ (åŒ smaction)
        }
    });
}
```

**ä½¿ç”¨åœºæ™¯ç¤ºä¾‹**:

```javascript
// å•æ¶ˆæ¯
uni.sm((re, err) => {
    console.log(re);
}, ['user.getInfo', userId], { route: 'bzn-xcx-tbpt' });

// å¤šæ¶ˆæ¯
uni.sm((re, err) => {
    console.log(re);
}, [
    ['user.getInfo', userId],
    ['order.list', pageNum]
], { route: 'bzn-xcx-tbpt', ismul: 1 });
```

##### B. `smaction` æ–¹æ³• (ç¬¬180-249è¡Œ) - RESTfulé£æ ¼

```javascript
smaction: function(cb, param, pobj) {
    // å‚æ•°å®¹é”™
    if (typeof cb == 'object') {
        var arrtemp = cb;
        cb = param;
        param = arrtemp;
    }
    
    if (!pobj || !pobj.action) {
        return cb(null, 'è·¯ç”±ä¸èƒ½ä¸ºç©º');
    }
    
    // æ·»åŠ  Token åˆ°å‚æ•°
    var token = uni.getStorageSync('token');
    if (token) {
        param.Authorization = 'Bearer ' + token;
    }
    
    var url = '/' + pobj.route + '/' + pobj.action;
    
    uni.request({
        url: _this.globalData.geturl(pobj.route || "", pobj.action),
        method: pobj.method || "GET",
        data: pobj.datastring ? JSON.stringify(param) : param,
        header: _this.globalData.headers,
        
        success: function(res) {
            if (res.data) {
                // æ–°ç‰ˆå“åº”æ ¼å¼ (å¸¦ code)
                if (res.data.code) {
                    var result = res.data && res.data.data ? 
                                 JSON.parse(res.data.data) : {};
                    if (res.data.code == 200) {
                        return cb(result || res.data.msg, null, result || res.data.msg);
                    } else {
                        return cb(null, res.data.msg, result);
                    }
                }
                
                // æ—§ç‰ˆå“åº”æ ¼å¼
                var strtype = Object.prototype.toString.apply(res.data.data);
                if (strtype == '[object Array]') {
                    cb(res.data);
                } else if (strtype == '[object Object]') {
                    if (res.data.error || res.data.code == 500) {
                        if (res.data.error == "nologin") {
                            return uni.navigateTo({
                                url: "/pages/login/login"
                            })
                        }
                        cb(res.data, res.data.error || res.data.msg, res.data);
                    } else {
                        cb(res.data.re || res.data, res.data.error, res.data);
                    }
                } else {
                    cb(null, res.data.error || res.data.msg, res.data);
                }
            } else {
                cb(null, 'è¯·æ±‚å¤±è´¥');
            }
        },
        fail: function(res) {
            cb(null, 'è¯·æ±‚å¤±è´¥');
        }
    });
}
```

**å¯¹æ¯”è¡¨**:

| ç‰¹æ€§     | sm                     | smaction            |
| -------- | ---------------------- | ------------------- |
| å‚æ•°æ ¼å¼ | æ•°ç»„ `[msgid, p1, p2]` | å¯¹è±¡ `{key: value}` |
| ç¼–ç æ–¹å¼ | è‡ªå®šä¹‰ `%15/%18` åˆ†éš”  | æ ‡å‡† JSON           |
| URL      | `/Enter`               | `/{route}/{action}` |
| é€‚ç”¨åœºæ™¯ | è€ç³»ç»Ÿå…¼å®¹             | ç°ä»£RESTful API     |
| åç«¯è¦æ±‚ | éœ€è¦è§£æç‰¹æ®Šç¼–ç        | æ ‡å‡†Controller      |

------

### 2.3 å®Œæ•´ç™»å½•æµç¨‹æ—¶åºå›¾

```mermaid
sequenceDiagram
    participant U as ç”¨æˆ·
    participant App as App.vue
    participant Start as start.vue
    participant Login as login.vue
    participant Backend as åç«¯æœåŠ¡
    participant Storage as æœ¬åœ°å­˜å‚¨

    Note over App: åº”ç”¨å¯åŠ¨
    App->>Storage: è¯»å– token
    Storage-->>App: è¿”å› token (å¯èƒ½ä¸ºç©º)
    
    alt Tokenå­˜åœ¨
        App->>Backend: loginByToken(token)
        Backend-->>App: TokenéªŒè¯ç»“æœ
        
        alt Tokenæœ‰æ•ˆ
            App->>Storage: ä¿å­˜ç”¨æˆ·ä¿¡æ¯
            App->>Start: userInfoReadyCallback()
            Start->>Start: init() åˆ¤æ–­åœºæ™¯
        else Tokenå¤±æ•ˆ
            App->>App: æ‰§è¡Œ errcb å›è°ƒ
            App->>Backend: å¾®ä¿¡codeç™»å½•/openidç™»å½•
        end
    else Tokenä¸å­˜åœ¨
        App->>Backend: å¾®ä¿¡codeç™»å½•/openidç™»å½•
        Backend-->>App: è¿”å›ç”¨æˆ·ä¿¡æ¯
        App->>Storage: ä¿å­˜ token
    end
    
    alt ç™»å½•å¤±è´¥
        App->>Login: è·³è½¬ç™»å½•é¡µ
        U->>Login: é€‰æ‹©ç™»å½•æ–¹å¼
        
        alt è´¦å·å¯†ç ç™»å½•
            U->>Login: è¾“å…¥æ‰‹æœºå·+å¯†ç 
            Login->>Backend: loginByPassword
        else éªŒè¯ç ç™»å½•
            U->>Login: è¾“å…¥æ‰‹æœºå·
            Login->>Backend: è·å–éªŒè¯ç 
            U->>Login: è¾“å…¥éªŒè¯ç 
            Login->>Backend: loginByVcode
        else æ‰«ç ç™»å½•
            Login->>Backend: è·å–äºŒç»´ç 
            Backend-->>Login: è¿”å›äºŒç»´ç æ•°æ®
            Login->>Login: å¼€å§‹è½®è¯¢
            U->>Login: æ‰‹æœºæ‰«ç ç¡®è®¤
            Login->>Backend: è½®è¯¢çŠ¶æ€
            Backend-->>Login: å·²ç¡®è®¤+token
        end
        
        Backend-->>Login: ç™»å½•æˆåŠŸ
        Login->>Storage: ä¿å­˜token
        Login->>App: applogin æˆåŠŸå›è°ƒ
        App->>Storage: getUserInfoBack
    end
    
    Note over Start: å¯åŠ¨é¡µé€»è¾‘
    Start->>Start: åˆ¤æ–­åœºæ™¯å‚æ•°
    
    alt æ‰«ç è¿›å…¥ (sceneå­˜åœ¨)
        Start->>Start: è§£æ qrcodeuserid
        Start->>Start: reLaunch home/index
    else æ­£å¸¸å¯åŠ¨
        Start->>Start: å»¶è¿Ÿ 1000ms
        Start->>Start: reLaunch erweima/index
    end
```

------

## ä¸‰ã€start.vue å¯åŠ¨é¡µæ·±åº¦è§£æ

### 3.1 æ ¸å¿ƒé€»è¾‘ (onLoad ç¬¬25-36è¡Œ)

```javascript
onLoad: function(params) {
    this.params = params;
    console.log("-----------", params);
    
    // å…³é”®åˆ¤æ–­: æ˜¯å¦ç­‰å¾…ç™»å½•å®Œæˆ
    if (app.globalData.waitlogin) {
        // ç™»å½•æœªå®Œæˆ â†’ æ³¨å†Œå›è°ƒ,ç­‰å¾… App.vue å®Œæˆç™»å½•
        app.globalData.userInfoReadyCallback = this.init;
    } else {
        // ç™»å½•å·²å®Œæˆ â†’ ç›´æ¥æ‰§è¡Œåœºæ™¯åˆ¤æ–­
        this.init();
    }
}
```

### 3.2 åœºæ™¯è·¯ç”±é€»è¾‘æµç¨‹å›¾

```mermaid
graph TD
    A[start.vue onLoad] --> B{waitlogin?}
    B -->|true| C[æ³¨å†Œ userInfoReadyCallback]
    B -->|false| D[ç›´æ¥æ‰§è¡Œ init]
    
    C --> E[ç­‰å¾… App.vue ç™»å½•å®Œæˆ]
    E --> F[App è°ƒç”¨ callback]
    F --> D
    
    D --> G[è·å–å¯åŠ¨åœºæ™¯ scene]
    G --> H{scene && params.scene?}
    
    H -->|æ˜¯| I[æ‰«ç åœºæ™¯]
    I --> J[è§£æ params.scene]
    J --> K[split '-' åˆ†å‰²]
    K --> L[qrcodeuserid = arrscene0]
    L --> M{arrscene.length > 1?}
    M -->|æ˜¯| N[qrcodegiftcode = arrscene1]
    M -->|å¦| O[qrcodegiftcode = ç©º]
    N --> P[reLaunch home/index?qrcodeuserid=X&qrcodegiftcode=Y]
    O --> P
    
    H -->|å¦| Q[æ­£å¸¸å¯åŠ¨]
    Q --> R[setTimeout 1000ms]
    R --> S[reLaunch erweima/index]
```

### 3.3 æ‰«ç åœºæ™¯å‚æ•°è§£æç¤ºä¾‹

**åœºæ™¯1: å¸¦ç¤¼å“ç çš„ç­¾åˆ°äºŒç»´ç **

```
å°ç¨‹åºç å‚æ•°: scene=123456-GIFT2025
è§£æç»“æœ:
  qrcodeuserid: "123456"
  qrcodegiftcode: "GIFT2025"
è·³è½¬: /pages/tabBar/home/index?qrcodeuserid=123456&qrcodegiftcode=GIFT2025
```

**åœºæ™¯2: æ™®é€šç­¾åˆ°äºŒç»´ç **

```
å°ç¨‹åºç å‚æ•°: scene=789012
è§£æç»“æœ:
  qrcodeuserid: "789012"
  qrcodegiftcode: ""
è·³è½¬: /pages/tabBar/home/index?qrcodeuserid=789012&qrcodegiftcode=
```

**åœºæ™¯3: æ­£å¸¸å¯åŠ¨**

```
æ—  scene å‚æ•°
å»¶è¿Ÿ 1 ç§’åè·³è½¬: /pages/tabBar/erweima/index
```

------

## å››ã€login.vue å¤šæ¨¡å¼ç™»å½•è¯¦è§£

### 4.1 ç™»å½•æ¨¡å¼æ¶æ„

```javascript
tabs: [
    { name: 'è´¦å·ç™»å½•', type: 'account' },
    // { name: 'äººè„¸ç™»å½•', type: 'face' },      // å·²æ³¨é‡Š
    { name: 'æ‰«ç ç™»å½•', type: 'qrcode' },
    // { name: 'éªŒè¯ç ç™»å½•', type: 'vcode' }     // å·²æ³¨é‡Š
]
```

**å½“å‰å¯ç”¨æ¨¡å¼**:

1. âœ… è´¦å·ç™»å½• (account)
2. âœ… æ‰«ç ç™»å½• (qrcode)
3. âŒ äººè„¸ç™»å½• (face) - UIä¿ç•™ä½†æœªå¯ç”¨
4. âŒ éªŒè¯ç ç™»å½• (vcode) - UIä¿ç•™ä½†æœªå¯ç”¨

### 4.2 è´¦å·å¯†ç ç™»å½•å®Œæ•´æµç¨‹

```mermaid
sequenceDiagram
    participant U as ç”¨æˆ·
    participant UI as login.vue
    participant Validate as è¡¨å•éªŒè¯
    participant App as App.globalData
    participant Backend as åç«¯

    U->>UI: è¾“å…¥æ‰‹æœºå·
    U->>UI: è¾“å…¥å¯†ç 
    U->>UI: ç‚¹å‡»ç™»å½•
    
    UI->>Validate: æ£€æŸ¥æ‰‹æœºå·æ˜¯å¦ä¸ºç©º
    alt æ‰‹æœºå·ä¸ºç©º
        Validate-->>U: æç¤º"è¯·è¾“å…¥æ‰‹æœºå·"
    else æ‰‹æœºå·æ ¼å¼é”™è¯¯
        Validate->>Validate: validatePhone()
        Validate-->>U: æç¤º"è¯·è¾“å…¥æ­£ç¡®çš„æ‰‹æœºå·"
    else å¯†ç ä¸ºç©º
        Validate-->>U: æç¤º"è¯·è¾“å…¥å¯†ç "
    else å¯†ç é•¿åº¦<6
        Validate-->>U: æç¤º"å¯†ç é•¿åº¦ä¸èƒ½å°‘äº6ä½"
    else éªŒè¯é€šè¿‡
        UI->>UI: showLoading("ç™»å½•ä¸­...")
        UI->>App: applogin(param)
        
        Note over App: æ„å»ºç™»å½•å‚æ•°
        App->>Backend: POST /login/applogin
        Note right of Backend: {<br/>zhtype: 'appuid',<br/>logintype: 'loginByPassword',<br/>mobile: '13800138000',<br/>password: '123456'<br/>}
        
        Backend-->>App: è¿”å›ç»“æœ
        
        alt ç™»å½•æˆåŠŸ
            App->>App: getUserInfoBack(re)
            App->>UI: æ‰§è¡ŒæˆåŠŸå›è°ƒ
            UI->>UI: hideLoading()
            UI->>UI: loginCallback()
            UI->>UI: reLaunch /pages/tabBar/rfidbind/index
        else ç™»å½•å¤±è´¥
            App-->>UI: é”™è¯¯ä¿¡æ¯
            UI->>UI: hideLoading()
            UI-->>U: æ˜¾ç¤ºé”™è¯¯æç¤º
        end
    end
```

**å…³é”®ä»£ç ** (login.vue ç¬¬216-248è¡Œ):

```javascript
handleAccountLogin() {
    const { phone, password } = this.accountLogin;

    // 1. è¡¨å•éªŒè¯
    if (!phone) {
        return uni.showToast({ title: 'è¯·è¾“å…¥æ‰‹æœºå·', icon: 'none' });
    }

    if (!this.validatePhone(phone)) {
        return uni.showToast({ title: 'è¯·è¾“å…¥æ­£ç¡®çš„æ‰‹æœºå·', icon: 'none' });
    }

    if (!password) {
        return uni.showToast({ title: 'è¯·è¾“å…¥å¯†ç ', icon: 'none' });
    }

    if (password.length < 6) {
        return uni.showToast({ title: 'å¯†ç é•¿åº¦ä¸èƒ½å°‘äº6ä½', icon: 'none' });
    }

    uni.showLoading({ title: 'ç™»å½•ä¸­...' });

    // 2. æ„å»ºç™»å½•å‚æ•°
    const param = {
        zhtype: app.globalData.xcxtype,  // 'appuid'
        logintype: "loginByPassword",
        mobile: phone,
        password: password
    };

    // 3. è°ƒç”¨ç»Ÿä¸€ç™»å½•
    app.globalData.applogin(param, () => {
        uni.hideLoading();
        this.loginCallback();  // è·³è½¬åˆ° rfidbind/index
    });
}
```

**æ‰‹æœºå·éªŒè¯è§„åˆ™** (ç¬¬455-458è¡Œ):

```javascript
validatePhone(phone) {
    const reg = /^1(3[0-9]|4[01456879]|5[0-35-9]|6[2567]|7[0-8]|8[0-9]|9[0-35-9])\d{8}$/;
    return phone.length === 11 && reg.test(phone);
}
```

æ”¯æŒçš„å·æ®µ:

- 13x, 14[01456879], 15[0-35-9]
- 16[2567], 17[0-8], 18x, 19[0-35-9]

------

### 4.3 äºŒç»´ç ç™»å½•ç°æœ‰å®ç°åˆ†æ

#### 4.3.1 æ•°æ®ç»“æ„ (ç¬¬129-140è¡Œ)

```javascript
qrcodeLogin: {
    content: '',                    // äºŒç»´ç å†…å®¹
    size: 260,                      // äºŒç»´ç å°ºå¯¸ (rpx)
    timestamp: '',                  // æ˜¾ç¤ºçš„æ—¶é—´æˆ³æ–‡æœ¬
    timer: null,                    // å®šæ—¶åˆ·æ–°è®¡æ—¶å™¨
    refreshInterval: 1 * 60 * 1000, // åˆ·æ–°é—´éš” 60ç§’
    options: {
        margin: 10,
        background: '#ffffff',
        foreground: '#000000',
    }
}
```

#### 4.3.2 äºŒç»´ç ç”Ÿæˆé€»è¾‘ (ç¬¬269-279è¡Œ)

```javascript
generateQrcode() {
    const timestamp = new Date().getTime();
    const virtualUnionId = "88888888888888";  // ğŸ‘ˆ ç¡¬ç¼–ç è™šæ‹ŸID
    const qrcodeData = virtualUnionId + timestamp;

    this.qrcodeLogin.content = qrcodeData;
    this.qrcodeLogin.timestamp = moment(timestamp).format("YYYYå¹´MMæœˆDDæ—¥ HH:mm:ss");

    console.log('äºŒç»´ç å†…å®¹å·²æ›´æ–°:', this.qrcodeLogin.content);
}
```

**é—®é¢˜åˆ†æ**:

1. âŒ **æ— åç«¯äº¤äº’**: äºŒç»´ç å†…å®¹å®Œå…¨ç”±å‰ç«¯ç”Ÿæˆ
2. âŒ **æ— çŠ¶æ€è½®è¯¢**: ç”Ÿæˆåæ— æ³•çŸ¥é“æ˜¯å¦è¢«æ‰«æ
3. âŒ **æ— éªŒè¯æœºåˆ¶**: è™šæ‹ŸIDæ— æ³•ä¸çœŸå®ç”¨æˆ·å…³è”
4. âš ï¸ **ä»…ä¸ºUIæ¼”ç¤º**: å½“å‰å®ç°ä¸å…·å¤‡å®é™…ç™»å½•åŠŸèƒ½

#### 4.3.3 å®šæ—¶åˆ·æ–°æœºåˆ¶

```javascript
// å¯åŠ¨å®šæ—¶å™¨ (ç¬¬281-287è¡Œ)
startQrcodeTimer() {
    this.clearQrcodeTimer();
    this.qrcodeLogin.timer = setInterval(() => {
        this.generateQrcode();  // æ¯60ç§’é‡æ–°ç”Ÿæˆ
    }, this.qrcodeLogin.refreshInterval);
}

// Tabåˆ‡æ¢æ—¶çš„åˆå§‹åŒ– (ç¬¬196-206è¡Œ)
switchTab(index) {
    this.currentTab = index;

    if (this.tabs[index].type === 'qrcode') {
        this.$nextTick(() => {
            this.initQrcode();  // ç”ŸæˆäºŒç»´ç å¹¶å¯åŠ¨å®šæ—¶å™¨
        });
    } else {
        this.clearQrcodeTimer();  // åˆ‡èµ°æ—¶æ¸…ç†å®šæ—¶å™¨
    }
}
```

------

### 4.4 éªŒè¯ç ç™»å½•æµç¨‹ (å·²æ³¨é‡Šä½†é€»è¾‘å®Œæ•´)

```mermaid
sequenceDiagram
    participant U as ç”¨æˆ·
    participant UI as login.vue
    participant Verify as éªŒè¯ç»„ä»¶
    participant Backend as åç«¯

    U->>UI: è¾“å…¥æ‰‹æœºå·
    UI->>UI: handlePhoneInput()
    UI->>UI: å¯ç”¨"è·å–éªŒè¯ç "æŒ‰é’®
    
    U->>UI: ç‚¹å‡»"è·å–éªŒè¯ç "
    UI->>Verify: show() æ˜¾ç¤ºæ»‘å—éªŒè¯
    U->>Verify: å®Œæˆæ»‘å—éªŒè¯
    Verify->>UI: onVerifySuccess(captchaVerification)
    
    UI->>Backend: POST login/loginsendvcode
    Note right of Backend: {<br/>mobile: '13800138000',<br/>captchaVerification: 'xxx'<br/>}
    
    Backend-->>UI: å‘é€æˆåŠŸ
    UI->>UI: startVcodeCountdown() å¼€å§‹å€’è®¡æ—¶
    UI->>UI: æŒ‰é’®æ˜¾ç¤º "300 ç§’"
    
    loop æ¯ç§’é€’å‡
        UI->>UI: countdown--
        alt countdown <= 0
            UI->>UI: æ¢å¤æŒ‰é’® "è·å–éªŒè¯ç "
        end
    end
    
    U->>UI: è¾“å…¥éªŒè¯ç 
    U->>UI: å‹¾é€‰æœåŠ¡åè®®
    U->>UI: ç‚¹å‡»"ç«‹å³ç™»å½•"
    
    UI->>Backend: applogin loginByVcode
    Backend-->>UI: ç™»å½•æˆåŠŸ
    UI->>UI: loginCallback()
```

**å…³é”®ä»£ç ** (ç¬¬425-438è¡Œ):

```javascript
handleVcodeLogin() {
    if (!this.vcodeLogin.agreed) {
        return uni.msg("è¯·å…ˆå‹¾é€‰åè®®");
    }

    if (!this.validatePhone(this.vcodeLogin.phone)) {
        return uni.msg("è¯·è¾“å…¥æ­£ç¡®çš„æ‰‹æœºå·");
    }
    
    if (!this.vcodeLogin.code) {
        return uni.msg("è¯·è¾“å…¥æ­£ç¡®çš„éªŒè¯ç ");
    }

    uni.showLoading({ title: 'ç™»å½•ä¸­...' });

    const param = {
        zhtype: app.globalData.xcxtype,
        logintype: "loginByVcode",
        mobile: this.vcodeLogin.phone,
        vcode: this.vcodeLogin.code
    };

    app.globalData.applogin(param, () => {
        uni.hideLoading();
        this.loginCallback();
    });
}

```

**éªŒè¯ç å€’è®¡æ—¶é€»è¾‘** (ç¬¬390-408è¡Œ):

```javascript
startVcodeCountdown() {
    this.clearVcodeTimer();
    this.vcodeLogin.btnDisabled = true;

    this.vcodeLogin.timer = setInterval(() => {
        this.vcodeLogin.countdown--;
        this.vcodeLogin.btnText = this.vcodeLogin.countdown + ' ç§’';

        if (this.vcodeLogin.countdown <= 0) {
            this.clearVcodeTimer();
            this.vcodeLogin.btnDisabled = false;
            this.vcodeLogin.btnText = "è·å–éªŒè¯ç ";
            this.vcodeLogin.countdown = 300;  // é‡ç½®ä¸º300ç§’
        }
    }, 1000);
}
```

------

## äº”ã€åœºæ™¯é—®é¢˜å®Œæ•´è§£å†³æ–¹æ¡ˆ

### 5.1 åœºæ™¯1: è·³è¿‡å¯åŠ¨é¡µçš„4ç§æ–¹æ¡ˆ

#### æ–¹æ¡ˆA: ä¿®æ”¹å¯åŠ¨å»¶è¿Ÿ (æœ€ç®€å•) â­â­â­â­â­

**ä¿®æ”¹ä½ç½®**: `start.vue` ç¬¬56-62è¡Œ

```javascript
// åŸä»£ç 
setTimeout(function() {
    uni.reLaunch({
        url: "/pages/tabBar/erweima/index"
    })
}, 1000)

// æ–¹æ¡ˆ1: ç›´æ¥ç§»é™¤å»¶è¿Ÿ
uni.reLaunch({
    url: "/pages/tabBar/erweima/index"
})

// æ–¹æ¡ˆ2: ç¼©çŸ­å»¶è¿Ÿè‡³100ms
setTimeout(function() {
    uni.reLaunch({
        url: "/pages/tabBar/erweima/index"
    })
}, 100)
```

**ä¼˜ç‚¹**:

- ä»£ç æ”¹åŠ¨æœ€å°
- ä¿ç•™å¯åŠ¨é¡µé€»è¾‘ç”¨äºæ‰«ç åœºæ™¯
- å¼€å‘è°ƒè¯•æ—¶å¿«é€Ÿè¿›å…¥

**ç¼ºç‚¹**:

- å¯åŠ¨é¡µUIä¼šé—ªç°

------

#### æ–¹æ¡ˆB: ä¿®æ”¹ç›®æ ‡é¡µé¢ (ä¿ç•™å¯åŠ¨é¡µ) â­â­â­â­

**ä¿®æ”¹ä½ç½®**: `start.vue` ç¬¬56-62è¡Œ

```javascript
setTimeout(function() {
    uni.reLaunch({
        url: "/pages/tabBar/home/index"  // ğŸ‘ˆ æ”¹ä¸ºä½ æƒ³è¦çš„é¦–é¡µ
    })
}, 100)  // å»ºè®®ç¼©çŸ­å»¶è¿Ÿ
```

**é€‚ç”¨åœºæ™¯**:

- æ”¹å˜é»˜è®¤é¦–é¡µè·¯å¾„
- ä¿ç•™å¯åŠ¨é¡µç”¨äºå¤„ç†æ‰«ç ç­‰ç‰¹æ®Šåœºæ™¯

------

#### æ–¹æ¡ˆC: pages.json é…ç½®æ³• (å½»åº•ç§»é™¤) â­â­â­

**ä¿®æ”¹ä½ç½®**: `pages.json`

```json
{
  "pages": [
    // æ–¹æ³•1: æ³¨é‡Šæ‰å¯åŠ¨é¡µ
    // {
    //   "path": "pages/start/start",
    //   "style": {
    //     "navigationBarTitleText": "å¯åŠ¨é¡µ"
    //   }
    // },
    
    // æ–¹æ³•2: å°†é¦–é¡µç§»åˆ°ç¬¬ä¸€ä½
    {
      "path": "pages/tabBar/home/index",  // ğŸ‘ˆ åº”ç”¨å¯åŠ¨æ—¶ä¼šè¿›å…¥ç¬¬ä¸€ä¸ªé¡µé¢
      "style": {
        "navigationBarTitleText": "é¦–é¡µ"
      }
    },
    {
      "path": "pages/start/start",
      "style": {
        "navigationBarTitleText": "å¯åŠ¨é¡µ"
      }
    }
  ]
}
```

**å½±å“**:

- âš ï¸ **æ‰«ç åœºæ™¯å¤±æ•ˆ**: `start.vue` çš„æ‰«ç è§£æé€»è¾‘å°†æ— æ³•æ‰§è¡Œ
- âš ï¸ **éœ€è¦è¿ç§»é€»è¾‘**: éœ€å°†æ‰«ç å¤„ç†ç§»è‡³æ–°é¦–é¡µçš„ `onLoad`

------

#### æ–¹æ¡ˆD: æ¡ä»¶è·³è¿‡æ³• (æœ€çµæ´») â­â­â­â­â­

**ä¿®æ”¹ä½ç½®**: `start.vue` ç¬¬43-67è¡Œ

```javascript
init() {
    var scene = 0;
    
    // #ifdef MP-WEIXIN
    var options = wx.getLaunchOptionsSync();
    console.log(options);
    scene = options.scene;
    // #endif
    
    var qrcodeuserid = "";
    var qrcodegiftcode = "";
    
    // ğŸ‘‡ æ–°å¢: å¼€å‘ç¯å¢ƒåˆ¤æ–­
    var isDev = app.globalData.env_version === 'develop';
    
    if (scene && this.params.scene) { 
        // æ‰«ç è¿›å…¥åœºæ™¯ (ä¿æŒåŸé€»è¾‘)
        var arrscene = this.params.scene.split('-');
        qrcodeuserid = arrscene[0];
        if (arrscene.length > 1) {
            qrcodegiftcode = arrscene[1];
        }
        uni.reLaunch({
            url: "/pages/tabBar/home/index?qrcodeuserid=" + qrcodeuserid + 
                 "&qrcodegiftcode=" + qrcodegiftcode
        });
    } else { 
        // æ­£å¸¸å¯åŠ¨åœºæ™¯
        if (isDev) {
            // ğŸ‘ˆ å¼€å‘ç¯å¢ƒ: ç«‹å³è·³è½¬,æ— å»¶è¿Ÿ
            uni.reLaunch({
                url: "/pages/tabBar/home/index"
            });
        } else {
            // ç”Ÿäº§ç¯å¢ƒ: ä¿ç•™å»¶è¿Ÿ,å±•ç¤ºå“ç‰Œ
            setTimeout(function() {
                uni.reLaunch({
                    url: "/pages/tabBar/home/index"
                });
            }, 1000);
        }
    }
}
```

**ä¼˜ç‚¹**:

- âœ… å¼€å‘ç¯å¢ƒå¿«é€Ÿè·³è¿‡
- âœ… ç”Ÿäº§ç¯å¢ƒä¿ç•™å“ç‰Œå±•ç¤º
- âœ… æ‰«ç åœºæ™¯ä¸å—å½±å“
- âœ… å¯é€šè¿‡é…ç½®æ–‡ä»¶æ§åˆ¶

**è¿›é˜¶ç‰ˆ: ä½¿ç”¨é…ç½®æ–‡ä»¶**

åœ¨ `globaldata.js` ä¸­æ·»åŠ :

```javascript
var dev = {
    // ...å…¶ä»–é…ç½®
    skipStartPage: true,        // ğŸ‘ˆ æ–°å¢é…ç½®é¡¹
    startPageDelay: 0           // å¯åŠ¨é¡µå»¶è¿Ÿ(ms)
}

var prod = {
    // ...å…¶ä»–é…ç½®
    skipStartPage: false,
    startPageDelay: 1000
}
```

åœ¨ `start.vue` ä¸­ä½¿ç”¨:

```javascript
init() {
    // ...å‰é¢ä»£ç ä¸å˜
    
    if (scene && this.params.scene) { 
        // æ‰«ç é€»è¾‘...
    } else {
        var delay = app.globalData.skipStartPage ? 
                    0 : app.globalData.startPageDelay;
        
        setTimeout(function() {
            uni.reLaunch({
                url: "/pages/tabBar/home/index"
            });
        }, delay);
    }
}
```

------

### 5.2 åœºæ™¯2: åŒäº‹è®¿é—®ä½ çš„æœ¬åœ°æ¥å£

#### å½“å‰é…ç½®åˆ†æ

```javascript
// globaldata.js ç¬¬2-7è¡Œ
var dev = {
    ossPrefix: 'https://btkjtest.oss-cn-beijing.aliyuncs.com/',
    requrl: 'http://192.168.1.37:8078',  // ğŸ‘ˆ ä½ å½“å‰çš„IP
    updir: 'appuid',
    xcxtype: 'appuid',
    env_version: "develop"
}
```

#### å®Œæ•´è§£å†³æ­¥éª¤

##### æ­¥éª¤1: ç¡®è®¤ä½ çš„å®é™…IPåœ°å€

**Windowsç³»ç»Ÿ**:

```bash
# æ–¹æ³•1: CMD
ipconfig

# è¾“å‡ºç¤ºä¾‹
æ— çº¿å±€åŸŸç½‘é€‚é…å™¨ WLAN:
   IPv4 åœ°å€ . . . . . . . . : 192.168.1.100  ğŸ‘ˆ è¿™ä¸ªæ˜¯ä½ çš„IP
   å­ç½‘æ©ç   . . . . . . . . : 255.255.255.0
   é»˜è®¤ç½‘å…³. . . . . . . . . : 192.168.1.1

# æ–¹æ³•2: PowerShell
Get-NetIPAddress -AddressFamily IPv4 | Where-Object {$_.InterfaceAlias -like "*WLAN*"}
```

**Mac/Linuxç³»ç»Ÿ**:

```bash
# æ–¹æ³•1
ifconfig | grep "inet " | grep -v 127.0.0.1

# æ–¹æ³•2
ip addr show | grep "inet " | grep -v 127.0.0.1

# è¾“å‡ºç¤ºä¾‹
inet 192.168.1.100/24 brd 192.168.1.255 scope global dynamic en0
```

##### æ­¥éª¤2: æ£€æŸ¥åç«¯æœåŠ¡ç›‘å¬åœ°å€

**é—®é¢˜è¯Šæ–­**:

```bash
# æ£€æŸ¥ç«¯å£ç›‘å¬æƒ…å†µ
# Windows
netstat -ano | findstr "8078"

# Mac/Linux
lsof -i :8078
# æˆ–
netstat -tulpn | grep 8078
```

**è¾“å‡ºè§£è¯»**:

```bash
# âŒ é”™è¯¯ç¤ºä¾‹ (ä»…ç›‘å¬ localhost)
TCP    127.0.0.1:8078    0.0.0.0:0    LISTENING

# âœ… æ­£ç¡®ç¤ºä¾‹ (ç›‘å¬æ‰€æœ‰ç½‘å¡)
TCP    0.0.0.0:8078      0.0.0.0:0    LISTENING
TCP    [::]:8078         [::]:0       LISTENING
```

**ä¿®æ­£æ–¹æ³•**:

æ ¹æ®ä½ çš„åç«¯æ¡†æ¶ä¿®æ”¹å¯åŠ¨é…ç½®:

```javascript
// Node.js (Express/Koa)
app.listen(8078, '0.0.0.0', () => {  // ğŸ‘ˆ ä¸è¦å†™ 'localhost'
    console.log('Server running on 0.0.0.0:8078');
});

// Java Spring Boot (application.yml)
server:
  address: 0.0.0.0  # ğŸ‘ˆ æˆ–ç›´æ¥åˆ é™¤æ­¤è¡Œ,é»˜è®¤å°±æ˜¯ 0.0.0.0
  port: 8078

// Python Flask
app.run(host='0.0.0.0', port=8078)  # ğŸ‘ˆ é»˜è®¤æ˜¯ 127.0.0.1

// .NET Core (Program.cs)
builder.WebHost.UseUrls("http://0.0.0.0:8078");  // ğŸ‘ˆ æˆ– http://*:8078
```

##### æ­¥éª¤3: ä¿®æ”¹ globaldata.js

```javascript
var dev = {
    ossPrefix: 'https://btkjtest.oss-cn-beijing.aliyuncs.com/',
    requrl: 'http://192.168.1.100:8078',  // ğŸ‘ˆ æ”¹ä¸ºä½ çš„å®é™…IP
    updir: 'appuid',
    xcxtype: 'appuid',
    env_version: "develop"
}
```

##### æ­¥éª¤4: éªŒè¯ç½‘ç»œè¿é€šæ€§

**åœ¨ä½ çš„ç”µè„‘ä¸Š**:

```bash
# æµ‹è¯•åç«¯æœåŠ¡æ˜¯å¦æ­£å¸¸
curl http://localhost:8078/health
# æˆ–ç”¨æµè§ˆå™¨è®¿é—® http://localhost:8078

# æµ‹è¯•æ˜¯å¦å¯é€šè¿‡IPè®¿é—®
curl http://192.168.1.100:8078/health
```

**åœ¨åŒäº‹ç”µè„‘ä¸Š**:

```bash
# 1. æµ‹è¯•ç½‘ç»œè¿é€šæ€§
ping 192.168.1.100

# 2. æµ‹è¯•ç«¯å£æ˜¯å¦å¼€æ”¾
# Windows (éœ€è¦å®‰è£… telnet å®¢æˆ·ç«¯)
telnet 192.168.1.100 8078

# Mac/Linux
nc -zv 192.168.1.100 8078
# æˆ–
telnet 192.168.1.100 8078

# 3. æµ‹è¯•HTTPæ¥å£
curl http://192.168.1.100:8078/health
# æˆ–ç”¨æµè§ˆå™¨è®¿é—®
```

**é¢„æœŸç»“æœ**:

```bash
# ping æˆåŠŸ
æ­£åœ¨ Ping 192.168.1.100 å…·æœ‰ 32 å­—èŠ‚çš„æ•°æ®:
æ¥è‡ª 192.168.1.100 çš„å›å¤: å­—èŠ‚=32 æ—¶é—´<1ms TTL=64

# telnet æˆåŠŸ
Trying 192.168.1.100...
Connected to 192.168.1.100.

# curl æˆåŠŸ
{"status": "ok", "message": "Service is running"}
```

##### æ­¥éª¤5: é˜²ç«å¢™é…ç½®

**Windowsé˜²ç«å¢™**:

```powershell
# æ–¹æ³•1: ä¸´æ—¶å…³é—­é˜²ç«å¢™ (ä¸æ¨è)
# æ§åˆ¶é¢æ¿ â†’ Windows Defender é˜²ç«å¢™ â†’ å¯ç”¨æˆ–å…³é—­ Windows Defender é˜²ç«å¢™

# æ–¹æ³•2: æ·»åŠ å…¥ç«™è§„åˆ™ (æ¨è)
# 1. Win + R è¾“å…¥ wf.msc
# 2. å…¥ç«™è§„åˆ™ â†’ æ–°å»ºè§„åˆ™
# 3. ç«¯å£ â†’ TCP â†’ ç‰¹å®šæœ¬åœ°ç«¯å£ â†’ 8078
# 4. å…è®¸è¿æ¥ â†’ æ‰€æœ‰é…ç½®æ–‡ä»¶ â†’ å‘½åä¸º "å¼€å‘æœåŠ¡å™¨8078"

# æ–¹æ³•3: PowerShellå‘½ä»¤
New-NetFirewallRule -DisplayName "Dev Server 8078" -Direction Inbound -LocalPort 8078 -Protocol TCP -Action Allow
```

**Macé˜²ç«å¢™**:

```bash
# 1. ç³»ç»Ÿåå¥½è®¾ç½® â†’ å®‰å…¨æ€§ä¸éšç§ â†’ é˜²ç«å¢™
# 2. ç‚¹å‡»é”å›¾æ ‡è§£é”
# 3. é˜²ç«å¢™é€‰é¡¹ â†’ æ·»åŠ ä½ çš„åç«¯è¿›ç¨‹

# æˆ–ä½¿ç”¨å‘½ä»¤ (éœ€è¦sudo)
sudo /usr/libexec/ApplicationFirewall/socketfilterfw --add /path/to/your/app
sudo /usr/libexec/ApplicationFirewall/socketfilterfw --unblockapp /path/to/your/app
```

**Linuxé˜²ç«å¢™**:

```bash
# UFW (Ubuntu)
sudo ufw allow 8078/tcp
sudo ufw reload

# firewalld (CentOS/RHEL)
sudo firewall-cmd --zone=public --add-port=8078/tcp --permanent
sudo firewall-cmd --reload

# iptables
sudo iptables -A INPUT -p tcp --dport 8078 -j ACCEPT
sudo iptables-save
```

##### æ­¥éª¤6: åŒäº‹ç«¯é…ç½®

**æ–¹æ³•A: åŒäº‹ä¹Ÿä¿®æ”¹ globaldata.js**

```javascript
// åŒäº‹çš„ globaldata.js
var dev = {
    requrl: 'http://192.168.1.100:8078',  // ğŸ‘ˆ æ”¹ä¸ºä½ çš„IP
    // ...å…¶ä»–é…ç½®
}
```

**æ–¹æ³•B: ä½¿ç”¨ç¯å¢ƒå˜é‡ (æ¨èå›¢é˜Ÿåä½œ)**

ä¿®æ”¹ `globaldata.js`:

```javascript
var dev = {
    ossPrefix: 'https://btkjtest.oss-cn-beijing.aliyuncs.com/',
    // ğŸ‘‡ ä»ç¯å¢ƒå˜é‡è¯»å–,fallbackåˆ°é»˜è®¤å€¼
    requrl: process.env.VUE_APP_API_URL || 'http://192.168.1.37:8078',
    updir: 'appuid',
    xcxtype: 'appuid',
    env_version: "develop"
}
```

æ¯ä¸ªäººåˆ›å»ºè‡ªå·±çš„ `.env.local` æ–‡ä»¶ (ä¸æäº¤åˆ°git):

```bash
# ä½ çš„ .env.local
VUE_APP_API_URL=http://192.168.1.100:8078

# åŒäº‹çš„ .env.local
VUE_APP_API_URL=http://192.168.1.100:8078

# å¦ä¸€ä¸ªåŒäº‹è¿è¡Œè‡ªå·±çš„åç«¯
VUE_APP_API_URL=http://192.168.1.200:8078
```

åœ¨ `.gitignore` ä¸­æ·»åŠ :

```
.env.local
.env.*.local
```

------

#### å¸¸è§é—®é¢˜æ’æŸ¥

**é—®é¢˜1: pingé€šä½†curlå¤±è´¥**

```bash
# å¯èƒ½åŸå› 
1. é˜²ç«å¢™é˜»æ­¢äº†8078ç«¯å£
2. åç«¯ç›‘å¬äº† 127.0.0.1 è€Œé 0.0.0.0
3. åç«¯æœåŠ¡æœªå¯åŠ¨

# è§£å†³æ–¹æ³•
netstat -ano | findstr "8078"  # æ£€æŸ¥ç«¯å£çŠ¶æ€
```

**é—®é¢˜2: å¶å°”èƒ½è®¿é—®,å¶å°”è¶…æ—¶**

```bash
# å¯èƒ½åŸå› 
1. ä½ çš„ç”µè„‘IPåŠ¨æ€å˜åŒ– (DHCP)
2. ç½‘ç»œä¸ç¨³å®š
3. åç«¯è¿›ç¨‹å´©æºƒé‡å¯

# è§£å†³æ–¹æ³• - è®¾ç½®é™æ€IP
# Windows: æ§åˆ¶é¢æ¿ â†’ ç½‘ç»œé€‚é…å™¨ â†’ IPv4å±æ€§ â†’ ä½¿ç”¨ä¸‹é¢çš„IPåœ°å€
# Mac: ç³»ç»Ÿåå¥½è®¾ç½® â†’ ç½‘ç»œ â†’ é«˜çº§ â†’ TCP/IP â†’ é…ç½®IPv4: æ‰‹åŠ¨
```

**é—®é¢˜3: å¾®ä¿¡å°ç¨‹åºæ— æ³•è®¿é—®å±€åŸŸç½‘IP**

```bash
# å¾®ä¿¡å°ç¨‹åºé™åˆ¶
1. çœŸæœºè°ƒè¯•æ—¶,requeståŸŸåå¿…é¡»åœ¨ç™½åå•
2. çº¿ä¸Šç‰ˆæœ¬ä¸å…è®¸è®¿é—® IP åœ°å€,å¿…é¡»ç”¨åŸŸå

# è§£å†³æ–¹æ³•
# 1. å¼€å‘é˜¶æ®µ: ä½¿ç”¨å¾®ä¿¡å¼€å‘è€…å·¥å…·,å‹¾é€‰"ä¸æ ¡éªŒåˆæ³•åŸŸå"
# 2. ç”Ÿäº§é˜¶æ®µ: ä½¿ç”¨å†…ç½‘ç©¿é€å·¥å…·
```

------

#### å†…ç½‘ç©¿é€æ–¹æ¡ˆ (å¯é€‰)

å¦‚æœéœ€è¦è®©å¤–ç½‘æˆ–å¾®ä¿¡å°ç¨‹åºçœŸæœºè®¿é—®:

```bash
# æ–¹æ¡ˆ1: ngrok (å›½å¤–)
ngrok http 8078
# ä¼šç”Ÿæˆç±»ä¼¼ https://abc123.ngrok.io çš„ä¸´æ—¶åŸŸå

# æ–¹æ¡ˆ2: frp (å›½å†…,éœ€è¦è‡ªå·±çš„æœåŠ¡å™¨)
# é…ç½®è¾ƒå¤æ‚,é€‚åˆé•¿æœŸä½¿ç”¨

# æ–¹æ¡ˆ3: natapp (å›½å†…,å…è´¹æœ‰é™åˆ¶)
./natapp -authtoken=ä½ çš„token

# æ–¹æ¡ˆ4: èŠ±ç”Ÿå£³ (ä»˜è´¹)
# GUIå·¥å…·,æ“ä½œç®€å•
```

ä½¿ç”¨åä¿®æ”¹ `globaldata.js`:

```javascript
var dev = {
    requrl: 'https://abc123.ngrok.io',  // ğŸ‘ˆ ä½¿ç”¨ç©¿é€åçš„åŸŸå
    // ...
}
```

------

### 5.3 åœºæ™¯3: æ”¹é€ äºŒç»´ç æ‰«ç ç™»å½•

#### ç°çŠ¶åˆ†æ

**å½“å‰ä»£ç é—®é¢˜** (login.vue ç¬¬269-279è¡Œ):

```javascript
generateQrcode() {
    const timestamp = new Date().getTime();
    const virtualUnionId = "88888888888888";  // âŒ ç¡¬ç¼–ç è™šæ‹ŸID
    const qrcodeData = virtualUnionId + timestamp;  // âŒ æ— ä¸šåŠ¡æ„ä¹‰

    this.qrcodeLogin.content = qrcodeData;  // âŒ æ— æ³•è¢«åç«¯è¯†åˆ«
    this.qrcodeLogin.timestamp = moment(timestamp).format("YYYYå¹´MMæœˆDDæ—¥ HH:mm:ss");
}
```

**ç¼ºå¤±çš„åŠŸèƒ½**:

1. âŒ åç«¯äºŒç»´ç ç”Ÿæˆæ¥å£
2. âŒ äºŒç»´ç çŠ¶æ€è½®è¯¢æœºåˆ¶
3. âŒ æ‰‹æœºç«¯æ‰«ç ç¡®è®¤é¡µé¢
4. âŒ ç™»å½•æˆåŠŸå›è°ƒå¤„ç†

------

#### å®Œæ•´æ”¹é€ æ–¹æ¡ˆ

##### é˜¶æ®µ1: åç«¯æ¥å£è®¾è®¡

ä½ éœ€è¦åç«¯æä¾›3ä¸ªæ¥å£:

```javascript
/**
 * æ¥å£1: ç”Ÿæˆç™»å½•äºŒç»´ç 
 * GET /api/qrcode/generate
 */
{
    "code": 200,
    "data": {
        "qrcodeId": "QR_20251219_abc123",     // äºŒç»´ç å”¯ä¸€æ ‡è¯†
        "qrcodeUrl": "weixin://dl/scan/QR_20251219_abc123",  // å°ç¨‹åºæ‰«ç è·³è½¬URL
        "appId": "wx1234567890",              // å°ç¨‹åºAppID (ä»åç«¯è·å–)
        "appSecret": "secret_abc123",         // ğŸ‘ˆ æ³¨æ„:ä¸åº”è¿”å›ç»™å‰ç«¯,ä»…åç«¯ä½¿ç”¨
        "timestamp": 1702999999000,           // ç”Ÿæˆæ—¶é—´æˆ³
        "expireTime": 300,                    // æœ‰æ•ˆæœŸ(ç§’)
        "status": "waiting"                   // åˆå§‹çŠ¶æ€
    },
    "msg": "ç”ŸæˆæˆåŠŸ"
}

/**
 * æ¥å£2: è½®è¯¢äºŒç»´ç çŠ¶æ€
 * GET /api/qrcode/check?qrcodeId=QR_20251219_abc123
 */
{
    "code": 200,
    "data": {
        "qrcodeId": "QR_20251219_abc123",
        "status": "waiting",    // waiting | scanned | confirmed | expired | cancelled
        "token": null,          // confirmedçŠ¶æ€æ—¶è¿”å›
        "userInfo": null        // confirmedçŠ¶æ€æ—¶è¿”å›
    }
}

// çŠ¶æ€å˜åŒ–ç¤ºä¾‹
// 1. åˆå§‹: {"status": "waiting"}
// 2. æ‰«ç : {"status": "scanned", "mobile": "138****8000"}
// 3. ç¡®è®¤: {"status": "confirmed", "token": "eyJhbG...", "userInfo": {...}}
// 4. è¿‡æœŸ: {"status": "expired"}

/**
 * æ¥å£3: æ‰‹æœºç«¯ç¡®è®¤ç™»å½•
 * POST /api/qrcode/confirm
 */
Request:
{
    "qrcodeId": "QR_20251219_abc123",
    "userToken": "å½“å‰ç”¨æˆ·çš„token"  // ä»æ‰‹æœºç«¯æœ¬åœ°å­˜å‚¨è·å–
}

Response:
{
    "code": 200,
    "data": {
        "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6...",  // æ–°çš„ç™»å½•token
        "userInfo": {
            "id": 12345,
            "mobile": "13800138000",
            "nickname": "å¼ ä¸‰",
            "avatar": "https://..."
        }
    },
    "msg": "ç¡®è®¤æˆåŠŸ"
}
```

**åç«¯å®ç°è¦ç‚¹ æ‰«ç åç»­å¤„ç†**:

```javascript
// ä¼ªä»£ç ç¤ºä¾‹ (Node.js)
// 1. ç”ŸæˆäºŒç»´ç 
app.get('/api/qrcode/generate', async (req, res) => {
    const qrcodeId = `QR_${Date.now()}_${generateRandomString(6)}`;
    
    // å­˜å‚¨åˆ°Redis,è®¾ç½®è¿‡æœŸæ—¶é—´
    await redis.setex(
        `qrcode:${qrcodeId}`,
        300,  // 5åˆ†é’Ÿè¿‡æœŸ
        JSON.stringify({
            status: 'waiting',
            createTime: Date.now()
        })
    );
    
    // æ„å»ºå°ç¨‹åºè·³è½¬URL
    const qrcodeUrl = `weixin://dl/scan/${qrcodeId}`;  // æˆ–ä½¿ç”¨å°ç¨‹åºç 
    
    res.json({
        code: 200,
        data: {
            qrcodeId,
            qrcodeUrl,
            appId: process.env.WECHAT_APP_ID,  // ä»ç¯å¢ƒå˜é‡è¯»å–
            timestamp: Date.now(),
            expireTime: 300,
            status: 'waiting'
        }
    });
});

// 2. è½®è¯¢çŠ¶æ€
app.get('/api/qrcode/check', async (req, res) => {
    const { qrcodeId } = req.query;
    
    const data = await redis.get(`qrcode:${qrcodeId}`);
    if (!data) {
        return res.json({
            code: 200,
            data: { status: 'expired' }
        });
    }
    
    const qrcodeData = JSON.parse(data);
    res.json({
        code: 200,
        data: {
            qrcodeId,
            status: qrcodeData.status,
            token: qrcodeData.token || null,
            userInfo: qrcodeData.userInfo || null
        }
    });
});

// 3. æ‰‹æœºç«¯ç¡®è®¤
app.post('/api/qrcode/confirm', async (req, res) => {
    const { qrcodeId, userToken } = req.body;
    
    // éªŒè¯ç”¨æˆ·token
    const user = await verifyToken(userToken);
    if (!user) {
        return res.json({ code: 401, msg: 'æœªç™»å½•' });
    }
    
    // ç”Ÿæˆæ–°çš„ç™»å½•token (ç”¨äºPCç«¯)
    const newToken = generateToken(user.id);
    
    // æ›´æ–°äºŒç»´ç çŠ¶æ€
    await redis.setex(
        `qrcode:${qrcodeId}`,
        60,  // ç¡®è®¤å60ç§’å†…PCç«¯éœ€å–èµ°token
        JSON.stringify({
            status: 'confirmed',
            token: newToken,
            userInfo: {
                id: user.id,
                mobile: user.mobile,
                nickname: user.nickname
            }
        })
    );
    
    res.json({
        code: 200,
        data: {
            token: newToken,
            userInfo: user
        },
        msg: 'ç¡®è®¤æˆåŠŸ'
    });
});
```

------

##### é˜¶æ®µ2: å‰ç«¯ login.vue æ”¹é€ 

**ç¬¬1æ­¥: ä¿®æ”¹æ•°æ®ç»“æ„**

```javascript
// login.vue data() ä¸­ä¿®æ”¹ (ç¬¬129-140è¡Œ)
qrcodeLogin: {
    qrcodeId: '',                // ğŸ‘ˆ æ–°å¢: äºŒç»´ç å”¯ä¸€æ ‡è¯†
    appId: '',                   // ğŸ‘ˆ æ–°å¢: å°ç¨‹åºAppID
    content: '',                 // äºŒç»´ç å†…å®¹URL
    size: 260,
    timestamp: '',
    timer: null,                 // å®šæ—¶åˆ·æ–°è®¡æ—¶å™¨
    pollingTimer: null,          // ğŸ‘ˆ æ–°å¢: è½®è¯¢è®¡æ—¶å™¨
    refreshInterval: 1 * 60 * 1000,  // åˆ·æ–°é—´éš”
    pollingInterval: 2000,       // ğŸ‘ˆ æ–°å¢: è½®è¯¢é—´éš”2ç§’
    expireTime: 300,             // ğŸ‘ˆ æ–°å¢: æœ‰æ•ˆæœŸ
    status: 'waiting',           // ğŸ‘ˆ æ–°å¢: å½“å‰çŠ¶æ€
    options: {
        margin: 10,
        background: '#ffffff',
        foreground: '#000000',
    }
}
```

**ç¬¬2æ­¥: é‡å†™äºŒç»´ç ç”Ÿæˆæ–¹æ³•**

```javascript
// æ›¿æ¢åŸ generateQrcode æ–¹æ³• (ç¬¬269-279è¡Œ)
async generateQrcodeFromBackend() {
    try {
        uni.showLoading({ title: 'ç”ŸæˆäºŒç»´ç ä¸­...' });
        
        // è°ƒç”¨åç«¯æ¥å£ç”ŸæˆäºŒç»´ç 
        const app = getApp();
        app.globalData.smaction(
            (re, err, obj) => {
                uni.hideLoading();
                
                if (err) {
                    console.error('ç”ŸæˆäºŒç»´ç å¤±è´¥:', err);
                    uni.showToast({ 
                        title: err || 'ç”Ÿæˆå¤±è´¥,è¯·é‡è¯•', 
                        icon: 'none' 
                    });
                    return;
                }
                
                // æ›´æ–°äºŒç»´ç æ•°æ®
                this.qrcodeLogin.qrcodeId = re.qrcodeId;
                this.qrcodeLogin.appId = re.appId;
                this.qrcodeLogin.content = re.qrcodeUrl;  // ğŸ‘ˆ ä½¿ç”¨åç«¯è¿”å›çš„URL
                this.qrcodeLogin.timestamp = moment(re.timestamp)
                    .format("YYYYå¹´MMæœˆDDæ—¥ HH:mm:ss");
                this.qrcodeLogin.expireTime = re.expireTime;
                this.qrcodeLogin.status = 'waiting';
                
                console.log('äºŒç»´ç ç”ŸæˆæˆåŠŸ:', {
                    id: this.qrcodeLogin.qrcodeId,
                    url: this.qrcodeLogin.content
                });
                
                // ç”ŸæˆæˆåŠŸåç«‹å³å¼€å§‹è½®è¯¢
                this.startQrcodePolling();
            },
            {},  // GETè¯·æ±‚æ— bodyå‚æ•°
            {
                route: uni.svs.auth,          // ä½¿ç”¨ç»Ÿä¸€çš„authè·¯ç”±
                action: 'api/qrcode/generate',  // æ§åˆ¶å™¨è·¯å¾„
                method: 'GET'
            }
        );
        
    } catch (error) {
        uni.hideLoading();
        console.error('ç”ŸæˆäºŒç»´ç å¼‚å¸¸:', error);
        uni.showToast({ title: 'ç½‘ç»œå¼‚å¸¸', icon: 'none' });
    }
}
```

**ç¬¬3æ­¥: æ–°å¢çŠ¶æ€è½®è¯¢æ–¹æ³•**

```javascript
// åœ¨ methods ä¸­æ–°å¢ (å»ºè®®æ”¾åœ¨ç¬¬300è¡Œå·¦å³)
startQrcodePolling() {
    console.log('å¼€å§‹è½®è¯¢äºŒç»´ç çŠ¶æ€');
    
    // å…ˆæ¸…é™¤æ—§çš„è½®è¯¢
    this.clearQrcodePolling();
    
    const app = getApp();
    
    // ç«‹å³æ‰§è¡Œä¸€æ¬¡
    this.checkQrcodeStatus();
    
    // è®¾ç½®å®šæ—¶è½®è¯¢ (æ¯2ç§’)
    this.qrcodeLogin.pollingTimer = setInterval(() => {
        this.checkQrcodeStatus();
    }, this.qrcodeLogin.pollingInterval);
},

checkQrcodeStatus() {
    const app = getApp();
    
    app.globalData.smaction(
        (re, err, obj) => {
            if (err) {
                console.error('è½®è¯¢å¤±è´¥:', err);
                // è½®è¯¢å¤±è´¥ä¸æç¤º,é™é»˜å¤„ç†
                return;
            }
            
            const prevStatus = this.qrcodeLogin.status;
            this.qrcodeLogin.status = re.status;
            
            // çŠ¶æ€å˜åŒ–æ—¶æ‰“å°æ—¥å¿—
            if (prevStatus !== re.status) {
                console.log(`äºŒç»´ç çŠ¶æ€å˜åŒ–: ${prevStatus} â†’ ${re.status}`);
            }
            
            switch(re.status) {
                case 'waiting':
                    // ç­‰å¾…æ‰«ç  - ç»§ç»­è½®è¯¢
                    break;
                    
                case 'scanned':
                    // å·²æ‰«ç å¾…ç¡®è®¤
                    if (prevStatus === 'waiting') {
                        uni.showToast({ 
                            title: 'å·²æ‰«ç ,è¯·åœ¨æ‰‹æœºä¸Šç¡®è®¤ç™»å½•', 
                            icon: 'none',
                                                        duration: 3000
                        });
                    }
                    break;
                    
                case 'confirmed':
                    // ç¡®è®¤æˆåŠŸ - æ‰§è¡Œç™»å½•
                    this.handleQrcodeLoginSuccess(re.token, re.userInfo);
                    break;
                    
                case 'expired':
                    // äºŒç»´ç è¿‡æœŸ - åœæ­¢è½®è¯¢å¹¶æç¤º
                    this.clearQrcodePolling();
                    uni.showToast({ 
                        title: 'äºŒç»´ç å·²è¿‡æœŸ,è¯·ç‚¹å‡»åˆ·æ–°', 
                        icon: 'none',
                        duration: 2000
                    });
                    break;
                    
                case 'cancelled':
                    // ç”¨æˆ·å–æ¶ˆ - åœæ­¢è½®è¯¢
                    this.clearQrcodePolling();
                    uni.showToast({ 
                        title: 'å·²å–æ¶ˆç™»å½•', 
                        icon: 'none' 
                    });
                    break;
                    
                default:
                    console.warn('æœªçŸ¥çŠ¶æ€:', re.status);
            }
        },
        { qrcodeId: this.qrcodeLogin.qrcodeId },
        {
            route: uni.svs.auth,
            action: 'api/qrcode/check',
            method: 'GET'
        }
    );
},

// å¤„ç†æ‰«ç ç™»å½•æˆåŠŸ
handleQrcodeLoginSuccess(token, userInfo) {
    console.log('æ‰«ç ç™»å½•æˆåŠŸ:', { token, userInfo });
    
    // åœæ­¢æ‰€æœ‰å®šæ—¶å™¨
    this.clearQrcodePolling();
    this.clearQrcodeTimer();
    
    uni.showLoading({ title: 'ç™»å½•ä¸­...' });
    
    // ä¿å­˜tokenå’Œç”¨æˆ·ä¿¡æ¯åˆ°æœ¬åœ°
    uni.setStorageSync('token', token);
    uni.setStorageSync('curmobile', userInfo.mobile);
    
    // è°ƒç”¨å…¨å±€ç™»å½•å›è°ƒ (åŒæ­¥globalData)
    const app = getApp();
    app.globalData.getUserInfoBack({
        sid: 'session_' + Date.now(),  // å¦‚æœåç«¯è¿”å›äº†sidåˆ™ä½¿ç”¨
        token: token,
        objuser: userInfo,
        code: 0
    });
    
    uni.hideLoading();
    
    // å»¶è¿Ÿä¸€ä¸‹æ˜¾ç¤ºæˆåŠŸæç¤º
    uni.showToast({
        title: 'ç™»å½•æˆåŠŸ',
        icon: 'success',
        duration: 1500
    });
    
    // è·³è½¬åˆ°ä¸»é¡µ
    setTimeout(() => {
        this.loginCallback();
    }, 1500);
},

// æ¸…é™¤è½®è¯¢å®šæ—¶å™¨
clearQrcodePolling() {
    if (this.qrcodeLogin.pollingTimer) {
        console.log('æ¸…é™¤è½®è¯¢å®šæ—¶å™¨');
        clearInterval(this.qrcodeLogin.pollingTimer);
        this.qrcodeLogin.pollingTimer = null;
    }
}
```



**ç¬¬4æ­¥: ä¿®æ”¹åˆå§‹åŒ–å’Œåˆ·æ–°æ–¹æ³•**

```javascript
// ä¿®æ”¹ initQrcode (ç¬¬265-268è¡Œ)
initQrcode() {
    console.log('åˆå§‹åŒ–äºŒç»´ç ');
    this.generateQrcodeFromBackend();  // ğŸ‘ˆ æ”¹ä¸ºä»åç«¯ç”Ÿæˆ
    this.startQrcodeTimer();           // å¯åŠ¨å®šæ—¶åˆ·æ–°
    // ä¸åœ¨è¿™é‡Œå¯åŠ¨è½®è¯¢,ç­‰ç”ŸæˆæˆåŠŸåå†å¯åŠ¨
},

// ä¿®æ”¹ refreshQrcode (ç¬¬295-299è¡Œ)
refreshQrcode() {
    console.log('æ‰‹åŠ¨åˆ·æ–°äºŒç»´ç ');
    
    // åœæ­¢æ—§çš„è½®è¯¢
    this.clearQrcodePolling();
    
    // é‡æ–°ç”Ÿæˆ (ç”ŸæˆæˆåŠŸåä¼šè‡ªåŠ¨å¼€å§‹è½®è¯¢)
    this.generateQrcodeFromBackend();
    
    // é‡å¯å®šæ—¶åˆ·æ–°
    this.startQrcodeTimer();
}
```

**ç¬¬5æ­¥: ä¿®æ”¹é¡µé¢å¸è½½é€»è¾‘**

```javascript
// ä¿®æ”¹ onUnload (ç¬¬37-41è¡Œ)
onUnload() {
    this.clearQrcodeTimer();
    this.clearQrcodePolling();  // ğŸ‘ˆ æ–°å¢: æ¸…ç†è½®è¯¢
    this.clearVcodeTimer();
}
```

**ç¬¬6æ­¥: ä¿®æ”¹Tabåˆ‡æ¢é€»è¾‘**

```javascript
// ä¿®æ”¹ switchTab (ç¬¬196-206è¡Œ)
switchTab(index) {
    this.currentTab = index;

    if (this.tabs[index].type === 'qrcode') {
        this.$nextTick(() => {
            this.initQrcode();
        });
    } else {
        // åˆ‡èµ°æ—¶æ¸…ç†äºŒç»´ç ç›¸å…³å®šæ—¶å™¨
        this.clearQrcodeTimer();
        this.clearQrcodePolling();  // ğŸ‘ˆ æ–°å¢
    }
}
```

**ç¬¬7æ­¥: ä¼˜åŒ–UIçŠ¶æ€æ˜¾ç¤º**

```vue
<!-- åœ¨ login.vue çš„äºŒç»´ç åŒºåŸŸæ·»åŠ çŠ¶æ€æ˜¾ç¤º (ç¬¬99-120è¡Œé™„è¿‘) -->
<view v-if="tabs[currentTab].type === 'qrcode'" class="form-content qrcode-content">
    <view class="qrcode-area">
        <!-- äºŒç»´ç å®¹å™¨ -->
        <view class="qrcode-wrapper">
            <uqrcode
                ref="qrcode"
                canvas-id="qrcode"
                :value="qrcodeLogin.content"
                :size="qrcodeLogin.size"
                :options="qrcodeLogin.options"
            ></uqrcode>
            
            <!-- ğŸ‘‡ æ–°å¢: çŠ¶æ€é®ç½©å±‚ -->
            <view v-if="qrcodeLogin.status === 'expired'" class="qrcode-mask">
                <image 
                    class="expired-icon" 
                    src="/static/image/login/expired.png"
                ></image>
                <text class="expired-text">äºŒç»´ç å·²è¿‡æœŸ</text>
            </view>
            
            <view v-if="qrcodeLogin.status === 'scanned'" class="qrcode-mask scanned">
                <image 
                    class="scanned-icon" 
                    src="/static/image/login/scanned.png"
                ></image>
                <text class="scanned-text">å·²æ‰«ç ,è¯·åœ¨æ‰‹æœºä¸Šç¡®è®¤</text>
            </view>
        </view>

        <!-- æ—¶é—´æ˜¾ç¤º -->
        <view class="timetxt">{{ qrcodeLogin.timestamp }}</view>

        <!-- ğŸ‘‡ ä¿®æ”¹æç¤ºæ–‡å­— -->
        <view class="qrcode-status-wrapper">
            <text class="qrcode-tip" v-if="qrcodeLogin.status === 'waiting'">
                è¯·ä½¿ç”¨æ‰‹æœºå¾®ä¿¡æ‰«æäºŒç»´ç ç™»å½•
            </text>
            <text class="qrcode-tip success" v-if="qrcodeLogin.status === 'scanned'">
                æ‰«ç æˆåŠŸ,è¯·åœ¨æ‰‹æœºä¸Šç¡®è®¤ç™»å½•
            </text>
            <text class="qrcode-tip expired" v-if="qrcodeLogin.status === 'expired'">
                äºŒç»´ç å·²å¤±æ•ˆ,è¯·ç‚¹å‡»ä¸‹æ–¹åˆ·æ–°
            </text>
        </view>
    </view>
    
    <!-- åˆ·æ–°æŒ‰é’® -->
    <view class="refreshcode weui-flex_center" @click="refreshQrcode">
        <image 
            src="/static/image/home/reload.png" 
            style="width:25rpx;height:25rpx;margin-right:5px;"
        ></image>
        åˆ·æ–°äºŒç»´ç 
    </view>
</view>
```

**ç¬¬8æ­¥: æ·»åŠ å¯¹åº”æ ·å¼**

```css
/* åœ¨ login.vue çš„ <style scoped> ä¸­æ·»åŠ  (ç¬¬600è¡Œå·¦å³) */

/* äºŒç»´ç é®ç½©å±‚ */
.qrcode-mask {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(255, 255, 255, 0.95);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    border-radius: 8rpx;
}

.qrcode-mask.scanned {
    background: rgba(96, 202, 187, 0.1);
}

.expired-icon,
.scanned-icon {
    width: 80rpx;
    height: 80rpx;
    margin-bottom: 16rpx;
}

.expired-text {
    font-size: 28rpx;
    color: #999999;
}

.scanned-text {
    font-size: 28rpx;
    color: #60CABB;
    font-weight: bold;
}

.qrcode-status-wrapper {
    min-height: 60rpx;
    display: flex;
    align-items: center;
    justify-content: center;
}

.qrcode-tip.success {
    color: #60CABB;
    font-weight: bold;
}

.qrcode-tip.expired {
    color: #FF6B6B;
}

/* åˆ·æ–°æŒ‰é’®hoveræ•ˆæœ */
.refreshcode:active {
    opacity: 0.7;
    transform: scale(0.98);
}
```

------

##### é˜¶æ®µ3: æ‰‹æœºç«¯æ‰«ç ç¡®è®¤é¡µé¢

**ç¬¬1æ­¥: åˆ›å»ºç¡®è®¤é¡µé¢**

åœ¨ `pages/qrcode/` ç›®å½•ä¸‹åˆ›å»º `confirm.vue`:

```vue
<template>
    <view class="confirm-container">
        <!-- é¡¶éƒ¨çŠ¶æ€ -->
        <view class="header">
            <image 
                class="logo" 
                src="/static/image/home/img_defaultlogo.jpg"
            ></image>
            <text class="app-name">æ™ºæ…§é£Ÿå ‚ä»“åº“</text>
        </view>

        <!-- ä¸»å†…å®¹ -->
        <view class="content">
            <!-- è®¾å¤‡ä¿¡æ¯å¡ç‰‡ -->
            <view class="device-card">
                <view class="card-title">
                    <image 
                        class="device-icon" 
                        src="/static/image/login/pc_icon.png"
                    ></image>
                    <text class="title-text">ç¡®è®¤ç™»å½•</text>
                </view>
                
                <view class="device-info">
                    <view class="info-row">
                        <text class="label">è®¾å¤‡ç±»å‹:</text>
                        <text class="value">PCç«¯æµè§ˆå™¨</text>
                    </view>
                    <view class="info-row">
                        <text class="label">ç™»å½•æ—¶é—´:</text>
                        <text class="value">{{ loginTime }}</text>
                    </view>
                    <view class="info-row">
                        <text class="label">è®¾å¤‡ä½ç½®:</text>
                        <text class="value">{{ location }}</text>
                    </view>
                </view>

                <view class="warning-box">
                    <image 
                        class="warning-icon" 
                        src="/static/image/login/warning.png"
                    ></image>
                    <text class="warning-text">
                        å¦‚æœä¸æ˜¯æ‚¨æœ¬äººæ“ä½œ,è¯·ç‚¹å‡»å–æ¶ˆå¹¶ä¿®æ”¹å¯†ç 
                    </text>
                </view>
            </view>

            <!-- ç”¨æˆ·ä¿¡æ¯ -->
            <view class="user-info" v-if="userInfo">
                <image 
                    class="avatar" 
                    :src="userInfo.avatar || '/static/image/default_avatar.png'"
                ></image>
                <text class="nickname">{{ userInfo.nickname || userInfo.mobile }}</text>
                <text class="mobile">{{ formatMobile(userInfo.mobile) }}</text>
            </view>
        </view>

        <!-- åº•éƒ¨æŒ‰é’® -->
        <view class="footer">
            <button 
                class="cancel-btn" 
                @click="handleCancel"
                :disabled="loading"
            >
                å–æ¶ˆç™»å½•
            </button>
            <button 
                class="confirm-btn" 
                @click="handleConfirm"
                :loading="loading"
            >
                {{ loading ? 'ç¡®è®¤ä¸­...' : 'ç¡®è®¤ç™»å½•' }}
            </button>
        </view>
    </view>
</template>

<script>
const app = getApp();

export default {
    data() {
        return {
            qrcodeId: '',           // äºŒç»´ç ID
            loginTime: '',          // ç™»å½•æ—¶é—´
            location: 'æœªçŸ¥',       // åœ°ç†ä½ç½®
            loading: false,         // åŠ è½½çŠ¶æ€
            userInfo: null          // å½“å‰ç”¨æˆ·ä¿¡æ¯
        }
    },
    
    onLoad(options) {
        console.log('æ‰«ç ç¡®è®¤é¡µé¢å‚æ•°:', options);
        
        // è·å–äºŒç»´ç ID
        this.qrcodeId = options.qrcodeId || options.scene;
        
        if (!this.qrcodeId) {
            uni.showModal({
                title: 'æç¤º',
                content: 'äºŒç»´ç å‚æ•°é”™è¯¯',
                showCancel: false,
                success: () => {
                    uni.navigateBack();
                }
            });
            return;
        }
        
        // è®¾ç½®ç™»å½•æ—¶é—´
        this.loginTime = this.formatDateTime(new Date());
        
        // è·å–ç”¨æˆ·ä¿¡æ¯
        this.getUserInfo();
        
        // è·å–åœ°ç†ä½ç½® (å¯é€‰)
        this.getLocation();
    },
    
    methods: {
        // è·å–ç”¨æˆ·ä¿¡æ¯
        getUserInfo() {
            // æ–¹æ³•1: ä»globalDataè·å–
            if (app.globalData.objuserinfo) {
                this.userInfo = app.globalData.objuserinfo;
                return;
            }
            
            // æ–¹æ³•2: ä»æœ¬åœ°å­˜å‚¨è·å–
            const mobile = uni.getStorageSync('curmobile');
            if (mobile) {
                this.userInfo = {
                    mobile: mobile,
                    nickname: mobile.replace(/(\d{3})\d{4}(\d{4})/, '$1****$2')
                };
                return;
            }
            
            // æ–¹æ³•3: æœªç™»å½•,æç¤ºå¹¶è·³è½¬
            uni.showModal({
                title: 'æç¤º',
                content: 'è¯·å…ˆç™»å½•',
                showCancel: false,
                success: () => {
                    uni.reLaunch({
                        url: '/pages/login/login'
                    });
                }
            });
        },
        
        // è·å–åœ°ç†ä½ç½®
        getLocation() {
            uni.getLocation({
                type: 'wgs84',
                success: (res) => {
                    // è¿™é‡Œå¯ä»¥è°ƒç”¨åœ°å›¾APIåå‘è§£æåœ°å€
                    this.location = `${res.latitude.toFixed(2)}, ${res.longitude.toFixed(2)}`;
                },
                fail: () => {
                    this.location = 'å®šä½å¤±è´¥';
                }
            });
        },
        
        // ç¡®è®¤ç™»å½•
        handleConfirm() {
            if (this.loading) return;
            
            const token = uni.getStorageSync('token');
            
            if (!token) {
                uni.showModal({
                    title: 'æç¤º',
                    content: 'ç™»å½•çŠ¶æ€å·²å¤±æ•ˆ,è¯·é‡æ–°ç™»å½•',
                    showCancel: false,
                    success: () => {
                        uni.reLaunch({
                            url: '/pages/login/login'
                        });
                    }
                });
                return;
            }
            
            this.loading = true;
            
            app.globalData.smaction(
                (re, err, obj) => {
                    this.loading = false;
                    
                    if (err) {
                        console.error('ç¡®è®¤ç™»å½•å¤±è´¥:', err);
                        uni.showModal({
                            title: 'ç¡®è®¤å¤±è´¥',
                            content: err || 'ç½‘ç»œå¼‚å¸¸,è¯·é‡è¯•',
                            showCancel: false
                        });
                        return;
                    }
                    
                    // ç¡®è®¤æˆåŠŸ
                    uni.showToast({
                        title: 'ç¡®è®¤æˆåŠŸ',
                        icon: 'success',
                        duration: 2000
                    });
                    
                    // å»¶è¿Ÿè¿”å›
                    setTimeout(() => {
                        uni.navigateBack();
                    }, 2000);
                },
                {
                    qrcodeId: this.qrcodeId,
                    userToken: token
                },
                {
                    route: uni.svs.auth,
                    action: 'api/qrcode/confirm',
                    method: 'POST',
                    datastring: true  // ğŸ‘ˆ POSTè¯·æ±‚éœ€è¦åºåˆ—åŒ–
                }
            );
        },
        
        // å–æ¶ˆç™»å½•
        handleCancel() {
            uni.showModal({
                title: 'ç¡®è®¤å–æ¶ˆ',
                content: 'ç¡®å®šè¦å–æ¶ˆæœ¬æ¬¡ç™»å½•å—?',
                success: (res) => {
                    if (res.confirm) {
                        // è°ƒç”¨å–æ¶ˆæ¥å£ (å¯é€‰)
                        app.globalData.smaction(
                            (re, err) => {
                                // æ— è®ºæˆåŠŸå¤±è´¥éƒ½è¿”å›
                                uni.navigateBack();
                            },
                            { qrcodeId: this.qrcodeId },
                            {
                                route: uni.svs.auth,
                                action: 'api/qrcode/cancel',
                                method: 'POST',
                                datastring: true
                            }
                        );
                    }
                }
            });
        },
        
        // æ ¼å¼åŒ–æ‰‹æœºå·
        formatMobile(mobile) {
            if (!mobile) return '';
            return mobile.replace(/(\d{3})\d{4}(\d{4})/, '$1****$2');
        },
        
        // æ ¼å¼åŒ–æ—¥æœŸæ—¶é—´
        formatDateTime(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hour = String(date.getHours()).padStart(2, '0');
            const minute = String(date.getMinutes()).padStart(2, '0');
            const second = String(date.getSeconds()).padStart(2, '0');
            
            return `${year}-${month}-${day} ${hour}:${minute}:${second}`;
        }
    }
}
</script>

<style scoped>
page {
    background: #F5F7FA;
}

.confirm-container {
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    padding: 40rpx;
}

/* é¡¶éƒ¨ */
.header {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 60rpx 0 80rpx;
}

.logo {
    width: 160rpx;
    height: 160rpx;
    border-radius: 50%;
    margin-bottom: 24rpx;
}

.app-name {
    font-size: 36rpx;
    font-weight: bold;
    color: #333333;
}

/* ä¸»å†…å®¹ */
.content {
    flex: 1;
}

.device-card {
    background: #FFFFFF;
    border-radius: 20rpx;
    padding: 40rpx;
    margin-bottom: 30rpx;
    box-shadow: 0 2rpx 12rpx rgba(0, 0, 0, 0.05);
}

.card-title {
    display: flex;
    align-items: center;
    margin-bottom: 30rpx;
    padding-bottom: 20rpx;
    border-bottom: 1rpx solid #F0F0F0;
}

.device-icon {
    width: 48rpx;
    height: 48rpx;
    margin-right: 16rpx;
}

.title-text {
    font-size: 32rpx;
    font-weight: bold;
    color: #333333;
}

.device-info {
    margin-bottom: 30rpx;
}

.info-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 20rpx 0;
}

.info-row .label {
    font-size: 28rpx;
    color: #666666;
}

.info-row .value {
    font-size: 28rpx;
    color: #333333;
    font-weight: 500;
}

.warning-box {
    background: #FFF5E6;
    border-radius: 12rpx;
    padding: 20rpx;
    display: flex;
    align-items: flex-start;
}

.warning-icon {
    width: 32rpx;
    height: 32rpx;
    margin-right: 12rpx;
    flex-shrink: 0;
}

.warning-text {
    flex: 1;
    font-size: 24rpx;
    color: #FF9800;
    line-height: 1.6;
}

/* ç”¨æˆ·ä¿¡æ¯ */
.user-info {
    background: #FFFFFF;
    border-radius: 20rpx;
    padding: 40rpx;
    display: flex;
    flex-direction: column;
    align-items: center;
    box-shadow: 0 2rpx 12rpx rgba(0, 0, 0, 0.05);
}

.avatar {
    width: 120rpx;
    height: 120rpx;
    border-radius: 50%;
    margin-bottom: 20rpx;
}

.nickname {
    font-size: 32rpx;
    font-weight: bold;
    color: #333333;
    margin-bottom: 12rpx;
}

.mobile {
    font-size: 28rpx;
    color: #999999;
}

/* åº•éƒ¨æŒ‰é’® */
.footer {
    display: flex;
    gap: 20rpx;
    padding: 40rpx 0 20rpx;
}

.cancel-btn,
.confirm-btn {
    flex: 1;
    height: 88rpx;
    border-radius: 44rpx;
    font-size: 32rpx;
    font-weight: bold;
    border: none;
    display: flex;
    align-items: center;
    justify-content: center;
}

.cancel-btn {
    background: #F5F5F5;
    color: #666666;
}

.cancel-btn:active {
    background: #E8E8E8;
}

.confirm-btn {
    background: linear-gradient(135deg, #60CABB 0%, #4AB5A5 100%);
    color: #FFFFFF;
}

.confirm-btn:active {
    opacity: 0.8;
}

.confirm-btn::after,
.cancel-btn::after {
    border: none;
}
</style>
```

**ç¬¬2æ­¥: é…ç½®é¡µé¢è·¯ç”±**

åœ¨ `pages.json` ä¸­æ·»åŠ :

```json
{
    "pages": [
        // ...å…¶ä»–é¡µé¢
        {
            "path": "pages/qrcode/confirm",
            "style": {
                "navigationBarTitleText": "æ‰«ç ç™»å½•ç¡®è®¤",
                "navigationBarBackgroundColor": "#60CABB",
                "navigationBarTextStyle": "white"
            }
        }
    ]
}
```

**ç¬¬3æ­¥: ç”Ÿæˆå°ç¨‹åºç **

åç«¯ç”Ÿæˆå°ç¨‹åºç æ—¶,è®¾ç½®è·³è½¬è·¯å¾„:

```javascript
// åç«¯ä¼ªä»£ç  (Node.js)
const WxBizDataCrypt = require('wechat-api');

app.post('/api/qrcode/generateMiniCode', async (req, res) => {
    const qrcodeId = req.body.qrcodeId;
    
    // è°ƒç”¨å¾®ä¿¡æ¥å£ç”Ÿæˆå°ç¨‹åºç 
    const result = await axios.post(
        `https://api.weixin.qq.com/wxa/getwxacodeunlimit?access_token=${accessToken}`,
        {
            scene: qrcodeId,  // ğŸ‘ˆ äºŒç»´ç IDä½œä¸ºsceneå‚æ•°
            page: 'pages/qrcode/confirm',  // ğŸ‘ˆ è·³è½¬åˆ°ç¡®è®¤é¡µé¢
            width: 280,
            auto_color: false,
            line_color: { r: 96, g: 202, b: 187 }  // ä¸»é¢˜è‰²
        },
        { responseType: 'arraybuffer' }
    );
    
    // ä¸Šä¼ åˆ°OSSæˆ–è¿”å›base64
    const base64 = Buffer.from(result.data).toString('base64');
    res.json({
        code: 200,
        data: {
            qrcodeImage: `data:image/png;base64,${base64}`
        }
    });
});
```

------

##### é˜¶æ®µ4: å®Œæ•´æµç¨‹æ—¶åºå›¾

```mermaid
sequenceDiagram
    participant PC as PCç«¯ login.vue
    participant Backend as åç«¯æœåŠ¡
    participant Redis as Redisç¼“å­˜
    participant Mobile as æ‰‹æœºç«¯

    Note over PC: ç”¨æˆ·åˆ‡æ¢åˆ°"æ‰«ç ç™»å½•"Tab
    PC->>PC: switchTab('qrcode')
    PC->>PC: initQrcode()
    
    PC->>Backend: GET /api/qrcode/generate
    Backend->>Backend: ç”Ÿæˆ qrcodeId
    Backend->>Redis: å­˜å‚¨çŠ¶æ€ {status: 'waiting'}
    Backend->>Backend: ç”Ÿæˆå°ç¨‹åºç URL
    Backend-->>PC: è¿”å› {qrcodeId, qrcodeUrl, appId}
    
    PC->>PC: æ¸²æŸ“äºŒç»´ç 
    PC->>PC: startQrcodePolling() æ¯2ç§’è½®è¯¢
    
    loop æ¯2ç§’è½®è¯¢
        PC->>Backend: GET /api/qrcode/check?qrcodeId=xxx
        Backend->>Redis: æŸ¥è¯¢çŠ¶æ€
        Redis-->>Backend: {status: 'waiting'}
        Backend-->>PC: {status: 'waiting'}
    end
    
    Note over Mobile: ç”¨æˆ·æ‰«æäºŒç»´ç 
    Mobile->>Mobile: è·³è½¬ pages/qrcode/confirm
    Mobile->>Mobile: onLoad(qrcodeId)
    Mobile->>Mobile: æ˜¾ç¤ºç¡®è®¤é¡µé¢
    
    PC->>Backend: GET /api/qrcode/check
    Backend->>Redis: æŸ¥è¯¢çŠ¶æ€
    Redis-->>Backend: {status: 'waiting'}
    Backend-->>PC: {status: 'waiting'}
    
    Note over Mobile: ç”¨æˆ·ç‚¹å‡»"ç¡®è®¤ç™»å½•"
    Mobile->>Backend: POST /api/qrcode/confirm
    Note right of Backend: {qrcodeId, userToken}
    
    Backend->>Backend: éªŒè¯ userToken
    Backend->>Backend: ç”Ÿæˆæ–°çš„ PC_token
    Backend->>Redis: æ›´æ–°çŠ¶æ€ {status: 'confirmed', token: PC_token}
    Backend-->>Mobile: {code: 200, msg: 'ç¡®è®¤æˆåŠŸ'}
    
    Mobile->>Mobile: æ˜¾ç¤ºæˆåŠŸæç¤º
    Mobile->>Mobile: navigateBack()
    
    PC->>Backend: GET /api/qrcode/check (ç»§ç»­è½®è¯¢)
    Backend->>Redis: æŸ¥è¯¢çŠ¶æ€
    Redis-->>Backend: {status: 'confirmed', token: PC_token, userInfo}
    Backend-->>PC: {status: 'confirmed', token, userInfo}
    
    PC->>PC: handleQrcodeLoginSuccess()
    PC->>PC: åœæ­¢è½®è¯¢
    PC->>PC: ä¿å­˜ token åˆ° localStorage
    PC->>PC: getUserInfoBack()
    PC->>PC: loginCallback()
    PC->>PC: reLaunch('/pages/tabBar/rfidbind/index')
```

------

##### é˜¶æ®µ5: App.vue ä¸­æ·»åŠ æ‰«ç ç™»å½•ç±»å‹

App.vue çš„ `applogin` æ–¹æ³•å·²ç»æ”¯æŒä»»æ„ `logintype`,**æ— éœ€ä¿®æ”¹**ã€‚

å½“å‰æ”¯æŒçš„ç™»å½•ç±»å‹:

```javascript
// App.vue å·²æ”¯æŒçš„ logintype (é€šè¿‡ param å‚æ•°ä¼ å…¥)
{
    logintype: 'autologin',        // Tokenè‡ªåŠ¨ç™»å½•
    logintype: 'loginBycode',      // å¾®ä¿¡codeç™»å½•
    logintype: 'loginByopenid',    // OpenIDç™»å½•
    logintype: 'loginByPassword',  // å¯†ç ç™»å½•
    logintype: 'loginByVcode',     // éªŒè¯ç ç™»å½•
    logintype: 'loginByQrcode'     // ğŸ‘ˆ æ–°å¢: æ‰«ç ç™»å½• (åç«¯éœ€æ”¯æŒ)
}
```

**å¦‚æœéœ€è¦æ˜ç¡®æ”¯æŒæ‰«ç ç™»å½•**,å¯ä»¥åœ¨ login.vue çš„ `handleQrcodeLoginSuccess` ä¸­æ·»åŠ :

```javascript
handleQrcodeLoginSuccess(token, userInfo) {
    // ...å‰é¢ä»£ç 

    // æ–¹å¼1: ç›´æ¥ä½¿ç”¨è¿”å›çš„token (æ¨è)
    uni.setStorageSync('token', token);
    app.globalData.getUserInfoBack({
        sid: userInfo.sessionId || 'qrcode_session',
        token: token,
        objuser: userInfo,
        code: 0
    });
    
    // æ–¹å¼2: å†æ¬¡è°ƒç”¨ applogin éªŒè¯ (ä¸æ¨è,å¤šä¸€æ¬¡è¯·æ±‚)
    // const param = {
    //     zhtype: app.globalData.xcxtype,
    //     logintype: "loginByQrcode",
    //     qrcodeId: this.qrcodeLogin.qrcodeId,
    //     token: token
    // };
    // app.globalData.applogin(param, () => {
    //     this.loginCallback();
    // });
}
```

------

## å…­ã€è°ƒè¯•æŒ‡å—

### 6.1 å¼€å‘ç¯å¢ƒé…ç½®æ£€æŸ¥æ¸…å•

```bash
âœ… ç¯å¢ƒå˜é‡æ£€æŸ¥
- [ ] globaldata.js ä¸­ requrl æ˜¯å¦æ­£ç¡®
- [ ] process.env.NODE_ENV æ˜¯å¦ä¸º 'development'
- [ ] åç«¯æœåŠ¡æ˜¯å¦åœ¨ 0.0.0.0:8078 ç›‘å¬

âœ… ç½‘ç»œè¿é€šæ€§æ£€æŸ¥
- [ ] ping 192.168.1.100 (ä½ çš„IP)
- [ ] curl http://192.168.1.100:8078/health
- [ ] æµè§ˆå™¨è®¿é—® http://192.168.1.100:8078

âœ… é˜²ç«å¢™æ£€æŸ¥
- [ ] Windowsé˜²ç«å¢™æ˜¯å¦å…è®¸ 8078 ç«¯å£
- [ ] æ€æ¯’è½¯ä»¶æ˜¯å¦æ‹¦æˆª
- [ ] å…¬å¸ç½‘ç»œæ˜¯å¦æœ‰é™åˆ¶

âœ… å°ç¨‹åºé…ç½®
- [ ] å¼€å‘è€…å·¥å…·æ˜¯å¦å‹¾é€‰"ä¸æ ¡éªŒåˆæ³•åŸŸå"
- [ ] app.globalData.services.auth æ˜¯å¦æ­£ç¡®é…ç½®
- [ ] Tokenæ˜¯å¦æ­£ç¡®ä¿å­˜åˆ°Storage
```

### 6.2 è°ƒè¯•æŠ€å·§

#### æŠ€å·§1: å…¨å±€è¯·æ±‚æ—¥å¿—

åœ¨ `App.vue`





























