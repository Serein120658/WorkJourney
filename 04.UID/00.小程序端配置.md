# uni-app 微服务路由配置完整指南

## 📋 目录

[TOC]

------

## 📌 项目架构概述

### 系统架构图

```
┌─────────────────┐    ┌──────────────────┐    ┌────────────────┐
│   uni-app 前端   │────│   网关/代理服务   │────│  后端微服务集群  │
│  (小程序/H5)     │    │                  │    │               │
└─────────────────┘    └──────────────────┘    └────────────────┘
         │                        │                       │
         │                        │                       ├── uniuid (认证服务)
         │                        │                       ├── zxx_home_biz (业务服务)
         │                        │                       └── 其他微服务...
         │                        │
    ┌────▼─────┐          ┌──────▼──────┐
    │ globaldata.js │      │ 请求路由分发  │
    │ 环境配置      │      │             │
    └──────────────┘      └─────────────┘
```

### 请求流程

```
用户操作 → uni.sm() → App.vue(sm方法) → geturl() → 构建完整URL → uni.request() → 后端服务
                ↑                              ↑
            传入route参数              根据route构建URL
```

------

## ⚙️ 关键配置文件详解

### 1. globaldata.js 配置结构

```javascript
var dev = {
    ossPrefix: 'https://btkjtest.oss-cn-beijing.aliyuncs.com/',
    requrl: 'http://localhost:8036',  // 🔴 本地开发服务器地址
    updir: 'xcxuid',
    xcxtype: 'xcxuid',
    env_version: "develop",
    
    // 🔴 关键配置：自定义服务路由映射
    selfsevice: {
        // ⚠️ 注意：key 必须以 "/" 开头
        "/uniuid": {
            target: "http://localhost:8036"  // 本地服务地址
        },
        "/undefined": {  // 🔴 重要：处理 route 为 undefined 的情况
            target: "http://localhost:8036"
        },
        "/zxx_home_biz": {  // 业务服务路由
            target: "http://localhost:8036"
        }
    }
}
```

### 2. App.vue 中的服务配置

```javascript
// globalData 中的服务映射
services: {
    auth: 'uniuid'  // 🔴 唯一的服务映射，非常重要！
},

// geturl 方法逻辑
geturl(route, action) {
    // 🔴 优先级1：检查 selfsevice 自定义配置
    if (_this.globalData.selfsevice && _this.globalData.selfsevice["/" + route]) {
        return _this.globalData.selfsevice["/" + route].target + '/' + action;
    } else {
        // 🔴 优先级2：使用默认规则
        return _this.globalData.requrl + '/' + route + '/' + action;
    }
}
```

------

## 🎯 route 参数配置规范

### ⚠️ 核心注意事项

#### 1. **uni.svs.auth 的唯一性问题**

```javascript
// ❗ 当前配置中只有一个服务映射
services: {
    auth: 'uniuid'  // 只有这一个！
}

// ✅ 正确使用方式
uni.sm(callback, params, {route: uni.svs.auth});  // 等同于 route: 'uniuid'

// ❌ 错误：尝试使用不存在的服务
uni.sm(callback, params, {route: uni.svs.home});  // uni.svs.home 不存在！
```

#### 2. **route 参数的三种正确写法**

##### 方式一：直接使用服务名（推荐本地开发）

```javascript
// 认证相关接口
uni.sm(callback, ['user.login', username, password], {
    route: 'uniuid'  // 🔴 直接使用微服务名
});

// 业务相关接口  
uni.sm(callback, ['feedback.add', data], {
    route: 'zxx_home_biz'  // 🔴 直接使用微服务名
});
```

##### 方式二：使用服务映射（仅限已配置的服务）

```javascript
// 只能使用 auth，因为只配置了这一个
uni.sm(callback, ['user.getInfo'], {
    route: uni.svs.auth  // ✅ 等同于 'uniuid'
});

// ❌ 错误示例：使用未配置的服务映射
uni.sm(callback, ['feedback.add', data], {
    route: uni.svs.business  // ❌ uni.svs.business 未定义
});
```

##### 方式三：本地开发统一配置（推荐）

```javascript
// 由于本地开发所有服务都在同一个端口，可以统一处理
uni.sm(callback, ['any.method', data], {
    route: 'uniuid'  // 统一使用 uniuid，通过 selfsevice 配置处理
});
```

### 📋 route 参数规范表

| 使用场景 | route 写法       | 最终URL                                 | 说明                 |
| -------- | ---------------- | --------------------------------------- | -------------------- |
| 用户认证 | `'uniuid'`       | `http://localhost:8036/Enter`           | 通过 selfsevice 配置 |
| 用户认证 | `uni.svs.auth`   | `http://localhost:8036/Enter`           | 等同于 'uniuid'      |
| 业务功能 | `'zxx_home_biz'` | `http://localhost:8036/Enter`           | 通过 selfsevice 配置 |
| ❌ 错误   | `undefined`      | `http://localhost:8036/undefined/Enter` | 需要配置处理         |
| ❌ 错误   | 不传参数         | `http://localhost:8036/undefined/Enter` | 需要配置处理         |

------

## 🏠 本地开发配置注意事项

### ⚠️ 关键配置要点

#### 1. **服务器地址统一**

```javascript
// 🔴 所有环境的 requrl 必须正确
var dev = {
    requrl: 'http://localhost:8036',  // 确保端口正确
    selfsevice: {
        "/uniuid": {
            target: "http://localhost:8036"  // 必须与 requrl 一致
        },
        "/zxx_home_biz": {
            target: "http://localhost:8036"  // 本地开发统一端口
        }
    }
}
```

#### 2. **undefined 处理配置**

```javascript
// 🔴 必须配置，防止 route 参数缺失导致的错误
selfsevice: {
    "/undefined": {
        target: "http://localhost:8036"  // 处理 route 为 undefined 的情况
    },
    "/null": {
        target: "http://localhost:8036"  // 处理 route 为 null 的情况
    },
    "/": {
        target: "http://localhost:8036"  // 处理 route 为空字符串的情况
    }
}
```

#### 3. **微信小程序域名配置**

```javascript
// 开发阶段必须设置
// 微信开发者工具 → 详情 → 本地设置 → 勾选
// "不校验合法域名、web-view（业务域名）、TLS 版本以及 HTTPS 证书"
```

#### 4. **本地服务器启动检查**

```bash
# 确保本地服务器在正确端口运行
netstat -an | findstr 8036  # Windows
lsof -i :8036              # macOS/Linux

# 测试服务器连通性
curl http://localhost:8036/Enter
```

### 🔧 本地开发推荐配置

```javascript
// globaldata.js - 本地开发优化配置
var dev = {
    ossPrefix: 'https://btkjtest.oss-cn-beijing.aliyuncs.com/',
    requrl: 'http://localhost:8036',
    updir: 'xcxuid',
    xcxtype: 'xcxuid',
    env_version: "develop",
    
    // 🔴 本地开发专用配置：所有服务统一到本地
    selfsevice: {
        // 处理各种异常情况
        "/undefined": { target: "http://localhost:8036" },
        "/null": { target: "http://localhost:8036" },
        "/": { target: "http://localhost:8036" },
        
        // 具体服务配置
        "/uniuid": { target: "http://localhost:8036" },
        "/zxx_home_biz": { target: "http://localhost:8036" },
        
        // 🔴 通配符配置（如果后端支持）
        "/*": { target: "http://localhost:8036" }
    }
}
```

------

## 🔍 常见问题与解决方案

### ❌ 问题1：请求 URL 出现 undefined

**错误现象：**

```
GET http://localhost:8036/undefined/Enter 404 (Not Found)
```

**原因分析：**

- 调用 `uni.sm` 时未传递 `route` 参数
- 传递的 `route` 参数值为 `undefined` 或 `null`

**解决方案：**

```javascript
// 方案1：在 globaldata.js 中添加异常处理配置
selfsevice: {
    "/undefined": {
        target: "http://localhost:8036"
    }
}

// 方案2：调用时确保传递正确的 route 参数
uni.sm(callback, params, {
    route: 'uniuid'  // 确保不为空
});

// 方案3：在调用前进行参数检查
const route = uni.svs.auth || 'uniuid';  // 提供默认值
uni.sm(callback, params, {route});
```

### ❌ 问题2：H5 能请求成功但小程序失败

**原因分析：**

- H5 环境使用相对路径 + 代理配置
- 小程序环境需要完整的绝对路径

**解决方案：**

```javascript
// 检查 App.vue 中的条件编译
uni.request({
    // #ifdef H5
    url: '/Enter',  // H5 使用相对路径
    // #endif
    // #ifndef H5
    url: _this.globalData.geturl(pobj.route, "Enter"),  // 小程序使用完整路径
    // #endif
});

// 确保 geturl 方法返回正确的完整 URL
console.log('构建的URL:', _this.globalData.geturl('uniuid', 'Enter'));
// 应该输出：http://localhost:8036/Enter
```

### ❌ 问题3：uni.svs.xxx 未定义

**错误现象：**

```javascript
TypeError: Cannot read property 'business' of undefined
```

**原因分析：**

- 尝试使用未在 `services` 中定义的服务映射

**解决方案：**

```javascript
// 方案1：扩展 services 配置（在 App.vue globalData 中）
services: {
    auth: 'uniuid',
    business: 'zxx_home_biz',  // 添加新的服务映射
    home: 'zxx_home_biz'
},

// 方案2：直接使用服务名，不依赖映射
uni.sm(callback, params, {
    route: 'zxx_home_biz'  // 直接使用，不通过 uni.svs
});

// 方案3：添加安全检查
const route = uni.svs.business || 'zxx_home_biz';
uni.sm(callback, params, {route});
```

### ❌ 问题4：跨域请求失败

**错误现象：**

```
Access to XMLHttpRequest at 'http://localhost:8036/Enter' from origin 'http://localhost:8080' has been blocked by CORS policy
```

**解决方案：**

```javascript
// 后端服务器添加 CORS 配置
app.use(cors({
    origin: ['http://localhost:8080', 'http://localhost:8036'],
    credentials: true
}));

// 或在 manifest.json 中配置代理
{
  "h5": {
    "devServer": {
      "proxy": {
        "/Enter": "http://localhost:8036"
      }
    }
  }
}
```

------

## 🐛 调试技巧

### 1. **添加详细日志**

```javascript
// 在 App.vue 的 sm 方法开头添加
sm: function(cb, arr, pobj) {
    console.group('🔍 uni.sm 调试信息');
    console.log('📝 参数信息:', {
        arr: arr,
        pobj: pobj,
        route: pobj ? pobj.route : 'undefined'
    });
    
    // #ifdef H5
    console.log('🌐 当前环境: H5');
    console.log('🔗 H5 使用URL:', '/Enter');
    // #endif
    
    // #ifndef H5
    console.log('📱 当前环境: 小程序');
    const fullUrl = _this.globalData.geturl(pobj ? pobj.route : undefined, "Enter");
    console.log('🔗 小程序完整URL:', fullUrl);
    console.log('🔧 geturl 构建逻辑:', {
        route: pobj ? pobj.route : undefined,
        action: 'Enter',
        selfsevice: _this.globalData.selfsevice,
        requrl: _this.globalData.requrl
    });
    // #endif
    
    console.groupEnd();
    
    // 继续原有逻辑...
}
```

### 2. **网络请求监控**

```javascript
// 在 uni.request 的 success 和 fail 中添加详细日志
uni.request({
    url: finalUrl,
    data: data,
    header: headers,
    success: function(res) {
        console.group('✅ 请求成功');
        console.log('🔗 请求URL:', finalUrl);
        console.log('📤 请求数据:', data);
        console.log('📥 响应数据:', res);
        console.groupEnd();
        // 原有处理逻辑
    },
    fail: function(res) {
        console.group('❌ 请求失败');
        console.log('🔗 请求URL:', finalUrl);
        console.log('📤 请求数据:', data);
        console.log('❌ 错误信息:', res);
        console.groupEnd();
        cb(null, '请求失败: ' + JSON.stringify(res));
    }
});
```

### 3. **配置验证工具**

```javascript
// 在 App.vue onLaunch 中添加配置验证
onLaunch: function() {
    // 验证关键配置
    this.validateConfig();
    // ...其他初始化逻辑
},

methods: {
    validateConfig() {
        console.group('⚙️ 配置验证');
        
        // 检查基础配置
        console.log('🔗 requrl:', this.globalData.requrl);
        console.log('🏷️ xcxtype:', this.globalData.xcxtype);
        console.log('🌍 env_version:', this.globalData.env_version);
        
        // 检查服务配置
        console.log('🔧 services:', this.globalData.services);
        console.log('🔀 selfsevice:', this.globalData.selfsevice);
        
        // 检查 uni.svs 注册
        console.log('🔌 uni.svs:', uni.svs);
        console.log('🔐 uni.svs.auth:', uni.svs ? uni.svs.auth : 'undefined');
        
        // 测试 geturl 方法
        if (this.globalData.geturl) {
            console.log('🧪 geturl 测试:');
            console.log('  - uniuid:', this.globalData.geturl('uniuid', 'Enter'));
            console.log('  - undefined:', this.globalData.geturl(undefined, 'Enter'));
            console.log('  - zxx_home_biz:', this.globalData.geturl('zxx_home_biz', 'Enter'));
        }
        
        console.groupEnd();
    }
}
```

### 4. **快速测试接口**

```javascript
// 在页面中添加测试方法
methods: {
    testApiConnection() {
        console.log('🧪 开始接口连通性测试...');
        
        // 测试1：使用 uniuid
        uni.sm((re, err) => {
            console.log('测试1 - uniuid:', {result: re, error: err});
        }, ['ping'], {route: 'uniuid'});
        
        // 测试2：使用 uni.svs.auth
        uni.sm((re, err) => {
            console.log('测试2 - uni.svs.auth:', {result: re, error: err});
        }, ['ping'], {route: uni.svs.auth});
        
        // 测试3：不传 route（测试异常处理）
        uni.sm((re, err) => {
            console.log('测试3 - 无route:', {result: re, error: err});
        }, ['ping'], {});
    }
}
```

------

## 🚀 最佳实践

### 1. **统一的服务常量管理**

```javascript
// 创建 constants/services.js
export const SERVICES = {
    AUTH: 'uniuid',           // 认证服务
    HOME_BIZ: 'zxx_home_biz', // 业务服务
    // 未来可扩展其他服务
};

// 在页面中使用
import { SERVICES } from '@/constants/services.js';

uni.sm(callback, params, {
    route: SERVICES.AUTH  // 使用常量，避免硬编码
});
```

### 2. **封装统一的接口调用方法**

```javascript
// 创建 utils/api.js
class ApiService {
    // 认证相关接口
    static callAuthApi(method, params = []) {
        return new Promise((resolve, reject) => {
            uni.sm((result, error) => {
                if (error) reject(error);
                else resolve(result);
            }, [method, ...params], {route: 'uniuid'});
        });
    }
    
    // 业务相关接口
    static callBusinessApi(method, params = []) {
        return new Promise((resolve, reject) => {
            uni.sm((result, error) => {
                if (error) reject(error);
                else resolve(result);
            }, [method, ...params], {route: 'zxx_home_biz'});
        });
    }
}

// 使用示例
try {
    const result = await ApiService.callAuthApi('user.login', [username, password]);
    console.log('登录成功:', result);
} catch (error) {
    console.error('登录失败:', error);
}
```

### 3. **环境配置最佳实践**

```javascript
// globaldata.js - 完整配置模板
const createConfig = (env) => {
    const baseConfig = {
        ossPrefix: 'https://btkjtest.oss-cn-beijing.aliyuncs.com/',
        updir: 'xcxuid',
        xcxtype: 'xcxuid',
    };
    
    const envConfigs = {
        development: {
            requrl: 'http://localhost:8036',
            env_version: "develop",
            selfsevice: {
                // 🔴 开发环境：统一到本地服务器
                "/undefined": { target: "http://localhost:8036" },
                "/uniuid": { target: "http://localhost:8036" },
                "/zxx_home_biz": { target: "http://localhost:8036" }
            }
        },
        test: {
            requrl: 'https://test-uid.bt-z.com:553',
            env_version: "trial",
            selfsevice: {
                "/undefined": { target: "https://test-uid.bt-z.com:553" },
                "/uniuid": { target: "https://test-uid.bt-z.com:553" },
                "/zxx_home_biz": { target: "https://test-uid.bt-z.com:553" }
            }
        },
        production: {
            requrl: 'https://uid.bt-z.com',
            env_version: "release",
            selfsevice: {
                // 生产环境可能需要不同的服务地址
                "/uniuid": { target: "https://auth.bt-z.com" },
                "/zxx_home_biz": { target: "https://business.bt-z.com" }
            }
        }
    };
    
    return { ...baseConfig, ...envConfigs[env] };
};

// 根据环境变量自动选择配置
const currentEnv = process.env.ENV_TYPE === 'test' ? 'test' : 
                  (process.env.NODE_ENV === 'development' ? 'development' : 'production');

module.exports = createConfig(currentEnv);
```

### 4. **错误处理最佳实践**

```javascript
// 统一错误处理函数
const handleApiError = (error, context = '') => {
    console.error(`❌ API调用失败 [${context}]:`, error);
    
    // 根据错误类型给出具体提示
    if (typeof error === 'string') {
        if (error.includes('undefined')) {
            uni.showToast({
                title: '服务配置错误，请联系开发者',
                icon: 'none'
            });
        } else if (error.includes('timeout')) {
            uni.showToast({
                title: '网络超时，请检查网络连接',
                icon: 'none'
            });
        } else {
            uni.showToast({
                title: error,
                icon: 'none'
            });
        }
    }
};

// 在业务代码中使用
uni.sm((result, error) => {
    if (error) {
        handleApiError(error, '提交反馈');
        return;
    }
    // 处理成功结果
}, ["xcxuser_feedback.add", JSON.stringify(param)], {
    route: uni.svs.auth  // 使用配置好的路由
});
```

------

## 📌 检查清单

### 🔧 配置检查清单

- [ ] `globaldata.js` 中 `requrl` 地址正确
- [ ] `selfsevice` 中包含 `/undefined` 处理配置
- [ ] 所有需要的服务都在 `selfsevice` 中配置
- [ ] `App.vue` 中 `services` 配置正确
- [ ] 微信开发者工具关闭域名校验

### 📱 调用检查清单

- [ ] 调用 `uni.sm` 时必须传递 `route` 参数
- [ ] `route` 参数值必须在配置中存在
- [ ] 使用 `uni.svs.xxx` 时确保对应配置存在
- [ ] 本地开发时确保服务器在正确端口运行

### 🐛 调试检查清单

- [ ] 添加详细的控制台日志
- [ ] 检查网络面板中的实际请求URL
- [ ] 验证后端服务器日志
- [ ] 测试不同环境下的表现差异

------

## 🎯 总结

本文档详细介绍了 uni-app 项目中微服务路由配置的完整流程，特别针对本地开发环境的配置要点。关键要记住：

1. **route 参数是必需的**，用于标识要调用的微服务
2. **本地开发时所有服务可以统一配置到同一个端口**
3. **必须处理 route 为 undefined 的异常情况**
4. **uni.svs.auth 是唯一配置的服务映射，使用时要注意**
5. **H5 和小程序环境的请求机制不同，需要分别配置**

遵循本文档的配置规范和最佳实践，可以有效避免接口请求失败的问题，提高开发效率。