## å‘é€çŸ­ä¿¡

å‚è€ƒ æ¶ˆæ¯   wx.app.smssend   æ¶ˆæ¯ç±»å‹myrule

é¦–å…ˆåœ¨xmlæ–‡ä»¶ä¸­é…ç½®å¥½ç›¸åº”çš„æ¶ˆæ¯

### wx.app.smssend

![image-20250930111755585](04.å‘é€çŸ­ä¿¡.assets/image-20250930111755585.png)

å°±å½“æ˜¯è‡ªå·±å»å­¦ä¹ ä¼ä¸šçš„çŸ­ä¿¡é…ç½®

![image-20250930111709528](04.å‘é€çŸ­ä¿¡.assets/image-20250930111709528.png)

## å‘é€å®ç°æ–¹æ³•

```java
public static String sendvcode(String captchaVerification, String mobile, HttpServletRequest request) {
    JSONObject objre = new JSONObject();
    log.info("sendvcode");
    log.info("è¯·æ±‚å‚æ•°ï¼šcaptchaVerification: {}, mobile: {}", captchaVerification, mobile);
    try {
        if (StringUtil.isNull(captchaVerification) || StringUtil.isNull(mobile)) {
            log.error("è¯·æ±‚å‚æ•°é”™è¯¯");
            objre.put("error", "è¯·æ±‚å‚æ•°é”™è¯¯");
        }
        //1ã€éªŒè¯å›¾å½¢éªŒè¯ç æ˜¯å¦é€šè¿‡
        CaptchaVO captchaVO = new CaptchaVO();
        captchaVO.setCaptchaVerification(captchaVerification);
        CaptchaService captchaService = SpringContextUtil.getBean(CaptchaService.class);
        ResponseModel responseModel = captchaService.verification(captchaVO);
        if (!responseModel.isSuccess()) {
            log.error("å›¾å½¢éªŒè¯ç ä¸é€šè¿‡ï¼Œ{}", responseModel.getRepMsg());
            objre.put("error", responseModel.getRepMsg());
        }
        //2ã€ç”ŸæˆçŸ­ä¿¡éªŒè¯ç 
        int randNum = (int) ((Math.random() * 9 + 1) * 100000);
        String valCode = String.valueOf(randNum);
        JSONObject param = new JSONObject();
        param.put("code", valCode);
        param.put("product", "UIDå°ç¨‹åº");
        param.put("mobile", mobile);
        param.put("smsid", "logincode");
        String isok = "200";//send_sms(param, "zxx");
        log.info("å‘é€éªŒè¯ç ç»“æœï¼šmobileï¼š{}ï¼Œisokï¼š {}ï¼ŒvalCodeï¼š {}", mobile, isok, valCode);
        if ("200".equals(isok)) {
            RedisUtils redisUtils = SpringContextUtil.getBean(RedisUtils.class);
            redisUtils.setCacheObject("uid_sms_" + mobile, valCode, 5 * 60, TimeUnit.SECONDS);
            objre.put("success", "éªŒè¯ç å·²å‘é€");
            objre.put("mcode", valCode);
        } else {
            if (isok.equals("15")) {
                objre.put("error", "ä¸æ˜¯åˆæ³•çš„æ‰‹æœºå·");
            }
            objre.put("error", "éªŒè¯ç å‘é€å¤±è´¥");
        }
    } catch (Exception e) {
        log.error("å‘é€çŸ­ä¿¡éªŒè¯ç å¼‚å¸¸");
        log.error(e.getMessage() + ",{}", e);
        objre.put("error", "å‘é€çŸ­ä¿¡éªŒè¯ç å¼‚å¸¸");
    }
    return objre.toString();
}

public static String send_sms(JSONObject param, String sys) {
    Map<String, String> headers = new HashMap<>();
    headers.put("Content-Type", "application/json");
    String resultstr = HttpUtil.doPost(headers, Global.map.get("smsAddress") + "?sys=" + sys, param);
    if (StringUtil.notNull(resultstr)) {
        JSONObject resObi = new JSONObject(resultstr);
        return resObi.optString("code");
    } else {
        return "500";
    }
}
```

### æ•´ä½“æµç¨‹æ¦‚è¿°

è¿™æ®µä»£ç å®ç°äº†ä¸€ä¸ªå…¸å‹çš„"å›¾å½¢éªŒè¯ç  + çŸ­ä¿¡éªŒè¯ç "çš„äºŒæ¬¡éªŒè¯æœºåˆ¶ï¼Œä¸»è¦åˆ†ä¸ºä»¥ä¸‹å‡ ä¸ªé˜¶æ®µï¼š

------

### ç¬¬ä¸€é˜¶æ®µï¼šå‚æ•°æ ¡éªŒ

```java
if (StringUtil.isNull(captchaVerification) || StringUtil.isNull(mobile)) {
    log.error("è¯·æ±‚å‚æ•°é”™è¯¯");
    objre.put("error", "è¯·æ±‚å‚æ•°é”™è¯¯");
}
```

- éªŒè¯å¿…ä¼ å‚æ•°ï¼šå›¾å½¢éªŒè¯ç å‡­è¯ï¼ˆ`captchaVerification`ï¼‰å’Œæ‰‹æœºå·ï¼ˆ`mobile`ï¼‰
- å¦‚æœä»»ä¸€å‚æ•°ä¸ºç©ºï¼Œç›´æ¥è¿”å›é”™è¯¯

------

### ç¬¬äºŒé˜¶æ®µï¼šå›¾å½¢éªŒè¯ç éªŒè¯

```java
CaptchaVO captchaVO = new CaptchaVO();
captchaVO.setCaptchaVerification(captchaVerification);
CaptchaService captchaService = SpringContextUtil.getBean(CaptchaService.class);
ResponseModel responseModel = captchaService.verification(captchaVO);
```

**ç›®çš„**ï¼šé˜²æ­¢æ¶æ„ç¨‹åºè‡ªåŠ¨åŒ–æ”»åˆ·çŸ­ä¿¡æ¥å£

**æµç¨‹**ï¼š

1. åˆ›å»ºå›¾å½¢éªŒè¯ç éªŒè¯å¯¹è±¡
2. é€šè¿‡ Spring å®¹å™¨è·å–éªŒè¯æœåŠ¡
3. è°ƒç”¨éªŒè¯æ¥å£æ£€æŸ¥ç”¨æˆ·æäº¤çš„å›¾å½¢éªŒè¯ç æ˜¯å¦æ­£ç¡®
4. å¦‚æœéªŒè¯å¤±è´¥ï¼Œè¿”å›é”™è¯¯ä¿¡æ¯ï¼Œ**ç»ˆæ­¢åç»­æµç¨‹**

------

### ç¬¬ä¸‰é˜¶æ®µï¼šç”ŸæˆçŸ­ä¿¡éªŒè¯ç 

```java
int randNum = (int) ((Math.random() * 9 + 1) * 100000);
String valCode = String.valueOf(randNum);
```

**ç”Ÿæˆé€»è¾‘**ï¼š

- `Math.random() * 9 + 1` ç”Ÿæˆ [1, 10) çš„éšæœºæ•°
- ä¹˜ä»¥ 100000 å¾—åˆ° [100000, 1000000) çš„æ•´æ•°
- ç»“æœæ˜¯ä¸€ä¸ª **6ä½æ•°å­—éªŒè¯ç **ï¼ˆä¾‹å¦‚ï¼š123456ï¼‰

------

### ç¬¬å››é˜¶æ®µï¼šå‡†å¤‡çŸ­ä¿¡å‚æ•°

```java
JSONObject param = new JSONObject();
param.put("code", valCode);           // éªŒè¯ç 
param.put("product", "UIDå°ç¨‹åº");    // äº§å“åç§°
param.put("mobile", mobile);          // ç›®æ ‡æ‰‹æœºå·
param.put("smsid", "logincode");      // çŸ­ä¿¡æ¨¡æ¿ID
```

è¿™äº›å‚æ•°ä¼šè¢«ä¼ é€’ç»™çŸ­ä¿¡å‘é€æ¥å£ï¼Œç”¨äºï¼š

- æŒ‡å®šéªŒè¯ç å†…å®¹
- æ ‡è¯†å‘é€æ–¹ï¼ˆäº§å“åç§°ï¼‰
- æŒ‡å®šæ¥æ”¶æ–¹ï¼ˆæ‰‹æœºå·ï¼‰
- é€‰æ‹©çŸ­ä¿¡æ¨¡æ¿ï¼ˆlogincode å¯¹åº”ç™»å½•éªŒè¯ç æ¨¡æ¿ï¼‰

------

### ç¬¬äº”é˜¶æ®µï¼šè°ƒç”¨çŸ­ä¿¡å‘é€æ¥å£

```java
String isok = "200";//send_sms(param, "zxx");
```

**æ³¨æ„**ï¼šä»£ç ä¸­æ³¨é‡Šæ‰äº†å®é™…è°ƒç”¨ï¼Œç›´æ¥è¿”å› "200"ï¼ˆæˆåŠŸï¼‰

#### `send_sms` æ–¹æ³•è¯¦è§£ï¼š

```java
public static String send_sms(JSONObject param, String sys) {
    Map<String, String> headers = new HashMap<>();
    headers.put("Content-Type", "application/json");
    
    // å‘é€HTTP POSTè¯·æ±‚åˆ°çŸ­ä¿¡ç½‘å…³
    String resultstr = HttpUtil.doPost(
        headers, 
        Global.map.get("smsAddress") + "?sys=" + sys, 
        param
    );
    
    // è§£æè¿”å›ç»“æœ
    if (StringUtil.notNull(resultstr)) {
        JSONObject resObi = new JSONObject(resultstr);
        return resObi.optString("code");  // è¿”å›çŠ¶æ€ç 
    } else {
        return "500";  // è¯·æ±‚å¤±è´¥
    }
}
```

**å·¥ä½œæµç¨‹**ï¼š

1. è®¾ç½® HTTP è¯·æ±‚å¤´ä¸º JSON æ ¼å¼
2. å‘çŸ­ä¿¡ç½‘å…³å‘é€ POST è¯·æ±‚ï¼ˆåœ°å€ä»å…¨å±€é…ç½®è¯»å–ï¼‰
3. æºå¸¦ç³»ç»Ÿæ ‡è¯†å‚æ•° `sys=zxx`
4. è§£æå“åº”ï¼Œæå–çŠ¶æ€ç 

------

### ç¬¬å…­é˜¶æ®µï¼šå¤„ç†å‘é€ç»“æœ

#### æˆåŠŸæƒ…å†µï¼ˆè¿”å›ç  = "200"ï¼‰

```java
if ("200".equals(isok)) {
    RedisUtils redisUtils = SpringContextUtil.getBean(RedisUtils.class);
    redisUtils.setCacheObject("uid_sms_" + mobile, valCode, 5 * 60, TimeUnit.SECONDS);
    objre.put("success", "éªŒè¯ç å·²å‘é€");
    objre.put("mcode", valCode);
}
```

**æ“ä½œ**ï¼š

1. å°†éªŒè¯ç å­˜å…¥ Redisï¼Œé”®åæ ¼å¼ï¼š`uid_sms_13800138000`
2. è®¾ç½® **5åˆ†é’Ÿè¿‡æœŸæ—¶é—´**ï¼ˆ300ç§’ï¼‰
3. è¿”å›æˆåŠŸæ¶ˆæ¯
4. **æ³¨æ„**ï¼šè¿”å›äº†æ˜æ–‡éªŒè¯ç  `mcode`ï¼ˆè¿™æ˜¯å®‰å…¨éšæ‚£ï¼Œè§ä¸‹æ–¹åˆ†æï¼‰

#### å¤±è´¥æƒ…å†µ

```java
else {
    if (isok.equals("15")) {
        objre.put("error", "ä¸æ˜¯åˆæ³•çš„æ‰‹æœºå·");
    }
    objre.put("error", "éªŒè¯ç å‘é€å¤±è´¥");
}
```

æ ¹æ®é”™è¯¯ç å¤„ç†ï¼š

- é”™è¯¯ç  "15"ï¼šæ‰‹æœºå·æ ¼å¼éæ³•
- å…¶ä»–é”™è¯¯ï¼šé€šç”¨å¤±è´¥æç¤º

------

### ç¬¬ä¸ƒé˜¶æ®µï¼šå¼‚å¸¸å¤„ç†

```java
catch (Exception e) {
    log.error("å‘é€çŸ­ä¿¡éªŒè¯ç å¼‚å¸¸");
    log.error(e.getMessage() + ",{}", e);
    objre.put("error", "å‘é€çŸ­ä¿¡éªŒè¯ç å¼‚å¸¸");
}
```

æ•è·æ‰€æœ‰å¼‚å¸¸å¹¶è®°å½•æ—¥å¿—ï¼Œè¿”å›ç»Ÿä¸€é”™è¯¯æç¤ºã€‚

------

## æµç¨‹å›¾æ€»ç»“

```
ç”¨æˆ·è¯·æ±‚
  â†“
å‚æ•°æ ¡éªŒï¼ˆcaptchaVerification + mobileï¼‰
  â†“
å›¾å½¢éªŒè¯ç éªŒè¯ â† é˜²æ­¢æœºå™¨äººæ”»å‡»
  â†“
ç”Ÿæˆ6ä½éšæœºéªŒè¯ç 
  â†“
è°ƒç”¨çŸ­ä¿¡ç½‘å…³å‘é€
  â†“
æˆåŠŸï¼Ÿ
  â”œâ”€ æ˜¯ â†’ å­˜å…¥Redisï¼ˆ5åˆ†é’Ÿï¼‰ â†’ è¿”å›æˆåŠŸ
  â””â”€ å¦ â†’ è¿”å›é”™è¯¯ä¿¡æ¯
```

------

## æ½œåœ¨é—®é¢˜ä¸å»ºè®®

### âš ï¸ å®‰å…¨é—®é¢˜

1. **è¿”å›æ˜æ–‡éªŒè¯ç **ï¼š`objre.put("mcode", valCode)` åœ¨ç”Ÿäº§ç¯å¢ƒåº”ç§»é™¤
2. **æ³¨é‡Šæ‰å®é™…å‘é€**ï¼š`String isok = "200";` åº”æ¢å¤ä¸ºçœŸå®è°ƒç”¨
3. **ç¼ºå°‘é¢‘ç‡é™åˆ¶**ï¼šæœªæ£€æŸ¥åŒä¸€æ‰‹æœºå·çš„å‘é€æ¬¡æ•°ï¼ˆå®¹æ˜“è¢«æ»¥ç”¨ï¼‰

### ğŸ”§ é€»è¾‘é—®é¢˜

1. **é”™è¯¯ç å¤„ç† bug**ï¼š

   ```java
   if (isok.equals("15")) {
       objre.put("error", "ä¸æ˜¯åˆæ³•çš„æ‰‹æœºå·");
   }
   objre.put("error", "éªŒè¯ç å‘é€å¤±è´¥"); // è¿™è¡Œä¼šè¦†ç›–ä¸Šé¢çš„é”™è¯¯
   ```

   åº”æ”¹ä¸º `else if`

2. **ç¼ºå°‘è¿”å›å€¼æ§åˆ¶**ï¼šå¤šä¸ªé”™è¯¯åˆ†æ”¯è®¾ç½®åä»ç»§ç»­æ‰§è¡Œï¼Œåº”åŠæ—¶ `return`

### ğŸ’¡ æ”¹è¿›å»ºè®®

- æ·»åŠ åŒä¸€æ‰‹æœºå·å‘é€é¢‘ç‡é™åˆ¶ï¼ˆå¦‚1åˆ†é’Ÿå†…åªèƒ½å‘é€1æ¬¡ï¼‰
- æ·»åŠ åŒä¸€IPçš„è¯·æ±‚é¢‘ç‡é™åˆ¶
- ç§»é™¤è¿”å›çš„æ˜æ–‡éªŒè¯ç 
- å¢å¼ºæ‰‹æœºå·æ ¼å¼æ ¡éªŒ
- å®Œå–„é”™è¯¯ç æ˜ å°„æœºåˆ¶

