# FastAPI å®Œæ•´å­¦ä¹ æŒ‡å—ï¼šä»åŸºç¡€åˆ°ä¼ä¸šçº§æ¶æ„

> åŸºäº FastAPI å®˜æ–¹æ¨¡æ¿å’Œå°ç±³ Miloco é¡¹ç›®æ¶æ„çš„æ·±åº¦å­¦ä¹ æŒ‡å—

------

## 1. FastAPI åŸºç¡€å…¥é—¨

### 1.1 ä»€ä¹ˆæ˜¯ FastAPIï¼Ÿ

FastAPI æ˜¯ä¸€ä¸ªç°ä»£ã€å¿«é€Ÿï¼ˆé«˜æ€§èƒ½ï¼‰çš„ Web æ¡†æ¶ï¼Œç”¨äºåŸºäº Python 3.8+ æ„å»º APIã€‚

**æ ¸å¿ƒç‰¹æ€§ï¼š**

- âš¡ **æé«˜æ€§èƒ½**ï¼šå¯ä¸ NodeJS å’Œ Go åª²ç¾ï¼ˆåŸºäº Starlette å’Œ Pydanticï¼‰
- ğŸ“ **è‡ªåŠ¨æ–‡æ¡£ç”Ÿæˆ**ï¼šè‡ªåŠ¨ç”Ÿæˆ OpenAPI (Swagger) å’Œ ReDoc æ–‡æ¡£
- ğŸ” **ç±»å‹æç¤º**ï¼šåŸºäº Python ç±»å‹æç¤ºï¼Œæä¾›æ™ºèƒ½ä»£ç è¡¥å…¨
- âœ… **æ•°æ®éªŒè¯**ï¼šä½¿ç”¨ Pydantic è¿›è¡Œè‡ªåŠ¨æ•°æ®éªŒè¯å’Œåºåˆ—åŒ–
- ğŸš€ **å¼‚æ­¥æ”¯æŒ**ï¼šåŸç”Ÿæ”¯æŒ async/await
- ğŸ“¦ **ç”Ÿäº§å¯ç”¨**ï¼šå¼€ç®±å³ç”¨çš„ç”Ÿäº§çº§ç‰¹æ€§

### 1.2 ç¯å¢ƒå®‰è£…

```bash
# æ£€æŸ¥ Python ç‰ˆæœ¬ï¼ˆéœ€è¦ 3.8+ï¼‰
python --version

# å®‰è£… FastAPI
pip install fastapi

# å®‰è£… ASGI æœåŠ¡å™¨ï¼ˆUvicornï¼‰
pip install "uvicorn[standard]"

# æˆ–è€…ä¸€æ¬¡æ€§å®‰è£…æ‰€æœ‰ä¾èµ–
pip install "fastapi[all]"
```

### 1.3 Hello World

åˆ›å»º `main.py` æ–‡ä»¶ï¼š

```python
from fastapi import FastAPI

app = FastAPI()

@app.get("/")
def read_root():
    return {"message": "Hello World"}

@app.get("/items/{item_id}")
def read_item(item_id: int, q: str = None):
    return {"item_id": item_id, "q": q}
```

è¿è¡Œåº”ç”¨ï¼š

```bash
uvicorn main:app --reload
```

![image-20251211143456585](00.fastApi(Basic).assets/image-20251211143456585.png)

è®¿é—®ï¼š

- API: http://127.0.0.1:8000

  ![image-20251211143222551](00.fastApi(Basic).assets/image-20251211143222551.png)

- äº¤äº’å¼æ–‡æ¡£: http://127.0.0.1:8000/docs

  ![image-20251211143258262](00.fastApi(Basic).assets/image-20251211143258262.png)

- å¤‡ç”¨æ–‡æ¡£: http://127.0.0.1:8000/redoc

  ![image-20251211143422045](00.fastApi(Basic).assets/image-20251211143422045.png)

------

## 2. æ ¸å¿ƒæ¦‚å¿µä¸è¯­æ³•

### 2.1 è·¯å¾„æ“ä½œï¼ˆPath Operationsï¼‰

FastAPI ä½¿ç”¨è£…é¥°å™¨æ¥å®šä¹‰è·¯å¾„æ“ä½œï¼š

```python
from fastapi import FastAPI

app = FastAPI()

# GET è¯·æ±‚
@app.get("/users")
async def list_users():
    return {"users": []}

# POST è¯·æ±‚
@app.post("/users")
async def create_user(name: str, email: str):
    return {"name": name, "email": email}

# PUT è¯·æ±‚
@app.put("/users/{user_id}")
async def update_user(user_id: int, name: str):
    return {"user_id": user_id, "name": name}

# DELETE è¯·æ±‚
@app.delete("/users/{user_id}")
async def delete_user(user_id: int):
    return {"deleted": user_id}
```

### 2.2 è·¯å¾„å‚æ•°ï¼ˆPath Parametersï¼‰

```python
from fastapi import FastAPI, Path

app = FastAPI()

@app.get("/items/{item_id}")
async def read_item(
    item_id: int = Path(..., title="The ID of the item", ge=1)
):
    return {"item_id": item_id}

# ä½¿ç”¨æšä¸¾é™åˆ¶å‚æ•°å€¼
from enum import Enum

class ModelName(str, Enum):
    alexnet = "alexnet"
    resnet = "resnet"
    lenet = "lenet"

@app.get("/models/{model_name}")
async def get_model(model_name: ModelName):
    return {"model_name": model_name, "message": "Deep Learning FTW!"}
```

### 2.3 æŸ¥è¯¢å‚æ•°ï¼ˆQuery Parametersï¼‰

```python
from typing import Optional
from fastapi import FastAPI, Query

app = FastAPI()

@app.get("/items/")
async def read_items(
    skip: int = 0,
    limit: int = Query(10, ge=1, le=100),
    q: Optional[str] = Query(None, min_length=3, max_length=50)
):
    return {"skip": skip, "limit": limit, "q": q}
```

### 2.4 è¯·æ±‚ä½“ï¼ˆRequest Bodyï¼‰ä¸ [Pydantic æ¨¡å‹](./01.Pydanticæ¨¡å‹.md)

```python
from fastapi import FastAPI
from pydantic import BaseModel, Field, EmailStr
from typing import Optional
from datetime import datetime

app = FastAPI()

class User(BaseModel):
    username: str = Field(..., min_length=3, max_length=50)
    email: EmailStr
    full_name: Optional[str] = None
    age: int = Field(..., ge=0, le=150)
    created_at: datetime = Field(default_factory=datetime.utcnow)
    
    class Config:
        json_schema_extra = {
            "example": {
                "username": "johndoe",
                "email": "johndoe@example.com",
                "full_name": "John Doe",
                "age": 25
            }
        }

@app.post("/users/", response_model=User)
async def create_user(user: User):
    return user
```

### 2.5 å“åº”æ¨¡å‹ï¼ˆResponse Modelï¼‰

```python
from fastapi import FastAPI
from pydantic import BaseModel
from typing import List

app = FastAPI()

class Item(BaseModel):
    name: str
    description: Optional[str] = None
    price: float
    tax: Optional[float] = None

class ItemResponse(BaseModel):
    name: str
    price: float

# æŒ‡å®šå“åº”æ¨¡å‹
@app.post("/items/", response_model=ItemResponse)
async def create_item(item: Item):
    return item

# è¿”å›åˆ—è¡¨
@app.get("/items/", response_model=List[ItemResponse])
async def list_items():
    return [
        {"name": "Item 1", "price": 10.5},
        {"name": "Item 2", "price": 20.0}
    ]
```

### 2.6 ä¾èµ–æ³¨å…¥ï¼ˆDependency Injectionï¼‰

```python
from fastapi import FastAPI, Depends, HTTPException
from typing import Optional

app = FastAPI()

# ç®€å•ä¾èµ–
async def common_parameters(q: Optional[str] = None, skip: int = 0, limit: int = 100):
    return {"q": q, "skip": skip, "limit": limit}

@app.get("/items/")
async def read_items(commons: dict = Depends(common_parameters)):
    return commons

# ç±»ä¾èµ–
class CommonQueryParams:
    def __init__(self, q: Optional[str] = None, skip: int = 0, limit: int = 100):
        self.q = q
        self.skip = skip
        self.limit = limit

@app.get("/users/")
async def read_users(commons: CommonQueryParams = Depends()):
    return commons

# æ•°æ®åº“ä¾èµ–ç¤ºä¾‹
def get_db():
    db = SessionLocal()
    try:
        yield db
    finally:
        db.close()

@app.get("/users/{user_id}")
async def get_user(user_id: int, db: Session = Depends(get_db)):
    user = db.query(User).filter(User.id == user_id).first()
    if not user:
        raise HTTPException(status_code=404, detail="User not found")
    return user
```

### 2.7 ä¸­é—´ä»¶ï¼ˆMiddlewareï¼‰

```python
from fastapi import FastAPI, Request
from fastapi.middleware.cors import CORSMiddleware
import time

app = FastAPI()

# CORS ä¸­é—´ä»¶
app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

# è‡ªå®šä¹‰ä¸­é—´ä»¶
@app.middleware("http")
async def add_process_time_header(request: Request, call_next):
    start_time = time.time()
    response = await call_next(request)
    process_time = time.time() - start_time
    response.headers["X-Process-Time"] = str(process_time)
    return response
```

### 2.8 å¼‚æ­¥ä¸åŒæ­¥

```python
from fastapi import FastAPI
import asyncio

app = FastAPI()

# åŒæ­¥å‡½æ•°ï¼ˆä¼šåœ¨çº¿ç¨‹æ± ä¸­è¿è¡Œï¼‰
@app.get("/sync")
def sync_endpoint():
    # é˜»å¡æ“ä½œ
    return {"message": "Sync"}

# å¼‚æ­¥å‡½æ•°ï¼ˆæ¨èç”¨äº I/O æ“ä½œï¼‰
@app.get("/async")
async def async_endpoint():
    # éé˜»å¡æ“ä½œ
    await asyncio.sleep(1)
    return {"message": "Async"}

# æ•°æ®åº“æ“ä½œ
@app.get("/users/{user_id}")
async def get_user(user_id: int, db: Session = Depends(get_db)):
    # å¦‚æœä½¿ç”¨å¼‚æ­¥æ•°æ®åº“é©±åŠ¨
    user = await db.execute(select(User).where(User.id == user_id))
    return user.scalar_one()
```

------

## 3. ä¼ä¸šçº§é¡¹ç›®æ¶æ„

åœ¨ä¼ä¸šå®è·µä¸­,**ä¸åŒå…¬å¸ä¼šæ ¹æ®è‡ªå·±çš„æŠ€æœ¯æ ˆå’Œä¸šåŠ¡éœ€æ±‚é‡‡ç”¨ä¸åŒçš„ç›®å½•ç»“æ„**ã€‚ä¸‹é¢åˆ†åˆ«ä»‹ç»ä¸¤ç§å…¸å‹çš„ä¼ä¸šçº§æ¶æ„ï¼š

### 3.1 FastAPI å®˜æ–¹å…¨æ ˆæ¨¡æ¿æ¶æ„

[FastAPI å®˜æ–¹æä¾›çš„ç”Ÿäº§çº§å…¨æ ˆæ¨¡æ¿](https://github.com/fastapi/full-stack-fastapi-template)ï¼Œé€‚åˆå¿«é€Ÿæ„å»ºç°ä»£ Web åº”ç”¨ã€‚

#### æ•´ä½“é¡¹ç›®ç»“æ„

```
full-stack-fastapi-template/
â”œâ”€â”€ .github/
â”‚   â””â”€â”€ workflows/              # GitHub Actions CI/CD
â”‚       â”œâ”€â”€ test.yml
â”‚       â”œâ”€â”€ deploy.yml
â”‚       â””â”€â”€ preview.yml
â”œâ”€â”€ backend/                    # FastAPI åç«¯
â”‚   â”œâ”€â”€ app/
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ main.py            # FastAPI åº”ç”¨å…¥å£
â”‚   â”‚   â”œâ”€â”€ alembic/           # æ•°æ®åº“è¿ç§»
â”‚   â”‚   â”‚   â”œâ”€â”€ versions/
â”‚   â”‚   â”‚   â””â”€â”€ env.py
â”‚   â”‚   â”œâ”€â”€ api/               # API è·¯ç”±
â”‚   â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”‚   â”œâ”€â”€ deps.py        # ä¾èµ–æ³¨å…¥
â”‚   â”‚   â”‚   â”œâ”€â”€ main.py        # è·¯ç”±æ±‡æ€»
â”‚   â”‚   â”‚   â””â”€â”€ routes/        # å…·ä½“è·¯ç”±
â”‚   â”‚   â”‚       â”œâ”€â”€ items.py
â”‚   â”‚   â”‚       â”œâ”€â”€ login.py
â”‚   â”‚   â”‚       â”œâ”€â”€ users.py
â”‚   â”‚   â”‚       â””â”€â”€ utils.py
â”‚   â”‚   â”œâ”€â”€ core/              # æ ¸å¿ƒé…ç½®
â”‚   â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”‚   â”œâ”€â”€ config.py      # é…ç½®ç®¡ç†
â”‚   â”‚   â”‚   â”œâ”€â”€ db.py          # æ•°æ®åº“è¿æ¥
â”‚   â”‚   â”‚   â””â”€â”€ security.py    # å®‰å…¨ç›¸å…³
â”‚   â”‚   â”œâ”€â”€ crud.py            # CRUD æ“ä½œï¼ˆç±»ä¼¼ DAOï¼‰
â”‚   â”‚   â”œâ”€â”€ models.py          # SQLModel æ•°æ®åº“æ¨¡å‹
â”‚   â”‚   â”œâ”€â”€ schemas.py         # Pydantic è¯·æ±‚/å“åº”æ¨¡å‹
â”‚   â”‚   â”œâ”€â”€ email-templates/   # é‚®ä»¶æ¨¡æ¿
â”‚   â”‚   â”‚   â”œâ”€â”€ build/
â”‚   â”‚   â”‚   â””â”€â”€ src/
â”‚   â”‚   â””â”€â”€ tests/             # æµ‹è¯•æ–‡ä»¶
â”‚   â”‚       â”œâ”€â”€ api/
â”‚   â”‚       â”œâ”€â”€ crud/
â”‚   â”‚       â””â”€â”€ utils/
â”‚   â”œâ”€â”€ pyproject.toml         # Python é¡¹ç›®é…ç½®
â”‚   â”œâ”€â”€ requirements.txt
â”‚   â””â”€â”€ Dockerfile
â”œâ”€â”€ frontend/                   # React å‰ç«¯
â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”œâ”€â”€ client/            # è‡ªåŠ¨ç”Ÿæˆçš„ API å®¢æˆ·ç«¯
â”‚   â”‚   â”œâ”€â”€ components/        # React ç»„ä»¶
â”‚   â”‚   â”œâ”€â”€ hooks/             # è‡ªå®šä¹‰ Hooks
â”‚   â”‚   â”œâ”€â”€ routes/            # è·¯ç”±é…ç½®
â”‚   â”‚   â””â”€â”€ main.tsx
â”‚   â”œâ”€â”€ package.json
â”‚   â”œâ”€â”€ vite.config.ts
â”‚   â””â”€â”€ Dockerfile
â”œâ”€â”€ scripts/                    # å·¥å…·è„šæœ¬
â”‚   â”œâ”€â”€ format.sh
â”‚   â”œâ”€â”€ lint.sh
â”‚   â””â”€â”€ test.sh
â”œâ”€â”€ docker-compose.yml          # Docker Compose é…ç½®
â”œâ”€â”€ docker-compose.override.yml # å¼€å‘ç¯å¢ƒè¦†ç›–
â”œâ”€â”€ .env                        # ç¯å¢ƒå˜é‡
â””â”€â”€ README.md
```

#### åç«¯æ ¸å¿ƒæ–‡ä»¶è¯´æ˜

**1. main.py - åº”ç”¨å…¥å£**

```python
from fastapi import FastAPI
from fastapi.routing import APIRouter
from app.core.config import settings
from app.api.main import api_router

app = FastAPI(
    title=settings.PROJECT_NAME,
    openapi_url=f"{settings.API_V1_STR}/openapi.json"
)

# åŒ…å« API è·¯ç”±
app.include_router(api_router, prefix=settings.API_V1_STR)
```

**2. crud.py - æ•°æ®è®¿é—®å±‚ï¼ˆç±»ä¼¼ Java DAOï¼‰**

```python
from sqlmodel import Session, select
from app.models import User, Item

def get_user(*, session: Session, user_id: int) -> User | None:
    return session.get(User, user_id)

def get_users(*, session: Session, skip: int = 0, limit: int = 100):
    return session.exec(select(User).offset(skip).limit(limit)).all()

def create_user(*, session: Session, user_create):
    db_user = User.model_validate(user_create)
    session.add(db_user)
    session.commit()
    session.refresh(db_user)
    return db_user
```

**3. models.py - æ•°æ®åº“æ¨¡å‹**

```python
from sqlmodel import Field, SQLModel

class UserBase(SQLModel):
    email: str = Field(unique=True, index=True)
    full_name: str | None = None

class User(UserBase, table=True):
    id: int | None = Field(default=None, primary_key=True)
    hashed_password: str
```

**4. schemas.py - API è¯·æ±‚/å“åº”æ¨¡å‹**

```python
from pydantic import BaseModel

class UserCreate(UserBase):
    password: str

class UserPublic(UserBase):
    id: int
```

**æ¶æ„ç‰¹ç‚¹ï¼š**

- âœ… **ç®€æ´ç›´æ¥**ï¼šCRUD æ“ä½œç›´æ¥åœ¨ crud.py ä¸­å®ç°ï¼Œæ— é¢å¤–åˆ†å±‚
- âœ… **SQLModel**ï¼šç»Ÿä¸€æ•°æ®åº“æ¨¡å‹å’Œ Pydantic æ¨¡å‹
- âœ… **å‡½æ•°å¼é£æ ¼**ï¼šä½¿ç”¨å‡½æ•°è€Œéç±»æ¥ç»„ç»‡ä»£ç 
- âœ… **è‡ªåŠ¨åŒ–ç¨‹åº¦é«˜**ï¼šè‡ªåŠ¨ç”Ÿæˆå‰ç«¯ API å®¢æˆ·ç«¯
- âœ… **å…¨æ ˆé›†æˆ**ï¼šå‰åç«¯åœ¨ä¸€ä¸ªä»“åº“ä¸­ï¼Œä¾¿äºç®¡ç†

------

### 3.2 å°ç±³ Miloco ä¼ä¸šçº§æ¶æ„ï¼ˆç±»ä¼¼ Java åˆ†å±‚ï¼‰

**å°ç±³ Miloco é¡¹ç›®é‡‡ç”¨äº†æ›´æ¥è¿‘ä¼ ç»Ÿä¼ä¸šçº§ Java é¡¹ç›®çš„åˆ†å±‚æ¶æ„ï¼Œç‰¹åˆ«é€‚åˆå¤§å‹å¤æ‚é¡¹ç›®ã€‚**

[xiaomi-miloco](https://github.com/XiaoMi/xiaomi-miloco)

#### æ•´ä½“é¡¹ç›®ç»“æ„

![image-20251211150116423](00.fastApi(Basic).assets/image-20251211150116423.png)

```
xiaomi-miloco/
â”œâ”€â”€ .github/
â”‚   â””â”€â”€ workflows/              # CI/CD
â”œâ”€â”€ config/                     # é…ç½®æ–‡ä»¶ç›®å½•
â”‚   â”œâ”€â”€ default_config.yaml
â”‚   â”œâ”€â”€ dev_config.yaml
â”‚   â””â”€â”€ prod_config.yaml
â”œâ”€â”€ docker/                     # Docker ç›¸å…³
â”‚   â”œâ”€â”€ Dockerfile
â”‚   â”œâ”€â”€ docker-compose.yml
â”‚   â””â”€â”€ nginx/
â”œâ”€â”€ docs/                       # é¡¹ç›®æ–‡æ¡£
â”‚   â”œâ”€â”€ api/
â”‚   â”œâ”€â”€ development/
â”‚   â””â”€â”€ usage/
â”œâ”€â”€ miloco_server/              # ä¸»æœåŠ¡ï¼ˆFastAPIï¼‰
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ main.py                # åº”ç”¨å…¥å£
â”‚   â”œâ”€â”€ api/                   # API å±‚ï¼ˆç±»ä¼¼ Controllerï¼‰
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ v1/                # API ç‰ˆæœ¬ç®¡ç†
â”‚   â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”‚   â”œâ”€â”€ endpoints/     # ç«¯ç‚¹æ§åˆ¶å™¨
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ chat.py
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ device.py
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ scene.py
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ video.py
â”‚   â”‚   â”‚   â””â”€â”€ router.py
â”‚   â”‚   â””â”€â”€ deps.py            # ä¾èµ–æ³¨å…¥
â”‚   â”œâ”€â”€ service/               # ä¸šåŠ¡é€»è¾‘å±‚ï¼ˆServiceï¼‰
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ chat_service.py
â”‚   â”‚   â”œâ”€â”€ device_service.py
â”‚   â”‚   â”œâ”€â”€ scene_service.py
â”‚   â”‚   â””â”€â”€ video_service.py
â”‚   â”œâ”€â”€ dao/                   # æ•°æ®è®¿é—®å±‚ï¼ˆDAOï¼‰
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ base_dao.py        # åŸºç¡€ DAO
â”‚   â”‚   â”œâ”€â”€ device_dao.py
â”‚   â”‚   â”œâ”€â”€ scene_dao.py
â”‚   â”‚   â””â”€â”€ user_dao.py
â”‚   â”œâ”€â”€ models/                # æ•°æ®åº“æ¨¡å‹ï¼ˆEntityï¼‰
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ device.py
â”‚   â”‚   â”œâ”€â”€ scene.py
â”‚   â”‚   â””â”€â”€ user.py
â”‚   â”œâ”€â”€ schemas/               # Pydantic æ¨¡å‹ï¼ˆDTOï¼‰
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ request/           # è¯·æ±‚ DTO
â”‚   â”‚   â”‚   â”œâ”€â”€ chat_req.py
â”‚   â”‚   â”‚   â”œâ”€â”€ device_req.py
â”‚   â”‚   â”‚   â””â”€â”€ scene_req.py
â”‚   â”‚   â””â”€â”€ response/          # å“åº” DTO
â”‚   â”‚       â”œâ”€â”€ chat_resp.py
â”‚   â”‚       â”œâ”€â”€ device_resp.py
â”‚   â”‚       â””â”€â”€ scene_resp.py
â”‚   â”œâ”€â”€ core/                  # æ ¸å¿ƒæ¨¡å—
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ config.py          # é…ç½®ç®¡ç†
â”‚   â”‚   â”œâ”€â”€ database.py        # æ•°æ®åº“è¿æ¥
â”‚   â”‚   â”œâ”€â”€ security.py        # å®‰å…¨ç›¸å…³
â”‚   â”‚   â”œâ”€â”€ exceptions.py      # è‡ªå®šä¹‰å¼‚å¸¸
â”‚   â”‚   â””â”€â”€ middleware.py      # ä¸­é—´ä»¶
â”‚   â”œâ”€â”€ utils/                 # å·¥å…·ç±»
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ logger.py
â”‚   â”‚   â”œâ”€â”€ validators.py
â”‚   â”‚   â””â”€â”€ helpers.py
â”‚   â””â”€â”€ constants/             # å¸¸é‡å®šä¹‰
â”‚       â”œâ”€â”€ __init__.py
â”‚       â”œâ”€â”€ error_codes.py
â”‚       â””â”€â”€ enums.py
â”œâ”€â”€ miloco_ai_engine/          # AI å¼•æ“æ¨¡å—
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ models/                # AI æ¨¡å‹ç®¡ç†
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ loader.py
â”‚   â”‚   â””â”€â”€ cache.py
â”‚   â”œâ”€â”€ inference/             # æ¨ç†æœåŠ¡
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ text_inference.py
â”‚   â”‚   â”œâ”€â”€ video_inference.py
â”‚   â”‚   â””â”€â”€ vision_inference.py
â”‚   â”œâ”€â”€ preprocessing/         # æ•°æ®é¢„å¤„ç†
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ text_processor.py
â”‚   â”‚   â””â”€â”€ video_processor.py
â”‚   â””â”€â”€ postprocessing/        # åå¤„ç†
â”‚       â”œâ”€â”€ __init__.py
â”‚       â””â”€â”€ result_formatter.py
â”œâ”€â”€ miot_kit/                  # å°ç±³ IoT SDK å°è£…
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ client.py
â”‚   â”œâ”€â”€ device_manager.py
â”‚   â””â”€â”€ protocol/
â”œâ”€â”€ web_ui/                    # Web å‰ç«¯ï¼ˆReactï¼‰
â”‚   â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ public/
â”‚   â””â”€â”€ package.json
â”œâ”€â”€ tests/                     # æµ‹è¯•æ–‡ä»¶
â”‚   â”œâ”€â”€ unit/
â”‚   â”œâ”€â”€ integration/
â”‚   â””â”€â”€ e2e/
â”œâ”€â”€ scripts/                   # è„šæœ¬å·¥å…·
â”‚   â”œâ”€â”€ install.sh
â”‚   â”œâ”€â”€ deploy.sh
â”‚   â””â”€â”€ migrate.sh
â”œâ”€â”€ third_party/               # ç¬¬ä¸‰æ–¹ä¾èµ–
â”œâ”€â”€ requirements.txt
â”œâ”€â”€ pyproject.toml
â””â”€â”€ README.md
```

#### è¯¦ç»†åˆ†å±‚è¯´æ˜

**1. API å±‚ï¼ˆControllerï¼‰- ç±»ä¼¼ Java Controller**

```python
# miloco_server/api/v1/endpoints/device.py
from fastapi import APIRouter, Depends, HTTPException
from miloco_server.service.device_service import DeviceService
from miloco_server.schemas.request.device_req import DeviceControlRequest
from miloco_server.schemas.response.device_resp import DeviceResponse

router = APIRouter()

@router.post("/control", response_model=DeviceResponse)
async def control_device(
    request: DeviceControlRequest,
    device_service: DeviceService = Depends(get_device_service)
):
    """æ§åˆ¶è®¾å¤‡ï¼ˆç±»ä¼¼ Java Controller æ–¹æ³•ï¼‰"""
    try:
        result = await device_service.control_device(
            device_id=request.device_id,
            action=request.action,
            params=request.params
        )
        return DeviceResponse.from_entity(result)
    except Exception as e:
        raise HTTPException(status_code=500, detail=str(e))
```

**2. Service å±‚ - ä¸šåŠ¡é€»è¾‘å±‚**

```python
# miloco_server/service/device_service.py
from typing import List, Optional
from miloco_server.dao.device_dao import DeviceDAO
from miloco_server.models.device import Device
from miloco_server.core.exceptions import DeviceNotFoundException

class DeviceService:
    """è®¾å¤‡ä¸šåŠ¡é€»è¾‘æœåŠ¡ï¼ˆç±»ä¼¼ Java Serviceï¼‰"""
    
    def __init__(self, device_dao: DeviceDAO):
        self.device_dao = device_dao
    
    async def control_device(
        self,
        device_id: str,
        action: str,
        params: dict
    ) -> Device:
        """æ§åˆ¶è®¾å¤‡ä¸šåŠ¡é€»è¾‘"""
        # 1. æŸ¥è¯¢è®¾å¤‡
        device = await self.device_dao.get_by_id(device_id)
        if not device:
            raise DeviceNotFoundException(f"Device {device_id} not found")
        
        # 2. éªŒè¯è®¾å¤‡çŠ¶æ€
        if not device.is_online:
            raise DeviceOfflineException(f"Device {device_id} is offline")
        
        # 3. æ‰§è¡Œæ§åˆ¶é€»è¾‘
        result = await self._execute_control(device, action, params)
        
        # 4. æ›´æ–°è®¾å¤‡çŠ¶æ€
        device.last_action = action
        await self.device_dao.update(device)
        
        return device
    
    async def _execute_control(self, device, action, params):
        """å…·ä½“æ§åˆ¶é€»è¾‘"""
        # å¤æ‚çš„ä¸šåŠ¡é€»è¾‘
        pass
```

**3. DAO å±‚ - æ•°æ®è®¿é—®å±‚**

```python
# miloco_server/dao/device_dao.py
from typing import List, Optional
from sqlalchemy.orm import Session
from sqlalchemy import select
from miloco_server.models.device import Device

class DeviceDAO:
    """è®¾å¤‡æ•°æ®è®¿é—®å¯¹è±¡ï¼ˆç±»ä¼¼ Java DAOï¼‰"""
    
    def __init__(self, db: Session):
        self.db = db
    
    async def get_by_id(self, device_id: str) -> Optional[Device]:
        """æ ¹æ® ID æŸ¥è¯¢è®¾å¤‡"""
        stmt = select(Device).where(Device.id == device_id)
        result = await self.db.execute(stmt)
        return result.scalar_one_or_none()
    
    async def get_all(self, skip: int = 0, limit: int = 100) -> List[Device]:
        """æŸ¥è¯¢æ‰€æœ‰è®¾å¤‡"""
        stmt = select(Device).offset(skip).limit(limit)
        result = await self.db.execute(stmt)
        return result.scalars().all()
    
    async def create(self, device: Device) -> Device:
        """åˆ›å»ºè®¾å¤‡"""
        self.db.add(device)
        await self.db.commit()
        await self.db.refresh(device)
        return device
    
    async def update(self, device: Device) -> Device:
        """æ›´æ–°è®¾å¤‡"""
        await self.db.commit()
        await self.db.refresh(device)
        return device
    
    async def delete(self, device_id: str) -> bool:
        """åˆ é™¤è®¾å¤‡"""
        device = await self.get_by_id(device_id)
        if device:
            await self.db.delete(device)
            await self.db.commit()
            return True
        return False
```

**4. Models å±‚ - æ•°æ®åº“å®ä½“ï¼ˆEntityï¼‰**

```python
# miloco_server/models/device.py
from sqlalchemy import Column, String, Boolean, DateTime, Integer
from sqlalchemy.orm import declarative_base
from datetime import datetime

Base = declarative_base()

class Device(Base):
    """è®¾å¤‡å®ä½“ç±»ï¼ˆç±»ä¼¼ Java Entityï¼‰"""
    __tablename__ = "devices"
    
    id = Column(String(50), primary_key=True)
    name = Column(String(100), nullable=False)
    device_type = Column(String(50), nullable=False)
    model = Column(String(50))
    is_online = Column(Boolean, default=False)
    last_action = Column(String(100))
    created_at = Column(DateTime, default=datetime.utcnow)
    updated_at = Column(DateTime, onupdate=datetime.utcnow)
```

**5. Schemas å±‚ - DTOï¼ˆæ•°æ®ä¼ è¾“å¯¹è±¡ï¼‰**

```python
# miloco_server/schemas/request/device_req.py
from pydantic import BaseModel, Field
from typing import Optional, Dict

class DeviceControlRequest(BaseModel):
    """è®¾å¤‡æ§åˆ¶è¯·æ±‚ DTOï¼ˆç±»ä¼¼ Java Request DTOï¼‰"""
    device_id: str = Field(..., description="è®¾å¤‡ ID")
    action: str = Field(..., description="æ“ä½œåŠ¨ä½œ")
    params: Optional[Dict] = Field(default={}, description="æ“ä½œå‚æ•°")

# miloco_server/schemas/response/device_resp.py
class DeviceResponse(BaseModel):
    """è®¾å¤‡å“åº” DTOï¼ˆç±»ä¼¼ Java Response DTOï¼‰"""
    id: str
    name: str
    device_type: str
    is_online: bool
    
    @classmethod
    def from_entity(cls, device: Device):
        """ä» Entity è½¬æ¢ä¸º DTO"""
        return cls(
            id=device.id,
            name=device.name,
            device_type=device.device_type,
            is_online=device.is_online
        )
```

**æ¶æ„ç‰¹ç‚¹ï¼š**

- âœ… **ä¸¥æ ¼åˆ†å±‚**ï¼šController â†’ Service â†’ DAO â†’ Entityï¼ŒèŒè´£æ¸…æ™°
- âœ… **æ˜“äºç»´æŠ¤**ï¼šæ¯ä¸€å±‚ç‹¬ç«‹ï¼Œä¿®æ”¹ä¸å½±å“å…¶ä»–å±‚
- âœ… **åˆ©äºå›¢é˜Ÿåä½œ**ï¼šä¸åŒå±‚å¯ä»¥ç”±ä¸åŒå›¢é˜Ÿå¼€å‘
- âœ… **ä¾¿äºæµ‹è¯•**ï¼šæ¯å±‚å¯ä»¥ç‹¬ç«‹è¿›è¡Œå•å…ƒæµ‹è¯•
- âœ… **å¯æ‰©å±•æ€§å¼º**ï¼šä¾¿äºæ·»åŠ æ–°åŠŸèƒ½æ¨¡å—
- âœ… **Java å¼€å‘è€…å‹å¥½**ï¼šç»“æ„ä¸ Spring Boot ç±»ä¼¼

------

### 3.3 ä¸¤ç§æ¶æ„å¯¹æ¯”

| ç‰¹æ€§            | FastAPI å®˜æ–¹æ¨¡æ¿ | å°ç±³ Miloco æ¶æ„ |
| --------------- | ---------------- | ---------------- |
| **åˆ†å±‚å¤æ‚åº¦**  | ç®€å•ï¼ˆ2-3 å±‚ï¼‰   | å¤æ‚ï¼ˆ4-5 å±‚ï¼‰   |
| **é€‚ç”¨åœºæ™¯**    | ä¸­å°å‹é¡¹ç›®       | å¤§å‹ä¼ä¸šé¡¹ç›®     |
| **å­¦ä¹ æ›²çº¿**    | å¹³ç¼“             | è¾ƒé™¡             |
| **ä»£ç ç»„ç»‡**    | å‡½æ•°å¼ä¸ºä¸»       | ç±» + å‡½æ•°æ··åˆ    |
| **å›¢é˜Ÿè§„æ¨¡**    | 1-10 äºº          | 10+ äºº           |
| **Java ç›¸ä¼¼åº¦** | ä½               | é«˜               |
| **çµæ´»æ€§**      | é«˜               | ä¸­ç­‰             |
| **ç»´æŠ¤æˆæœ¬**    | ä½               | ä¸­ç­‰             |

### 3.4 é€‰æ‹©å»ºè®®

**é€‰æ‹© FastAPI å®˜æ–¹æ¨¡æ¿æ¶æ„ï¼Œå¦‚æœï¼š**

- ğŸ¯ é¡¹ç›®è§„æ¨¡ä¸­å°ï¼ˆ< 50 ä¸ª API ç«¯ç‚¹ï¼‰
- ğŸ¯ å›¢é˜Ÿåå¥½ Python é£æ ¼ï¼ˆå‡½æ•°å¼ï¼‰
- ğŸ¯ éœ€è¦å¿«é€Ÿè¿­ä»£å’ŒåŸå‹éªŒè¯
- ğŸ¯ å…¨æ ˆé¡¹ç›®ï¼ˆå‰åç«¯åœ¨ä¸€ä¸ªä»“åº“ï¼‰

**é€‰æ‹© Miloco åˆ†å±‚æ¶æ„ï¼Œå¦‚æœï¼š**

- ğŸ¯ å¤§å‹å¤æ‚é¡¹ç›®ï¼ˆ100+ API ç«¯ç‚¹ï¼‰
- ğŸ¯ å›¢é˜Ÿæœ‰ Java/Spring Boot èƒŒæ™¯
- ğŸ¯ éœ€è¦ä¸¥æ ¼çš„èŒè´£åˆ†ç¦»
- ğŸ¯ å¤šå›¢é˜Ÿåä½œå¼€å‘
- ğŸ¯ éœ€è¦é«˜åº¦å¯ç»´æŠ¤æ€§å’Œå¯æ‰©å±•æ€§

### 3.2 æ¨¡å—åŒ–è®¾è®¡åŸåˆ™

**æŒ‰åŠŸèƒ½åŸŸåˆ’åˆ†ï¼ˆæ¨èï¼‰ï¼š**

```
src/
â”œâ”€â”€ auth/                   # è®¤è¯æ¨¡å—
â”‚   â”œâ”€â”€ router.py
â”‚   â”œâ”€â”€ schemas.py
â”‚   â”œâ”€â”€ models.py
â”‚   â”œâ”€â”€ service.py
â”‚   â”œâ”€â”€ dependencies.py
â”‚   â”œâ”€â”€ config.py
â”‚   â”œâ”€â”€ constants.py
â”‚   â”œâ”€â”€ exceptions.py
â”‚   â””â”€â”€ utils.py
â”œâ”€â”€ users/                  # ç”¨æˆ·æ¨¡å—
â”‚   â”œâ”€â”€ router.py
â”‚   â”œâ”€â”€ schemas.py
â”‚   â”œâ”€â”€ models.py
â”‚   â”œâ”€â”€ service.py
â”‚   â””â”€â”€ ...
â”œâ”€â”€ posts/                  # æ–‡ç« æ¨¡å—
â”‚   â””â”€â”€ ...
â””â”€â”€ ai_engine/             # AI å¼•æ“æ¨¡å—
    â”œâ”€â”€ router.py
    â”œâ”€â”€ inference.py
    â”œâ”€â”€ models/
    â””â”€â”€ ...
```

**ä¼˜åŠ¿ï¼š**

- æ¯ä¸ªæ¨¡å—é«˜å†…èšã€ä½è€¦åˆ
- æ˜“äºå›¢é˜Ÿåä½œï¼ˆä¸åŒäººè´Ÿè´£ä¸åŒæ¨¡å—ï¼‰
- ä¾¿äºå¾®æœåŠ¡æ‹†åˆ†

------

## 4. ä»é›¶åˆ›å»º FastAPI é¡¹ç›®

### 4.1 åˆå§‹åŒ–é¡¹ç›®

```bash
# åˆ›å»ºé¡¹ç›®ç›®å½•
mkdir my-fastapi-project
cd my-fastapi-project

# åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ
python -m venv venv
source venv/bin/activate  # Windows: venv\Scripts\activate

# å®‰è£…ä¾èµ–
pip install fastapi uvicorn[standard] sqlalchemy pydantic-settings alembic
pip install python-jose[cryptography] passlib[bcrypt] python-multipart
pip install pytest pytest-asyncio httpx

# ä¿å­˜ä¾èµ–
pip freeze > requirements.txt
```

### 4.2 é…ç½®ç®¡ç†ï¼ˆsrc/core/config.pyï¼‰

```python
from pydantic_settings import BaseSettings
from typing import Optional

class Settings(BaseSettings):
    # åº”ç”¨é…ç½®
    PROJECT_NAME: str = "FastAPI Project"
    VERSION: str = "1.0.0"
    API_V1_STR: str = "/api/v1"
    
    # æœåŠ¡å™¨é…ç½®
    HOST: str = "0.0.0.0"
    PORT: int = 8000
    
    # æ•°æ®åº“é…ç½®
    DATABASE_URL: str = "postgresql://user:password@localhost/dbname"
    
    # å®‰å…¨é…ç½®
    SECRET_KEY: str = "your-secret-key-here"
    ALGORITHM: str = "HS256"
    ACCESS_TOKEN_EXPIRE_MINUTES: int = 30
    
    # CORS é…ç½®
    BACKEND_CORS_ORIGINS: list = ["http://localhost:3000"]
    
    # Redis é…ç½®ï¼ˆå¯é€‰ï¼‰
    REDIS_URL: Optional[str] = None
    
    class Config:
        env_file = ".env"
        case_sensitive = True

settings = Settings()
```

### 4.3 æ•°æ®åº“é…ç½®ï¼ˆsrc/core/database.pyï¼‰

```python
from sqlalchemy import create_engine
from sqlalchemy.ext.declarative import declarative_base
from sqlalchemy.orm import sessionmaker
from .config import settings

engine = create_engine(settings.DATABASE_URL, pool_pre_ping=True)
SessionLocal = sessionmaker(autocommit=False, autoflush=False, bind=engine)
Base = declarative_base()

def get_db():
    db = SessionLocal()
    try:
        yield db
    finally:
        db.close()
```

### 4.4 æ•°æ®æ¨¡å‹ï¼ˆsrc/models/user.pyï¼‰

```python
from sqlalchemy import Column, Integer, String, Boolean, DateTime
from sqlalchemy.sql import func
from ..core.database import Base

class User(Base):
    __tablename__ = "users"
    
    id = Column(Integer, primary_key=True, index=True)
    email = Column(String, unique=True, index=True, nullable=False)
    username = Column(String, unique=True, index=True, nullable=False)
    hashed_password = Column(String, nullable=False)
    is_active = Column(Boolean, default=True)
    is_superuser = Column(Boolean, default=False)
    created_at = Column(DateTime(timezone=True), server_default=func.now())
    updated_at = Column(DateTime(timezone=True), onupdate=func.now())
```

### 4.5 Pydantic Schemaï¼ˆsrc/schemas/user.pyï¼‰

```python
from pydantic import BaseModel, EmailStr, Field
from typing import Optional
from datetime import datetime

class UserBase(BaseModel):
    email: EmailStr
    username: str = Field(..., min_length=3, max_length=50)

class UserCreate(UserBase):
    password: str = Field(..., min_length=8)

class UserUpdate(BaseModel):
    email: Optional[EmailStr] = None
    username: Optional[str] = None
    password: Optional[str] = None

class UserInDB(UserBase):
    id: int
    is_active: bool
    is_superuser: bool
    created_at: datetime
    
    class Config:
        from_attributes = True

class User(UserInDB):
    pass
```

### 4.6 ä¸šåŠ¡é€»è¾‘å±‚ï¼ˆsrc/services/user_service.pyï¼‰

```python
from sqlalchemy.orm import Session
from typing import Optional, List
from ..models.user import User
from ..schemas.user import UserCreate, UserUpdate
from ..core.security import get_password_hash

class UserService:
    def __init__(self, db: Session):
        self.db = db
    
    def get_by_id(self, user_id: int) -> Optional[User]:
        return self.db.query(User).filter(User.id == user_id).first()
    
    def get_by_email(self, email: str) -> Optional[User]:
        return self.db.query(User).filter(User.email == email).first()
    
    def get_by_username(self, username: str) -> Optional[User]:
        return self.db.query(User).filter(User.username == username).first()
    
    def list(self, skip: int = 0, limit: int = 100) -> List[User]:
        return self.db.query(User).offset(skip).limit(limit).all()
    
    def create(self, user_in: UserCreate) -> User:
        db_user = User(
            email=user_in.email,
            username=user_in.username,
            hashed_password=get_password_hash(user_in.password)
        )
        self.db.add(db_user)
        self.db.commit()
        self.db.refresh(db_user)
        return db_user
    
    def update(self, user_id: int, user_in: UserUpdate) -> Optional[User]:
        db_user = self.get_by_id(user_id)
        if not db_user:
            return None
        
        update_data = user_in.dict(exclude_unset=True)
        if "password" in update_data:
            update_data["hashed_password"] = get_password_hash(update_data.pop("password"))
        
        for field, value in update_data.items():
            setattr(db_user, field, value)
        
        self.db.commit()
        self.db.refresh(db_user)
        return db_user
    
    def delete(self, user_id: int) -> bool:
        db_user = self.get_by_id(user_id)
        if not db_user:
            return False
        self.db.delete(db_user)
        self.db.commit()
        return True
```

### 4.7 API è·¯ç”±ï¼ˆsrc/api/v1/endpoints/users.pyï¼‰

```python
from fastapi import APIRouter, Depends, HTTPException, status
from sqlalchemy.orm import Session
from typing import List

from ....core.database import get_db
from ....schemas.user import User, UserCreate, UserUpdate
from ....services.user_service import UserService
from ....api.deps import get_current_user

router = APIRouter()

@router.get("/", response_model=List[User])
def list_users(
    skip: int = 0,
    limit: int = 100,
    db: Session = Depends(get_db)
):
    service = UserService(db)
    return service.list(skip=skip, limit=limit)

@router.post("/", response_model=User, status_code=status.HTTP_201_CREATED)
def create_user(
    user_in: UserCreate,
    db: Session = Depends(get_db)
):
    service = UserService(db)
    
    # æ£€æŸ¥é‚®ç®±æ˜¯å¦å·²å­˜åœ¨
    if service.get_by_email(user_in.email):
        raise HTTPException(
            status_code=status.HTTP_400_BAD_REQUEST,
            detail="Email already registered"
        )
    
    return service.create(user_in)

@router.get("/{user_id}", response_model=User)
def get_user(
    user_id: int,
    db: Session = Depends(get_db)
):
    service = UserService(db)
    user = service.get_by_id(user_id)
    if not user:
        raise HTTPException(
            status_code=status.HTTP_404_NOT_FOUND,
            detail="User not found"
        )
    return user

@router.put("/{user_id}", response_model=User)
def update_user(
    user_id: int,
    user_in: UserUpdate,
    db: Session = Depends(get_db),
    current_user: User = Depends(get_current_user)
):
    service = UserService(db)
    user = service.update(user_id, user_in)
    if not user:
        raise HTTPException(
            status_code=status.HTTP_404_NOT_FOUND,
            detail="User not found"
        )
    return user

@router.delete("/{user_id}", status_code=status.HTTP_204_NO_CONTENT)
def delete_user(
    user_id: int,
    db: Session = Depends(get_db),
    current_user: User = Depends(get_current_user)
):
    service = UserService(db)
    if not service.delete(user_id):
        raise HTTPException(
            status_code=status.HTTP_404_NOT_FOUND,
            detail="User not found"
        )
```

### 4.8 åº”ç”¨å…¥å£ï¼ˆsrc/main.pyï¼‰

```python
from fastapi import FastAPI
from fastapi.middleware.cors import CORSMiddleware
from .core.config import settings
from .api.v1.router import api_router

app = FastAPI(
    title=settings.PROJECT_NAME,
    version=settings.VERSION,
    openapi_url=f"{settings.API_V1_STR}/openapi.json"
)

# é…ç½® CORS
app.add_middleware(
    CORSMiddleware,
    allow_origins=settings.BACKEND_CORS_ORIGINS,
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

# åŒ…å« API è·¯ç”±
app.include_router(api_router, prefix=settings.API_V1_STR)

@app.get("/")
def root():
    return {
        "message": "Welcome to FastAPI",
        "version": settings.VERSION
    }

@app.get("/health")
def health_check():
    return {"status": "healthy"}
```

### 4.9 è¿è¡Œåº”ç”¨

```bash
# å¼€å‘æ¨¡å¼
uvicorn src.main:app --reload --host 0.0.0.0 --port 8000

# æˆ–ä½¿ç”¨ fastapi å‘½ä»¤ï¼ˆæ¨èï¼‰
fastapi dev src/main.py

# ç”Ÿäº§æ¨¡å¼
uvicorn src.main:app --host 0.0.0.0 --port 8000 --workers 4
```

------

## 5. AI é›†æˆä¸æ‰©å±•

### 5.1 é›†æˆ Hugging Face æ¨¡å‹

#### å®‰è£…ä¾èµ–

```bash
pip install transformers torch huggingface-hub
pip install sentence-transformers  # ç”¨äºå‘é‡åŒ–
```

#### AI æ¨¡å—ç»“æ„

```
src/ai/
â”œâ”€â”€ __init__.py
â”œâ”€â”€ config.py           # AI é…ç½®
â”œâ”€â”€ models/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ loader.py       # æ¨¡å‹åŠ è½½å™¨
â”‚   â””â”€â”€ cache.py        # æ¨¡å‹ç¼“å­˜
â”œâ”€â”€ inference/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ text_generation.py
â”‚   â”œâ”€â”€ embedding.py
â”‚   â””â”€â”€ classification.py
â”œâ”€â”€ preprocessing.py    # æ•°æ®é¢„å¤„ç†
â””â”€â”€ router.py          # AI API è·¯ç”±
```

#### AI é…ç½®ï¼ˆsrc/ai/config.pyï¼‰

```python
from pydantic import BaseModel
from typing import Optional

class AIConfig(BaseModel):
    # Hugging Face é…ç½®
    HF_API_KEY: Optional[str] = None
    HF_API_URL: str = "https://api-inference.huggingface.co/models"
    
    # æ¨¡å‹é…ç½®
    TEXT_GENERATION_MODEL: str = "meta-llama/Llama-3.2-3B-Instruct"
    EMBEDDING_MODEL: str = "sentence-transformers/all-MiniLM-L6-v2"
    CLASSIFICATION_MODEL: str = "distilbert-base-uncased-finetuned-sst-2-english"
    
    # æ¨ç†é…ç½®
    MAX_LENGTH: int = 512
    TEMPERATURE: float = 0.7
    TOP_P: float = 0.9
    
    # ç¼“å­˜é…ç½®
    MODEL_CACHE_DIR: str = "/tmp/models"
    ENABLE_CACHE: bool = True

ai_config = AIConfig()
```

#### æ¨¡å‹åŠ è½½å™¨ï¼ˆsrc/ai/models/loader.pyï¼‰

```python
from transformers import AutoTokenizer, AutoModel, AutoModelForCausalLM
from sentence_transformers import SentenceTransformer
import torch
from typing import Dict, Any
import os

class ModelLoader:
    def __init__(self, cache_dir: str = None):
        self.cache_dir = cache_dir or "/tmp/models"
        self.models: Dict[str, Any] = {}
        os.makedirs(self.cache_dir, exist_ok=True)
    
    def load_text_generation_model(self, model_name: str):
        """åŠ è½½æ–‡æœ¬ç”Ÿæˆæ¨¡å‹"""
        if model_name in self.models:
            return self.models[model_name]
        
        tokenizer = AutoTokenizer.from_pretrained(
            model_name,
            cache_dir=self.cache_dir
        )
        model = AutoModelForCausalLM.from_pretrained(
            model_name,
            cache_dir=self.cache_dir,
            torch_dtype=torch.float16 if torch.cuda.is_available() else torch.float32,
            device_map="auto" if torch.cuda.is_available() else None
        )
        
        self.models[model_name] = {"tokenizer": tokenizer, "model": model}
        return self.models[model_name]
    
    def load_embedding_model(self, model_name: str):
        """åŠ è½½åµŒå…¥æ¨¡å‹"""
        if model_name in self.models:
            return self.models[model_name]
        
        model = SentenceTransformer(model_name, cache_folder=self.cache_dir)
        self.models[model_name] = model
        return model
    
    def unload_model(self, model_name: str):
        """å¸è½½æ¨¡å‹ä»¥é‡Šæ”¾å†…å­˜"""
        if model_name in self.models:
            del self.models[model_name]
            torch.cuda.empty_cache() if torch.cuda.is_available() else None

# å…¨å±€æ¨¡å‹åŠ è½½å™¨
model_loader = ModelLoader()
```

#### æ¨ç†æœåŠ¡ï¼ˆsrc/ai/inference/text_generation.pyï¼‰

```python
from typing import Optional, Dict, Any
import torch
from ..models.loader import model_loader
from ..config import ai_config

class TextGenerationService:
    def __init__(self):
        self.model_name = ai_config.TEXT_GENERATION_MODEL
        self.max_length = ai_config.MAX_LENGTH
        self.temperature = ai_config.TEMPERATURE
    
    async def generate(
        self,
        prompt: str,
        max_length: Optional[int] = None,
        temperature: Optional[float] = None,
        top_p: Optional[float] = None
    ) -> Dict[str, Any]:
        """ç”Ÿæˆæ–‡æœ¬"""
        # åŠ è½½æ¨¡å‹
        model_dict = model_loader.load_text_generation_model(self.model_name)
        tokenizer = model_dict["tokenizer"]
        model = model_dict["model"]
        
        # ç¼–ç è¾“å…¥
        inputs = tokenizer(prompt, return_tensors="pt")
        if torch.cuda.is_available():
            inputs = {k: v.cuda() for k, v in inputs.items()}
        
        # ç”Ÿæˆ
        with torch.no_grad():
            outputs = model.generate(
                **inputs,
                max_length=max_length or self.max_length,
                temperature=temperature or self.temperature,
                top_p=top_p or ai_config.TOP_P,
                    do_sample=True,
                pad_token_id=tokenizer.eos_token_id
            )
        
        # è§£ç è¾“å‡º
        generated_text = tokenizer.decode(outputs[0], skip_special_tokens=True)
        
        return {
            "prompt": prompt,
            "generated_text": generated_text,
            "model": self.model_name
        }
    
    async def chat(
        self,
        messages: list[Dict[str, str]],
        max_length: Optional[int] = None
    ) -> Dict[str, Any]:
        """èŠå¤©å¯¹è¯"""
        model_dict = model_loader.load_text_generation_model(self.model_name)
        tokenizer = model_dict["tokenizer"]
        model = model_dict["model"]
        
        # æ„å»ºèŠå¤©æç¤º
        chat_prompt = tokenizer.apply_chat_template(
            messages,
            tokenize=False,
            add_generation_prompt=True
        )
        
        return await self.generate(chat_prompt, max_length=max_length)

text_generation_service = TextGenerationService()
```

#### å‘é‡åµŒå…¥æœåŠ¡ï¼ˆsrc/ai/inference/embedding.pyï¼‰

```python
import numpy as np
from typing import List, Union
from ..models.loader import model_loader
from ..config import ai_config

class EmbeddingService:
    def __init__(self):
        self.model_name = ai_config.EMBEDDING_MODEL
    
    async def encode(
        self,
        texts: Union[str, List[str]],
        normalize: bool = True
    ) -> np.ndarray:
        """ç”Ÿæˆæ–‡æœ¬åµŒå…¥å‘é‡"""
        model = model_loader.load_embedding_model(self.model_name)
        
        # æ‰¹é‡ç¼–ç 
        embeddings = model.encode(
            texts,
            normalize_embeddings=normalize,
            show_progress_bar=False
        )
        
        return embeddings
    
    async def similarity(self, text1: str, text2: str) -> float:
        """è®¡ç®—ä¸¤ä¸ªæ–‡æœ¬çš„ç›¸ä¼¼åº¦"""
        embeddings = await self.encode([text1, text2])
        similarity = np.dot(embeddings[0], embeddings[1])
        return float(similarity)

embedding_service = EmbeddingService()
```

#### AI API è·¯ç”±ï¼ˆsrc/ai/router.pyï¼‰

```python
from fastapi import APIRouter, HTTPException, BackgroundTasks
from pydantic import BaseModel
from typing import Optional, List, Dict
from .inference.text_generation import text_generation_service
from .inference.embedding import embedding_service

router = APIRouter(prefix="/ai", tags=["AI"])

class GenerateRequest(BaseModel):
    prompt: str
    max_length: Optional[int] = None
    temperature: Optional[float] = None
    top_p: Optional[float] = None

class ChatRequest(BaseModel):
    messages: List[Dict[str, str]]
    max_length: Optional[int] = None

class EmbeddingRequest(BaseModel):
    texts: Union[str, List[str]]
    normalize: bool = True

class SimilarityRequest(BaseModel):
    text1: str
    text2: str

@router.post("/generate")
async def generate_text(request: GenerateRequest):
    """æ–‡æœ¬ç”Ÿæˆç«¯ç‚¹"""
    try:
        result = await text_generation_service.generate(
            prompt=request.prompt,
            max_length=request.max_length,
            temperature=request.temperature,
            top_p=request.top_p
        )
        return result
    except Exception as e:
        raise HTTPException(status_code=500, detail=str(e))

@router.post("/chat")
async def chat(request: ChatRequest):
    """èŠå¤©å¯¹è¯ç«¯ç‚¹"""
    try:
        result = await text_generation_service.chat(
            messages=request.messages,
            max_length=request.max_length
        )
        return result
    except Exception as e:
        raise HTTPException(status_code=500, detail=str(e))

@router.post("/embeddings")
async def create_embeddings(request: EmbeddingRequest):
    """ç”Ÿæˆæ–‡æœ¬åµŒå…¥"""
    try:
        embeddings = await embedding_service.encode(
            texts=request.texts,
            normalize=request.normalize
        )
        return {
            "embeddings": embeddings.tolist(),
            "model": embedding_service.model_name
        }
    except Exception as e:
        raise HTTPException(status_code=500, detail=str(e))

@router.post("/similarity")
async def calculate_similarity(request: SimilarityRequest):
    """è®¡ç®—æ–‡æœ¬ç›¸ä¼¼åº¦"""
    try:
        similarity = await embedding_service.similarity(
            text1=request.text1,
            text2=request.text2
        )
        return {"similarity": similarity}
    except Exception as e:
        raise HTTPException(status_code=500, detail=str(e))

@router.get("/models/status")
async def get_model_status():
    """è·å–æ¨¡å‹åŠ è½½çŠ¶æ€"""
    from .models.loader import model_loader
    return {
        "loaded_models": list(model_loader.models.keys()),
        "cache_dir": model_loader.cache_dir
    }
```

### 5.2 ä½¿ç”¨ Hugging Face Inference APIï¼ˆæ— éœ€æœ¬åœ°æ¨¡å‹ï¼‰

```python
import httpx
from typing import Dict, Any, Optional

class HuggingFaceAPIService:
    def __init__(self, api_key: str):
        self.api_key = api_key
        self.base_url = "https://api-inference.huggingface.co/models"
        self.headers = {"Authorization": f"Bearer {api_key}"}
    
    async def query(
        self,
        model: str,
        inputs: str,
        parameters: Optional[Dict[str, Any]] = None
    ) -> Dict[str, Any]:
        """è°ƒç”¨ Hugging Face Inference API"""
        async with httpx.AsyncClient() as client:
            response = await client.post(
                f"{self.base_url}/{model}",
                headers=self.headers,
                json={"inputs": inputs, "parameters": parameters or {}}
            )
            response.raise_for_status()
            return response.json()
    
    async def text_generation(
        self,
        prompt: str,
        model: str = "meta-llama/Llama-3.2-3B-Instruct",
        max_length: int = 512
    ):
        return await self.query(
            model=model,
            inputs=prompt,
            parameters={"max_length": max_length}
        )
```

### 5.3 RAGï¼ˆæ£€ç´¢å¢å¼ºç”Ÿæˆï¼‰é›†æˆ

```python
from typing import List
import chromadb
from chromadb.config import Settings

class RAGService:
    def __init__(self):
        self.client = chromadb.Client(Settings(
            chroma_db_impl="duckdb+parquet",
            persist_directory="./chroma_db"
        ))
        self.collection = self.client.get_or_create_collection(
            name="knowledge_base"
        )
    
    async def add_documents(
        self,
        documents: List[str],
        metadata: List[dict] = None,
        ids: List[str] = None
    ):
        """æ·»åŠ æ–‡æ¡£åˆ°å‘é‡æ•°æ®åº“"""
        embeddings = await embedding_service.encode(documents)
        
        self.collection.add(
            documents=documents,
            embeddings=embeddings.tolist(),
            metadatas=metadata,
            ids=ids or [f"doc_{i}" for i in range(len(documents))]
        )
    
    async def query(
        self,
        query_text: str,
        n_results: int = 3
    ) -> Dict[str, Any]:
        """æ£€ç´¢ç›¸å…³æ–‡æ¡£"""
        query_embedding = await embedding_service.encode(query_text)
        
        results = self.collection.query(
            query_embeddings=[query_embedding.tolist()],
            n_results=n_results
        )
        
        return results
    
    async def generate_with_context(
        self,
        question: str,
        n_results: int = 3
    ) -> str:
        """åŸºäºæ£€ç´¢ç»“æœç”Ÿæˆç­”æ¡ˆ"""
        # 1. æ£€ç´¢ç›¸å…³æ–‡æ¡£
        search_results = await self.query(question, n_results)
        context = "\n\n".join(search_results["documents"][0])
        
        # 2. æ„å»ºæç¤º
        prompt = f"""Context:
{context}

Question: {question}

Answer based on the context above:"""
        
        # 3. ç”Ÿæˆç­”æ¡ˆ
        result = await text_generation_service.generate(prompt)
        return result["generated_text"]

rag_service = RAGService()
```

### 5.4 è§†é¢‘ç†è§£é›†æˆï¼ˆå‚è€ƒå°ç±³ Milocoï¼‰

```python
import cv2
import numpy as np
from typing import List, Dict, Any
from transformers import CLIPProcessor, CLIPModel
import torch

class VideoUnderstandingService:
    def __init__(self):
        self.model_name = "openai/clip-vit-base-patch32"
        self.processor = CLIPProcessor.from_pretrained(self.model_name)
        self.model = CLIPModel.from_pretrained(self.model_name)
    
    async def extract_frames(
        self,
        video_path: str,
        num_frames: int = 8
    ) -> List[np.ndarray]:
        """ä»è§†é¢‘ä¸­æå–å…³é”®å¸§"""
        cap = cv2.VideoCapture(video_path)
        total_frames = int(cap.get(cv2.CAP_PROP_FRAME_COUNT))
        
        frame_indices = np.linspace(0, total_frames - 1, num_frames, dtype=int)
        frames = []
        
        for idx in frame_indices:
            cap.set(cv2.CAP_PROP_POS_FRAMES, idx)
            ret, frame = cap.read()
            if ret:
                frame = cv2.cvtColor(frame, cv2.COLOR_BGR2RGB)
                frames.append(frame)
        
        cap.release()
        return frames
    
    async def analyze_video(
        self,
        video_path: str,
        queries: List[str]
    ) -> Dict[str, Any]:
        """åˆ†æè§†é¢‘å†…å®¹"""
        # æå–å¸§
        frames = await self.extract_frames(video_path)
        
        # å¤„ç†å›¾åƒå’Œæ–‡æœ¬
        inputs = self.processor(
            text=queries,
            images=frames,
            return_tensors="pt",
            padding=True
        )
        
        # è®¡ç®—ç›¸ä¼¼åº¦
        with torch.no_grad():
            outputs = self.model(**inputs)
            logits_per_image = outputs.logits_per_image
            probs = logits_per_image.softmax(dim=1)
        
        results = []
        for i, query in enumerate(queries):
            results.append({
                "query": query,
                "confidence": float(probs[:, i].mean())
            })
        
        return {"video_path": video_path, "results": results}

video_service = VideoUnderstandingService()
```

------

## 6. æœ€ä½³å®è·µä¸è¿›é˜¶

### 6.1 é”™è¯¯å¤„ç†

```python
from fastapi import FastAPI, Request, status
from fastapi.responses import JSONResponse
from fastapi.exceptions import RequestValidationError
from pydantic import BaseModel

# è‡ªå®šä¹‰å¼‚å¸¸
class BusinessException(Exception):
    def __init__(self, message: str, code: str = "BUSINESS_ERROR"):
        self.message = message
        self.code = code

# å…¨å±€å¼‚å¸¸å¤„ç†å™¨
@app.exception_handler(BusinessException)
async def business_exception_handler(request: Request, exc: BusinessException):
    return JSONResponse(
        status_code=status.HTTP_400_BAD_REQUEST,
        content={
            "code": exc.code,
            "message": exc.message,
            "path": request.url.path
        }
    )

@app.exception_handler(RequestValidationError)
async def validation_exception_handler(request: Request, exc: RequestValidationError):
    return JSONResponse(
        status_code=status.HTTP_422_UNPROCESSABLE_ENTITY,
        content={
            "code": "VALIDATION_ERROR",
            "message": "Request validation failed",
            "errors": exc.errors()
        }
    )
```

### 6.2 æ—¥å¿—é…ç½®

```python
import logging
from logging.handlers import RotatingFileHandler
import sys

def setup_logging():
    # åˆ›å»ºæ—¥å¿—æ ¼å¼
    formatter = logging.Formatter(
        '%(asctime)s - %(name)s - %(levelname)s - %(message)s'
    )
    
    # æ§åˆ¶å°å¤„ç†å™¨
    console_handler = logging.StreamHandler(sys.stdout)
    console_handler.setFormatter(formatter)
    
    # æ–‡ä»¶å¤„ç†å™¨
    file_handler = RotatingFileHandler(
        'logs/app.log',
        maxBytes=10485760,  # 10MB
        backupCount=5
    )
    file_handler.setFormatter(formatter)
    
    # é…ç½®æ ¹æ—¥å¿—å™¨
    logger = logging.getLogger()
    logger.setLevel(logging.INFO)
    logger.addHandler(console_handler)
    logger.addHandler(file_handler)
    
    return logger

# åœ¨ main.py ä¸­ä½¿ç”¨
logger = setup_logging()

@app.on_event("startup")
async def startup_event():
    logger.info("Application starting up...")

@app.on_event("shutdown")
async def shutdown_event():
    logger.info("Application shutting down...")
```

### 6.3 æ€§èƒ½ä¼˜åŒ–

#### ç¼“å­˜ç­–ç•¥

```python
from functools import lru_cache
from fastapi_cache import FastAPICache
from fastapi_cache.backends.redis import RedisBackend
from fastapi_cache.decorator import cache
from redis import asyncio as aioredis

# åˆå§‹åŒ– Redis ç¼“å­˜
@app.on_event("startup")
async def startup():
    redis = aioredis.from_url("redis://localhost")
    FastAPICache.init(RedisBackend(redis), prefix="fastapi-cache")

# ä½¿ç”¨ç¼“å­˜è£…é¥°å™¨
@router.get("/items/{item_id}")
@cache(expire=60)  # ç¼“å­˜ 60 ç§’
async def get_item(item_id: int, db: Session = Depends(get_db)):
    return db.query(Item).filter(Item.id == item_id).first()

# å†…å­˜ç¼“å­˜
@lru_cache(maxsize=128)
def get_expensive_computation(param: str):
    # æ˜‚è´µçš„è®¡ç®—
    return result
```

#### æ•°æ®åº“è¿æ¥æ± 

```python
from sqlalchemy import create_engine
from sqlalchemy.pool import QueuePool

engine = create_engine(
    settings.DATABASE_URL,
    poolclass=QueuePool,
    pool_size=20,           # è¿æ¥æ± å¤§å°
    max_overflow=10,        # æœ€å¤§æº¢å‡ºè¿æ¥
    pool_timeout=30,        # è¿æ¥è¶…æ—¶
    pool_recycle=3600,      # è¿æ¥å›æ”¶æ—¶é—´
    pool_pre_ping=True      # è¿æ¥å‰æµ‹è¯•
)
```

### 6.4 å®‰å…¨å®è·µ

```python
from fastapi import FastAPI, Security, Depends
from fastapi.security import HTTPBearer, HTTPAuthorizationCredentials
from jose import JWTError, jwt
from passlib.context import CryptContext
from datetime import datetime, timedelta

# å¯†ç åŠ å¯†
pwd_context = CryptContext(schemes=["bcrypt"], deprecated="auto")

def verify_password(plain_password, hashed_password):
    return pwd_context.verify(plain_password, hashed_password)

def get_password_hash(password):
    return pwd_context.hash(password)

# JWT è®¤è¯
security = HTTPBearer()

def create_access_token(data: dict, expires_delta: timedelta = None):
    to_encode = data.copy()
    expire = datetime.utcnow() + (expires_delta or timedelta(minutes=15))
    to_encode.update({"exp": expire})
    return jwt.encode(to_encode, settings.SECRET_KEY, algorithm=settings.ALGORITHM)

async def get_current_user(
    credentials: HTTPAuthorizationCredentials = Security(security),
    db: Session = Depends(get_db)
):
    token = credentials.credentials
    try:
        payload = jwt.decode(token, settings.SECRET_KEY, algorithms=[settings.ALGORITHM])
        user_id: int = payload.get("sub")
        if user_id is None:
            raise HTTPException(status_code=401, detail="Invalid token")
    except JWTError:
        raise HTTPException(status_code=401, detail="Invalid token")
    
    user = db.query(User).filter(User.id == user_id).first()
    if not user:
        raise HTTPException(status_code=404, detail="User not found")
    return user

# ä½¿ç”¨è®¤è¯
@router.get("/protected")
async def protected_route(current_user: User = Depends(get_current_user)):
    return {"user": current_user.username}
```

### 6.5 æµ‹è¯•

```python
from fastapi.testclient import TestClient
from sqlalchemy import create_engine
from sqlalchemy.orm import sessionmaker
from src.main import app
from src.core.database import Base, get_db

# æµ‹è¯•æ•°æ®åº“
SQLALCHEMY_DATABASE_URL = "sqlite:///./test.db"
engine = create_engine(SQLALCHEMY_DATABASE_URL, connect_args={"check_same_thread": False})
TestingSessionLocal = sessionmaker(autocommit=False, autoflush=False, bind=engine)

# åˆ›å»ºæµ‹è¯•è¡¨
Base.metadata.create_all(bind=engine)

def override_get_db():
    db = TestingSessionLocal()
    try:
        yield db
    finally:
        db.close()

app.dependency_overrides[get_db] = override_get_db

client = TestClient(app)

# æµ‹è¯•ç”¨ä¾‹
def test_create_user():
    response = client.post(
        "/api/v1/users/",
        json={"email": "test@example.com", "username": "testuser", "password": "password123"}
    )
    assert response.status_code == 201
    data = response.json()
    assert data["email"] == "test@example.com"
    assert "id" in data

def test_get_user():
    response = client.get("/api/v1/users/1")
    assert response.status_code == 200
    data = response.json()
    assert data["id"] == 1
```

### 6.6 Docker éƒ¨ç½²

**Dockerfile**

```dockerfile
FROM python:3.11-slim

WORKDIR /app

# å®‰è£…ç³»ç»Ÿä¾èµ–
RUN apt-get update && apt-get install -y \
    gcc \
    postgresql-client \
    && rm -rf /var/lib/apt/lists/*

# å¤åˆ¶ä¾èµ–æ–‡ä»¶
COPY requirements.txt .

# å®‰è£… Python ä¾èµ–
RUN pip install --no-cache-dir -r requirements.txt

# å¤åˆ¶åº”ç”¨ä»£ç 
COPY . .

# æš´éœ²ç«¯å£
EXPOSE 8000

# å¯åŠ¨å‘½ä»¤
CMD ["uvicorn", "src.main:app", "--host", "0.0.0.0", "--port", "8000"]
```

**docker-compose.yml**

```yaml
version: '3.8'

services:
  db:
    image: postgres:15
    environment:
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "5432:5432"

  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"

  backend:
    build: .
    ports:
      - "8000:8000"
    environment:
      DATABASE_URL: postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@db:5432/${POSTGRES_DB}
      REDIS_URL: redis://redis:6379
    depends_on:
      - db
      - redis
    volumes:
      - ./src:/app/src
    command: uvicorn src.main:app --host 0.0.0.0 --port 8000 --reload

volumes:
  postgres_data:
```

### 6.7 CI/CDï¼ˆGitHub Actionsï¼‰

**.github/workflows/test.yml**

```yaml
name: Test

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: postgres
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Run tests
      run: |
        pytest tests/ --cov=src --cov-report=xml
    
    - name: Upload coverage
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage.xml
```

------

## æ€»ç»“

æœ¬æŒ‡å—æ¶µç›–äº†ä» FastAPI åŸºç¡€åˆ°ä¼ä¸šçº§åº”ç”¨çš„å®Œæ•´çŸ¥è¯†ä½“ç³»ï¼š

1. **åŸºç¡€å…¥é—¨**ï¼šå®‰è£…ã€Hello Worldã€æ ¸å¿ƒæ¦‚å¿µ
2. **æ ¸å¿ƒè¯­æ³•**ï¼šè·¯å¾„æ“ä½œã€å‚æ•°ã€è¯·æ±‚ä½“ã€ä¾èµ–æ³¨å…¥ç­‰
3. **ä¼ä¸šæ¶æ„**ï¼šæ¨¡å—åŒ–è®¾è®¡ã€åˆ†å±‚æ¶æ„ã€é…ç½®ç®¡ç†
4. **é¡¹ç›®å®æˆ˜**ï¼šä»é›¶æ­å»ºå®Œæ•´é¡¹ç›®
5. **AI é›†æˆ**ï¼šHugging Faceã€RAGã€è§†é¢‘ç†è§£
6. **æœ€ä½³å®è·µ**ï¼šé”™è¯¯å¤„ç†ã€æ—¥å¿—ã€ç¼“å­˜ã€å®‰å…¨ã€æµ‹è¯•ã€éƒ¨ç½²

### å‚è€ƒèµ„æº

- [FastAPI å®˜æ–¹æ–‡æ¡£](https://fastapi.tiangolo.com/)
- [FastAPI å®˜æ–¹æ¨¡æ¿](https://github.com/fastapi/full-stack-fastapi-template)
- [å°ç±³ Miloco é¡¹ç›®](https://github.com/XiaoMi/xiaomi-miloco)
- [Pydantic æ–‡æ¡£](https://docs.pydantic.dev/)
- [SQLModel æ–‡æ¡£](https://sqlmodel.tiangolo.com/)
- [Hugging Face Transformers](https://huggingface.co/docs/transformers)

### ä¸‹ä¸€æ­¥å»ºè®®

1. **å®è·µé¡¹ç›®**ï¼šåŸºäºæœ¬æŒ‡å—åˆ›å»ºè‡ªå·±çš„ FastAPI é¡¹ç›®
2. **æ·±å…¥å­¦ä¹ **ï¼šç ”ç©¶ FastAPI å®˜æ–¹æ¨¡æ¿çš„é«˜çº§ç‰¹æ€§
3. **AI æ¢ç´¢**ï¼šå°è¯•é›†æˆä¸åŒçš„ AI æ¨¡å‹å’ŒæœåŠ¡
4. **æ€§èƒ½ä¼˜åŒ–**ï¼šå­¦ä¹ å¼‚æ­¥ç¼–ç¨‹ã€æ•°æ®åº“ä¼˜åŒ–ã€ç¼“å­˜ç­–ç•¥
5. **å¾®æœåŠ¡**ï¼šæ¢ç´¢ FastAPI åœ¨å¾®æœåŠ¡æ¶æ„ä¸­çš„åº”ç”¨