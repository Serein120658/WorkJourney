# æ—¶åºæ•°æ®åº“å®Œå…¨æŒ‡å—ï¼šä»é›¶åˆ° SpringBoot å®æˆ˜ â°

## ğŸ¯ å¼•è¨€ï¼šä¸ºä»€ä¹ˆæˆ‘ä»¬éœ€è¦æ—¶åºæ•°æ®åº“ï¼Ÿ

æƒ³è±¡ä¸€ä¸‹è¿™æ ·çš„åœºæ™¯ï¼šä½ çš„æ™ºèƒ½å®¶å±…æ¯ç§’é’Ÿäº§ç”Ÿæ•°ç™¾æ¡æ¸©åº¦ã€æ¹¿åº¦ã€å…‰ç…§ä¼ æ„Ÿå™¨æ•°æ®ï¼›è‚¡ç¥¨äº¤æ˜“ç³»ç»Ÿæ¯æ¯«ç§’è®°å½•ç€æˆåƒä¸Šä¸‡ç¬”äº¤æ˜“ä¿¡æ¯ï¼›è‡ªåŠ¨é©¾é©¶æ±½è½¦æ¯æ—¶æ¯åˆ»äº§ç”Ÿ GB çº§åˆ«çš„ä¼ æ„Ÿå™¨æ•°æ®ï¼›ä½ çš„æœåŠ¡å™¨ç›‘æ§ç³»ç»Ÿéœ€è¦å®æ—¶è¿½è¸ª CPUã€å†…å­˜ã€ç½‘ç»œæµé‡...

è¿™äº›æ•°æ®æœ‰ä¸€ä¸ªå…±åŒç‰¹ç‚¹ï¼š**å®ƒä»¬éƒ½å¸¦ç€æ—¶é—´æˆ³ï¼Œéšæ—¶é—´è¿ç»­äº§ç”Ÿï¼Œå¹¶ä¸”æ•°æ®é‡å·¨å¤§**ã€‚ä¼ ç»Ÿçš„å…³ç³»å‹æ•°æ®åº“åœ¨é¢å¯¹è¿™ç±»åœºæ™¯æ—¶ä¼šæ˜¾å¾—åŠ›ä¸ä»å¿ƒï¼Œè€Œæ—¶åºæ•°æ®åº“ï¼ˆTime Series Databaseï¼ŒTSDBï¼‰æ­£æ˜¯ä¸ºè§£å†³è¿™ç±»é—®é¢˜è€Œç”Ÿã€‚

![æ—¶åºæ•°æ®ç¤ºä¾‹](06.æ—¶åºæ•°æ®åº“.assets/image-20251020143935511.png)

------

## ğŸ“Š ä»€ä¹ˆæ˜¯æ—¶åºæ•°æ®ï¼Ÿ

### æ—¶åºæ•°æ®çš„æ ¸å¿ƒç‰¹å¾

æ—¶åºæ•°æ®ï¼ˆTime Series Dataï¼‰æ˜¯æŒ‡æŒ‰æ—¶é—´é¡ºåºæ’åˆ—çš„ä¸€ç³»åˆ—æ•°æ®ç‚¹ã€‚å®ƒå…·æœ‰ä»¥ä¸‹é²œæ˜ç‰¹ç‚¹ï¼š

**æ—¶é—´æ˜¯ç¬¬ä¸€ç»´åº¦** â±ï¸ - æ¯æ¡æ•°æ®å¿…å®šå¸¦æœ‰æ—¶é—´æˆ³ï¼Œæ•°æ®æŒ‰æ—¶é—´é¡ºåºç»„ç»‡å’ŒæŸ¥è¯¢ï¼Œæ—¶é—´æ˜¯æœ€é‡è¦çš„ç´¢å¼•ç»´åº¦ã€‚

**å†™å¤šè¯»å°‘** âœï¸ - æ•°æ®æŒç»­ä¸æ–­åœ°å†™å…¥ï¼ˆç›‘æ§æŒ‡æ ‡ã€ä¼ æ„Ÿå™¨è¯»æ•°ï¼‰ï¼Œè¯»æ“ä½œç›¸å¯¹è¾ƒå°‘ï¼ˆé€šå¸¸æ˜¯æŸ¥è¯¢æŸä¸ªæ—¶é—´èŒƒå›´çš„æ•°æ®ï¼‰ï¼Œå†™å…¥ååé‡æ˜¯å…³é”®æ€§èƒ½æŒ‡æ ‡ã€‚

**æ•°æ®å¾ˆå°‘æ›´æ–°æˆ–åˆ é™¤** ğŸ”’ - å†å²æ•°æ®ä¸€æ—¦å†™å…¥ï¼Œé€šå¸¸ä¸ä¼šä¿®æ”¹ï¼Œä¸»è¦æ“ä½œæ˜¯æ‰¹é‡æŒ‰æ—¶é—´åˆ é™¤è¿‡æœŸæ•°æ®ï¼Œé€‚åˆé‡‡ç”¨è¿½åŠ å†™å…¥ï¼ˆAppend-Onlyï¼‰ç­–ç•¥ã€‚

**æ—¶é—´èŒƒå›´æŸ¥è¯¢ä¸ºä¸»** ğŸ” - å…¸å‹æŸ¥è¯¢å¦‚"æœ€è¿‘ 24 å°æ—¶çš„ CPU ä½¿ç”¨ç‡"ï¼Œç»å¸¸éœ€è¦èšåˆè®¡ç®—ï¼ˆå¹³å‡å€¼ã€æœ€å¤§å€¼ã€è¶‹åŠ¿åˆ†æï¼‰ï¼ŒæŸ¥è¯¢æ¨¡å¼ç›¸å¯¹å›ºå®šã€‚

### å…¸å‹åº”ç”¨åœºæ™¯

æ—¶åºæ•°æ®åº“å¹¿æ³›åº”ç”¨äºç‰©è”ç½‘ï¼ˆå·¥å‚è®¾å¤‡ç›‘æ§ã€æ™ºèƒ½åŸå¸‚ä¼ æ„Ÿå™¨ï¼‰ã€ç³»ç»Ÿç›‘æ§ï¼ˆæœåŠ¡å™¨æ€§èƒ½ã€åº”ç”¨ APMã€ç½‘ç»œæµé‡ï¼‰ã€é‡‘èäº¤æ˜“ï¼ˆè‚¡ç¥¨è¡Œæƒ…ã€äº¤æ˜“è®°å½•ã€é£é™©ç›‘æ§ï¼‰ã€è½¦è”ç½‘ï¼ˆè½¦è¾†è½¨è¿¹ã€é©¾é©¶è¡Œä¸ºã€è½¦å†µæ•°æ®ï¼‰ã€Webåˆ†æï¼ˆç”¨æˆ·è¡Œä¸ºè¿½è¸ªã€ç‚¹å‡»æµåˆ†æï¼‰ç­‰é¢†åŸŸã€‚

------

## ğŸ—ï¸ æ—¶åºæ•°æ®åº“ vs ä¼ ç»Ÿæ•°æ®åº“

### ä¸ºä»€ä¹ˆä¸ç”¨å…³ç³»å‹æ•°æ®åº“ï¼Ÿ

è®©æˆ‘ä»¬é€šè¿‡ä¸€ä¸ªå®é™…æ¡ˆä¾‹æ¥å¯¹æ¯”ã€‚å‡è®¾ä½ éœ€è¦ç›‘æ§ 1000 å°æœåŠ¡å™¨ï¼Œæ¯å°æœåŠ¡å™¨ 10 ä¸ªæŒ‡æ ‡ï¼Œæ¯ 10 ç§’é‡‡é›†ä¸€æ¬¡ã€‚è¿™æ„å‘³ç€æ¯ç§’å†™å…¥é‡ä¸º 1000 æ¡/ç§’ï¼Œä¸€å¤©æ•°æ®é‡é«˜è¾¾ 8640 ä¸‡æ¡ï¼

#### ä¼ ç»Ÿå…³ç³»å‹æ•°æ®åº“çš„ç—›ç‚¹

ä¼ ç»Ÿæ•°æ®åº“é¢ä¸´ç´¢å¼•è†¨èƒ€ï¼ˆå¤§é‡ B-Tree ç´¢å¼•å ç”¨ç©ºé—´ï¼Œç»´æŠ¤æˆæœ¬é«˜ï¼‰ã€å†™å…¥æ€§èƒ½å·®ï¼ˆé¢‘ç¹çš„éšæœºå†™å…¥å¯¼è‡´ç£ç›˜ I/O ç“¶é¢ˆï¼‰ã€å­˜å‚¨æµªè´¹ï¼ˆæ— ä¸“é—¨å‹ç¼©ç®—æ³•ï¼‰ã€æŸ¥è¯¢ç¼“æ…¢ï¼ˆæ—¶é—´èŒƒå›´æŸ¥è¯¢éœ€è¦æ‰«æå¤§é‡æ•°æ®ï¼‰ã€åˆ é™¤å›°éš¾ï¼ˆåˆ é™¤å†å²æ•°æ®éœ€è¦æ˜‚è´µçš„ DELETE æ“ä½œï¼‰ç­‰é—®é¢˜ã€‚

#### æ—¶åºæ•°æ®åº“çš„ä¼˜åŠ¿

æ—¶åºæ•°æ®åº“é€šè¿‡ LSM-Tree ç»“æ„å®ç°é«˜æ•ˆé¡ºåºå†™å…¥ï¼Œé‡‡ç”¨é’ˆå¯¹æ—¶åºæ•°æ®çš„ä¸“é—¨å‹ç¼©ç®—æ³•å¯è¾¾åˆ° 10-100 å€å‹ç¼©æ¯”ï¼Œåˆ©ç”¨æ—¶é—´åˆ†ç‰‡ã€åˆ—å¼å­˜å‚¨ã€é¢„èšåˆå®ç°å¿«é€ŸæŸ¥è¯¢ï¼Œæä¾› TTLï¼ˆç”Ÿå­˜æ—¶é—´ï¼‰æœºåˆ¶è‡ªåŠ¨æ¸…ç†è¿‡æœŸæ•°æ®ï¼Œå¹¶å†…ç½®ä¸°å¯Œçš„æ—¶åºåˆ†æå‡½æ•°ï¼ˆç§»åŠ¨å¹³å‡ã€è¶‹åŠ¿é¢„æµ‹ç­‰ï¼‰ã€‚

![æ—¶åºæ•°æ®åº“æ¶æ„å¯¹æ¯”](06.æ—¶åºæ•°æ®åº“.assets/æ—¶åºæ•°æ®åº“æ¶æ„.jpg)

------

## ğŸ”§ æ—¶åºæ•°æ®åº“æ ¸å¿ƒæŠ€æœ¯

### 1. æ•°æ®æ¨¡å‹

æ—¶åºæ•°æ®åº“é€šå¸¸é‡‡ç”¨ç±»ä¼¼ä¸‹é¢çš„æ•°æ®æ¨¡å‹ï¼š

```
measurement,tag1=value1,tag2=value2 field1=value1,field2=value2 timestamp
```

ä»¥ä¸€æ¡ CPU ç›‘æ§æ•°æ®ä¸ºä¾‹ï¼š

```
cpu,host=server01,region=us-west usage_user=45.2,usage_system=12.3 1634567890000000000
```

è¿™é‡ŒåŒ…å«äº†å››ä¸ªæ ¸å¿ƒæ¦‚å¿µï¼š**Measurementï¼ˆåº¦é‡ï¼‰** ç±»ä¼¼å…³ç³»å‹æ•°æ®åº“çš„è¡¨åï¼Œå¦‚ `cpu`ã€`memory`ï¼›**Tagsï¼ˆæ ‡ç­¾ï¼‰** æ˜¯ç´¢å¼•å­—æ®µï¼Œç”¨äºè¿‡æ»¤å’Œåˆ†ç»„ï¼Œå¦‚ `host=server01`ï¼›**Fieldsï¼ˆå­—æ®µï¼‰** æ˜¯å®é™…æ•°æ®å€¼ï¼Œä¸è¢«ç´¢å¼•ï¼Œå¦‚ `usage_user=45.2`ï¼›**Timestampï¼ˆæ—¶é—´æˆ³ï¼‰** æ˜¯æ•°æ®çš„æ—¶é—´ç‚¹ï¼Œé€šå¸¸æ˜¯çº³ç§’çº§ç²¾åº¦ã€‚

### 2. å­˜å‚¨å¼•æ“ï¼šLSM-Tree

![LSM-Tree æ¶æ„](06.æ—¶åºæ•°æ®åº“.assets/image-20251020144444134.png)

LSM-Treeï¼ˆLog-Structured Merge Treeï¼‰æ˜¯æ—¶åºæ•°æ®åº“çš„æ ¸å¿ƒå­˜å‚¨å¼•æ“ã€‚æ–°æ•°æ®é¦–å…ˆå†™å…¥å†…å­˜ä¸­çš„ MemTableï¼ˆè·³è¡¨ç»“æ„ï¼‰ï¼Œå†™å…¥é€Ÿåº¦æå¿«ã€‚ä¸ºä¿è¯æ•°æ®æŒä¹…æ€§ï¼Œå†™å…¥å‰ä¼šå…ˆè®°å½• WALï¼ˆé¢„å†™æ—¥å¿—ï¼‰ï¼Œè¿™æ˜¯å´©æºƒæ¢å¤çš„åŸºç¡€ã€‚å½“ MemTable è¾¾åˆ°é˜ˆå€¼åï¼Œæ•°æ®ä¼šè¢«åˆ·å…¥ç£ç›˜ç”Ÿæˆä¸å¯å˜çš„ SSTable æ–‡ä»¶ï¼Œè¿™äº›æ–‡ä»¶æŒ‰æ—¶é—´å’Œé”®æ’åºï¼Œæ”¯æŒé«˜æ•ˆèŒƒå›´æŸ¥è¯¢ã€‚ç³»ç»Ÿä¼šå®šæœŸæ‰§è¡Œ Compactionï¼ˆå‹ç¼©ï¼‰ï¼Œåˆå¹¶å¤šä¸ª SSTableï¼Œåˆ é™¤è¿‡æœŸæ•°æ®ï¼Œä¼˜åŒ–å­˜å‚¨ç©ºé—´å’ŒæŸ¥è¯¢æ€§èƒ½ã€‚

### 3. æ•°æ®å‹ç¼©æŠ€æœ¯

æ—¶åºæ•°æ®å…·æœ‰å¾ˆå¼ºçš„è§„å¾‹æ€§ï¼Œå¯ä»¥å®ç°æƒŠäººçš„å‹ç¼©æ¯”ã€‚å¸¸ç”¨çš„å‹ç¼©ç®—æ³•åŒ…æ‹¬ï¼šDelta Encodingï¼ˆç”¨äºé€’å¢çš„æ—¶é—´æˆ³åºåˆ—ï¼Œå‹ç¼©æ¯” 5-10xï¼‰ã€Run-Length Encodingï¼ˆç”¨äºé‡å¤çš„æ ‡ç­¾å€¼ï¼Œå‹ç¼©æ¯” 3-5xï¼‰ã€Gorilla Compressionï¼ˆFacebook å¼€æºçš„æµ®ç‚¹æ•°å‹ç¼©ï¼Œå‹ç¼©æ¯” 10-12xï¼‰ã€Simple8bï¼ˆæ•´æ•°åºåˆ—å‹ç¼©ï¼Œå‹ç¼©æ¯” 5-8xï¼‰ä»¥åŠé€šç”¨çš„ Snappy/LZ4 æ–‡æœ¬å‹ç¼©ï¼ˆå‹ç¼©æ¯” 2-3xï¼‰ã€‚

ä¸¾ä¸ªä¾‹å­ï¼ŒåŸå§‹æ—¶é—´æˆ³åºåˆ— `1634567890, 1634567900, 1634567910, 1634567920...` ç»è¿‡ Delta Encoding åå˜æˆ `1634567890, +10, +10, +10...`ï¼Œåªå­˜å‚¨å·®å€¼ï¼Œå¤§å¤§èŠ‚çœäº†å­˜å‚¨ç©ºé—´ã€‚

### 4. æ—¶é—´åˆ†ç‰‡ï¼ˆShardingï¼‰

![æ—¶é—´åˆ†ç‰‡ç¤ºä¾‹](https://docs.influxdata.com/img/influxdb/v1-tsm-engine.png)

æ—¶åºæ•°æ®åº“ä¼šæŒ‰æ—¶é—´èŒƒå›´å°†æ•°æ®åˆ†å‰²æˆå¤šä¸ª Shardï¼Œæ¯ä¸ª Shard æ˜¯ç‹¬ç«‹çš„ LSM-Treeã€‚è¿™æ ·åšçš„ä¼˜åŠ¿æ˜¯å¯ä»¥å¹¶è¡ŒæŸ¥è¯¢æå‡æ€§èƒ½ï¼ŒæŒ‰æ—¶é—´åˆ é™¤æ•´ä¸ª Shardï¼ˆè€Œä¸æ˜¯é€æ¡åˆ é™¤ï¼‰ï¼Œä¾¿äºæ•°æ®è¿ç§»å’Œå¤‡ä»½ã€‚åˆ†ç‰‡ç­–ç•¥é€šå¸¸æ ¹æ®æ•°æ®ä¿ç•™æœŸæ¥è®¾ç½®ï¼Œæ¯”å¦‚ä¿ç•™æœŸå°äº 1 å¤©çš„æ•°æ®ç”¨ 1 å°æ—¶åˆ†ç‰‡ï¼Œ1-7 å¤©çš„æ•°æ®ç”¨ 1 å¤©åˆ†ç‰‡ï¼Œ7-90 å¤©çš„æ•°æ®ç”¨ 7 å¤©åˆ†ç‰‡ï¼Œè¶…è¿‡ 90 å¤©çš„æ•°æ®ç”¨ 30 å¤©åˆ†ç‰‡ã€‚

------

## ğŸ¯ æ·±å…¥ InfluxDBï¼šæœ€æµè¡Œçš„æ—¶åºæ•°æ®åº“

![InfluxDB Logo](06.æ—¶åºæ•°æ®åº“.assets/image-20251020144906982.png)

### InfluxDB æ¶æ„æ¦‚è§ˆ

![InfluxDB 3.0 Architecture](06.æ—¶åºæ•°æ®åº“.assets/image-20251020145016125.png)

InfluxDB 3.0 é‡‡ç”¨äº†å…¨æ–°çš„äº‘åŸç”Ÿæ¶æ„ï¼Œä¸»è¦åŒ…å«ä»¥ä¸‹å‡ ä¸ªæ ¸å¿ƒç»„ä»¶ï¼š

**Routerï¼ˆè·¯ç”±å™¨ï¼‰** è´Ÿè´£è§£æ Line Protocol æ ¼å¼çš„æ•°æ®ï¼Œå°†æ•°æ®è·¯ç”±åˆ°ä¸åŒçš„ Ingesterï¼Œæ”¯æŒæ•°æ®å¤åˆ¶ä¿è¯å†™å…¥æŒä¹…æ€§ï¼Œå¯ä»¥æ°´å¹³æ‰©å±•æå‡å†™å…¥ååã€‚

**Ingesterï¼ˆæ•°æ®æ‘„å…¥å™¨ï¼‰** è´Ÿè´£è‡ªåŠ¨å‘ç°è¡¨ç»“æ„ã€æ•°æ®åˆ†åŒºï¼ˆé»˜è®¤æŒ‰å¤©åˆ†åŒºï¼‰ã€æ•°æ®å»é‡ä»¥åŠæŒä¹…åŒ–åˆ°å¯¹è±¡å­˜å‚¨ï¼ˆç”Ÿæˆ Parquet æ–‡ä»¶ï¼‰ã€‚å†™å…¥æµç¨‹æ˜¯ï¼šå®¢æˆ·ç«¯ â†’ Router â†’ Ingester â†’ WALï¼ˆå´©æºƒæ¢å¤ï¼‰â†’ Parquetï¼ˆå¯¹è±¡å­˜å‚¨ï¼‰ï¼ŒåŒæ—¶æ›´æ–°å…ƒæ•°æ®åˆ° Catalogã€‚

**Querierï¼ˆæŸ¥è¯¢å™¨ï¼‰** æ¥æ”¶ SQL/InfluxQL æŸ¥è¯¢ï¼Œæ„å»ºæŸ¥è¯¢è®¡åˆ’ï¼ˆåŸºäº DataFusionï¼‰ï¼Œä» Ingester è·å–æœ€æ–°æ•°æ®ï¼Œä» Object Store è¯»å–å†å²æ•°æ®ï¼Œå¯æ°´å¹³æ‰©å±•å¤„ç†æ›´å¤šæŸ¥è¯¢ã€‚

**Compactorï¼ˆå‹ç¼©å™¨ï¼‰** è´Ÿè´£åˆå¹¶å°çš„ Parquet æ–‡ä»¶ï¼Œä¼˜åŒ–å­˜å‚¨å¸ƒå±€ï¼Œåº”ç”¨å‹ç¼©ç®—æ³•ï¼Œé€šè¿‡å‚ç›´æ‰©å±•ï¼ˆå¢åŠ  CPUï¼‰æå‡æ€§èƒ½ã€‚

æ ¸å¿ƒå­˜å‚¨æ–¹é¢ï¼ŒCatalog ä½¿ç”¨ PostgreSQL å­˜å‚¨å…ƒæ•°æ®ï¼ŒObject Storeï¼ˆS3/Azure Blob/GCSï¼‰å­˜å‚¨æ•°æ®æ–‡ä»¶ï¼ŒWAL ä½¿ç”¨æœ¬åœ°ç£ç›˜è¿›è¡Œå´©æºƒæ¢å¤ã€‚

### InfluxDB æ•°æ®æ¨¡å‹å®æˆ˜

InfluxDB ä½¿ç”¨ Line Protocol è¯­æ³•å†™å…¥æ•°æ®ï¼Œæ ¼å¼å¦‚ä¸‹ï¼š

```
<measurement>[,<tag_key>=<tag_value>] <field_key>=<field_value> [<timestamp>]
```

ä»¥æœåŠ¡å™¨ç›‘æ§æ•°æ®ä¸ºä¾‹ï¼š

```influxdb
# CPU ä½¿ç”¨ç‡
cpu,host=server01,region=us-west,cpu=cpu0 usage_user=45.2,usage_system=12.3 1634567890000000000

# å†…å­˜ä½¿ç”¨
mem,host=server01,region=us-west used=8589934592,free=2147483648 1634567890000000000

# ç£ç›˜ I/O
disk,host=server01,region=us-west,device=sda read_bytes=104857600 1634567890000000000
```

### æŸ¥è¯¢è¯­è¨€ç¤ºä¾‹

InfluxDB æ”¯æŒå¤šç§æŸ¥è¯¢è¯­è¨€ã€‚ä½¿ç”¨ InfluxQLï¼ˆç±» SQL è¯­æ³•ï¼‰æŸ¥è¯¢æœ€è¿‘ 1 å°æ—¶çš„å¹³å‡ CPU ä½¿ç”¨ç‡ï¼š

```sql
SELECT MEAN("usage_user") 
FROM "cpu" 
WHERE time > now() - 1h 
GROUP BY time(1m), "host"
```

æˆ–è€…ä½¿ç”¨ SQLï¼ˆInfluxDB 3.0ï¼‰ï¼š

```sql
SELECT 
  host,
  DATE_TRUNC('minute', time) AS minute,
  AVG(usage_user) AS avg_cpu
FROM cpu
WHERE time > NOW() - INTERVAL '1 hour'
GROUP BY host, minute
ORDER BY minute DESC;
```

### æ•°æ®ä¿ç•™ç­–ç•¥

InfluxDB æ”¯æŒè‡ªåŠ¨åˆ é™¤è¿‡æœŸæ•°æ®å’Œæ•°æ®é™é‡‡æ ·ã€‚åˆ›å»ºä¿ç•™ç­–ç•¥ï¼š

```sql
-- ä¿ç•™ 30 å¤©ï¼Œå‰¯æœ¬æ•° 1
CREATE RETENTION POLICY "thirty_days" 
ON "monitoring" 
DURATION 30d 
REPLICATION 1 
DEFAULT
```

å®ç°æ•°æ®åˆ†å±‚å­˜å‚¨ï¼šåŸå§‹æ•°æ®ï¼ˆ10s ç²’åº¦ï¼‰ä¿ç•™ 30 å¤©åè‡ªåŠ¨åˆ é™¤ï¼ŒåŒæ—¶é€šè¿‡é™é‡‡æ ·ç”Ÿæˆ 1 åˆ†é’Ÿèšåˆæ•°æ®ä¿ç•™ 1 å¹´ï¼Œå†é™é‡‡æ ·ç”Ÿæˆ 1 å°æ—¶èšåˆæ•°æ®æ°¸ä¹…ä¿å­˜ã€‚

------

## ğŸš€ SpringBoot æ•´åˆ InfluxDB å®æˆ˜

### 1. é¡¹ç›®æ­å»ºä¸ä¾èµ–é…ç½®

é¦–å…ˆåœ¨ `pom.xml` ä¸­æ·»åŠ  InfluxDB ä¾èµ–ï¼š

```xml
<dependencies>
    <!-- Spring Boot Web -->
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-web</artifactId>
    </dependency>
    
    <!-- InfluxDB Java Client -->
    <dependency>
        <groupId>com.influxdb</groupId>
        <artifactId>influxdb-client-java</artifactId>
        <version>6.10.0</version>
    </dependency>
    
    <!-- Lombok (å¯é€‰ï¼Œç®€åŒ–ä»£ç ) -->
    <dependency>
        <groupId>org.projectlombok</groupId>
        <artifactId>lombok</artifactId>
        <optional>true</optional>
    </dependency>
</dependencies>
```

åœ¨ `application.yml` ä¸­é…ç½® InfluxDB è¿æ¥ä¿¡æ¯ï¼š

```yaml
spring:
  application:
    name: influxdb-demo

influxdb:
  url: http://localhost:8086
  token: your-influxdb-token
  org: your-org
  bucket: monitoring
  timeout: 30s
```

### 2. InfluxDB é…ç½®ç±»

åˆ›å»º InfluxDB å®¢æˆ·ç«¯é…ç½®ç±»ï¼š

```java
package com.example.config;

import com.influxdb.client.InfluxDBClient;
import com.influxdb.client.InfluxDBClientFactory;
import lombok.Data;
import org.springframework.boot.context.properties.ConfigurationProperties;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

@Data
@Configuration
@ConfigurationProperties(prefix = "influxdb")
public class InfluxDBConfig {
    
    private String url;
    private String token;
    private String org;
    private String bucket;
    private String timeout;
    
    @Bean
    public InfluxDBClient influxDBClient() {
        return InfluxDBClientFactory.create(url, token.toCharArray(), org, bucket);
    }
}
```

### 3. å®ä½“ç±»å®šä¹‰

å®šä¹‰æœåŠ¡å™¨ç›‘æ§æ•°æ®å®ä½“ï¼š

```java
package com.example.entity;

import com.influxdb.annotations.Column;
import com.influxdb.annotations.Measurement;
import lombok.AllArgsConstructor;
import lombok.Builder;
import lombok.Data;
import lombok.NoArgsConstructor;

import java.time.Instant;

@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
@Measurement(name = "server_metrics")
public class ServerMetrics {
    
    // Tags - ç”¨äºç´¢å¼•å’Œåˆ†ç»„
    @Column(tag = true)
    private String host;
    
    @Column(tag = true)
    private String region;
    
    // Fields - å®é™…æ•°æ®
    @Column
    private Double cpuUsage;
    
    @Column
    private Double memoryUsage;
    
    @Column
    private Long diskReadBytes;
    
    @Column
    private Long diskWriteBytes;
    
    // Timestamp
    @Column(timestamp = true)
    private Instant time;
}
```

### 4. æ•°æ®å†™å…¥æœåŠ¡

åˆ›å»ºæ•°æ®å†™å…¥æœåŠ¡ç±»ï¼š

```java
package com.example.service;

import com.example.entity.ServerMetrics;
import com.influxdb.client.InfluxDBClient;
import com.influxdb.client.WriteApiBlocking;
import com.influxdb.client.domain.WritePrecision;
import com.influxdb.client.write.Point;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Service;

import java.time.Instant;
import java.util.List;

@Slf4j
@Service
@RequiredArgsConstructor
public class MetricsWriteService {
    
    private final InfluxDBClient influxDBClient;
    
    /**
     * æ–¹æ³•1: ä½¿ç”¨ POJO å¯¹è±¡å†™å…¥ï¼ˆæ¨èï¼‰
     */
    public void writeMetrics(ServerMetrics metrics) {
        WriteApiBlocking writeApi = influxDBClient.getWriteApiBlocking();
        writeApi.writeMeasurement(WritePrecision.NS, metrics);
        log.info("å†™å…¥ç›‘æ§æ•°æ®: {}", metrics);
    }
    
    /**
     * æ–¹æ³•2: ä½¿ç”¨ Point å¯¹è±¡å†™å…¥ï¼ˆæ›´çµæ´»ï¼‰
     */
    public void writeMetricsByPoint(String host, String region, 
                                     Double cpuUsage, Double memUsage) {
        Point point = Point.measurement("server_metrics")
                .addTag("host", host)
                .addTag("region", region)
                .addField("cpuUsage", cpuUsage)
                .addField("memoryUsage", memUsage)
                .time(Instant.now(), WritePrecision.NS);
        
        WriteApiBlocking writeApi = influxDBClient.getWriteApiBlocking();
        writeApi.writePoint(point);
        log.info("å†™å…¥ç›‘æ§æ•°æ®: host={}, cpu={}", host, cpuUsage);
    }
    
    /**
     * æ–¹æ³•3: æ‰¹é‡å†™å…¥ï¼ˆé«˜æ€§èƒ½ï¼‰
     */
    public void batchWriteMetrics(List<ServerMetrics> metricsList) {
        WriteApiBlocking writeApi = influxDBClient.getWriteApiBlocking();
        writeApi.writeMeasurements(WritePrecision.NS, metricsList);
        log.info("æ‰¹é‡å†™å…¥ {} æ¡ç›‘æ§æ•°æ®", metricsList.size());
    }
    
    /**
     * æ–¹æ³•4: ä½¿ç”¨ Line Protocol å†™å…¥ï¼ˆæœ€é«˜æ€§èƒ½ï¼‰
     */
    public void writeLineProtocol(String lineProtocol) {
        WriteApiBlocking writeApi = influxDBClient.getWriteApiBlocking();
        writeApi.writeRecord(WritePrecision.NS, lineProtocol);
        log.info("å†™å…¥ Line Protocol: {}", lineProtocol);
    }
}
```

### 5. æ•°æ®æŸ¥è¯¢æœåŠ¡

åˆ›å»ºæ•°æ®æŸ¥è¯¢æœåŠ¡ç±»ï¼š

```java
package com.example.service;

import com.example.entity.ServerMetrics;
import com.influxdb.client.InfluxDBClient;
import com.influxdb.client.QueryApi;
import com.influxdb.query.FluxRecord;
import com.influxdb.query.FluxTable;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Service;

import java.time.Instant;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

@Slf4j
@Service
@RequiredArgsConstructor
public class MetricsQueryService {
    
    private final InfluxDBClient influxDBClient;
    
    /**
     * æŸ¥è¯¢æŒ‡å®šä¸»æœºæœ€è¿‘çš„ç›‘æ§æ•°æ®
     */
    public List<ServerMetrics> queryRecentMetrics(String host, String duration) {
        String flux = String.format("""
            from(bucket: "monitoring")
              |> range(start: -%s)
              |> filter(fn: (r) => r._measurement == "server_metrics")
              |> filter(fn: (r) => r.host == "%s")
              |> pivot(rowKey:["_time"], columnKey: ["_field"], valueColumn: "_value")
            """, duration, host);
        
        QueryApi queryApi = influxDBClient.getQueryApi();
        List<FluxTable> tables = queryApi.query(flux);
        
        List<ServerMetrics> result = new ArrayList<>();
        for (FluxTable table : tables) {
            for (FluxRecord record : table.getRecords()) {
                ServerMetrics metrics = ServerMetrics.builder()
                        .host((String) record.getValueByKey("host"))
                        .region((String) record.getValueByKey("region"))
                        .cpuUsage(getDoubleValue(record, "cpuUsage"))
                        .memoryUsage(getDoubleValue(record, "memoryUsage"))
                        .diskReadBytes(getLongValue(record, "diskReadBytes"))
                        .diskWriteBytes(getLongValue(record, "diskWriteBytes"))
                        .time((Instant) record.getValueByKey("_time"))
                        .build();
                result.add(metrics);
            }
        }
        
        log.info("æŸ¥è¯¢åˆ° {} æ¡ç›‘æ§æ•°æ®", result.size());
        return result;
    }
    
    /**
     * æŸ¥è¯¢å¹³å‡ CPU ä½¿ç”¨ç‡ï¼ˆæŒ‰æ—¶é—´èšåˆï¼‰
     */
    public Map<String, Double> queryAvgCpuUsage(String duration, String window) {
        String flux = String.format("""
            from(bucket: "monitoring")
              |> range(start: -%s)
              |> filter(fn: (r) => r._measurement == "server_metrics")
              |> filter(fn: (r) => r._field == "cpuUsage")
              |> aggregateWindow(every: %s, fn: mean)
              |> group(columns: ["host"])
            """, duration, window);
        
        QueryApi queryApi = influxDBClient.getQueryApi();
        List<FluxTable> tables = queryApi.query(flux);
        
        Map<String, Double> result = new HashMap<>();
        for (FluxTable table : tables) {
            for (FluxRecord record : table.getRecords()) {
                String host = (String) record.getValueByKey("host");
                Double avgCpu = getDoubleValue(record, "_value");
                result.put(host, avgCpu);
            }
        }
        
        log.info("æŸ¥è¯¢å¹³å‡ CPU: {}", result);
        return result;
    }
    
    /**
     * æŸ¥è¯¢ CPU ä½¿ç”¨ç‡è¶‹åŠ¿ï¼ˆä½¿ç”¨ InfluxQLï¼‰
     */
    public List<Map<String, Object>> queryCpuTrend(String host, int hours) {
        // InfluxDB 2.x æ¨èä½¿ç”¨ Fluxï¼Œè¿™é‡Œä»…ä½œç¤ºä¾‹
        String flux = String.format("""
            from(bucket: "monitoring")
              |> range(start: -%dh)
              |> filter(fn: (r) => r._measurement == "server_metrics")
              |> filter(fn: (r) => r.host == "%s")
              |> filter(fn: (r) => r._field == "cpuUsage")
              |> aggregateWindow(every: 5m, fn: mean)
            """, hours, host);
        
        QueryApi queryApi = influxDBClient.getQueryApi();
        List<FluxTable> tables = queryApi.query(flux);
        
        List<Map<String, Object>> result = new ArrayList<>();
        for (FluxTable table : tables) {
            for (FluxRecord record : table.getRecords()) {
                Map<String, Object> point = new HashMap<>();
                point.put("time", record.getTime());
                point.put("value", record.getValue());
                result.add(point);
            }
        }
        
        return result;
    }
    
    // è¾…åŠ©æ–¹æ³•ï¼šå®‰å…¨è·å– Double å€¼
    private Double getDoubleValue(FluxRecord record, String key) {
        Object value = record.getValueByKey(key);
        if (value instanceof Number) {
            return ((Number) value).doubleValue();
        }
        return null;
    }
    
    // è¾…åŠ©æ–¹æ³•ï¼šå®‰å…¨è·å– Long å€¼
    private Long getLongValue(FluxRecord record, String key) {
        Object value = record.getValueByKey(key);
        if (value instanceof Number) {
            return ((Number) value).longValue();
        }
        return null;
    }
}
```

### 6. REST API æ§åˆ¶å™¨

åˆ›å»º RESTful API æ§åˆ¶å™¨ï¼š

```java
package com.example.controller;

import com.example.entity.ServerMetrics;
import com.example.service.MetricsQueryService;
import com.example.service.MetricsWriteService;
import lombok.RequiredArgsConstructor;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.*;

import java.time.Instant;
import java.util.List;
import java.util.Map;

@RestController
@RequestMapping("/api/metrics")
@RequiredArgsConstructor
public class MetricsController {
    
    private final MetricsWriteService writeService;
    private final MetricsQueryService queryService;
    
    /**
     * å†™å…¥å•æ¡ç›‘æ§æ•°æ®
     * POST /api/metrics
     */
    @PostMapping
    public ResponseEntity<String> writeMetrics(@RequestBody ServerMetrics metrics) {
        if (metrics.getTime() == null) {
            metrics.setTime(Instant.now());
        }
        writeService.writeMetrics(metrics);
        return ResponseEntity.ok("æ•°æ®å†™å…¥æˆåŠŸ");
    }
    
    /**
     * æ‰¹é‡å†™å…¥ç›‘æ§æ•°æ®
     * POST /api/metrics/batch
     */
    @PostMapping("/batch")
    public ResponseEntity<String> batchWriteMetrics(
            @RequestBody List<ServerMetrics> metricsList) {
        metricsList.forEach(m -> {
            if (m.getTime() == null) m.setTime(Instant.now());
        });
        writeService.batchWriteMetrics(metricsList);
        return ResponseEntity.ok("æ‰¹é‡å†™å…¥æˆåŠŸï¼š" + metricsList.size() + " æ¡");
    }
    
    /**
     * æŸ¥è¯¢æŒ‡å®šä¸»æœºçš„ç›‘æ§æ•°æ®
     * GET /api/metrics/{host}?duration=1h
     */
    @GetMapping("/{host}")
    public ResponseEntity<List<ServerMetrics>> getMetrics(
            @PathVariable String host,
            @RequestParam(defaultValue = "1h") String duration) {
        List<ServerMetrics> metrics = queryService.queryRecentMetrics(host, duration);
        return ResponseEntity.ok(metrics);
    }
    
    /**
     * æŸ¥è¯¢å¹³å‡ CPU ä½¿ç”¨ç‡
     * GET /api/metrics/avg-cpu?duration=1h&window=5m
     */
    @GetMapping("/avg-cpu")
    public ResponseEntity<Map<String, Double>> getAvgCpu(
            @RequestParam(defaultValue = "1h") String duration,
            @RequestParam(defaultValue = "5m") String window) {
        Map<String, Double> avgCpu = queryService.queryAvgCpuUsage(duration, window);
        return ResponseEntity.ok(avgCpu);
    }
    
    /**
     * æŸ¥è¯¢ CPU ä½¿ç”¨ç‡è¶‹åŠ¿
     * GET /api/metrics/cpu-trend/{host}?hours=24
     */
    @GetMapping("/cpu-trend/{host}")
    public ResponseEntity<List<Map<String, Object>>> getCpuTrend(
            @PathVariable String host,
            @RequestParam(defaultValue = "24") int hours) {
        List<Map<String, Object>> trend = queryService.queryCpuTrend(host, hours);
        return ResponseEntity.ok(trend);
    }
}
```

### 7. å®šæ—¶é‡‡é›†ä»»åŠ¡

åˆ›å»ºå®šæ—¶ä»»åŠ¡æ¨¡æ‹Ÿç›‘æ§æ•°æ®é‡‡é›†ï¼š

```java
package com.example.scheduler;

import com.example.entity.ServerMetrics;
import com.example.service.MetricsWriteService;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.scheduling.annotation.Scheduled;
import org.springframework.stereotype.Component;

import java.time.Instant;
import java.util.Random;

@Slf4j
@Component
@RequiredArgsConstructor
public class MetricsCollector {
    
    private final MetricsWriteService writeService;
    private final Random random = new Random();
    
    /**
     * æ¯ 10 ç§’é‡‡é›†ä¸€æ¬¡ç›‘æ§æ•°æ®
     */
    @Scheduled(fixedRate = 10000)
    public void collectMetrics() {
        String[] hosts = {"server01", "server02", "server03"};
        String[] regions = {"us-west", "us-east", "eu-central"};
        
        for (int i = 0; i < hosts.length; i++) {
            ServerMetrics metrics = ServerMetrics.builder()
                    .host(hosts[i])
                    .region(regions[i % regions.length])
                    .cpuUsage(20 + random.nextDouble() * 60)  // 20-80%
                    .memoryUsage(30 + random.nextDouble() * 50)  // 30-80%
                    .diskReadBytes((long) (random.nextDouble() * 100_000_000))
                    .diskWriteBytes((long) (random.nextDouble() * 50_000_000))
                    .time(Instant.now())
                    .build();
            
            writeService.writeMetrics(metrics);
        }
        
        log.info("å®Œæˆä¸€è½®ç›‘æ§æ•°æ®é‡‡é›†");
    }
}
```

è®°å¾—åœ¨å¯åŠ¨ç±»ä¸Šæ·»åŠ  `@EnableScheduling` æ³¨è§£ï¼š

```java
package com.example;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.scheduling.annotation.EnableScheduling;

@EnableScheduling
@SpringBootApplication
public class InfluxdbDemoApplication {
    public static void main(String[] args) {
        SpringApplication.run(InfluxdbDemoApplication.class, args);
    }
}
```

### 8. æµ‹è¯•ä¸éªŒè¯

å¯åŠ¨åº”ç”¨åï¼Œå¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼æµ‹è¯•ï¼š

**1. ä½¿ç”¨ curl å†™å…¥æ•°æ®ï¼š**

```bash
curl -X POST http://localhost:8080/api/metrics \
  -H "Content-Type: application/json" \
  -d '{
    "host": "server01",
    "region": "us-west",
    "cpuUsage": 45.2,
    "memoryUsage": 68.5,
    "diskReadBytes": 104857600,
    "diskWriteBytes": 52428800
  }'
```

**2. æŸ¥è¯¢æœ€è¿‘ 1 å°æ—¶çš„æ•°æ®ï¼š**

```bash
curl http://localhost:8080/api/metrics/server01?duration=1h
```

**3. æŸ¥è¯¢å¹³å‡ CPU ä½¿ç”¨ç‡ï¼š**

```bash
curl http://localhost:8080/api/metrics/avg-cpu?duration=24h&window=1h
```

**4. æŸ¥è¯¢ CPU è¶‹åŠ¿ï¼š**

```bash
curl http://localhost:8080/api/metrics/cpu-trend/server01?hours=24
```

### 9. é«˜çº§ç‰¹æ€§ï¼šå¼‚æ­¥å†™å…¥ä¸æ‰¹å¤„ç†

ä¸ºäº†æé«˜å†™å…¥æ€§èƒ½ï¼Œå¯ä»¥ä½¿ç”¨å¼‚æ­¥ APIï¼š

```java
package com.example.service;

import com.example.entity.ServerMetrics;
import com.influxdb.client.InfluxDBClient;
import com.influxdb.client.WriteApi;
import com.influxdb.client.domain.WritePrecision;
import com.influxdb.client.write.events.WriteErrorEvent;
import com.influxdb.client.write.events.WriteSuccessEvent;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Service;

import javax.annotation.PreDestroy;

@Slf4j
@Service
public class AsyncMetricsWriteService {
    
    private final WriteApi writeApi;
    
    public AsyncMetricsWriteService(InfluxDBClient influxDBClient) {
        this.writeApi = influxDBClient.makeWriteApi();
        
        // ç›‘å¬å†™å…¥æˆåŠŸäº‹ä»¶
        writeApi.listenEvents(WriteSuccessEvent.class, event -> {
            log.debug("æ•°æ®å†™å…¥æˆåŠŸ");
        });
        
        // ç›‘å¬å†™å…¥å¤±è´¥äº‹ä»¶
        writeApi.listenEvents(WriteErrorEvent.class, event -> {
            log.error("æ•°æ®å†™å…¥å¤±è´¥: {}", event.getThrowable().getMessage());
        });
    }
    
    /**
     * å¼‚æ­¥å†™å…¥å•æ¡æ•°æ®
     */
    public void writeAsync(ServerMetrics metrics) {
        writeApi.writeMeasurement(WritePrecision.NS, metrics);
        log.info("å¼‚æ­¥å†™å…¥é˜Ÿåˆ—: {}", metrics.getHost());
    }
    
    /**
     * åº”ç”¨å…³é—­æ—¶åˆ·æ–°å¹¶å…³é—­ WriteApi
     */
    @PreDestroy
    public void close() {
        log.info("å…³é—­ WriteApiï¼Œåˆ·æ–°ç¼“å†²åŒº...");
        writeApi.flush();
        writeApi.close();
    }
}
```

### 10. å¼‚å¸¸å¤„ç†ä¸ç›‘æ§

åˆ›å»ºå…¨å±€å¼‚å¸¸å¤„ç†å™¨ï¼š

```java
package com.example.exception;

import com.influxdb.exceptions.InfluxException;
import lombok.extern.slf4j.Slf4j;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.ExceptionHandler;
import org.springframework.web.bind.annotation.RestControllerAdvice;

import java.util.HashMap;
import java.util.Map;

@Slf4j
@RestControllerAdvice
public class GlobalExceptionHandler {
    
    @ExceptionHandler(InfluxException.class)
    public ResponseEntity<Map<String, Object>> handleInfluxException(
            InfluxException e) {
        log.error("InfluxDB æ“ä½œå¼‚å¸¸: {}", e.getMessage(), e);
        
        Map<String, Object> error = new HashMap<>();
        error.put("error", "InfluxDB Error");
        error.put("message", e.getMessage());
        error.put("code", e.code());
        
        return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(error);
    }
    
    @ExceptionHandler(Exception.class)
    public ResponseEntity<Map<String, Object>> handleException(Exception e) {
        log.error("ç³»ç»Ÿå¼‚å¸¸: {}", e.getMessage(), e);
        
        Map<String, Object> error = new HashMap<>();
        error.put("error", "Internal Server Error");
        error.put("message", e.getMessage());
        
        return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(error);
    }
}
```

### 11. æ€§èƒ½ä¼˜åŒ–å»ºè®®

åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ä½¿ç”¨ InfluxDB æ—¶ï¼Œéœ€è¦æ³¨æ„ä»¥ä¸‹å‡ ç‚¹ï¼š

**æ‰¹é‡å†™å…¥ä¼˜åŒ–** - å°½é‡ä½¿ç”¨æ‰¹é‡å†™å…¥è€Œä¸æ˜¯å•æ¡å†™å…¥ï¼Œå»ºè®®æ¯æ‰¹ 5000-10000 æ¡æ•°æ®ã€‚å¯ä»¥é…ç½® WriteApi çš„æ‰¹å¤„ç†å‚æ•°ï¼š`batchSize`ï¼ˆæ‰¹æ¬¡å¤§å°ï¼Œé»˜è®¤ 5000ï¼‰ã€`flushInterval`ï¼ˆåˆ·æ–°é—´éš”ï¼Œé»˜è®¤ 1000msï¼‰ã€`bufferLimit`ï¼ˆç¼“å†²åŒºé™åˆ¶ï¼Œé»˜è®¤ 10000ï¼‰ã€‚

**åˆç†è®¾è®¡ Schema** - Tags åº”è¯¥æ˜¯ä½åŸºæ•°çš„ï¼ˆä¸è¶…è¿‡å‡ åƒä¸ªå”¯ä¸€å€¼ï¼‰ï¼Œæ¯”å¦‚ hostã€regionã€environment ç­‰ã€‚Fields ç”¨äºå­˜å‚¨é«˜åŸºæ•°æˆ–æ•°å€¼å‹æ•°æ®ï¼Œæ¯”å¦‚ CPU ä½¿ç”¨ç‡ã€å†…å­˜å¤§å°ç­‰ã€‚é¿å…åœ¨ Tags ä¸­å­˜å‚¨å”¯ä¸€æ ‡è¯†ç¬¦ï¼ˆå¦‚ UUIDï¼‰ï¼Œè¿™ä¼šå¯¼è‡´ç´¢å¼•è†¨èƒ€ã€‚

**ä½¿ç”¨è¿æ¥æ± ** - è™½ç„¶ InfluxDB Java Client å†…éƒ¨å·²ç»å¤„ç†äº†è¿æ¥å¤ç”¨ï¼Œä½†åœ¨é«˜å¹¶å‘åœºæ™¯ä¸‹å»ºè®®é…ç½®åˆç†çš„è¶…æ—¶æ—¶é—´å’Œé‡è¯•ç­–ç•¥ã€‚

**æ•°æ®ä¿ç•™ç­–ç•¥** - æ ¹æ®ä¸šåŠ¡éœ€æ±‚è®¾ç½®åˆç†çš„æ•°æ®ä¿ç•™æœŸï¼Œé¿å…å­˜å‚¨æ— ç”¨çš„å†å²æ•°æ®ã€‚å¯¹äºé•¿æœŸæ•°æ®ï¼Œå¯ä»¥é€šè¿‡é™é‡‡æ ·ï¼ˆDownsamplingï¼‰å‡å°‘æ•°æ®é‡ï¼Œä¿ç•™èšåˆåçš„ç»Ÿè®¡ä¿¡æ¯è€Œä¸æ˜¯åŸå§‹æ˜ç»†ã€‚

**æŸ¥è¯¢ä¼˜åŒ–** - å§‹ç»ˆåœ¨æŸ¥è¯¢ä¸­ä½¿ç”¨æ—¶é—´èŒƒå›´é™åˆ¶ï¼Œé¿å…å…¨è¡¨æ‰«æã€‚åˆç†ä½¿ç”¨ Tags è¿›è¡Œè¿‡æ»¤ï¼Œå› ä¸º Tags æ˜¯è¢«ç´¢å¼•çš„ã€‚å¯¹äºå¤æ‚çš„èšåˆæŸ¥è¯¢ï¼Œè€ƒè™‘ä½¿ç”¨ Continuous Queryï¼ˆè¿ç»­æŸ¥è¯¢ï¼‰é¢„è®¡ç®—ç»“æœã€‚

------

## ğŸ“ˆ å®æˆ˜æ¡ˆä¾‹ï¼šæœåŠ¡å™¨ç›‘æ§ç³»ç»Ÿ

### å®Œæ•´çš„ç›‘æ§æ•°æ®æµ

ä¸‹é¢å±•ç¤ºä¸€ä¸ªå®Œæ•´çš„ç›‘æ§æ•°æ®æµç¨‹ï¼š

```
[æœåŠ¡å™¨] â†’ [é‡‡é›† Agent] â†’ [SpringBoot API] â†’ [InfluxDB]
                                  â†“
                            [æŸ¥è¯¢ API]
                                  â†“
                          [å¯è§†åŒ–é¢æ¿ï¼ˆGrafanaï¼‰]
```

### ä¸ Grafana é›†æˆ

InfluxDB ä¸ Grafana æ˜¯é»„é‡‘ç»„åˆï¼Œå¯ä»¥å¿«é€Ÿæ­å»ºç›‘æ§é¢æ¿ï¼š

1. åœ¨ Grafana ä¸­æ·»åŠ  InfluxDB æ•°æ®æº
2. é…ç½®æŸ¥è¯¢è¯­å¥ï¼ˆæ”¯æŒ Flux å’Œ InfluxQLï¼‰
3. åˆ›å»ºå¯è§†åŒ–å›¾è¡¨ï¼ˆæŠ˜çº¿å›¾ã€æŸ±çŠ¶å›¾ã€ä»ªè¡¨ç›˜ç­‰ï¼‰
4. è®¾ç½®å‘Šè­¦è§„åˆ™ï¼ˆCPU è¶…è¿‡ 80% å‘é€é€šçŸ¥ï¼‰

![Grafana ç›‘æ§é¢æ¿ç¤ºä¾‹](06.æ—¶åºæ•°æ®åº“.assets/image-20251020145206195.png)

### å‘Šè­¦æœåŠ¡é›†æˆ

åœ¨ SpringBoot ä¸­å¯ä»¥é›†æˆå‘Šè­¦é€»è¾‘ï¼š

```java
package com.example.service;

import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Service;

@Slf4j
@Service
@RequiredArgsConstructor
public class AlertService {
    
    private final MetricsQueryService queryService;
    
    /**
     * æ£€æŸ¥ CPU ä½¿ç”¨ç‡å‘Šè­¦
     */
    public void checkCpuAlert(String host) {
        var avgCpu = queryService.queryAvgCpuUsage("5m", "1m");
        
        if (avgCpu.get(host) != null && avgCpu.get(host) > 80.0) {
            log.warn("å‘Šè­¦: ä¸»æœº {} CPU ä½¿ç”¨ç‡è¶…è¿‡ 80%: {}%", 
                     host, avgCpu.get(host));
            // å‘é€å‘Šè­¦é€šçŸ¥ï¼ˆé‚®ä»¶ã€é’‰é’‰ã€Slack ç­‰ï¼‰
            sendAlert(host, "CPU ä½¿ç”¨ç‡è¿‡é«˜", avgCpu.get(host));
        }
    }
    
    private void sendAlert(String host, String message, Double value) {
        // å®ç°å‘Šè­¦é€šçŸ¥é€»è¾‘
        log.info("å‘é€å‘Šè­¦: host={}, message={}, value={}", host, message, value);
    }
}
```

------

## ğŸ“ æ€»ç»“ä¸æœ€ä½³å®è·µ

### æ—¶åºæ•°æ®åº“é€‰å‹å»ºè®®

**é€‰æ‹© InfluxDB çš„åœºæ™¯**ï¼šå•æœºæˆ–ä¸­å°è§„æ¨¡é›†ç¾¤ï¼Œéœ€è¦å¿«é€Ÿä¸Šæ‰‹ï¼Œå¯¹ SQL å‹å¥½ï¼Œé€‚åˆç›‘æ§ã€IoT ç­‰åœºæ™¯ã€‚

**é€‰æ‹© Prometheus çš„åœºæ™¯**ï¼šKubernetes ç”Ÿæ€ï¼ŒPull æ¨¡å¼é‡‡é›†ï¼Œå¼ºå¤§çš„æŸ¥è¯¢è¯­è¨€ï¼ˆPromQLï¼‰ï¼Œé€‚åˆäº‘åŸç”Ÿç›‘æ§ã€‚

**é€‰æ‹© TimescaleDB çš„åœºæ™¯**ï¼šå·²æœ‰ PostgreSQL æŠ€èƒ½æ ˆï¼Œéœ€è¦å…³ç³»å‹ç‰¹æ€§ï¼ˆJOINã€äº‹åŠ¡ï¼‰ï¼Œå¯¹ SQL å…¼å®¹æ€§è¦æ±‚é«˜ã€‚

**é€‰æ‹© ClickHouse çš„åœºæ™¯**ï¼šè¶…å¤§è§„æ¨¡æ•°æ®ï¼ˆPB çº§ï¼‰ï¼Œå®æ—¶åˆ†æéœ€æ±‚ï¼Œéœ€è¦å¤æ‚çš„ SQL æŸ¥è¯¢ã€‚

### æ ¸å¿ƒè¦ç‚¹å›é¡¾

æ—¶åºæ•°æ®åº“ä¸“ä¸ºæ—¶é—´åºåˆ—æ•°æ®ä¼˜åŒ–ï¼Œæä¾›é«˜æ€§èƒ½å†™å…¥ã€é«˜å‹ç¼©æ¯”å­˜å‚¨ã€å¿«é€Ÿæ—¶é—´èŒƒå›´æŸ¥è¯¢ç­‰ç‰¹æ€§ã€‚InfluxDB é‡‡ç”¨ LSM-Tree å­˜å‚¨å¼•æ“ï¼Œæ”¯æŒçµæ´»çš„æ•°æ®æ¨¡å‹ï¼ˆMeasurementã€Tagsã€Fieldsï¼‰å’Œå¼ºå¤§çš„æŸ¥è¯¢è¯­è¨€ã€‚åœ¨ SpringBoot ä¸­é›†æˆ InfluxDB éå¸¸ç®€å•ï¼Œé€šè¿‡å®˜æ–¹ Java Client å³å¯å®ç°æ•°æ®çš„è¯»å†™æ“ä½œã€‚åˆç†è®¾è®¡ Schemaã€ä½¿ç”¨æ‰¹é‡å†™å…¥ã€è®¾ç½®æ•°æ®ä¿ç•™ç­–ç•¥æ˜¯ç”Ÿäº§ç¯å¢ƒçš„å…³é”®ã€‚

### è¿›é˜¶å­¦ä¹ èµ„æº

- [InfluxDB å®˜æ–¹æ–‡æ¡£](https://docs.influxdata.com/)
- [Flux æŸ¥è¯¢è¯­è¨€æŒ‡å—](https://docs.influxdata.com/flux/)
- [æ—¶åºæ•°æ®åº“æ€§èƒ½åŸºå‡†æµ‹è¯•](https://www.timescale.com/blog/time-series-database-benchmarks/)
- [Grafana å¯è§†åŒ–æœ€ä½³å®è·µ](https://grafana.com/docs/grafana/latest/best-practices/)

------

## ğŸš€ ä¸‹ä¸€æ­¥

ç°åœ¨ä½ å·²ç»æŒæ¡äº†æ—¶åºæ•°æ®åº“çš„æ ¸å¿ƒæ¦‚å¿µå’Œ SpringBoot æ•´åˆå®è·µï¼Œå¯ä»¥å°è¯•ï¼š

1. åœ¨ä½ çš„é¡¹ç›®ä¸­å¼•å…¥ InfluxDB æ›¿ä»£ä¼ ç»Ÿç›‘æ§æ–¹æ¡ˆ
2. ä½¿ç”¨ Grafana æ­å»ºå¯è§†åŒ–ç›‘æ§é¢æ¿
3. æ¢ç´¢æ›´é«˜çº§çš„ç‰¹æ€§ï¼ˆContinuous Queryã€Kapacitor å‘Šè­¦ç­‰ï¼‰
4. ç ”ç©¶åˆ†å¸ƒå¼æ—¶åºæ•°æ®åº“é›†ç¾¤æ–¹æ¡ˆ

æ—¶åºæ•°æ®åº“æ˜¯ç°ä»£å¯è§‚æµ‹æ€§ä½“ç³»çš„åŸºçŸ³ï¼ŒæŒæ¡å®ƒå°†è®©ä½ çš„ç³»ç»Ÿç›‘æ§èƒ½åŠ›æå‡åˆ°æ–°çš„é«˜åº¦ï¼ğŸ’ª
