####  实体店的"AI营销助手"小程序

**目标用户**：服装店、母婴店、家居店等

- 核心功能：
  - 顾客到店扫码建档
  - AI分析购买偏好，推送个性化优惠
  - 自动生成营销文案和海报
  - 裂变活动工具包
- **获客**：找连锁品牌或加盟体系合作



# 实体店AI营销助手 - 完整需求文档 (PRD)

**版本**: 1.0
 **日期**: 2025年10月
 **项目周期**: 3个月（MVP + 1.0版本）
 **目标**: 帮助实体零售店通过AI实现智能会员管理和个性化营销

------

## 一、项目概述

### 1.1 产品定位

为中小型实体零售店（服装、母婴、家居、化妆品等）提供一站式智能营销解决方案，通过AI技术实现会员精细化运营和个性化推荐，提升复购率和客单价。

### 1.2 核心价值

- **商家侧**: 自动化会员分层、智能推荐商品、降低营销成本、提升销售额
- **顾客侧**: 获得个性化购物体验、专属优惠、积分权益
- **差异化**: AI驱动的推荐系统 + 自动化营销 + 简单易用

### 1.3 目标用户

- **主要用户**: 20-200平米的实体零售店老板
- **次要用户**: 店员（日常操作）、顾客（小程序购物）
- **用户特征**: 有微信私域运营需求，但缺乏技术能力和专业营销人员

### 1.4 商业模式

- **SaaS订阅制**: 按年收费，分基础版/标准版/高级版
- 定价策略:
  - 基础版 ¥3,980/年（500会员上限）
  - 标准版 ¥6,980/年（2000会员上限，主推）
  - 高级版 ¥12,800/年（无上限 + 定制服务）

------

## 二、技术架构设计

### 2.1 技术栈选型

#### 前端技术栈

**顾客端小程序（uni-app）**

```json
{
  "框架": "uni-app 3.x",
  "语言": "Vue 3.4+ + TypeScript 5.x",
  "状态管理": "Pinia 2.1+",
  "UI组件库": "uView Plus 3.2+",
  "网络请求": "Axios 1.6+ (带拦截器)",
  "构建工具": "Vite 5.x",
  "代码规范": "ESLint 8+ + Prettier 3+",
  
  "核心依赖": {
    "@dcloudio/uni-app": "^3.0.0",
    "vue": "^3.4.0",
    "pinia": "^2.1.7",
    "uview-plus": "^3.2.0",
    "axios": "^1.6.5",
    "dayjs": "^1.11.10",
    "lodash-es": "^4.17.21",
    "vant-weapp": "^1.11.0"
  },
  
  "发布平台": [
    "微信小程序（主要）",
    "H5",
    "支付宝小程序（可选）"
  ],
  
  "目录结构": {
    "src/": {
      "pages/": "页面",
      "components/": "公共组件",
      "store/": "状态管理",
      "api/": "接口定义",
      "utils/": "工具函数",
      "static/": "静态资源"
    }
  }
}
```

**管理后台（Vue 3 + Element Plus）**

```json
{
  "框架": "Vue 3.4+",
  "语言": "TypeScript 5.x",
  "构建工具": "Vite 5.x",
  "UI组件库": "Element Plus 2.5+",
  "状态管理": "Pinia 2.1+",
  "路由": "Vue Router 4.2+",
  "图表库": "ECharts 5.5+",
  "网络请求": "Axios 1.6+",
  "代码规范": "ESLint 8+ + Prettier 3+",
  
  "核心依赖": {
    "vue": "^3.4.0",
    "element-plus": "^2.5.0",
    "vue-router": "^4.2.5",
    "pinia": "^2.1.7",
    "axios": "^1.6.5",
    "echarts": "^5.5.0",
    "lodash-es": "^4.17.21",
    "dayjs": "^1.11.10",
    "@vueuse/core": "^10.7.0",
    "nprogress": "^0.2.0"
  },
  
  "推荐插件": {
    "vite-plugin-vue-setup-extend": "页面name支持",
    "unplugin-auto-import": "自动导入API",
    "unplugin-vue-components": "自动导入组件"
  }
}
```

#### 后端技术栈

**核心框架（升级到最新稳定版）**

```yaml
语言: Java 17 LTS (推荐) 或 Java 21 LTS
框架: Spring Boot 3.2.x (最新稳定版)
架构模式: 多模块Maven项目

为什么选择Java 17 + Spring Boot 3.2？
  ✅ Java 17是LTS版本，支持到2029年
  ✅ Spring Boot 3.x性能提升30%+
  ✅ 原生支持GraalVM（可编译成原生镜像，启动更快）
  ✅ 改进的可观测性（Micrometer原生支持）
  ✅ HTTP Client升级，性能更好
  ✅ 更好的虚拟线程支持（Project Loom）
  ✅ Records、Pattern Matching等新特性简化代码

核心依赖:
  spring-boot-starter-web: 3.2.2
  spring-boot-starter-data-redis: 3.2.2
  spring-boot-starter-validation: 3.2.2
  spring-boot-starter-actuator: 3.2.2
  spring-boot-starter-amqp: 3.2.2 (RabbitMQ)
  
持久层:
  MyBatis-Plus: 3.5.5 (支持Spring Boot 3)
  HikariCP: 自动集成 (连接池)
  MySQL Connector: 8.2.0
  
缓存与分布式:
  Spring Data Redis: 3.2.2
  Redisson: 3.26.0 (分布式锁、限流、布隆过滤器)
  Caffeine: 3.1.8 (本地缓存)
  
消息队列:
  RabbitMQ: 最新稳定版
  Spring AMQP: 3.1.1
  
工具库:
  Lombok: 1.18.30
  Hutool: 5.8.25 (Java工具类集合)
  Guava: 33.0.0 (Google核心库)
  MapStruct: 1.5.5 (Bean映射)
  FastJSON2: 2.0.45 (阿里JSON库，性能最好)
  
API文档:
  Knife4j (Swagger增强): 4.4.0
  SpringDoc OpenAPI: 2.3.0
  
安全认证:
  Sa-Token: 1.37.0 (轻量级权限认证框架)
  或 Spring Security 6 + JWT
  
支付SDK:
  WxJava (微信全家桶): 4.6.0
    - weixin-java-pay (微信支付)
    - weixin-java-miniapp (小程序)
  
HTTP客户端:
  OkHttp: 4.12.0
  或 Spring WebClient (响应式，推荐用于AI调用)
  
序列化:
  Jackson: 2.16.1 (Spring默认)
  或 Gson: 2.10.1
  
日志:
  Logback (Spring Boot默认)
  + SLF4J 2.0.x
  
监控:
  Micrometer: 1.12.x (指标收集)
  Prometheus: 集成
  
测试:
  JUnit 5: 5.10.x
  Mockito: 5.8.x
  TestContainers: 1.19.x (集成测试)
```

**项目模块结构**

```
shop-ai-marketing/
├── pom.xml (父POM - Spring Boot 3.2.2)
│
├── shop-common/ (公共模块)
│   ├── common-core/
│   │   ├── enums/ (枚举)
│   │   ├── constants/ (常量)
│   │   ├── exception/ (自定义异常)
│   │   ├── domain/ (公共实体: Result, PageResult)
│   │   └── utils/ (工具类)
│   │
│   ├── common-redis/
│   │   ├── config/ (Redis配置)
│   │   ├── utils/ (RedisUtils)
│   │   └── lock/ (分布式锁)
│   │
│   ├── common-web/
│   │   ├── config/ (Web配置: CORS, Jackson)
│   │   ├── interceptor/ (拦截器)
│   │   ├── filter/ (过滤器)
│   │   └── handler/ (全局异常处理)
│   │
│   ├── common-security/
│   │   ├── config/ (Sa-Token配置)
│   │   ├── interceptor/ (认证拦截器)
│   │   └── utils/ (SecurityUtils)
│   │
│   └── common-mybatis/
│       ├── config/ (MyBatis-Plus配置)
│       ├── handler/ (字段填充、租户)
│       └── interceptor/ (分页、性能分析)
│
├── shop-api/ (API接口定义 - Feign接口)
│   ├── api-user/
│   ├── api-product/
│   └── api-order/
│
├── shop-model/ (领域模型)
│   ├── entity/ (实体类)
│   ├── dto/ (数据传输对象)
│   ├── vo/ (视图对象)
│   └── query/ (查询对象)
│
├── shop-service/ (业务服务)
│   │
│   ├── service-user/ (用户服务 8081)
│   │   ├── controller/
│   │   ├── service/
│   │   ├── mapper/
│   │   └── UserServiceApplication.java
│   │
│   ├── service-product/ (商品服务 8082)
│   │   ├── controller/
│   │   ├── service/
│   │   ├── mapper/
│   │   └── ProductServiceApplication.java
│   │
│   ├── service-order/ (订单服务 8083)
│   │   ├── controller/
│   │   ├── service/
│   │   ├── mapper/
│   │   └── OrderServiceApplication.java
│   │
│   ├── service-recommend/ (推荐服务 8084) ⭐️核心
│   │   ├── controller/
│   │   ├── service/
│   │   │   ├── RecommendService (推荐主服务)
│   │   │   ├── AIService (AI调用服务)
│   │   │   ├── RuleEngineService (规则引擎)
│   │   │   └── CollaborativeFilteringService (协同过滤)
│   │   ├── algorithm/ (算法包)
│   │   ├── mapper/
│   │   └── RecommendServiceApplication.java
│   │
│   ├── service-marketing/ (营销服务 8085)
│   │   ├── controller/
│   │   ├── service/
│   │   │   ├── CouponService (优惠券)
│   │   │   ├── CampaignService (营销活动)
│   │   │   └── AutoTriggerService (自动触发)
│   │   ├── listener/ (RabbitMQ监听器)
│   │   ├── mapper/
│   │   └── MarketingServiceApplication.java
│   │
│   ├── service-analytics/ (数据分析服务 8086)
│   │   ├── controller/
│   │   ├── service/
│   │   │   ├── StatisticsService (统计)
│   │   │   ├── RFMService (RFM计算)
│   │   │   └── AIInsightService (AI洞察)
│   │   ├── scheduled/ (定时任务)
│   │   ├── mapper/
│   │   └── AnalyticsServiceApplication.java
│   │
│   └── service-admin/ (管理服务 8087)
│       ├── controller/ (后台管理接口)
│       ├── service/
│       ├── mapper/
│       └── AdminServiceApplication.java
│
├── shop-gateway/ (网关服务 8080)
│   ├── config/ (Gateway配置)
│   ├── filter/ (全局过滤器)
│   └── GatewayApplication.java
│
└── shop-infrastructure/ (基础设施)
    ├── rabbitmq/ (消息队列配置)
    ├── redis/ (Redis配置)
    └── ai/ (AI服务集成)
```

**Maven父POM关键配置**

```xml
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 
         http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>
    
    <groupId>com.shopai</groupId>
    <artifactId>shop-ai-marketing</artifactId>
    <version>1.0.0</version>
    <packaging>pom</packaging>
    
    <parent>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-parent</artifactId>
        <version>3.2.2</version>
        <relativePath/>
    </parent>
    
    <properties>
        <java.version>17</java.version>
        <project.build.sourceEncoding>UTF-8</project.build.sourceEncoding>
        <maven.compiler.source>17</maven.compiler.source>
        <maven.compiler.target>17</maven.compiler.target>
        
        <!-- 依赖版本管理 -->
        <mybatis-plus.version>3.5.5</mybatis-plus.version>
        <hutool.version>5.8.25</hutool.version>
        <guava.version>33.0.0</guava.version>
        <fastjson2.version>2.0.45</fastjson2.version>
        <redisson.version>3.26.0</redisson.version>
        <sa-token.version>1.37.0</sa-token.version>
        <knife4j.version>4.4.0</knife4j.version>
        <wxjava.version>4.6.0</wxjava.version>
        <mapstruct.version>1.5.5.Final</mapstruct.version>
        <lombok.version>1.18.30</lombok.version>
    </properties>
    
    <dependencyManagement>
        <dependencies>
            <!-- MyBatis-Plus -->
            <dependency>
                <groupId>com.baomidou</groupId>
                <artifactId>mybatis-plus-boot-starter</artifactId>
                <version>${mybatis-plus.version}</version>
            </dependency>
            
            <!-- Hutool工具类 -->
            <dependency>
                <groupId>cn.hutool</groupId>
                <artifactId>hutool-all</artifactId>
                <version>${hutool.version}</version>
            </dependency>
            
            <!-- Guava -->
            <dependency>
                <groupId>com.google.guava</groupId>
                <artifactId>guava</artifactId>
                <version>${guava.version}</version>
            </dependency>
            
            <!-- FastJSON2 -->
            <dependency>
                <groupId>com.alibaba.fastjson2</groupId>
                <artifactId>fastjson2</artifactId>
                <version>${fastjson2.version}</version>
            </dependency>
            
            <!-- Redisson -->
            <dependency>
                <groupId>org.redisson</groupId>
                <artifactId>redisson-spring-boot-starter</artifactId>
                <version>${redisson.version}</version>
            </dependency>
            
            <!-- Sa-Token -->
            <dependency>
                <groupId>cn.dev33</groupId>
                <artifactId>sa-token-spring-boot3-starter</artifactId>
                <version>${sa-token.version}</version>
            </dependency>
            
            <!-- Knife4j API文档 -->
            <dependency>
                <groupId>com.github.xiaoymin</groupId>
                <artifactId>knife4j-openapi3-jakarta-spring-boot-starter</artifactId>
                <version>${knife4j.version}</version>
            </dependency>
            
            <!-- 微信SDK -->
            <dependency>
                <groupId>com.github.binarywang</groupId>
                <artifactId>weixin-java-miniapp</artifactId>
                <version>${wxjava.version}</version>
            </dependency>
            <dependency>
                <groupId>com.github.binarywang</groupId>
                <artifactId>weixin-java-pay</artifactId>
                <version>${wxjava.version}</version>
            </dependency>
            
            <!-- MapStruct -->
            <dependency>
                <groupId>org.mapstruct</groupId>
                <artifactId>mapstruct</artifactId>
                <version>${mapstruct.version}</version>
            </dependency>
            <dependency>
                <groupId>org.mapstruct</groupId>
                <artifactId>mapstruct-processor</artifactId>
                <version>${mapstruct.version}</version>
            </dependency>
        </dependencies>
    </dependencyManagement>
    
    <build>
        <plugins>
            <plugin>
                <groupId>org.springframework.boot</groupId>
                <artifactId>spring-boot-maven-plugin</artifactId>
            </plugin>
            <plugin>
                <groupId>org.apache.maven.plugins</groupId>
                <artifactId>maven-compiler-plugin</artifactId>
                <version>3.11.0</version>
                <configuration>
                    <source>17</source>
                    <target>17</target>
                    <annotationProcessorPaths>
                        <path>
                            <groupId>org.projectlombok</groupId>
                            <artifactId>lombok</artifactId>
                            <version>${lombok.version}</version>
                        </path>
                        <path>
                            <groupId>org.mapstruct</groupId>
                            <artifactId>mapstruct-processor</artifactId>
                            <version>${mapstruct.version}</version>
                        </path>
                    </annotationProcessorPaths>
                </configuration>
            </plugin>
        </plugins>
    </build>
</project>
```

#### 数据库设计

**MySQL 8.0**

```yaml
版本: MySQL 8.0.35+ (最新稳定版)
引擎: InnoDB
字符集: utf8mb4
排序规则: utf8mb4_unicode_ci

配置建议:
  max_connections: 200
  innodb_buffer_pool_size: 2G
  innodb_log_file_size: 512M
  innodb_flush_log_at_trx_commit: 1
  max_allowed_packet: 64M
  
索引策略:
  - 所有外键字段建立索引
  - 查询频繁的字段组合建立联合索引
  - 时间范围查询字段建立索引
  - 使用JSON字段时配合虚拟列+索引
  
性能优化:
  - 使用prepared statement
  - 批量插入优化
  - 分页查询使用游标
  - 定期ANALYZE TABLE
```

**Redis 7.x**

```yaml
版本: Redis 7.2+ (最新稳定版)
部署模式: 单机 (初期) / 主从+哨兵 (扩展期)

数据结构使用:
  - String: 缓存用户信息、商品详情
  - Hash: 用户画像、会员等级配置
  - List: 消息队列（辅助）
  - Set: 用户标签、商品标签、去重
  - ZSet: 热销商品排行、推荐商品评分
  - Bitmap: 用户签到记录、活跃用户统计
  - HyperLogLog: UV统计
  - Bloom Filter: 防止缓存穿透
  
缓存策略:
  - 用户画像: 1小时 TTL + 懒加载
  - 商品信息: 30分钟 TTL
  - 推荐结果: 10-60分钟 TTL (根据场景动态)
  - 热门数据: 永久 + LRU策略
  
键命名规范:
  - user:info:{userId}
  - product:detail:{productId}
  - recommend:{userId}:{scene}
  - ranking:hot:daily
```

#### 中间件

**RabbitMQ 3.13**

```yaml
版本: RabbitMQ 3.13+ (支持Streams等新特性)

交换机设计:
  - shop.direct.exchange (Direct - 精确路由)
  - shop.topic.exchange (Topic - 模式匹配)
  - shop.fanout.exchange (Fanout - 广播)
  - shop.delay.exchange (Delay - 延迟消息)

队列设计:
  business:
    - coupon.send.queue (发券)
    - message.push.queue (推送)
    - order.event.queue (订单事件)
    - member.event.queue (会员事件)
    - analytics.task.queue (统计任务)
  
  dead_letter:
    - dlx.queue (死信队列)
    - retry.queue (重试队列)

消息模型:
  - 优先级队列: 重要消息优先处理
  - 延迟队列: 定时任务（召回、生日祝福）
  - 持久化: 重要消息持久化
  
消费策略:
  - 手动ACK
  - 限流（prefetch=1）
  - 死信处理
  - 幂等性保证
```

#### AI服务集成

**推荐方案（按优先级）**

~~~yaml
方案1: 阿里云通义千问 (生产环境推荐) ⭐️
  模型:
    - qwen-turbo: 最便宜，适合高频调用
    - qwen-plus: 平衡性价比
    - qwen-max: 最强能力
  
  成本:
    - qwen-turbo: ¥0.004/千tokens
    - qwen-plus: ¥0.008/千tokens
    - qwen-max: ¥0.12/千tokens
  
  优势:
    ✅ 成本极低（是OpenAI的1/50）
    ✅ 中文理解优秀
    ✅ 国内访问快
    ✅ 有免费额度
    ✅ 合规性好
  
  SDK:
    - dashscope-sdk-java: 2.14.0
  
  示例代码:
    ```java
    // 添加依赖
    <dependency>
        <groupId>com.alibaba</groupId>
        <artifactId>dashscope-sdk-java</artifactId>
        <version>2.14.0</version>
    </dependency>
    
    // 调用示例
    @Service
    public class QwenAIService {
        @Value("${ai.dashscope.api-key}")
        private String apiKey;
        
        public String generate(String prompt) {
            Generation gen = new Generation();
            GenerationParam param = GenerationParam.builder()
                .model("qwen-turbo")
                .prompt(prompt)
                .apiKey(apiKey)
                .build();
            GenerationResult result = gen.call(param);
            return result.getOutput().getText();
        }
    }
    ```

方案2: 百度文心一言 (备选)
  模型:
    - ernie-speed: 最快最便宜
    - ernie-lite: 轻量级
    - ernie-4.0: 最强
  
  成本:
    - ernie-speed: ¥0.004/千tokens
    - 新用户有免费额度
  
  SDK:
    - qianfan-java-sdk: 0.3.0

方案3: OpenAI (对比测试用)
  模型:
    - gpt-3.5-turbo: $0.5-2/1M tokens
    - gpt-4-turbo: $10-30/1M tokens
  
  注意:
    - 需要海外服务器或代理
    - 成本高
    - 仅用于效果对比

方案4: 本地模型 (可选 - 零成本)
  模型:
    - Qwen-7B (阿里开源)
    - ChatGLM3-6B (智谱开源)
  
  部署:
    - Ollama (本地运行工具)
    - FastChat (模型服务)
  
  优势:
    - 零API成本
    - 数据不出服务器
    - 低延迟
  
  劣势:
    - 需要GPU服务器
    - 效果不如云端大模型
    - 运维成本高
~~~

**AI调用架构设计**

```java
// 统一AI服务接口
public interface AIService {
    /**
     * 同步生成
     */
    String generate(String prompt);
    
    /**
     * 带缓存的生成
     */
    String generateWithCache(String cacheKey, String prompt, Duration ttl);
    
    /**
     * 异步生成
     */
    CompletableFuture<String> generateAsync(String prompt);
    
    /**
     * 流式生成
     */
    Flux<String> generateStream(String prompt);
}

// 策略模式 - 支持多个AI Provider
public enum AIProvider {
    QWEN("qwen", "阿里通义千问"),
    ERNIE("ernie", "百度文心"),
    OPENAI("openai", "OpenAI"),
    LOCAL("local", "本地模型");
    
    private final String code;
    private final String name;
}

// AI服务工厂
@Component
public class AIServiceFactory {
    private final Map<AIProvider, AIService> serviceMap = new ConcurrentHashMap<>();
    
    @Autowired
    private QwenAIService qwenService;
    
    @Autowired
    private ErnieAIService ernieService;
    
    @PostConstruct
    public void init() {
        serviceMap.put(AIProvider.QWEN, qwenService);
        serviceMap.put(AIProvider.ERNIE, ernieService);
    }
    
    public AIService getService(AIProvider provider) {
        return serviceMap.get(provider);
    }
}

// 智能路由 - 根据场景选择AI
@Service
public class AIRouter {
    
    @Autowired
    private AIServiceFactory factory;
    
    @Autowired
    private CostControlService costControl;
    
    public AIService route(AIContext context) {
        // 如果超出预算，降级
        if (!costControl.canCallAI()) {
            throw new AIQuotaExceededException();
        }
        
        // VIP用户用最好的模型
        if (context.getUser().isVip()) {
            return factory.getService(AIProvider.QWEN); // qwen-max
        }
        
        // 简单场景用便宜模型
        if (context.getScene().isSimple()) {
            return factory.getService(AIProvider.QWEN); // qwen-turbo
        }
        
        // 默认
        return factory.getService(AIProvider.QWEN);
    }
}

// 降级和容错
@Service
public class ResilientAIService {
    
    @Autowired
    private AIRouter router;
    
    @Autowired
    private RuleBasedRecommendService fallbackService;
    
    @Retryable(
        value = {AIServiceException.class},
        maxAttempts = 3,
        backoff = @Backoff(delay = 1000, multiplier = 2)
    )
    public String generateWithFallback(AIContext context) {
        try {
            AIService service = router.route(context);
            return Timeout.of(Duration.ofSeconds(3))
                .execute(() -> service.generate(context.getPrompt()));
        } catch (Exception e) {
            log.warn("AI调用失败，降级到规则引擎", e);
            return fallbackService.recommend(context);
        }
    }
}

// 成本控制
@Service
public class CostControlService {
    
    @Autowired
    private RedisTemplate<String, Object> redis;
    
    private static final int DAILY_LIMIT = 10000; // 每天1万次
    public boolean canCallAI() {
        String key = "ai:call:count:" + LocalDate.now();
        Long count = redis.opsForValue().increment(key);
        if (count == 1) {
            redis.expire(key, Duration.ofDays(1));
        }
        return count <= DAILY_LIMIT;
    }
    
    public void recordCall(AIProvider provider, int tokens) {
        // 记录每个provider的调用次数和token消耗
        String dateKey = LocalDate.now().toString();
        redis.opsForHash().increment("ai:stats:" + dateKey, provider.name(), 1);
        redis.opsForHash().increment("ai:tokens:" + dateKey, provider.name(), tokens);
    }
    
    public Map<String, Object> getDailyStats() {
        String dateKey = LocalDate.now().toString();
        Map<Object, Object> stats = redis.opsForHash().entries("ai:stats:" + dateKey);
        Map<Object, Object> tokens = redis.opsForHash().entries("ai:tokens:" + dateKey);
        
        return Map.of(
            "calls", stats,
            "tokens", tokens,
            "estimatedCost", calculateCost(tokens)
        );
    }
}

// Prompt模板管理
@Component
public class PromptTemplateManager {
    
    private final Map<String, String> templates = new HashMap<>();
    
    @PostConstruct
    public void init() {
        // 用户画像分析
        templates.put("user_profile_analysis", """
            请分析以下用户的消费行为特征：
            
            ## 基础信息
            - 性别：{gender}
            - 年龄段：{ageRange}
            - 地区：{region}
            
            ## 消费数据
            - 总消费金额：¥{totalAmount}
            - 订单数量：{orderCount}
            - 平均客单价：¥{avgAmount}
            - 最近购买：{lastOrderDate}
            
            ## 购买记录
            {purchaseHistory}
            
            请从以下维度分析用户特征（返回JSON格式）：
            1. consumptionLevel: low/medium/high
            2. priceSensitivity: 0.0-1.0
            3. preferredCategories: [分类1, 分类2, ...]
            4. purchaseFrequency: high/medium/low
            5. tags: [标签1, 标签2, ...]
            6. insight: 简短的用户洞察（50字内）
            """);
        
        // 商品推荐
        templates.put("product_recommendation", """
            # 任务：为用户推荐商品
            
            ## 用户画像
            {userProfile}
            
            ## 候选商品（JSON数组）
            {candidateProducts}
            
            ## 推荐场景
            {scene}
            
            ## 要求
            1. 从候选商品中选出最适合的5个商品ID
            2. 为每个推荐生成吸引人的理由（20字内）
            3. 考虑用户的消费能力和偏好
            4. 返回JSON格式：
            {
              "recommendations": [
                {
                  "productId": 123,
                  "score": 0.95,
                  "reason": "根据您的购买记录，这款很适合您"
                }
              ]
            }
            """);
        
        // 营销文案生成
        templates.put("marketing_copy", """
            为以下用户生成个性化的营销文案：
            
            ## 用户特征
            - 会员等级：{memberLevel}
            - 最近购买：{recentPurchase}
            - 消费偏好：{preferences}
            
            ## 营销场景
            {scenario}
            
            ## 优惠内容
            {couponInfo}
            
            要求：
            1. 文案亲切、有吸引力
            2. 突出用户专属感
            3. 长度40字以内
            4. 包含emoji（1-2个）
            """);
        
        // AI洞察生成
        templates.put("business_insight", """
            根据以下门店经营数据，给出具体的经营建议：
            
            ## 销售数据
            - 昨日销售额：¥{yesterdaySales} (环比{salesChange}%)
            - 客单价：¥{avgOrderAmount} (环比{amountChange}%)
            - 订单量：{orderCount} (环比{orderChange}%)
            
            ## 会员数据
            - 新增会员：{newMembers}
            - 活跃会员：{activeMembers}
            - 复购率：{repurchaseRate}%
            
            ## 商品数据
            - 热销TOP3：{topProducts}
            - 滞销商品：{slowProducts}
            
            请给出3条具体可执行的经营建议，每条包含：
            1. 问题诊断
            2. 改进建议
            3. 预期效果
            
            返回JSON格式。
            """);
    }
    
    public String render(String templateName, Map<String, Object> variables) {
        String template = templates.get(templateName);
        if (template == null) {
            throw new IllegalArgumentException("Template not found: " + templateName);
        }
        
        StrSubstitutor substitutor = new StrSubstitutor(variables, "{", "}");
        return substitutor.replace(template);
    }
}
```

#### 部署架构

**Docker容器化部署**

```yaml
# docker-compose.yml
version: '3.8'

services:
  # MySQL数据库
  mysql:
    image: mysql:8.0.35
    container_name: shop-mysql
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MYSQL_DATABASE: shop_ai
      TZ: Asia/Shanghai
    ports:
      - "3306:3306"
    volumes:
      - mysql-data:/var/lib/mysql
      - ./init-sql:/docker-entrypoint-initdb.d
    command:
      --default-authentication-plugin=mysql_native_password
      --character-set-server=utf8mb4
      --collation-server=utf8mb4_unicode_ci
      --max_connections=200
      --max_allowed_packet=64M
    networks:
      - shop-network
    restart: always
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      interval: 10s
      timeout: 5s
      retries: 3

  # Redis缓存
  redis:
    image: redis:7.2-alpine
    container_name: shop-redis
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
      - ./redis.conf:/usr/local/etc/redis/redis.conf
    command: redis-server /usr/local/etc/redis/redis.conf
    networks:
      - shop-network
    restart: always
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 3

  # RabbitMQ消息队列
  rabbitmq:
    image: rabbitmq:3.13-management-alpine
    container_name: shop-rabbitmq
    environment:
      RABBITMQ_DEFAULT_USER: ${RABBITMQ_USER}
      RABBITMQ_DEFAULT_PASS: ${RABBITMQ_PASS}
    ports:
      - "5672:5672"
      - "15672:15672"
    volumes:
      - rabbitmq-data:/var/lib/rabbitmq
    networks:
      - shop-network
    restart: always
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3

  # 网关服务
  gateway:
    build:
      context: ./shop-gateway
      dockerfile: Dockerfile
    container_name: shop-gateway
    ports:
      - "8080:8080"
    environment:
      SPRING_PROFILES_ACTIVE: prod
      SPRING_CLOUD_GATEWAY_ROUTES[0]_URI: http://service-user:8081
      SPRING_CLOUD_GATEWAY_ROUTES[1]_URI: http://service-product:8082
    depends_on:
      - redis
    networks:
      - shop-network
    restart: always

  # 用户服务
  service-user:
    build:
      context: ./shop-service/service-user
      dockerfile: Dockerfile
    container_name: service-user
    ports:
      - "8081:8081"
    environment:
      SPRING_PROFILES_ACTIVE: prod
      SPRING_DATASOURCE_URL: jdbc:mysql://mysql:3306/shop_ai?useUnicode=true&characterEncoding=utf8&serverTimezone=Asia/Shanghai
      SPRING_DATASOURCE_USERNAME: ${MYSQL_USER}
      SPRING_DATASOURCE_PASSWORD: ${MYSQL_PASSWORD}
      SPRING_DATA_REDIS_HOST: redis
      SPRING_RABBITMQ_HOST: rabbitmq
      JAVA_OPTS: "-Xms512m -Xmx1024m"
    depends_on:
      mysql:
        condition: service_healthy
      redis:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    networks:
      - shop-network
    restart: always

  # 商品服务
  service-product:
    build:
      context: ./shop-service/service-product
      dockerfile: Dockerfile
    container_name: service-product
    ports:
      - "8082:8082"
    environment:
      SPRING_PROFILES_ACTIVE: prod
      SPRING_DATASOURCE_URL: jdbc:mysql://mysql:3306/shop_ai
      SPRING_DATA_REDIS_HOST: redis
      JAVA_OPTS: "-Xms512m -Xmx1024m"
    depends_on:
      mysql:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - shop-network
    restart: always

  # 订单服务
  service-order:
    build:
      context: ./shop-service/service-order
      dockerfile: Dockerfile
    container_name: service-order
    ports:
      - "8083:8083"
    environment:
      SPRING_PROFILES_ACTIVE: prod
      SPRING_DATASOURCE_URL: jdbc:mysql://mysql:3306/shop_ai
      SPRING_DATA_REDIS_HOST: redis
      SPRING_RABBITMQ_HOST: rabbitmq
      JAVA_OPTS: "-Xms512m -Xmx1024m"
    depends_on:
      - mysql
      - redis
      - rabbitmq
    networks:
      - shop-network
    restart: always

  # 推荐服务（核心）
  service-recommend:
    build:
      context: ./shop-service/service-recommend
      dockerfile: Dockerfile
    container_name: service-recommend
    ports:
      - "8084:8084"
    environment:
      SPRING_PROFILES_ACTIVE: prod
      SPRING_DATASOURCE_URL: jdbc:mysql://mysql:3306/shop_ai
      SPRING_DATA_REDIS_HOST: redis
      AI_DASHSCOPE_API_KEY: ${DASHSCOPE_API_KEY}
      JAVA_OPTS: "-Xms1024m -Xmx2048m" # 推荐服务需要更多内存
    depends_on:
      - mysql
      - redis
    networks:
      - shop-network
    restart: always

  # 营销服务
  service-marketing:
    build:
      context: ./shop-service/service-marketing
      dockerfile: Dockerfile
    container_name: service-marketing
    ports:
      - "8085:8085"
    environment:
      SPRING_PROFILES_ACTIVE: prod
      SPRING_DATASOURCE_URL: jdbc:mysql://mysql:3306/shop_ai
      SPRING_DATA_REDIS_HOST: redis
      SPRING_RABBITMQ_HOST: rabbitmq
      JAVA_OPTS: "-Xms512m -Xmx1024m"
    depends_on:
      - mysql
      - redis
      - rabbitmq
    networks:
      - shop-network
    restart: always

  # 数据分析服务
  service-analytics:
    build:
      context: ./shop-service/service-analytics
      dockerfile: Dockerfile
    container_name: service-analytics
    ports:
      - "8086:8086"
    environment:
      SPRING_PROFILES_ACTIVE: prod
      SPRING_DATASOURCE_URL: jdbc:mysql://mysql:3306/shop_ai
      SPRING_DATA_REDIS_HOST: redis
      AI_DASHSCOPE_API_KEY: ${DASHSCOPE_API_KEY}
      JAVA_OPTS: "-Xms512m -Xmx1024m"
    depends_on:
      - mysql
      - redis
    networks:
      - shop-network
    restart: always

  # Nginx (静态资源 + 反向代理)
  nginx:
    image: nginx:1.25-alpine
    container_name: shop-nginx
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/ssl:/etc/nginx/ssl:ro
      - ./admin-dist:/usr/share/nginx/html/admin:ro
    depends_on:
      - gateway
    networks:
      - shop-network
    restart: always

volumes:
  mysql-data:
  redis-data:
  rabbitmq-data:

networks:
  shop-network:
    driver: bridge
```

**Dockerfile示例**

```dockerfile
# 多阶段构建 - 减小镜像体积
FROM maven:3.9-eclipse-temurin-17 AS builder
WORKDIR /app
COPY pom.xml .
COPY src ./src
RUN mvn clean package -DskipTests -Dmaven.test.skip=true

FROM eclipse-temurin:17-jre-alpine
WORKDIR /app

# 安装必要工具
RUN apk add --no-cache curl

# 创建非root用户
RUN addgroup -S spring && adduser -S spring -G spring
USER spring:spring

# 复制jar包
COPY --from=builder /app/target/*.jar app.jar

# 健康检查
HEALTHCHECK --interval=30s --timeout=3s --start-period=60s --retries=3 \
  CMD curl -f http://localhost:8080/actuator/health || exit 1

# JVM参数优化
ENV JAVA_OPTS="-XX:+UseG1GC \
               -XX:MaxRAMPercentage=75.0 \
               -XX:+HeapDumpOnOutOfMemoryError \
               -XX:HeapDumpPath=/tmp/heapdump.hprof \
               -Djava.security.egd=file:/dev/./urandom"

ENTRYPOINT ["sh", "-c", "java $JAVA_OPTS -jar app.jar"]
```

**Nginx配置**

```nginx
# nginx.conf
user nginx;
worker_processes auto;
error_log /var/log/nginx/error.log warn;
pid /var/run/nginx.pid;

events {
    worker_connections 1024;
    use epoll;
}

http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent" "$http_x_forwarded_for"';

    access_log /var/log/nginx/access.log main;

    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    keepalive_timeout 65;
    types_hash_max_size 2048;
    client_max_body_size 20M;

    # Gzip压缩
    gzip on;
    gzip_vary on;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_types text/plain text/css text/xml text/javascript 
               application/json application/javascript application/xml+rss;

    # 后端API代理
    upstream gateway {
        server gateway:8080;
        keepalive 32;
    }

    # HTTP -> HTTPS重定向
    server {
        listen 80;
        server_name your-domain.com;
        return 301 https://$server_name$request_uri;
    }

    # HTTPS主配置
    server {
        listen 443 ssl http2;
        server_name your-domain.com;

        ssl_certificate /etc/nginx/ssl/cert.pem;
        ssl_certificate_key /etc/nginx/ssl/key.pem;
        ssl_protocols TLSv1.2 TLSv1.3;
        ssl_ciphers HIGH:!aNULL:!MD5;
        ssl_prefer_server_ciphers on;
        ssl_session_cache shared:SSL:10m;
        ssl_session_timeout 10m;

        # 管理后台
        location /admin {
            alias /usr/share/nginx/html/admin;
            index index.html;
            try_files $uri $uri/ /admin/index.html;
        }

        # API代理
        location /api/ {
            proxy_pass http://gateway/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            # 超时设置
            proxy_connect_timeout 60s;
            proxy_send_timeout 60s;
            proxy_read_timeout 60s;
            
            # WebSocket支持
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
        }

        # 静态资源缓存
        location ~* \.(jpg|jpeg|png|gif|ico|css|js|woff|woff2|ttf)$ {
            expires 30d;
            add_header Cache-Control "public, immutable";
        }
    }
}
```

------

## 三、数据库详细设计

### 3.1 完整表结构

#### 用户表 (tb_user)

```sql
CREATE TABLE `tb_user` (
  `id` BIGINT NOT NULL AUTO_INCREMENT COMMENT '用户ID',
  `openid` VARCHAR(64) NOT NULL COMMENT '微信openid',
  `unionid` VARCHAR(64) DEFAULT NULL COMMENT '微信unionid',
  `nickname` VARCHAR(64) DEFAULT NULL COMMENT '昵称',
  `avatar` VARCHAR(255) DEFAULT NULL COMMENT '头像URL',
  `gender` TINYINT DEFAULT 0 COMMENT '性别: 0-未知, 1-男, 2-女',
  `phone` VARCHAR(20) DEFAULT NULL COMMENT '手机号',
  `birthday` DATE DEFAULT NULL COMMENT '生日',    
  `register_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '注册时间',
  `last_visit_time` DATETIME DEFAULT NULL COMMENT '最后访问时间',
  `status` TINYINT NOT NULL DEFAULT 1 COMMENT '状态: 1-正常, 0-禁用',
  `deleted` TINYINT NOT NULL DEFAULT 0 COMMENT '是否删除: 0-否, 1-是',
  `create_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `update_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_openid` (`openid`),
  KEY `idx_phone` (`phone`),
  KEY `idx_register_time` (`register_time`),
  KEY `idx_deleted` (`deleted`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='用户表';
```

#### 用户画像表 (tb_user_profile)

```sql
CREATE TABLE `tb_user_profile` (
  `id` BIGINT NOT NULL AUTO_INCREMENT,
  `user_id` BIGINT NOT NULL COMMENT '用户ID',
  
  -- 基础画像
  `age_range` VARCHAR(20) DEFAULT NULL COMMENT '年龄段: 18-25, 26-35, 36-45, 46+',
  `region` VARCHAR(50) DEFAULT NULL COMMENT '地区（城市）',
  `consumption_level` VARCHAR(20) DEFAULT NULL COMMENT '消费水平: low, medium, high',
  `preferred_categories` JSON DEFAULT NULL COMMENT '偏好品类 ["服装", "鞋靴"]',
  `price_sensitivity` DECIMAL(3,2) DEFAULT NULL COMMENT '价格敏感度: 0.00-1.00',
  `purchase_frequency` VARCHAR(20) DEFAULT NULL COMMENT '购买频率: high, medium, low',
  
  -- RFM模型
  `rfm_recency` INT DEFAULT 0 COMMENT 'R值: 最近消费距今天数',
  `rfm_frequency` INT DEFAULT 0 COMMENT 'F值: 总消费次数',
  `rfm_monetary` DECIMAL(10,2) DEFAULT 0.00 COMMENT 'M值: 总消费金额',
  `rfm_score` INT DEFAULT 0 COMMENT 'RFM总分: 3-15分',
  `member_level` VARCHAR(20) NOT NULL DEFAULT 'normal' COMMENT '会员等级: platinum, gold, silver, normal, sleeping',
  
  -- 统计数据
  `total_amount` DECIMAL(10,2) NOT NULL DEFAULT 0.00 COMMENT '总消费金额',
  `total_orders` INT NOT NULL DEFAULT 0 COMMENT '总订单数',
  `avg_order_amount` DECIMAL(10,2) NOT NULL DEFAULT 0.00 COMMENT '平均订单金额',
  `last_order_date` DATE DEFAULT NULL COMMENT '最后下单日期',
  `first_order_date` DATE DEFAULT NULL COMMENT '首次下单日期',
  
  -- AI增强
  `ai_insight` TEXT DEFAULT NULL COMMENT 'AI生成的用户洞察',
  `ai_tags` JSON DEFAULT NULL COMMENT 'AI打的标签 ["价格敏感", "品质优先"]',
  `ai_update_time` DATETIME DEFAULT NULL COMMENT 'AI分析更新时间',
  
  `create_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `update_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_user_id` (`user_id`),
  KEY `idx_member_level` (`member_level`),
  KEY `idx_rfm_score` (`rfm_score` DESC),
  KEY `idx_last_order_date` (`last_order_date`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='用户画像表';
```

#### 商品表 (tb_product)

```sql
CREATE TABLE `tb_product` (
  `id` BIGINT NOT NULL AUTO_INCREMENT,
  `shop_id` BIGINT NOT NULL COMMENT '店铺ID',
  `name` VARCHAR(200) NOT NULL COMMENT '商品名称',
  `subtitle` VARCHAR(255) DEFAULT NULL COMMENT '副标题',
  `category_id` BIGINT NOT NULL COMMENT '分类ID',
  `category_name` VARCHAR(100) NOT NULL COMMENT '分类名称（冗余）',
  
  -- 价格库存
  `price` DECIMAL(10,2) NOT NULL COMMENT '现价',
  `original_price` DECIMAL(10,2) DEFAULT NULL COMMENT '原价',
  `cost_price` DECIMAL(10,2) DEFAULT NULL COMMENT '成本价（仅老板可见）',
  `stock` INT NOT NULL DEFAULT 0 COMMENT '库存',
  `warning_stock` INT DEFAULT 10 COMMENT '预警库存',
  
  -- 统计数据
  `sales_count` INT NOT NULL DEFAULT 0 COMMENT '销量',
  `view_count` INT NOT NULL DEFAULT 0 COMMENT '浏览量',
  `collect_count` INT NOT NULL DEFAULT 0 COMMENT '收藏量',
  `cart_count` INT NOT NULL DEFAULT 0 COMMENT '加购量',
  
  -- 媒体资源
  `main_image` VARCHAR(255) DEFAULT NULL COMMENT '主图',
  `images` JSON DEFAULT NULL COMMENT '商品图片数组 ["url1", "url2"]',
  `video_url` VARCHAR(255) DEFAULT NULL COMMENT '视频URL',
  
  -- 详情和属性
  `description` TEXT DEFAULT NULL COMMENT '商品详情',
  `tags` JSON DEFAULT NULL COMMENT '标签 ["新品", "热卖", "限时"]',
  `specs` JSON DEFAULT NULL COMMENT '规格 {"颜色": ["红","蓝"], "尺码": ["S","M","L"]}',
  `attributes` JSON DEFAULT NULL COMMENT '属性 {"材质": "纯棉", "产地": "中国"}',
  
  -- 推荐相关
  `recommend_score` DECIMAL(5,2) DEFAULT 0.00 COMMENT '推荐分数（综合评分）',
  `related_products` JSON DEFAULT NULL COMMENT '关联商品ID数组',
  
  -- 管理字段
  `sort` INT NOT NULL DEFAULT 0 COMMENT '排序（越大越靠前）',
  `status` TINYINT NOT NULL DEFAULT 1 COMMENT '状态: 1-上架, 0-下架',
  `deleted` TINYINT NOT NULL DEFAULT 0 COMMENT '是否删除',
  `create_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `update_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  
  PRIMARY KEY (`id`),
  KEY `idx_shop_category` (`shop_id`, `category_id`),
  KEY `idx_status_deleted` (`status`, `deleted`),
  KEY `idx_sales_count` (`sales_count` DESC),
  KEY `idx_recommend_score` (`recommend_score` DESC),
  FULLTEXT KEY `ft_name` (`name`) WITH PARSER ngram
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='商品表';
```

#### 商品分类表 (tb_category)

```sql
CREATE TABLE `tb_category` (
  `id` BIGINT NOT NULL AUTO_INCREMENT,
  `shop_id` BIGINT NOT NULL COMMENT '店铺ID',
  `parent_id` BIGINT DEFAULT 0 COMMENT '父分类ID，0表示一级分类',
  `name` VARCHAR(100) NOT NULL COMMENT '分类名称',
  `icon` VARCHAR(255) DEFAULT NULL COMMENT '图标',
  `sort` INT NOT NULL DEFAULT 0 COMMENT '排序',
  `level` TINYINT NOT NULL DEFAULT 1 COMMENT '层级: 1-一级, 2-二级',
  `status` TINYINT NOT NULL DEFAULT 1 COMMENT '状态: 1-启用, 0-停用',
  `deleted` TINYINT NOT NULL DEFAULT 0,
  `create_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `update_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  
  PRIMARY KEY (`id`),
  KEY `idx_shop_parent` (`shop_id`, `parent_id`),
  KEY `idx_status` (`status`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='商品分类表';
```

#### 订单表 (tb_order)

```sql
CREATE TABLE `tb_order` (
  `id` BIGINT NOT NULL AUTO_INCREMENT,
  `order_no` VARCHAR(32) NOT NULL COMMENT '订单号',
  `shop_id` BIGINT NOT NULL COMMENT '店铺ID',
  `user_id` BIGINT NOT NULL COMMENT '用户ID',
  
  -- 金额相关
  `total_amount` DECIMAL(10,2) NOT NULL COMMENT '商品总额',
  `discount_amount` DECIMAL(10,2) NOT NULL DEFAULT 0.00 COMMENT '优惠金额',
  `coupon_amount` DECIMAL(10,2) NOT NULL DEFAULT 0.00 COMMENT '优惠券抵扣',
  `point_amount` DECIMAL(10,2) NOT NULL DEFAULT 0.00 COMMENT '积分抵扣',
  `pay_amount` DECIMAL(10,2) NOT NULL COMMENT '实付金额',
  
  -- 支付信息
  `pay_type` VARCHAR(20) DEFAULT NULL COMMENT '支付方式: wxpay, alipay, balance',
  `pay_time` DATETIME DEFAULT NULL COMMENT '支付时间',
  `transaction_id` VARCHAR(64) DEFAULT NULL COMMENT '第三方交易号',
  
  -- 优惠券和积分
  `coupon_id` BIGINT DEFAULT NULL COMMENT '使用的优惠券ID',
  `use_points` INT DEFAULT 0 COMMENT '使用积分数',
  `earn_points` INT DEFAULT 0 COMMENT '获得积分数',
  
  -- 订单状态
  `status` TINYINT NOT NULL DEFAULT 0 COMMENT '状态: 0-待付款, 1-已付款, 2-已完成, 9-已取消',
  `cancel_reason` VARCHAR(255) DEFAULT NULL COMMENT '取消原因',
  `finish_time` DATETIME DEFAULT NULL COMMENT '完成时间',
  
  -- 推荐来源追踪
  `source` VARCHAR(50) DEFAULT NULL COMMENT '订单来源: recommend, search, direct',
  `recommend_scene` VARCHAR(50) DEFAULT NULL COMMENT '推荐场景',
  
  `remark` VARCHAR(500) DEFAULT NULL COMMENT '用户备注',
  `deleted` TINYINT NOT NULL DEFAULT 0,
  `create_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '下单时间',
  `update_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_order_no` (`order_no`),
  KEY `idx_user_id` (`user_id`),
  KEY `idx_shop_id` (`shop_id`),
  KEY `idx_status` (`status`),
  KEY `idx_create_time` (`create_time` DESC),
  KEY `idx_pay_time` (`pay_time`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='订单表';
```

#### 订单明细表 (tb_order_item)

```sql
CREATE TABLE `tb_order_item` (
  `id` BIGINT NOT NULL AUTO_INCREMENT,
  `order_id` BIGINT NOT NULL COMMENT '订单ID',
  `product_id` BIGINT NOT NULL COMMENT '商品ID',
  `product_name` VARCHAR(200) NOT NULL COMMENT '商品名称',
  `product_image` VARCHAR(255) DEFAULT NULL COMMENT '商品图片',
  `category_name` VARCHAR(100) DEFAULT NULL COMMENT '商品分类',
  
  -- 规格和价格
  `spec_info` VARCHAR(255) DEFAULT NULL COMMENT '规格信息: 颜色:红色,尺码:M',
  `price` DECIMAL(10,2) NOT NULL COMMENT '商品单价',
  `quantity` INT NOT NULL COMMENT '购买数量',
  `total_amount` DECIMAL(10,2) NOT NULL COMMENT '小计金额',
  
  `create_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  
  PRIMARY KEY (`id`),
  KEY `idx_order_id` (`order_id`),
  KEY `idx_product_id` (`product_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='订单明细表';
```

#### 用户行为表 (tb_user_behavior)

```sql
CREATE TABLE `tb_user_behavior` (
  `id` BIGINT NOT NULL AUTO_INCREMENT,
  `user_id` BIGINT NOT NULL COMMENT '用户ID',
  `product_id` BIGINT NOT NULL COMMENT '商品ID',
  `behavior_type` VARCHAR(20) NOT NULL COMMENT '行为类型: view-浏览, collect-收藏, cart-加购, buy-购买',
  `scene` VARCHAR(50) DEFAULT NULL COMMENT '场景: home-首页, detail-详情, search-搜索, recommend-推荐',
  `device` VARCHAR(20) DEFAULT NULL COMMENT '设备: miniapp, h5, app',
  `extra_data` JSON DEFAULT NULL COMMENT '额外数据（JSON格式）',
  `create_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '行为时间',
  
  PRIMARY KEY (`id`),
  KEY `idx_user_product` (`user_id`, `product_id`),
  KEY `idx_behavior_type` (`behavior_type`),
  KEY `idx_create_time` (`create_time`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='用户行为表';

-- 按月分表策略（可选）
-- tb_user_behavior_202501, tb_user_behavior_202502...
```

#### 推荐记录表 (tb_recommend_log)

```sql
CREATE TABLE `tb_recommend_log` (
  `id` BIGINT NOT NULL AUTO_INCREMENT,
  `user_id` BIGINT NOT NULL COMMENT '用户ID',
  `product_id` BIGINT NOT NULL COMMENT '商品ID',
  `scene` VARCHAR(50) NOT NULL COMMENT '推荐场景: home, detail, cart, checkout',
  `algorithm` VARCHAR(50) NOT NULL COMMENT '算法: rule-规则, cf-协同过滤, ai-AI推荐, hot-热门',
  `score` DECIMAL(5,4) DEFAULT NULL COMMENT '推荐分数: 0.0000-1.0000',
  `reason` VARCHAR(500) DEFAULT NULL COMMENT '推荐理由（用户可见）',
  `position` INT DEFAULT NULL COMMENT '推荐位置（第几个）',
  
  -- 效果追踪
  `is_exposed` TINYINT NOT NULL DEFAULT 1 COMMENT '是否曝光: 1-是, 0-否',
  `is_clicked` TINYINT NOT NULL DEFAULT 0 COMMENT '是否点击',
  `is_bought` TINYINT NOT NULL DEFAULT 0 COMMENT '是否购买',
  `click_time` DATETIME DEFAULT NULL COMMENT '点击时间',
  `buy_time` DATETIME DEFAULT NULL COMMENT '购买时间',
  
  `create_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '推荐时间',
  
  PRIMARY KEY (`id`),
  KEY `idx_user_id` (`user_id`),
  KEY `idx_product_id` (`product_id`),
  KEY `idx_scene_algorithm` (`scene`, `algorithm`),
  KEY `idx_create_time` (`create_time`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='推荐记录表';

-- 定期归档：保留近3个月数据，历史数据移到归档表
```

#### 优惠券模板表 (tb_coupon)

```sql
CREATE TABLE `tb_coupon` (
  `id` BIGINT NOT NULL AUTO_INCREMENT,
  `shop_id` BIGINT NOT NULL COMMENT '店铺ID',
  `name` VARCHAR(100) NOT NULL COMMENT '优惠券名称',
  `type` VARCHAR(20) NOT NULL COMMENT '类型: discount-折扣券, cash-代金券, gift-礼品券',
  
  -- 折扣信息
  `discount_value` DECIMAL(5,2) DEFAULT NULL COMMENT '折扣值: 8.5表示85折',
  `cash_value` DECIMAL(10,2) DEFAULT NULL COMMENT '代金券金额',
  `min_amount` DECIMAL(10,2) NOT NULL DEFAULT 0.00 COMMENT '使用门槛: 0表示无门槛',
  `max_discount` DECIMAL(10,2) DEFAULT NULL COMMENT '最高优惠金额（折扣券用）',
  
  -- 库存
  `total_count` INT NOT NULL COMMENT '总发放数量: -1表示不限量',
  `remain_count` INT NOT NULL COMMENT '剩余数量',
  `per_user_limit` INT DEFAULT 1 COMMENT '每人限领数量',
  
  -- 有效期
  `valid_type` TINYINT NOT NULL COMMENT '有效期类型: 1-固定日期, 2-领取后N天',
  `valid_days` INT DEFAULT NULL COMMENT '领取后N天有效',
  `start_time` DATETIME DEFAULT NULL COMMENT '固定开始时间',
  `end_time` DATETIME DEFAULT NULL COMMENT '固定结束时间',
  
  -- 使用规则
  `target_level` VARCHAR(100) DEFAULT NULL COMMENT '目标会员等级: platinum,gold,silver',
  `target_category` JSON DEFAULT NULL COMMENT '适用分类ID数组',
  `target_products` JSON DEFAULT NULL COMMENT '适用商品ID数组',
  
  -- 自动发放
  `auto_send` TINYINT NOT NULL DEFAULT 0 COMMENT '是否自动发放: 1-是, 0-否',
  `send_trigger` VARCHAR(50) DEFAULT NULL COMMENT '发放触发: register-注册, birthday-生日, level_up-升级',
  
  `description` VARCHAR(500) DEFAULT NULL COMMENT '使用说明',
  `status` TINYINT NOT NULL DEFAULT 1 COMMENT '状态: 1-启用, 0-停用',
  `deleted` TINYINT NOT NULL DEFAULT 0,
  `create_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `update_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  
  PRIMARY KEY (`id`),
  KEY `idx_shop_id` (`shop_id`),
  KEY `idx_status` (`status`),
  KEY `idx_end_time` (`end_time`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='优惠券模板表';
```

#### 用户优惠券表 (tb_user_coupon)

```sql
CREATE TABLE `tb_user_coupon` (
  `id` BIGINT NOT NULL AUTO_INCREMENT,
  `user_id` BIGINT NOT NULL COMMENT '用户ID',
  `coupon_id` BIGINT NOT NULL COMMENT '优惠券模板ID',
  
  -- 冗余优惠券信息（防止模板被修改影响已发券）
  `coupon_name` VARCHAR(100) NOT NULL,
  `coupon_type` VARCHAR(20) NOT NULL,
  `discount_value` DECIMAL(5,2) DEFAULT NULL,
  `cash_value` DECIMAL(10,2) DEFAULT NULL,
  `min_amount` DECIMAL(10,2) NOT NULL DEFAULT 0.00,
  
  -- 状态
  `status` TINYINT NOT NULL DEFAULT 0 COMMENT '状态: 0-未使用, 1-已使用, 2-已过期, 3-已作废',
  `used_time` DATETIME DEFAULT NULL COMMENT '使用时间',
  `order_id` BIGINT DEFAULT NULL COMMENT '使用的订单ID',
  
  -- 时间
  `receive_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '领取时间',
  `expire_time` DATETIME NOT NULL COMMENT '过期时间',
  `create_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  
  PRIMARY KEY (`id`),
  KEY `idx_user_status` (`user_id`, `status`),
  KEY `idx_coupon_id` (`coupon_id`),
  KEY `idx_expire_time` (`expire_time`),
  KEY `idx_order_id` (`order_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='用户优惠券表';
```

#### 营销活动表 (tb_marketing_campaign)

```sql
CREATE TABLE `tb_marketing_campaign` (
  `id` BIGINT NOT NULL AUTO_INCREMENT,
  `shop_id` BIGINT NOT NULL COMMENT '店铺ID',
  `name` VARCHAR(100) NOT NULL COMMENT '活动名称',
  `type` VARCHAR(50) NOT NULL COMMENT '类型: new_user-新客, recall-召回, level_up-升级, birthday-生日, sleeping-沉睡唤醒',
  
  -- 触发条件（JSON格式）
  `trigger_condition` JSON NOT NULL COMMENT '触发条件 {"type": "new_user"}',
  
  -- 动作配置（JSON格式）
  `action_config` JSON NOT NULL COMMENT '动作配置 {"action": "send_coupon", "coupon_id": 123}',
  
  -- 执行时间
  `execute_time` VARCHAR(50) DEFAULT NULL COMMENT '执行时间: immediate-立即, scheduled-定时, delay-延迟',
  `delay_minutes` INT DEFAULT NULL COMMENT '延迟分钟数',
  `schedule_cron` VARCHAR(100) DEFAULT NULL COMMENT 'Cron表达式',
  
  -- 目标人群
  `target_condition` JSON DEFAULT NULL COMMENT '目标人群条件',
  `target_count` INT DEFAULT NULL COMMENT '预计触达人数',
  
  -- 状态和时间
  `status` TINYINT NOT NULL DEFAULT 1 COMMENT '状态: 1-启用, 0-停用',
  `start_time` DATETIME DEFAULT NULL COMMENT '活动开始时间',
  `end_time` DATETIME DEFAULT NULL COMMENT '活动结束时间',
  
  -- 效果统计
  `trigger_count` INT NOT NULL DEFAULT 0 COMMENT '触发次数',
  `success_count` INT NOT NULL DEFAULT 0 COMMENT '成功次数',
  `fail_count` INT NOT NULL DEFAULT 0 COMMENT '失败次数',
  
  `description` VARCHAR(500) DEFAULT NULL COMMENT '活动说明',
  `deleted` TINYINT NOT NULL DEFAULT 0,
  `create_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `update_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  
  PRIMARY KEY (`id`),
  KEY `idx_shop_type` (`shop_id`, `type`),
  KEY `idx_status` (`status`),
  KEY `idx_time_range` (`start_time`, `end_time`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='营销活动表';
```

#### 积分记录表 (tb_points_log)

```sql
CREATE TABLE `tb_points_log` (
  `id` BIGINT NOT NULL AUTO_INCREMENT,
  `user_id` BIGINT NOT NULL COMMENT '用户ID',
  `type` VARCHAR(20) NOT NULL COMMENT '类型: earn-获得, consume-消费, expire-过期',
  `points` INT NOT NULL COMMENT '积分数（正数为获得，负数为消费）',
  `balance` INT NOT NULL COMMENT '操作后余额',
  `source` VARCHAR(50) NOT NULL COMMENT '来源: order-订单, sign-签到, share-分享, manual-手动',
  `related_id` BIGINT DEFAULT NULL COMMENT '关联ID（如订单ID）',
  `remark` VARCHAR(255) DEFAULT NULL COMMENT '备注',
  `expire_time` DATETIME DEFAULT NULL COMMENT '过期时间',
  `create_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  
  PRIMARY KEY (`id`),
  KEY `idx_user_id` (`user_id`),
  KEY `idx_create_time` (`create_time`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='积分记录表';
```

#### 店铺表 (tb_shop)

```sql
CREATE TABLE `tb_shop` (
  `id` BIGINT NOT NULL AUTO_INCREMENT,
  `name` VARCHAR(100) NOT NULL COMMENT '店铺名称',
  `owner_phone` VARCHAR(20) NOT NULL COMMENT '老板手机号',
  `owner_name` VARCHAR(50) DEFAULT NULL COMMENT '老板姓名',
  
  -- 店铺信息
  `logo` VARCHAR(255) DEFAULT NULL COMMENT 'Logo',
  `banner` VARCHAR(255) DEFAULT NULL COMMENT '横幅图',
  `category` VARCHAR(50) NOT NULL COMMENT '行业分类: clothing-服装, maternal-母婴, home-家居',
  `address` VARCHAR(255) DEFAULT NULL COMMENT '店铺地址',
  `latitude` DECIMAL(10,7) DEFAULT NULL COMMENT '纬度',
  `longitude` DECIMAL(10,7) DEFAULT NULL COMMENT '经度',
  `business_hours` VARCHAR(100) DEFAULT NULL COMMENT '营业时间',
  
  -- 订阅信息
  `subscription_plan` VARCHAR(20) NOT NULL DEFAULT 'basic' COMMENT '订阅套餐: basic-基础版, standard-标准版, premium-高级版',
  `subscription_start` DATE NOT NULL COMMENT '订阅开始日期',
  `subscription_expire` DATE NOT NULL COMMENT '订阅到期日期',
  `member_limit` INT NOT NULL DEFAULT 500 COMMENT '会员数上限',
  `is_trial` TINYINT NOT NULL DEFAULT 0 COMMENT '是否试用: 1-是, 0-否',
  `trial_expire` DATE DEFAULT NULL COMMENT '试用到期日期',
  
  -- 配置信息（JSON）
  `config` JSON DEFAULT NULL COMMENT '店铺配置 {"theme": "blue", "features": []}',
  
  -- 统计数据
  `total_members` INT NOT NULL DEFAULT 0 COMMENT '总会员数',
  `total_products` INT NOT NULL DEFAULT 0 COMMENT '总商品数',
  `total_orders` INT NOT NULL DEFAULT 0 COMMENT '总订单数',
  `total_revenue` DECIMAL(12,2) NOT NULL DEFAULT 0.00 COMMENT '总营业额',
  
  `status` TINYINT NOT NULL DEFAULT 1 COMMENT '状态: 1-正常, 0-停用, 2-过期',
  `deleted` TINYINT NOT NULL DEFAULT 0,
  `create_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `update_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_owner_phone` (`owner_phone`),
  KEY `idx_subscription_expire` (`subscription_expire`),
  KEY `idx_status` (`status`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='店铺表';
```

#### 系统配置表 (tb_system_config)

```sql
CREATE TABLE `tb_system_config` (
  `id` BIGINT NOT NULL AUTO_INCREMENT,
  `shop_id` BIGINT DEFAULT NULL COMMENT '店铺ID，NULL表示全局配置',
  `config_key` VARCHAR(100) NOT NULL COMMENT '配置键',
  `config_value` TEXT NOT NULL COMMENT '配置值',
  `config_type` VARCHAR(20) NOT NULL DEFAULT 'string' COMMENT '类型: string, int, json, boolean',
  `description` VARCHAR(255) DEFAULT NULL COMMENT '说明',
  `is_system` TINYINT NOT NULL DEFAULT 0 COMMENT '是否系统配置: 1-是（不可删除）, 0-否',
  `create_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `update_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_shop_key` (`shop_id`, `config_key`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='系统配置表';

-- 预置配置数据
INSERT INTO `tb_system_config` (`config_key`, `config_value`, `config_type`, `description`, `is_system`) VALUES
('rfm.recency.thresholds', '[7,30,90,180]', 'json', 'RFM-R值阈值（天）', 1),
('rfm.frequency.thresholds', '[1,3,6,9]', 'json', 'RFM-F值阈值（次）', 1),
('rfm.monetary.thresholds', '[500,1000,2000,5000]', 'json', 'RFM-M值阈值（元）', 1),
('member.level.platinum.threshold', '12', 'int', '铂金会员RFM总分阈值', 1),
('member.level.gold.threshold', '9', 'int', '黄金会员RFM总分阈值', 1),
('member.level.silver.threshold', '6', 'int', '白银会员RFM总分阈值', 1),
('ai.daily.call.limit', '10000', 'int', 'AI每日调用限制', 1),
('points.order.rate', '0.01', 'string', '订单积分比例（每元获得积分）', 1);
```

#### 管理员表 (tb_admin)

```sql
CREATE TABLE `tb_admin` (
  `id` BIGINT NOT NULL AUTO_INCREMENT,
  `shop_id` BIGINT DEFAULT NULL COMMENT '店铺ID，NULL表示平台管理员',
  `username` VARCHAR(50) NOT NULL COMMENT '用户名',
  `password` VARCHAR(100) NOT NULL COMMENT '密码（加密）',
  `real_name` VARCHAR(50) DEFAULT NULL COMMENT '真实姓名',
  `phone` VARCHAR(20) DEFAULT NULL COMMENT '手机号',
  `email` VARCHAR(100) DEFAULT NULL COMMENT '邮箱',
  `role` VARCHAR(20) NOT NULL DEFAULT 'staff' COMMENT '角色: super_admin-超管, shop_owner-店主, staff-店员',
  `permissions` JSON DEFAULT NULL COMMENT '权限列表',
  `avatar` VARCHAR(255) DEFAULT NULL COMMENT '头像',
  `status` TINYINT NOT NULL DEFAULT 1 COMMENT '状态: 1-启用, 0-停用',
  `last_login_time` DATETIME DEFAULT NULL COMMENT '最后登录时间',
  `last_login_ip` VARCHAR(50) DEFAULT NULL COMMENT '最后登录IP',
  `deleted` TINYINT NOT NULL DEFAULT 0,
  `create_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `update_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_username` (`username`),
  KEY `idx_shop_id` (`shop_id`),
  KEY `idx_phone` (`phone`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='管理员表';
```

------

## 四、核心功能模块详细设计

### 4.1 会员系统模块

#### 功能概述

- 用户注册/登录（微信授权）
- 自动会员分层（RFM模型）
- 会员权益管理
- 积分系统

#### 接口设计

```java
/**
 * 用户服务接口
 */
@RestController
@RequestMapping("/api/user")
public class UserController {
    
    /**
     * 微信小程序登录
     * POST /api/user/login/miniapp
     */
    @PostMapping("/login/miniapp")
    public Result<LoginVO> miniappLogin(@RequestBody @Valid MiniappLoginDTO dto) {
        // 1. 调用微信API获取openid
        // 2. 查询或创建用户
        // 3. 生成token（Sa-Token）
        // 4. 返回用户信息和token
    }
    
    /**
     * 获取用户信息
     * GET /api/user/info
     */
    @GetMapping("/info")
    public Result<UserInfoVO> getUserInfo() {
        // 1. 从token获取userId
        // 2. 查询用户基本信息
        // 3. 查询用户画像
        // 4. 查询会员权益
        // 5. 查询积分余额
    }
    
    /**
     * 更新用户资料
     * PUT /api/user/profile
     */
    @PutMapping("/profile")
    public Result<Void> updateProfile(@RequestBody @Valid UserProfileDTO dto) {
        // 1. 验证用户身份
        // 2. 更新用户信息
        // 3. 异步触发画像更新
    }
    
    /**
     * 获取会员等级信息
     * GET /api/user/member/level
     */
    @GetMapping("/member/level")
    public Result<MemberLevelVO> getMemberLevel() {
        // 1. 查询用户画像
        // 2. 计算距离下一等级差距
        // 3. 返回权益说明
    }
    
    /**
     * 获取积分明细
     * GET /api/user/points/logs
     */
    @GetMapping("/points/logs")
    public Result<PageResult<PointsLogVO>> getPointsLogs(
        @RequestParam(defaultValue = "1") Integer page,
        @RequestParam(defaultValue = "20") Integer size
    ) {
        // 分页查询积分记录
    }
}

/**
 * 会员画像服务（内部服务）
 */
@Service
public class UserProfileService {
    
    /**
     * 计算用户RFM得分
     */
    public RFMScore calculateRFM(Long userId) {
        // 1. 查询用户订单数据
        // 2. 计算R、F、M值
        // 3. 根据阈值打分
        // 4. 计算总分
        return rfmScore;
    }
    
    /**
     * 更新会员等级
     */
    @Transactional
    public void updateMemberLevel(Long userId) {
        // 1. 计算RFM得分
        RFMScore score = calculateRFM(userId);
        
        // 2. 确定会员等级
        MemberLevel newLevel = determineMemberLevel(score);
        
        // 3. 查询当前等级
        UserProfile profile = getProfile(userId);
        MemberLevel oldLevel = profile.getMemberLevel();
        
        // 4. 如果等级变化，发布事件
        if (newLevel != oldLevel) {
            profile.setMemberLevel(newLevel);
            profileMapper.updateById(profile);
            
            // 发布会员升级事件（触发营销活动）
            eventPublisher.publishEvent(new MemberLevelUpEvent(userId, oldLevel, newLevel));
        }
    }
    
    /**
     * AI增强用户画像
     */
    @Async
    public void enhanceProfileWithAI(Long userId) {
        // 1. 获取用户数据
        UserProfile profile = getProfile(userId);
        List<Order> orders = orderService.getUserOrders(userId);
        List<UserBehavior> behaviors = behaviorService.getUserBehaviors(userId);
        
        // 2. 构建prompt
        String prompt = promptTemplateManager.render("user_profile_analysis", Map.of(
            "gender", profile.getGender(),
            "ageRange", profile.getAgeRange(),
            "region", profile.getRegion(),
            "totalAmount", profile.getTotalAmount(),
            "orderCount", profile.getTotalOrders(),
            "avgAmount", profile.getAvgOrderAmount(),
            "lastOrderDate", profile.getLastOrderDate(),
            "purchaseHistory", formatPurchaseHistory(orders)
        ));
        
        // 3. 调用AI
        try {
            String aiResponse = aiService.generateWithCache(
                "user_profile:" + userId,
                prompt,
                Duration.ofHours(24)
            );
            
            // 4. 解析AI返回
            AIProfileAnalysis analysis = JSON.parseObject(aiResponse, AIProfileAnalysis.class);
            
            // 5. 更新画像
            profile.setConsumptionLevel(analysis.getConsumptionLevel());
            profile.setPriceSensitivity(analysis.getPriceSensitivity());
            profile.setPreferredCategories(analysis.getPreferredCategories());
            profile.setAiTags(analysis.getTags());
            profile.setAiInsight(analysis.getInsight());
            profile.setAiUpdateTime(LocalDateTime.now());
            
            profileMapper.updateById(profile);
            
        } catch (Exception e) {
            log.error("AI分析用户画像失败: userId={}", userId, e);
        }
    }
}
```

#### DTO/VO定义

```java
/**
 * 小程序登录请求
 */
@Data
public class MiniappLoginDTO {
    @NotBlank(message = "code不能为空")
    private String code;
    
    private String nickname;
    private String avatar;
    private Integer gender;
}

/**
 * 登录响应
 */
@Data
public class LoginVO {
    private Long userId;
    private String token;
    private String openid;
    private UserInfoVO userInfo;
}

/**
 * 用户信息
 */
@Data
public class UserInfoVO {
    private Long id;
    private String nickname;
    private String avatar;
    private Integer gender;
    private String phone;
    
    // 会员信息
    private String memberLevel;
    private String memberLevelName;
    private BigDecimal totalAmount;
    private Integer totalOrders;
    private Integer points;
    
    // 权益
    private List<MemberRightVO> rights;
}

/**
 * 会员等级详情
 */
@Data
public class MemberLevelVO {
    private String currentLevel;
    private String currentLevelName;
    private Integer rfmScore;
    
    // 距离下一等级
    private String nextLevel;
    private String nextLevelName;
    private Integer nextLevelThreshold;
    private Integer scoreGap;
    
    // 当前权益
    private List<MemberRightVO> currentRights;
    
    // 下一等级权益
    private List<MemberRightVO> nextLevelRights;
}

/**
 * 会员权益
 */
@Data
public class MemberRightVO {
    private String name;
    private String description;
    private String icon;
}
```

------

### 4.2 推荐系统模块 ⭐️核心

#### 功能概述

- 多算法融合推荐
- AI个性化推荐
- 实时推荐
- A/B测试
- 效果追踪

#### 推荐算法实现

```java
/**
 * 推荐服务主控制器
 */
@RestController
@RequestMapping("/api/recommend")
public class RecommendController {
    
    /**
     * 获取首页推荐
     * GET /api/recommend/home
     */
    @GetMapping("/home")
    public Result<List<ProductRecommendVO>> getHomeRecommend(
        @RequestParam(defaultValue = "10") Integer limit
    ) {
        Long userId = StpUtil.getLoginIdAsLong();
        return Result.success(recommendService.recommend(userId, "home", limit));
    }
    
    /**
     * 获取商品详情页推荐
     * GET /api/recommend/detail/{productId}
     */
    @GetMapping("/detail/{productId}")
    public Result<List<ProductRecommendVO>> getDetailPageRecommend(
        @PathVariable Long productId,
        @RequestParam(defaultValue = "6") Integer limit
    ) {
        Long userId = StpUtil.getLoginIdAsLong();
        return Result.success(recommendService.recommendForDetail(userId, productId, limit));
    }
    
    /**
     * 记录推荐点击
     * POST /api/recommend/click
     */
    @PostMapping("/click")
    public Result<Void> recordClick(@RequestBody @Valid RecommendClickDTO dto) {
        recommendService.recordClick(dto);
        return Result.success();
    }
}

/**
 * 推荐服务核心实现
 */
@Service
public class RecommendService {
    
    @Autowired
    private RuleEngineService ruleEngine;
    
    @Autowired
    private CollaborativeFilteringService cfService;
    
    @Autowired
    private AIRecommendService aiService;
    
    @Autowired
    private
```























































