[æŸ¥çœ‹éœ€æ±‚](../03.æ™ºèƒ½ä½“/07.é¡µé¢è·³è½¬åŠèŠ‚ç‚¹ç‚¹å‡»å†å²è®°å½•.md)ï¼šæŸ¥çœ‹ç™»å½•ç”¨æˆ·ç‚¹å‡»èŠ‚ç‚¹çš„å†å²è®°å½•ï¼Œéœ€è¦æœ€è¿‘çš„èŠ‚ç‚¹ç‚¹å‡»å†å²è®°å½•

éœ€è¦å®ç°çš„é€»è¾‘ï¼š

å…ˆæ ¹æ®èŠ‚ç‚¹åˆ†ç»„æ’åºå¾—åˆ°æœ€æ–°çš„ä¸€æ¡æ•°æ®ï¼Œç„¶åå†å¯¹æ•°æ®è¿›è¡Œæ’åº

æœŸé—´å°±ç”¨åˆ°äº†çª—å£å‡½æ•°æ¥è€ƒè™‘æ€§èƒ½é—®é¢˜    å…·ä½“çš„ `Crtl + é¼ æ ‡å·¦é”®` ç‚¹å‡»å‰é¢çš„éœ€æ±‚

å½“ç„¶è¿™åªæ˜¯å› ä¸ºæ•°æ®åº“è¿™æ ·è®¾è®¡äº†ï¼Œå¯¹äºå†å²è®°å½•è‚¯å®šè¿˜æœ‰æ›´å¥½çš„è§£å†³æ–¹æ¡ˆ  æ¯”å¦‚  æ”¾å…¥redis  

å…³äºçª—å£å‡½æ•°çš„å¥½å¤„  ğŸ§ [ç‚¹å‡»è¿™ç¯‡æ–‡ç« ](https://developer.huawei.com/consumer/cn/forum/topic/0201890445606820312)



## ç®€ä»‹

æ™®é€šçš„èšåˆå‡½æ•°åªèƒ½ç”¨æ¥è®¡ç®—ä¸€è¡Œå†…çš„ç»“æœæˆ–æŠŠæ‰€æœ‰è¡Œèšåˆæˆä¸€è¡Œç»“æœï¼Œè€Œçª—å£å‡½æ•°æ”¯æŒä¸ºæ¯ä¸€è¡Œç”Ÿæˆä¸€ä¸ªç»“æœã€‚çª—å£å‡½æ•°åŒ…å«åˆ†åŒºã€æ’åºå’Œæ¡†æ¶è¿™3ä¸ªæ ¸å¿ƒå…ƒç´ ã€‚æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚è§[Window Function Concepts and Syntax](https://dev.mysql.com/doc/refman/8.0/en/window-functions-usage.html)ã€‚

 

```js
function over (
    [partition by partition_expression]
    [order by order_expression]
    [frame]
)
```

- åˆ†åŒºï¼šåˆ†åŒºå…ƒç´ ç”±partition byå­å¥å®šä¹‰ã€‚partition byå­å¥ç”¨äºåˆ’åˆ†çª—å£åˆ†åŒºï¼Œå¦‚æœæ²¡æœ‰æŒ‡å®špartition byå­å¥ï¼Œåˆ™æ•´ä¸ªæŸ¥è¯¢ä¸åˆ†æç»“æœé›†ä½œä¸ºä¸€ä¸ªçª—å£åˆ†åŒºã€‚

- æ’åºï¼šæ’åºå…ƒç´ ç”±order byå­å¥å®šä¹‰ã€‚order byå­å¥ç”¨äºå¯¹çª—å£åˆ†åŒºå†…çš„è¡Œè¿›è¡Œæ’åºã€‚

  **è¯´æ˜**

  ä½¿ç”¨order byå­å¥å¯¹é‡å¤çš„æ•°å€¼è¿›è¡Œæ’åºæ—¶ï¼Œæ’åºç»“æœä¸ç¨³å®šã€‚å¦‚æœæ‚¨å¸Œæœ›æ¯æ¬¡æ’åºç»“æœç›¸åŒï¼Œå¯æŒ‡å®šå¤šä¸ªåˆ—è¿›è¡Œæ’åºã€‚ä¾‹å¦‚`order by request_time, request_method`ã€‚

- æ¡†æ¶ï¼šæ¡†æ¶å…ƒç´ åœ¨çª—å£åˆ†åŒºå†…å¯¹è¡Œè¿›ä¸€æ­¥é™åˆ¶ã€‚æ¡†æ¶å…ƒç´ ä¸é€‚ç”¨äºæ’åå‡½æ•°ã€‚æ¡†æ¶å­å¥çš„è¯­æ³•ä¸º`{ rows | range} { frame_start | frame_between }`ï¼Œä¾‹å¦‚`range between unbounded preceding and unbounded following`ã€‚æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚è§[Window Function Frame Specification](https://dev.mysql.com/doc/refman/8.0/en/window-functions-frames.html)ã€‚

## å‡½æ•°åˆ—è¡¨

|      |      |      |      |      |      |
| ---- | ---- | ---- | ---- | ---- | ---- |
|      |      |      |      |      |      |

| **åˆ†ç±»**                                                     | **å‡½æ•°åç§°**                                                 | **è¯­æ³•**                                                     | **è¯´æ˜**                                                     | æ”¯æŒSQL | æ”¯æŒSPL |
| ------------------------------------------------------------ | ------------------------------------------------------------ | ------------------------------------------------------------ | ------------------------------------------------------------ | ------- | ------- |
| èšåˆå‡½æ•°                                                     | [èšåˆå‡½æ•°](https://help.aliyun.com/zh/sls/window-functions#section-42t-cj8-nio) | æ—                                                            | æ‰€æœ‰èšåˆå‡½æ•°éƒ½æ”¯æŒåœ¨çª—å£å‡½æ•°ä¸­ä½¿ç”¨ã€‚èšåˆå‡½æ•°åˆ—è¡¨è¯·å‚è§[èšåˆå‡½æ•°](https://help.aliyun.com/zh/sls/aggregate-function#LogService-user-guide-0103)ã€‚ | âˆš       | Ã—       |
| æ’åå‡½æ•°                                                     | [cume_distå‡½æ•°](https://help.aliyun.com/zh/sls/window-functions#section-6dk-2dm-t9u) | cume_dist()                                                  | ç»Ÿè®¡çª—å£åˆ†åŒºå†…å„ä¸ªå€¼çš„ç´¯è®¡åˆ†å¸ƒã€‚å³è®¡ç®—çª—å£åˆ†åŒºå†…å€¼å°äºç­‰äºå½“å‰å€¼çš„è¡Œæ•°å çª—å£å†…æ€»è¡Œæ•°çš„æ¯”ä¾‹ã€‚è¿”å›å€¼èŒƒå›´ä¸º(0,1]ã€‚ | âˆš       | Ã—       |
| [dense_rankå‡½æ•°](https://help.aliyun.com/zh/sls/window-functions#section-2sg-x7c-k6i) | dense_rank()                                                 | çª—å£åˆ†åŒºå†…å€¼çš„æ’åã€‚ç›¸åŒå€¼æ‹¥æœ‰ç›¸åŒçš„æ’åï¼Œæ’åæ˜¯è¿ç»­çš„ï¼Œä¾‹å¦‚æœ‰ä¸¤ä¸ªç›¸åŒå€¼çš„æ’åä¸º1ï¼Œåˆ™ä¸‹ä¸€ä¸ªå€¼çš„æ’åä¸º2ã€‚ | âˆš                                                            | Ã—       |         |
| [ntileå‡½æ•°](https://help.aliyun.com/zh/sls/window-functions#section-rbj-f90-1j7) | ntile(*n*)                                                   | å°†çª—å£åˆ†åŒºå†…æ•°æ®æŒ‰ç…§é¡ºåºåˆ†æˆNç»„ã€‚                            | âˆš                                                            | Ã—       |         |
| [percent_rankå‡½æ•°](https://help.aliyun.com/zh/sls/window-functions#section-1yc-nyu-obp) | percent_rank()                                               | è®¡ç®—çª—å£åˆ†åŒºå†…å„è¡Œçš„ç™¾åˆ†æ¯”æ’åã€‚                             | âˆš                                                            | Ã—       |         |
| [rankå‡½æ•°](https://help.aliyun.com/zh/sls/window-functions#section-slw-cpg-1lp) | rank()                                                       | çª—å£åˆ†åŒºå†…å€¼çš„æ’åã€‚ç›¸åŒå€¼æ‹¥æœ‰ç›¸åŒçš„æ’åï¼Œæ’åä¸æ˜¯è¿ç»­çš„ï¼Œä¾‹å¦‚æœ‰ä¸¤ä¸ªç›¸åŒå€¼çš„æ’åä¸º1ï¼Œåˆ™ä¸‹ä¸€ä¸ªå€¼çš„æ’åä¸º3ã€‚ | âˆš                                                            | Ã—       |         |
| [row_numberå‡½æ•°](https://help.aliyun.com/zh/sls/window-functions#section-9a0-6yn-3kg) | row_number()                                                 | çª—å£åˆ†åŒºå†…å€¼çš„æ’åã€‚æ¯ä¸ªå€¼æ‹¥æœ‰å”¯ä¸€çš„åºå·ï¼Œä»1å¼€å§‹ã€‚ä¸‰ä¸ªç›¸åŒå€¼çš„æ’åä¸º1ã€2ã€3ã€‚ | âˆš                                                            | Ã—       |         |
| åç§»å‡½æ•°                                                     | [first_valueå‡½æ•°](https://help.aliyun.com/zh/sls/window-functions#section-ddv-1t7-per) | first_value(*x*)                                             | è¿”å›å„ä¸ªçª—å£åˆ†åŒºå†…ç¬¬ä¸€è¡Œçš„å€¼ã€‚                               | âˆš       | Ã—       |
| [last_valueå‡½æ•°](https://help.aliyun.com/zh/sls/window-functions#section-rdr-pgb-fvf) | last_value(*x*)                                              | è¿”å›å„ä¸ªçª—å£åˆ†åŒºå†…æœ€åä¸€è¡Œçš„å€¼ã€‚                             | âˆš                                                            | Ã—       |         |
| [lagå‡½æ•°](https://help.aliyun.com/zh/sls/window-functions#section-ugb-0vt-tdz) | lag(*x*, *offset*, *default_value*)                          | è¿”å›çª—å£åˆ†åŒºå†…ä½äºå½“å‰è¡Œä¸Šæ–¹ç¬¬*offset*è¡Œçš„å€¼ã€‚å¦‚æœä¸å­˜åœ¨è¯¥è¡Œï¼Œåˆ™è¿”å›*default_value*ã€‚ | âˆš                                                            | Ã—       |         |
| [leadå‡½æ•°](https://help.aliyun.com/zh/sls/window-functions#section-pu9-9ch-j9k) | lead(*x*, *offset*, *default_value*)                         | è¿”å›çª—å£åˆ†åŒºå†…ä½äºå½“å‰è¡Œä¸‹æ–¹ç¬¬*offset*è¡Œçš„å€¼ã€‚å¦‚æœä¸å­˜åœ¨è¯¥è¡Œï¼Œåˆ™è¿”å›*default_value*ã€‚ | âˆš                                                            | Ã—       |         |
| [nth_valueå‡½æ•°](https://help.aliyun.com/zh/sls/window-functions#section-578-lim-ujg) | nth_value(*x*, *offset*)                                     | è¿”å›çª—å£åˆ†åŒºä¸­ç¬¬*offset*è¡Œçš„å€¼ã€‚                             | âˆš                                                            | Ã—       |         |

## èšåˆå‡½æ•°

æ‰€æœ‰èšåˆå‡½æ•°éƒ½æ”¯æŒåœ¨çª—å£å‡½æ•°ä¸­ä½¿ç”¨ã€‚èšåˆå‡½æ•°åˆ—è¡¨è¯·å‚è§[èšåˆå‡½æ•°](https://help.aliyun.com/zh/sls/aggregate-function#LogService-user-guide-0103)ã€‚æ­¤å¤„ä»¥sumå‡½æ•°ä¸ºä¾‹ã€‚

### è¯­æ³•

 

```plaintext
sum() over (
    [partition by partition_expression]
    [order by order_expression]
    [frame]
)
```

### å‚æ•°è¯´æ˜

|      |      |
| ---- | ---- |
|      |      |

| **å‚æ•°**                            | **è¯´æ˜**                                                     |
| ----------------------------------- | ------------------------------------------------------------ |
| partition by *partition_expression* | çª—å£åˆ†åŒºï¼Œæ ¹æ®åˆ†åŒºè¡¨è¾¾å¼å°†æ•°æ®åˆ’åˆ†æˆä¸åŒçš„åˆ†åŒºã€‚             |
| order by *order_expression*         | çª—å£æ’åºï¼Œæ ¹æ®æ’åºè¡¨è¾¾å¼å¯¹å„ä¸ªåˆ†åŒºå†…çš„æ¯ä¸€è¡Œè¿›è¡Œæ’åºã€‚       |
| *frame*                             | çª—å£æ¡†æ¶ï¼Œä¾‹å¦‚`range between unbounded preceding and unbounded following`ã€‚ |

### è¿”å›å€¼ç±»å‹

doubleç±»å‹ã€‚

### ç¤ºä¾‹

æŒ‰ç…§éƒ¨é—¨åˆ†åŒºï¼Œè·å–æ¯ä¸ªå‘˜å·¥è–ªæ°´åœ¨éƒ¨é—¨å†…çš„å æ¯”ã€‚

- æŸ¥è¯¢å’Œåˆ†æè¯­å¥

   

  ```plaintext
  * |
  SELECT
    department,
    staff_name,
    salary,
    round ( salary * 1.0 / sum(salary) over(partition by department), 3) AS salary_percentage 
  ```

- æŸ¥è¯¢å’Œåˆ†æç»“æœ![sum](https://help-static-aliyun-doc.aliyuncs.com/assets/img/zh-CN/7115699261/p312606.png)

## cume_distå‡½æ•°

cume_distå‡½æ•°ç”¨äºç»Ÿè®¡çª—å£åˆ†åŒºå†…å„ä¸ªå€¼çš„ç´¯è®¡åˆ†å¸ƒã€‚å³è®¡ç®—çª—å£åˆ†åŒºå†…å€¼å°äºç­‰äºå½“å‰å€¼çš„è¡Œæ•°å çª—å£å†…æ€»è¡Œæ•°çš„æ¯”ä¾‹ã€‚è¿”å›å€¼èŒƒå›´ä¸º(0,1]ã€‚

### è¯­æ³•

 

```plaintext
cume_dist() over (
    [partition by partition_expression]
    [order by order_expression]
)
```

### å‚æ•°è¯´æ˜

|      |      |
| ---- | ---- |
|      |      |

| **å‚æ•°**                            | **è¯´æ˜**                                               |
| ----------------------------------- | ------------------------------------------------------ |
| partition by *partition_expression* | çª—å£åˆ†åŒºï¼Œæ ¹æ®åˆ†åŒºè¡¨è¾¾å¼å°†æ•°æ®åˆ’åˆ†æˆä¸åŒçš„åˆ†åŒºã€‚       |
| order by *order_expression*         | çª—å£æ’åºï¼Œæ ¹æ®æ’åºè¡¨è¾¾å¼å¯¹å„ä¸ªåˆ†åŒºå†…çš„æ¯ä¸€è¡Œè¿›è¡Œæ’åºã€‚ |

### è¿”å›å€¼ç±»å‹

doubleç±»å‹ã€‚

### ç¤ºä¾‹

ç»Ÿè®¡åä¸ºbucket00788çš„OSS Bucketå†…å„ä¸ªå¯¹è±¡çš„å¤§å°çš„ç´¯è®¡åˆ†å¸ƒã€‚

- æŸ¥è¯¢å’Œåˆ†æè¯­å¥

   

  ```plaintext
  bucket=bucket00788 |
  select
    object,
    object_size,
    cume_dist() over (
      partition by object
      order by
        object_size
    ) as cume_dist
  from  oss-log-store
  ```

- æŸ¥è¯¢å’Œåˆ†æç»“æœ![cume_dist](https://help-static-aliyun-doc.aliyuncs.com/assets/img/zh-CN/6621499261/p310518.png)

## dense_rankå‡½æ•°

dense_rankå‡½æ•°ç”¨äºçª—å£åˆ†åŒºå†…å€¼çš„æ’åã€‚ç›¸åŒå€¼æ‹¥æœ‰ç›¸åŒçš„æ’åï¼Œæ’åæ˜¯è¿ç»­çš„ï¼Œä¾‹å¦‚æœ‰ä¸¤ä¸ªç›¸åŒå€¼çš„æ’åä¸º1ï¼Œåˆ™ä¸‹ä¸€ä¸ªå€¼çš„æ’åä¸º2ã€‚

### è¯­æ³•

 

```plaintext
dense_rank() over (
    [partition by partition_expression]
    [order by order_expression]
)
```

### å‚æ•°è¯´æ˜

|      |      |
| ---- | ---- |
|      |      |

| **å‚æ•°**                            | **è¯´æ˜**                                               |
| ----------------------------------- | ------------------------------------------------------ |
| partition by *partition_expression* | çª—å£åˆ†åŒºï¼Œæ ¹æ®åˆ†åŒºè¡¨è¾¾å¼å°†æ•°æ®åˆ’åˆ†æˆä¸åŒçš„åˆ†åŒºã€‚       |
| order by *order_expression*         | çª—å£æ’åºï¼Œæ ¹æ®æ’åºè¡¨è¾¾å¼å¯¹å„ä¸ªåˆ†åŒºå†…çš„æ¯ä¸€è¡Œè¿›è¡Œæ’åºã€‚ |

### è¿”å›å€¼ç±»å‹

bigintç±»å‹ã€‚

### ç¤ºä¾‹

æŒ‰ç…§éƒ¨é—¨åˆ†åŒºï¼Œè®¡ç®—å‘˜å·¥è–ªæ°´åœ¨éƒ¨é—¨å†…çš„æ’åã€‚

- æŸ¥è¯¢å’Œåˆ†æè¯­å¥

   

  ```plaintext
  * |
  select
    department,
    staff_name,
    salary,
    dense_rank() over(
      partition by department
      order by
        salary desc
    ) as salary_rank
  order by
    department,
    salary_rank
  ```

- æŸ¥è¯¢å’Œåˆ†æç»“æœ![dense_rank](https://help-static-aliyun-doc.aliyuncs.com/assets/img/zh-CN/7115699261/p312291.png)

## ntileå‡½æ•°

ntileå‡½æ•°ç”¨äºå°†çª—å£åˆ†åŒºå†…æ•°æ®æŒ‰ç…§é¡ºåºåˆ†æˆNç»„ã€‚

### è¯­æ³•

 

```plaintext
ntile(n) over (
    [partition by partition_expression]
    [order by order_expression]
)
```

### å‚æ•°è¯´æ˜

|      |      |
| ---- | ---- |
|      |      |

| **å‚æ•°**                            | **è¯´æ˜**                                               |
| ----------------------------------- | ------------------------------------------------------ |
| *n*                                 | ç»„æ•°ã€‚                                                 |
| partition by *partition_expression* | çª—å£åˆ†åŒºï¼Œæ ¹æ®åˆ†åŒºè¡¨è¾¾å¼å°†æ•°æ®åˆ’åˆ†æˆä¸åŒçš„åˆ†åŒºã€‚       |
| order by *order_expression*         | çª—å£æ’åºï¼Œæ ¹æ®æ’åºè¡¨è¾¾å¼å¯¹å„ä¸ªåˆ†åŒºå†…çš„æ¯ä¸€è¡Œè¿›è¡Œæ’åºã€‚ |

### è¿”å›å€¼ç±»å‹

bigintç±»å‹ã€‚

### ç¤ºä¾‹

å°†æŒ‡å®šå¯¹è±¡ä¸­çš„æ•°æ®åˆ†æˆ3ç»„ã€‚

- æŸ¥è¯¢å’Œåˆ†æè¯­å¥

   

  ```plaintext
  object=245-da918c.model |
  select
    object,
    object_size,
    ntile(3) over (
      partition by object
      order by
        object_size
    ) as ntile
  from  oss-log-store
  ```

- æŸ¥è¯¢å’Œåˆ†æç»“æœ![ntile](https://help-static-aliyun-doc.aliyuncs.com/assets/img/zh-CN/6621499261/p312373.png)

## percent_rankå‡½æ•°

å‡½æ•°ç”¨äºè®¡ç®—çª—å£åˆ†åŒºå†…å„è¡Œçš„ç™¾åˆ†æ¯”æ’åã€‚è®¡ç®—å…¬å¼ä¸º`(rank - 1) / (total_rows - 1) `ï¼Œå…¶ä¸­rankä¸ºå½“å‰è¡Œçš„æ’åï¼Œtotal_rowsä¸ºå½“å‰çª—å£åˆ†åŒºå†…çš„æ€»è¡Œæ•°ã€‚

### è¯­æ³•

 

```plaintext
percent_rank() over (
    [partition by partition_expression]
    [order by order_expression]
)
```

### å‚æ•°è¯´æ˜

|      |      |
| ---- | ---- |
|      |      |

| **å‚æ•°**                            | **è¯´æ˜**                                               |
| ----------------------------------- | ------------------------------------------------------ |
| partition by *partition_expression* | çª—å£åˆ†åŒºï¼Œæ ¹æ®åˆ†åŒºè¡¨è¾¾å¼å°†æ•°æ®åˆ’åˆ†æˆä¸åŒçš„åˆ†åŒºã€‚       |
| order by *order_expression*         | çª—å£æ’åºï¼Œæ ¹æ®æ’åºè¡¨è¾¾å¼å¯¹å„ä¸ªåˆ†åŒºå†…çš„æ¯ä¸€è¡Œè¿›è¡Œæ’åºã€‚ |

### è¿”å›å€¼ç±»å‹

doubleç±»å‹ã€‚

### ç¤ºä¾‹

è®¡ç®—ç›®æ ‡OSSå¯¹è±¡çš„ä¸åŒå¤§å°çš„ç™¾åˆ†æ¯”æ’åã€‚

- æŸ¥è¯¢å’Œåˆ†æè¯­å¥

   

  ```plaintext
  object=245-da918c3e2dd9dc9cb4d9283b%2F555e2441b6a4c7f094099a6dba8e7a5f.model|
  select
    object,
    object_size,
   percent_rank() over (
      partition by object
      order by
        object_size
    ) as ntile
  FROM  oss-log-store
  ```

- æŸ¥è¯¢å’Œåˆ†æç»“æœ![percent_rank](https://help-static-aliyun-doc.aliyuncs.com/assets/img/zh-CN/6621499261/p311497.png)

## rankå‡½æ•°

å‡½æ•°ç”¨äºçª—å£åˆ†åŒºå†…å€¼çš„æ’åã€‚ç›¸åŒå€¼æ‹¥æœ‰ç›¸åŒçš„æ’åï¼Œæ’åä¸æ˜¯è¿ç»­çš„ï¼Œä¾‹å¦‚æœ‰ä¸¤ä¸ªç›¸åŒå€¼çš„æ’åä¸º1ï¼Œåˆ™ä¸‹ä¸€ä¸ªå€¼çš„æ’åä¸º3ã€‚

### è¯­æ³•

 

```plaintext
rank() over (
    [partition by partition_expression]
    [order by order_expression]
)
```

### å‚æ•°è¯´æ˜

|      |      |
| ---- | ---- |
|      |      |

| **å‚æ•°**                            | **è¯´æ˜**                                               |
| ----------------------------------- | ------------------------------------------------------ |
| partition by *partition_expression* | çª—å£åˆ†åŒºï¼Œæ ¹æ®åˆ†åŒºè¡¨è¾¾å¼å°†æ•°æ®åˆ’åˆ†æˆä¸åŒçš„åˆ†åŒºã€‚       |
| order by *order_expression*         | çª—å£æ’åºï¼Œæ ¹æ®æ’åºè¡¨è¾¾å¼å¯¹å„ä¸ªåˆ†åŒºå†…çš„æ¯ä¸€è¡Œè¿›è¡Œæ’åºã€‚ |

### è¿”å›å€¼ç±»å‹

bigintç±»å‹ã€‚

### ç¤ºä¾‹

æŒ‰ç…§éƒ¨é—¨åˆ†åŒºï¼Œè®¡ç®—å‘˜å·¥è–ªæ°´åœ¨éƒ¨é—¨å†…çš„æ’åã€‚

- æŸ¥è¯¢å’Œåˆ†æè¯­å¥

   

  ```plaintext
  * |
  select
    department,
    staff_name,
    salary,
    rank() over(
      partition by department
      order by
        salary desc
    ) as salary_rank
  order by
    department,
    salary_rank
  ```

- æŸ¥è¯¢å’Œåˆ†æç»“æœ![rank](https://help-static-aliyun-doc.aliyuncs.com/assets/img/zh-CN/7115699261/p311615.png)

## row_numberå‡½æ•°

row_numberå‡½æ•°ç”¨äºçª—å£åˆ†åŒºå†…å€¼çš„æ’åã€‚æ¯ä¸ªå€¼æ‹¥æœ‰å”¯ä¸€çš„åºå·ï¼Œä»1å¼€å§‹ã€‚

### è¯­æ³•

 

```js
row_number() over (
    [partition by partition_expression]
    [order by order_expression]
)
```

### å‚æ•°è¯´æ˜

|      |      |
| ---- | ---- |
|      |      |

| **å‚æ•°**                            | **è¯´æ˜**                                               |
| ----------------------------------- | ------------------------------------------------------ |
| partition by *partition_expression* | çª—å£åˆ†åŒºï¼Œæ ¹æ®åˆ†åŒºè¡¨è¾¾å¼å°†æ•°æ®åˆ’åˆ†æˆä¸åŒçš„åˆ†åŒºã€‚       |
| order by *order_expression*         | çª—å£æ’åºï¼Œæ ¹æ®æ’åºè¡¨è¾¾å¼å¯¹å„ä¸ªåˆ†åŒºå†…çš„æ¯ä¸€è¡Œè¿›è¡Œæ’åºã€‚ |

### è¿”å›å€¼ç±»å‹

bigintç±»å‹ã€‚

### ç¤ºä¾‹

æŒ‰ç…§éƒ¨é—¨åˆ†åŒºï¼Œè®¡ç®—å‘˜å·¥è–ªæ°´åœ¨éƒ¨é—¨å†…çš„æ’åã€‚

- æŸ¥è¯¢å’Œåˆ†æè¯­å¥

   

  ```sql
  select
    department,
    staff_name,
    salary,
    row_number() over(
      partition by department
      order by
        salary desc
    ) as salary_rank
  order by
    department,
    salary_rank
  ```

- æŸ¥è¯¢å’Œåˆ†æç»“æœ![row_number](https://help-static-aliyun-doc.aliyuncs.com/assets/img/zh-CN/7115699261/p311633.png)

## first_valueå‡½æ•°

first_valueå‡½æ•°ç”¨äºè¿”å›å„ä¸ªçª—å£åˆ†åŒºå†…ç¬¬ä¸€è¡Œçš„å€¼ã€‚

### è¯­æ³•

 

```plaintext
first_value(x) over (
    [partition by partition_expression]
    [order by order_expression]
    [frame]
)
```

### å‚æ•°è¯´æ˜

|      |      |
| ---- | ---- |
|      |      |

| **å‚æ•°**                            | **è¯´æ˜**                                                     |
| ----------------------------------- | ------------------------------------------------------------ |
| *x*                                 | åˆ—åï¼Œå¯ä»¥ä¸ºä»»æ„æ•°æ®ç±»å‹ã€‚                                   |
| partition by *partition_expression* | çª—å£åˆ†åŒºï¼Œæ ¹æ®åˆ†åŒºè¡¨è¾¾å¼å°†æ•°æ®åˆ’åˆ†æˆä¸åŒçš„åˆ†åŒºã€‚             |
| order by *order_expression*         | çª—å£æ’åºï¼Œæ ¹æ®æ’åºè¡¨è¾¾å¼å¯¹å„ä¸ªåˆ†åŒºå†…çš„æ¯ä¸€è¡Œè¿›è¡Œæ’åºã€‚       |
| *frame*                             | çª—å£æ¡†æ¶ï¼Œä¾‹å¦‚`range between unbounded preceding and unbounded following`ã€‚ |

### è¿”å›å€¼ç±»å‹

ä¸*x*çš„æ•°æ®ç±»å‹ä¸€è‡´ã€‚

### ç¤ºä¾‹

è·å–ç›®æ ‡OSS Bucketä¸­å„ä¸ªå¯¹è±¡çš„æœ€å°å€¼ã€‚

- æŸ¥è¯¢å’Œåˆ†æè¯­å¥

   

  ```plaintext
  bucket :bucket90 |
  select
    object,
    object_size,
    first_value(object_size) over (
      partition by object
      order by
        object_size 
       range between unbounded preceding and unbounded following
    ) as first_value
  from  oss-log-store
  ```

- æŸ¥è¯¢å’Œåˆ†æç»“æœ![first_value](https://help-static-aliyun-doc.aliyuncs.com/assets/img/zh-CN/6621499261/p312466.png)

## last_valueå‡½æ•°

last_valueå‡½æ•°ç”¨äºè¿”å›å„ä¸ªçª—å£åˆ†åŒºå†…æœ€åä¸€è¡Œçš„å€¼ã€‚

### è¯­æ³•

 

```plaintext
last_value(x) over (
    [partition by partition_expression]
    [order by order_expression]
    [frame]
)
```

### å‚æ•°è¯´æ˜

|      |      |
| ---- | ---- |
|      |      |

| **å‚æ•°**                            | **è¯´æ˜**                                                     |
| ----------------------------------- | ------------------------------------------------------------ |
| *x*                                 | åˆ—åï¼Œå¯ä»¥ä¸ºä»»æ„æ•°æ®ç±»å‹ã€‚                                   |
| partition by *partition_expression* | çª—å£åˆ†åŒºï¼Œæ ¹æ®åˆ†åŒºè¡¨è¾¾å¼å°†æ•°æ®åˆ’åˆ†æˆä¸åŒçš„åˆ†åŒºã€‚             |
| order by *order_expression*         | çª—å£æ’åºï¼Œæ ¹æ®æ’åºè¡¨è¾¾å¼å¯¹å„ä¸ªåˆ†åŒºå†…çš„æ¯ä¸€è¡Œè¿›è¡Œæ’åºã€‚       |
| *frame*                             | çª—å£æ¡†æ¶ï¼Œä¾‹å¦‚`range between unbounded preceding and unbounded following`ã€‚ |

### è¿”å›å€¼ç±»å‹

ä¸*x*çš„æ•°æ®ç±»å‹ä¸€è‡´ã€‚

### ç¤ºä¾‹

è·å–ç›®æ ‡OSS Bucketä¸­å„ä¸ªå¯¹è±¡çš„æœ€å¤§å€¼ã€‚

- æŸ¥è¯¢å’Œåˆ†æè¯­å¥

   

  ```plaintext
  bucket :bucket90 |
  select
    object,
    object_size,
    last_value(object_size) over (
      partition by object
      order by
        object_size 
       range between unbounded preceding and unbounded following
    ) as last_value
  from  oss-log-store
  ```

- æŸ¥è¯¢å’Œåˆ†æç»“æœ![last_value](https://help-static-aliyun-doc.aliyuncs.com/assets/img/zh-CN/7621499261/p312463.png)

## lagå‡½æ•°

lagå‡½æ•°ç”¨äºè¿”å›çª—å£åˆ†åŒºå†…ä½äºå½“å‰è¡Œä¸Šæ–¹ç¬¬*offset*è¡Œçš„å€¼ã€‚

### è¯­æ³•

 

```plaintext
lag(x, offset, default_value) over (
    [partition by partition_expression]
    [order by order_expression]
    [frame]
)
```

### å‚æ•°è¯´æ˜

|      |      |
| ---- | ---- |
|      |      |

| **å‚æ•°**                            | **è¯´æ˜**                                                     |
| ----------------------------------- | ------------------------------------------------------------ |
| *x*                                 | åˆ—åï¼Œå¯ä»¥ä¸ºä»»æ„æ•°æ®ç±»å‹ã€‚                                   |
| *offset*                            | åç¦»é‡ã€‚å¦‚æœ*offset*ä¸º0ï¼Œåˆ™è¿”å›å½“å‰è¡Œçš„å€¼ã€‚                  |
| *default_value*                     | å¦‚æœä¸å­˜åœ¨æŒ‡å®šçš„åç¦»è¡Œï¼Œåˆ™è¿”å›*default_value*ã€‚              |
| partition by *partition_expression* | çª—å£åˆ†åŒºï¼Œæ ¹æ®åˆ†åŒºè¡¨è¾¾å¼å°†æ•°æ®åˆ’åˆ†æˆä¸åŒçš„åˆ†åŒºã€‚             |
| order by *order_expression*         | çª—å£æ’åºï¼Œæ ¹æ®æ’åºè¡¨è¾¾å¼å¯¹å„ä¸ªåˆ†åŒºå†…çš„æ¯ä¸€è¡Œè¿›è¡Œæ’åºã€‚       |
| *frame*                             | çª—å£æ¡†æ¶ï¼Œä¾‹å¦‚`range between unbounded preceding and unbounded following`ã€‚ |

### è¿”å›å€¼ç±»å‹

ä¸*x*çš„æ•°æ®ç±»å‹ä¸€è‡´ã€‚

### ç¤ºä¾‹

æŒ‰å¤©ç»Ÿè®¡ç½‘ç«™è®¿é—®UVï¼Œè·å–æ¯å¤©ç½‘ç«™è®¿é—®UVç›¸æ¯”å‰ä¸€å¤©çš„å¢é•¿æƒ…å†µã€‚

- æŸ¥è¯¢å’Œåˆ†æè¯­å¥

   

  ```plaintext
  * |
  select
    day,
    UV,
    UV * 1.0 /(lag(UV, 1, 0) over()) as diff_percentage
  from  (
      select
        approx_distinct(client_ip) as UV,
        date_trunc('day', __time__) as day
      from  log
      group by
        day
      order by
        day asc
    )
  ```

- æŸ¥è¯¢å’Œåˆ†æç»“æœ![çª—å£å‡½æ•°](https://help-static-aliyun-doc.aliyuncs.com/assets/img/zh-CN/0659558261/p302458.png)

## leadå‡½æ•°

å‡½æ•°ç”¨äºè¿”å›çª—å£åˆ†åŒºå†…ä½äºå½“å‰è¡Œä¸‹æ–¹ç¬¬*offset*è¡Œçš„å€¼ã€‚

### è¯­æ³•

 

```plaintext
lead(x, offset, default_value) over (
    [partition by partition_expression]
    [order by order_expression]
    [frame]
)
```

### å‚æ•°è¯´æ˜

|      |      |
| ---- | ---- |
|      |      |

| **å‚æ•°**                            | **è¯´æ˜**                                                     |
| ----------------------------------- | ------------------------------------------------------------ |
| *x*                                 | åˆ—åï¼Œå¯ä»¥ä¸ºä»»æ„æ•°æ®ç±»å‹ã€‚                                   |
| *offset*                            | åç¦»é‡ã€‚å¦‚æœ*offset*ä¸º0ï¼Œåˆ™è¿”å›å½“å‰è¡Œçš„å€¼ã€‚                  |
| *default_value*                     | å¦‚æœä¸å­˜åœ¨æŒ‡å®šçš„åç¦»è¡Œï¼Œåˆ™è¿”å›*default_value*ã€‚              |
| partition by *partition_expression* | çª—å£åˆ†åŒºï¼Œæ ¹æ®åˆ†åŒºè¡¨è¾¾å¼å°†æ•°æ®åˆ’åˆ†æˆä¸åŒçš„åˆ†åŒºã€‚             |
| order by *order_expression*         | çª—å£æ’åºï¼Œæ ¹æ®æ’åºè¡¨è¾¾å¼å¯¹å„ä¸ªåˆ†åŒºå†…çš„æ¯ä¸€è¡Œè¿›è¡Œæ’åºã€‚       |
| *frame*                             | çª—å£æ¡†æ¶ï¼Œä¾‹å¦‚`range between unbounded preceding and unbounded following`ã€‚ |

### è¿”å›å€¼ç±»å‹

ä¸*x*çš„æ•°æ®ç±»å‹ä¸€è‡´ã€‚

### ç¤ºä¾‹

è®¡ç®—2021-08-26å½“å¤©ï¼Œå½“å‰ä¸€å°æ—¶ç½‘ç«™è®¿é—®UVä¸åä¸€å°æ—¶çš„å æ¯”æƒ…å†µã€‚

- æŸ¥è¯¢å’Œåˆ†æè¯­å¥

   

  ```plaintext
  * |
  select
    time,
    UV,
    UV * 1.0 /(lead(UV, 1, 0) over()) as diff_percentage
  from  (
      select
        approx_distinct(client_ip) as uv,
        date_trunc('hour', __time__) as time
      from    log
      group by
        time
      order by
        time asc
    )
  ```

- æŸ¥è¯¢å’Œåˆ†æç»“æœ![lead](https://help-static-aliyun-doc.aliyuncs.com/assets/img/zh-CN/7115699261/p312579.png)

## nth_valueå‡½æ•°

nth_valueå‡½æ•°ç”¨äºè¿”å›çª—å£åˆ†åŒºä¸­ç¬¬*offset*è¡Œçš„å€¼ã€‚

### è¯­æ³•

 

```plaintext
nth_value(x, offset) over (
    [partition by partition_expression]
    [order by order_expression]
    [frame]
)
```

### å‚æ•°è¯´æ˜

|      |      |
| ---- | ---- |
|      |      |

| **å‚æ•°**                            | **è¯´æ˜**                                                     |
| ----------------------------------- | ------------------------------------------------------------ |
| *x*                                 | åˆ—åï¼Œå¯ä»¥ä¸ºä»»æ„æ•°æ®ç±»å‹ã€‚                                   |
| *offset*                            | åç¦»é‡ã€‚                                                     |
| partition by *partition_expression* | çª—å£åˆ†åŒºï¼Œæ ¹æ®åˆ†åŒºè¡¨è¾¾å¼å°†æ•°æ®åˆ’åˆ†æˆä¸åŒçš„åˆ†åŒºã€‚             |
| order by *order_expression*         | çª—å£æ’åºï¼Œæ ¹æ®æ’åºè¡¨è¾¾å¼å¯¹å„ä¸ªåˆ†åŒºå†…çš„æ¯ä¸€è¡Œè¿›è¡Œæ’åºã€‚       |
| *frame*                             | çª—å£æ¡†æ¶ï¼Œä¾‹å¦‚`range between unbounded preceding and unbounded following`ã€‚ |

### è¿”å›å€¼ç±»å‹

ä¸*x*çš„æ•°æ®ç±»å‹ä¸€è‡´ã€‚

### ç¤ºä¾‹

æŒ‰ç…§éƒ¨é—¨åˆ†åŒºï¼Œç»Ÿè®¡å„ä¸ªéƒ¨é—¨ä¸­è–ªæ°´ç¬¬äºŒé«˜çš„å‘˜å·¥ã€‚

- æŸ¥è¯¢å’Œåˆ†æè¯­å¥

   

  ```plaintext
  * |
  select
    department,
    staff_name,
    salary,
    nth_value(staff_name, 2) over(
      partition by department
      order by
        salary desc
        range between unbounded preceding and unbounded following
    ) as second_highest_salary from log
  ```

- æŸ¥è¯¢å’Œåˆ†æç»“æœ