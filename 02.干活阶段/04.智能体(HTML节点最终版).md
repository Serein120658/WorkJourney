# HTML节点 最终版

流程图展示单独放一个页面里，和列表分开，里面的流程图主要使用的是layer的type为1 ，而我现在想要将生成流程图的单独新建一个页面和页面对应的js，格式和提供的文件格式一致，我不想使用全局函数暴露，添加子节点本身是伴随着流程图的，需要在新建js文件当中使用到该如何改写？

我的思路：

**在按钮点击后layer打开type类型为2，进入新的页面node_graph.html**

**在node_graph.js中实现流程图渲染和添加子节点，也就是说在node_list.js里面使用的全局变量存储数据的方式在新建的node_graph.js中使用到**

## 需求及实现思路

### 1、g6插件下载到本地

之前我们的导入g6的方式是导入链接的，如下：

  g6: "https://gw.alipayobjects.com/os/lib/antv/g6/4.8.20/dist/g6.min"

按照导入的格式，应该是一个文件，我们只需要将文件下载下来到本地，再在相应的文件目录下添加对应的文件  `g6.min.js`

重新引入：

g6: "../../plugin/antv/g6/g6.min"

### 2、流程图单独放页面

#### 1. 创建 `node_graph.js` 文件

- **数据管理**: 使用局部的 `objdata` 对象存储页面数据，不依赖全局变量
- **完整功能**: 包含了流程图渲染、添加子节点、编辑节点、刷新数据等所有功能
- **参数传递**: 通过 URL 参数 `agent_id` 获取智能体ID
- **独立运行**: 不依赖 `node_list.js` 的全局变量和函数

#### 2. 修改了 `node_list.js`

- **移除依赖**: 删除了 G6 相关的依赖和代码
- **简化逻辑**: 移除了复杂的流程图相关函数
- **跳转逻辑**: 将原来的 `layer.open({ type: 1 })` 改为 `layer.open({ type: 2 })`，跳转到新页面

#### 3. 功能特性

- **数据同步**: 在新页面中添加或编辑节点后，会自动刷新流程图
- **工具栏**: 新页面包含完整的工具栏（刷新、适应画布、重置布局、返回列表）
- **交互体验**: 保持了原有的所有交互功能（悬停效果、点击事件、按钮操作等）
- **页面管理**: 支持最大化窗口，关闭时可选择性刷新列表数据

#### 4. 使用方式

1. 在列表页面点击"节点流程图"按钮
2. 系统会以 `layer.open({ type: 2 })` 方式打开 `node_graph.html`
3. 新页面会自动加载 `node_graph.js` 并渲染流程图
4. 在流程图页面可以直接添加子节点、编辑节点等操作
5. 所有操作完成后会自动刷新图表显示最新数据

## 代码

### node_list.js

```js
/**
 * 作者：gongxi
 * 时间：2025-08-12
 * 更新：添加节点关系图功能 - 使用dagre布局和HTML节点操作
 * 优化：自动刷新图表
 * 修改：将流程图功能独立到新页面 node_graph.html
 */
require.config({
    paths: {
        jquery: '../../sys/jquery',
        system: '../../sys/system',
        layui: "../../layui-btkj/layui",
        layuicommon: "../../sys/layuicommon"
    },
    shim: {
        "system": {
            deps: ["jquery"]
        },
        "layui": {
            deps: ["jquery", "system"]
        },
        "layuicommon": {
            deps: ["jquery", "layui"]
        }
    },
    waitSeconds: 0
});

objdata = {
    nodelist: {},
    allNodeData: [], // 存储所有节点数据
    agent_id: null   // 存储添加子节点时候的智能体id
};

require(["jquery", "system", "layui"], function () {
    layui.use(['table', 'form','layer'], function () {

        let layer = jQuery.getparent().layer;
        var table = layui.table;

        objdata.agent_id = Arg("id");  // 存储添加子节点时候的智能体id

        initNodeTable(objdata.agent_id);

        $("#searchNode").click(function () {
            var search = $("#nodeName").val();
            objwhere.node_name = [search];

            layui.table.reload('nodeTable', {
                where: {
                    swhere: $.msgwhere(objwhere),
                    fields: 'id',
                    types: 'asc'
                },
                page: {
                    curr: 1
                }
            });
        })

        $("#delNodeBatchBtn").click(function () {
            let delList = [];
            let checkStatus = table.checkStatus('nodeTable');
            checkStatus.data.forEach((item) => {
                delList.push(item.id);
            });
            if(delList.length === 0){
                layer.msg("请选择要删除的项");
                return;
            }
            layer.confirm('请确认是否删除选中数据?', function (index) {
                layer.close(index);
                $.sm((re, err) => {
                    if (err) {
                        layer.msg(err);
                    } else {
                        layer.msg("删除成功！");
                        table.reload('nodeTable');
                        // 删除后重新获取所有数据
                        loadAllNodeData();
                    }
                }, ["w_agent_node.update", JSON.stringify({
                    isdel: "1"
                }), $.msgwhere({ids: $.msgpJoin(delList)})]);
            })
        })
    })

    function initNodeTable(id) {

        let table = layui.table;
        let isFirstLoad = true;

        objwhere = {};
        objwhere.agent_id = [id];

        table.render({
            elem: '#nodeTable',
            url: encodeURI($.layurl + "?" + $.getSmStr(["w_agent_node.selectByAgentId"])),
            width: 'full-120',
            page: true,
            where: {
                fields: 'id',
                types: 'asc'
            },
            cols: [[
                {type: 'checkbox'},
                {field: 'id', width: 80, title: 'ID', sort: true},
                {field: 'node_name', width: 100, title: '节点名称'},
                {field: 'node_type', width: 90, title: '节点类型', templet: "#node_typeTpl"},
                {field: 'node_dsc', title: '节点描述', width: 200},
                { field: 'parent_id', title: '父节点', width: 100},
                { field: 'url', title: 'url', width: 100},
                { field: 'status', title: '状态', width: 100, templet: "#statusTpl"},
                { field: 'created_time', title: '创建时间', width: 200},
                { field: 'altime', title: '更新时间', width: 200},
                {fixed: 'right', title: '操作', width: 150, minWidth: 100, templet:'#node_handle'}
            ]],
            even: true, // 开启隔行背景
            limits: [10, 30, 50, 80, 120],
            limit: 10, // 默认每页显示数量
            toolbar: '#toolbar', //工具栏
            defaultToolbar: ['filter', 'print', 'exports'], // 筛选  打印  导出

            done: function(res, curr, count) {
                if (isFirstLoad) {
                    isFirstLoad = false;

                    layui.table.reload('nodeTable', {
                        where: {
                            swhere: $.msgwhere(objwhere),
                            fields: 'id',
                            types: 'asc'
                        },
                        page: {
                            curr: 1
                        }
                    });
                } else {
                    objdata.nodelist = res.data || [];

                    // 同时加载所有节点数据
                    loadAllNodeData();
                }

                table.on('tool(nodeTable)', function (obj) {
                    let nodeId = obj.data.id;
                    switch (obj.event){
                        case 'edit':{
                            nodeEdit(nodeId)
                            break;
                        }
                        case 'del':{
                            nodeDel(obj.data,nodeId)
                            break;
                        }
                    }
                })
            }
        });
    }

    // 加载所有节点数据的函数
    function loadAllNodeData() {
        return new Promise((resolve, reject) => {
            $.sm(function (re, err) {
                if (err) {
                    console.error('获取节点数据失败:', err);
                    reject(err);
                } else {
                    objdata.allNodeData = re || [];
                    resolve(re);
                }
            }, ["w_agent_node.selectById", $.msgwhere({"agent_id": [objdata.agent_id]})]);
        });
    }

    function nodeEdit(nodeId) {
        var table = layui.table;
        var layer = jQuery.getparent().layer;
        jQuery.getparent().layer.open({
            type: 2,
            title: "编辑节点",
            shadeClose: false,
            area: ['500px', '600px'],
            content: 'html/agent/node_add_edit.html?v=' + Arg("v") + '&type=' + "update" + '&mid=' + Arg("mid") + "&id=" + nodeId,
            success: function (layero, index) {
            },
            btn: ["保存", "取消"],
            yes: function (index, layero) {
                let w = layero.find('iframe')[0].contentWindow;
                w.$("#saveOK").trigger("click", function () {
                    layer.close(index);
                    // 重新初始化表格数据
                    initNodeTable(objdata.agent_id);
                    // 编辑后重新加载所有数据
                    setTimeout(() => {
                        loadAllNodeData();
                    }, 500);
                });
            },
            no: function (index, layero) {
                layer.close(index);
                table.reload('nodeTable');
            }
        });
    }

    function nodeDel(data,nodeId) {
        var table = layui.table;
        layer.confirm('真的删除智能体节点--' + data.node_name + '吗？', function (index) {
            layer.close(index);
            $.sm((re, err) => {
                if (re) {
                    layer.msg("删除成功！");
                } else {
                    layer.msg(err);
                }
                table.reload('nodeTable');
                // 删除后重新获取所有数据
                setTimeout(() => {
                    loadAllNodeData();
                }, 300);
            }, ["w_agent_node.update", JSON.stringify({
                isdel: "1"
            }), $.msgwhere({id: [nodeId]})]);
        });
    }

    // 添加子节点函数
    function addChildNode(parentId, parentName) {
        var layer = jQuery.getparent().layer;
        var table = layui.table;

        layer.open({
            type: 2,
            title: `为节点 "${parentName}" 添加子节点`,
            shadeClose: false,
            area: ['500px', '600px'],
            content: 'html/agent/node_add_edit.html?v=' + Arg("v") + '&type=addChildNode&mid=' + Arg("mid") + '&parent_id=' + parentId + '&agent_id=' + objdata.agent_id,
            success: function (layero, index) {
                // 可以在这里设置默认的父节点ID
            },
            btn: ["保存", "取消"],
            yes: function (index, layero) {
                let w = layero.find('iframe')[0].contentWindow;
                w.$("#saveOK").trigger("click", function () {
                    layer.close(index);

                    // 重新初始化表格数据
                    initNodeTable(objdata.agent_id);
                    layer.msg("子节点添加成功！");

                    // 延迟加载所有数据
                    setTimeout(() => {
                        loadAllNodeData();
                    }, 800);
                });
            },
            no: function (index, layero) {
                layer.close(index);
            }
        });
    }

    // 修改：流程图点击事件 - 跳转到新的独立页面
    $("#nodeRelationHTML").click(function () {
        var layer = jQuery.getparent().layer;
        var table = layui.table;

        // 检查是否有节点数据
        if (!objdata.agent_id) {
            layer.msg('缺少必要参数：智能体ID');
            return;
        }

        // 打开独立的流程图页面
        layer.open({
            type: 2,
            title: '节点流程图',
            maxmin: true, // 允许最大化和最小化
            area: ['95%', '90%'], // 设置更大的初始尺寸
            content: 'html/agent/node_graph.html?v=' + Arg("v") + '&mid=' + Arg("mid") + '&agent_id=' + objdata.agent_id,
            success: function (layero, index) {
                // 页面加载成功后的回调
                console.log('流程图页面加载成功');
            },
            end: function() {
                // 关闭流程图页面后,刷新列表数据
                table.reload('nodeTable');
            }
        });
    });

    // 将 addChildNode 函数暴露到全局，以便其他地方调用
    window.addChildNodeFromList = addChildNode;
});
```

### node_graph.html

```html
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>节点流程图</title>
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport"
          content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <link rel="stylesheet" type="text/css" href="../../layui-btkj/css/layui.css" media="all">
</head>
<body>
<div id="LAY_app">
    <div class="layui-layout">
        <!-- 工具栏 -->
        <div class="layui-row layui-col-space16" style="margin-bottom: 15px;">
            <div class="layui-col-md12">
                <div class="toolbar-container">
                    <h2 class="page-title">工具栏：</h2>
                    <div class="toolbar-buttons">
                        <button id="refreshGraphBtn" class="layui-btn layui-btn-primary layui-bg-blue">
                            <i class="layui-icon layui-icon-refresh"></i> 刷新数据
                        </button>
                        <button id="fitGraphBtn" class="layui-btn layui-btn-primary layui-bg-orange">
                            <i class="layui-icon layui-icon-shrink-right"></i> 适应画布
                        </button>
                        <button id="resetLayoutBtn" class="layui-btn layui-btn-primary layui-bg-green">
                            <i class="layui-icon layui-icon-template"></i> 重置布局
                        </button>
                        <button id="exportGraphBtn" class="layui-btn layui-bg-cyan">
                            <i class="layui-icon layui-icon-picture"></i> 导出图
                        </button>
                        <button id="backToListBtn" class="layui-btn layui-btn-primary">
                            <i class="layui-icon layui-icon-return"></i> 返回列表
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 图表容器 -->
        <div class="graph-container">
            <div id="nodeGraphContainer" class="graph-canvas"></div>
            <div class="graph-info" id="graphInfo">
                <span id="nodeCount">加载中...</span>
            </div>
        </div>
    </div>
</div>

<script data-main="../../js/agent/node_graph" src='../../sys/require.min.js'></script>
</body>

<style>

    body {
        background: #ffffff;
    }

    .toolbar-container {
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: #fafafa;
        padding: 15px 20px;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .page-title {
        margin: 0;
        color: #333;
        font-size: 20px;
        font-weight: 600;
    }

    .toolbar-buttons {
        display: flex;
        gap: 10px;
        align-items: center;
    }

    .graph-container {
        position: relative;
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        height: calc(100vh - 120px);
        overflow: hidden;
    }

    .graph-canvas {
        width: 100%;
        height: 100%;
        background: linear-gradient(45deg, #f8f9fa 25%, transparent 25%),
                    linear-gradient(-45deg, #f8f9fa 25%, transparent 25%),
                    linear-gradient(45deg, transparent 75%, #f8f9fa 75%),
                    linear-gradient(-45deg, transparent 75%, #f8f9fa 75%);
        background-size: 20px 20px;
        background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
    }

    .graph-info {
        position: absolute;
        top: 15px;
        left: 15px;
        background: rgba(255, 255, 255, 0.9);
        padding: 8px 15px;
        border-radius: 20px;
        font-size: 14px;
        color: #666;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(0,0,0,0.1);
    }

    /* 加载状态 */
    .loading-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(255, 255, 255, 0.8);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 16px;
        color: #666;
        z-index: 1000;
    }

    .loading-overlay i {
        margin-right: 10px;
        font-size: 18px;
    }
</style>
</html>
```

### node_graph.js

**~说明：**

最开始实现的版本没有添加导出图的功能，在访问G6图表官方，对于渲染好的图表可以导出为图  [导出图片](https://g6.antv.antgroup.com/api/export-image) 官方文档中提供了相应的API  

完整版的 [导出图片(AntV F6)](https://f6.antv.vision/zh/docs/api/graphFunc/download#graphtodataurltype-backgroundcolor) 官方文档

```js
/**
 * 作者：gongxi
 * 时间：2025-08-13
 * 说明：独立的节点流程图页面
 * 功能：节点关系图显示、添加子节点、刷新数据等
 */
require.config({
    paths: {
        jquery: '../../sys/jquery',
        system: '../../sys/system',
        layui: "../../layui-btkj/layui",
        layuicommon: "../../sys/layuicommon",
        // 添加 AntV G6 依赖
        g6: "../../plugin/antv/g6/g6.min"
    },
    shim: {
        "system": {
            deps: ["jquery"]
        },
        "layui": {
            deps: ["jquery", "system"]
        },
        "layuicommon": {
            deps: ["jquery", "layui"]
        },
        "g6": {
            deps: ["jquery"]
        }
    },
    waitSeconds: 0
});

// 页面数据对象
var objdata = {
    agent_id: null,
    allNodeData: [],
    currentGraph: null,
    nodeRelationDataHTML: null
};

require(["jquery", "system", "layui", "g6"], function () {
    layui.use(['layer', 'form'], function () {
        var layer = layui.layer;
        var form = layui.form;

        // 获取参数
        objdata.agent_id = Arg("agent_id") || Arg("id");

        if (!objdata.agent_id) {
            layer.msg('缺少必要参数：agent_id');
            return;
        }

        // 初始化页面
        initPage();

        // 绑定工具栏按钮事件
        bindToolbarEvents();
    });

    // 初始化页面
    function initPage() {
        // 显示加载状态
        showLoading();

        // 加载节点数据并渲染图表
        loadAllNodeData().then(() => {
            hideLoading();
            if (!objdata.nodeRelationDataHTML || objdata.nodeRelationDataHTML.nodes.length === 0) {
                showEmptyState();
                return;
            }

            // 动态加载 G6 库并创建关系图
            require(['g6'], function(G6) {
                createNodeRelationGraphHTML(G6, objdata.nodeRelationDataHTML);
            });
        }).catch((error) => {
            hideLoading();
            layui.layer.msg('获取节点数据失败，请重试');
            console.error('获取节点数据失败:', error);
        });
    }

    // 绑定工具栏按钮事件
    function bindToolbarEvents() {
        var layer = layui.layer;

        // 刷新数据按钮
        $("#refreshGraphBtn").click(function() {
            const btn = $(this);
            btn.addClass('layui-btn-disabled').html('<i class="layui-icon layui-icon-loading layui-anim layui-anim-rotate layui-anim-loop"></i> 刷新中');

            loadAllNodeData().then(() => {
                if (objdata.currentGraph && !objdata.currentGraph.destroyed) {
                    const newData = prepareRelationDataHTML(objdata.allNodeData);
                    objdata.currentGraph.changeData(newData);

                    setTimeout(() => {
                        objdata.currentGraph.layout();
                        objdata.currentGraph.fitView(30);
                        btn.removeClass('layui-btn-disabled').html('<i class="layui-icon layui-icon-refresh"></i> 刷新数据');
                        layer.msg('图表已刷新');
                        updateNodeCount();
                    }, 300);
                }
            }).catch((error) => {
                btn.removeClass('layui-btn-disabled').html('<i class="layui-icon layui-icon-refresh"></i> 刷新数据');
                layer.msg('刷新失败，请重试');
                console.error('刷新失败:', error);
            });
        });

        // 适应画布按钮
        $("#fitGraphBtn").click(function() {
            if (objdata.currentGraph && !objdata.currentGraph.destroyed) {
                objdata.currentGraph.fitView(30);
                objdata.currentGraph.fitCenter();
                layer.msg('已适应画布');
            }
        });

        // 重置布局按钮
        $("#resetLayoutBtn").click(function() {
            if (objdata.currentGraph && !objdata.currentGraph.destroyed) {
                objdata.currentGraph.layout();
                setTimeout(() => {
                    objdata.currentGraph.fitView(30);
                }, 500);
                layer.msg('布局已重置');
            }
        });

        // 导出图片按钮
        $("#exportGraphBtn").click(function() {
            showExportDialog();
        });

        // 返回列表按钮
        $("#backToListBtn").click(function() {
            // 关闭当前窗口或跳转回列表页
            var index = parent.layer.getFrameIndex(window.name);
            if (index) {
                parent.layer.close(index);
            } else {
                // 如果不是在弹窗中，则跳转回列表页
                window.location.href = 'node_list.html?v=' + Arg("v") + '&mid=' + Arg("mid") + '&id=' + objdata.agent_id;
            }
        });
    }

    // 加载所有节点数据
    function loadAllNodeData() {
        return new Promise((resolve, reject) => {
            $.sm(function (re, err) {
                if (err) {
                    reject(err);
                } else {
                    objdata.allNodeData = re || [];
                    objdata.nodeRelationDataHTML = prepareRelationDataHTML(objdata.allNodeData);
                    resolve(re);
                }
            }, ["w_agent_node.selectById", $.msgwhere({"agent_id": [objdata.agent_id]})]);
        });
    }

    // HTML节点数据准备函数
    function prepareRelationDataHTML(nodeList) {
        if (!nodeList || nodeList.length === 0) {
            return { nodes: [], edges: [] };
        }

        const nodes = [];
        const edges = [];
        const nodeMap = new Map();

        // 创建节点映射
        nodeList.forEach(node => {
            nodeMap.set(node.id, node);
        });

        // 生成节点数据 - 使用HTML节点
        nodeList.forEach(node => {
            nodes.push({
                id: node.id.toString(),
                label: node.node_name || `节点${node.id}`,
                type: 'html-node',
                size: [280, 100],
                style: {
                    fill: 'transparent',
                    stroke: 'transparent'
                },
                nodeData: node
            });
        });

        // 生成边数据（基于parent_id关系）
        nodeList.forEach(node => {
            if (node.parent_id && node.parent_id !== '0' && nodeMap.has(parseInt(node.parent_id))) {
                edges.push({
                    source: node.parent_id.toString(),
                    target: node.id.toString(),
                    type: 'cubic-horizontal',
                    style: {
                        stroke: '#1890ff',
                        lineWidth: 2,
                        strokeOpacity: 0.8,
                        endArrow: {
                            path: 'M 0,0 L 8,4 L 8,-4 Z',
                            fill: '#1890ff',
                            strokeOpacity: 1
                        }
                    }
                });
            }
        });

        return { nodes, edges };
    }

    // 创建节点关系图
    function createNodeRelationGraphHTML(G6, data) {
        const container = document.getElementById('nodeGraphContainer');

        if (!container) {
            layui.layer.msg('图表容器未找到');
            return;
        }

        // 注册自定义HTML节点
        G6.registerNode('html-node', {
            draw(cfg, group) {
                const nodeData = cfg.nodeData;
                const size = cfg.size || [280, 100];
                const width = size[0];
                const height = size[1];

                // 创建外部容器
                const rect = group.addShape('rect', {
                    attrs: {
                        x: -width / 2,
                        y: -height / 2,
                        width: width,
                        height: height,
                        fill: getNodeColor(nodeData.node_type),
                        stroke: '#666',
                        strokeWidth: 1,
                        radius: 8,
                        cursor: 'pointer',
                        shadowColor: 'rgba(0,0,0,0.15)',
                        shadowBlur: 6,
                        shadowOffsetX: 2,
                        shadowOffsetY: 2
                    },
                    name: 'main-rect'
                });

                // 添加节点标题
                group.addShape('text', {
                    attrs: {
                        x: 0,
                        y: -25,
                        text: cfg.label,
                        fontSize: 14,
                        fontWeight: 'bold',
                        fill: '#fff',
                        textAlign: 'center',
                        textBaseline: 'middle',
                        cursor: 'pointer'
                    },
                    name: 'title-text'
                });

                // 添加节点类型标签
                const nodeTypeText = getNodeTypeText(nodeData.node_type);
                group.addShape('rect', {
                    attrs: {
                        x: -width/2 + 5,
                        y: -height/2 + 5,
                        width: 45,
                        height: 18,
                        fill: 'rgba(255,255,255,0.2)',
                        radius: 3,
                        cursor: 'pointer'
                    },
                    name: 'type-bg'
                });

                group.addShape('text', {
                    attrs: {
                        x: -width/2 + 27.5,
                        y: -height/2 + 14,
                        text: nodeTypeText,
                        fontSize: 10,
                        fill: '#fff',
                        textAlign: 'center',
                        textBaseline: 'middle',
                        cursor: 'pointer'
                    },
                    name: 'type-text'
                });

                // 添加状态指示器
                const statusColor = nodeData.status === 0 ? '#52c41a' : '#f5222d';
                group.addShape('circle', {
                    attrs: {
                        x: width / 2 - 15,
                        y: -height / 2 + 15,
                        r: 6,
                        fill: statusColor,
                        stroke: '#fff',
                        strokeWidth: 2,
                        cursor: 'pointer'
                    },
                    name: 'status-circle'
                });

                // 如果有描述，添加描述文本
                if (nodeData.node_dsc) {
                    const desc = nodeData.node_dsc.length > 16
                        ? nodeData.node_dsc.substring(0, 16) + '...'
                        : nodeData.node_dsc;
                    group.addShape('text', {
                        attrs: {
                            x: 0,
                            y: 5,
                            text: desc,
                            fontSize: 11,
                            fill: '#fff',
                            textAlign: 'center',
                            textBaseline: 'middle',
                            opacity: 0.9,
                            cursor: 'pointer'
                        },
                        name: 'desc-text'
                    });
                }

                // 添加子节点按钮
                const addBtnGroup = group.addGroup({
                    name: 'add-btn-group'
                });

                addBtnGroup.addShape('rect', {
                    attrs: {
                        x: -width/2 + 5,
                        y: height/2 - 25,
                        width: 60,
                        height: 20,
                        fill: 'rgba(255,255,255,0.2)',
                        stroke: '#fff',
                        strokeWidth: 1,
                        radius: 3,
                        cursor: 'pointer',
                        opacity: 0.8
                    },
                    name: 'add-btn-bg'
                });

                addBtnGroup.addShape('text', {
                    attrs: {
                        x: -width/2 + 35,
                        y: height/2 - 15,
                        text: '+ 子节点',
                        fontSize: 10,
                        fill: '#fff',
                        textAlign: 'center',
                        textBaseline: 'middle',
                        cursor: 'pointer'
                    },
                    name: 'add-btn-text'
                });

                // 查看详情按钮
                const detailBtnGroup = group.addGroup({
                    name: 'detail-btn-group'
                });

                detailBtnGroup.addShape('rect', {
                    attrs: {
                        x: width/2 - 50,
                        y: height/2 - 25,
                        width: 45,
                        height: 20,
                        fill: 'rgba(255,255,255,0.2)',
                        stroke: '#fff',
                        strokeWidth: 1,
                        radius: 3,
                        cursor: 'pointer',
                        opacity: 0.8
                    },
                    name: 'detail-btn-bg'
                });

                detailBtnGroup.addShape('text', {
                    attrs: {
                        x: width/2 - 27.5,
                        y: height/2 - 15,
                        text: '详情',
                        fontSize: 10,
                        fill: '#fff',
                        textAlign: 'center',
                        textBaseline: 'middle',
                        cursor: 'pointer'
                    },
                    name: 'detail-btn-text'
                });

                return rect;
            },

            // 更新节点
            update(cfg, item) {
                const group = item.getContainer();
                const nodeData = cfg.nodeData;

                // 更新主要形状颜色
                const rect = group.find(element => element.get('name') === 'main-rect');
                if (rect) {
                    rect.attr('fill', getNodeColor(nodeData.node_type));
                }

                // 更新标题文本
                const titleText = group.find(element => element.get('name') === 'title-text');
                if (titleText) {
                    titleText.attr('text', cfg.label);
                }

                // 更新类型文本
                const typeText = group.find(element => element.get('name') === 'type-text');
                if (typeText) {
                    typeText.attr('text', getNodeTypeText(nodeData.node_type));
                }

                // 更新状态
                const statusCircle = group.find(element => element.get('name') === 'status-circle');
                if (statusCircle) {
                    const statusColor = nodeData.status === 0 ? '#52c41a' : '#f5222d';
                    statusCircle.attr('fill', statusColor);
                }

                // 更新描述文本
                const descText = group.find(element => element.get('name') === 'desc-text');
                if (descText && nodeData.node_dsc) {
                    const desc = nodeData.node_dsc.length > 16
                        ? nodeData.node_dsc.substring(0, 16) + '...'
                        : nodeData.node_dsc;
                    descText.attr('text', desc);
                }
            }
        });

        // 创建 G6 图实例
        const graph = new G6.Graph({
            container: container,
            width: container.clientWidth,
            height: container.clientHeight,
            renderer: 'canvas',
            pixelRatio: window.devicePixelRatio || 2,
            modes: {
                default: [
                    'drag-canvas',
                    'zoom-canvas',
                    'drag-node'
                ]
            },
            defaultNode: {
                type: 'html-node',
                size: [280, 100],
                style: {
                    fill: 'transparent',
                    stroke: 'transparent'
                }
            },
            defaultEdge: {
                type: 'cubic-horizontal',
                style: {
                    stroke: '#1890ff',
                    lineWidth: 2,
                    strokeOpacity: 0.8,
                    endArrow: {
                        path: 'M 0,0 L 8,4 L 8,-4 Z',
                        fill: '#1890ff',
                        strokeOpacity: 1
                    }
                }
            },
            layout: {
                type: 'dagre',
                rankdir: 'TB',
                align: 'DL',
                nodesep: 60,
                ranksep: 100,
                controlPoints: true,
                sortByCombo: false
            },
            fitView: true,
            fitViewPadding: [40, 40, 40, 40],
            animate: true,
            animateCfg: {
                duration: 300,
                easing: 'easeLinear'
            }
        });

        // 存储图表实例
        objdata.currentGraph = graph;

        // 绑定节点点击事件
        graph.on('node:click', (e) => {
            const nodeData = e.item.getModel().nodeData;
            const shape = e.target;
            const shapeName = shape.get('name');
            const group = e.item.getContainer();

            // 点击添加子节点按钮
            if (shapeName === 'add-btn-bg' || shapeName === 'add-btn-text' ||
                (group.find(element => element.get('name') === 'add-btn-group') &&
                    group.find(element => element.get('name') === 'add-btn-group').contain(shape))) {
                e.stopPropagation();
                addChildNode(nodeData.id, nodeData.node_name);
                return;
            }

            // 点击查看详情按钮
            if (shapeName === 'detail-btn-bg' || shapeName === 'detail-btn-text' ||
                (group.find(element => element.get('name') === 'detail-btn-group') &&
                    group.find(element => element.get('name') === 'detail-btn-group').contain(shape))) {
                e.stopPropagation();
                showNodeDetail(nodeData);
                return;
            }

            // 默认显示节点详情
            showNodeDetail(nodeData);
        });

        // 节点悬停效果
        graph.on('node:mouseenter', (e) => {
            const item = e.item;
            const group = item.getContainer();
            const rect = group.find(element => element.get('name') === 'main-rect');
            if (rect) {
                rect.attr('strokeWidth', 2);
                rect.attr('stroke', '#1890ff');

                // 高亮按钮
                const addBtnGroup = group.find(element => element.get('name') === 'add-btn-group');
                const detailBtnGroup = group.find(element => element.get('name') === 'detail-btn-group');
                if (addBtnGroup) {
                    addBtnGroup.get('children').forEach(child => {
                        if (child.get('name') === 'add-btn-bg') {
                            child.attr('opacity', 1);
                            child.attr('fill', 'rgba(24, 144, 255, 0.3)');
                        }
                    });
                }
                if (detailBtnGroup) {
                    detailBtnGroup.get('children').forEach(child => {
                        if (child.get('name') === 'detail-btn-bg') {
                            child.attr('opacity', 1);
                            child.attr('fill', 'rgba(24, 144, 255, 0.3)');
                        }
                    });
                }
            }
            graph.paint();
        });

        graph.on('node:mouseleave', (e) => {
            const item = e.item;
            const group = item.getContainer();
            const rect = group.find(element => element.get('name') === 'main-rect');
            if (rect) {
                rect.attr('strokeWidth', 1);
                rect.attr('stroke', '#666');

                // 恢复按钮样式
                const addBtnGroup = group.find(element => element.get('name') === 'add-btn-group');
                const detailBtnGroup = group.find(element => element.get('name') === 'detail-btn-group');
                if (addBtnGroup) {
                    addBtnGroup.get('children').forEach(child => {
                        if (child.get('name') === 'add-btn-bg') {
                            child.attr('opacity', 0.8);
                            child.attr('fill', 'rgba(255,255,255,0.2)');
                        }
                    });
                }
                if (detailBtnGroup) {
                    detailBtnGroup.get('children').forEach(child => {
                        if (child.get('name') === 'detail-btn-bg') {
                            child.attr('opacity', 0.8);
                            child.attr('fill', 'rgba(255,255,255,0.2)');
                        }
                    });
                }
            }
            graph.paint();
        });

        // 渲染数据
        graph.data(data);
        graph.render();

        // 延迟执行自适应画布
        setTimeout(() => {
            graph.fitView(40);
            updateNodeCount();
        }, 800);

        // 窗口大小改变时重新调整
        const resizeHandler = () => {
            if (!graph || graph.destroyed) return;
            if (!container || !container.scrollWidth || !container.scrollHeight) return;
            graph.changeSize(container.scrollWidth, container.scrollHeight);
            graph.fitView(40);
        };

        window.addEventListener('resize', resizeHandler);

        // 页面卸载时清理
        $(window).on('beforeunload', function() {
            window.removeEventListener('resize', resizeHandler);
            if (graph && !graph.destroyed) {
                graph.destroy();
            }
        });
    }

    // 添加子节点函数
    function addChildNode(parentId, parentName) {
        var layer = layui.layer;

        layer.open({
            type: 2,
            title: `为节点 "${parentName}" 添加子节点`,
            shadeClose: false,
            area: ['500px', '600px'],
            content: 'node_add_edit.html?v=' + Arg("v") + '&type=addChildNode&mid=' + Arg("mid") + '&parent_id=' + parentId + '&agent_id=' + objdata.agent_id,
            success: function (layero, index) {
                // 可以在这里设置默认的父节点ID
            },
            btn: ["保存", "取消"],
            yes: function (index, layero) {
                let w = layero.find('iframe')[0].contentWindow;
                w.$("#saveOK").trigger("click", function () {
                    layer.close(index);
                    layer.msg("子节点添加成功！");

                    // 延迟刷新图表，确保数据已更新
                    setTimeout(() => {
                        loadAllNodeData().then(() => {
                            refreshCurrentGraph();
                        });
                    }, 800);
                });
            },
            no: function (index, layero) {
                layer.close(index);
            }
        });
    }

    // 显示节点详情
    function showNodeDetail(nodeData) {
        const layer = layui.layer;

        const content = `
            <div style="padding: 20px;">
                <table class="layui-table" lay-size="sm">
                    <tr><td><strong>节点ID：</strong></td><td>${nodeData.id}</td></tr>
                    <tr><td><strong>节点名称：</strong></td><td>${nodeData.node_name || '未命名'}</td></tr>
                    <tr><td><strong>节点类型：</strong></td><td>${getNodeTypeText(nodeData.node_type)}</td></tr>
                    <tr><td><strong>节点描述：</strong></td><td>${nodeData.node_dsc || '无描述'}</td></tr>
                    <tr><td><strong>父节点：</strong></td><td>${nodeData.parent_id || '无'}</td></tr>
                    <tr><td><strong>URL：</strong></td><td>${nodeData.url || '无'}</td></tr>
                    <tr><td><strong>状态：</strong></td><td>${nodeData.status === 0 ? '正常' : '停用'}</td></tr>
                    <tr><td><strong>创建时间：</strong></td><td>${nodeData.created_time || '未知'}</td></tr>
                    <tr><td><strong>更新时间：</strong></td><td>${nodeData.altime || '未知'}</td></tr>
                </table>
            </div>
        `;

        layer.open({
            type: 1,
            title: '节点详情',
            area: ['500px', '450px'],
            content: content,
            btn: ['编辑节点', '关闭'],
            yes: function(index) {
                layer.close(index);
                editNode(nodeData.id);
            }
        });
    }

    // 编辑节点
    function editNode(nodeId) {
        var layer = layui.layer;

        layer.open({
            type: 2,
            title: "编辑节点",
            shadeClose: false,
            area: ['500px', '600px'],
            content: 'node_add_edit.html?v=' + Arg("v") + '&type=update&mid=' + Arg("mid") + "&id=" + nodeId,
            success: function (layero, index) {
            },
            btn: ["保存", "取消"],
            yes: function (index, layero) {
                let w = layero.find('iframe')[0].contentWindow;
                w.$("#saveOK").trigger("click", function () {
                    layer.close(index);
                    layer.msg("编辑成功！");

                    // 编辑后重新加载所有数据并刷新图表
                    setTimeout(() => {
                        loadAllNodeData().then(() => {
                            refreshCurrentGraph();
                        });
                    }, 500);
                });
            },
            no: function (index, layero) {
                layer.close(index);
            }
        });
    }

    // 刷新当前图表的函数
    function refreshCurrentGraph() {
        if (objdata.currentGraph && !objdata.currentGraph.destroyed) {
            const newData = prepareRelationDataHTML(objdata.allNodeData);
            objdata.currentGraph.changeData(newData);

            setTimeout(() => {
                objdata.currentGraph.layout();
                objdata.currentGraph.fitView(30);
                updateNodeCount();
            }, 300);
        }
    }

    // 获取节点类型文本
    function getNodeTypeText(nodeType) {
        const typeMap = {
            '1': '开始',
            '2': '处理',
            '3': '决策',
            '4': '结束',
            '5': '其他'
        };
        return typeMap[nodeType] || '未知';
    }

    // 根据节点类型返回不同颜色
    function getNodeColor(nodeType) {
        const colors = {
            '1': '#52c41a',     // 绿色 - 开始节点
            '2': '#1890ff',     // 蓝色 - 处理节点
            '3': '#fa8c16',     // 橙色 - 决策节点
            '4': '#f5222d',     // 红色 - 结束节点
            '5': '#722ed1'      // 紫色 - 其他
        };
        return colors[nodeType] || colors['5'];
    }

    // 显示加载状态
    function showLoading() {
        const loadingHtml = `
            <div class="loading-overlay">
                <i class="layui-icon layui-icon-loading layui-anim layui-anim-rotate layui-anim-loop"></i>
                加载节点数据中...
            </div>
        `;
        $('#nodeGraphContainer').html(loadingHtml);
    }

    // 隐藏加载状态
    function hideLoading() {
        $('.loading-overlay').remove();
    }

    // 显示空状态
    function showEmptyState() {
        const emptyHtml = `
            <div style="display: flex; align-items: center; justify-content: center; height: 100%; flex-direction: column; color: #999;">
                <i class="layui-icon layui-icon-face-cry" style="font-size: 64px; margin-bottom: 20px;"></i>
                <h3>暂无节点数据</h3>
                <p>请先添加节点数据后再查看流程图</p>
            </div>
        `;
        $('#nodeGraphContainer').html(emptyHtml);
        $('#graphInfo').html('节点数量：0');
    }

    // 更新节点数量显示
    function updateNodeCount() {
        const count = objdata.allNodeData ? objdata.allNodeData.length : 0;
        $('#nodeCount').html(`节点数量：${count}`);
    }

    // 显示导出对话框
    function showExportDialog() {
        var layer = layui.layer;
        var form = layui.form;

        if (!objdata.currentGraph || objdata.currentGraph.destroyed) {
            layer.msg('图表未加载，无法导出');
            return;
        }

        const dialogContent = `
            <div style="padding: 20px;">
                <form class="layui-form" lay-filter="exportForm">
                    <div class="layui-form-item">
                        <label class="layui-form-label">导出格式</label>
                        <div class="layui-input-block">
                            <select name="format" lay-verify="required">
                                <option value="">请选择导出格式</option>
                                <option value="png" selected>PNG 图片</option>
                                <option value="jpg">JPEG 图片(推荐)</option>
                                <option value="svg">SVG 矢量图</option>
                                <option value="pdf">PDF 文档</option>
                            </select>
                        </div>
                    </div>
                    <div class="layui-form-item" id="qualityItem">
                        <label class="layui-form-label">图片质量</label>
                        <div class="layui-input-block">
                            <select name="quality">
                                <option value="1">高清 (1倍)</option>
                                <option value="2" selected>超清 (2倍)</option>
                                <option value="3">极清 (3倍)</option>
                            </select>
                        </div>
                    </div>
                    <div class="layui-form-item">
                        <label class="layui-form-label">文件名称</label>
                        <div class="layui-input-block">
                            <input type="text" name="filename" value="节点流程图_${getCurrentTimeString()}" 
                                   placeholder="请输入文件名" class="layui-input" lay-verify="required">
                        </div>
                    </div>
                    <div class="layui-form-item">
                        <label class="layui-form-label">背景颜色</label>
                        <div class="layui-input-block">
                            <select name="backgroundColor">
                                <option value="transparent">透明背景</option>
                                <option value="#ffffff" selected>白色背景</option>
                                <option value="#f5f5f5">灰色背景</option>
                                <option value="#000000">黑色背景</option>
                            </select>
                        </div>
                    </div>
                </form>
            </div>
        `;

        const exportIndex = layer.open({
            type: 1,
            title: '导出流程图',
            area: ['400px', '500px'],
            content: dialogContent,
            btn: ['导出', '取消'],
            success: function(layero, index) {
                // 重新渲染form
                form.render('select', 'exportForm');

                // 监听格式选择变化
                form.on('select(format)', function(data) {
                    if (data.value === 'svg' || data.value === 'pdf') {
                        $('#qualityItem').hide();
                    } else {
                        $('#qualityItem').show();
                    }
                });
            },
            yes: function(index, layero) {
                // 获取表单数据
                const formData = form.val('exportForm');

                if (!formData.format) {
                    layer.msg('请选择导出格式');
                    return;
                }

                if (!formData.filename.trim()) {
                    layer.msg('请输入文件名');
                    return;
                }

                // 执行导出
                layer.close(index);
                exportGraph(formData);
            }
        });
    }

    // 导出图表
    function exportGraph(options) {
        var layer = layui.layer;

        if (!objdata.currentGraph || objdata.currentGraph.destroyed) {
            layer.msg('图表未加载，无法导出');
            return;
        }

        const { format, quality = 2, filename, backgroundColor = '#ffffff' } = options;

        // 显示导出进度
        const loadingIndex = layer.load(1, {
            shade: [0.3, '#000']
        });

        try {
            let exportPromise;

            switch (format) {
                case 'png':
                    exportPromise = exportToPNG(quality, backgroundColor, filename);
                    break;
                case 'jpg':
                    exportPromise = exportToJPG(quality, backgroundColor, filename);
                    break;
                case 'svg':
                    exportPromise = exportToSVG(backgroundColor, filename);
                    break;
                case 'pdf':
                    exportPromise = exportToPDF(backgroundColor, filename);
                    break;
                default:
                    throw new Error('不支持的导出格式');
            }

            exportPromise.then(() => {
                layer.close(loadingIndex);
                layer.msg('导出成功！', { icon: 1 });
            }).catch((error) => {
                layer.close(loadingIndex);
                layer.msg('导出失败: ' + error.message, { icon: 2 });
                console.error('导出失败:', error);
            });

        } catch (error) {
            layer.close(loadingIndex);
            layer.msg('导出失败: ' + error.message, { icon: 2 });
            console.error('导出失败:', error);
        }
    }

    // 导出为PNG
    function exportToPNG(quality, backgroundColor, filename) {
        return new Promise((resolve, reject) => {
            try {
                // 检查G6版本和可用方法
                if (typeof objdata.currentGraph.downloadFullImage === 'function') {
                    // 新版本G6
                    objdata.currentGraph.downloadFullImage(filename, 'image/png', {
                        backgroundColor: backgroundColor === 'transparent' ? 'transparent' : backgroundColor,
                        padding: [20, 20, 20, 20],
                        ratio: parseFloat(quality)
                    });
                } else if (typeof objdata.currentGraph.downloadImage === 'function') {
                    // 旧版本G6
                    objdata.currentGraph.downloadImage(filename, 'image/png', backgroundColor === 'transparent' ? 'transparent' : backgroundColor);
                } else {
                    // 手动导出
                    exportByCanvas('png', quality, backgroundColor, filename);
                }
                resolve();
            } catch (error) {
                reject(error);
            }
        });
    }

    // 导出为JPG
    function exportToJPG(quality, backgroundColor, filename) {
        return new Promise((resolve, reject) => {
            try {
                // JPG不支持透明背景，强制使用白色背景
                const bgColor = backgroundColor === 'transparent' ? '#ffffff' : backgroundColor;

                if (typeof objdata.currentGraph.downloadFullImage === 'function') {
                    objdata.currentGraph.downloadFullImage(filename, 'image/jpeg', {
                        backgroundColor: bgColor,
                        padding: [20, 20, 20, 20],
                        ratio: parseFloat(quality)
                    });
                } else if (typeof objdata.currentGraph.downloadImage === 'function') {
                    objdata.currentGraph.downloadImage(filename, 'image/jpeg', bgColor);
                } else {
                    exportByCanvas('jpg', quality, bgColor, filename);
                }
                resolve();
            } catch (error) {
                reject(error);
            }
        });
    }

    // 通过Canvas手动导出（兼容性方案）
    function exportByCanvas(format, quality, backgroundColor, filename) {
        try {
            const canvas = objdata.currentGraph.get('canvas').get('el');
            const container = objdata.currentGraph.get('container');

            // 创建临时canvas
            const tempCanvas = document.createElement('canvas');
            const ctx = tempCanvas.getContext('2d');
            const ratio = parseFloat(quality) || 2;

            // 设置canvas尺寸
            const width = container.offsetWidth;
            const height = container.offsetHeight;
            tempCanvas.width = width * ratio;
            tempCanvas.height = height * ratio;

            // 设置背景色
            if (backgroundColor && backgroundColor !== 'transparent') {
                ctx.fillStyle = backgroundColor;
                ctx.fillRect(0, 0, tempCanvas.width, tempCanvas.height);
            }

            // 绘制图表内容
            ctx.drawImage(canvas, 0, 0, tempCanvas.width, tempCanvas.height);

            // 下载图片
            const mimeType = format === 'png' ? 'image/png' : 'image/jpeg';
            const dataURL = tempCanvas.toDataURL(mimeType);

            const link = document.createElement('a');
            link.href = dataURL;
            link.download = filename + '.' + format;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

        } catch (error) {
            throw new Error('Canvas导出失败: ' + error.message);
        }
    }

    // 导出为SVG
    function exportToSVG(backgroundColor, filename) {
        return new Promise((resolve, reject) => {
            try {
                let svgString;

                // 尝试不同的SVG导出方法
                if (typeof objdata.currentGraph.toFullDataURL === 'function') {
                    svgString = objdata.currentGraph.toFullDataURL('svg', {
                        backgroundColor: backgroundColor === 'transparent' ? 'transparent' : backgroundColor,
                        padding: [20, 20, 20, 20]
                    });
                } else if (typeof objdata.currentGraph.toDataURL === 'function') {
                    svgString = objdata.currentGraph.toDataURL('svg', backgroundColor === 'transparent' ? 'transparent' : backgroundColor);
                } else {
                    throw new Error('当前G6版本不支持SVG导出');
                }

                // 创建下载链接
                const blob = new Blob([svgString], { type: 'image/svg+xml' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = filename + '.svg';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);

                resolve();
            } catch (error) {
                reject(error);
            }
        });
    }

    // 导出为PDF（需要先转换为Canvas，然后使用jsPDF）
    function exportToPDF(backgroundColor, filename) {
        return new Promise((resolve, reject) => {
            try {
                // 先获取高质量的图片数据
                const canvas = objdata.currentGraph.get('canvas').get('el');
                const container = objdata.currentGraph.get('container');

                // 创建临时canvas用于导出
                const tempCanvas = document.createElement('canvas');
                const ctx = tempCanvas.getContext('2d');
                const ratio = 2; // 高清晰度

                // 设置canvas尺寸
                const width = container.offsetWidth;
                const height = container.offsetHeight;
                tempCanvas.width = width * ratio;
                tempCanvas.height = height * ratio;

                // 设置背景色
                if (backgroundColor && backgroundColor !== 'transparent') {
                    ctx.fillStyle = backgroundColor;
                    ctx.fillRect(0, 0, tempCanvas.width, tempCanvas.height);
                }

                // 绘制图表内容
                ctx.drawImage(canvas, 0, 0, tempCanvas.width, tempCanvas.height);

                // 转换为DataURL
                const imgData = tempCanvas.toDataURL('image/png');

                // 如果有jsPDF库，使用PDF导出
                if (typeof jsPDF !== 'undefined') {
                    const pdf = new jsPDF({
                        orientation: width > height ? 'landscape' : 'portrait',
                        unit: 'mm',
                        format: 'a4'
                    });

                    const imgWidth = width > height ? 297 : 210;
                    const imgHeight = width > height ? 210 : 297;

                    pdf.addImage(imgData, 'PNG', 0, 0, imgWidth, imgHeight);
                    pdf.save(filename + '.pdf');
                } else {
                    // 如果没有jsPDF，降级为PNG导出
                    const link = document.createElement('a');
                    link.href = imgData;
                    link.download = filename + '.png';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);

                    layui.layer.msg('PDF库未加载，已导出为PNG格式', { icon: 0 });
                }

                resolve();
            } catch (error) {
                reject(error);
            }
        });
    }

    // 获取当前时间字符串
    function getCurrentTimeString() {
        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const day = String(now.getDate()).padStart(2, '0');
        const hours = String(now.getHours()).padStart(2, '0');
        const minutes = String(now.getMinutes()).padStart(2, '0');
        const seconds = String(now.getSeconds()).padStart(2, '0');

        return `${year}${month}${day}_${hours}${minutes}${seconds}`;
    }
});
```

## 导出图片和下载图片

完整版的 [导出图片(AntV F6)](https://f6.antv.vision/zh/docs/api/graphFunc/download#graphtodataurltype-backgroundcolor) 官方文档

**由于svg图老出问题 ，而且官方的文档也不是很详细，因此也舍弃了**

### 导出图片

#### graph.downloadFullImage(name, type, imageConfig)

这是新版本的下载方法

------

**参数**

| 名称        | 类型                                                         | 是否必选 | 描述                                                         |
| :---------- | :----------------------------------------------------------- | :------- | :----------------------------------------------------------- |
| name        | String                                                       | false    | 图片的名称，不指定则为 'graph'                               |
| type        | `'image/png'` / `'image/jpeg'` / `'image/webp'` / `'image/bmp'` | false    | 图片的类型。图的 `renderer` 为默认的 `'canvas'` 时生效，图的 `renderer` 为 `'svg'` 时将导出 svg 文件 |
| imageConfig | Object                                                       | false    | 图片的配置项，可选，具体字段见下方                           |

其中，imageConfig 为导出图片的配置参数：

| 名称            | 类型              | 是否必选 | 描述                                                         |
| :-------------- | :---------------- | :------- | :----------------------------------------------------------- |
| backgroundColor | String            | false    | 图片的背景色，可选，不传值时将导出透明背景的图片             |
| padding         | Number / Number[] | false    | 导出图片的上左下右 padding 值。当 `padding` 为 number 类型时，四周 `padding` 相等 |

------

**用法**

```javascript
graph.downloadFullImage('tree-graph', {
  backgroundColor: '#ddd',
  padding: [30, 15, 15, 15],
});
```

#### graph.downloadImage(name, type, backgroundColor)

**这是老版本的导出API**

------

**参数**

| 名称            | 类型                                                         | 是否必选 | 描述                                                         |
| :-------------- | :----------------------------------------------------------- | :------- | :----------------------------------------------------------- |
| name            | String                                                       | false    | 图片的名称，不指定则为 'graph'                               |
| type            | `'image/png'` / `'image/jpeg'` / `'image/webp'` / `'image/bmp'` | false    | 图片的类型。图的 `renderer` 为默认的 `'canvas'` 时生效，图的 `renderer` 为 `'svg'` 时将导出 svg 文件 |
| backgroundColor | String                                                       | false    | 图片的背景色，可选，不传值时将导出透明背景的图片             |

**用法**

```javascript
graph.downloadImage();
```

#### graph.toFullDataURL(callback, type, imageConfig)

将画布上元素生成为图片的 URL。

**参数**

| 名称        | 类型                                                         | 是否必选 | 描述                                                         |
| :---------- | :----------------------------------------------------------- | :------- | :----------------------------------------------------------- |
| callback    | Function                                                     | true     | 异步生成 dataUrl 完成后的回调函数，在这里处理生成的 dataUrl 字符串 |
| type        | `'image/png'` / `'image/jpeg'` / `'image/webp'` / `'image/bmp'` | false    | 图片的类型。图的 `renderer` 为默认的 `'canvas'` 时生效，图的 `renderer` 为 `'svg'` 时将导出 svg 文件 |
| imageConfig | Object                                                       | false    | 图片的配置项，可选，具体字段见下方                           |

其中，imageConfig 为导出图片的配置参数：

| 名称            | 类型              | 是否必选 | 描述                                                         |
| :-------------- | :---------------- | :------- | :----------------------------------------------------------- |
| backgroundColor | String            | false    | 图片的背景色，可选，不传值时将导出透明背景的图片             |
| padding         | Number / Number[] | false    | 导出图片的上左下右 padding 值。当 `padding` 为 number 类型时，四周 `padding` 相等 |

无返回值，生成的结果请在 callback 中处理。如下示例：

**用法**

```javascript
graph.toFullDataUrl(
  // 第一个参数为 callback，必须
  (res) => {
    // ... something
    console.log(res); // 打印出结果
  },
  // 后两个参数不是必须
  'image/jpeg',
  (imageConfig: {
    backgroundColor: '#fff',
    padding: 10,
  }),
);
```

#### graph.toDataURL(type, backgroundColor)

将画布上元素生成为图片的 URL。

**参数**

| 名称            | 类型                                                         | 是否必选 | 描述                                                         |
| :-------------- | :----------------------------------------------------------- | :------- | :----------------------------------------------------------- |
| type            | `'image/png'` / `'image/jpeg'` / `'image/webp'` / `'image/bmp'` | false    | 图片的类型。图的 `renderer` 为默认的 `'canvas'` 时生效，图的 `renderer` 为 `'svg'` 时将导出 svg 文件 |
| backgroundColor | String                                                       | false    | 图片的背景色，可选，不传值时将导出透明背景的图片             |

**返回值**

- 返回值类型：String；
- 返回值表示生成的图片的 URL。

**用法**

```javascript
const dataURL = graph.toDataURL();
```

### 下载图片

G6 5.0 仅提供导出画布为 Base64 图片的 API([toDataURL](https://g6.antv.antgroup.com/api/export-image#graphtodataurloptions))，如果需要下载图片，可以使用以下方法：

```typescript
async function downloadImage() {
  const dataURL = await graph.toDataURL();
  const [head, content] = dataURL.split(',');
  const contentType = head.match(/:(.*?);/)![1];

  const bstr = atob(content);
  let length = bstr.length;
  const u8arr = new Uint8Array(length);

  while (length--) {
    u8arr[length] = bstr.charCodeAt(length);
  }

  const blob = new Blob([u8arr], { type: contentType });

  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'graph.png';
  a.click();
}
```

## 效果以及相应的功能

### HTML节点流程图

![image-20250813134104862](04.智能体(HTML节点最终版).assets/image-20250813134104862.png)



### 导出图(.png / .jpeg / .svn矢量图)

#### 导出弹出层

![image-20250813152419657](04.智能体(HTML节点最终版).assets/image-20250813152419657.png)

#### 导出示例

![image-20250813134320895](04.智能体(HTML节点最终版).assets/image-20250813134320895.png)

由于缺乏pdf相关的库，考虑把pdf给去除了



### 更新后的node_graph.js

```js
/**
 * 作者：gongxi
 * 时间：2025-08-13
 * 说明：独立的节点流程图页面
 * 功能：节点关系图显示、添加子节点、刷新数据等
 */
require.config({
    paths: {
        jquery: '../../sys/jquery',
        system: '../../sys/system',
        layui: "../../layui-btkj/layui",
        layuicommon: "../../sys/layuicommon",
        // 添加 AntV G6 依赖
        g6: "../../plugin/antv/g6/g6.min"
    },
    shim: {
        "system": {
            deps: ["jquery"]
        },
        "layui": {
            deps: ["jquery", "system"]
        },
        "layuicommon": {
            deps: ["jquery", "layui"]
        },
        "g6": {
            deps: ["jquery"]
        }
    },
    waitSeconds: 0
});

// 页面数据对象
var objdata = {
    agent_id: null,
    allNodeData: [],
    currentGraph: null,
    nodeRelationDataHTML: null
};

require(["jquery", "system", "layui", "g6"], function () {
    layui.use(['layer', 'form'], function () {
        var layer = layui.layer;
        var form = layui.form;

        // 获取参数
        objdata.agent_id = Arg("agent_id") || Arg("id");

        if (!objdata.agent_id) {
            layer.msg('缺少必要参数：agent_id');
            return;
        }

        // 初始化页面
        initPage();

        // 绑定工具栏按钮事件
        bindToolbarEvents();
    });

    // 初始化页面
    function initPage() {
        // 显示加载状态
        showLoading();

        // 加载节点数据并渲染图表
        loadAllNodeData().then(() => {
            hideLoading();
            if (!objdata.nodeRelationDataHTML || objdata.nodeRelationDataHTML.nodes.length === 0) {
                showEmptyState();
                return;
            }

            // 动态加载 G6 库并创建关系图
            require(['g6'], function(G6) {
                createNodeRelationGraphHTML(G6, objdata.nodeRelationDataHTML);
            });
        }).catch((error) => {
            hideLoading();
            layui.layer.msg('获取节点数据失败，请重试');
            console.error('获取节点数据失败:', error);
        });
    }

    // 绑定工具栏按钮事件
    function bindToolbarEvents() {
        var layer = layui.layer;

        // 刷新数据按钮
        $("#refreshGraphBtn").click(function() {
            const btn = $(this);
            btn.addClass('layui-btn-disabled').html('<i class="layui-icon layui-icon-loading layui-anim layui-anim-rotate layui-anim-loop"></i> 刷新中');

            loadAllNodeData().then(() => {
                if (objdata.currentGraph && !objdata.currentGraph.destroyed) {
                    const newData = prepareRelationDataHTML(objdata.allNodeData);
                    objdata.currentGraph.changeData(newData);

                    setTimeout(() => {
                        objdata.currentGraph.layout();
                        objdata.currentGraph.fitView(30);
                        btn.removeClass('layui-btn-disabled').html('<i class="layui-icon layui-icon-refresh"></i> 刷新数据');
                        layer.msg('图表已刷新');
                        updateNodeCount();
                    }, 300);
                }
            }).catch((error) => {
                btn.removeClass('layui-btn-disabled').html('<i class="layui-icon layui-icon-refresh"></i> 刷新数据');
                layer.msg('刷新失败，请重试');
                console.error('刷新失败:', error);
            });
        });

        // 适应画布按钮
        $("#fitGraphBtn").click(function() {
            if (objdata.currentGraph && !objdata.currentGraph.destroyed) {
                objdata.currentGraph.fitView(30);
                objdata.currentGraph.fitCenter();
                layer.msg('已适应画布');
            }
        });

        // 重置布局按钮
        $("#resetLayoutBtn").click(function() {
            if (objdata.currentGraph && !objdata.currentGraph.destroyed) {
                objdata.currentGraph.layout();
                setTimeout(() => {
                    objdata.currentGraph.fitView(30);
                }, 500);
                layer.msg('布局已重置');
            }
        });

        // 导出图片按钮
        $("#exportGraphBtn").click(function() {
            showExportDialog();
        });

        // 返回列表按钮
        $("#backToListBtn").click(function() {
            // 关闭当前窗口或跳转回列表页
            var index = parent.layer.getFrameIndex(window.name);
            if (index) {
                parent.layer.close(index);
            } else {
                // 如果不是在弹窗中，则跳转回列表页
                window.location.href = 'node_list.html?v=' + Arg("v") + '&mid=' + Arg("mid") + '&id=' + objdata.agent_id;
            }
        });
    }

    // 加载所有节点数据
    function loadAllNodeData() {
        return new Promise((resolve, reject) => {
            $.sm(function (re, err) {
                if (err) {
                    reject(err);
                } else {
                    objdata.allNodeData = re || [];
                    objdata.nodeRelationDataHTML = prepareRelationDataHTML(objdata.allNodeData);
                    resolve(re);
                }
            }, ["w_agent_node.selectById", $.msgwhere({"agent_id": [objdata.agent_id]})]);
        });
    }

    // HTML节点数据准备函数
    function prepareRelationDataHTML(nodeList) {
        if (!nodeList || nodeList.length === 0) {
            return { nodes: [], edges: [] };
        }

        const nodes = [];
        const edges = [];
        const nodeMap = new Map();

        // 创建节点映射
        nodeList.forEach(node => {
            nodeMap.set(node.id, node);
        });

        // 生成节点数据 - 使用HTML节点
        nodeList.forEach(node => {
            nodes.push({
                id: node.id.toString(),
                label: node.node_name || `节点${node.id}`,
                type: 'html-node',
                size: [280, 100],
                style: {
                    fill: 'transparent',
                    stroke: 'transparent'
                },
                nodeData: node
            });
        });

        // 生成边数据（基于parent_id关系）
        nodeList.forEach(node => {
            if (node.parent_id && node.parent_id !== '0' && nodeMap.has(parseInt(node.parent_id))) {
                edges.push({
                    source: node.parent_id.toString(),
                    target: node.id.toString(),
                    type: 'cubic-horizontal',
                    style: {
                        stroke: '#1890ff',
                        lineWidth: 2,
                        strokeOpacity: 0.8,
                        endArrow: {
                            path: 'M 0,0 L 8,4 L 8,-4 Z',
                            fill: '#1890ff',
                            strokeOpacity: 1
                        }
                    }
                });
            }
        });

        return { nodes, edges };
    }

    // 创建节点关系图
    function createNodeRelationGraphHTML(G6, data) {
        const container = document.getElementById('nodeGraphContainer');

        if (!container) {
            layui.layer.msg('图表容器未找到');
            return;
        }

        // 注册自定义HTML节点
        G6.registerNode('html-node', {
            draw(cfg, group) {
                const nodeData = cfg.nodeData;
                const size = cfg.size || [280, 100];
                const width = size[0];
                const height = size[1];

                // 创建外部容器
                const rect = group.addShape('rect', {
                    attrs: {
                        x: -width / 2,
                        y: -height / 2,
                        width: width,
                        height: height,
                        fill: getNodeColor(nodeData.node_type),
                        stroke: '#666',
                        strokeWidth: 1,
                        radius: 8,
                        cursor: 'pointer',
                        shadowColor: 'rgba(0,0,0,0.15)',
                        shadowBlur: 6,
                        shadowOffsetX: 2,
                        shadowOffsetY: 2
                    },
                    name: 'main-rect'
                });

                // 添加节点标题
                group.addShape('text', {
                    attrs: {
                        x: 0,
                        y: -25,
                        text: cfg.label,
                        fontSize: 14,
                        fontWeight: 'bold',
                        fill: '#fff',
                        textAlign: 'center',
                        textBaseline: 'middle',
                        cursor: 'pointer'
                    },
                    name: 'title-text'
                });

                // 添加节点类型标签
                const nodeTypeText = getNodeTypeText(nodeData.node_type);
                group.addShape('rect', {
                    attrs: {
                        x: -width/2 + 5,
                        y: -height/2 + 5,
                        width: 45,
                        height: 18,
                        fill: 'rgba(255,255,255,0.2)',
                        radius: 3,
                        cursor: 'pointer'
                    },
                    name: 'type-bg'
                });

                group.addShape('text', {
                    attrs: {
                        x: -width/2 + 27.5,
                        y: -height/2 + 14,
                        text: nodeTypeText,
                        fontSize: 10,
                        fill: '#fff',
                        textAlign: 'center',
                        textBaseline: 'middle',
                        cursor: 'pointer'
                    },
                    name: 'type-text'
                });

                // 添加状态指示器
                const statusColor = nodeData.status === 0 ? '#52c41a' : '#f5222d';
                group.addShape('circle', {
                    attrs: {
                        x: width / 2 - 15,
                        y: -height / 2 + 15,
                        r: 6,
                        fill: statusColor,
                        stroke: '#fff',
                        strokeWidth: 2,
                        cursor: 'pointer'
                    },
                    name: 'status-circle'
                });

                // 如果有描述，添加描述文本
                if (nodeData.node_dsc) {
                    const desc = nodeData.node_dsc.length > 16
                        ? nodeData.node_dsc.substring(0, 16) + '...'
                        : nodeData.node_dsc;
                    group.addShape('text', {
                        attrs: {
                            x: 0,
                            y: 5,
                            text: desc,
                            fontSize: 11,
                            fill: '#fff',
                            textAlign: 'center',
                            textBaseline: 'middle',
                            opacity: 0.9,
                            cursor: 'pointer'
                        },
                        name: 'desc-text'
                    });
                }

                // 添加子节点按钮
                const addBtnGroup = group.addGroup({
                    name: 'add-btn-group'
                });

                addBtnGroup.addShape('rect', {
                    attrs: {
                        x: -width/2 + 5,
                        y: height/2 - 25,
                        width: 60,
                        height: 20,
                        fill: 'rgba(255,255,255,0.2)',
                        stroke: '#fff',
                        strokeWidth: 1,
                        radius: 3,
                        cursor: 'pointer',
                        opacity: 0.8
                    },
                    name: 'add-btn-bg'
                });

                addBtnGroup.addShape('text', {
                    attrs: {
                        x: -width/2 + 35,
                        y: height/2 - 15,
                        text: '+ 子节点',
                        fontSize: 10,
                        fill: '#fff',
                        textAlign: 'center',
                        textBaseline: 'middle',
                        cursor: 'pointer'
                    },
                    name: 'add-btn-text'
                });

                // 查看详情按钮
                const detailBtnGroup = group.addGroup({
                    name: 'detail-btn-group'
                });

                detailBtnGroup.addShape('rect', {
                    attrs: {
                        x: width/2 - 50,
                        y: height/2 - 25,
                        width: 45,
                        height: 20,
                        fill: 'rgba(255,255,255,0.2)',
                        stroke: '#fff',
                        strokeWidth: 1,
                        radius: 3,
                        cursor: 'pointer',
                        opacity: 0.8
                    },
                    name: 'detail-btn-bg'
                });

                detailBtnGroup.addShape('text', {
                    attrs: {
                        x: width/2 - 27.5,
                        y: height/2 - 15,
                        text: '详情',
                        fontSize: 10,
                        fill: '#fff',
                        textAlign: 'center',
                        textBaseline: 'middle',
                        cursor: 'pointer'
                    },
                    name: 'detail-btn-text'
                });

                return rect;
            },

            // 更新节点
            update(cfg, item) {
                const group = item.getContainer();
                const nodeData = cfg.nodeData;

                // 更新主要形状颜色
                const rect = group.find(element => element.get('name') === 'main-rect');
                if (rect) {
                    rect.attr('fill', getNodeColor(nodeData.node_type));
                }

                // 更新标题文本
                const titleText = group.find(element => element.get('name') === 'title-text');
                if (titleText) {
                    titleText.attr('text', cfg.label);
                }

                // 更新类型文本
                const typeText = group.find(element => element.get('name') === 'type-text');
                if (typeText) {
                    typeText.attr('text', getNodeTypeText(nodeData.node_type));
                }

                // 更新状态
                const statusCircle = group.find(element => element.get('name') === 'status-circle');
                if (statusCircle) {
                    const statusColor = nodeData.status === 0 ? '#52c41a' : '#f5222d';
                    statusCircle.attr('fill', statusColor);
                }

                // 更新描述文本
                const descText = group.find(element => element.get('name') === 'desc-text');
                if (descText && nodeData.node_dsc) {
                    const desc = nodeData.node_dsc.length > 16
                        ? nodeData.node_dsc.substring(0, 16) + '...'
                        : nodeData.node_dsc;
                    descText.attr('text', desc);
                }
            }
        });

        // 创建 G6 图实例
        const graph = new G6.Graph({
            container: container,
            width: container.clientWidth,
            height: container.clientHeight,
            renderer: 'canvas',
            pixelRatio: window.devicePixelRatio || 2,
            modes: {
                default: [
                    'drag-canvas',
                    'zoom-canvas',
                    'drag-node'
                ]
            },
            defaultNode: {
                type: 'html-node',
                size: [280, 100],
                style: {
                    fill: 'transparent',
                    stroke: 'transparent'
                }
            },
            defaultEdge: {
                type: 'cubic-horizontal',
                style: {
                    stroke: '#1890ff',
                    lineWidth: 2,
                    strokeOpacity: 0.8,
                    endArrow: {
                        path: 'M 0,0 L 8,4 L 8,-4 Z',
                        fill: '#1890ff',
                        strokeOpacity: 1
                    }
                }
            },
            layout: {
                type: 'dagre',
                rankdir: 'TB',
                align: 'DL',
                nodesep: 60,
                ranksep: 100,
                controlPoints: true,
                sortByCombo: false
            },
            fitView: true,
            fitViewPadding: [40, 40, 40, 40],
            animate: true,
            animateCfg: {
                duration: 300,
                easing: 'easeLinear'
            }
        });

        // 存储图表实例
        objdata.currentGraph = graph;

        // 绑定节点点击事件
        graph.on('node:click', (e) => {
            const nodeData = e.item.getModel().nodeData;
            const shape = e.target;
            const shapeName = shape.get('name');
            const group = e.item.getContainer();

            // 点击添加子节点按钮
            if (shapeName === 'add-btn-bg' || shapeName === 'add-btn-text' ||
                (group.find(element => element.get('name') === 'add-btn-group') &&
                    group.find(element => element.get('name') === 'add-btn-group').contain(shape))) {
                e.stopPropagation();
                addChildNode(nodeData.id, nodeData.node_name);
                return;
            }

            // 点击查看详情按钮
            if (shapeName === 'detail-btn-bg' || shapeName === 'detail-btn-text' ||
                (group.find(element => element.get('name') === 'detail-btn-group') &&
                    group.find(element => element.get('name') === 'detail-btn-group').contain(shape))) {
                e.stopPropagation();
                showNodeDetail(nodeData);
                return;
            }

            // 默认显示节点详情
            showNodeDetail(nodeData);
        });

        // 节点悬停效果
        graph.on('node:mouseenter', (e) => {
            const item = e.item;
            const group = item.getContainer();
            const rect = group.find(element => element.get('name') === 'main-rect');
            if (rect) {
                rect.attr('strokeWidth', 2);
                rect.attr('stroke', '#1890ff');

                // 高亮按钮
                const addBtnGroup = group.find(element => element.get('name') === 'add-btn-group');
                const detailBtnGroup = group.find(element => element.get('name') === 'detail-btn-group');
                if (addBtnGroup) {
                    addBtnGroup.get('children').forEach(child => {
                        if (child.get('name') === 'add-btn-bg') {
                            child.attr('opacity', 1);
                            child.attr('fill', 'rgba(24, 144, 255, 0.3)');
                        }
                    });
                }
                if (detailBtnGroup) {
                    detailBtnGroup.get('children').forEach(child => {
                        if (child.get('name') === 'detail-btn-bg') {
                            child.attr('opacity', 1);
                            child.attr('fill', 'rgba(24, 144, 255, 0.3)');
                        }
                    });
                }
            }
            graph.paint();
        });

        graph.on('node:mouseleave', (e) => {
            const item = e.item;
            const group = item.getContainer();
            const rect = group.find(element => element.get('name') === 'main-rect');
            if (rect) {
                rect.attr('strokeWidth', 1);
                rect.attr('stroke', '#666');

                // 恢复按钮样式
                const addBtnGroup = group.find(element => element.get('name') === 'add-btn-group');
                const detailBtnGroup = group.find(element => element.get('name') === 'detail-btn-group');
                if (addBtnGroup) {
                    addBtnGroup.get('children').forEach(child => {
                        if (child.get('name') === 'add-btn-bg') {
                            child.attr('opacity', 0.8);
                            child.attr('fill', 'rgba(255,255,255,0.2)');
                        }
                    });
                }
                if (detailBtnGroup) {
                    detailBtnGroup.get('children').forEach(child => {
                        if (child.get('name') === 'detail-btn-bg') {
                            child.attr('opacity', 0.8);
                            child.attr('fill', 'rgba(255,255,255,0.2)');
                        }
                    });
                }
            }
            graph.paint();
        });

        // 渲染数据
        graph.data(data);
        graph.render();

        // 延迟执行自适应画布
        setTimeout(() => {
            graph.fitView(40);
            updateNodeCount();
        }, 800);

        // 窗口大小改变时重新调整
        const resizeHandler = () => {
            if (!graph || graph.destroyed) return;
            if (!container || !container.scrollWidth || !container.scrollHeight) return;
            graph.changeSize(container.scrollWidth, container.scrollHeight);
            graph.fitView(40);
        };

        window.addEventListener('resize', resizeHandler);

        // 页面卸载时清理
        $(window).on('beforeunload', function() {
            window.removeEventListener('resize', resizeHandler);
            if (graph && !graph.destroyed) {
                graph.destroy();
            }
        });
    }

    // 添加子节点函数
    function addChildNode(parentId, parentName) {
        var layer = layui.layer;

        layer.open({
            type: 2,
            title: `为节点 "${parentName}" 添加子节点`,
            shadeClose: false,
            area: ['500px', '600px'],
            content: 'node_add_edit.html?v=' + Arg("v") + '&type=addChildNode&mid=' + Arg("mid") + '&parent_id=' + parentId + '&agent_id=' + objdata.agent_id,
            success: function (layero, index) {
                // 可以在这里设置默认的父节点ID
            },
            btn: ["保存", "取消"],
            yes: function (index, layero) {
                let w = layero.find('iframe')[0].contentWindow;
                w.$("#saveOK").trigger("click", function () {
                    layer.close(index);
                    layer.msg("子节点添加成功！");

                    // 延迟刷新图表，确保数据已更新
                    setTimeout(() => {
                        loadAllNodeData().then(() => {
                            refreshCurrentGraph();
                        });
                    }, 800);
                });
            },
            no: function (index, layero) {
                layer.close(index);
            }
        });
    }

    // 显示节点详情
    function showNodeDetail(nodeData) {
        const layer = layui.layer;

        const content = `
            <div style="padding: 20px;">
                <table class="layui-table" lay-size="sm">
                    <tr><td><strong>节点ID：</strong></td><td>${nodeData.id}</td></tr>
                    <tr><td><strong>节点名称：</strong></td><td>${nodeData.node_name || '未命名'}</td></tr>
                    <tr><td><strong>节点类型：</strong></td><td>${getNodeTypeText(nodeData.node_type)}</td></tr>
                    <tr><td><strong>节点描述：</strong></td><td>${nodeData.node_dsc || '无描述'}</td></tr>
                    <tr><td><strong>父节点：</strong></td><td>${nodeData.parent_id || '无'}</td></tr>
                    <tr><td><strong>URL：</strong></td><td>${nodeData.url || '无'}</td></tr>
                    <tr><td><strong>状态：</strong></td><td>${nodeData.status === 0 ? '正常' : '停用'}</td></tr>
                    <tr><td><strong>创建时间：</strong></td><td>${nodeData.created_time || '未知'}</td></tr>
                    <tr><td><strong>更新时间：</strong></td><td>${nodeData.altime || '未知'}</td></tr>
                </table>
            </div>
        `;

        layer.open({
            type: 1,
            title: '节点详情',
            area: ['500px', '450px'],
            content: content,
            btn: ['编辑节点', '关闭'],
            yes: function(index) {
                layer.close(index);
                editNode(nodeData.id);
            }
        });
    }

    // 编辑节点
    function editNode(nodeId) {
        var layer = layui.layer;

        layer.open({
            type: 2,
            title: "编辑节点",
            shadeClose: false,
            area: ['500px', '600px'],
            content: 'node_add_edit.html?v=' + Arg("v") + '&type=update&mid=' + Arg("mid") + "&id=" + nodeId,
            success: function (layero, index) {
            },
            btn: ["保存", "取消"],
            yes: function (index, layero) {
                let w = layero.find('iframe')[0].contentWindow;
                w.$("#saveOK").trigger("click", function () {
                    layer.close(index);
                    layer.msg("编辑成功！");

                    // 编辑后重新加载所有数据并刷新图表
                    setTimeout(() => {
                        loadAllNodeData().then(() => {
                            refreshCurrentGraph();
                        });
                    }, 500);
                });
            },
            no: function (index, layero) {
                layer.close(index);
            }
        });
    }

    // 刷新当前图表的函数
    function refreshCurrentGraph() {
        if (objdata.currentGraph && !objdata.currentGraph.destroyed) {
            const newData = prepareRelationDataHTML(objdata.allNodeData);
            objdata.currentGraph.changeData(newData);

            setTimeout(() => {
                objdata.currentGraph.layout();
                objdata.currentGraph.fitView(30);
                updateNodeCount();
            }, 300);
        }
    }

    // 获取节点类型文本
    function getNodeTypeText(nodeType) {
        const typeMap = {
            '1': '开始',
            '2': '处理',
            '3': '决策',
            '4': '结束',
            '5': '其他'
        };
        return typeMap[nodeType] || '未知';
    }

    // 根据节点类型返回不同颜色
    function getNodeColor(nodeType) {
        const colors = {
            '1': '#52c41a',     // 绿色 - 开始节点
            '2': '#1890ff',     // 蓝色 - 处理节点
            '3': '#fa8c16',     // 橙色 - 决策节点
            '4': '#f5222d',     // 红色 - 结束节点
            '5': '#722ed1'      // 紫色 - 其他
        };
        return colors[nodeType] || colors['5'];
    }

    // 显示加载状态
    function showLoading() {
        const loadingHtml = `
            <div class="loading-overlay">
                <i class="layui-icon layui-icon-loading layui-anim layui-anim-rotate layui-anim-loop"></i>
                加载节点数据中...
            </div>
        `;
        $('#nodeGraphContainer').html(loadingHtml);
    }

    // 隐藏加载状态
    function hideLoading() {
        $('.loading-overlay').remove();
    }

    // 显示空状态
    function showEmptyState() {
        const emptyHtml = `
            <div style="display: flex; align-items: center; justify-content: center; height: 100%; flex-direction: column; color: #999;">
                <i class="layui-icon layui-icon-face-cry" style="font-size: 64px; margin-bottom: 20px;"></i>
                <h3>暂无节点数据</h3>
                <p>请先添加节点数据后再查看流程图</p>
            </div>
        `;
        $('#nodeGraphContainer').html(emptyHtml);
        $('#graphInfo').html('节点数量：0');
    }

    // 更新节点数量显示
    function updateNodeCount() {
        const count = objdata.allNodeData ? objdata.allNodeData.length : 0;
        $('#nodeCount').html(`节点数量：${count}`);
    }

    // 显示导出对话框
    function showExportDialog() {
        var layer = layui.layer;
        var form = layui.form;

        if (!objdata.currentGraph || objdata.currentGraph.destroyed) {
            layer.msg('图表未加载，无法导出');
            return;
        }

        const dialogContent = `
            <div style="padding: 20px;">
                <form class="layui-form" lay-filter="exportForm">
                    <div class="layui-form-item">
                        <label class="layui-form-label">导出格式</label>
                        <div class="layui-input-block">
                            <select name="format" lay-verify="required">
                                <option value="">请选择导出格式</option>
                                <option value="png" selected>PNG 图片</option>
                                <option value="jpg">JPEG 图片(推荐)</option>                       
                            </select>
                        </div>
                    </div>
                    <div class="layui-form-item">
                        <label class="layui-form-label">文件名称</label>
                        <div class="layui-input-block">
                            <input type="text" name="filename" value="节点流程图_${getCurrentTimeString()}" 
                                   placeholder="请输入文件名" class="layui-input" lay-verify="required">
                        </div>
                    </div>
                    <div class="layui-form-item">
                        <label class="layui-form-label">背景颜色</label>
                        <div class="layui-input-block">
                            <select name="backgroundColor">
                                <option value="transparent">透明背景</option>
                                <option value="#ffffff" selected>白色背景</option>
                                <option value="#FAF9DE">护眼背景</option>
                                <option value="#000000">黑色背景</option>
                            </select>
                        </div>
                    </div>
                </form>
            </div>
        `;

        const exportIndex = layer.open({
            type: 1,
            title: '导出流程图',
            area: ['400px', '450px'],
            content: dialogContent,
            btn: ['导出', '取消'],
            success: function(layero, index) {
                // 重新渲染form
                form.render('select', 'exportForm');
            },
            yes: function(index, layero) {
                // 获取表单数据
                const formData = form.val('exportForm');

                if (!formData.format) {
                    layer.msg('请选择导出格式');
                    return;
                }

                if (!formData.filename.trim()) {
                    layer.msg('请输入文件名');
                    return;
                }

                // 执行导出
                layer.close(index);
                exportGraph(formData);
            }
        });
    }

    // 导出图表
    function exportGraph(options) {
        var layer = layui.layer;

        if (!objdata.currentGraph || objdata.currentGraph.destroyed) {
            layer.msg('图表未加载，无法导出');
            return;
        }

        const { format, filename, backgroundColor = '#ffffff' } = options;

        // 显示导出进度
        const loadingIndex = layer.load(1, {
            shade: [0.3, '#000']
        });

        try {
            let exportPromise;
            switch (format) {
                case 'png':
                    exportPromise = exportToPNG( backgroundColor, filename);
                    break;
                case 'jpg':
                    exportPromise = exportToJPG(backgroundColor, filename);
                    break;
                default:
                    throw new Error('不支持的导出格式');
            }
            exportPromise.then(() => {
                layer.close(loadingIndex);
                layer.msg('导出成功！', { icon: 1 });
            }).catch((error) => {
                layer.close(loadingIndex);
                layer.msg('导出失败: ' + error.message, { icon: 2 });
                console.error('导出失败:', error);
            });

        } catch (error) {
            layer.close(loadingIndex);
            layer.msg('导出失败: ' + error.message, { icon: 2 });
            console.error('导出失败:', error);
        }
    }

    // 导出为PNG
    function exportToPNG( backgroundColor, filename) {
        return new Promise((resolve, reject) => {
            try {
                objdata.currentGraph.downloadFullImage(filename, 'image/png', {
                    backgroundColor: backgroundColor === 'transparent' ? 'transparent' : backgroundColor,
                    padding: [20, 20, 20, 20],
                    ratio: parseFloat(quality)
                });
                resolve();
            } catch (error) {
                reject(error);
            }
        });
    }

    // 导出为JPG
    function exportToJPG(backgroundColor, filename) {
        return new Promise((resolve, reject) => {
            try {
                // JPG不支持透明背景，强制使用白色背景
                const bgColor = backgroundColor === 'transparent' ? '#ffffff' : backgroundColor;
                objdata.currentGraph.downloadFullImage(filename, 'image/jpeg', {
                    backgroundColor: bgColor,
                    padding: [20, 20, 20, 20],
                });
                resolve();
            } catch (error) {
                reject(error);
            }
        });
    }

    // 获取当前时间字符串
    function getCurrentTimeString() {
        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const day = String(now.getDate()).padStart(2, '0');
        const hours = String(now.getHours()).padStart(2, '0');
        const minutes = String(now.getMinutes()).padStart(2, '0');
        const seconds = String(now.getSeconds()).padStart(2, '0');

        return `${year}${month}${day}_${hours}${minutes}${seconds}`;
    }
});
```

## 状态点击修改

之前对于layuitable所展示的状态，点击可以实现状态的修改，对于js该如何修改呢？  这是参考例子

![image-20250813153848943](04.智能体(HTML节点最终版).assets/image-20250813153848943.png)

照着葫芦画瓢，对于w_agent   和w_agent_node 两个表格的状态就可以进行如下的添加

### agent_manage.js 和 node_list.js

 form.on 方法为带有 lay-filter 属性的表单元素绑定事件。所以哪怕我们html文件中没有使用form表单组件，点击也是可以实现相应的状态修改功能的。

![image-20250813160641869](04.智能体(HTML节点最终版).assets/image-20250813160641869.png)



### agent.xml

编写相应的更新xml

```xml
<msg id="w_agent.enable" type="update" v="update w_agent set status = #1# where id = #0# ">

</msg>
```

![image-20250813160752873](04.智能体(HTML节点最终版).assets/image-20250813160752873.png)

最后实现状态点击的修改
