## é¡µé¢



åœºæ™¯ï¼šä¹‹å‰æˆ‘ä»¬å®Œæˆäº†å¹¼å„¿å›­ç®¡ç†çš„æ™ºèƒ½ä½“åˆ—è¡¨å±•ç¤ºï¼Œç„¶åé€šè¿‡ç‚¹å‡»æ™ºèƒ½ä½“è·³è½¬åˆ°æ™ºèƒ½ä½“è¯¦æƒ…é¡µï¼Œæ˜¾ç¤ºå¯¹åº”çš„æ™ºèƒ½ä½“çš„èŠ‚ç‚¹ç­‰

ä½†æ˜¯æŒ‰ç…§åŸå‹ä¸­çš„æ•ˆæœï¼Œåœ¨æ™ºèƒ½ä½“åˆ—è¡¨é¡µï¼Œåœ¨ç‚¹å‡»äº†å¯¹åº”çš„æ™ºèƒ½ä½“åï¼Œæœ¬é¡µé¢çš„å†…å®¹æ›¿æ¢ä¸ºagent_detail.htmlä¸­çš„å†…å®¹ï¼Œç‚¹å‡»é¡µé¢ä¸­çš„è¿”å›å¯ä»¥å®ç°è¿”å›åˆ°åŸå§‹çš„åˆ—è¡¨é¡µé¢ï¼Œè¿™æ‰æ˜¯ç†æƒ³æƒ³è¿‡ï¼Œè¿™æ ·ä¸€æ¥å°±éœ€è¦å»é™¤è·¯ç”±äº†

### æ•ˆæœ

ç‚¹å‡»æ™ºèƒ½ä½“ååŠ¨æ€åŠ è½½äº†å¯¹åº”çš„è¯¦æƒ…é¡µé¢

![image-20250908103727508](07.é¡µé¢è·³è½¬åŠèŠ‚ç‚¹ç‚¹å‡»å†å²è®°å½•.assets/image-20250908103727508.png)

### bugä¿®å¤

#### é¡µé¢æ¸²æŸ“æ™ºèƒ½ä½“åˆ—è¡¨çš„æ—¶å€™ï¼Œå•åˆ—è¡¨çš„å æ¯”æœ‰é—®é¢˜

é¼ æ ‡ç§»åŠ¨åˆ°æŸä¸ªæ™ºèƒ½ä½“ï¼Œä¸‹ä¸€ä¸ªæ™ºèƒ½ä½“ä¼šè¢«æŒ¤åˆ°åˆ«çš„åœ°æ–¹å»ï¼š
![image-20250908093720253](07.é¡µé¢è·³è½¬åŠèŠ‚ç‚¹ç‚¹å‡»å†å²è®°å½•.assets/image-20250908093720253.png)
reason:
è¿™ä¸ªé—®é¢˜æ˜¯ç”±äºæ‚¬æµ®æ—¶çš„ `transform: translateY(-8px)` ä¼šæ”¹å˜å…ƒç´ çš„ä½ç½®ï¼Œå½±å“åˆ°å…¶ä»–å…ƒç´ çš„å¸ƒå±€ã€‚è§£å†³æ–¹æ¡ˆæ˜¯ä½¿ç”¨ç»å¯¹å®šä½æˆ–è€…å‡å°‘ä½ç§»é‡ï¼š

#### ç‚¹å‡»è¿”å›æŒ‰é’®æ²¡æœ‰è¿”å›å’ŒåŠ¨æ€çš„åŠ è½½ç›¸åº”çš„æ™ºèƒ½ä½“åˆ—è¡¨é¡µ

ä¸Šé¢æˆ‘ä»¬è™½ç„¶åŠ¨æ€çš„å®ç°äº†ç‚¹å‡»æ™ºèƒ½ä½“åŠ è½½è¯¦æƒ…ï¼Œä½†æ˜¯ç‚¹å‡»è¿”å›æŒ‰é’®æ˜¯æ²¡æœ‰æ•ˆæœçš„,ä¿®æ”¹å…¶ä¸­çš„æ–¹æ³•







### ä»£ç 

#### agent_list.js

```js
/*
* ä½œè€…: é¾šå–œ
* å¹¼å„¿å›­ç®¡ç†ç«¯çš„è·³è½¬é¡µé¢
* æ™ºèƒ½ä½“åˆ—è¡¨é¡µ
* åˆ›å»ºæ—¶é—´: 2025-09-03
* é‡æ„: 2025-09-08 ç®€åŒ–é¡µé¢è·³è½¬é€»è¾‘
* */

require.config({
    paths: {
        jquery: '../../sys/jquery',
        system: '../../sys/system',
        layui: "../../layui-btkj/layui",
        layuicommon: "../../sys/layuicommon",
    },
    shim: {
        "system": {
            deps: ["jquery"]
        },
        "layui": {
            deps: ["jquery", "system"]
        },
        "layuicommon": {
            deps: ["jquery", "layui"]
        }
    },
    waitSeconds: 0
});

objdata = {
    // é€‚ç”¨ç«¯
    applicable: {
        applicable_end: ['å®¶é•¿ç«¯'],
        applicable_role: ['å®¶é•¿'],
    },

    // æ™ºèƒ½ä½“æœç´¢
    agent_name: 'æµ‹è¯•',

    // æ™ºèƒ½ä½“åˆ—è¡¨æ•°æ®
    agentListData: []
};

require(["jquery", "system", "layui"], function () {
    layui.use(['table', 'form', 'layer'], function () {
        initList();
    });

    /**
     * åˆå§‹åŒ–æ™ºèƒ½ä½“åˆ—è¡¨
     */
    function initList() {
        let data = objdata.applicable;

        $.sm(function (re, err) {
            if (err) {
                layer.msg(err);
                renderEmptyState('åŠ è½½å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
            } else {
                objdata.agentListData = re || [];
                renderAgentList(objdata.agentListData);
            }
        }, ["w_agent_plugin.getList", $.msgwhere(data)]);
    }

    /**
     * æ¸²æŸ“æ™ºèƒ½ä½“åˆ—è¡¨
     */
    function renderAgentList(listData) {
        const container = $('#agentContainer');

        // å¦‚æœæ•°æ®ä¸ºç©ºï¼Œæ˜¾ç¤ºæš‚æ— æ•°æ®
        if (!listData || listData.length === 0) {
            renderEmptyState('æš‚æ— æ™ºèƒ½ä½“æ•°æ®', 'æš‚æ—¶è¿˜æ²¡æœ‰å¯ç”¨çš„æ™ºèƒ½ä½“ï¼Œè¯·ç¨åå†è¯•');
            return;
        }

        let html = '';

        listData.forEach(function(item) {
            const timeGranularity = item.time_granularity || 'æ—¥';
            const agentName = item.agent_name || 'æ™ºèƒ½ä½“åç§°';
            const bgClass = getBackgroundClass(timeGranularity);
            const contentHtml = generateContentHtml(item);

            html += `
                <div class="layui-col-xs12 layui-col-sm6 layui-col-md4 layui-col-lg3">
                    <div class="agent-list" data-id="${item.id}" data-time-granularity="${timeGranularity}">
                        <div class="agent_bg ${bgClass}">${timeGranularity}</div>
                        <div class="agent-listdiv">
                            ${contentHtml}
                        </div>
                        <div class="agent-btn">
                            ${agentName}
                        </div>
                    </div>
                </div>
            `;
        });

        container.html(html);

        // ç»‘å®šç‚¹å‡»äº‹ä»¶
        bindEvents();
    }

    /**
     * æ¸²æŸ“ç©ºçŠ¶æ€
     */
    function renderEmptyState(title, description) {
        const container = $('#agentContainer');
        const emptyHtml = `
            <div class="layui-col-xs12">
                <div class="empty-state">
                    <div class="empty-icon">ğŸ“‹</div>
                    <div class="empty-text">${title}</div>
                    <div class="empty-desc">${description || ''}</div>
                    <div class="empty-actions">
                        <button class="layui-btn layui-btn-primary" onclick="refreshList()">
                            <i class="layui-icon layui-icon-refresh"></i> åˆ·æ–°
                        </button>
                    </div>
                </div>
            </div>
        `;
        container.html(emptyHtml);
    }

    /**
     * æ ¹æ®æ—¶é—´ç²’åº¦è·å–èƒŒæ™¯æ ·å¼ç±»
     */
    function getBackgroundClass(timeGranularity) {
        switch(timeGranularity) {
            case 'æ—¥':
                return 'daybg';
            case 'æœˆ':
                return 'mouthbg';
            case 'å¹´':
                return 'yearbg';
            default:
                return 'daybg';
        }
    }

    /**
     * ç”Ÿæˆå†…å®¹HTML
     */
    function generateContentHtml(item) {
        // å¦‚æœpldä¸º0ï¼Œæ˜¾ç¤ºlogoå›¾ç‰‡
        if (item.pld === 0) {
            if (item.logo) {
                const logoUrl = ossPrefix + item.logo;
                return `<img src="${logoUrl}" alt="${item.agent_name}" onerror="this.src='../../images/agentimg/agentimg.jpg'">`;
            } else {
                return `<img src="../../images/agentimg/agentimg.jpg" alt="é»˜è®¤å›¾ç‰‡">`;
            }
        } else {
            // pldä¸ä¸º0æ—¶ï¼Œæ˜¾ç¤ºcontentå†…å®¹
            return generateContentDisplay(item.content, item.plugin_type);
        }
    }

    /**
     * ç”Ÿæˆcontentå†…å®¹æ˜¾ç¤º
     */
    function generateContentDisplay(content, pluginType) {
        if (!content) {
            return `<img src="../../images/agentimg/agentimg.jpg" alt="é»˜è®¤å›¾ç‰‡">`;
        }

        // åˆ¤æ–­æ˜¯å¦ä¸ºé“¾æ¥
        if (isUrl(content)) {
            return `
                <div class="content-display">
                    <a href="${content}" target="_blank" rel="noopener">
                        <img src="${content}" alt="é“¾æ¥å›¾ç‰‡" onerror="this.style.display='none'; this.parentNode.innerHTML='<span>é“¾æ¥å†…å®¹</span>'">
                    </a>
                </div>
            `;
        }

        // åˆ¤æ–­æ˜¯å¦ä¸ºä»£ç å—
        if (pluginType === 'code' || isCodeContent(content)) {
            const displayText = content.length > 50 ? content.substring(0, 50) + '...' : content;
            return `
                <div class="content-display code-display">
                    <pre><code>${escapeHtml(displayText)}</code></pre>
                </div>
            `;
        }

        // æ™®é€šæ–‡æœ¬å†…å®¹
        const displayText = content.length > 60 ? content.substring(0, 60) + '...' : content;
        return `
            <div class="content-display text-display">
                <span>${escapeHtml(displayText)}</span>
            </div>
        `;
    }

    /**
     * åˆ¤æ–­æ˜¯å¦ä¸ºURL
     */
    function isUrl(str) {
        try {
            new URL(str);
            return true;
        } catch {
            return /^https?:\/\/.+/.test(str);
        }
    }

    /**
     * åˆ¤æ–­æ˜¯å¦ä¸ºä»£ç å†…å®¹
     */
    function isCodeContent(content) {
        const codePatterns = [
            /function\s*\(/,
            /\{[\s\S]*\}/,
            /class\s+\w+/,
            /import\s+.*from/,
            /console\./,
            /document\./,
            /var\s+\w+\s*=/,
            /let\s+\w+\s*=/,
            /const\s+\w+\s*=/
        ];

        return codePatterns.some(pattern => pattern.test(content));
    }

    /**
     * HTMLè½¬ä¹‰
     */
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    /**
     * ç»‘å®šäº‹ä»¶
     */
    function bindEvents() {
        // æ™ºèƒ½ä½“ç‚¹å‡»äº‹ä»¶ - ç›´æ¥è·³è½¬åˆ°è¯¦æƒ…é¡µ
        $('.agent-list').off('click').on('click', function() {
            const agentId = $(this).data('id');
            const agentData = objdata.agentListData.find(item => item.id === agentId);

            if (agentData) {
                handleAgentClick(agentData);
            } else {
                layer.msg('æ™ºèƒ½ä½“æ•°æ®ä¸å­˜åœ¨');
            }
        });

        // æ‚¬æµ®æ•ˆæœ
        $('.agent-list').off('mouseenter mouseleave')
            .on('mouseenter', function() {
                $(this).addClass('agent-hover');
            })
            .on('mouseleave', function() {
                $(this).removeClass('agent-hover');
            });
    }

    /**
     * å¤„ç†æ™ºèƒ½ä½“ç‚¹å‡»äº‹ä»¶ - è·³è½¬åˆ°è¯¦æƒ…é¡µ
     */
    function handleAgentClick(agentData) {

        // æ˜¾ç¤ºåŠ è½½åŠ¨ç”»
        const loadingIndex = layui.layer.load(2, {
            shade: [0.3, '#ffffff'],
            content: 'æ­£åœ¨åŠ è½½...'
        });

        // å»¶è¿Ÿè·³è½¬ï¼Œè®©ç”¨æˆ·çœ‹åˆ°åé¦ˆ
        setTimeout(function() {
            layui.layer.close(loadingIndex);

            // è·³è½¬åˆ°è¯¦æƒ…é¡µï¼Œä¼ é€’agent_idå‚æ•°
            window.location.href = `agent_detail.html?agent_id=${agentData.id}`;
        }, 500);
    }

    /**
     * åˆ·æ–°åˆ—è¡¨
     */
    window.refreshList = function() {
        const loadingIndex = layui.layer.load(1, {shade: [0.2, '#000']});

        // å»¶è¿Ÿä¸€ä¸‹å†åˆ·æ–°ï¼Œç»™ç”¨æˆ·åé¦ˆ
        setTimeout(function() {
            layui.layer.close(loadingIndex);
            initList();
        }, 500);
    };

    // æš´éœ²å…¨å±€ç®¡ç†å¯¹è±¡
    window.agentListManager = {
        refreshList: function() {
            refreshList();
        },
        getListData: function() {
            return objdata.agentListData;
        },
        renderList: renderAgentList,
        reload: function() {
            window.location.reload();
        }
    };
});
```

#### agent_detail.js

```js
/*
* ä½œè€…: é¾šå–œ
* å¹¼å„¿å›­ç®¡ç†ç«¯WEB çš„æ™ºèƒ½ä½“è¯¦æƒ…é¡µ
* åˆ›å»ºæ—¶é—´: 2025-09-03
* é‡æ„: 2025-09-08 ç®€åŒ–é¡µé¢è·³è½¬é€»è¾‘
* */

require.config({
    paths: {
        jquery: '../../sys/jquery',
        system: '../../sys/system',
        layui: "../../layui-btkj/layui",
        layuicommon: "../../sys/layuicommon",
    },
    shim: {
        "system": {
            deps: ["jquery"]
        },
        "layui": {
            deps: ["jquery", "system"]
        },
        "layuicommon": {
            deps: ["jquery", "layui"]
        }
    },
    waitSeconds: 0
});

objdata = {
    // é€‚ç”¨ç«¯
    applicable: {
        applicable_end: ['å¹¼å„¿å›­ç®¡ç†WEB'],
        applicable_role: ['ç³»ç»Ÿç®¡ç†å‘˜']
    },

    // æ™ºèƒ½ä½“æœç´¢
    agent_name: 'æµ‹è¯•',

    // URLä¼ é€’çš„agent_id
    agent_id: null,

    // å½“å‰é€‰ä¸­çš„æ™ºèƒ½ä½“
    currentAgent: null,

    // å·¦ä¾§é¢æ¿çŠ¶æ€
    leftPanelCollapsed: false,

    // å†å²è®°å½•å±•å¼€çŠ¶æ€
    historyExpanded: false,

    // å½“å‰é€‰æ‹©çš„æ—¶é—´
    currentDate: new Date(),

    // layuiç»„ä»¶å®ä¾‹
    laydate: null,

    // æ™ºèƒ½ä½“åˆ—è¡¨æ•°æ®
    agentListData: []
};

require(["jquery", "system", "layui"], function () {
    layui.use(['table', 'form', 'layer', 'laydate'], function () {
        // ä¿å­˜laydateå®ä¾‹
        objdata.laydate = layui.laydate;

        // åˆå§‹åŒ–é¡µé¢
        initPage();
    });

    /**
     * åˆå§‹åŒ–é¡µé¢
     */
    function initPage() {
        // è·å–URLå‚æ•°ä¸­çš„agent_id
        objdata.agent_id = Arg('agent_id');

        if (!objdata.agent_id) {
            layer.msg('ç¼ºå°‘æ™ºèƒ½ä½“å‚æ•°ï¼Œå³å°†è¿”å›åˆ—è¡¨é¡µ', {time: 2000});
            setTimeout(function() {
                goBackToList();
            }, 2000);
            return;
        }

        // åˆå§‹åŒ–æ™ºèƒ½ä½“åˆ—è¡¨å’Œè¯¦æƒ…
        initAgentList();

        // åˆå§‹åŒ–äº‹ä»¶ç›‘å¬å™¨
        initEventListeners();

        // åˆå§‹åŒ–å†å²è®°å½•åŠŸèƒ½
        initNodeHistory();
    }

    /**
     * åˆå§‹åŒ–æ™ºèƒ½ä½“åˆ—è¡¨
     */
    function initAgentList() {
        let data = objdata.applicable;

        $.sm(function (re, err) {
            if (err) {
                layer.msg('è·å–æ™ºèƒ½ä½“æ•°æ®å¤±è´¥: ' + err);
                renderAgentListError();
            } else {
                objdata.agentListData = re || [];

                // æ¸²æŸ“å·¦ä¾§æ™ºèƒ½ä½“åˆ—è¡¨
                renderAgentList(objdata.agentListData);

                // è‡ªåŠ¨é€‰ä¸­æŒ‡å®šçš„æ™ºèƒ½ä½“
                if (objdata.agent_id) {
                    autoSelectAgent(objdata.agent_id);
                }
            }
        }, ["w_agent_plugin.getList", $.msgwhere(data)]);
    }

    /**
     * æ¸²æŸ“æ™ºèƒ½ä½“åˆ—è¡¨
     */
    function renderAgentList(agentListData) {
        const container = $('#agentListContainer');
        container.empty();

        if (!agentListData || agentListData.length === 0) {
            container.append('<div class="no-agents">æš‚æ— æ™ºèƒ½ä½“æ•°æ®</div>');
            return;
        }

        agentListData.forEach((item, index) => {
            const timeGranularity = item.time_granularity || 'æ—¥';
            const agentName = item.agent_name || 'æ™ºèƒ½ä½“åç§°';
            const bgClass = getBackgroundClass(timeGranularity);
            const contentHtml = generateContentHtml(item);

            const agentHtml = `
                <div class="agent-list widdiv" data-agent-id="${item.id}" data-index="${index}">
                    <div class="agent_bg ${bgClass}">${timeGranularity}</div>
                    <div class="agent-listdiv">${contentHtml}</div> 
                    <div class="agent-btn">${agentName}</div>
                </div>
            `;

            container.append(agentHtml);
        });

        // ç»‘å®šæ™ºèƒ½ä½“ç‚¹å‡»äº‹ä»¶
        bindAgentClickEvents();
    }

    /**
     * æ¸²æŸ“æ™ºèƒ½ä½“åˆ—è¡¨é”™è¯¯çŠ¶æ€
     */
    function renderAgentListError() {
        const container = $('#agentListContainer');
        const errorHtml = `
            <div class="error-state">
                <div class="error-icon">âŒ</div>
                <div class="error-text">åŠ è½½å¤±è´¥</div>
                <div class="error-actions">
                    <button class="layui-btn layui-btn-sm" onclick="initAgentList()">é‡è¯•</button>
                    <button class="layui-btn layui-btn-primary layui-btn-sm" onclick="goBackToList()">è¿”å›åˆ—è¡¨</button>
                </div>
            </div>
        `;
        container.html(errorHtml);
    }

    /**
     * ç»‘å®šæ™ºèƒ½ä½“ç‚¹å‡»äº‹ä»¶
     */
    function bindAgentClickEvents() {
        $('.agent-list').off('click').on('click', function() {
            const agentIndex = $(this).data('index');
            const agentData = objdata.agentListData[agentIndex];

            if (agentData) {
                selectAgent(agentData, $(this));

                // æ›´æ–°URLå‚æ•°ï¼Œä½†ä¸åˆ·æ–°é¡µé¢
                updateUrlParameter('agent_id', agentData.id);
            }
        });
    }

    /**
     * è‡ªåŠ¨é€‰ä¸­æŒ‡å®šIDçš„æ™ºèƒ½ä½“
     */
    function autoSelectAgent(agentId) {
        // æŸ¥æ‰¾å¯¹åº”çš„æ™ºèƒ½ä½“æ•°æ®
        const targetAgent = objdata.agentListData.find(agent => agent.id == agentId);

        if (targetAgent) {
            // æŸ¥æ‰¾å¯¹åº”çš„DOMå…ƒç´ 
            const targetElement = $(`.agent-list[data-agent-id="${agentId}"]`);

            if (targetElement.length > 0) {
                // è‡ªåŠ¨é€‰ä¸­è¯¥æ™ºèƒ½ä½“
                selectAgent(targetAgent, targetElement);

                // æ»šåŠ¨åˆ°é€‰ä¸­çš„æ™ºèƒ½ä½“ä½ç½®
                setTimeout(function() {
                    targetElement[0].scrollIntoView({
                        behavior: 'smooth',
                        block: 'center'
                    });
                }, 300);
            } else {
                layer.msg(`æœªæ‰¾åˆ°æŒ‡å®šçš„æ™ºèƒ½ä½“ (ID: ${agentId})`);
            }
        } else {
            layer.msg(`æœªæ‰¾åˆ°æŒ‡å®šçš„æ™ºèƒ½ä½“ (ID: ${agentId})`);
        }
    }

    /**
     * é€‰æ‹©æ™ºèƒ½ä½“
     */
    function selectAgent(agent, element) {
        // æ›´æ–°é€‰ä¸­çŠ¶æ€
        $('.agent-list').removeClass('active');
        element.addClass('active');

        // ä¿å­˜å½“å‰é€‰ä¸­çš„æ™ºèƒ½ä½“
        objdata.currentAgent = agent;
        objdata.agent_id = agent.id;

        // æ¸²æŸ“å³ä¾§å†…å®¹
        renderAgentContent(agent);
    }

    /**
     * æ¸²æŸ“æ™ºèƒ½ä½“å†…å®¹
     */
    function renderAgentContent(agent) {
        const header = $('#detailHeader');
        const contentArea = $('#contentArea');
        const placeholder = $('#contentPlaceholder');

        // éšè—å ä½ç¬¦
        placeholder.hide();

        // æ¸…é™¤ä¹‹å‰çš„å†…å®¹
        $('.header-content').remove();
        $('.node-content').remove();

        // æ˜¾ç¤ºå¤´éƒ¨
        const headerHtml = generateHeaderHtml(agent);
        header.append(headerHtml);

        // åˆå§‹åŒ–æ—¶é—´é€‰æ‹©å™¨
        initTimeSelector(agent);

        // åŠ è½½èŠ‚ç‚¹å›¾è¡¨
        const nodeGraphHtml = `
            <div class="node-content">           
                <iframe 
                    id="nodeGraphFrame" 
                    src="../../html/agent-web/node_graph_web.html?agent_id=${agent.id}" 
                    frameborder="0" 
                    style="width: 100%; height: 810px; border: none; border-radius: 8px;">
                </iframe>       
            </div>
        `;

        contentArea.append(nodeGraphHtml);
    }

    /**
     * ç”Ÿæˆå¤´éƒ¨HTML
     */
    function generateHeaderHtml(agent) {
        const timeDisplay = getTimeDisplay(agent.time_granularity);

        return `
            <div class="header-content">
                <div class="header-left">
                    <i class="layui-icon layui-icon-left" style="font-size: 20px; color: #1E9FFF; cursor: pointer" onclick="goBackToList()"></i> 
                    <div class="agent_name">${agent.agent_name}</div>
                </div>
                <div class="header-right" id="timeSelector">
                    <div class="header-right-time" id="timeContent">
                        ${timeDisplay}
                    </div>
                    <i class="layui-icon layui-icon-date" style="font-size: 20px; color: #1E9FFF; margin-left: 5px;"></i> 
                </div>
            </div>
        `;
    }

    /**
     * æ ¹æ®æ—¶é—´ç»´åº¦è·å–å½“å‰æ—¶é—´æ˜¾ç¤º
     */
    function getTimeDisplay(timeGranularity) {
        const now = objdata.currentDate;

        switch(timeGranularity) {
            case 'æ—¥':
                return formatDate(now, 'yyyy-MM-dd');
            case 'æœˆ':
                return formatDate(now, 'yyyy-MM');
            case 'å¹´':
                return formatDate(now, 'yyyy');
            default:
                return formatDate(now, 'yyyy-MM-dd');
        }
    }

    /**
     * åˆå§‹åŒ–æ—¶é—´é€‰æ‹©å™¨
     */
    function initTimeSelector(agent) {
        const timeGranularity = agent.time_granularity || 'æ—¥';

        // ç§»é™¤ä¹‹å‰çš„ç‚¹å‡»äº‹ä»¶
        $('#timeSelector').off('click');

        // é…ç½®laydateå‚æ•°
        let dateConfig = {
            elem: '#timeSelector',
            trigger: 'click',
            value: getTimeDisplay(timeGranularity),
            show: false,
            done: function(value) {
                objdata.currentDate = new Date(value);
                $('#timeContent').text(value);

                // é‡æ–°åŠ è½½èŠ‚ç‚¹å›¾è¡¨æ•°æ®
                reloadNodeGraph(agent.id, value, timeGranularity);
            }
        };

        // æ ¹æ®æ—¶é—´ç»´åº¦é…ç½®ä¸åŒçš„é€‰æ‹©å™¨
        switch(timeGranularity) {
            case 'æ—¥':
                dateConfig.type = 'date';
                dateConfig.format = 'yyyy-MM-dd';
                break;
            case 'æœˆ':
                dateConfig.type = 'month';
                dateConfig.format = 'yyyy-MM';
                break;
            case 'å¹´':
                dateConfig.type = 'year';
                dateConfig.format = 'yyyy';
                break;
            default:
                dateConfig.type = 'date';
                dateConfig.format = 'yyyy-MM-dd';
        }

        // æ¸²æŸ“laydate
        const laydateInstance = objdata.laydate.render(dateConfig);
        $('#timeSelector').data('laydate-instance', laydateInstance);
    }

    /**
     * é‡æ–°åŠ è½½èŠ‚ç‚¹å›¾è¡¨
     */
    function reloadNodeGraph(agentId, selectedTime, timeGranularity) {
        const iframe = $('#nodeGraphFrame');
        if (iframe.length > 0) {
            const newSrc = `../../html/agent-web/node_graph_web.html?agent_id=${agentId}&selected_time=${encodeURIComponent(selectedTime)}&time_granularity=${encodeURIComponent(timeGranularity)}`;
            iframe.attr('src', newSrc);
        }
    }

    /**
     * è¿”å›åˆ—è¡¨é¡µ
     */
    window.goBackToList = function() {
        // æ˜¾ç¤ºåŠ è½½åŠ¨ç”»
        const loadingIndex = layui.layer.load(1, {
            shade: [0.3, '#ffffff'],
            content: 'åŠ è½½ä¸­...'
        });

        // å»¶è¿Ÿè·³è½¬ï¼Œç»™ç”¨æˆ·åé¦ˆ
        setTimeout(function() {
            layui.layer.close(loadingIndex);
            window.location.href = 'agent_list.html';
        }, 300);
    };

    /**
     * æ›´æ–°URLå‚æ•°
     */
    function updateUrlParameter(key, value) {
        try {
            const url = new URL(window.location);
            url.searchParams.set(key, value);
            window.history.replaceState({}, document.title, url.toString());
        } catch (error) {
            console.error('æ›´æ–°URLå‚æ•°å¤±è´¥:', error);
        }
    }

    /**
     * æ ¼å¼åŒ–æ—¥æœŸ
     */
    function formatDate(date, format) {
        if (!date) return '';

        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');

        return format
            .replace('yyyy', year)
            .replace('MM', month)
            .replace('dd', day);
    }

    /**
     * æ ¹æ®æ—¶é—´ç²’åº¦è·å–èƒŒæ™¯æ ·å¼ç±»
     */
    function getBackgroundClass(timeGranularity) {
        switch(timeGranularity) {
            case 'æ—¥':
                return 'daybg';
            case 'æœˆ':
                return 'mouthbg';
            case 'å¹´':
                return 'yearbg';
            default:
                return 'daybg';
        }
    }

    /**
     * ç”Ÿæˆå†…å®¹HTML
     */
    function generateContentHtml(item) {
        var isPluginLogo = item.logo && item.logo.toString().match(/^\d+$/);

        if (!isPluginLogo && item.logo !== 0) {
            if (item.logo) {
                const logoUrl = ossPrefix + item.logo;
                return `<img src="${logoUrl}" alt="${item.agent_name}" onerror="this.src='../../images/agentimg/agentimg.jpg'">`;
            } else {
                return `<img src="../../images/agentimg/agentimg.jpg" alt="é»˜è®¤å›¾ç‰‡">`;
            }
        } else if (item.logo === 0) {
            return `<img src="../../images/agentimg/agentimg.jpg" alt="é»˜è®¤å›¾ç‰‡">`;
        } else {
            return generatePluginContentDisplay(item);
        }
    }

    /**
     * æ ¹æ®plugin_typeç”Ÿæˆä¸åŒçš„å†…å®¹æ˜¾ç¤º
     */
    function generatePluginContentDisplay(item) {
        switch (item.plugin_type) {
            case 'superlink':
                return generateSuperlinkDisplay(item);
            case 'http':
                return generateHttpDisplay(item);
            case 'code':
                return generateCodeDisplay(item);
            case 'function':
                return generateFunctionDisplay(item);
            default:
                return generateDefaultDisplay(item);
        }
    }

    function generateSuperlinkDisplay(item) {
        const linkText = item.url || item.content || 'è¶…é“¾æ¥';
        const displayText = linkText.length > 15 ? linkText.substring(0, 15) + '...' : linkText;

        return `
            <div class="content-display superlink-display">
                <div class="plugin-icon" style="background: #e6f7ff; color: #1890ff; border: 1px solid #1890ff;">ğŸ”—</div>
                <div class="plugin-text" style="color: #1890ff;">${escapeHtml(displayText)}</div>
            </div>
        `;
    }

    function generateHttpDisplay(item) {
        const method = item.http_method || 'GET';
        const apiUrl = item.api_url || item.content || 'HTTPè¯·æ±‚';
        const displayText = apiUrl.length > 12 ? apiUrl.substring(0, 12) + '...' : apiUrl;

        return `
            <div class="content-display http-display">
                <div class="plugin-icon" style="background: #fff7e6; color: #fa8c16; border: 1px solid #fa8c16;">ğŸŒ</div>
                <div class="plugin-method" style="color: #fa8c16; font-weight: bold; font-size: 11px;">${method}</div>
                <div class="plugin-text" style="color: #666; font-size: 10px;">${escapeHtml(displayText)}</div>
            </div>
        `;
    }

    function generateCodeDisplay(item) {
        const language = item.code_language || item.language || 'Code';
        const codeText = item.content || 'ä»£ç æ‰§è¡Œ';
        const displayText = codeText.length > 10 ? codeText.substring(0, 10) + '...' : codeText;

        return `
            <div class="content-display code-display">
                <div class="plugin-icon" style="background: #f6ffed; color: #52c41a; border: 1px solid #52c41a; font-family: monospace;">&lt;/&gt;</div>
                <div class="plugin-method" style="color: #52c41a; font-weight: bold; font-size: 10px;">${language.toUpperCase()}</div>
                <div class="plugin-text" style="color: #666; font-size: 9px; font-family: monospace;">${escapeHtml(displayText)}</div>
            </div>
        `;
    }

    function generateFunctionDisplay(item) {
        const funcName = item.function_name || item.func_name || 'Function';
        const funcDesc = item.content || item.description || 'å‡½æ•°è°ƒç”¨';
        const displayText = funcDesc.length > 10 ? funcDesc.substring(0, 10) + '...' : funcDesc;

        return `
            <div class="content-display function-display">
                <div class="plugin-icon" style="background: #f9f0ff; color: #722ed1; border: 1px solid #722ed1; font-family: serif;">Æ’</div>
                <div class="plugin-method" style="color: #722ed1; font-weight: bold; font-size: 10px;">${escapeHtml(funcName)}</div>
                <div class="plugin-text" style="color: #666; font-size: 9px;">${escapeHtml(displayText)}</div>
            </div>
        `;
    }

    function generateDefaultDisplay(item) {
        const content = item.content || 'æ— å†…å®¹';
        const displayText = content.length > 30 ? content.substring(0, 30) + '...' : content;

        return `
            <div class="content-display">
                <span>${escapeHtml(displayText)}</span>
            </div>
        `;
    }

    /**
     * HTMLè½¬ä¹‰
     */
    function escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    /**
     * åˆå§‹åŒ–å†å²è®°å½•åŠŸèƒ½
     */
    function initNodeHistory() {
        console.log('å†å²è®°å½•åŠŸèƒ½å¾…å¼€å‘');
    }

    /**
     * åˆå§‹åŒ–äº‹ä»¶ç›‘å¬å™¨
     */
    function initEventListeners() {
        // å†å²è®°å½•å±•å¼€/æ”¶èµ·
        $('#expandBtn').off('click').on('click', function() {
            const btn = $(this);
            const content = $('#historyContent');

            objdata.historyExpanded = !objdata.historyExpanded;

            if (objdata.historyExpanded) {
                content.addClass('show');
                btn.addClass('expanded');
                btn.html('æ”¶èµ· <img src="../../images/agentimg/downimg.png">');
            } else {
                content.removeClass('show');
                btn.removeClass('expanded');
                btn.html('å±•å¼€ <img src="../../images/agentimg/downimg.png">');
            }
        });

        // å·¦ä¾§é¢æ¿æ”¶ç¼©/å±•å¼€
        $('#collapseBtn').off('click').on('click', function() {
            const leftPanel = $('#leftPanel');

            objdata.leftPanelCollapsed = !objdata.leftPanelCollapsed;

            if (objdata.leftPanelCollapsed) {
                leftPanel.addClass('collapsed');
            } else {
                leftPanel.removeClass('collapsed');
            }
        });

        // çª—å£å¤§å°æ”¹å˜æ—¶é‡æ–°è®¡ç®—å¸ƒå±€
        $(window).off('resize.agentDetail').on('resize.agentDetail', function() {
            if ($(window).width() <= 768) {
                $('#leftPanel').removeClass('collapsed');
                objdata.leftPanelCollapsed = false;
            }
        });
    }

    // æš´éœ²å…¨å±€ç®¡ç†å¯¹è±¡
    window.agentDetailManager = {
        getCurrentAgent: function() {
            return objdata.currentAgent;
        },
        getAgentId: function() {
            return objdata.agent_id;
        },
        refreshAgent: function() {
            if (objdata.agent_id) {
                window.location.reload();
            }
        },
        goBack: goBackToList
    };
});
```

### æœ€åçš„æ•ˆæœ

![image-20250908131048230](07.é¡µé¢è·³è½¬åŠèŠ‚ç‚¹ç‚¹å‡»å†å²è®°å½•.assets/image-20250908131048230.png)

è¿›å…¥åï¼š

![image-20250908131104138](07.é¡µé¢è·³è½¬åŠèŠ‚ç‚¹ç‚¹å‡»å†å²è®°å½•.assets/image-20250908131104138.png)

ç‚¹å‡»è¿”å›:

![image-20250908131145846](07.é¡µé¢è·³è½¬åŠèŠ‚ç‚¹ç‚¹å‡»å†å²è®°å½•.assets/image-20250908131145846.png)

## èŠ‚ç‚¹ç‚¹å‡»çš„å†å²è®°å½•

![image-20250908131708439](07.é¡µé¢è·³è½¬åŠèŠ‚ç‚¹ç‚¹å‡»å†å²è®°å½•.assets/image-20250908131708439.png)

å­˜å‚¨ç”¨æˆ·ç‚¹å‡»è¿‡é‚£äº›èŠ‚ç‚¹ï¼Œéœ€è¦å­˜å‚¨çš„å°±æ˜¯   **æ™ºèƒ½ä½“çš„id   èŠ‚ç‚¹id   ç”¨æˆ·id  ç‚¹å‡»æ—¶é—´**

### é‡åˆ°çš„ç–‘é—®

ç”¨æˆ·id  é—®é£å“¥ä¹‹åobjdataä¸­æ‹¿åˆ°ï¼Œä½†æ˜¯è¿™ä¸ªç«¯çš„è²Œä¼¼æ‹¿ä¸åˆ°

é€šè¿‡è¯¢é—®ææ€»ä¹‹å  åœ¨æ¶ˆæ¯ä¸­ä½¿ç”¨  {uid}  ä¼šè‡ªåŠ¨æ›¿æ¢ç”¨æˆ·çš„id

![image-20250908170247649](07.é¡µé¢è·³è½¬åŠèŠ‚ç‚¹ç‚¹å‡»å†å²è®°å½•.assets/image-20250908170247649.png)

å»æŸ¥çœ‹æºç ï¼Œå‘ç°æœ‰ä¸¤ä¸ªç–‘é—®ï¼Œoprid æ›¿æ¢sessionçš„æ—¶å€™æ˜¯ä»requestä¸­çš„sessionMapä¸­æ‹¿åˆ°uidï¼Œä½†æ˜¯åœ¨debugçš„æ—¶å€™å‘ç°ï¼Œrequestçš„sessionMapä¸­å°±æ²¡æœ‰uidè¿™ä¸ªå­—æ®µï¼Œå¯¼è‡´äº†åç»­æ‹¿åˆ°çš„uidä¸€ç›´ä¸ºnull
![image-20250908170535729](07.é¡µé¢è·³è½¬åŠèŠ‚ç‚¹ç‚¹å‡»å†å²è®°å½•.assets/image-20250908170535729.png)

è€Œå°†opridèµ‹å€¼ä¸º''  çš„æ—¶å€™ä¼šæŠ¥é”™
![image-20250908170632461](07.é¡µé¢è·³è½¬åŠèŠ‚ç‚¹ç‚¹å‡»å†å²è®°å½•.assets/image-20250908170632461.png)

ä¸Šé¢çš„uidæ›¿æ¢ä¸ºukeyä¹‹åæˆåŠŸäº†ï¼Œä¹Ÿå¯ä»¥æ›¿æ¢ä¸ºid  
æŸ¥è¯¢çš„æ—¶å€™åœ¨æ¡ä»¶éƒ¨åˆ†æ·»åŠ where user_id = {ukey}

### è®¾è®¡è¡¨

w_node_click_log  èŠ‚ç‚¹ç‚¹å‡»æ—¥å¿—è¡¨
![image-20250908145421310](07.é¡µé¢è·³è½¬åŠèŠ‚ç‚¹ç‚¹å‡»å†å²è®°å½•.assets/image-20250908145421310.png)

## æŸ¥è¯¢å†å²èŠ‚ç‚¹ç‚¹å‡»è®°å½•

### æ•°æ®æŸ¥è¯¢ä¼˜åŒ–

#### 1ã€æœªåˆ†é¡µæƒ…å†µ

```sql
SELECT DISTINCT ON (ncl.node_id)
       ag.id AS agid, 
       ag.agent_name, 
       no.id AS noid, 
       no.node_name, 
       no.url, 
       ncl.id,
       ncl.click_time
FROM node_click_log AS ncl
LEFT JOIN w_agent AS ag ON ag.id = ncl.agent_id
LEFT JOIN w_agent_node AS no ON no.id = ncl.node_id
WHERE ncl.isdel = 0 AND ncl.user_id = {ukey}
ORDER BY ncl.node_id, ncl.click_time DESC
LIMIT 10
```

#### 2ã€åˆ†é¡µåä½¿ç”¨ç³»ç»Ÿæ¶æ„

```xml
<msg id="node_click_log.queryClickRecord" type="selectjson"
    v=" SELECT DISTINCT ON (ncl.node_id)
           ag.id AS agid,
           ag.agent_name,
           no.id AS noid,
           no.node_name,
           no.url,
           ncl.id,
           ncl.click_time
        FROM node_click_log AS ncl
        LEFT JOIN w_agent AS ag ON ag.id = ncl.agent_id
        LEFT JOIN w_agent_node AS no ON no.id = ncl.node_id
        WHERE ncl.isdel = 0 AND ncl.user_id = {ukey} #0#
        ORDER BY ncl.node_id, ncl.click_time DESC
        LIMIT #1# OFFSET #2# " perms="">
    <where idx="0">
        <p key="node_name">  and no.node_name like '%{node_name}%'</p>
    </where>
</msg>
```

ä¸Šé¢çš„ç‰ˆæœ¬è™½ç„¶å®ç°äº†ï¼Œä½†æ˜¯ï¼Œåªæ˜¯åˆ†ç»„åç»„å†…çš„æ•°æ®æ‹¿åˆ°äº†æœ€æ–°çš„ä¸€æ¡ï¼Œå¤–å±‚çš„æ•°æ®æ˜¯æ²¡æœ‰æ’åºçš„ï¼Œé‚£ä¹ˆå°±éœ€è¦ä¿®æ”¹ä¸€ä¸‹ï¼Œè€Œä¸”**ä½¿ç”¨DISTINCT ON ä¼šå…¨è¡¨æ‰«æï¼Œåœ¨æ•°æ®é‡å¾ˆå¤§çš„æ—¶å€™ä¼šå‡ºç°æ¥å£å“åº”å¾ˆæ…¢ï¼Œè€Œä¸”æå¤§çš„æ¶ˆè€—èµ„æº**

#### 3ã€ç›¸å…³å­æŸ¥è¯¢

```xml
<msg id="node_click_log.queryClickRecord" type="selectjson"
     v="SELECT ag.id AS agid,ag.agent_name,no.id AS noid,no.node_name,no.url,ncl.id,ncl.click_time
          FROM node_click_log AS ncl
          LEFT JOIN w_agent AS ag ON ag.id = ncl.agent_id
          LEFT JOIN w_agent_node AS no ON no.id = ncl.node_id
          WHERE ncl.isdel = 0
               AND ncl.user_id = {ukey} #0#
               AND ncl.click_time = (
                    SELECT MAX(click_time)
                    FROM node_click_log ncl2
                    WHERE ncl2.node_id = ncl.node_id
                        AND ncl2.isdel = 0
                        AND ncl2.user_id = {ukey}
               )
          ORDER BY ncl.click_time DESC
          LIMIT #1# OFFSET #2#" perms="">
    <where idx="0">
        <p key="node_name">  and no.node_name like '%{node_name}%'</p>
    </where>
</msg>
```

ä¸Šé¢ä½¿ç”¨äº†[ç›¸å…³å­æŸ¥è¯¢](https://www.ibm.com/docs/zh/i/7.6.0?topic=subqueries-correlated)ï¼Œæ•°æ®é‡å¤§çš„æƒ…å†µä¹Ÿä¼šé€ æˆæ¥å£å“åº”å¾ˆæ…¢çš„æƒ…å†µï¼Œ**ç¬¬äºŒä¸ªæŸ¥è¯¢ä¾èµ–ç¬¬ä¸€ä¸ªæŸ¥è¯¢çš„æ•°æ®ï¼Œè™½ç„¶é¿å…äº†å…¨è¡¨æ‰«æï¼Œä½†æ˜¯è¿˜æ˜¯å¾ˆæ…¢å‘¢ï¼ï¼ï¼**



#### 4ã€çª—å£å‡½æ•°+ç´¢å¼•

##### [ğŸŒçª—å£å‡½æ•°](https://help.aliyun.com/zh/sls/window-functions#section-6dk-2dm-t9u)

è¯´æ˜: æ™®é€šçš„èšåˆå‡½æ•°åªèƒ½ç”¨æ¥è®¡ç®—ä¸€è¡Œå†…çš„ç»“æœæˆ–æŠŠæ‰€æœ‰è¡Œèšåˆæˆä¸€è¡Œç»“æœï¼Œè€Œçª—å£å‡½æ•°æ”¯æŒä¸ºæ¯ä¸€è¡Œç”Ÿæˆä¸€ä¸ªç»“æœï¼Œçª—å£å‡½æ•°åŒ…å«åˆ†åŒºã€æ’åºå’Œæ¡†æ¶ä¸‰ä¸ªæ ¸å¿ƒå…ƒç´ 



æ­¤å¤„ä½¿ç”¨åˆ°çš„  **ROW_NUMBER() å‡½æ•°ï¼š**

è¯¥å‡½æ•°ç”¨äºçª—å£åˆ†åŒºå†…å€¼çš„æ’åï¼Œæ¯ä¸ªå€¼æ‹¥æœ‰å”¯ä¸€çš„åºå·

```xml
<msg id="node_click_log.queryClickRecord" type="selectjson"
     v="SELECT ag.id AS agid,ag.agent_name, no.id AS noid,no.node_name,no.url,ncl.id,ncl.click_time
          FROM (
               SELECT *,
                    ROW_NUMBER() OVER (PARTITION BY node_id ORDER BY click_time DESC) as rn
               FROM node_click_log
               WHERE isdel = 0 AND user_id = {ukey}
          ) ncl
          LEFT JOIN w_agent ag ON ag.id = ncl.agent_id
          LEFT JOIN w_agent_node no ON no.id = ncl.node_id
          WHERE ncl.rn = 1 #0#
          ORDER BY ncl.click_time DESC
          LIMIT #1# OFFSET #2#" perms="">
    <where idx="0">
        <p key="node_name">  and no.node_name like '%{node_name}%'</p>
    </where>
</msg>
```

##### ğŸ“•ç´¢å¼•æ·»åŠ 

åˆ›å»ºå¤åˆç´¢å¼•
`CONCURRENTLY` ç”¨äºåœ¨ PostgreSQL ä¸­ä»¥éé˜»å¡æ–¹å¼åˆ›å»ºç´¢å¼•ï¼Œå…è®¸åœ¨åå°æ„å»ºç´¢å¼•çš„åŒæ—¶ï¼Œæ•°æ®åº“ä»èƒ½è¿›è¡ŒDMLï¼ˆæ’å…¥ã€æ›´æ–°ã€åˆ é™¤ï¼‰æ“ä½œã€‚è¿™ä¸ªè¿‡ç¨‹åˆ†ä¸‰ä¸ªé˜¶æ®µï¼Œæ¶‰åŠä¸¤æ¬¡å…¨è¡¨æ‰«æï¼Œå¹¶é€šè¿‡MVCC æœºåˆ¶å¤„ç†æ•°æ®å¹¶å‘æ€§ï¼Œä½†å¯èƒ½éœ€è¦ç­‰å¾…å†™äº‹åŠ¡æäº¤æ‰èƒ½å®Œæˆã€‚ä½¿ç”¨ `CONCURRENTLY` åˆ›å»ºç´¢å¼•çš„æ³¨æ„äº‹é¡¹åŒ…æ‹¬ï¼šé¿å…é•¿äº‹åŠ¡ã€ç¡®ä¿æ•°æ®åº“æ²¡æœ‰å…¶ä»–é•¿äº‹åŠ¡å ç”¨èµ„æºï¼Œä»¥åŠæ³¨æ„æ½œåœ¨çš„ç­‰å¾…é”é—®é¢˜å’Œåˆ†é˜¶æ®µçš„æ„å»ºè¿‡ç¨‹ã€‚ï»¿

```sql
CREATE INDEX CONCURRENTLY idx_node_click_log_user_node_time 
ON node_click_log (user_id, node_id, click_time DESC) 
WHERE isdel = 0;
```

![image-20250909134551747](07.é¡µé¢è·³è½¬åŠèŠ‚ç‚¹ç‚¹å‡»å†å²è®°å½•.assets/image-20250909134551747.png)

ä¸ºä»€ä¹ˆä½¿ç”¨ **CREATE INDEX CONCURRENTLY**ï¼Ÿï»¿
åœ¨çº¿æ“ä½œ:æ ‡å‡†çš„ CREATE INDEX å‘½ä»¤ä¼šé”å®šè¡¨ï¼Œé˜»æ­¢å†™æ“ä½œç›´åˆ°ç´¢å¼•æ„å»ºå®Œæˆã€‚CONCURRENTLY é€‰é¡¹åˆ™å…è®¸åœ¨ä¸é”è¡¨çš„æƒ…å†µä¸‹åˆ›å»ºç´¢å¼•ï¼Œå› æ­¤ä¸ä¼šå½±å“åº”ç”¨ç¨‹åºçš„å¯ç”¨æ€§ã€‚
CONCURRENTLY åˆ›å»ºç´¢å¼•çš„æ­¥éª¤å’Œè¿‡ç¨‹:CREATE INDEX CONCURRENTLY åˆ†ä¸ºå‡ ä¸ªé˜¶æ®µæ¥å¤„ç†å¹¶å‘æ€§ï¼šï»¿

1. ç¬¬ä¸€é˜¶æ®µ(å»ºç«‹å®šä¹‰):
  PostgreSQL è·å–ä¸€ä¸ªMVCC å¿«ç…§ï¼Œå¹¶ç­‰å¾…æ‰€æœ‰åœ¨å®ƒä¹‹åå¯åŠ¨çš„å†™äº‹åŠ¡å®Œæˆã€‚
  åˆ›å»ºç´¢å¼•çš„å®šä¹‰ï¼Œä½†æ­¤æ—¶ç´¢å¼•æ˜¯æ— æ•ˆçš„ã€‚
2. ç¬¬äºŒé˜¶æ®µ(æ„å»ºç´¢å¼•æ•°æ®):
  PostgreSQL è·å–å¦ä¸€ä¸ªMVCC å¿«ç…§ï¼Œå¯¹è¡¨è¿›è¡Œç¬¬äºŒæ¬¡å…¨è¡¨æ‰«æã€‚
  æ‰«æè¿‡ç¨‹ä¸­æ’å…¥çš„æ•°æ®ä¼šå¡«å……åˆ°ç´¢å¼•ä¸­ã€‚
  åœ¨æ‰«æå®Œæˆåï¼Œå®ƒä¼šç­‰å¾…æ‰€æœ‰æ—©äºè¿™ä¸ªæ–°å¿«ç…§çš„äº‹åŠ¡éƒ½æäº¤ã€‚
3. ç¬¬ä¸‰é˜¶æ®µ(ç”Ÿæ•ˆå’ŒéªŒè¯):
  ç´¢å¼•è¢«æ ‡è®°ä¸ºæœ‰æ•ˆï¼Œå¯ä»¥ä¾›å…¶ä»–æŸ¥è¯¢ä½¿ç”¨ã€‚
  åœ¨æ­¤è¿‡ç¨‹ä¸­ï¼Œæ–°æ’å…¥çš„æ•°æ®å°†è¢«ç´¢å¼•è‡ªåŠ¨ç»´æŠ¤å’Œç»´æŠ¤ã€‚
4. ä½¿ç”¨ CONCURRENTLY çš„æ³¨æ„äº‹é¡¹:
  é•¿äº‹åŠ¡:
  ç¡®ä¿æ•°æ®åº“ä¸­æ²¡æœ‰é•¿äº‹åŠ¡ã€‚å¦‚æœå­˜åœ¨é•¿äº‹åŠ¡ï¼Œå®ƒä»¬ä¼šé˜»æ­¢ CONCURRENTLY ç´¢å¼•çš„æ„å»ºï¼Œç›´åˆ°è¿™äº›äº‹åŠ¡ç»“æŸã€‚ï»¿
  ç­‰å¾…é”:
  å°½ç®¡å®ƒå…è®¸å¹¶å‘å†™æ“ä½œï¼Œä½†åœ¨ä¸åŒé˜¶æ®µï¼Œå®ƒå¯èƒ½ä»ç„¶éœ€è¦ç­‰å¾…å…¶ä»–äº‹åŠ¡çš„é”ï¼Œå¯¼è‡´é˜»å¡ã€‚ï»¿
  ä¸¤æ¬¡æ‰«æ:
  CONCURRENTLY éœ€è¦ä¸¤æ¬¡å…¨è¡¨æ‰«ææ¥å¤„ç†å¹¶å‘æ•°æ®ï¼Œå¹¶åˆ†ä¸ºä¸‰ä¸ªç‹¬ç«‹çš„äº‹åŠ¡é˜¶æ®µï¼Œè¿™ä¼šæ¯”ä¸ä½¿ç”¨ CONCURRENTLY æ…¢ä¸€äº›ã€‚ï»¿
  åˆ†é˜¶æ®µè¿‡ç¨‹:
  ç†è§£ç´¢å¼•çš„åˆ›å»ºæ˜¯åˆ†é˜¶æ®µçš„ï¼Œæ¯ä¸ªé˜¶æ®µéƒ½æ¶‰åŠç­‰å¾…ï¼Œè¿™æœ‰åŠ©äºè¯†åˆ«å’Œæ’é™¤æ€§èƒ½é—®é¢˜ã€‚ï»¿



### å†å²è®°å½•å±•ç¤º

#### å‰ç«¯è¯·æ±‚æ¥å£

éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå‰é¢çš„æ¶ˆæ¯ä¸­æˆ‘ä»¬ä½¿ç”¨äº†#1#  å’Œ  #2# å»å ä½çš„ï¼Œåœ¨å‰ç«¯çš„  $.sm(function(re,err){})  ä¸­å¡«å……æ•°æ®çš„æ—¶å€™éœ€è¦æ³¨æ„ msgwhereåé¢çš„ä¸¤ä¸ªå‚æ•°åˆ†åˆ«å¯¹åº”çš„å°±æ˜¯   ä¸Šé¢  #1# å’Œ #2# ä¸­çš„å†…å®¹

```js
$.sm(function (re, err) {
    // æ·»åŠ 0.8ç§’å»¶è¿Ÿï¼Œè®©ç”¨æˆ·çœ‹åˆ°åŠ è½½æ•ˆæœ
    setTimeout(function() {
        objdata.historyLoading = false;
        hideHistoryLoading();
        if (err) {
            layer.msg('è·å–å†å²è®°å½•å¤±è´¥: ' + err);
            return;
        }
        // å¤„ç†è¿”å›çš„æ•°æ®
        processHistoryData(re || [], isLoadMore);
    }, 800);

}, ["node_click_log.queryClickRecord", $.msgwhere(objwhere), pageSize, offset]);
```



å…¶ä»–çš„å°±æ˜¯åŠ¨æ€åŠ è½½ï¼Œä¸€æ¬¡å…ˆè·å–10æ¡æ•°æ®ï¼Œå½“æ»‘åŠ¨åˆ°åº•éƒ¨çš„æ—¶å€™å†å»è¯·æ±‚æ¥å£ï¼Œå½“ä¸Šä¸€ä¸ªæ•°ç»„ä¸ä¸‹ä¸€ä¸ªæ•°ç»„ä¸€è‡´æ—¶å°±ä¸å†è¯·æ±‚æ¥å£ï¼Œå› ä¸ºå½“è¾¾åˆ°æœ€åçš„æ•°æ®çš„æ—¶å€™ï¼Œå“ªæ€•é¡µç æŒç»­å¢åŠ ï¼Œå¾—åˆ°çš„æ•°æ®éƒ½æ˜¯ä¸€è‡´çš„ï¼Œé‚£ä¹ˆå°±æ²¡å¿…è¦å†æ¬¡è¯·æ±‚æ¥å£äº†ï¼Œæç¤ºæ•°æ®åˆ°åº•äº†å°±å®Œäº‹äº†ã€‚å¦åˆ™å°±å¾€å­˜å‚¨çš„å†å²è®°å½•çš„æ•°ç»„ä¸­è¿½åŠ ç›¸åº”çš„æ•°æ®å³å¯

## æ•ˆæœ

![image-20250909140428002](07.é¡µé¢è·³è½¬åŠèŠ‚ç‚¹ç‚¹å‡»å†å²è®°å½•.assets/image-20250909140428002.png)



## é¡µé¢ä¿®å¤

### æ ·å¼ä¿®å¤

åœ¨æ™ºèƒ½ä½“åˆ—è¡¨é¡µï¼Œä¼šå‡ºç°ä¸€ç§æƒ…å†µ![image-20250909140619201](07.é¡µé¢è·³è½¬åŠèŠ‚ç‚¹ç‚¹å‡»å†å²è®°å½•.assets/image-20250909140619201.png)
å½“é¼ æ ‡ç§»åŠ¨åˆ°ç¬¬äºŒä¸ªåˆ—è¡¨çš„æ—¶å€™
![image-20250909140652213](07.é¡µé¢è·³è½¬åŠèŠ‚ç‚¹ç‚¹å‡»å†å²è®°å½•.assets/image-20250909140652213.png)

ä¸‹é¢çš„æ™ºèƒ½ä½“ä¼šè¢«æŒ¤åˆ°åˆ«çš„åœ°æ–¹









### è·³è½¬è¿æ¥

é“¾æ¥å¾ˆé•¿çš„æ—¶å€™ç»™æˆªæ–­äº†ï¼ï¼ï¼ï¼





















