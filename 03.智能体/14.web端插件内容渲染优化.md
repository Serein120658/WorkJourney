## contentå†…å®¹æ¸²æŸ“

agent_list.js   agent_detail.js    node_graph_web.js

è¿™ä¸‰ä¸ªæ–‡ä»¶ä¸­éƒ½æ¶‰åŠåˆ°äº†ï¼Œé’ˆå¯¹ä¸åŒç±»å‹çš„contentå»æ¸²æŸ“ï¼ŒåŒ…æ‹¬codeç±»å‹ï¼Œhttpç±»å‹ç­‰ï¼Œè¿™å°±å¯¼è‡´äº†ä»£ç å†—ä½™é‡å¤§ï¼Œç°åœ¨æˆ‘æƒ³è¦å°†è¿™å‡ ç§æ¸²æŸ“å°è£…åˆ°ä¸€ä¸ªjsæ–‡ä»¶å½“ä¸­ï¼Œç„¶ååœ¨è¿™ä¸‰ä¸ªæ–‡ä»¶ä¸­requireè¿›è¡Œå¼•å…¥ï¼Œæ–°å»ºçš„jsæ–‡ä»¶ä¸è¿™ä¸‰ä¸ªæ–‡ä»¶åœ¨åŒä¸€ä¸ªç›®å½•ä¸‹ï¼Œä¸”ç»“æ„ä¹Ÿè¦ä¸æä¾›çš„æ–‡ä»¶ç»“æ„ä¸€è‡´





### æ–°é—®é¢˜

iframeæ˜¯ä¸æ”¯æŒjsçš„   éœ€è¦è€ƒè™‘ä½¿ç”¨åˆ«çš„æ–¹æ³•



# é‡æ„

ä¹‹å‰çš„å®ç°ä¸­ï¼Œå¯¹äºcontentçš„æ¸²æŸ“ï¼Œåœ¨ä¸‰ä¸ªåœ°æ–¹(agent_list.jsã€agent_detail.jsã€node_graph_web.js)éƒ½æ¶‰åŠåˆ°äº†ï¼Œä½†æ˜¯æœ€å¼€å§‹çš„ä¸€ç‰ˆï¼Œä¸‰ä¸ªåœ°æ–¹çš„æ¸²æŸ“éƒ½åœ¨å¯¹åº”çš„jsæ–‡ä»¶ä¸­ï¼Œè¿™å°±å¯¼è‡´äº†ä»£ç ä¸ä»…éå¸¸çš„è‡ƒè‚¿ï¼Œè€Œä¸”å¾ˆä¸çµæ´»ï¼Œå¦‚æœè¦å…¨é¢çš„æ”¹ï¼Œé‚£å°±éœ€è¦ä¿®æ”¹ä¸‰ä¸ªåœ°æ–¹ï¼Œé‰´äºä¸‰ä¸ªæ–‡ä»¶çš„codeç±»å‹çš„æ¸²æŸ“æ•ˆæœæ˜¯ä¸€æ ·çš„ï¼Œé‚£ä¹ˆå°±å¯ä»¥å°†å…¶å°è£…èµ·æ¥ï¼ŒåˆåŸæœ¬çš„èŠ‚ç‚¹é…ç½®æ˜¯åœ¨node_graph_web.jsä¸­çš„ï¼Œå¯¼è‡´äº†æ–‡ä»¶çš„ä»£ç é‡å¾ˆå¤§ï¼Œå°±è€ƒè™‘å°†èŠ‚ç‚¹çš„æ ·å¼ç­‰ä¹Ÿå°è£…åˆ°ä¸€ä¸ªæ–‡ä»¶å½“ä¸­ï¼Œä¹Ÿæ–¹ä¾¿ç»´æŠ¤

## content_renderer.js

```js
/**
 * ä½œè€…: é¾šå–œ
 * å†…å®¹æ¸²æŸ“å·¥å…·æ¨¡å— - ä¼˜åŒ–ç‰ˆ
 * ç»Ÿä¸€å¤„ç†ä¸åŒç±»å‹çš„æ’ä»¶å†…å®¹æ¸²æŸ“
 * åˆ›å»ºæ—¶é—´: 2025-10-09
 * ä¼˜åŒ–æ—¶é—´: 2025-10-10 ä¿®å¤HTMLåŒ…è£…ã€æƒé™æ£€æŸ¥ã€iframeç®¡ç†é—®é¢˜
 */

require.config({
    paths: {
        jquery: '../../sys/jquery'
    },
    waitSeconds: 0
});

// å…¨å±€å†…å®¹æ¸²æŸ“å™¨å¯¹è±¡
var ContentRenderer = (function() {

    // é»˜è®¤å›¾ç‰‡è·¯å¾„
    const DEFAULT_LOGO_PATH = '../../images/agentimg/agentimg.jpg';

    // æ’ä»¶ç±»å‹é…ç½®
    const PLUGIN_TYPES = {
        superlink: {
            name: 'è¶…é“¾æ¥',
            icon: 'ğŸ”—',
            bgColor: '#e6f7ff',
            borderColor: '#1890ff',
            textColor: '#1890ff'
        },
        http: {
            name: 'HTTPè¯·æ±‚',
            icon: 'ğŸŒ',
            bgColor: '#fff7e6',
            borderColor: '#fa8c16',
            textColor: '#fa8c16'
        },
        code: {
            name: 'ä»£ç æ‰§è¡Œ',
            icon: 'ğŸ’»',
            bgColor: '#f6ffed',
            borderColor: '#52c41a',
            textColor: '#52c41a'
        },
        function: {
            name: 'å‡½æ•°è°ƒç”¨',
            icon: 'âš¡',
            bgColor: '#f9f0ff',
            borderColor: '#722ed1',
            textColor: '#722ed1'
        },
        default: {
            name: 'é»˜è®¤å†…å®¹',
            icon: 'ğŸ“„',
            bgColor: 'transparent',
            borderColor: 'transparent',
            textColor: '#666'
        }
    };

    // èŠ‚ç‚¹æ ·å¼é…ç½®
    const NODE_STYLE_CONFIG = {
        size: {
            H5: [180, 140],
            web: [280, 180]
        },
        titleHeight: {
            H5: 25,
            web: 30
        },
        fontSize: {
            title: { H5: 10, web: 12 },
            content: { H5: 9, web: 11 },
            date: { H5: 10, web: 10 },
            count: { H5: 10, web: 10 },
            mainNumber: { H5: 16, web: 16 },
            subLabel: { H5: 12, web: 12 },
            lockIcon: { H5: 20, web: 26 }
        },
        colors: {
            nodeBorder: '#818181',
            nodeBorderDisabled: '#e8e8e8',
            nodeBorderSelected: '#1890ff',
            nodeBackground: '#fff',
            nodeBackgroundDisabled: '#f5f5f5',
            shadowDefault: 'rgba(24, 144, 255, 0.6)',
            shadowClicked: 'rgba(82, 196, 26, 0.8)',
            titleText: '#0a0a0a',
            titleTextDisabled: '#999',
            contentText: '#565555',
            contentTextDisabled: '#999',
            titleBorder: '#e1e1e1',
            htmlPreviewBorder: '#52c41a',
            htmlPreviewBorderDisabled: '#d9d9d9',
            htmlPreviewBackground: '#fff',
            htmlPreviewBackgroundDisabled: '#f5f5f5'
        },
        layout: {
            nodesep: { H5: 10, web: 40 },
            ranksep: { H5: 10, web: 25 },
            rankdir: { H5: 'TB', web: 'TB' },
            fitViewPadding: { H5: [20, 20, 20, 20], web: [30, 30, 30, 30] }
        },
        backgroundGrid: {
            H5: {
                background: `linear-gradient(90deg, rgba(0,0,0,0.1) 1px, transparent 1px),
                    linear-gradient(180deg, rgba(0,0,0,0.1) 1px, transparent 1px)`,
                backgroundSize: '20px 20px',
                backgroundPosition: '0 0, 0 10px, 10px -10px, -10px 0px'
            },
            web: {
                background: `linear-gradient(45deg, #f8f9fa 25%, transparent 25%),
                              linear-gradient(-45deg, #f8f9fa 25%, transparent 25%),
                              linear-gradient(45deg, transparent 75%, #f8f9fa 75%),
                              linear-gradient(-45deg, transparent 75%, #f8f9fa 75%)`,
                backgroundSize: '20px 20px',
                backgroundPosition: '0 0, 0 10px, 10px -10px, -10px 0px'
            }
        }
    };

    // iframeç®¡ç†å™¨ - ä¼˜åŒ–ç‰ˆ
    const IframeManager = {
        iframes: new Map(),

        create: function(containerId, htmlContent, isComplete = false) {
            this.destroy(containerId);

            const container = document.getElementById(containerId);
            if (!container) return null;

            const iframe = document.createElement('iframe');
            iframe.style.cssText = `
                width: 100%;
                height: 100%;
                border: none;
                border-radius: 4px;
            `;

            // ä¿®å¤ï¼šå®Œæ•´HTMLä¸éœ€è¦å†åŒ…è£…  TODO srcdocæ˜¯ä¸å…è®¸jsçš„
            if (isComplete) {
                iframe.srcdoc = htmlContent;
            } else {
                // åªæœ‰HTMLç‰‡æ®µæ‰éœ€è¦åŒ…è£…
                iframe.srcdoc = this.wrapHtmlContent(htmlContent);
            }

            container.appendChild(iframe);
            this.iframes.set(containerId, iframe);

            return iframe;
        },

        wrapHtmlContent: function(htmlContent) {
            return `
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="utf-8">
                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                    <style>
                        * { margin: 0; padding: 0; box-sizing: border-box; }
                        body { 
                            font-family: Arial, sans-serif; 
                            font-size: 10px; 
                            line-height: 1.2;
                            overflow: hidden;
                            transform: scale(0.8);
                            transform-origin: top left;
                            width: 125%;
                            height: 125%;
                        }
                        img { max-width: 100%; max-height: 40px; }
                        h1, h2, h3, h4, h5, h6 { font-size: 11px; margin: 1px 0; }
                        p, div { font-size: 9px; margin: 1px 0; }
                    </style>
                </head>
                <body>${htmlContent}</body>
                </html>
            `;
        },

        destroy: function(containerId) {
            const iframe = this.iframes.get(containerId);
            if (iframe && iframe.parentNode) {
                iframe.parentNode.removeChild(iframe);
                this.iframes.delete(containerId);
            }
        },

        destroyAll: function() {
            this.iframes.forEach((iframe, id) => {
                this.destroy(id);
            });
            this.iframes.clear();
        }
    };

    /**
     * è·å–èŠ‚ç‚¹æ ·å¼é…ç½®
     */
    function getNodeStyleConfig(configPath, pointType = 'web') {
        const type = pointType === 'H5' ? 'H5' : 'web';
        const pathArray = configPath.split('.');
        let config = NODE_STYLE_CONFIG;

        for (let path of pathArray) {
            config = config[path];
            if (!config) return null;
        }

        if (config && typeof config === 'object' && (config.H5 || config.web)) {
            return config[type] || config.web;
        }

        return config;
    }

    function escapeHtml(text) {
        if (!text) return '';
        const map = {
            '&': '&amp;',
            '<': '&lt;',
            '>': '&gt;',
            '"': '&quot;',
            "'": '&#039;'
        };
        return text.toString().replace(/[&<>"']/g, m => map[m]);
    }

    function isHtmlContent(content) {
        if (!content) return false;
        return /<[^>]+>/.test(content);
    }

    function isCompleteHtml(content) {
        if (!content) return false;
        const trimmed = content.trim().toLowerCase();
        return trimmed.startsWith('<!doctype html') || trimmed.startsWith('<html');
    }

    function getPluginTypeConfig(pluginType) {
        return PLUGIN_TYPES[pluginType] || PLUGIN_TYPES.default;
    }

    function shouldShowLogo(item) {
        if (item.pld === 0 && (!item.logo || item.logo === '')) {
            return { showLogo: true, logoPath: DEFAULT_LOGO_PATH };
        }

        if (item.logo === 0) {
            return { showLogo: true, logoPath: DEFAULT_LOGO_PATH };
        }

        if (item.logo && !item.logo.toString().match(/^\d+$/)) {
            const logoUrl = (typeof ossPrefix !== 'undefined' ? ossPrefix : '') + item.logo;
            return { showLogo: true, logoPath: logoUrl };
        }

        return { showLogo: false, logoPath: null };
    }

    function needsHtmlRendering(item) {
        return item.pld !== 0 &&
            item.plugin_type === 'code' &&
            isHtmlContent(item.content);
    }

    function generateContentHtml(item) {
        const logoInfo = shouldShowLogo(item);

        if (logoInfo.showLogo) {
            return `<img src="${logoInfo.logoPath}" alt="${item.agent_name || item.node_name || 'å›¾ç‰‡'}" onerror="this.src='${DEFAULT_LOGO_PATH}'">`;
        }

        if (item.pld !== 0 && item.content) {
            return generatePluginContentDisplay(item);
        }

        return `<img src="${DEFAULT_LOGO_PATH}" alt="é»˜è®¤å›¾ç‰‡">`;
    }

    function generatePluginContentDisplay(item) {
        const generators = {
            'superlink': generateSuperlinkDisplay,
            'http': generateHttpDisplay,
            'code': generateCodeDisplay,
            'function': generateFunctionDisplay
        };

        const generator = generators[item.plugin_type] || generateDefaultDisplay;
        return generator(item.content, item);
    }

    function generateSuperlinkDisplay(content) {
        const config = getPluginTypeConfig('superlink');
        const displayText = content.length > 60 ? content.substring(0, 60) + '...' : content;

        return `
            <div class="content-display superlink-display">
                <div class="link-icon">${config.icon}</div>
                <span class="link-text">${escapeHtml(displayText)}</span>
            </div>
        `;
    }

    function generateHttpDisplay(content, item) {
        const config = getPluginTypeConfig('http');
        const method = item.http_method || 'GET';
        const apiUrl = item.api_url || content || 'HTTPè¯·æ±‚';
        const displayText = apiUrl.length > 60 ? apiUrl.substring(0, 60) + '...' : apiUrl;

        return `
            <div class="content-display http-display">
                <div class="http-icon">${config.icon}</div>
                <span class="http-method">${method}</span>
                <span class="http-text">${escapeHtml(displayText)}</span>
            </div>
        `;
    }

    function generateCodeDisplay(content, item) {
        if (isHtmlContent(content)) {
            const previewId = `code-preview-${item.id || Math.random().toString(36).substr(2, 9)}`;
            const isComplete = isCompleteHtml(content);

            setTimeout(() => {
                IframeManager.create(previewId, content, isComplete);
            }, 100);

            return `<div class="html-preview-container" id="${previewId}"></div>`;
        } else {
            const displayText = content.length > 60 ? content.substring(0, 60) + '...' : content;
            const config = getPluginTypeConfig('code');

            return `
                <div class="content-display code-display">
                    <div class="code-icon">${config.icon}</div>
                    <span class="code-text">${escapeHtml(displayText)}</span>
                </div>
            `;
        }
    }

    function generateFunctionDisplay(content, item) {
        const config = getPluginTypeConfig('function');
        const funcName = item.function_name || item.func_name || 'Function';
        const funcDesc = content || item.description || 'å‡½æ•°è°ƒç”¨';
        const displayText = funcDesc.length > 60 ? funcDesc.substring(0, 60) + '...' : funcDesc;

        return `
            <div class="content-display function-display">
                <div class="function-icon">${config.icon}</div>
                <div class="function-name">${escapeHtml(funcName)}</div>
                <div class="function-text">${escapeHtml(displayText)}</div>
            </div>
        `;
    }

    function generateDefaultDisplay(content) {
        if (isCompleteHtml(content)) {
            return content;
        }

        if (isHtmlContent(content)) {
            return content;
        }

        const displayText = content.length > 60 ? content.substring(0, 60) + '...' : content;
        return `
            <div class="content-display text-display">
                <span>${escapeHtml(displayText)}</span>
            </div>
        `;
    }

    function generateDetailCardContent(item) {
        const isPluginLogo = item.logo && item.logo.toString().match(/^\d+$/);

        if (!isPluginLogo && item.logo !== 0) {
            if (item.logo) {
                const logoUrl = (typeof ossPrefix !== 'undefined' ? ossPrefix : '') + item.logo;
                return `<img src="${logoUrl}" alt="${item.agent_name || item.node_name || 'å›¾ç‰‡'}" onerror="this.src='${DEFAULT_LOGO_PATH}'">`;
            } else {
                return `<img src="${DEFAULT_LOGO_PATH}" alt="é»˜è®¤å›¾ç‰‡">`;
            }
        } else if (item.logo === 0) {
            return `<img src="${DEFAULT_LOGO_PATH}" alt="é»˜è®¤å›¾ç‰‡">`;
        } else {
            return generatePluginDetailDisplay(item);
        }
    }

    function generatePluginDetailDisplay(item) {
        const detailGenerators = {
            'superlink': generateSuperlinkDetailDisplay,
            'http': generateHttpDetailDisplay,
            'code': generateCodeDetailDisplay,
            'function': generateFunctionDetailDisplay
        };

        const generator = detailGenerators[item.plugin_type] || generateDefaultDetailDisplay;
        return generator(item);
    }

    function generateSuperlinkDetailDisplay(item) {
        const linkText = item.url || item.content || 'è¶…é“¾æ¥';
        const displayText = linkText.length > 15 ? linkText.substring(0, 15) + '...' : linkText;

        return `
            <div class="content-display superlink-display">
                <div class="plugin-icon" style="background: #e6f7ff; color: #1890ff; border: 1px solid #1890ff;">ğŸ”—</div>
                <div class="plugin-text" style="color: #1890ff;">${escapeHtml(displayText)}</div>
            </div>
        `;
    }

    function generateHttpDetailDisplay(item) {
        const method = item.http_method || 'GET';
        const apiUrl = item.api_url || item.content || 'HTTPè¯·æ±‚';
        const displayText = apiUrl.length > 12 ? apiUrl.substring(0, 12) + '...' : apiUrl;

        return `
            <div class="content-display http-display">
                <div class="plugin-icon" style="background: #fff7e6; color: #fa8c16; border: 1px solid #fa8c16;">ğŸŒ</div>
                <div class="plugin-method" style="color: #fa8c16; font-weight: bold; font-size: 11px;">${method}</div>
                <div class="plugin-text" style="color: #666; font-size: 10px;">${escapeHtml(displayText)}</div>
            </div>
        `;
    }

    function generateCodeDetailDisplay(item) {
        const codeText = item.content || 'ä»£ç æ‰§è¡Œ';

        if (isHtmlContent(codeText)) {
            const previewId = `code-preview-${item.id}`;
            const isComplete = isCompleteHtml(codeText);

            setTimeout(() => {
                IframeManager.create(previewId, codeText, isComplete);
            }, 100);

            return `<div class="html-preview-container" id="${previewId}" style="
                width: 100%; 
                height: 100%;              
                border-radius: 4px;
                overflow: hidden;
                background: #fff;
            "></div>`;
        } else {
            const displayText = codeText.length > 10 ? codeText.substring(0, 10) + '...' : codeText;
            return `
                <div class="content-display code-display">
                    <div class="plugin-icon" style="background: #f6ffed; color: #52c41a; border: 1px solid #52c41a; font-family: monospace;">&lt;/&gt;</div>
                    <div class="plugin-text" style="color: #666; font-size: 9px; font-family: monospace;">${escapeHtml(displayText)}</div>
                </div>
            `;
        }
    }

    function generateFunctionDetailDisplay(item) {
        const funcName = item.function_name || item.func_name || 'Function';
        const funcDesc = item.content || item.description || 'å‡½æ•°è°ƒç”¨';
        const displayText = funcDesc.length > 10 ? funcDesc.substring(0, 10) + '...' : funcDesc;

        return `
            <div class="content-display function-display">
                <div class="plugin-icon" style="background: #f9f0ff; color: #722ed1; border: 1px solid #722ed1; font-family: serif;">Æ’</div>
                <div class="plugin-method" style="color: #722ed1; font-weight: bold; font-size: 10px;">${escapeHtml(funcName)}</div>
                <div class="plugin-text" style="color: #666; font-size: 9px;">${escapeHtml(displayText)}</div>
            </div>
        `;
    }

    function generateDefaultDetailDisplay(item) {
        const content = item.content || 'æ— å†…å®¹';

        if (isCompleteHtml(content)) {
            return content;
        }

        if (isHtmlContent(content)) {
            return content;
        }

        const displayText = content.length > 30 ? content.substring(0, 30) + '...' : content;
        return `
            <div class="content-display">
                <span>${escapeHtml(displayText)}</span>
            </div>
        `;
    }

    // æš´éœ²å…¬å…±API
    return {
        escapeHtml: escapeHtml,
        isHtmlContent: isHtmlContent,
        isCompleteHtml: isCompleteHtml,
        getPluginTypeConfig: getPluginTypeConfig,
        shouldShowLogo: shouldShowLogo,
        needsHtmlRendering: needsHtmlRendering,
        getNodeStyleConfig: getNodeStyleConfig,
        NODE_STYLE_CONFIG: NODE_STYLE_CONFIG,
        generateContentHtml: generateContentHtml,
        generatePluginContentDisplay: generatePluginContentDisplay,
        generateDetailCardContent: generateDetailCardContent,
        generatePluginDetailDisplay: generatePluginDetailDisplay,
        generateSuperlinkDisplay: generateSuperlinkDisplay,
        generateHttpDisplay: generateHttpDisplay,
        generateCodeDisplay: generateCodeDisplay,
        generateFunctionDisplay: generateFunctionDisplay,
        generateDefaultDisplay: generateDefaultDisplay,
        generateSuperlinkDetailDisplay: generateSuperlinkDetailDisplay,
        generateHttpDetailDisplay: generateHttpDetailDisplay,
        generateCodeDetailDisplay: generateCodeDetailDisplay,
        generateFunctionDetailDisplay: generateFunctionDetailDisplay,
        generateDefaultDetailDisplay: generateDefaultDetailDisplay,
        IframeManager: IframeManager,
        createCodePreviewIframe: function(containerId, htmlContent, isComplete) {
            return IframeManager.create(containerId, htmlContent, isComplete);
        },
        PLUGIN_TYPES: PLUGIN_TYPES,
        DEFAULT_LOGO_PATH: DEFAULT_LOGO_PATH
    };
})();
```

åˆ›å»ºç»Ÿä¸€çš„iframeç®¡ç†å™¨

å°†ä¸€äº›æ–¹æ³•æš´éœ²å‡ºå»

## agent_list.js

```js
/*
* ä½œè€…: é¾šå–œ
* å¹¼å„¿å›­ç®¡ç†ç«¯çš„è·³è½¬é¡µé¢
* æ™ºèƒ½ä½“åˆ—è¡¨é¡µ
* åˆ›å»ºæ—¶é—´: 2025-09-03
* é‡æ„: 2025-09-08 ç®€åŒ–é¡µé¢è·³è½¬é€»è¾‘
* æ›´æ–°: 2025-09-12 æ·»åŠ pointTypeé€‚é…ä¸åŒç«¯
* æ›´æ–°: 2025-10-09 å¼•å…¥ContentRendererç»Ÿä¸€å†…å®¹æ¸²æŸ“
* */

require.config({
    paths: {
        jquery: '../../sys/jquery',
        system: '../../sys/system',
        layui: "../../layui-btkj/layui",
        layuicommon: "../../sys/layuicommon",
        contentRenderer: './content_renderer'
    },
    shim: {
        "system": {
            deps: ["jquery"]
        },
        "layui": {
            deps: ["jquery", "system"]
        },
        "layuicommon": {
            deps: ["jquery", "layui"]
        }
    },
    waitSeconds: 0
});

objdata = {
    // é€‚ç”¨ç«¯  é“¾æ¥æºå¸¦
    applicable: {
        applicable_end: ['å¹¼å„¿å›­ç®¡ç†WEB'],
        applicable_role: ['ç³»ç»Ÿç®¡ç†å‘˜']
    },

    // æ™ºèƒ½ä½“æœç´¢
    agent_name: 'æµ‹è¯•',

    // æ™ºèƒ½ä½“åˆ—è¡¨æ•°æ®
    agentListData: [],

    // ç«¯ç±»å‹æ§åˆ¶ï¼šwebã€H5  åç»­ä¼šé€šè¿‡è·³è½¬é“¾æ¥æºå¸¦
    pointType: 'web'
};

require(["jquery", "system", "layui", "contentRenderer"], function () {
    layui.use(['table', 'form', 'layer'], function () {
        initPointType();
        initList();
    });

    /**
     * åˆå§‹åŒ–ç«¯ç±»å‹
     */
    function initPointType() {
        // ä»URLå‚æ•°è·å–pointType
        const urlParams = new URLSearchParams(window.location.search);
        const pointType = urlParams.get('pointType');

        if (pointType) {
            objdata.pointType = pointType;
        }

        // æ ¹æ®ç«¯ç±»å‹åº”ç”¨æ ·å¼
        applyPointTypeStyle();
    }

    /**
     * æ ¹æ®ç«¯ç±»å‹åº”ç”¨æ ·å¼
     */
    function applyPointTypeStyle() {
        const body = $('body');

        // æ¸…é™¤ä¹‹å‰çš„ç«¯ç±»å‹æ ·å¼
        body.removeClass('point-type-web point-type-h5');

        // æ·»åŠ å¯¹åº”çš„ç«¯ç±»å‹æ ·å¼
        if (objdata.pointType === 'H5') {
            body.addClass('point-type-h5');
        } else {
            body.addClass('point-type-web');
        }
    }

    /**
     * åˆå§‹åŒ–æ™ºèƒ½ä½“åˆ—è¡¨
     */
    function initList() {
        let data = objdata.applicable;

        $.sm(function (re, err) {
            if (err) {
                layer.msg(err);
                renderEmptyState('åŠ è½½å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
            } else {
                objdata.agentListData = re || [];
                renderAgentList(objdata.agentListData);
            }
        }, ["w_agent_plugin.getList", $.msgwhere(data)]);
    }

    /**
     * æ¸²æŸ“æ™ºèƒ½ä½“åˆ—è¡¨
     */
    function renderAgentList(listData) {
        const container = $('#agentContainer');

        // å¦‚æœæ•°æ®ä¸ºç©ºï¼Œæ˜¾ç¤ºæš‚æ— æ•°æ®
        if (!listData || listData.length === 0) {
            renderEmptyState('æš‚æ— æ™ºèƒ½ä½“æ•°æ®', 'æš‚æ—¶è¿˜æ²¡æœ‰å¯ç”¨çš„æ™ºèƒ½ä½“ï¼Œè¯·ç¨åå†è¯•');
            return;
        }

        let html = '';

        listData.forEach(function(item) {
            const timeGranularity = item.time_granularity || 'æ—¥';
            const agentName = item.agent_name || 'æ™ºèƒ½ä½“åç§°';
            const bgClass = getBackgroundClass(timeGranularity);
            const contentHtml = generateContentHtml(item);

            // æ ¹æ®ç«¯ç±»å‹ç¡®å®šåˆ—å¸ƒå±€
            const colClass = getColumnClass();

            html += `
                <div class="${colClass}">
                    <div class="agent-list" data-id="${item.id}" data-time-granularity="${timeGranularity}">
                        <div class="agent_bg ${bgClass}">${timeGranularity}</div>
                        <div class="agent-listdiv">
                            ${contentHtml}
                        </div>
                        <div class="agent-btn">
                            ${agentName}
                        </div>
                    </div>
                </div>
            `;
        });

        container.html(html);

        // ç»‘å®šç‚¹å‡»äº‹ä»¶
        bindEvents();
    }

    /**
     * æ ¹æ®ç«¯ç±»å‹è·å–åˆ—å¸ƒå±€ç±»å
     */
    function getColumnClass() {
        if (objdata.pointType === 'H5') {
            // H5ç«¯ï¼šä¸€è¡Œä¸¤ä¸ª
            return 'layui-col-xs6 layui-col-sm6 layui-col-md6 layui-col-lg6';
        } else {
            // Webç«¯ï¼šå“åº”å¼å¸ƒå±€
            return 'layui-col-xs12 layui-col-sm6 layui-col-md4 layui-col-lg3';
        }
    }

    /**
     * æ¸²æŸ“ç©ºçŠ¶æ€
     */
    function renderEmptyState(title, description) {
        const container = $('#agentContainer');
        const emptyHtml = `
            <div class="layui-col-xs12">
                <div class="empty-state">
                    <div class="empty-icon">ğŸ“‹</div>
                    <div class="empty-text">${title}</div>
                    <div class="empty-desc">${description || ''}</div>
                    <div class="empty-actions">
                        <button class="layui-btn layui-btn-primary" onclick="refreshList()">
                            <i class="layui-icon layui-icon-refresh"></i> åˆ·æ–°
                        </button>
                    </div>
                </div>
            </div>
        `;
        container.html(emptyHtml);
    }

    /**
     * æ ¹æ®æ—¶é—´ç²’åº¦è·å–èƒŒæ™¯æ ·å¼ç±»
     */
    function getBackgroundClass(timeGranularity) {
        switch(timeGranularity) {
            case 'æ—¥':
                return 'daybg';
            case 'æœˆ':
                return 'mouthbg';
            case 'å¹´':
                return 'yearbg';
            default:
                return 'daybg';
        }
    }

    /**
     * ç”Ÿæˆå†…å®¹HTML - ä½¿ç”¨ ContentRenderer
     */
    function generateContentHtml(item) {
        return ContentRenderer.generateContentHtml(item);
    }

    /**
     * ç»‘å®šäº‹ä»¶
     */
    function bindEvents() {
        // æ™ºèƒ½ä½“ç‚¹å‡»äº‹ä»¶ - ç›´æ¥è·³è½¬åˆ°è¯¦æƒ…é¡µ
        $('.agent-list').off('click').on('click', function() {
            const agentId = $(this).data('id');
            const agentData = objdata.agentListData.find(item => item.id === agentId);

            if (agentData) {
                handleAgentClick(agentData);
            } else {
                layer.msg('æ™ºèƒ½ä½“æ•°æ®ä¸å­˜åœ¨');
            }
        });

        // æ‚¬æµ®æ•ˆæœ
        $('.agent-list').off('mouseenter mouseleave')
            .on('mouseenter', function() {
                $(this).addClass('agent-hover');
            })
            .on('mouseleave', function() {
                $(this).removeClass('agent-hover');
            });
    }

    /**
     * å¤„ç†æ™ºèƒ½ä½“ç‚¹å‡»äº‹ä»¶ - è·³è½¬åˆ°è¯¦æƒ…é¡µ
     */
    function handleAgentClick(agentData) {
        // æ˜¾ç¤ºåŠ è½½åŠ¨ç”»
        const loadingIndex = layui.layer.load(2, {
            shade: [0.3, '#ffffff'],
            content: 'æ­£åœ¨åŠ è½½...'
        });

        // å»¶è¿Ÿè·³è½¬ï¼Œè®©ç”¨æˆ·çœ‹åˆ°åé¦ˆ
        setTimeout(function() {
            layui.layer.close(loadingIndex);

            // è·³è½¬åˆ°è¯¦æƒ…é¡µï¼Œä¼ é€’agent_idå’ŒpointTypeå‚æ•°
            const params = new URLSearchParams();
            params.set('agent_id', agentData.id);
            if (objdata.pointType) {
                params.set('pointType', objdata.pointType);
            }
            params.set('applicable_end',objdata.applicable.applicable_end)
            params.set('applicable_role',objdata.applicable.applicable_role)

            window.location.href = `agent_detail.html?${params.toString()}`;
        }, 500);
    }

    /**
     * åˆ·æ–°åˆ—è¡¨
     */
    window.refreshList = function() {
        const loadingIndex = layui.layer.load(1, {shade: [0.2, '#000']});

        // å»¶è¿Ÿä¸€ä¸‹å†åˆ·æ–°ï¼Œç»™ç”¨æˆ·åé¦ˆ
        setTimeout(function() {
            layui.layer.close(loadingIndex);
            initList();
        }, 500);
    };

    // æš´éœ²å…¨å±€ç®¡ç†å¯¹è±¡
    window.agentListManager = {
        refreshList: function() {
            refreshList();
        },
        getListData: function() {
            return objdata.agentListData;
        },
        renderList: renderAgentList,
        reload: function() {
            window.location.reload();
        },
        getPointType: function() {
            return objdata.pointType;
        },
        setPointType: function(type) {
            objdata.pointType = type;
            applyPointTypeStyle();
            // é‡æ–°æ¸²æŸ“åˆ—è¡¨ä»¥åº”ç”¨æ–°çš„å¸ƒå±€
            renderAgentList(objdata.agentListData);
        }
    };
});
```

ç›´æ¥è°ƒç”¨å°è£…å¥½çš„æ–¹æ³•ï¼Œå‡å°‘ä»£ç å†—ä½™

## agent_detail.js

```js
/*
* ä½œè€…: é¾šå–œ
* å¹¼å„¿å›­ç®¡ç†ç«¯WEB çš„æ™ºèƒ½ä½“è¯¦æƒ…é¡µ
* åˆ›å»ºæ—¶é—´: 2025-09-03
* é‡æ„: 2025-09-08 ç®€åŒ–é¡µé¢è·³è½¬é€»è¾‘
* å†å²è®°å½•åŠŸèƒ½å®Œå–„: 2025-09-09
* æ›´æ–°: 2025-09-12 æ·»åŠ pointTypeé€‚é…ä¸åŒç«¯
* æ›´æ–°ï¼š2025-09-17 ä½¿ç”¨iframeå»æ¸²æŸ“ä»£ç å—
* æ›´æ–°: 2025-10-09 å¼•å…¥ContentRendererç»Ÿä¸€å†…å®¹æ¸²æŸ“
* */

require.config({
    paths: {
        jquery: '../../sys/jquery',
        system: '../../sys/system',
        layui: "../../layui-btkj/layui",
        layuicommon: "../../sys/layuicommon",
        contentRenderer: './content_renderer'
    },
    shim: {
        "system": {
            deps: ["jquery"]
        },
        "layui": {
            deps: ["jquery", "system"]
        },
        "layuicommon": {
            deps: ["jquery", "layui"]
        }
    },
    waitSeconds: 0
});

objdata = {
    // é€‚ç”¨ç«¯
    applicable: {
        applicable_end: '',
        applicable_role: ''
    },

    // æ™ºèƒ½ä½“æœç´¢
    agent_name: 'æµ‹è¯•',

    // URLä¼ é€’çš„agent_id
    agent_id: null,

    // å½“å‰é€‰ä¸­çš„æ™ºèƒ½ä½“
    currentAgent: null,

    // å·¦ä¾§é¢æ¿çŠ¶æ€
    leftPanelCollapsed: false,

    // å†å²è®°å½•å±•å¼€çŠ¶æ€
    historyExpanded: false,

    // å½“å‰é€‰æ‹©çš„æ—¶é—´
    currentDate: new Date(),

    // layuiç»„ä»¶å®ä¾‹
    laydate: null,

    // æ™ºèƒ½ä½“åˆ—è¡¨æ•°æ®
    agentListData: [],

    // èŠ‚ç‚¹å†å²è®°å½•
    nodeClickLog: [],

    // å†å²è®°å½•åˆ†é¡µç›¸å…³
    historyPageNum: 1,
    historyPageSize: 10,
    historyLoading: false,
    historyNoMore: false,
    historyLastData: null,

    // ç«¯ç±»å‹æ§åˆ¶ï¼šwebã€H5 åœ°å€æ æ‹¿åˆ°
    pointType: '',

    // H5ç«¯å·¦ä¾§é¢æ¿æ˜¾ç¤ºçŠ¶æ€
    h5LeftPanelVisible: false
};

require(["jquery", "system", "layui", "contentRenderer"], function () {
    layui.use(['table', 'form', 'layer', 'laydate'], function () {
        // ä¿å­˜laydateå®ä¾‹
        objdata.laydate = layui.laydate;

        // åˆå§‹åŒ–é¡µé¢
        initPage();
    });

    /**
     * åˆå§‹åŒ–é¡µé¢
     */
    function initPage() {
        // åˆå§‹åŒ–ç«¯ç±»å‹
        initPointType();

        // è·å–URLå‚æ•°ä¸­çš„agent_id
        objdata.agent_id = Arg('agent_id');

        if (!objdata.agent_id) {
            layer.msg('ç¼ºå°‘æ™ºèƒ½ä½“å‚æ•°ï¼Œå³å°†è¿”å›åˆ—è¡¨é¡µ', {time: 2000});
            setTimeout(function() {
                goBackToList();
            }, 2000);
            return;
        }

        // åˆå§‹åŒ–æ™ºèƒ½ä½“åˆ—è¡¨å’Œè¯¦æƒ…
        initAgentList();

        // åˆå§‹åŒ–äº‹ä»¶ç›‘å¬å™¨
        initEventListeners();

        // åˆå§‹åŒ–å†å²è®°å½•åŠŸèƒ½
        // initNodeHistory();
    }

    /**
     * åˆå§‹åŒ–ç«¯ç±»å‹
     */
    function initPointType() {

        const pointType = Arg('pointType');
        const applicable_end = Arg('applicable_end')
        const applicable_role = Arg('applicable_role');

        // console.log('pointType:', pointType);
        if (pointType) {
            objdata.pointType = pointType;
        }
        if(applicable_end && applicable_role){
            objdata.applicable.applicable_end = [applicable_end]
            objdata.applicable.applicable_role = [applicable_role]
        }

        // æ ¹æ®ç«¯ç±»å‹åº”ç”¨æ ·å¼
        applyPointTypeStyle();
    }

    /**
     * æ ¹æ®ç«¯ç±»å‹åº”ç”¨æ ·å¼
     */
    function applyPointTypeStyle() {
        const body = $('body');

        // æ¸…é™¤ä¹‹å‰çš„ç«¯ç±»å‹æ ·å¼
        body.removeClass('point-type-web point-type-h5');

        // æ·»åŠ å¯¹åº”çš„ç«¯ç±»å‹æ ·å¼
        if (objdata.pointType === 'H5') {
            body.addClass('point-type-h5');
            // H5ç«¯é»˜è®¤éšè—å·¦ä¾§é¢æ¿
            objdata.h5LeftPanelVisible = false;
        } else {
            body.addClass('point-type-web');
        }
    }

    /**
     * åˆå§‹åŒ–æ™ºèƒ½ä½“åˆ—è¡¨
     */
    function initAgentList() {
        let data = objdata.applicable;

        $.sm(function (re, err) {
            if (err) {
                layer.msg('è·å–æ™ºèƒ½ä½“æ•°æ®å¤±è´¥: ' + err);
                renderAgentListError();
            } else {
                objdata.agentListData = re || [];

                // æ¸²æŸ“å·¦ä¾§æ™ºèƒ½ä½“åˆ—è¡¨
                renderAgentList(objdata.agentListData);

                // è‡ªåŠ¨é€‰ä¸­æŒ‡å®šçš„æ™ºèƒ½ä½“
                if (objdata.agent_id) {
                    autoSelectAgent(objdata.agent_id);
                }
            }
        }, ["w_agent_plugin.getList", $.msgwhere(data)]);
    }

    /**
     * æ¸²æŸ“æ™ºèƒ½ä½“åˆ—è¡¨
     */
    function renderAgentList(agentListData) {
        const container = $('#agentListContainer');
        container.empty();

        if (!agentListData || agentListData.length === 0) {
            container.append('<div class="no-agents">æš‚æ— æ™ºèƒ½ä½“æ•°æ®</div>');
            return;
        }

        agentListData.forEach((item, index) => {
            const timeGranularity = item.time_granularity || 'æ—¥';
            const agentName = item.agent_name || 'æ™ºèƒ½ä½“åç§°';
            const bgClass = getBackgroundClass(timeGranularity);
            const contentHtml = generateContentHtml(item);

            const agentHtml = `
                <div class="agent-list widdiv" data-agent-id="${item.id}" data-index="${index}">
                    <div class="agent_bg ${bgClass}">${timeGranularity}</div>
                    <div class="agent-listdiv">${contentHtml}</div> 
                    <div class="agent-btn">${agentName}</div>
                </div>
            `;

            container.append(agentHtml);
        });

        // ç»‘å®šæ™ºèƒ½ä½“ç‚¹å‡»äº‹ä»¶
        bindAgentClickEvents();
    }

    /**
     * æ¸²æŸ“æ™ºèƒ½ä½“åˆ—è¡¨é”™è¯¯çŠ¶æ€
     */
    function renderAgentListError() {
        const container = $('#agentListContainer');
        const errorHtml = `
            <div class="error-state">
                <div class="error-icon">âš </div>
                <div class="error-text">åŠ è½½å¤±è´¥</div>
                <div class="error-actions">
                    <button class="layui-btn layui-btn-sm" onclick="initAgentList()">é‡è¯•</button>
                    <button class="layui-btn layui-btn-primary layui-btn-sm" onclick="goBackToList()">è¿”å›åˆ—è¡¨</button>
                </div>
            </div>
        `;
        container.html(errorHtml);
    }

    /**
     * ç»‘å®šæ™ºèƒ½ä½“ç‚¹å‡»äº‹ä»¶
     */
    function bindAgentClickEvents() {
        $('.agent-list').off('click').on('click', function() {
            const agentIndex = $(this).data('index');
            const agentData = objdata.agentListData[agentIndex];

            if (agentData) {
                selectAgent(agentData, $(this));

                // æ›´æ–°URLå‚æ•°ï¼Œä½†ä¸åˆ·æ–°é¡µé¢
                updateUrlParameter('agent_id', agentData.id);

                // H5ç«¯é€‰æ‹©æ™ºèƒ½ä½“åè‡ªåŠ¨éšè—å·¦ä¾§é¢æ¿
                if (objdata.pointType === 'H5') {
                    hideH5LeftPanel();
                }
            }
        });
    }

    /**
     * è‡ªåŠ¨é€‰ä¸­æŒ‡å®šIDçš„æ™ºèƒ½ä½“
     */
    function autoSelectAgent(agentId) {
        // æŸ¥æ‰¾å¯¹åº”çš„æ™ºèƒ½ä½“æ•°æ®
        const targetAgent = objdata.agentListData.find(agent => agent.id == agentId);

        if (targetAgent) {
            // æŸ¥æ‰¾å¯¹åº”çš„DOMå…ƒç´ 
            const targetElement = $(`.agent-list[data-agent-id="${agentId}"]`);

            if (targetElement.length > 0) {
                // è‡ªåŠ¨é€‰ä¸­è¯¥æ™ºèƒ½ä½“
                selectAgent(targetAgent, targetElement);

                // æ»šåŠ¨åˆ°é€‰ä¸­çš„æ™ºèƒ½ä½“ä½ç½®
                setTimeout(function() {
                    targetElement[0].scrollIntoView({
                        behavior: 'smooth',
                        block: 'center'
                    });
                }, 300);
            } else {
                layer.msg(`æœªæ‰¾åˆ°æŒ‡å®šçš„æ™ºèƒ½ä½“ (ID: ${agentId})`);
            }
        } else {
            layer.msg(`æœªæ‰¾åˆ°æŒ‡å®šçš„æ™ºèƒ½ä½“ (ID: ${agentId})`);
        }
    }

    /**
     * é€‰æ‹©æ™ºèƒ½ä½“
     */
    function selectAgent(agent, element) {
        // æ›´æ–°é€‰ä¸­çŠ¶æ€
        $('.agent-list').removeClass('active');
        element.addClass('active');

        // ä¿å­˜å½“å‰é€‰ä¸­çš„æ™ºèƒ½ä½“
        objdata.currentAgent = agent;
        objdata.agent_id = agent.id;

        // æ¸²æŸ“å³ä¾§å†…å®¹
        renderAgentContent(agent);
    }

    /**
     * æ¸²æŸ“æ™ºèƒ½ä½“å†…å®¹
     */
    function renderAgentContent(agent) {
        const header = $('#detailHeader');
        const contentArea = $('#contentArea');
        const placeholder = $('#contentPlaceholder');

        // éšè—å ä½ç¬¦
        placeholder.hide();

        // æ¸…é™¤ä¹‹å‰çš„å†…å®¹
        $('.header-content').remove();
        $('.node-content').remove();

        // æ˜¾ç¤ºå¤´éƒ¨
        const headerHtml = generateHeaderHtml(agent);
        header.append(headerHtml);

        // åˆå§‹åŒ–æ—¶é—´é€‰æ‹©å™¨
        initTimeSelector(agent);
        const params = new URLSearchParams();
        params.set('agent_id', agent.id);
        params.set('pointType', objdata.pointType);
        params.set('applicable_end',objdata.applicable.applicable_end)
        params.set('applicable_role',objdata.applicable.applicable_role)

        // åŠ è½½èŠ‚ç‚¹å›¾è¡¨
        const nodeGraphHtml = `
            <div class="node-content">           
                <iframe 
                    id="nodeGraphFrame" 
                    src="../../html/agent-web/node_graph_web.html?${params.toString()}" 
                    frameborder="0" 
                    style="width: 100%; height: 810px; border: none; border-radius: 8px;">
                </iframe>       
            </div>
        `;

        contentArea.append(nodeGraphHtml);
    }

    /**
     * ç”Ÿæˆå¤´éƒ¨HTML
     */
    function generateHeaderHtml(agent) {
        const timeDisplay = getTimeDisplay(agent.time_granularity);
        const iconFont = objdata.h5LeftPanelVisible ? 'layui-icon-spread-left' : 'layui-icon-spread-right';

        // H5ç«¯æ·»åŠ èœå•æŒ‰é’®
        const menuButton = objdata.pointType === 'H5' ?
            `<i class="layui-icon layui-icon-list" style="font-size: 20px; color: #1E9FFF; cursor: pointer; margin-right: 10px;" onclick="toggleH5LeftPanel()"></i>` : '';

        return `
            <div class="header-content">
                <div class="header-left">
                    ${menuButton}
                    <i class="layui-icon layui-icon-left" style="font-size: 20px; color: #1E9FFF; cursor: pointer" onclick="goBackToList()"></i> 
                    <div class="agent_name">${agent.agent_name}</div>
                </div>
                <div class="header-right" id="timeSelector">
                    <div class="header-right-time" id="timeContent">
                        ${timeDisplay}
                    </div>
                    <i class="layui-icon layui-icon-date" style="font-size: 20px; color: #1E9FFF; margin-left: 5px;"></i> 
                </div>
            </div>
        `;
    }

    /**
     * H5ç«¯åˆ‡æ¢å·¦ä¾§é¢æ¿æ˜¾ç¤º/éšè—
     */
    window.toggleH5LeftPanel = function() {
        if (objdata.pointType === 'H5') {
            objdata.h5LeftPanelVisible = !objdata.h5LeftPanelVisible;

            if (objdata.h5LeftPanelVisible) {
                showH5LeftPanel();
            } else {
                hideH5LeftPanel();
            }
        }
    };

    /**
     * æ˜¾ç¤ºH5ç«¯å·¦ä¾§é¢æ¿
     */
    function showH5LeftPanel() {
        const leftPanel = $('#leftPanel');
        const overlay = $('.h5-overlay');

        leftPanel.addClass('h5-visible');

        // å¦‚æœé®ç½©ä¸å­˜åœ¨ï¼Œåˆ›å»ºé®ç½©
        if (overlay.length === 0) {
            $('body').append('<div class="h5-overlay"></div>');

            // ç»‘å®šé®ç½©ç‚¹å‡»äº‹ä»¶
            $('.h5-overlay').on('click', function() {
                hideH5LeftPanel();
            });
        }

        $('.h5-overlay').fadeIn(300);
        objdata.h5LeftPanelVisible = true;
    }

    /**
     * éšè—H5ç«¯å·¦ä¾§é¢æ¿
     */
    function hideH5LeftPanel() {
        const leftPanel = $('#leftPanel');
        const overlay = $('.h5-overlay');

        leftPanel.removeClass('h5-visible');
        overlay.fadeOut(300);
        objdata.h5LeftPanelVisible = false;
    }

    /**
     * æ ¹æ®æ—¶é—´ç»´åº¦è·å–å½“å‰æ—¶é—´æ˜¾ç¤º
     */
    function getTimeDisplay(timeGranularity) {
        const now = objdata.currentDate;

        switch(timeGranularity) {
            case 'æ—¥':
                return formatDate(now, 'yyyy-MM-dd');
            case 'æœˆ':
                return formatDate(now, 'yyyy-MM');
            case 'å¹´':
                return formatDate(now, 'yyyy');
            default:
                return formatDate(now, 'yyyy-MM-dd');
        }
    }

    /**
     * åˆå§‹åŒ–æ—¶é—´é€‰æ‹©å™¨
     */
    function initTimeSelector(agent) {
        const timeGranularity = agent.time_granularity || 'æ—¥';

        $('#timeSelector').off('click');

        let dateConfig = {
            elem: '#timeSelector',
            trigger: 'click',
            value: getTimeDisplay(timeGranularity),
            show: false,
            done: function(value) {
                objdata.currentDate = new Date(value);
                $('#timeContent').text(value);

                // é‡æ–°åŠ è½½èŠ‚ç‚¹å›¾è¡¨æ•°æ® - ä¼ é€’å®Œæ•´å‚æ•°
                reloadNodeGraph(agent.id, value, timeGranularity);
            }
        };

        switch(timeGranularity) {
            case 'æ—¥':
                dateConfig.type = 'date';
                dateConfig.format = 'yyyy-MM-dd';
                break;
            case 'æœˆ':
                dateConfig.type = 'month';
                dateConfig.format = 'yyyy-MM';
                break;
            case 'å¹´':
                dateConfig.type = 'year';
                dateConfig.format = 'yyyy';
                break;
            default:
                dateConfig.type = 'date';
                dateConfig.format = 'yyyy-MM-dd';
        }

        const laydateInstance = objdata.laydate.render(dateConfig);
        $('#timeSelector').data('laydate-instance', laydateInstance);
    }

    /**
     * é‡æ–°åŠ è½½èŠ‚ç‚¹å›¾è¡¨
     */
    function reloadNodeGraph(agentId, selectedTime, timeGranularity) {
        const iframe = $('#nodeGraphFrame');
        if (iframe.length > 0) {
            const params = new URLSearchParams();
            params.set('agent_id', agentId);
            params.set('selected_time', selectedTime);
            params.set('time_granularity', timeGranularity);

            // ä¼ é€’ç«¯ç±»å‹
            if (objdata.pointType) {
                params.set('pointType', objdata.pointType);
            }

            // ä¼ é€’æƒé™å‚æ•° - å…³é”®ä¿®å¤
            if (objdata.applicable.applicable_end) {
                params.set('applicable_end', objdata.applicable.applicable_end);
            }
            if (objdata.applicable.applicable_role) {
                params.set('applicable_role', objdata.applicable.applicable_role);
            }

            const newSrc = `../../html/agent-web/node_graph_web.html?${params.toString()}`;
            iframe.attr('src', newSrc);
        }
    }

    /**
     * è¿”å›åˆ—è¡¨é¡µ
     */
    window.goBackToList = function() {
        // æ˜¾ç¤ºåŠ è½½åŠ¨ç”»
        const loadingIndex = layui.layer.load(1, {
            shade: [0.3, '#ffffff'],
            content: 'åŠ è½½ä¸­...'
        });

        // å»¶è¿Ÿè·³è½¬ï¼Œç»™ç”¨æˆ·åé¦ˆ
        setTimeout(function() {
            layui.layer.close(loadingIndex);

            // è·³è½¬æ—¶ä¿æŒpointTypeå‚æ•°
            const params = new URLSearchParams();
            if (objdata.pointType) {
                params.set('pointType', objdata.pointType);
            }

            const url = params.toString() ? `agent_list.html?${params.toString()}` : 'agent_list.html';
            window.location.href = url;
        }, 300);
    };

    /**
     * æ›´æ–°URLå‚æ•°
     */
    function updateUrlParameter(key, value) {
        try {
            const url = new URL(window.location);
            url.searchParams.set(key, value);

            // ä¿æŒpointTypeå‚æ•°
            if (objdata.pointType) {
                url.searchParams.set('pointType', objdata.pointType);
            }

            window.history.replaceState({}, document.title, url.toString());
        } catch (error) {
            console.error('æ›´æ–°URLå‚æ•°å¤±è´¥:', error);
        }
    }

    /**
     * æ ¼å¼åŒ–æ—¥æœŸ
     */
    function formatDate(date, format) {
        if (!date) return '';

        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');

        return format
            .replace('yyyy', year)
            .replace('MM', month)
            .replace('dd', day);
    }

    /**
     * æ ¹æ®æ—¶é—´ç²’åº¦è·å–èƒŒæ™¯æ ·å¼ç±»
     */
    function getBackgroundClass(timeGranularity) {
        switch(timeGranularity) {
            case 'æ—¥':
                return 'daybg';
            case 'æœˆ':
                return 'mouthbg';
            case 'å¹´':
                return 'yearbg';
            default:
                return 'daybg';
        }
    }

    /**
     * ç”Ÿæˆå†…å®¹HTML - ä½¿ç”¨ ContentRenderer
     */
    function generateContentHtml(item) {
        return ContentRenderer.generateDetailCardContent(item);
    }

    /**
     * åˆå§‹åŒ–å†å²è®°å½•åŠŸèƒ½
     */
    function initNodeHistory() {
        // é‡ç½®å†å²è®°å½•ç›¸å…³å˜é‡
        objdata.nodeClickLog = [];
        objdata.historyPageNum = 1;
        objdata.historyPageSize = 10;
        objdata.historyLoading = false;
        objdata.historyNoMore = false;
        objdata.historyLastData = null;

        // é¦–æ¬¡åŠ è½½å†å²è®°å½•
        loadNodeHistory();

        // ç»‘å®šå†å²è®°å½•å®¹å™¨çš„æ»šåŠ¨äº‹ä»¶
        bindHistoryScrollEvent();
    }

    /**
     * åŠ è½½å†å²è®°å½•æ•°æ®
     */
    function loadNodeHistory(isLoadMore = false) {
        // å¦‚æœæ­£åœ¨åŠ è½½æˆ–è€…å·²ç»æ²¡æœ‰æ›´å¤šæ•°æ®ï¼Œåˆ™ä¸å†åŠ è½½
        if (objdata.historyLoading || objdata.historyNoMore) {
            return;
        }

        objdata.historyLoading = true;

        // æ˜¾ç¤ºåŠ è½½æ•ˆæœ
        showHistoryLoading(isLoadMore);

        const pageSize = objdata.historyPageSize;
        const pageNum = objdata.historyPageNum;
        const offset = (pageNum - 1) * pageSize;

        // æœç´¢èŠ‚ç‚¹åå­—,åç»­éœ€è¦å†åŠ 
        var objwhere = {};
        const nodeName = $('#nodeName').val();
        if (nodeName && nodeName.trim()) {
            objwhere.node_name = nodeName.trim();
        }

        $.sm(function (re, err) {
            // æ·»åŠ 0.8ç§’å»¶è¿Ÿï¼Œè®©ç”¨æˆ·çœ‹åˆ°åŠ è½½æ•ˆæœ
            setTimeout(function() {
                objdata.historyLoading = false;
                hideHistoryLoading();

                if (err) {
                    layer.msg('è·å–å†å²è®°å½•å¤±è´¥: ' + err);
                    return;
                }

                // å¤„ç†è¿”å›çš„æ•°æ®
                processHistoryData(re || [], isLoadMore);
            }, 800);

        }, ["node_click_log.queryClickRecord", $.msgwhere(objwhere), pageSize, offset]);
    }

    /**
     * å¤„ç†å†å²è®°å½•æ•°æ®
     */
    function processHistoryData(newData, isLoadMore) {
        // æ£€æŸ¥æ˜¯å¦ä¸ä¸Šæ¬¡æ•°æ®ä¸€è‡´ é¿å…é‡å¤è¯·æ±‚æ¥å£
        if (objdata.historyLastData && JSON.stringify(newData) === JSON.stringify(objdata.historyLastData)) {
            objdata.historyNoMore = true;
            showNoMoreTip();
            return;
        }

        // å¦‚æœæ²¡æœ‰æ–°æ•°æ®
        if (!newData || newData.length === 0) {
            if (!isLoadMore) {
                renderEmptyHistory();
            } else {
                objdata.historyNoMore = true;
                showNoMoreTip();
            }
            return;
        }

        // å¦‚æœè¿”å›çš„æ•°æ®å°‘äºé¡µé¢å¤§å°ï¼Œè¯´æ˜æ²¡æœ‰æ›´å¤šæ•°æ®äº†
        if (newData.length < objdata.historyPageSize) {
            objdata.historyNoMore = true;
        }

        // ä¿å­˜å½“å‰æ•°æ®ä½œä¸ºä¸Šæ¬¡æ•°æ®çš„æ¯”è¾ƒåŸºå‡†
        objdata.historyLastData = [...newData];

        if (isLoadMore) {
            // è¿½åŠ æ•°æ®
            objdata.nodeClickLog = objdata.nodeClickLog.concat(newData);
        } else {
            // é¦–æ¬¡åŠ è½½æˆ–åˆ·æ–°
            objdata.nodeClickLog = newData;
        }

        // æ¸²æŸ“å†å²è®°å½•
        renderHistory(isLoadMore);

        // é¡µç åŠ 1ï¼Œä¸ºä¸‹æ¬¡åŠ è½½åšå‡†å¤‡
        objdata.historyPageNum++;
    }

    /**
     * æ¸²æŸ“å†å²è®°å½•
     */
    function renderHistory(isLoadMore = false) {
        const historyContent = $('#historyContent');

        if (!isLoadMore) {
            // æ¸…ç©ºç°æœ‰å†…å®¹
            historyContent.empty();
        }

        // ç§»é™¤ä¹‹å‰çš„"åˆ°åº•äº†"æç¤º
        historyContent.find('.history-no-more').remove();

        if (!objdata.nodeClickLog || objdata.nodeClickLog.length === 0) {
            renderEmptyHistory();
            return;
        }

        // æ¸²æŸ“æ¯ä¸€æ¡å†å²è®°å½•
        objdata.nodeClickLog.forEach((item, index) => {
            // å¦‚æœæ˜¯åŠ è½½æ›´å¤šï¼Œåªæ¸²æŸ“æ–°æ•°æ®
            if (isLoadMore) {
                const existingIndex = objdata.nodeClickLog.length - (objdata.historyLastData ? objdata.historyLastData.length : 0);
                if (index < existingIndex) {
                    return;
                }
            }

            const historyItemHtml = generateHistoryItemHtml(item, index);
            historyContent.append(historyItemHtml);
        });

        // å¦‚æœæ²¡æœ‰æ›´å¤šæ•°æ®ï¼Œæ˜¾ç¤ºåˆ°åº•æç¤º
        if (objdata.historyNoMore) {
            showNoMoreTip();
        }

        // ç»‘å®šç‚¹å‡»äº‹ä»¶
        bindHistoryItemClickEvents();
    }

    /**
     * ç”Ÿæˆå†å²è®°å½•é¡¹HTML
     */
    function generateHistoryItemHtml(item, index) {
        const nodeName = item.node_name || 'æœªçŸ¥èŠ‚ç‚¹';
        const agentName = item.agent_name || 'æœªçŸ¥æ™ºèƒ½ä½“';
        const clickTime = formatHistoryTime(item.click_time);

        // æˆªå–è¿‡é•¿çš„èŠ‚ç‚¹åç§°
        const displayNodeName = nodeName.length > 15 ? nodeName.substring(0, 15) + '...' : nodeName;
        const displayAgentName = agentName.length > 12 ? agentName.substring(0, 12) + '...' : agentName;

        return `
            <div class="history-item" data-item-index="${index}" data-url="${item.url || ''}" data-node-id="${item.noid || ''}" data-agent-id="${item.agid || ''}">
                <h3>
                    <img src="../../images/agentimg/refreshimg.png" width="16" height="17">
                    <span class="node-name" title="${ContentRenderer.escapeHtml(nodeName)}">${ContentRenderer.escapeHtml(displayNodeName)}</span>
                </h3>
                <p class="history-desc">
                    <span class="agent-info" title="${ContentRenderer.escapeHtml(agentName)}">æ™ºèƒ½ä½“ï¼š${ContentRenderer.escapeHtml(displayAgentName)}</span>
                    <span class="time-info">${clickTime}</span>
                </p>
            </div>
        `;
    }

    /**
     * æ ¼å¼åŒ–å†å²è®°å½•æ—¶é—´æ˜¾ç¤º
     */
    function formatHistoryTime(timeStr) {
        if (!timeStr) return '';

        try {
            const date = new Date(timeStr);
            const now = new Date();
            const diff = now - date;

            // å°äº1åˆ†é’Ÿæ˜¾ç¤º"åˆšåˆš"
            if (diff < 60 * 1000) {
                return 'åˆšåˆš';
            }

            // å°äº1å°æ—¶æ˜¾ç¤º"Xåˆ†é’Ÿå‰"
            if (diff < 60 * 60 * 1000) {
                const minutes = Math.floor(diff / (60 * 1000));
                return `${minutes}åˆ†é’Ÿå‰`;
            }

            // å°äº1å¤©æ˜¾ç¤º"Xå°æ—¶å‰"
            if (diff < 24 * 60 * 60 * 1000) {
                const hours = Math.floor(diff / (60 * 60 * 1000));
                return `${hours}å°æ—¶å‰`;
            }

            // è¶…è¿‡1å¤©æ˜¾ç¤ºå…·ä½“æ—¥æœŸ
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hour = String(date.getHours()).padStart(2, '0');
            const minute = String(date.getMinutes()).padStart(2, '0');

            return `${month}-${day} ${hour}:${minute}`;
        } catch (error) {
            return timeStr;
        }
    }

    /**
     * ç»‘å®šå†å²è®°å½•é¡¹ç‚¹å‡»äº‹ä»¶
     */
    function bindHistoryItemClickEvents() {
        $('.history-item').off('click.historyItem').on('click.historyItem', function() {
            const nodeId = $(this).data('node-id');
            const agentId = $(this).data('agent-id');
            const nodeName = $(this).find('.node-name').text();

            // æ£€æŸ¥å¿…è¦å‚æ•°
            if (!nodeId || !agentId) {
                layer.msg('å†å²è®°å½•æ•°æ®ä¸å®Œæ•´ï¼Œæ— æ³•è·³è½¬');
                return;
            }

            // æ·»åŠ åŠ è½½æç¤º
            const loadingIndex = layer.load(1, {
                shade: [0.3, '#ffffff'],
                content: 'æ­£åœ¨è·³è½¬...'
            });

            try {
                // 1. æ£€æŸ¥å½“å‰æ˜¯å¦å·²ç»æ˜¯ç›®æ ‡æ™ºèƒ½ä½“
                if (objdata.agent_id && objdata.agent_id.toString() === agentId.toString()) {
                    // å½“å‰å°±æ˜¯ç›®æ ‡æ™ºèƒ½ä½“ï¼Œç›´æ¥é€‰ä¸­èŠ‚ç‚¹
                    selectNodeInCurrentGraph(nodeId, nodeName);
                    layer.close(loadingIndex);
                } else {
                    // 2. éœ€è¦åˆ‡æ¢åˆ°ç›®æ ‡æ™ºèƒ½ä½“
                    switchToAgentAndSelectNode(agentId, nodeId, nodeName, loadingIndex);
                }

                // 3. æ”¶èµ·å†å²è®°å½•é¢æ¿
                if (objdata.historyExpanded) {
                    $('#expandBtn').click();
                    setTimeout(function() {
                        hideH5LeftPanel();
                    },500)
                }

            } catch (error) {
                layer.close(loadingIndex);
                layer.msg('è·³è½¬å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        });
    }

    /**
     * åœ¨å½“å‰å›¾è¡¨ä¸­é€‰ä¸­æŒ‡å®šèŠ‚ç‚¹
     */
    function selectNodeInCurrentGraph(nodeId, nodeName) {
        const iframe = $('#nodeGraphFrame')[0];
        if (iframe && iframe.contentWindow) {
            try {
                // å‘é€é€‰ä¸­èŠ‚ç‚¹çš„æ¶ˆæ¯åˆ°iframe
                iframe.contentWindow.postMessage({
                    type: 'selectNode',
                    nodeId: nodeId.toString(),
                    nodeName: nodeName
                }, '*');

            } catch (error) {
                layer.msg('é€‰ä¸­èŠ‚ç‚¹å¤±è´¥');
            }
        } else {
            layer.msg('å›¾è¡¨æœªåŠ è½½å®Œæˆï¼Œè¯·ç¨åé‡è¯•');
        }
    }

    /**
     * åˆ‡æ¢åˆ°æŒ‡å®šæ™ºèƒ½ä½“å¹¶é€‰ä¸­èŠ‚ç‚¹
     */
    function switchToAgentAndSelectNode(agentId, nodeId, nodeName, loadingIndex) {
        // 1. æŸ¥æ‰¾ç›®æ ‡æ™ºèƒ½ä½“
        const targetAgent = objdata.agentListData.find(agent => agent.id.toString() === agentId.toString());

        if (!targetAgent) {
            layer.close(loadingIndex);
            layer.msg('æœªæ‰¾åˆ°ç›®æ ‡æ™ºèƒ½ä½“');
            return;
        }

        // 2. åˆ‡æ¢æ™ºèƒ½ä½“
        const targetElement = $(`.agent-list[data-agent-id="${agentId}"]`);
        if (targetElement.length > 0) {
            selectAgent(targetAgent, targetElement);
            updateUrlParameter('agent_id', agentId);

            // 3. ç­‰å¾…iframeåŠ è½½å®Œæˆåé€‰ä¸­èŠ‚ç‚¹
            const iframe = $('#nodeGraphFrame')[0];
            if (iframe) {
                let hasSelected = false;

                const onIframeLoad = function() {
                    if (hasSelected) return;
                    hasSelected = true;

                    // ç­‰å¾…iframeå†…éƒ¨åˆå§‹åŒ–å®Œæˆ
                    setTimeout(() => {
                        selectNodeInCurrentGraph(nodeId, nodeName);

                        setTimeout(() => {
                            layer.close(loadingIndex);
                        }, 1000);
                    }, 800);

                    iframe.removeEventListener('load', onIframeLoad);
                };

                // ç›‘å¬æ¥è‡ªiframeçš„readyæ¶ˆæ¯
                const messageHandler = function(event) {
                    if (event.data && event.data.type === 'graphReady' && !hasSelected) {
                        hasSelected = true;

                        setTimeout(() => {
                            selectNodeInCurrentGraph(nodeId, nodeName);
                            setTimeout(() => {
                                layer.close(loadingIndex);
                            }, 1000);
                        }, 500);

                        window.removeEventListener('message', messageHandler);
                    }
                };

                window.addEventListener('message', messageHandler);
                iframe.addEventListener('load', onIframeLoad);

                // è¶…æ—¶ä¿æŠ¤
                setTimeout(() => {
                    layer.close(loadingIndex);
                    iframe.removeEventListener('load', onIframeLoad);
                    window.removeEventListener('message', messageHandler);

                    if (!hasSelected) {
                        layer.msg('é€‰ä¸­èŠ‚ç‚¹è¶…æ—¶,è¯·æ‰‹åŠ¨ç‚¹å‡»èŠ‚ç‚¹');
                    }
                }, 8000);
            } else {
                layer.close(loadingIndex);
                layer.msg('å›¾è¡¨åŠ è½½å¤±è´¥');
            }
        } else {
            layer.close(loadingIndex);
            layer.msg('æœªæ‰¾åˆ°ç›®æ ‡æ™ºèƒ½ä½“å…ƒç´ ');
        }
    }

    /**
     * åˆå§‹åŒ–è·¨iframeé€šä¿¡ç›‘å¬
     * éœ€è¦åœ¨initEventListenerså‡½æ•°ä¸­è°ƒç”¨
     */
    function initIframeCommunication() {
        // ç›‘å¬æ¥è‡ªnode_graph_web.htmlçš„æ¶ˆæ¯
        window.addEventListener('message', function(event) {
            // å®‰å…¨æ£€æŸ¥ï¼šç¡®ä¿æ¶ˆæ¯æ¥æºå¯ä¿¡
            if (event.origin !== window.location.origin) {
                return;
            }

            const data = event.data;
            if (!data || typeof data !== 'object') {
                return;
            }

            switch (data.type) {
                case 'nodeSelected':
                    // èŠ‚ç‚¹é€‰ä¸­æˆåŠŸçš„åé¦ˆ
                    break;

                case 'nodeSelectFailed':
                    // èŠ‚ç‚¹é€‰ä¸­å¤±è´¥çš„åé¦ˆ
                    console.error('èŠ‚ç‚¹é€‰ä¸­å¤±è´¥:', data.error);
                    layer.msg('é€‰ä¸­èŠ‚ç‚¹å¤±è´¥ï¼š' + (data.error || 'æœªçŸ¥é”™è¯¯'));
                    break;

                case 'graphReady':
                    // å›¾è¡¨å‡†å¤‡å°±ç»ª
                    break;

                default:
                    console.log('æ”¶åˆ°æœªçŸ¥æ¶ˆæ¯ç±»å‹:', data.type);
            }
        });
    }

    /**
     * ç»‘å®šå†å²è®°å½•æ»šåŠ¨äº‹ä»¶
     */
    function bindHistoryScrollEvent() {
        $('#historyContent').off('scroll.historyLoad').on('scroll.historyLoad', function() {
            const container = $(this);
            const scrollTop = container.scrollTop();
            const scrollHeight = container.prop('scrollHeight');
            const containerHeight = container.height();

            // å½“æ»šåŠ¨åˆ°åº•éƒ¨é™„è¿‘50pxæ—¶è§¦å‘åŠ è½½æ›´å¤š
            if (scrollHeight - scrollTop - containerHeight <= 50) {
                if (!objdata.historyLoading && !objdata.historyNoMore) {
                    loadNodeHistory(true);
                }
            }
        });
    }

    /**
     * æ˜¾ç¤ºå†å²è®°å½•åŠ è½½æ•ˆæœ
     */
    function showHistoryLoading(isLoadMore) {
        const historyContent = $('#historyContent');

        if (isLoadMore) {
            // åŠ è½½æ›´å¤šæ—¶åœ¨åº•éƒ¨æ˜¾ç¤ºloading
            historyContent.find('.history-loading').remove();
            historyContent.append(`
                <div class="history-loading">
                    <div class="loading-spinner"></div>
                    <span>åŠ è½½ä¸­...</span>
                </div>
            `);
        } else {
            // é¦–æ¬¡åŠ è½½æ—¶æ˜¾ç¤ºæ•´ä½“loading
            historyContent.html(`
                <div class="history-loading full-loading">
                    <div class="loading-spinner"></div>
                    <span>åŠ è½½å†å²è®°å½•ä¸­...</span>
                </div>
            `);
        }
    }

    /**
     * éšè—å†å²è®°å½•åŠ è½½æ•ˆæœ
     */
    function hideHistoryLoading() {
        $('#historyContent .history-loading').remove();
    }

    /**
     * æ˜¾ç¤ºæ²¡æœ‰æ›´å¤šæ•°æ®çš„æç¤º
     */
    function showNoMoreTip() {
        const historyContent = $('#historyContent');

        // ç§»é™¤ç°æœ‰çš„æç¤º
        historyContent.find('.history-no-more').remove();

        // æ·»åŠ åˆ°åº•äº†çš„æç¤º
        historyContent.append(`
            <div class="history-no-more">
                <span>â€”â€” å·²æ˜¾ç¤ºå…¨éƒ¨å†å²è®°å½• â€”â€”</span>
            </div>
        `);
    }

    /**
     * æ¸²æŸ“ç©ºå†å²è®°å½•çŠ¶æ€
     */
    function renderEmptyHistory() {
        const historyContent = $('#historyContent');
        historyContent.html(`
            <div class="history-empty">
                <div class="empty-icon">ğŸ“</div>
                <div class="empty-text">æš‚æ— å†å²è®°å½•</div>
                <div class="empty-desc">èŠ‚ç‚¹æ“ä½œè®°å½•ä¼šåœ¨è¿™é‡Œæ˜¾ç¤º</div>
            </div>
        `);
    }

    /**
     * åˆ·æ–°å†å²è®°å½•
     */
    function refreshHistory() {
        // é‡ç½®åˆ†é¡µç›¸å…³å˜é‡
        objdata.historyPageNum = 1;
        objdata.historyNoMore = false;
        objdata.historyLastData = null;
        objdata.nodeClickLog = [];

        // é‡æ–°åŠ è½½
        loadNodeHistory();
    }

    /**
     * åˆå§‹åŒ–äº‹ä»¶ç›‘å¬å™¨ - æ›´æ–°ç‰ˆæœ¬
     */
    function initEventListeners() {
        // å†å²è®°å½•å±•å¼€/æ”¶èµ·
        $('#expandBtn').off('click').on('click', function() {
            const btn = $(this);
            const content = $('#historyContent');

            objdata.historyExpanded = !objdata.historyExpanded;

            if (objdata.historyExpanded) {
                initNodeHistory();  // ç‚¹å‡»å±•å¼€å¾—åˆ°æœ€æ–°çš„æ•°æ®ï¼Œä¸ç”¨åœ¨ä¸€å¼€å§‹åˆå§‹åŒ–
                content.addClass('show');
                setTimeout(function() {
                    btn.addClass('expanded');
                }, 1000)

                btn.html('æ”¶èµ· <img src="../../images/agentimg/downimg.png">');
            } else {
                content.removeClass('show');
                btn.removeClass('expanded');
                btn.html('å±•å¼€ <img src="../../images/agentimg/downimg.png">');
            }
        });

        // å·¦ä¾§é¢æ¿æ”¶ç¼©/å±•å¼€ (Webç«¯)
        $('#collapseBtn').off('click').on('click', function() {
            if (objdata.pointType !== 'H5') {
                const leftPanel = $('#leftPanel');

                objdata.leftPanelCollapsed = !objdata.leftPanelCollapsed;

                if (objdata.leftPanelCollapsed) {
                    leftPanel.addClass('collapsed');
                } else {
                    leftPanel.removeClass('collapsed');
                }
            }
        });

        // çª—å£å¤§å°æ”¹å˜æ—¶é‡æ–°è®¡ç®—å¸ƒå±€
        $(window).off('resize.agentDetail').on('resize.agentDetail', function() {
            if ($(window).width() <= 768) {
                if (objdata.pointType !== 'H5') {
                    $('#leftPanel').removeClass('collapsed');
                    objdata.leftPanelCollapsed = false;
                }
            }
        });

        // H5ç«¯é˜»æ­¢é¡µé¢æ»šåŠ¨ç©¿é€
        if (objdata.pointType === 'H5') {
            $('body').on('touchmove', '.h5-overlay', function(e) {
                e.preventDefault();
            });
        }

        // åˆå§‹åŒ–è·¨iframeé€šä¿¡ - æ–°æ·»åŠ çš„
        initIframeCommunication();
    }

    // æš´éœ²å…¨å±€ç®¡ç†å¯¹è±¡
    window.agentDetailManager = {
        getCurrentAgent: function() {
            return objdata.currentAgent;
        },
        getAgentId: function() {
            return objdata.agent_id;
        },
        getPointType: function() {
            return objdata.pointType;
        },
        setPointType: function(type) {
            objdata.pointType = type;
            applyPointTypeStyle();
        },
        refreshAgent: function() {
            if (objdata.agent_id) {
                window.location.reload();
            }
        },
        refreshHistory: refreshHistory,
        goBack: goBackToList,
        toggleH5LeftPanel: toggleH5LeftPanel,
        showH5LeftPanel: showH5LeftPanel,
        hideH5LeftPanel: hideH5LeftPanel
    };
});
```



## node_graph_web.js

```js
/**
 * ä½œè€…:gongxi
 * æ—¶é—´:2025-09-11
 * æ™ºèƒ½ä½“èŠ‚ç‚¹å›¾è¡¨ - ä¼˜åŒ–ç‰ˆ
 * ä¿®å¤: æ—¶é—´é€‰æ‹©åèŠ‚ç‚¹çŠ¶æ€é—®é¢˜ã€è¾¹æ¡†é¢œè‰²ç»Ÿä¸€ã€iframeç®¡ç†ä¼˜åŒ–
 * æ›´æ–°:2025-10-10 å…¨é¢ä¼˜åŒ–
 */

require.config({
    paths: {
        jquery: '../../sys/jquery',
        system: '../../sys/system',
        layui: "../../layui-btkj/layui",
        layuicommon: "../../sys/layuicommon",
        g6: "../../plugin/antv/g6/g6.min",
        contentRenderer: './content_renderer'
    },
    shim: {
        "system": { deps: ["jquery"] },
        "layui": { deps: ["jquery", "system"] },
        "layuicommon": { deps: ["jquery", "layui"] },
        "g6": { deps: ["jquery"] }
    },
    waitSeconds: 0
});

// å…¨å±€æ•°æ®å¯¹è±¡
objdata = {
    agent_id: null,
    selected_time: null,        // æ·»åŠ :é€‰ä¸­çš„æ—¶é—´
    time_granularity: null,     // æ·»åŠ :æ—¶é—´ç²’åº¦
    allNodeData: [],
    nodeRelationDataHTML: null,
    currentGraph: null,
    isLoading: false,
    isInitialized: false,
    isDragging: false,
    dragStartTime: 0,
    clickedNodes: new Set(),
    applicable: {
        applicable_end: '',
        applicable_role: ''
    },
    pointType: '',
    htmlIframeContainers: new Map(),
    sortedNodeIds: []
};

require(["jquery", "system", "layui", "contentRenderer"], function () {
    layui.use(['layer'], function () {
        initNodeGraph();
        initEventListeners();
        initCrossIframeCommunication();
    });
});

/**
 * è·å–å½“å‰ç«¯ç‚¹ç±»å‹çš„é…ç½®
 */
function getCurrentStyleConfig(configPath) {
    return ContentRenderer.getNodeStyleConfig(configPath, objdata.pointType);
}

/**
 * åˆå§‹åŒ–èŠ‚ç‚¹å›¾è¡¨
 */
function initNodeGraph() {
    const agentId = Arg("agent_id") || Arg("id");
    const pointType = Arg("pointType");
    const applicable_end = Arg("applicable_end");
    const applicable_role = Arg("applicable_role");
    const selected_time = Arg("selected_time");           // è·å–æ—¶é—´å‚æ•°
    const time_granularity = Arg("time_granularity");     // è·å–æ—¶é—´ç²’åº¦

    objdata.pointType = pointType;
    objdata.selected_time = selected_time;
    objdata.time_granularity = time_granularity;

    // ä¿®å¤:æ­£ç¡®è®¾ç½®æƒé™å‚æ•°
    if (applicable_end) {
        objdata.applicable.applicable_end = [applicable_end];
    }
    if (applicable_role) {
        objdata.applicable.applicable_role = [applicable_role];
    }

    if (!agentId) {
        showEmptyState('ç¼ºå°‘å¿…è¦å‚æ•°:agent_id');
        return;
    }

    objdata.agent_id = agentId;
    setBackgroundStyle();
    loadNodeData();
}

/**
 * è®¾ç½®èƒŒæ™¯æ ·å¼
 */
function setBackgroundStyle() {
    const container = $('.graph-canvas');
    const pointType = objdata.pointType === 'H5' ? 'H5' : 'web';
    const bgConfig = ContentRenderer.NODE_STYLE_CONFIG.backgroundGrid[pointType];

    container.css({
        'background': bgConfig.background,
        'background-size': bgConfig.backgroundSize,
        'background-position': bgConfig.backgroundPosition
    });
}

/**
 * åŠ è½½èŠ‚ç‚¹æ•°æ®
 */
function loadNodeData() {
    showLoading();

    const data = {
        "agent_id": [objdata.agent_id]
    };

    // å¦‚æœæœ‰æ—¶é—´å‚æ•°,æ·»åŠ åˆ°æŸ¥è¯¢æ¡ä»¶ TODO
  /*  if (objdata.selected_time) {
        data.selected_time = objdata.selected_time;
    }
    if (objdata.time_granularity) {
        data.time_granularity = objdata.time_granularity;
    }*/

    $.sm(function (re, err) {
        if (err) {
            hideLoading();
            layer.msg(err);
            showEmptyState('åŠ è½½èŠ‚ç‚¹æ•°æ®å¤±è´¥,è¯·é‡è¯•');
        } else {
            objdata.allNodeData = re || [];
            prepareAndRenderGraph();
        }
    }, ["w_agent_node_plugin.getList", $.msgwhere(data)]);
}

/**
 * å‡†å¤‡å¹¶æ¸²æŸ“å›¾è¡¨
 */
function prepareAndRenderGraph() {
    // 1. é”€æ¯æ—§å›¾è¡¨
    if (objdata.currentGraph && !objdata.currentGraph.destroyed) {
        objdata.currentGraph.destroy();
        objdata.currentGraph = null;
    }

    // 2. æ¸…ç†æ‰€æœ‰iframeèµ„æº
    ContentRenderer.IframeManager.destroyAll();
    clearAllIframeContainers();

    // 3. é‡ç½®çŠ¶æ€
    objdata.clickedNodes.clear();
    objdata.isInitialized = false;

    // 4. å‡†å¤‡æ•°æ®
    objdata.nodeRelationDataHTML = prepareRelationDataHTML(objdata.allNodeData);
    hideLoading();

    if (!objdata.nodeRelationDataHTML || objdata.nodeRelationDataHTML.nodes.length === 0) {
        showEmptyState('è¯¥æ™ºèƒ½ä½“æš‚æ— èŠ‚ç‚¹æ•°æ®');
        return;
    }

    // 5. åˆ›å»ºæ–°å›¾è¡¨
    require(['g6'], function(G6) {
        createNodeRelationGraph(G6, objdata.nodeRelationDataHTML);
        hideEmptyState();
        updateNodeCount();

        objdata.isInitialized = true;

        // 6. å»¶è¿Ÿæ›´æ–°iframeä½ç½®,ç¡®ä¿DOMå®Œå…¨æ¸²æŸ“
        setTimeout(() => {
            updateAllIframePositions();

            // 7. é€šçŸ¥çˆ¶é¡µé¢å›¾è¡¨å·²å°±ç»ª
            notifyParentGraphReady();
        }, 500);
    });
}


/**
 * å‡†å¤‡èŠ‚ç‚¹å…³ç³»æ•°æ®
 */
function prepareRelationDataHTML(nodeList) {
    if (!nodeList || nodeList.length === 0) {
        return { nodes: [], edges: [] };
    }

    const nodes = [];
    const edges = [];
    const ids = [];
    const nodeMap = new Map();

    nodeList.forEach(node => {
        nodeMap.set(node.id, node);
        ids.push(node.id);
    });

    // æ’åºèŠ‚ç‚¹ID
    objdata.sortedNodeIds = ids.sort((a, b) => a - b).map(id => id.toString());

    // å‡†å¤‡èŠ‚ç‚¹æ•°æ®
    nodeList.forEach(node => {
        const nodeName = node.node_name || `èŠ‚ç‚¹${node.id}`;
        const nodeSize = getCurrentStyleConfig('size');

        nodes.push({
            id: node.id.toString(),
            label: nodeName,
            size: nodeSize,
            type: 'unified-custom-node',
            nodeData: node,
            style: {
                fill: 'transparent',
                stroke: 'transparent'
            }
        });
    });

    // å‡†å¤‡è¾¹æ•°æ®
    nodeList.forEach(node => {
        if (node.parent_id && node.parent_id !== '0' && nodeMap.has(parseInt(node.parent_id))) {
            edges.push({
                source: node.parent_id.toString(),
                target: node.id.toString(),
                sourceAnchor: 1,
                targetAnchor: 0,
                type: 'polyline',
                style: {
                    stroke: '#1890ff',
                    lineWidth: 2,
                    strokeOpacity: 0.8,
                    endArrow: {
                        path: 'M 0,0 L 8,4 L 8,-4 Z',
                        fill: '#1890ff',
                        strokeOpacity: 1
                    }
                }
            });
        }
    });

    return { nodes, edges };
}

/**
 * åˆ›å»ºèŠ‚ç‚¹å…³ç³»å›¾
 */
function createNodeRelationGraph(G6, data) {
    const container = $('#nodeGraphContainer');

    // åˆ›å»ºHTML iframeå®¹å™¨
    createHtmlIframeContainer(container[0]);

    // æ³¨å†Œç»Ÿä¸€çš„è‡ªå®šä¹‰èŠ‚ç‚¹
    G6.registerNode('unified-custom-node', {
        draw(cfg, group) {
            return drawUnifiedNode(cfg, group);
        },
        afterDraw(cfg, group) {
            const nodeData = cfg.nodeData;
            // ä¿®å¤:ç¡®ä¿æƒé™æ£€æŸ¥æ­£ç¡®
            if (ContentRenderer.needsHtmlRendering(nodeData) &&
                checkNodePermission(nodeData) &&
                nodeData.status === 0) {
                createNodeIframe(cfg);
            }
        },
        getAnchorPoints() {
            return [
                [0.5, 0],    // é¡¶éƒ¨ä¸­å¿ƒ
                [0.5, 1],    // åº•éƒ¨ä¸­å¿ƒ
            ];
        }
    });

    const graphConfig = getGraphConfig(container);
    const graph = new G6.Graph(graphConfig);
    objdata.currentGraph = graph;

    bindGraphEvents(graph);

    graph.data(data);
    graph.render();

    setTimeout(() => {
        if (graph && !graph.destroyed) {
            graph.fitView(30);
        }
        updateAllIframePositions();
    }, 300);

    initGraphResize(graph);
}


/**
 * åˆ›å»ºHTML iframeå®¹å™¨
 */
function createHtmlIframeContainer(graphContainer) {
    const oldContainer = document.getElementById('html-iframe-container');
    if (oldContainer) {
        oldContainer.remove();
    }

    const iframeContainer = document.createElement('div');
    iframeContainer.id = 'html-iframe-container';
    iframeContainer.style.cssText = `
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        z-index: 1000;
    `;

    graphContainer.style.position = 'relative';
    graphContainer.appendChild(iframeContainer);
}

/**
 * åˆ›å»ºèŠ‚ç‚¹iframe
 */
function createNodeIframe(cfg) {
    const nodeData = cfg.nodeData;
    const nodeId = cfg.id;

    // æ£€æŸ¥æ˜¯å¦å·²åˆ›å»º
    if (objdata.htmlIframeContainers.has(nodeId)) {
        // console.log('iframeå·²å­˜åœ¨,è·³è¿‡åˆ›å»º:', nodeId);
        return;
    }

    const size = cfg.size || getCurrentStyleConfig('size');
    const titleHeight = getCurrentStyleConfig('titleHeight');

    // èŠ‚ç‚¹çŠ¶æ€æ£€æŸ¥
    const isDisabled = nodeData.status !== 0;
    const hasPermission = checkNodePermission(nodeData);

    if (!hasPermission || isDisabled) {
        // console.log('èŠ‚ç‚¹æ— æƒé™æˆ–ç¦ç”¨,è·³è¿‡iframeåˆ›å»º:', nodeId, {hasPermission, isDisabled});
        return;
    }

    // åˆ›å»ºå®¹å™¨
    const tempContainer = document.createElement('div');
    tempContainer.id = `iframe-container-${nodeId}`;
    tempContainer.style.cssText = `
        position: absolute;
        width: ${size[0] - 2}px;
        height: ${size[1] - titleHeight - 1}px;
        pointer-events: auto;
        z-index: 1001;
        display: none;
    `;

    const iframeContainer = document.getElementById('html-iframe-container');
    if (iframeContainer) {
        iframeContainer.appendChild(tempContainer);

        // ä½¿ç”¨ContentRendereråˆ›å»ºiframe
        const isComplete = ContentRenderer.isCompleteHtml(nodeData.content);
        ContentRenderer.IframeManager.create(tempContainer.id, nodeData.content, isComplete);

        // å­˜å‚¨å®¹å™¨å¼•ç”¨
        objdata.htmlIframeContainers.set(nodeId, tempContainer);

        // console.log('iframeåˆ›å»ºæˆåŠŸ:', nodeId);

        // åˆå§‹ä½ç½®æ›´æ–°
        setTimeout(() => {
            updateIframePosition(nodeId);
        }, 100);
    }
}


/**
 * ç»˜åˆ¶ç»Ÿä¸€çš„è‡ªå®šä¹‰èŠ‚ç‚¹ - ä¿®å¤è¾¹æ¡†é¢œè‰²é—®é¢˜
 */
function drawUnifiedNode(cfg, group) {
    const nodeData = cfg.nodeData;
    const size = cfg.size || getCurrentStyleConfig('size');
    const width = size[0];
    const height = size[1];

    // èŠ‚ç‚¹çŠ¶æ€
    const isDisabled = nodeData.status !== 0;
    const hasPermission = checkNodePermission(nodeData);
    const isClicked = objdata.clickedNodes.has(nodeData.id.toString());
    const isHtmlNode = ContentRenderer.needsHtmlRendering(nodeData);

    // ç»Ÿä¸€è¾¹æ¡†é¢œè‰²é…ç½®
    const colors = ContentRenderer.NODE_STYLE_CONFIG.colors;
    const shadowColor = isClicked ? colors.shadowClicked : colors.shadowDefault;

    // ä¿®å¤:ç»Ÿä¸€ä½¿ç”¨ç›¸åŒçš„è¾¹æ¡†é¢œè‰²é…ç½®
    const strokeColor = (isDisabled || !hasPermission) ? colors.nodeBorderDisabled : colors.nodeBorder;
    const fillColor = isHtmlNode ? 'transparent' :
        ((isDisabled || !hasPermission) ? colors.nodeBackgroundDisabled : colors.nodeBackground);

    // åˆ›å»ºä¸»å®¹å™¨ - æ‰€æœ‰èŠ‚ç‚¹ä½¿ç”¨ç»Ÿä¸€è¾¹æ¡†
    const mainRect = group.addShape('rect', {
        attrs: {
            x: -width / 2,
            y: -height / 2,
            width: width,
            height: height,
            fill: fillColor,
            stroke: strokeColor,
            strokeWidth: 5,
            cursor: hasPermission && !isDisabled ? 'pointer' : 'not-allowed',
            shadowColor: shadowColor,
            shadowBlur: 8,
            shadowOffsetX: 2,
            shadowOffsetY: 2,
            radius: 8,
            opacity: isDisabled || !hasPermission ? 0.8 : 1
        },
        name: 'main-rect'
    });

    const titleHeight = getCurrentStyleConfig('titleHeight');

    if (!isHtmlNode) {
        renderNodeContent(group, nodeData, width, height, titleHeight, isDisabled || !hasPermission);
    }

    renderNodeTitle(group, cfg, width, height, titleHeight, hasPermission, isDisabled, isHtmlNode);

    if (!hasPermission) {
        group.addShape('text', {
            attrs: {
                x: width / 2 - (isHtmlNode ? 15 : 10),
                y: -height / 2 + (isHtmlNode ? 15 : 10),
                text: 'ğŸ”’',
                fontSize: getCurrentStyleConfig('fontSize.lockIcon'),
                textAlign: 'center',
                textBaseline: 'middle',
            },
            name: 'lock-icon'
        });
    }

    return mainRect;
}

/**
 * æ¸²æŸ“èŠ‚ç‚¹å†…å®¹(éHTMLèŠ‚ç‚¹)
 */
function renderNodeContent(group, nodeData, width, height, titleHeight, isDisabled) {
    const contentHeight = height - titleHeight;
    const contentY = -height / 2;
    const colors = ContentRenderer.NODE_STYLE_CONFIG.colors;

    const logoInfo = ContentRenderer.shouldShowLogo(nodeData);

    if (logoInfo.showLogo) {
        group.addShape('image', {
            attrs: {
                x: -width / 2,
                y: contentY,
                width: width,
                height: contentHeight,
                img: logoInfo.logoPath,
                cursor: !isDisabled ? 'pointer' : 'not-allowed',
                radius: 8,
                opacity: isDisabled ? 0.6 : 1,
            },
            name: 'logo-image'
        });
        return;
    }

    const pluginConfig = ContentRenderer.getPluginTypeConfig(nodeData.plugin_type);
    let displayText = '';

    if (nodeData.pld === 0) {
        displayText = 'é»˜è®¤å†…å®¹';
    } else {
        displayText = nodeData.content ?
            (nodeData.content.length > 25 ? nodeData.content.substring(0, 25) + '...' : nodeData.content) :
            'æ— å†…å®¹';
    }

    group.addShape('text', {
        attrs: {
            x: 0,
            y: contentY + contentHeight / 2,
            text: displayText,
            fontSize: getCurrentStyleConfig('fontSize.content'),
            fill: isDisabled ? colors.contentTextDisabled : pluginConfig.textColor,
            textAlign: 'center',
            textBaseline: 'middle',
            cursor: 'pointer',
        },
        name: 'content-text'
    });
}

/**
 * æ¸²æŸ“èŠ‚ç‚¹æ ‡é¢˜
 */
function renderNodeTitle(group, cfg, width, height, titleHeight, hasPermission, isDisabled, isHtmlNode) {
    const colors = ContentRenderer.NODE_STYLE_CONFIG.colors;

    group.addShape('rect', {
        attrs: {
            x: -width / 2,
            y: height / 2 - titleHeight,
            width: width,
            height: titleHeight,
            fill: hasPermission && !isDisabled ? colors.nodeBackground : colors.nodeBackgroundDisabled,
            cursor: hasPermission && !isDisabled ? 'pointer' : 'not-allowed',
            stroke: colors.titleBorder,
            strokeWidth: 1,
            opacity: isDisabled || !hasPermission ? 0.6 : 1,
            radius: isHtmlNode ? [0, 0, 8, 8] : 8,
            textBaseline: 'top'
        },
        name: 'name-bg'
    });

    group.addShape('text', {
        attrs: {
            x: 0,
            y: height / 2 - titleHeight / 2,
            text: cfg.label,
            fontSize: getCurrentStyleConfig('fontSize.title'),
            fontWeight: 'bold',
            fill: isDisabled || !hasPermission ? colors.titleTextDisabled : colors.titleText,
            textAlign: 'center',
            textBaseline: 'middle',
            cursor: hasPermission && !isDisabled ? 'pointer' : 'not-allowed'
        },
        name: 'name-text'
    });
}


/**
 * æ›´æ–°å•ä¸ªiframeä½ç½®
 */
function updateIframePosition(nodeId) {
    if (!objdata.currentGraph || objdata.currentGraph.destroyed) return;

    const container = objdata.htmlIframeContainers.get(nodeId);
    if (!container) return;

    const node = objdata.currentGraph.findById(nodeId);
    if (!node) return;

    const model = node.getModel();
    const size = model.size || getCurrentStyleConfig('size');
    const titleHeight = getCurrentStyleConfig('titleHeight');
    const zoom = objdata.currentGraph.getZoom();

    const canvasPoint = objdata.currentGraph.getCanvasByPoint(model.x || 0, model.y || 0);

    const scaledWidth = (size[0] - 2) * zoom;
    const scaledHeight = (size[1] - titleHeight - 1) * zoom;

    const finalX = canvasPoint.x - scaledWidth/2;
    const finalY = canvasPoint.y - (size[1] * zoom)/2;

    container.style.left = finalX + 'px';
    container.style.top = finalY + 'px';
    container.style.width = scaledWidth + 'px';
    container.style.height = scaledHeight + 'px';
    container.style.display = zoom < 0.2 ? 'none' : 'block';
}

/**
 * æ›´æ–°æ‰€æœ‰iframeä½ç½®
 */
function updateAllIframePositions() {
    objdata.htmlIframeContainers.forEach((container, nodeId) => {
        updateIframePosition(nodeId);
    });
}

/**
 * æ¸…ç†æ‰€æœ‰iframeå®¹å™¨
 */
function clearAllIframeContainers() {
    objdata.htmlIframeContainers.forEach((container, nodeId) => {
        if (container && container.parentNode) {
            container.parentNode.removeChild(container);
        }
    });
    objdata.htmlIframeContainers.clear();
}

/**
 * è·å–å›¾è¡¨é…ç½®
 */
function getGraphConfig(container) {
    const pointType = objdata.pointType === 'H5' ? 'H5' : 'web';
    const layoutConfig = ContentRenderer.NODE_STYLE_CONFIG.layout;

    return {
        container: container[0],
        width: container[0].clientWidth || 800,
        height: container[0].clientHeight || 600,
        renderer: 'canvas',
        pixelRatio: window.devicePixelRatio || 2,
        modes: {
            default: pointType === 'H5' ? [
                'drag-canvas',
                'zoom-canvas',
            ] : [
                'drag-canvas',
                'zoom-canvas',
                'drag-node'
            ]
        },
        defaultNode: {
            type: 'unified-custom-node',
            size: getCurrentStyleConfig('size'),
            draggable: true
        },
        defaultEdge: {
            type: 'polyline',
            style: {
                stroke: '#1890ff',
                lineWidth: 2,
                strokeOpacity: 0.8,
                endArrow: {
                    path: 'M 0,0 L 8,4 L 8,-4 Z',
                    fill: '#1890ff'
                }
            }
        },
        layout: {
            type: 'dagre',
            rankdir: layoutConfig.rankdir[pointType],
            align: 'DL',
            nodesep: layoutConfig.nodesep[pointType],
            ranksep: layoutConfig.ranksep[pointType],
            nodeOrder: objdata.sortedNodeIds
        },
        fitView: true,
        fitViewPadding: layoutConfig.fitViewPadding[pointType]
    };
}

/**
 * ç»‘å®šå›¾è¡¨äº‹ä»¶
 */
function bindGraphEvents(graph) {
    // èŠ‚ç‚¹ç‚¹å‡»äº‹ä»¶
    graph.on('node:click', function(e) {
        const timeSinceDragStart = Date.now() - objdata.dragStartTime;
        if (objdata.isDragging && timeSinceDragStart > 200) return;

        const nodeModel = e.item.getModel();
        const nodeData = nodeModel.nodeData;

        if (isClickOnIframeArea(e, nodeModel)) {
            return;
        }

        const hasPermission = checkNodePermission(nodeData);
        if (!hasPermission) {
            layer.msg('æ‚¨æ²¡æœ‰æƒé™è®¿é—®æ­¤èŠ‚ç‚¹');
            return;
        }

        if (nodeData.status !== 0) {
            layer.msg('è¯¥èŠ‚ç‚¹æš‚ä¸å¯ç”¨');
            return;
        }

        selectedNode(nodeData, e.item);
    });

    // æ‹–æ‹½äº‹ä»¶
    graph.on('node:dragstart', function() {
        objdata.isDragging = true;
        objdata.dragStartTime = Date.now();
    });

    graph.on('node:drag', function() {
        requestAnimationFrame(() => {
            updateAllIframePositions();
        });
    });

    graph.on('node:dragend', function() {
        setTimeout(() => {
            objdata.isDragging = false;
            updateAllIframePositions();
        }, 150);
    });

    // ç”»å¸ƒæ‹–æ‹½
    graph.on('canvas:dragstart', function() {
        objdata.isDragging = true;
    });

    graph.on('canvas:drag', function() {
        requestAnimationFrame(() => {
            updateAllIframePositions();
        });
    });

    graph.on('canvas:dragend', function() {
        setTimeout(() => {
            objdata.isDragging = false;
            updateAllIframePositions();
        }, 100);
    });

    // ç¼©æ”¾äº‹ä»¶
    graph.on('wheelzoom', function() {
        requestAnimationFrame(() => {
            updateAllIframePositions();
        });
    });

    // ç›‘å¬å›¾è¡¨çš„çŸ©é˜µå˜æ¢äº‹ä»¶
    graph.on('viewportchange', function() {
        requestAnimationFrame(() => {
            updateAllIframePositions();
        });
    });
}

/**
 * æ£€æŸ¥ç‚¹å‡»æ˜¯å¦åœ¨iframeåŒºåŸŸå†…
 */
function isClickOnIframeArea(e, nodeModel) {
    const nodeData = nodeModel.nodeData;
    const isHtmlNode = ContentRenderer.needsHtmlRendering(nodeData);

    if (!isHtmlNode) return false;

    const size = nodeModel.size || getCurrentStyleConfig('size');
    const titleHeight = getCurrentStyleConfig('titleHeight');

    const clickX = e.canvasX - nodeModel.x;
    const clickY = e.canvasY - nodeModel.y;

    const inXRange = clickX >= -size[0]/2 + 2 && clickX <= size[0]/2 - 2;
    const inYRange = clickY >= -size[1]/2 + 2 && clickY <= size[1]/2 - titleHeight - 2;

    return inXRange && inYRange;
}

/**
 * æ£€æŸ¥èŠ‚ç‚¹æƒé™
 */
function checkNodePermission(nodeData) {
    // 1. å¦‚æœèŠ‚ç‚¹æ²¡æœ‰è®¾ç½®æƒé™,é»˜è®¤æœ‰æƒé™
    if (!nodeData.applicable_end && !nodeData.applicable_role) {
        return true;
    }

    // 2. å¦‚æœèŠ‚ç‚¹è®¾ç½®ä¸º"å…¨éƒ¨",æœ‰æƒé™
    if (nodeData.applicable_end === 'å…¨éƒ¨' && nodeData.applicable_role === 'å…¨éƒ¨') {
        return true;
    }

    // 3. å¦‚æœå½“å‰ç”¨æˆ·æ²¡æœ‰æƒé™ä¿¡æ¯,é»˜è®¤æ— æƒé™
    if ((!objdata.applicable.applicable_end || objdata.applicable.applicable_end.length === 0) &&
        (!objdata.applicable.applicable_role || objdata.applicable.applicable_role.length === 0)) {
        return false;
    }

    let hasEndPermission = true;
    let hasRolePermission = true;

    // 4. æ£€æŸ¥ç«¯æƒé™
    if (nodeData.applicable_end && nodeData.applicable_end !== 'å…¨éƒ¨') {
        const nodeEnds = nodeData.applicable_end.split(',').map(item => item.trim());
        hasEndPermission = nodeEnds.some(end =>
            objdata.applicable.applicable_end &&
            objdata.applicable.applicable_end.includes(end)
        );
    }

    // 5. æ£€æŸ¥è§’è‰²æƒé™
    if (nodeData.applicable_role && nodeData.applicable_role !== 'å…¨éƒ¨') {
        const nodeRoles = nodeData.applicable_role.split(',').map(item => item.trim());
        hasRolePermission = nodeRoles.some(role =>
            objdata.applicable.applicable_role &&
            objdata.applicable.applicable_role.includes(role)
        );
    }

    return hasEndPermission && hasRolePermission;;
}

/**
 * é€‰ä¸­èŠ‚ç‚¹
 */
function selectedNode(nodeData, nodeItem) {
    objdata.clickedNodes.add(nodeData.id.toString());

    if (objdata.currentGraph) {
        const colors = ContentRenderer.NODE_STYLE_CONFIG.colors;

        // é‡ç½®æ‰€æœ‰èŠ‚ç‚¹æ ·å¼
        objdata.currentGraph.getNodes().forEach(node => {
            objdata.currentGraph.updateItem(node, {
                style: {
                    stroke: colors.nodeBorder,
                    strokeWidth: 1
                }
            });
        });

        // é«˜äº®é€‰ä¸­èŠ‚ç‚¹
        objdata.currentGraph.updateItem(nodeItem, {
            style: {
                stroke: colors.nodeBorderSelected,
                strokeWidth: 3
            }
        });

        objdata.currentGraph.refresh();

        setTimeout(() => {
            updateAllIframePositions();
        }, 100);
    }

    saveNodeClickLog(nodeData);
    handleNodeAction(nodeData);
}

/**
 * ä¿å­˜èŠ‚ç‚¹ç‚¹å‡»æ—¥å¿—
 */
function saveNodeClickLog(nodeData) {
    $.sm(function (re, err) {
        if (err) {
            console.log(err);
        }
    }, ["node_click_log.add", JSON.stringify({
        agent_id: nodeData.agent_id,
        node_id: nodeData.id,
        oprid: "",
    })]);
}

/**
 * å¤„ç†èŠ‚ç‚¹åŠ¨ä½œ
 */
function handleNodeAction(nodeData) {
    // æ ¹æ®éœ€è¦æ‰©å±•
    if (nodeData.url && nodeData.plugin_type !== 'code') {
        // window.open(nodeData.url, '_blank');
    }
}

/**
 * åˆå§‹åŒ–å›¾è¡¨resize
 */
function initGraphResize(graph) {
    const resizeHandler = () => {
        if (!graph || graph.destroyed) return;

        const container = $('#nodeGraphContainer')[0];
        if (!container || !container.clientWidth || !container.clientHeight) return;

        graph.changeSize(container.clientWidth, container.clientHeight);
        graph.fitView(30);

        setTimeout(() => {
            updateAllIframePositions();
        }, 100);
    };

    window.addEventListener('resize', resizeHandler);

    $(window).on('beforeunload', function() {
        window.removeEventListener('resize', resizeHandler);
        if (graph && !graph.destroyed) {
            graph.destroy();
        }
        ContentRenderer.IframeManager.destroyAll();
        clearAllIframeContainers();
    });
}

/**
 * åˆå§‹åŒ–äº‹ä»¶ç›‘å¬å™¨
 */
function initEventListeners() {
    $(window).on('resize', function() {
        if (objdata.currentGraph && !objdata.currentGraph.destroyed) {
            const container = $('#nodeGraphContainer')[0];
            if (container) {
                objdata.currentGraph.changeSize(container.clientWidth, container.clientHeight);
                objdata.currentGraph.fitView(30);

                setTimeout(() => {
                    updateAllIframePositions();
                }, 100);
            }
        }
    });
}

/**
 * åˆå§‹åŒ–è·¨iframeé€šä¿¡
 */
function initCrossIframeCommunication() {
    window.addEventListener('message', function(event) {
        if (event.origin !== window.location.origin) {
            return;
        }

        const data = event.data;
        if (!data || typeof data !== 'object') {
            return;
        }

        switch (data.type) {
            case 'selectNode':
                handleNodeSelection(data.nodeId, data.nodeName);
                break;
        }
    });

    const sendReadyMessage = () => {
        if (objdata.currentGraph && objdata.isInitialized) {
            window.parent.postMessage({
                type: 'graphReady'
            }, '*');
        } else {
            setTimeout(sendReadyMessage, 200);
        }
    };

    setTimeout(sendReadyMessage, 100);
}

/**
 * å¤„ç†èŠ‚ç‚¹é€‰ä¸­è¯·æ±‚
 */
function handleNodeSelection(nodeId, nodeName) {
    try {
        if (!objdata.currentGraph || objdata.currentGraph.destroyed) {
            throw new Error('å›¾è¡¨æœªåˆå§‹åŒ–æˆ–å·²é”€æ¯');
        }

        const targetNode = objdata.currentGraph.findById(nodeId.toString());
        if (!targetNode) {
            throw new Error(`æœªæ‰¾åˆ°IDä¸º ${nodeId} çš„èŠ‚ç‚¹`);
        }

        const nodeModel = targetNode.getModel();
        const nodeData = nodeModel.nodeData;

        if (!nodeData) {
            throw new Error('èŠ‚ç‚¹æ•°æ®ä¸å­˜åœ¨');
        }

        const hasPermission = checkNodePermission(nodeData);
        if (!hasPermission) {
            throw new Error('æ²¡æœ‰æƒé™è®¿é—®æ­¤èŠ‚ç‚¹');
        }

        if (nodeData.status !== 0) {
            throw new Error('è¯¥èŠ‚ç‚¹æš‚ä¸å¯ç”¨');
        }

        selectedNode(nodeData, targetNode);

        setTimeout(() => {
            updateAllIframePositions();
        }, 100);

        window.parent.postMessage({
            type: 'nodeSelected',
            nodeId: nodeId,
            nodeName: nodeName
        }, '*');

    } catch (error) {
        console.error('é€‰ä¸­èŠ‚ç‚¹å¤±è´¥:', error.message);

        window.parent.postMessage({
            type: 'nodeSelectFailed',
            nodeId: nodeId,
            error: error.message
        }, '*');
    }
}

function notifyParentGraphReady() {
    try {
        window.parent.postMessage({
            type: 'graphReady'
        }, '*');
    } catch (error) {
        console.error('å‘é€å°±ç»ªæ¶ˆæ¯å¤±è´¥:', error);
    }
}

// é¡µé¢çŠ¶æ€ç®¡ç†å‡½æ•°
function showLoading() {
    objdata.isLoading = true;
    $('#loadingOverlay').show();
}

function hideLoading() {
    objdata.isLoading = false;
    $('#loadingOverlay').hide();
}

function showEmptyState(message = 'æš‚æ— èŠ‚ç‚¹æ•°æ®') {
    $('#emptyState').show();
    $('#emptyState .empty-text').text(message);
    updateNodeCount();
}

function hideEmptyState() {
    $('#emptyState').hide();
}

function updateNodeCount() {
    const count = objdata.allNodeData ? objdata.allNodeData.length : 0;
    const name = objdata.pointType === 'H5' ? 'æµç¨‹' : 'èŠ‚ç‚¹';
    $('#nodeCount').text(`å…± ${count} ä¸ª ${name}`);
}
```



# è§£å†³BUG

## iframeä¸æ”¯æŒjs

iframeæ˜¯ä¸æ”¯æŒjsçš„   éœ€è¦è€ƒè™‘ä½¿ç”¨åˆ«çš„æ–¹æ³•

ä¿®æ”¹content_renderer.js

ä½¿ç”¨ Blob  åˆ›å»ºç›¸åº”çš„é“¾æ¥  ç„¶åç»™åˆ°iframe.src

```js
/**
 * ä½œè€…: é¾šå–œ
 * å†…å®¹æ¸²æŸ“å·¥å…·æ¨¡å— - ä¼˜åŒ–ç‰ˆ
 * ç»Ÿä¸€å¤„ç†ä¸åŒç±»å‹çš„æ’ä»¶å†…å®¹æ¸²æŸ“
 * åˆ›å»ºæ—¶é—´: 2025-10-09
 * ä¼˜åŒ–æ—¶é—´: 2025-10-10 ä¿®å¤HTMLåŒ…è£…ã€æƒé™æ£€æŸ¥ã€iframeç®¡ç†é—®é¢˜
 */

require.config({
    paths: {
        jquery: '../../sys/jquery'
    },
    waitSeconds: 0
});

// å…¨å±€å†…å®¹æ¸²æŸ“å™¨å¯¹è±¡
var ContentRenderer = (function() {

    // é»˜è®¤å›¾ç‰‡è·¯å¾„
    const DEFAULT_LOGO_PATH = '../../images/agentimg/agentimg.jpg';

    // æ’ä»¶ç±»å‹é…ç½®
    const PLUGIN_TYPES = {
        superlink: {
            name: 'è¶…é“¾æ¥',
            icon: 'ğŸ”—',
            bgColor: '#e6f7ff',
            borderColor: '#1890ff',
            textColor: '#1890ff'
        },
        http: {
            name: 'HTTPè¯·æ±‚',
            icon: 'ğŸŒ',
            bgColor: '#fff7e6',
            borderColor: '#fa8c16',
            textColor: '#fa8c16'
        },
        code: {
            name: 'ä»£ç æ‰§è¡Œ',
            icon: 'ğŸ’»',
            bgColor: '#f6ffed',
            borderColor: '#52c41a',
            textColor: '#52c41a'
        },
        function: {
            name: 'å‡½æ•°è°ƒç”¨',
            icon: 'âš¡',
            bgColor: '#f9f0ff',
            borderColor: '#722ed1',
            textColor: '#722ed1'
        },
        default: {
            name: 'é»˜è®¤å†…å®¹',
            icon: 'ğŸ“„',
            bgColor: 'transparent',
            borderColor: 'transparent',
            textColor: '#666'
        }
    };

    // èŠ‚ç‚¹æ ·å¼é…ç½®
    const NODE_STYLE_CONFIG = {
        size: {
            H5: [180, 140],
            web: [280, 180]
        },
        titleHeight: {
            H5: 25,
            web: 30
        },
        fontSize: {
            title: { H5: 10, web: 12 },
            content: { H5: 9, web: 11 },
            date: { H5: 10, web: 10 },
            count: { H5: 10, web: 10 },
            mainNumber: { H5: 16, web: 16 },
            subLabel: { H5: 12, web: 12 },
            lockIcon: { H5: 20, web: 26 }
        },
        colors: {
            nodeBorder: '#818181',
            nodeBorderDisabled: '#e8e8e8',
            nodeBorderSelected: '#1890ff',
            nodeBackground: '#fff',
            nodeBackgroundDisabled: '#f5f5f5',
            shadowDefault: 'rgba(24, 144, 255, 0.6)',
            shadowClicked: 'rgba(82, 196, 26, 0.8)',
            titleText: '#0a0a0a',
            titleTextDisabled: '#999',
            contentText: '#565555',
            contentTextDisabled: '#999',
            titleBorder: '#e1e1e1',
            htmlPreviewBorder: '#52c41a',
            htmlPreviewBorderDisabled: '#d9d9d9',
            htmlPreviewBackground: '#fff',
            htmlPreviewBackgroundDisabled: '#f5f5f5'
        },
        layout: {
            nodesep: { H5: 10, web: 40 },
            ranksep: { H5: 10, web: 25 },
            rankdir: { H5: 'TB', web: 'TB' },
            fitViewPadding: { H5: [20, 20, 20, 20], web: [30, 30, 30, 30] }
        },
        backgroundGrid: {
            H5: {
                background: `linear-gradient(90deg, rgba(0,0,0,0.1) 1px, transparent 1px),
                    linear-gradient(180deg, rgba(0,0,0,0.1) 1px, transparent 1px)`,
                backgroundSize: '20px 20px',
                backgroundPosition: '0 0, 0 10px, 10px -10px, -10px 0px'
            },
            web: {
                background: `linear-gradient(45deg, #f8f9fa 25%, transparent 25%),
                              linear-gradient(-45deg, #f8f9fa 25%, transparent 25%),
                              linear-gradient(45deg, transparent 75%, #f8f9fa 75%),
                              linear-gradient(-45deg, transparent 75%, #f8f9fa 75%)`,
                backgroundSize: '20px 20px',
                backgroundPosition: '0 0, 0 10px, 10px -10px, -10px 0px'
            }
        }
    };

    // iframeç®¡ç†å™¨ - ä¼˜åŒ–ç‰ˆ
    const IframeManager = {
        iframes: new Map(),
        blobUrls: new Map(),

        create: function(containerId, htmlContent, isComplete = false) {
            this.destroy(containerId);

            const container = document.getElementById(containerId);
            if (!container) return null;

            const iframe = document.createElement('iframe');
            iframe.style.cssText = `
                width: 100%;
                height: 100%;
                border: none;
                border-radius: 4px;
            `;

            htmlContent = $.dehtmlencode(htmlContent)
            // ä½¿ç”¨ Blob URL æ›¿ä»£ srcdocï¼Œä»¥æ”¯æŒ JavaScript æ‰§è¡Œ
            const finalHtml = isComplete ? htmlContent : this.wrapHtmlContent(htmlContent);
            const blob = new Blob([finalHtml], { type: 'text/html; charset=utf-8' });
            const blobUrl = URL.createObjectURL(blob);

            iframe.src = blobUrl;

            container.appendChild(iframe);
            this.iframes.set(containerId, iframe);
            this.blobUrls.set(containerId, blobUrl);

            return iframe;
        },

        wrapHtmlContent: function(htmlContent) {
            return `
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="utf-8">
                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                    <style>
                        * { margin: 0; padding: 0; box-sizing: border-box; }
                        body { 
                            font-family: Arial, sans-serif; 
                            font-size: 10px; 
                            line-height: 1.2;
                            overflow: hidden;
                            transform: scale(0.8);
                            transform-origin: top left;
                            width: 125%;
                            height: 125%;
                        }
                        img { max-width: 100%; max-height: 40px; }
                        h1, h2, h3, h4, h5, h6 { font-size: 11px; margin: 1px 0; }
                        p, div { font-size: 9px; margin: 1px 0; }
                    </style>
                </head>
                <body>${htmlContent}</body>
                </html>
            `;
        },

        destroy: function(containerId) {
            const iframe = this.iframes.get(containerId);
            if (iframe && iframe.parentNode) {
                iframe.parentNode.removeChild(iframe);
                this.iframes.delete(containerId);
            }
        },

        destroyAll: function() {
            this.iframes.forEach((iframe, id) => {
                this.destroy(id);
            });
            this.iframes.clear();
        }
    };

    /**
     * è·å–èŠ‚ç‚¹æ ·å¼é…ç½®
     */
    function getNodeStyleConfig(configPath, pointType = 'web') {
        const type = pointType === 'H5' ? 'H5' : 'web';
        const pathArray = configPath.split('.');
        let config = NODE_STYLE_CONFIG;

        for (let path of pathArray) {
            config = config[path];
            if (!config) return null;
        }

        if (config && typeof config === 'object' && (config.H5 || config.web)) {
            return config[type] || config.web;
        }

        return config;
    }

    function escapeHtml(text) {
        if (!text) return '';
        const map = {
            '&': '&amp;',
            '<': '&lt;',
            '>': '&gt;',
            '"': '&quot;',
            "'": '&#039;'
        };
        return text.toString().replace(/[&<>"']/g, m => map[m]);
    }

    function isHtmlContent(content) {
        if (!content) return false;
        return /<[^>]+>/.test(content);
    }

    function isCompleteHtml(content) {
        if (!content) return false;
        const trimmed = content.trim().toLowerCase();
        return trimmed.startsWith('<!doctype html') || trimmed.startsWith('<html');
    }

    function getPluginTypeConfig(pluginType) {
        return PLUGIN_TYPES[pluginType] || PLUGIN_TYPES.default;
    }

    function shouldShowLogo(item) {
        if (item.pld === 0 && (!item.logo || item.logo === '')) {
            return { showLogo: true, logoPath: DEFAULT_LOGO_PATH };
        }

        if (item.logo === 0) {
            return { showLogo: true, logoPath: DEFAULT_LOGO_PATH };
        }

        if (item.logo && !item.logo.toString().match(/^\d+$/)) {
            const logoUrl = (typeof ossPrefix !== 'undefined' ? ossPrefix : '') + item.logo;
            return { showLogo: true, logoPath: logoUrl };
        }

        return { showLogo: false, logoPath: null };
    }

    function needsHtmlRendering(item) {
        return item.pld !== 0 &&
            item.plugin_type === 'code' &&
            isHtmlContent(item.content);
    }

    function generateContentHtml(item) {
        const logoInfo = shouldShowLogo(item);

        if (logoInfo.showLogo) {
            return `<img src="${logoInfo.logoPath}" alt="${item.agent_name || item.node_name || 'å›¾ç‰‡'}" onerror="this.src='${DEFAULT_LOGO_PATH}'">`;
        }

        if (item.pld !== 0 && item.content) {
            return generatePluginContentDisplay(item);
        }

        return `<img src="${DEFAULT_LOGO_PATH}" alt="é»˜è®¤å›¾ç‰‡">`;
    }

    function generatePluginContentDisplay(item) {
        const generators = {
            'superlink': generateSuperlinkDisplay,
            'http': generateHttpDisplay,
            'code': generateCodeDisplay,
            'function': generateFunctionDisplay
        };

        const generator = generators[item.plugin_type] || generateDefaultDisplay;
        return generator(item.content, item);
    }

    function generateSuperlinkDisplay(content) {
        const config = getPluginTypeConfig('superlink');
        const displayText = content.length > 60 ? content.substring(0, 60) + '...' : content;

        return `
            <div class="content-display superlink-display">
                <div class="link-icon">${config.icon}</div>
                <span class="link-text">${escapeHtml(displayText)}</span>
            </div>
        `;
    }

    function generateHttpDisplay(content, item) {
        const config = getPluginTypeConfig('http');
        const method = item.http_method || 'GET';
        const apiUrl = item.api_url || content || 'HTTPè¯·æ±‚';
        const displayText = apiUrl.length > 60 ? apiUrl.substring(0, 60) + '...' : apiUrl;

        return `
            <div class="content-display http-display">
                <div class="http-icon">${config.icon}</div>
                <span class="http-method">${method}</span>
                <span class="http-text">${escapeHtml(displayText)}</span>
            </div>
        `;
    }

    function generateCodeDisplay(content, item) {
        if (isHtmlContent(content)) {
            const previewId = `code-preview-${item.id || Math.random().toString(36).substr(2, 9)}`;
            const isComplete = isCompleteHtml(content);

            setTimeout(() => {
                IframeManager.create(previewId, content, isComplete);
            }, 100);

            return `<div class="html-preview-container" id="${previewId}"></div>`;
        } else {
            const displayText = content.length > 60 ? content.substring(0, 60) + '...' : content;
            const config = getPluginTypeConfig('code');

            return `
                <div class="content-display code-display">
                    <div class="code-icon">${config.icon}</div>
                    <span class="code-text">${escapeHtml(displayText)}</span>
                </div>
            `;
        }
    }

    function generateFunctionDisplay(content, item) {
        const config = getPluginTypeConfig('function');
        const funcName = item.function_name || item.func_name || 'Function';
        const funcDesc = content || item.description || 'å‡½æ•°è°ƒç”¨';
        const displayText = funcDesc.length > 60 ? funcDesc.substring(0, 60) + '...' : funcDesc;

        return `
            <div class="content-display function-display">
                <div class="function-icon">${config.icon}</div>
                <div class="function-name">${escapeHtml(funcName)}</div>
                <div class="function-text">${escapeHtml(displayText)}</div>
            </div>
        `;
    }

    function generateDefaultDisplay(content) {
        if (isCompleteHtml(content)) {
            return content;
        }

        if (isHtmlContent(content)) {
            return content;
        }

        const displayText = content.length > 60 ? content.substring(0, 60) + '...' : content;
        return `
            <div class="content-display text-display">
                <span>${escapeHtml(displayText)}</span>
            </div>
        `;
    }

    function generateDetailCardContent(item) {
        const isPluginLogo = item.logo && item.logo.toString().match(/^\d+$/);

        if (!isPluginLogo && item.logo !== 0) {
            if (item.logo) {
                const logoUrl = (typeof ossPrefix !== 'undefined' ? ossPrefix : '') + item.logo;
                return `<img src="${logoUrl}" alt="${item.agent_name || item.node_name || 'å›¾ç‰‡'}" onerror="this.src='${DEFAULT_LOGO_PATH}'">`;
            } else {
                return `<img src="${DEFAULT_LOGO_PATH}" alt="é»˜è®¤å›¾ç‰‡">`;
            }
        } else if (item.logo === 0) {
            return `<img src="${DEFAULT_LOGO_PATH}" alt="é»˜è®¤å›¾ç‰‡">`;
        } else {
            return generatePluginDetailDisplay(item);
        }
    }

    function generatePluginDetailDisplay(item) {
        const detailGenerators = {
            'superlink': generateSuperlinkDetailDisplay,
            'http': generateHttpDetailDisplay,
            'code': generateCodeDetailDisplay,
            'function': generateFunctionDetailDisplay
        };

        const generator = detailGenerators[item.plugin_type] || generateDefaultDetailDisplay;
        return generator(item);
    }

    function generateSuperlinkDetailDisplay(item) {
        const linkText = item.url || item.content || 'è¶…é“¾æ¥';
        const displayText = linkText.length > 15 ? linkText.substring(0, 15) + '...' : linkText;

        return `
            <div class="content-display superlink-display">
                <div class="plugin-icon" style="background: #e6f7ff; color: #1890ff; border: 1px solid #1890ff;">ğŸ”—</div>
                <div class="plugin-text" style="color: #1890ff;">${escapeHtml(displayText)}</div>
            </div>
        `;
    }

    function generateHttpDetailDisplay(item) {
        const method = item.http_method || 'GET';
        const apiUrl = item.api_url || item.content || 'HTTPè¯·æ±‚';
        const displayText = apiUrl.length > 12 ? apiUrl.substring(0, 12) + '...' : apiUrl;

        return `
            <div class="content-display http-display">
                <div class="plugin-icon" style="background: #fff7e6; color: #fa8c16; border: 1px solid #fa8c16;">ğŸŒ</div>
                <div class="plugin-method" style="color: #fa8c16; font-weight: bold; font-size: 11px;">${method}</div>
                <div class="plugin-text" style="color: #666; font-size: 10px;">${escapeHtml(displayText)}</div>
            </div>
        `;
    }

    function generateCodeDetailDisplay(item) {
        const codeText = item.content || 'ä»£ç æ‰§è¡Œ';

        if (isHtmlContent(codeText)) {
            const previewId = `code-preview-${item.id}`;
            const isComplete = isCompleteHtml(codeText);

            setTimeout(() => {
                IframeManager.create(previewId, codeText, isComplete);
            }, 100);

            return `<div class="html-preview-container" id="${previewId}" style="
                width: 100%; 
                height: 100%;              
                border-radius: 4px;
                overflow: hidden;
                background: #fff;
            "></div>`;
        } else {
            const displayText = codeText.length > 10 ? codeText.substring(0, 10) + '...' : codeText;
            return `
                <div class="content-display code-display">
                    <div class="plugin-icon" style="background: #f6ffed; color: #52c41a; border: 1px solid #52c41a; font-family: monospace;">&lt;/&gt;</div>
                    <div class="plugin-text" style="color: #666; font-size: 9px; font-family: monospace;">${escapeHtml(displayText)}</div>
                </div>
            `;
        }
    }

    function generateFunctionDetailDisplay(item) {
        const funcName = item.function_name || item.func_name || 'Function';
        const funcDesc = item.content || item.description || 'å‡½æ•°è°ƒç”¨';
        const displayText = funcDesc.length > 10 ? funcDesc.substring(0, 10) + '...' : funcDesc;

        return `
            <div class="content-display function-display">
                <div class="plugin-icon" style="background: #f9f0ff; color: #722ed1; border: 1px solid #722ed1; font-family: serif;">Æ’</div>
                <div class="plugin-method" style="color: #722ed1; font-weight: bold; font-size: 10px;">${escapeHtml(funcName)}</div>
                <div class="plugin-text" style="color: #666; font-size: 9px;">${escapeHtml(displayText)}</div>
            </div>
        `;
    }

    function generateDefaultDetailDisplay(item) {
        const content = item.content || 'æ— å†…å®¹';

        if (isCompleteHtml(content)) {
            return content;
        }

        if (isHtmlContent(content)) {
            return content;
        }

        const displayText = content.length > 30 ? content.substring(0, 30) + '...' : content;
        return `
            <div class="content-display">
                <span>${escapeHtml(displayText)}</span>
            </div>
        `;
    }

    // æš´éœ²å…¬å…±API
    return {
        escapeHtml: escapeHtml,
        isHtmlContent: isHtmlContent,
        isCompleteHtml: isCompleteHtml,
        getPluginTypeConfig: getPluginTypeConfig,
        shouldShowLogo: shouldShowLogo,
        needsHtmlRendering: needsHtmlRendering,
        getNodeStyleConfig: getNodeStyleConfig,
        NODE_STYLE_CONFIG: NODE_STYLE_CONFIG,
        generateContentHtml: generateContentHtml,
        generatePluginContentDisplay: generatePluginContentDisplay,
        generateDetailCardContent: generateDetailCardContent,
        generatePluginDetailDisplay: generatePluginDetailDisplay,
        generateSuperlinkDisplay: generateSuperlinkDisplay,
        generateHttpDisplay: generateHttpDisplay,
        generateCodeDisplay: generateCodeDisplay,
        generateFunctionDisplay: generateFunctionDisplay,
        generateDefaultDisplay: generateDefaultDisplay,
        generateSuperlinkDetailDisplay: generateSuperlinkDetailDisplay,
        generateHttpDetailDisplay: generateHttpDetailDisplay,
        generateCodeDetailDisplay: generateCodeDetailDisplay,
        generateFunctionDetailDisplay: generateFunctionDetailDisplay,
        generateDefaultDetailDisplay: generateDefaultDetailDisplay,
        IframeManager: IframeManager,
        createCodePreviewIframe: function(containerId, htmlContent, isComplete) {
            return IframeManager.create(containerId, htmlContent, isComplete);
        },
        PLUGIN_TYPES: PLUGIN_TYPES,
        DEFAULT_LOGO_PATH: DEFAULT_LOGO_PATH
    };
})();
```

## encodeå•å¼•å·é—®é¢˜

![image-20251010143831640](14.webç«¯æ’ä»¶å†…å®¹æ¸²æŸ“ä¼˜åŒ–.assets/image-20251010143831640.png)

### å‡å¦‚ä½¿ç”¨base64  æ²¡æˆåŠŸ 

è¿™ç§æ–¹å¼ç›¸å¯¹è€Œè¨€ç†è®ºä¸Šä¹Ÿæ›´å®‰å…¨

å°±æ˜¯æ•°æ®åº“é‡Œé¢å­˜base64ç¼–ç åçš„ä¸€å †ç¬¦å·

åœ¨å‰ç«¯



### ä½¿ç”¨system.jsä¸­å¸¦çš„ç¼–ç å’Œè§£ç æ–¹å¼

åœ¨å­˜å…¥htmlçš„æ—¶å€™ä½¿ç”¨

```js
submitData.content = encodeURIComponent($.htmlencode(submitData.content,true));
```

$.htmlencode()  å»æŠŠå•å¼•å·å’ŒåŒå¼•å·ç»™æ›¿æ¢

æ›¿æ¢åå­˜å‚¨ç›¸åº”çš„ç¼–ç è¿‡çš„html



å†ä½¿ç”¨

$dehtmlcodeä¸ªè§£ç è·å–  ä¹Ÿå°±æ˜¯è¿˜åŸä¸ºåŸæ¥çš„å•å¼•å·å’ŒåŒå¼•å·

![image-20251010161006581](14.webç«¯æ’ä»¶å†…å®¹æ¸²æŸ“ä¼˜åŒ–.assets/image-20251010161006581.png)

## æœ€åå®ç°äº†æ¸²æŸ“ä»¥åŠjsä¹Ÿæ˜¯å¯ä»¥äº¤äº’çš„

![image-20251010161050200](14.webç«¯æ’ä»¶å†…å®¹æ¸²æŸ“ä¼˜åŒ–.assets/image-20251010161050200.png)









