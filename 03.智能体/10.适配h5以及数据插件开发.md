![image-20250901180405864](10.é€‚é…h5ä»¥åŠæ•°æ®æ’ä»¶å¼€å‘.assets/image-20250901180405864.png)

## å¼€å‘æ•°æ®æ’ä»¶éœ€è¦è€ƒè™‘çš„é—®é¢˜

æ ¹æ®éœ€æ±‚é‚£è¾¹ç»™çš„å›¾ï¼Œå¯¹äºæ’ä»¶çš„å¼€å‘è‡³å°‘éœ€è¦è€ƒè™‘ä»¥ä¸‹å‡ ä¸ªé—®é¢˜

1. æˆ‘ä»¬çŸ¥é“ï¼Œåˆ›å»ºèŠ‚ç‚¹çš„æ—¶å€™å¯ä»¥é€‰æ‹©ç›¸åº”çš„æ’ä»¶ï¼Œç„¶ååœ¨åˆ«çš„ç«¯å±•ç¤ºçš„æ—¶å€™è¦ä¹ˆå±•ç¤ºå½“æ—¶èŠ‚ç‚¹ä¸Šä¼ çš„logo
   è¦ä¹ˆå°±æ˜¯å±•ç¤ºæ’ä»¶çš„å†…å®¹ï¼Œè€Œåœ¨è®¾è®¡æ’ä»¶çš„è¡¨çš„æ—¶å€™ï¼Œæ’ä»¶å†…å®¹ä½¿ç”¨çš„æ˜¯text,  ä¹Ÿå°±æ˜¯è¯´è¿™éƒ¨åˆ†å¾—åˆ°çš„åªæ˜¯ä¸€æ®µå­—ç¬¦ä¸²ç½¢äº†ï¼Œè€Œæœ¬èº«contentçš„å†…å®¹å°±ä¼šæ ¹æ®é€‰æ‹©çš„æ’ä»¶ç±»å‹ **è¶…é“¾æ¥**   **http**   **ä»£ç å—**æ¥å­˜å¯¹åº”çš„å†…å®¹ï¼Œæ¸²æŸ“èŠ‚ç‚¹çš„æ—¶å€™å¦‚ä½•æŒ‰ç…§æä¾›çš„åŸå‹æ¥åšæ’ä»¶å‘¢ï¼Ÿ
2. å¾ˆæ˜æ˜¾ï¼ŒæŒ‰ç…§æä¾›è¿‡æ¥çš„å›¾ï¼Œæ’ä»¶çš„å†…å®¹å¯èƒ½æ˜¯å›¾è¡¨ï¼Œåº•éƒ¨è¿˜æœ‰ç›¸åº”çš„é“¾æ¥ï¼Œé“¾æ¥ç‚¹å¼€ï¼Œçœ‹æ ·å­æ˜¯åˆ«çš„é¡µé¢çš„ä¸œè¥¿
   è¿™äº›é¡µé¢ä»å“ªé‡Œæ¥ï¼Œè¯¥å¦‚ä½•å®ç°ï¼Ÿ
3. ä¹‹å‰æŒ‰ç…§åŸå‹éœ€è¦é€‰æ‹©è¾“å…¥è¾“å‡ºå­—æ®µï¼Œè¿™ä¸¤ä¸ªå­—æ®µå­˜å‚¨æ˜¯å­—ç¬¦ä¸²ï¼Œéœ€è¦è§£ææ–¹å¯å¾—åˆ°å¯¹åº”çš„å†…å®¹ï¼Œé‚£ä¹ˆé—®é¢˜æ¥äº†ï¼Œè¿™äº›å­—æ®µè§£æäº†ååœ¨é‚£äº›åœ°æ–¹ä½¿ç”¨å‘¢ï¼Ÿå‰é¢å¯èƒ½æ˜¯è·³è½¬é“¾æ¥ï¼Œæ˜¯åœ¨é“¾æ¥ä¸­æºå¸¦è·³è½¬å—ï¼Ÿ
4. è°ˆåˆ°è¿‡ä¸€ä¸ªè€ƒå‹¤æ™ºèƒ½ä½“ï¼Œæ™ºèƒ½ä½“çš„èŠ‚ç‚¹ï¼ŒèŠ‚ç‚¹ä¸­çš„æ•°æ®è¯¥å¦‚ä½•æ‹¿å‘¢ï¼Ÿæ‰“å¡æ•°æ®è‚¯å®šæ˜¯ä»åˆ«çš„è¡¨ä¸­æ‹¿çš„ï¼Œåœ¨ç³»ç»Ÿä¸­æ‹¿**åˆ«çš„æ•°æ®åº“ä¸­çš„è¡¨**æ˜¯å¦‚ä½•èµ°çš„å‘¢ï¼Ÿ
5. æœ€å¤´å¤§çš„åœ°æ–¹å°±æ˜¯ï¼Œåˆ«çš„ç«¯ç³»ç»Ÿè¿˜æ²¡æœ‰ï¼Œç†Ÿæ‚‰ä¸åˆ°ï¼Œåˆ°æ—¶å€™å¦‚ä½•æ·»åŠ æˆä¸ºä¸€ä¸ªå›°éš¾ç‚¹







## é€‚é…å¹¼å„¿å›­ç«¯H5



ç”±äºH5å’Œpcç«¯ä½¿ç”¨çš„æ˜¯åŒä¸€ä¸ªé¡µé¢ï¼Œä¹Ÿå°±éœ€è¦å¯¹åŸæœ¬çš„agent_list.htmlå’Œagnet_list.jsè¿›è¡Œè°ƒæ•´

### webç«¯æ•ˆæœ  æ™ºèƒ½ä½“åˆ—è¡¨agent_list

![image-20250912101826729](10.é€‚é…h5ä»¥åŠæ•°æ®æ’ä»¶å¼€å‘.assets/image-20250912101826729.png)

#### H5ç«¯çš„æ•ˆæœ åŸæ•ˆæœ

![image-20250912101852717](10.é€‚é…h5ä»¥åŠæ•°æ®æ’ä»¶å¼€å‘.assets/image-20250912101852717.png)

æ•´ä½“å¤ªå¤§äº†ï¼Œéœ€è¦ç¼©å°

#### é€‚é…æ€è·¯

**åœ¨jsä¸­çš„objdataé‡Œé¢æ·»åŠ ä¸€ä¸ªå˜é‡pointType ç”¨äºå­˜å‚¨æ—¶ pcç«¯è¿˜æ˜¯ h5**

é’ˆå¯¹ä¸åŒçš„ç«¯å®ç°ä¸åŒçš„æ ·å¼

ç»è¿‡é€‚é…

#### H5ç«¯é€‚é…å

![image-20250912104116482](10.é€‚é…h5ä»¥åŠæ•°æ®æ’ä»¶å¼€å‘.assets/image-20250912104116482.png)

**ç¼ºç‚¹ï¼šé’ˆå¯¹ä¸åŒç«¯çš„cssæ ·å¼ è€¦åˆæ•ˆæœå¤ªå¤§**  ä¼˜åŒ–èµ·æ¥æ—¶é—´å¤ªé•¿

### webç«¯æ™ºèƒ½ä½“è¯¦æƒ…æ•ˆæœ  agent_detail



#### H5ç«¯çš„æ•ˆæœ



#### H5é€‚é…å

![image-20250912114949170](10.é€‚é…h5ä»¥åŠæ•°æ®æ’ä»¶å¼€å‘.assets/image-20250912114949170.png)



### webç«¯æ•ˆæœ  node_graph_web

![image-20250912132143837](10.é€‚é…h5ä»¥åŠæ•°æ®æ’ä»¶å¼€å‘.assets/image-20250912132143837.png)

#### H5ç«¯çš„æ•ˆæœ ï¼ˆå·²ç»ä¿®æ”¹è¿‡ï¼‰

![image-20250912132235366](10.é€‚é…h5ä»¥åŠæ•°æ®æ’ä»¶å¼€å‘.assets/image-20250912132235366.png)

ä¼˜åŒ–åï¼š

![image-20250912141509801](10.é€‚é…h5ä»¥åŠæ•°æ®æ’ä»¶å¼€å‘.assets/image-20250912141509801.png)

##### å­˜åœ¨çš„bug   è§£å†³

å¦‚ä¸Šå›¾è™½ç„¶èŠ‚ç‚¹æ¸²æŸ“æ²¡é—®é¢˜ï¼Œä½†æ˜¯ï¼ŒèŠ‚ç‚¹ä¸èƒ½ç‚¹å‡»ï¼Œå› ä¸ºåœ¨H5ç«¯æ˜¯é€šè¿‡è§¦æ‘¸å®ç°çš„ï¼Œå› æ­¤é€‚é…webç«¯çš„é‚£ä¸€å¥—ç‚¹å‡»æ—¶é—´åœ¨è¿™éƒ¨åˆ†æ˜¯æ— æ³•æ»¡è¶³H5ç«¯çš„è¦æ±‚çš„ï¼Œå› æ­¤éœ€è¦äºŒæ¬¡é€‚é…













## æ’ä»¶demo

contenté‡Œé¢æ”¾çš„ä»£ç å—

htmlå’Œjséƒ½ç»™åˆ°å¯¹äºçš„content

**éœ€è¦çš„å‚æ•°ä»è¾“å…¥è¾“å‡ºæ‹¿**

### superlink  è¶…é“¾æ¥ç±»å‹



### HTTP è¯·æ±‚





### code  ä»£ç å—æ¸²æŸ“

#### éš¾ç‚¹1

ç°æœ‰çš„ä»£ç ç»“æ„æ˜¯åŸºäºcanvaså»æ¸²æŸ“çš„ï¼Œä½†æ˜¯canvasæœ¬èº«æ˜¯ä¸æ”¯æŒhtml  çš„ ä¹Ÿå°±æ˜¯ group.addshape æ˜¯æ²¡æœ‰htmlçš„

https://f6.antv.vision/zh/docs/manual/middle/elements/shape/shape-and-properties

![image-20250912152646069](10.é€‚é…h5ä»¥åŠæ•°æ®æ’ä»¶å¼€å‘.assets/image-20250912152646069.png)

**æ‰€ä»¥æ¸²æŸ“å¾—è€ƒè™‘åˆ«çš„åŠæ³•**  å¯æ˜¯æœ‰å•¥åŠæ³•å‘¢ï¼Ÿ

![image-20250912164410315](10.é€‚é…h5ä»¥åŠæ•°æ®æ’ä»¶å¼€å‘.assets/image-20250912164410315.png)

ä¹‹å‰çš„èŠ‚ç‚¹å†™æ­»äº†ä¸€ç§  å‘ä¸Šæ”¹å˜çš„è¯å°±æ˜¯è®¾ç½®ä¸åŒçš„èŠ‚ç‚¹ nodes  type

å¦‚æœæ˜¯code ç±»å‹çš„  æˆ‘ä»¬å°±åœ¨è®¾ç½®typeçš„æ—¶å€™è®¾ç½®ä¸ºhtml  ç„¶åå†å»æ¸²æŸ“ contenté‡Œé¢çš„å†…å®¹

**æ€è·¯ï¼š**

```tex
/*
* TODO ç”±äºgraph.addShape() æ— æ³•æ¸²æŸ“å‡ºHTMLå†…å®¹
*  æ‰€ä»¥è€ƒè™‘åœ¨è®¾ç½®èŠ‚ç‚¹çš„æ—¶å€™é€šè¿‡æ˜¯å¦æ˜¾ç¤ºlogoçš„é€»è¾‘æ¥åˆ¤æ–­èŠ‚ç‚¹çš„type  æ¸²æŸ“å›¾ç‰‡çš„å°±æ˜¯ç°åœ¨çš„custom-node
*  è€Œæ‹¿åˆ°çš„nodeçš„plugin_typeä¸ºcode çš„æ—¶å€™  ä½¿ç”¨  htmlèŠ‚ç‚¹  æ¸²æŸ“HTML ä¹Ÿå°±æ˜¯typeä¸ºhtml
*  nodeså»pushçš„æ—¶å€™å­˜å‚¨æ–°çš„å³å¯  è€Œå†…å®¹å°±æ¥è‡ª content ä¹Ÿå°±æ˜¯return çš„html
*  å¦‚æœæ‹¿åˆ°çš„plugin_type ä¸ºsuperlink å’Œ httpçš„æ—¶å€™å°±æš‚ä¸”æŒ‰ç…§ç›®å‰çš„custom-node å±•ç¤ºæ–‡æœ¬å°±è¡Œ
*
*  åˆ›å»ºæ–°çš„æ–¹æ³•é’ˆå¯¹è¿™ç§ç±»å‹çš„èŠ‚ç‚¹å•ç‹¬æ¸²æŸ“å…¶å†…å®¹
* */
```

ä¸è¿‡è¿™ä¹Ÿå°±è¦æ±‚codeç±»å‹çš„cntentä¸ºæ ‡å‡†çš„html  ç›¸å½“äºæŠŠæ•´ä¸ªé¡µé¢éƒ½ç»™æ”¾è¿›å»äº†ï¼Œè¿™éƒ¨åˆ†è¿˜å¾—ç¡®å®šå¥½
å¯¹äºåŠ¨æ€çš„æ•°æ®å±•ç¤ºï¼Œhtmlé‡Œé¢çš„jså’‹æï¼Ÿ å¦‚ä½•æ‹¿åˆ°å¯¹åº”çš„å‚æ•°å‘¢ï¼Ÿ

#### éš¾ç‚¹2

4ç‰ˆæœ¬çš„G6æ˜¯æ²¡æœ‰  htmlç±»å‹çš„èŠ‚ç‚¹çš„ï¼Œå°±å¯¼è‡´äº†ä½¿ç”¨  htmlèŠ‚ç‚¹ç±»å‹ä¸ç”Ÿæ•ˆï¼Œè€Œéœ€è¦å°†åŸæœ¬çš„é‡æ„ä¸ºé€‚é…5ç‰ˆæœ¬çš„,

é‡æ„ä¸º5ç‰ˆæœ¬ï¼ŒåŸæœ¬çš„æ³¨å†ŒèŠ‚ç‚¹çš„æ–¹å¼å°±éœ€è¦é‡æ–°ç¼–å†™ï¼Œåœ¨4ç‰ˆæœ¬é€‚ç”¨ç«¯ï¼Œå¼ºè¡Œä½¿ç”¨5ç‰ˆæœ¬çš„htmlç±»å‹æ¸²æŸ“å¾—åˆ°çš„ç»“æœ

![image-20250915161748626](10.é€‚é…h5ä»¥åŠæ•°æ®æ’ä»¶å¼€å‘.assets/image-20250915161748626.png)

codeç±»å‹çš„èŠ‚ç‚¹çš„ä»£ç å—å¹¶æ²¡æœ‰æ¸²æŸ“å‡ºæ¥ï¼Œå…¶ä»–çš„ç©ºç™½æ˜¯è¶…é“¾æ¥å’ŒHTTPè¯·æ±‚çš„ è¿™éƒ¨åˆ†çš„å†…å®¹åœ¨éœ€æ±‚é‚£è¾¹ä¹Ÿæ²¡æœ‰ç»™å‡ºï¼Œæš‚ä¸”å…ˆè¿™æ ·

æœ¬èº«æ¸²æŸ“èŠ‚ç‚¹è¿™éƒ¨åˆ†ï¼Œä»£ç é‡å·²ç»å¾ˆå¤§äº†  å› ä¸ºè¿™æ˜¯H5ç«¯å’Œwebç«¯å…±ç”¨çš„é¡µé¢ï¼Œç¼©æ”¾ä»€ä¹ˆçš„éƒ½æ˜¯åœ¨è¿™é‡Œé¢å»å®ç°çš„

å¯¹äºå…¶å®æ¸²æŸ“æ’ä»¶å†…å®¹content  æˆ‘è§‰å¾—éœ€è¦åœ¨æ¸²æŸ“çš„æ—¶å€™ç»™åˆ°å…¶ä»–çš„é¡µé¢ï¼Œè¿™æ ·ä»£ç è€¦åˆåº¦ç›¸å¯¹è¾ƒä½ï¼Œä½†æ˜¯åˆé‡åˆ°å›°éš¾

#### éš¾ç‚¹3

ä¸Šé¢æåˆ°äº†å°†æ¸²æŸ“æ’ä»¶çš„contentå•ç‹¬æ‹å‡ºæ¥æ”¾åˆ°æ–°çš„é¡µé¢ï¼Œå®˜æ–¹çš„æ–‡æ¡£æ²¡æœ‰ç›¸å…³çš„ä¾‹å­ï¼Œåœ¨æœ¬ç³»ç»Ÿä¸­è¯¥å¦‚ä½•åšå‘¢ï¼Ÿ

![image-20250915162425744](10.é€‚é…h5ä»¥åŠæ•°æ®æ’ä»¶å¼€å‘.assets/image-20250915162425744.png)

å®˜æ–¹æ‰€åšçš„htmlèŠ‚ç‚¹æ˜¯æŒ‰ç…§ä¸Šé¢çš„ç»“æ„çš„ï¼Œreturn ç›¸åº”çš„å‰ç«¯ä»£ç   åœ¨ç°åœ¨çš„ä»£ç ä¸Šå»ç…§è‘«èŠ¦ç”»ç“¢ï¼Œè¡Œä¸é€šï¼Œä¹Ÿå¾ˆæ˜æ˜¾ï¼Œè¿™æ˜¯5ç‰ˆæœ¬çš„è¯­æ³•ï¼Œ4ç‰ˆæœ¬ä¸Šç”šè‡³éƒ½æ²¡æœ‰è¿™æ ·çš„èŠ‚ç‚¹ç±»å‹  

## BUG

### æ’ä»¶æ·»åŠ æˆ–è€…ç¼–è¾‘

1. **å¾€contenté‡Œé¢æ”¾htmlä»£ç çš„æ—¶å€™å°±ä¼šå‡ºé—®é¢˜  å­˜å…¥contentçš„æ—¶å€™è¯¥å¦‚ä½•å†™ï¼Ÿ**
   ![image-20250912152928250](10.é€‚é…h5ä»¥åŠæ•°æ®æ’ä»¶å¼€å‘.assets/image-20250912152928250.png)

2. **ä»åœ°å€æ ä¼ é€’è¿‡æ¥åˆ¤æ–­æ˜¯é‚£ä¸ªç«¯çš„pointType ä½¿ç”¨ä¸‰ç›®è¿ç®—ç¬¦å»è®¾ç½®æµç¨‹å›¾çš„æ–¹å‘çš„æ—¶å€™æœªç”Ÿæ•ˆ  rankdir**  

   ![image-20250915161329743](10.é€‚é…h5ä»¥åŠæ•°æ®æ’ä»¶å¼€å‘.assets/image-20250915161329743.png)



## å®ç°æ’ä»¶demoè§£å†³æ–¹æ¡ˆ

### 4.x.g6.min.js ç‰ˆæœ¬

è¯´æ˜ï¼šè¯¥ç‰ˆæœ¬ä¹‹å‰å°è¯•è¿‡ï¼Œä½¿ç”¨çš„è‡ªå®šä¹‰èŠ‚ç‚¹ï¼Œç„¶ååœ¨æ¸²æŸ“çš„éƒ¨åˆ†é’ˆå¯¹ä¸åŒç±»å‹çš„æ’ä»¶å»èµ°å•ç‹¬çš„æ¸²æŸ“æ–¹æ³•ï¼Œä½†æ˜¯ä½¿ç”¨çš„æ˜¯graph.addShap()   å®˜æ–¹æ²¡æœ‰html  ç™½ç»™  æ²¡æœ‰æƒ³åˆ°æ›´å¥½çš„ä»£æ›¿æ–¹æ¡ˆ

**ä½¿ç”¨domå’Œoverlay  å»ç‚¹å‡»æ¸²æŸ“  html**   

#### ä»£ç 

```js
/**
 * ä½œè€…ï¼šgongxi
 * æ—¶é—´ï¼š2025-09-11
 * æ™ºèƒ½ä½“èŠ‚ç‚¹å›¾è¡¨ - G6 v4ç‰ˆæœ¬ + DOMå åŠ HTMLæ¸²æŸ“æ–¹æ¡ˆ
 * ä¿æŒåŸæœ‰Canvasæ¸²æŸ“æ ·å¼å’Œäº¤äº’æ•ˆæœï¼Œé€šè¿‡DOM overlayå®ç°HTMLå†…å®¹æ¸²æŸ“
 */

require.config({
    paths: {
        jquery: '../../sys/jquery',
        system: '../../sys/system',
        layui: "../../layui-btkj/layui",
        layuicommon: "../../sys/layuicommon",
        g6: "../../plugin/antv/g6/4.x.g6.min"  // ä¿æŒG6 v4
    },
    shim: {
        "system": {
            deps: ["jquery"]
        },
        "layui": {
            deps: ["jquery", "system"]
        },
        "layuicommon": {
            deps: ["jquery", "layui"]
        },
        "g6": {
            deps: ["jquery"]
        }
    },
    waitSeconds: 0
});

// ä¿æŒåŸæœ‰çš„objdataå’ŒPLUGIN_TYPESé…ç½®...
objdata = {
    // æ™ºèƒ½ä½“ID
    agent_id: null,
    // èŠ‚ç‚¹æ•°æ®å­˜å‚¨
    allNodeData: [],
    nodeRelationDataHTML: null,
    // å›¾è¡¨å®ä¾‹
    currentGraph: null,
    // é¡µé¢çŠ¶æ€
    isLoading: false,
    isInitialized: false,
    // æ‹–æ‹½çŠ¶æ€æ§åˆ¶
    isDragging: false,
    dragStartTime: 0,
    // ç‚¹å‡»è¿‡çš„èŠ‚ç‚¹è®°å½•
    clickedNodes: new Set(),
    // åœ°å€æ ä¼ é€’
    applicable: {
        applicable_end: '',
        applicable_role: ''
    },
    pointType: '',
    // è®¾å¤‡ç±»å‹æ£€æµ‹
    isMobile: false,
    isTouch: false,
    // HTML overlayå®¹å™¨
    htmlOverlayContainer: null
};

// æ’ä»¶ç±»å‹é…ç½®
const PLUGIN_TYPES = {
    superlink: {
        name: 'è¶…é“¾æ¥',
        bgColor: '#e6f7ff',
        borderColor: '#1890ff',
        textColor: '#1890ff',
        rendering: 'canvas'
    },
    http: {
        name: 'HTTPè¯·æ±‚',
        bgColor: '#fff7e6',
        borderColor: '#fa8c16',
        textColor: '#fa8c16',
        rendering: 'canvas'
    },
    code: {
        name: 'ä»£ç æ‰§è¡Œ',
        bgColor: '#f6ffed',
        borderColor: '#52c41a',
        textColor: '#52c41a',
        rendering: 'html'   // codeç±»å‹æ”¯æŒHTMLæ¸²æŸ“
    },
    function: {
        name: 'å‡½æ•°è°ƒç”¨',
        bgColor: '#f9f0ff',
        borderColor: '#722ed1',
        textColor: '#722ed1',
        rendering: 'canvas'
    },
    default: {
        name: 'é»˜è®¤å†…å®¹',
        bgColor: 'transparent',
        borderColor: 'transparent',
        textColor: '#666',
        rendering: 'canvas'
    }
};

const DEFAULT_LOGO_PATH = '../../images/agentimg/agentimg.jpg';

require(["jquery", "system", "layui"], function () {
    layui.use(['layer'], function () {
        detectDevice();
        initNodeGraph();
        initEventListeners();
    });
});

// ä¿æŒåŸæœ‰çš„åŸºç¡€å‡½æ•°...
function detectDevice() {
    objdata.isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
    objdata.isTouch = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
}

function initNodeGraph() {
    const agentId = Arg("agent_id") || Arg("id");
    const pointType = Arg("pointType");
    const applicable_end = Arg("applicable_end");
    const applicable_role = Arg("applicable_role");
    objdata.pointType = pointType;
    objdata.applicable.applicable_end = [applicable_end];
    objdata.applicable.applicable_role = [applicable_role];

    if (!agentId) {
        showEmptyState('ç¼ºå°‘å¿…è¦å‚æ•°ï¼šagent_id');
        return;
    }

    objdata.agent_id = agentId;
    setBackgroundStyle();
    loadNodeData();
}

function setBackgroundStyle() {
    const container = $('.graph-canvas');
    if (objdata.pointType === 'H5' || objdata.isMobile) {
        container.css({
            'background': `        
                linear-gradient(90deg, rgba(0,0,0,0.1) 1px, transparent 1px),
                linear-gradient(180deg, rgba(0,0,0,0.1) 1px, transparent 1px)`,
            'background-size': '20px 20px',
            'background-position': '0 0, 0 10px, 10px -10px, -10px 0px'
        });
    } else {
        container.css({
            'background': `linear-gradient(45deg, #f8f9fa 25%, transparent 25%),
                          linear-gradient(-45deg, #f8f9fa 25%, transparent 25%),
                          linear-gradient(45deg, transparent 75%, #f8f9fa 75%),
                          linear-gradient(-45deg, transparent 75%, #f8f9fa 75%)`,
            'background-size': '20px 20px',
            'background-position': '0 0, 0 10px, 10px -10px, -10px 0px'
        });
    }
}

function loadNodeData() {
    showLoading();
    let data = {
        "agent_id": [objdata.agent_id]
    };

    $.sm(function (re, err) {
        if (err) {
            hideLoading();
            layer.msg(err);
            showEmptyState('åŠ è½½èŠ‚ç‚¹æ•°æ®å¤±è´¥ï¼Œè¯·é‡è¯•');
        } else {
            objdata.allNodeData = re || [];
            prepareAndRenderGraph();
        }
    }, ["w_agent_node_plugin.getList", $.msgwhere(data)]);
}

function prepareAndRenderGraph() {
    objdata.nodeRelationDataHTML = prepareRelationDataHTML(objdata.allNodeData);
    hideLoading();

    if (!objdata.nodeRelationDataHTML || objdata.nodeRelationDataHTML.nodes.length === 0) {
        showEmptyState('è¯¥æ™ºèƒ½ä½“æš‚æ— èŠ‚ç‚¹æ•°æ®');
        return;
    }

    require(['g6'], function(G6) {
        createNodeRelationGraph(G6, objdata.nodeRelationDataHTML);
        hideEmptyState();
        updateNodeCount();
        objdata.isInitialized = true;
    });
}

/**
 * å‡†å¤‡èŠ‚ç‚¹å…³ç³»æ•°æ® - G6 v4ç‰ˆæœ¬ï¼Œæ‰€æœ‰èŠ‚ç‚¹éƒ½ç”¨Canvasï¼ŒHTMLå†…å®¹é€šè¿‡overlayæ˜¾ç¤º
 */
function prepareRelationDataHTML(nodeList) {
    if (!nodeList || nodeList.length === 0) {
        return { nodes: [], edges: [] };
    }

    const nodes = [];
    const edges = [];
    const nodeMap = new Map();

    nodeList.forEach(node => {
        nodeMap.set(node.id, node);
    });

    // æ‰€æœ‰èŠ‚ç‚¹éƒ½ä½¿ç”¨è‡ªå®šä¹‰CanvasèŠ‚ç‚¹ï¼ŒHTMLå†…å®¹é€šè¿‡overlayå¤„ç†
    nodeList.forEach(node => {
        const nodeName = node.node_name || `èŠ‚ç‚¹${node.id}`;
        const nodeSize = (objdata.pointType === 'H5' || objdata.isMobile) ? [180, 140] : [220, 180];

        nodes.push({
            id: node.id.toString(),
            label: nodeName,
            size: nodeSize,
            type: 'custom-node',
            nodeData: node,
            style: {
                fill: 'transparent',
                stroke: 'transparent'
            }
        });
    });

    nodeList.forEach(node => {
        if (node.parent_id && node.parent_id !== '0' && nodeMap.has(parseInt(node.parent_id))) {
            edges.push({
                source: node.parent_id.toString(),
                target: node.id.toString(),
                type: 'cubic-horizontal',
                style: {
                    stroke: '#1890ff',
                    lineWidth: 2,
                    strokeOpacity: 0.8,
                    endArrow: {
                        path: 'M 0,0 L 8,4 L 8,-4 Z',
                        fill: '#1890ff',
                        strokeOpacity: 1
                    }
                }
            });
        }
    });

    return { nodes, edges };
}

/**
 * åˆ›å»ºèŠ‚ç‚¹å…³ç³»å›¾ - G6 v4ç‰ˆæœ¬ + HTML overlay
 */
function createNodeRelationGraph(G6, data) {
    const container = $('#nodeGraphContainer');

    if (objdata.currentGraph && !objdata.currentGraph.destroyed) {
        objdata.currentGraph.destroy();
    }

    // åˆ›å»ºHTML overlayå®¹å™¨
    createHtmlOverlayContainer(container[0]);

    // æ³¨å†Œè‡ªå®šä¹‰èŠ‚ç‚¹
    G6.registerNode('custom-node', {
        draw(cfg, group) {
            const nodeData = cfg.nodeData;
            const size = cfg.size || [220, 180];
            const width = size[0];
            const height = size[1];

            // èŠ‚ç‚¹çŠ¶æ€
            const isDisabled = nodeData.status !== 0;
            const hasPermission = checkNodePermission(nodeData);
            const isClicked = objdata.clickedNodes.has(nodeData.id.toString());

            // åˆ›å»ºä¸»å®¹å™¨
            const shadowColor = isClicked ? 'rgba(82, 196, 26, 0.8)' : 'rgba(24, 144, 255, 0.6)';
            const strokeColor = isDisabled || !hasPermission ? '#e8e8e8' : '#12ecb2';

            const mainRect = group.addShape('rect', {
                attrs: {
                    x: -width / 2,
                    y: -height / 2,
                    width: width,
                    height: height,
                    fill: isDisabled || !hasPermission ? '#f5f5f5' : '#fff',
                    stroke: strokeColor,
                    strokeWidth: 1,
                    cursor: hasPermission && !isDisabled ? 'pointer' : 'not-allowed',
                    shadowColor: shadowColor,
                    shadowBlur: 8,
                    shadowOffsetX: 2,
                    shadowOffsetY: 2,
                    radius: 4,
                    opacity: isDisabled || !hasPermission ? 0.8 : 1
                },
                name: 'main-rect'
            });

            // å†…å®¹åŒºåŸŸ
            const contentY = -height / 2;
            const titleHeight = (objdata.pointType === 'H5' || objdata.isMobile) ? 25 : 30;

            // æ ¹æ®æ˜¯å¦ä¸ºHTMLå†…å®¹æ˜¾ç¤ºä¸åŒçš„é¢„è§ˆ
            if (getPluginTypeConfig(nodeData.plugin_type).rendering === 'html' && isHtmlContent(nodeData.content)) {
                renderHtmlPreview(group, nodeData, contentY, width, height, titleHeight, isDisabled || !hasPermission);
            } else {
                renderPluginContent(group, nodeData, contentY, width, height, titleHeight, isDisabled || !hasPermission);
            }

            // æ¸²æŸ“èŠ‚ç‚¹åç§°
            renderNodeTitle(group, cfg, width, height, titleHeight, strokeColor, hasPermission, isDisabled);

            // æƒé™é”å®šå›¾æ ‡
            if (!hasPermission) {
                group.addShape('text', {
                    attrs: {
                        x: width / 2 - 10,
                        y: -height / 2 + 10,
                        text: 'ğŸ”’',
                        fontSize: (objdata.pointType === 'H5' || objdata.isMobile) ? 20 : 26,
                        textAlign: 'center',
                        textBaseline: 'middle',
                    },
                    name: 'lock-icon'
                });
            }

            return mainRect;
        },

        // èŠ‚ç‚¹åˆ›å»ºåçš„å›è°ƒï¼Œç”¨äºåˆ›å»ºHTML overlay
        afterDraw(cfg, group) {
            const nodeData = cfg.nodeData;
            if (getPluginTypeConfig(nodeData.plugin_type).rendering === 'html' && isHtmlContent(nodeData.content)) {
                createNodeHtmlOverlay(cfg);
            }
        }
    });

    const graphConfig = getGraphConfig(container);
    const graph = new G6.Graph(graphConfig);
    objdata.currentGraph = graph;

    bindGraphEvents(graph);

    graph.data(data);
    graph.render();

    setTimeout(() => {
        if (graph && !graph.destroyed) {
            graph.fitView(30);
        }
    }, 300);

    initGraphResize(graph);
}

/**
 * åˆ›å»ºHTML overlayå®¹å™¨
 */
function createHtmlOverlayContainer(graphContainer) {
    if (objdata.htmlOverlayContainer) {
        objdata.htmlOverlayContainer.remove();
    }

    objdata.htmlOverlayContainer = document.createElement('div');
    objdata.htmlOverlayContainer.id = 'html-overlay-container';
    objdata.htmlOverlayContainer.style.cssText = `
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        z-index: 1000;
    `;

    graphContainer.style.position = 'relative';
    graphContainer.appendChild(objdata.htmlOverlayContainer);
}

/**
 * ä¸ºèŠ‚ç‚¹åˆ›å»ºHTML overlay
 */
function createNodeHtmlOverlay(cfg) {
    const nodeData = cfg.nodeData;
    const nodeId = cfg.id;

    // åˆ›å»ºHTML overlayå…ƒç´ 
    const overlay = document.createElement('div');
    overlay.id = `html-overlay-${nodeId}`;
    overlay.className = 'node-html-overlay';
    overlay.style.cssText = `
        position: absolute;
        background: white;
        border: 2px solid #52c41a;
        border-radius: 8px;
        padding: 12px;
        max-width: 400px;
        max-height: 300px;
        overflow: auto;
        pointer-events: auto;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        z-index: 1001;
        display: none;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    `;

    // æ·»åŠ æ ‡é¢˜
    const title = document.createElement('div');
    title.style.cssText = `
        font-weight: bold;
        font-size: 14px;
        margin-bottom: 8px;
        color: #333;
        border-bottom: 1px solid #f0f0f0;
        padding-bottom: 8px;
    `;
    title.textContent = `${nodeData.node_name || 'ä»£ç èŠ‚ç‚¹'} - HTMLå†…å®¹`;

    // æ·»åŠ HTMLå†…å®¹
    const content = document.createElement('div');
    content.innerHTML = sanitizeHtml(nodeData.content);

    overlay.appendChild(title);
    overlay.appendChild(content);

    // æ·»åŠ å…³é—­æŒ‰é’®
    const closeBtn = document.createElement('div');
    closeBtn.style.cssText = `
        position: absolute;
        top: 8px;
        right: 8px;
        width: 20px;
        height: 20px;
        cursor: pointer;
        text-align: center;
        line-height: 18px;
        border-radius: 50%;
        background: #f0f0f0;
        font-size: 12px;
        color: #666;
    `;
    closeBtn.innerHTML = 'Ã—';
    closeBtn.onclick = () => {
        overlay.style.display = 'none';
    };

    overlay.appendChild(closeBtn);
    objdata.htmlOverlayContainer.appendChild(overlay);

    // å­˜å‚¨overlayå¼•ç”¨åˆ°èŠ‚ç‚¹é…ç½®ä¸­
    cfg.htmlOverlay = overlay;
}

/**
 * æ¸²æŸ“HTMLé¢„è§ˆï¼ˆåœ¨CanvasèŠ‚ç‚¹ä¸­æ˜¾ç¤ºæç¤ºï¼‰ TODO  åç»­å¯èƒ½ä¼šæ¢ä¸ºåŠ¨æ€çš„å†…å®¹
 */
function renderHtmlPreview(group, nodeData, contentY, width, height, titleHeight, isDisabled) {
    const contentHeight = height - titleHeight;

    // æ·»åŠ HTMLå›¾æ ‡
    group.addShape('text', {
        attrs: {
            x: 0,
            y: contentY + contentHeight / 2 - 20,
            text: 'ğŸŒ',
            fontSize: 28,
            textAlign: 'center',
            textBaseline: 'middle',
            opacity: isDisabled ? 0.6 : 1
        },
        name: 'html-icon'
    });

    // æ·»åŠ HTMLæ ‡è¯†
    group.addShape('text', {
        attrs: {
            x: 0,
            y: contentY + contentHeight / 2,
            text: 'HTMLå†…å®¹',
            fontSize: 12,
            fill: isDisabled ? '#999' : '#52c41a',
            textAlign: 'center',
            textBaseline: 'middle',
            fontWeight: 'bold'
        },
        name: 'html-label'
    });

    // æ·»åŠ æç¤ºæ–‡æœ¬
    group.addShape('text', {
        attrs: {
            x: 0,
            y: contentY + contentHeight / 2 + 20,
            text: 'ç‚¹å‡»æŸ¥çœ‹å®Œæ•´HTML',
            fontSize: 10,
            fill: '#999',
            textAlign: 'center',
            textBaseline: 'middle'
        },
        name: 'html-hint'
    });
}

/**
 * æ˜¾ç¤ºHTML overlay
 */
function showHtmlOverlay(nodeItem) {
    const cfg = nodeItem.getModel();
    const overlay = cfg.htmlOverlay;

    if (overlay) {
        // è·å–èŠ‚ç‚¹ä½ç½®
        const position = getNodeScreenPosition(nodeItem);
        overlay.style.left = position.x + 'px';
        overlay.style.top = position.y + 'px';
        overlay.style.display = 'block';

        // ç¡®ä¿overlayåœ¨è§†çª—å†…
        adjustOverlayPosition(overlay);
    }
}

/**
 * è·å–èŠ‚ç‚¹åœ¨å±å¹•ä¸Šçš„ä½ç½®
 */
function getNodeScreenPosition(nodeItem) {
    const model = nodeItem.getModel();
    const canvasPoint = objdata.currentGraph.getCanvasByPoint(model.x || 0, model.y || 0);
    const container = objdata.currentGraph.getContainer();
    const containerRect = container.getBoundingClientRect();

    return {
        x: containerRect.left + canvasPoint.x + 120, // èŠ‚ç‚¹å³ä¾§
        y: containerRect.top + canvasPoint.y - 100
    };
}

/**
 * è°ƒæ•´overlayä½ç½®ï¼Œç¡®ä¿åœ¨è§†çª—å†…
 */
function adjustOverlayPosition(overlay) {
    const rect = overlay.getBoundingClientRect();
    const viewportWidth = window.innerWidth;
    const viewportHeight = window.innerHeight;

    // å³è¾¹ç•Œè°ƒæ•´
    if (rect.right > viewportWidth - 20) {
        overlay.style.left = (viewportWidth - rect.width - 20) + 'px';
    }

    // ä¸‹è¾¹ç•Œè°ƒæ•´
    if (rect.bottom > viewportHeight - 20) {
        overlay.style.top = (viewportHeight - rect.height - 20) + 'px';
    }

    // å·¦è¾¹ç•Œè°ƒæ•´
    if (rect.left < 20) {
        overlay.style.left = '20px';
    }

    // ä¸Šè¾¹ç•Œè°ƒæ•´
    if (rect.top < 20) {
        overlay.style.top = '20px';
    }
}

/**
 * ç»‘å®šå›¾è¡¨äº‹ä»¶ - å¢åŠ HTML overlayå¤„ç†
 */
function bindGraphEvents(graph) {
    // èŠ‚ç‚¹ç‚¹å‡»äº‹ä»¶
    const clickEvent = objdata.isTouch ? 'node:touchstart' : 'node:click';

    graph.on(clickEvent, function(e) {
        const timeSinceDragStart = Date.now() - objdata.dragStartTime;
        if (objdata.isDragging && timeSinceDragStart > 200) return;

        const nodeModel = e.item.getModel();
        const nodeData = nodeModel.nodeData;

        const hasPermission = checkNodePermission(nodeData);
        if (!hasPermission) {
            layer.msg('æ‚¨æ²¡æœ‰æƒé™è®¿é—®æ­¤èŠ‚ç‚¹');
            return;
        }

        if (nodeData.status !== 0) {
            layer.msg('è¯¥èŠ‚ç‚¹æš‚ä¸å¯ç”¨');
            return;
        }

        // å¦‚æœæ˜¯HTMLèŠ‚ç‚¹ï¼Œæ˜¾ç¤ºoverlay
        if (getPluginTypeConfig(nodeData.plugin_type).rendering === 'html' && isHtmlContent(nodeData.content)) {
            showHtmlOverlay(e.item);
        }

        selectedNode(nodeData, e.item);
    });

    // æ‹–æ‹½äº‹ä»¶
    graph.on('node:dragstart', function() {
        objdata.isDragging = true;
        objdata.dragStartTime = Date.now();
        // éšè—æ‰€æœ‰overlay
        hideAllHtmlOverlays();
    });

    graph.on('node:dragend', function() {
        setTimeout(() => {
            objdata.isDragging = false;
        }, 150);
    });

    // ç”»å¸ƒç‚¹å‡»æ—¶éšè—æ‰€æœ‰overlay
    graph.on('canvas:click', function() {
        hideAllHtmlOverlays();
    });

    // ç§»åŠ¨ç«¯ç‰¹æ®Šå¤„ç†
    if (objdata.isTouch) {
        graph.on('node:touchstart', function(e) {
            e.preventDefault();
        });

        let lastTapTime = 0;
        graph.on('canvas:touchstart', function(e) {
            const currentTime = Date.now();
            const tapLength = currentTime - lastTapTime;
            if (tapLength < 500 && tapLength > 0) {
                const point = { x: e.canvasX, y: e.canvasY };
                const currentZoom = graph.getZoom();
                const targetZoom = currentZoom < 1.5 ? 2 : 1;
                graph.zoomTo(targetZoom, point);
            }
            lastTapTime = currentTime;
        });
    }

    // ç”»å¸ƒæ‹–æ‹½ä¼˜åŒ–
    graph.on('canvas:dragstart', function() {
        objdata.isDragging = true;
        hideAllHtmlOverlays();
    });

    graph.on('canvas:dragend', function() {
        setTimeout(() => {
            objdata.isDragging = false;
        }, 100);
    });
}

/**
 * éšè—æ‰€æœ‰HTML overlay
 */
function hideAllHtmlOverlays() {
    if (objdata.htmlOverlayContainer) {
        const overlays = objdata.htmlOverlayContainer.querySelectorAll('.node-html-overlay');
        overlays.forEach(overlay => {
            overlay.style.display = 'none';
        });
    }
}

/**
 * è·å–å›¾è¡¨é…ç½®
 */
function getGraphConfig(container) {
    const isMobileDevice = objdata.pointType === 'H5' || objdata.isMobile;

    return {
        container: container[0],
        width: container[0].clientWidth || 800,
        height: container[0].clientHeight || 600,
        renderer: 'canvas',
        pixelRatio: window.devicePixelRatio || 2,
        modes: {
            default: isMobileDevice ? [
                'drag-canvas',
                'zoom-canvas'
            ] : [
                'drag-canvas',
                'zoom-canvas',
                'drag-node'
            ]
        },
        defaultNode: {
            type: 'custom-node',
            size: isMobileDevice ? [180, 120] : [220, 120]
        },
        defaultEdge: {
            type: 'polyline',
            style: {
                stroke: '#1890ff',
                lineWidth: 2,
                strokeOpacity: 0.8,
                endArrow: {
                    path: 'M 0,0 L 8,4 L 8,-4 Z',
                    fill: '#1890ff'
                }
            }
        },
        layout: {
            type: 'dagre',
            rankdir: isMobileDevice ? 'TB':'LR'  ,  // todo æ²¡æœ‰å³æ—¶æ›´æ–°
            align: 'DL',
            nodesep: isMobileDevice ? 60 : 80,
            ranksep: isMobileDevice ? 80 : 120
        },
        fitView: true,
        fitViewPadding: isMobileDevice ? [20, 20, 20, 20] : [30, 30, 30, 30]
    };
}

function checkNodePermission(nodeData) {
    if (!nodeData.applicable_end && !nodeData.applicable_role) {
        return true;
    }
    if (nodeData.applicable_end === 'å…¨éƒ¨' && nodeData.applicable_role === 'å…¨éƒ¨') {
        return true;
    }

    let hasEndPermission = true;
    let hasRolePermission = true;

    if (nodeData.applicable_end) {
        const nodeEnds = nodeData.applicable_end.split(',').map(item => item.trim());
        hasEndPermission = nodeEnds.some(end => objdata.applicable.applicable_end.includes(end));
    }

    if (nodeData.applicable_role) {
        const nodeRoles = nodeData.applicable_role.split(',').map(item => item.trim());
        hasRolePermission = nodeRoles.some(role => objdata.applicable.applicable_role.includes(role));
    }

    return hasEndPermission && hasRolePermission;
}

function getPluginTypeConfig(pluginType) {
    return PLUGIN_TYPES[pluginType] || PLUGIN_TYPES.default;
}

function shouldShowLogo(nodeData) {
    if (nodeData.pld === 0 && nodeData.logo === '') {
        return { showLogo: true, logoPath: DEFAULT_LOGO_PATH };
    }

    if (nodeData.logo && !nodeData.logo.toString().match(/^\d+$/)) {
        return { showLogo: true, logoPath: ossPrefix + nodeData.logo };
    }

    return { showLogo: false, logoPath: null };
}

function isHtmlContent(content) {
    if (!content) return false;
    const htmlRegex = /<[^>]+>/;
    return htmlRegex.test(content);
}

function sanitizeHtml(html) {
    const temp = document.createElement('div');
    temp.innerHTML = html;

    const dangerousTags = ['script', 'object', 'embed', 'form', 'iframe'];
    dangerousTags.forEach(tag => {
        const elements = temp.querySelectorAll(tag);
        elements.forEach(el => el.remove());
    });

    const allElements = temp.querySelectorAll('*');
    allElements.forEach(el => {
        Array.from(el.attributes).forEach(attr => {
            if (attr.name.startsWith('on')) {
                el.removeAttribute(attr.name);
            }
        });
    });

    return temp.innerHTML;
}

function renderPluginContent(group, nodeData, contentY, width, height, titleHeight, isDisabled) {
    const contentHeight = height - titleHeight;
    const pluginConfig = getPluginTypeConfig(nodeData.plugin_type);
    const logoInfo = shouldShowLogo(nodeData);

    if (logoInfo.showLogo) {
        group.addShape('image', {
            attrs: {
                x: -width / 2,
                y: contentY,
                width: width,
                height: contentHeight,
                img: logoInfo.logoPath,
                cursor: !isDisabled ? 'pointer' : 'not-allowed',
                radius: 8,
                opacity: isDisabled ? 0.6 : 1
            },
            name: 'logo-image'
        });
        return;
    }

    let displayText = '';
    if (nodeData.pld === 0) {
        displayText = 'é»˜è®¤å†…å®¹';
    } else {
        displayText = nodeData.content ?
            (nodeData.content.length > 25 ? nodeData.content.substring(0, 25) + '...' : nodeData.content) :
            'æ— å†…å®¹';
    }

    group.addShape('text', {
        attrs: {
            x: 0,
            y: contentY + contentHeight / 2,
            text: displayText,
            fontSize: (objdata.pointType === 'H5' || objdata.isMobile) ? 9 : 11,
            fill: isDisabled ? '#999' : pluginConfig.textColor,
            textAlign: 'center',
            textBaseline: 'middle',
            cursor: 'pointer',
        },
        name: 'content-text'
    });
}

function renderNodeTitle(group, cfg, width, height, titleHeight, strokeColor, hasPermission, isDisabled) {
    group.addShape('rect', {
        attrs: {
            x: -width / 2,
            y: height / 2 - titleHeight,
            width: width,
            height: titleHeight,
            cursor: hasPermission && !isDisabled ? 'pointer' : 'not-allowed',
            stroke: strokeColor,
            opacity: isDisabled || !hasPermission ? 0.6 : 1
        },
        name: 'name-bg'
    });

    group.addShape('text', {
        attrs: {
            x: 0,
            y: height / 2 - titleHeight / 2,
            text: cfg.label,
            fontSize: (objdata.pointType === 'H5' || objdata.isMobile) ? 10 : 12,
            fontWeight: 'bold',
            fill: isDisabled || !hasPermission ? '#999' : '#0a0a0a',
            textAlign: 'center',
            textBaseline: 'middle',
            cursor: hasPermission && !isDisabled ? 'pointer' : 'not-allowed'
        },
        name: 'name-text'
    });
}

function selectedNode(nodeData, nodeItem) {
    objdata.clickedNodes.add(nodeData.id.toString());

    if (objdata.currentGraph) {
        objdata.currentGraph.getNodes().forEach(node => {
            objdata.currentGraph.updateItem(node, {
                style: {
                    stroke: '#e8e8e8',
                    strokeWidth: 1
                }
            });
        });

        objdata.currentGraph.updateItem(nodeItem, {
            style: {
                stroke: '#1890ff',
                strokeWidth: 3
            }
        });

        setTimeout(() => {
            objdata.currentGraph.refresh();
        }, 100);
    }

    saveNodeClickLog(nodeData);
    handleNodeAction(nodeData);
    showNodeDetails(nodeData);
}

function saveNodeClickLog(nodeData) {
    $.sm(function (re, err) {
        if (err) {
            console.log(err);
        } else {
            console.log(re);
        }
    }, ["node_click_log.add", JSON.stringify({
        agent_id: nodeData.agent_id,
        node_id: nodeData.id,
        oprid: "",
    })]);
}

function handleNodeAction(nodeData) {
    switch (nodeData.plugin_type) {
        case 'superlink':
            if (nodeData.url) {
                // window.open(nodeData.url, '_blank');
            } else {
                layer.msg('è¯¥è¶…é“¾æ¥èŠ‚ç‚¹æš‚æ— URLé…ç½®');
            }
            break;

        case 'http':
            if (nodeData.api_url || nodeData.url) {
                const url = nodeData.api_url || nodeData.url;
                layer.confirm('æ˜¯å¦è¦è®¿é—®æ­¤HTTPæ¥å£ï¼Ÿ<br>' + url, {
                    icon: 3,
                    title: 'HTTPè¯·æ±‚'
                }, function(index) {
                    // window.open(url, '_blank');
                    layer.close(index);
                });
            } else {
                // showNodeDetails(nodeData);
            }
            break;

        case 'code':
            if (nodeData.url) {
                // window.open(nodeData.url, '_blank');
            } else {
                showCodeDetails(nodeData);
            }
            break;

        case 'function':
            if (nodeData.url) {
                // window.open(nodeData.url, '_blank');
            } else {
                showFunctionDetails(nodeData);
            }
            break;

        default:
            if (nodeData.url) {
                // window.open(nodeData.url, '_blank');
            } else {
                layer.msg('è¯¥èŠ‚ç‚¹æš‚æ— é…ç½®æ“ä½œ');
            }
            break;
    }
}

function showNodeDetails(nodeData) {
    // å¯ä»¥åœ¨è¿™é‡Œå®ç°èŠ‚ç‚¹è¯¦æƒ…å¼¹çª—ç­‰åŠŸèƒ½
}

function showCodeDetails(nodeData) {
    const content = nodeData.content || 'æ— ä»£ç å†…å®¹';
    const isHtml = isHtmlContent(content);

    const contentHtml = `
        <div style="padding: 15px;">
            <h4>ä»£ç èŠ‚ç‚¹è¯¦æƒ…</h4>
            <p><strong>èŠ‚ç‚¹åç§°ï¼š</strong>${nodeData.node_name || 'æœªå‘½å'}</p>
            <p><strong>ç¼–ç¨‹è¯­è¨€ï¼š</strong>${nodeData.language || nodeData.code_language || 'æœªæŒ‡å®š'}</p>
            <p><strong>å†…å®¹ç±»å‹ï¼š</strong>${isHtml ? 'HTMLå†…å®¹' : 'ä»£ç å†…å®¹'}</p>
            <p><strong>${isHtml ? 'HTML' : 'ä»£ç '}å†…å®¹ï¼š</strong></p>
            <div style="
                background: #f5f5f5; 
                padding: 10px; 
                border-radius: 4px; 
                max-height: 300px; 
                overflow-y: auto;
                ${isHtml ? '' : 'font-family: monospace;'}
            ">
                ${isHtml ? content : content.replace(/</g, '&lt;').replace(/>/g, '&gt;')}
            </div>
        </div>
    `;

    layer.open({
        type: 1,
        title: 'ä»£ç èŠ‚ç‚¹',
        area: (objdata.pointType === 'H5' || objdata.isMobile) ? ['90%', '70%'] : ['600px', '450px'],
        content: contentHtml
    });
}

function showFunctionDetails(nodeData) {
    const content = `
        <div style="padding: 15px;">
            <h4>å‡½æ•°èŠ‚ç‚¹è¯¦æƒ…</h4>
            <p><strong>èŠ‚ç‚¹åç§°ï¼š</strong>${nodeData.node_name || 'æœªå‘½å'}</p>
            <p><strong>å‡½æ•°åç§°ï¼š</strong>${nodeData.function_name || nodeData.func_name || 'æœªæŒ‡å®š'}</p>
            <p><strong>å‡½æ•°æè¿°ï¼š</strong></p>
            <div style="background: #f5f5f5; padding: 10px; border-radius: 4px; max-height: 200px; overflow-y: auto;">
                ${nodeData.content || nodeData.description || 'æ— å‡½æ•°æè¿°'}
            </div>
        </div>
    `;

    layer.open({
        type: 1,
        title: 'å‡½æ•°èŠ‚ç‚¹',
        area: (objdata.pointType === 'H5' || objdata.isMobile) ? ['90%', '60%'] : ['500px', '350px'],
        content: content
    });
}

function initGraphResize(graph) {
    const resizeHandler = () => {
        if (!graph || graph.destroyed) return;

        const container = $('#nodeGraphContainer')[0];
        if (!container || !container.clientWidth || !container.clientHeight) return;

        graph.changeSize(container.clientWidth, container.clientHeight);
        graph.fitView(30);

        // éšè—overlayï¼Œå› ä¸ºä½ç½®å¯èƒ½å·²æ”¹å˜
        hideAllHtmlOverlays();
    };

    window.addEventListener('resize', resizeHandler);

    $(window).on('beforeunload', function() {
        window.removeEventListener('resize', resizeHandler);
        if (graph && !graph.destroyed) {
            graph.destroy();
        }
        // æ¸…ç†HTML overlayå®¹å™¨
        if (objdata.htmlOverlayContainer) {
            objdata.htmlOverlayContainer.remove();
        }
    });
}

function initEventListeners() {
    $(window).on('resize', function() {
        if (objdata.currentGraph && !objdata.currentGraph.destroyed) {
            const container = $('#nodeGraphContainer')[0];
            if (container) {
                objdata.currentGraph.changeSize(container.clientWidth, container.clientHeight);
                objdata.currentGraph.fitView(30);
                hideAllHtmlOverlays();
            }
        }
    });
}

// é¡µé¢çŠ¶æ€ç®¡ç†å‡½æ•°
function showLoading() {
    objdata.isLoading = true;
    $('#loadingOverlay').show();
}

function hideLoading() {
    objdata.isLoading = false;
    $('#loadingOverlay').hide();
}

function showEmptyState(message = 'æš‚æ— èŠ‚ç‚¹æ•°æ®') {
    $('#emptyState').show();
    $('#emptyState .empty-text').text(message);
    updateNodeCount();
}

function hideEmptyState() {
    $('#emptyState').hide();
}

function updateNodeCount() {
    const count = objdata.allNodeData ? objdata.allNodeData.length : 0;
    const name = objdata.pointType === 'H5' ?  'æµç¨‹':'èŠ‚ç‚¹' ;
    $('#nodeCount').text(`å…± ${count} ä¸ª ${name}`);
}
```

#### æ•ˆæœ

![image-20250916131210717](10.é€‚é…h5ä»¥åŠæ•°æ®æ’ä»¶å¼€å‘.assets/image-20250916131210717.png)

**åç»­åŸæœ‰çš„æ–‡æœ¬å±•ç¤ºä¼šåˆ°ç›¸åº”çš„æ¥å£ä¸­è·å¾—ï¼Œ**

#### æŒ‰ç…§åŸå‹æµ…æµ…å®ç°demo

![image-20250916145738348](10.é€‚é…h5ä»¥åŠæ•°æ®æ’ä»¶å¼€å‘.assets/image-20250916145738348.png)

##### ä¼˜åŒ–ç‚¹

1ï¼šå»é™¤é‡Œé¢çš„è®¾å¤‡ç±»å‹æ£€æµ‹ï¼Œå®Œå…¨ç”±objdata.pointTypeå»æ§åˆ¶æ˜¯é‚£ä¸ªç«¯ï¼Œ

2ï¼šä»£ç ä¸­èŠ‚ç‚¹çš„å„ç§é¢œè‰²ï¼Œå°ºå¯¸ç­‰æˆ‘å¸Œæœ›åƒplugin_typesé‚£æ ·å»å…¨å±€é…ç½®ï¼Œä½†æ˜¯ä¸éœ€è¦æä¾›ç»™åˆ«çš„åœ°æ–¹ä½¿ç”¨

### 5.x.g6.min.js ç‰ˆæœ¬

è¿™ä¸ªç‰ˆæœ¬æ”¯æŒ  htmlèŠ‚ç‚¹ï¼Œåˆšå¥½å¯ä»¥æ¸²æŸ“ä»£ç å—ï¼Œé‚£ä¹ˆå¦‚æœè¦å®ç°5ç‰ˆæœ¬çš„

1. **ç°æœ‰çš„ä»£ç éœ€è¦é‡æ„ä¸ºé€‚é…5ç‰ˆæœ¬çš„** è¿™ä¸€æ­¥å°±éš¾æå•Šï¼ï¼ï¼

   è¿™tmå¾—å¡ä¸€å‘¨å•Šï¼ï¼ï¼  ç°æœ‰çš„ä»£ç é€‚é…é—®é¢˜å¤ªå¤šï¼Œå°è¯•ä¸€ä¸‹4ç‰ˆæœ¬

2. å¦‚ä½•å°†æ¸²æŸ“çš„htmlå•ç‹¬åˆ°æ–°çš„é¡µé¢ï¼Ÿ

 











## ä»£ç å¤‡ä»½

### é’ˆå¯¹codeç±»å‹çš„æ¸²æŸ“  4ç‰ˆæœ¬

**è¯¥ç‰ˆæœ¬ä¸‹æ— æ³•ç›´æ¥æ¸²æŸ“html  ä½†æ˜¯graph.addShape  é‡Œé¢ä¸åŒ…å«htmlçš„æ¸²æŸ“**

```js
/**
 * ä½œè€…ï¼šgongxi
 * æ—¶é—´ï¼š2025-09-11
 * æ™ºèƒ½ä½“èŠ‚ç‚¹å›¾è¡¨ - ä¼˜åŒ–ä»£ç ï¼Œå‡å°‘å†—ä½™ï¼Œé™ä½è€¦åˆï¼ŒH5ç«¯é€‚é…ï¼Œæ”¯æŒHTMLå†…å®¹æ¸²æŸ“
 * ä¿æŒåŸæœ‰Canvasæ¸²æŸ“æ ·å¼å’Œäº¤äº’æ•ˆæœ
 */

require.config({
    paths: {
        jquery: '../../sys/jquery',
        system: '../../sys/system',
        layui: "../../layui-btkj/layui",
        layuicommon: "../../sys/layuicommon",
        g6: "../../plugin/antv/g6/4.x.g6.min"
    },
    shim: {
        "system": {
            deps: ["jquery"]
        },
        "layui": {
            deps: ["jquery", "system"]
        },
        "layuicommon": {
            deps: ["jquery", "layui"]
        },
        "g6": {
            deps: ["jquery"]
        }
    },
    waitSeconds: 0
});

objdata = {
    // æ™ºèƒ½ä½“ID
    agent_id: null,

    // èŠ‚ç‚¹æ•°æ®å­˜å‚¨
    allNodeData: [],
    nodeRelationDataHTML: null,

    // å›¾è¡¨å®ä¾‹
    currentGraph: null,

    // é¡µé¢çŠ¶æ€
    isLoading: false,
    isInitialized: false,

    // æ‹–æ‹½çŠ¶æ€æ§åˆ¶
    isDragging: false,
    dragStartTime: 0,

    // ç‚¹å‡»è¿‡çš„èŠ‚ç‚¹è®°å½•
    clickedNodes: new Set(),

    // åœ°å€æ ä¼ é€’
    applicable: {
        applicable_end: '',
        applicable_role: ''
    },
    pointType: '',

    // è®¾å¤‡ç±»å‹æ£€æµ‹
    isMobile: false,
    isTouch: false
};

// æ’ä»¶ç±»å‹é…ç½® - é›†ä¸­ç®¡ç†é¢œè‰²å’Œæ ·å¼
const PLUGIN_TYPES = {
    superlink: {
        name: 'è¶…é“¾æ¥',
        bgColor: '#e6f7ff',
        borderColor: '#1890ff',
        textColor: '#1890ff',
        rendering: 'html'   // èŠ‚ç‚¹ç±»å‹ html
    },
    http: {
        name: 'HTTPè¯·æ±‚',
        bgColor: '#fff7e6',
        borderColor: '#fa8c16',
        textColor: '#fa8c16',
        rendering: 'html'
    },
    code: {
        name: 'ä»£ç æ‰§è¡Œ',
        bgColor: '#f6ffed',
        borderColor: '#52c41a',
        textColor: '#52c41a',
        rendering: 'html'   // æ”¯æŒHTMLæ¸²æŸ“
    },
    function: {
        name: 'å‡½æ•°è°ƒç”¨',
        bgColor: '#f9f0ff',
        borderColor: '#722ed1',
        textColor: '#722ed1',
        rendering: 'html'
    },
    default: {
        name: 'é»˜è®¤å†…å®¹',
        bgColor: 'transparent',
        borderColor: 'transparent',
        textColor: '#666'
    }
};

// é»˜è®¤å›¾ç‰‡è·¯å¾„é…ç½®ï¼Œæ—¢æ²¡æœ‰logo ä¹Ÿæ²¡æœ‰æ’ä»¶çš„æƒ…å†µä¸‹ä½¿ç”¨ï¼Œé¿å…å¤§ç©ºç™½
const DEFAULT_LOGO_PATH = '../../images/agentimg/agentimg.jpg';

require(["jquery", "system", "layui"], function () {
    layui.use(['layer'], function () {
        // è®¾å¤‡æ£€æµ‹
        detectDevice();
        // åˆå§‹åŒ–é¡µé¢
        initNodeGraph();
        initEventListeners();
    });
});

/**
 * è®¾å¤‡æ£€æµ‹
 */
function detectDevice() {
    objdata.isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
    objdata.isTouch = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
}

/**
 * åˆå§‹åŒ–èŠ‚ç‚¹å›¾è¡¨ - ä¸»å…¥å£å‡½æ•°
 */
function initNodeGraph() {
    // è·å–URLå‚æ•°ä¸­çš„agent_id
    const agentId = Arg("agent_id") || Arg("id");
    const pointType = Arg("pointType");
    const applicable_end = Arg("applicable_end");
    const applicable_role = Arg("applicable_role");
    objdata.pointType = pointType;
    objdata.applicable.applicable_end = [applicable_end];
    objdata.applicable.applicable_role = [applicable_role];

    if (!agentId) {
        showEmptyState('ç¼ºå°‘å¿…è¦å‚æ•°ï¼šagent_id');
        return;
    }

    objdata.agent_id = agentId;

    // æ ¹æ®ç«¯ç±»å‹è®¾ç½®èƒŒæ™¯æ ·å¼
    setBackgroundStyle();

    // åŠ è½½èŠ‚ç‚¹æ•°æ®
    loadNodeData();
}

/**
 * è®¾ç½®èƒŒæ™¯æ ·å¼ - æ ¹æ®ç«¯ç±»å‹é€‚é…
 */
function setBackgroundStyle() {
    const container = $('.graph-canvas');

    if (objdata.pointType === 'H5' || objdata.isMobile) {
        // H5ç«¯ä½¿ç”¨æ–¹æ ¼çº¿
        container.css({
            'background': `        
                linear-gradient(90deg, rgba(0,0,0,0.1) 1px, transparent 1px),
                linear-gradient(180deg, rgba(0,0,0,0.1) 1px, transparent 1px)`,
            'background-size': '20px 20px',
            'background-position': '0 0, 0 10px, 10px -10px, -10px 0px'
        });
    } else {
        // Webç«¯ä¿æŒåŸæœ‰ç½‘æ ¼èƒŒæ™¯
        container.css({
            'background': `linear-gradient(45deg, #f8f9fa 25%, transparent 25%),
                          linear-gradient(-45deg, #f8f9fa 25%, transparent 25%),
                          linear-gradient(45deg, transparent 75%, #f8f9fa 75%),
                          linear-gradient(-45deg, transparent 75%, #f8f9fa 75%)`,
            'background-size': '20px 20px',
            'background-position': '0 0, 0 10px, 10px -10px, -10px 0px'
        });
    }
}

/**
 * åŠ è½½èŠ‚ç‚¹æ•°æ® - ç»Ÿä¸€æ•°æ®åŠ è½½æ–¹å¼
 */
function loadNodeData() {
    showLoading();

    let data = {
        "agent_id": [objdata.agent_id]
    };

    $.sm(function (re, err) {
        if (err) {
            hideLoading();
            layer.msg(err);
            showEmptyState('åŠ è½½èŠ‚ç‚¹æ•°æ®å¤±è´¥ï¼Œè¯·é‡è¯•');
        } else {
            objdata.allNodeData = re || [];
            // å‡†å¤‡å…³ç³»æ•°æ®å¹¶æ¸²æŸ“å›¾è¡¨
            prepareAndRenderGraph();
        }
    }, ["w_agent_node_plugin.getList", $.msgwhere(data)]);
}

/**
 * å‡†å¤‡æ•°æ®å¹¶æ¸²æŸ“å›¾è¡¨
 */
function prepareAndRenderGraph() {
    // å‡†å¤‡èŠ‚ç‚¹å…³ç³»æ•°æ®
    objdata.nodeRelationDataHTML = prepareRelationDataHTML(objdata.allNodeData);

    hideLoading();

    if (!objdata.nodeRelationDataHTML || objdata.nodeRelationDataHTML.nodes.length === 0) {
        showEmptyState('è¯¥æ™ºèƒ½ä½“æš‚æ— èŠ‚ç‚¹æ•°æ®');
        return;
    }

    // åŠ¨æ€åŠ è½½ G6 åº“å¹¶åˆ›å»ºå…³ç³»å›¾
    require(['g6'], function(G6) {
        createNodeRelationGraph(G6, objdata.nodeRelationDataHTML);
        hideEmptyState();
        updateNodeCount();
        objdata.isInitialized = true;
    });
}

/**
 * å‡†å¤‡èŠ‚ç‚¹å…³ç³»æ•°æ®
 */
function prepareRelationDataHTML(nodeList) {
    if (!nodeList || nodeList.length === 0) {
        return { nodes: [], edges: [] };
    }

    const nodes = [];
    const edges = [];
    const nodeMap = new Map();

    // åˆ›å»ºèŠ‚ç‚¹æ˜ å°„
    nodeList.forEach(node => {
        nodeMap.set(node.id, node);
    });

    // ç”ŸæˆèŠ‚ç‚¹æ•°æ® - æ ¹æ®plugin_typeé€‰æ‹©ä¸åŒçš„æ¸²æŸ“æ–¹å¼
    nodeList.forEach(node => {
        const nodeName = node.node_name || `èŠ‚ç‚¹${node.id}`;
        const nodeSize = (objdata.pointType === 'H5' || objdata.isMobile) ? [180, 140] : [220, 180];

        let nodeConfig = {
            id: node.id.toString(),
            label: nodeName,
            size: nodeSize,
            nodeData: node,
        };

        // æ ¹æ®æ’ä»¶ç±»å‹è®¾ç½®ä¸åŒçš„æ¸²æŸ“æ–¹å¼
        if (node.plugin_type === 'code') {
            console.log('code node:', node);
            // codeç±»å‹ä½¿ç”¨HTMLæ¸²æŸ“
            nodeConfig.type = 'html';
            nodeConfig.style = {
                dx:-120,
                dy:-40,
                innerHTML:getCodeNodeHtmlContent(node)
            };
        } else {
            // å…¶ä»–ç±»å‹ä½¿ç”¨Canvasæ¸²æŸ“
            nodeConfig.type = 'custom-node';
            nodeConfig.style = {
                fill: 'transparent',
                stroke: 'transparent'
            };
        }

        nodes.push(nodeConfig);
    });

    nodeList.forEach(node => {
        if (node.parent_id && node.parent_id !== '0' && nodeMap.has(parseInt(node.parent_id))) {
            edges.push({
                source: node.parent_id.toString(),
                target: node.id.toString(),
                type: 'cubic-horizontal',
                style: {
                    stroke: '#1890ff',
                    lineWidth: 2,
                    strokeOpacity: 0.8,
                    endArrow: {
                        path: 'M 0,0 L 8,4 L 8,-4 Z',
                        fill: '#1890ff',
                        strokeOpacity: 1
                    }
                }
            });
        }
    });

    return { nodes, edges };
}

/**
 * è·å–ä»£ç èŠ‚ç‚¹çš„HTMLå†…å®¹ - ç‹¬ç«‹å‡½æ•°ï¼Œé™ä½è€¦åˆ
 */
function getCodeNodeHtmlContent(nodeData) {
    const pluginConfig = getPluginTypeConfig(nodeData.plugin_type);
    const isDisabled = nodeData.status !== 0;
    const hasPermission = checkNodePermission(nodeData);
    // const selectedTime = getUserSelectedTime();

    // è·å–æœ€æ–°çš„å†…å®¹æ•°æ®
    // const contentData = getLatestCodeContent(nodeData.pld, nodeData.plugin_id, selectedTime);

    const nodeId = nodeData.id;
    const nodeTitle = nodeData.node_name || `èŠ‚ç‚¹${nodeId}`;
    const language = 'html';

    return `
        <div class="html-code-node" 
             data-node-id="${nodeId}"
             data-pld="${nodeData.pld || ''}"
             data-plugin-id="${nodeData.plugin_id || ''}"
             data-selected-time=""
             style="
                width: 100%;
                height: 100%;
                background: ${isDisabled || !hasPermission ? '#f5f5f5' : '#fff'};
                border: 2px solid ${isDisabled || !hasPermission ? '#e8e8e8' : pluginConfig.borderColor};
                border-radius: 6px;
                overflow: hidden;
                opacity: ${isDisabled || !hasPermission ? 0.6 : 1};
                pointer-events: ${hasPermission && !isDisabled ? 'auto' : 'none'};
                box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
                cursor: ${hasPermission && !isDisabled ? 'pointer' : 'not-allowed'};
                display: flex;
                flex-direction: column;
             "
<!--             onclick="handleHtmlNodeClick('${nodeId}')">-->
            
            <!-- èŠ‚ç‚¹æ ‡é¢˜æ  -->
            <div class="node-header" style="
                padding: 8px 12px;
                background: ${pluginConfig.bgColor || '#f0f0f0'};
                border-bottom: 1px solid ${pluginConfig.borderColor};
                font-weight: bold;
                font-size: 12px;
                color: ${isDisabled || !hasPermission ? '#999' : '#0a0a0a'};
                display: flex;
                justify-content: space-between;
                align-items: center;
                min-height: 30px;
            ">
                <span class="node-title" title="${nodeTitle}">${nodeTitle.length > 15 ? nodeTitle.substring(0, 15) + '...' : nodeTitle}</span>
                <div class="node-badges">
                    <span class="language-badge" style="
                        background: ${pluginConfig.textColor};
                        color: #fff;
                        padding: 2px 6px;
                        border-radius: 3px;
                        font-size: 9px;
                        margin-right: 4px;
                    ">${language.toUpperCase()}</span>
                    <span class="html-icon">ğŸŒ</span>
                    ${!hasPermission ? '<span class="lock-icon">ğŸ”’</span>' : ''}
                </div>
            </div>
            
            <!-- å†…å®¹åŒºåŸŸ -->
            <div class="node-content" style="
                flex: 1;
                padding: 10px;
                overflow: auto;
                font-size: 11px;
                line-height: 1.4;
            ">
                ${nodeData.content}
            </div>
            
            <!-- æ—¶é—´æ ‡è¯† -->
            <div class="time-indicator" style="
                padding: 4px 8px;
                background: rgba(0,0,0,0.05);
                border-top: 1px solid rgba(0,0,0,0.1);
                font-size: 9px;
                color: #666;
                text-align: right;
            ">

            </div>
        </div>
    `;
}

/**
 * æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æœ‰æƒé™è®¿é—®èŠ‚ç‚¹
 */
function checkNodePermission(nodeData) {
    console.log(objdata.applicable)
    // å¦‚æœèŠ‚ç‚¹æ²¡æœ‰æƒé™é…ç½®ï¼Œé»˜è®¤å…è®¸è®¿é—®
    if (!nodeData.applicable_end && !nodeData.applicable_role) {
        return true;
    }
    // èŠ‚ç‚¹çš„é€‚ç”¨ç«¯å’Œé€‚ç”¨è§’è‰²ä¸ºå…¨éƒ¨,ä¹Ÿè¿”å› true
    if (nodeData.applicable_end === 'å…¨éƒ¨' && nodeData.applicable_role === 'å…¨éƒ¨') {
        return true;
    }

    let hasEndPermission = true;
    let hasRolePermission = true;

    // æ£€æŸ¥ç«¯æƒé™
    if (nodeData.applicable_end) {
        const nodeEnds = nodeData.applicable_end.split(',').map(item => item.trim());
        hasEndPermission = nodeEnds.some(end => objdata.applicable.applicable_end.includes(end));
    }

    // æ£€æŸ¥è§’è‰²æƒé™
    if (nodeData.applicable_role) {
        const nodeRoles = nodeData.applicable_role.split(',').map(item => item.trim());
        hasRolePermission = nodeRoles.some(role => objdata.applicable.applicable_role.includes(role));
    }

    return hasEndPermission && hasRolePermission;
}

/**
 * è·å–æ’ä»¶ç±»å‹é…ç½®
 */
function getPluginTypeConfig(pluginType) {
    return PLUGIN_TYPES[pluginType] || PLUGIN_TYPES.default;
}

/**
 * åˆ¤æ–­æ˜¯å¦åº”è¯¥æ˜¾ç¤ºlogoå›¾ç‰‡
 */
function shouldShowLogo(nodeData) {
    // å¦‚æœpldä¸º0ä¸”logoä¸ºç©ºæˆ–0ï¼Œæ˜¾ç¤ºé»˜è®¤å›¾ç‰‡
    if (nodeData.pld === 0 &&  nodeData.logo === '') {
        return { showLogo: true, logoPath: DEFAULT_LOGO_PATH };
    }

    // å¦‚æœlogoä¸æ˜¯çº¯æ•°å­—ï¼Œæ˜¾ç¤ºè‡ªå®šä¹‰logo
    if (nodeData.logo && !nodeData.logo.toString().match(/^\d+$/)) {
        return { showLogo: true, logoPath: ossPrefix + nodeData.logo };
    }

    return { showLogo: false, logoPath: null };
}

/**
 * æ¸²æŸ“æ’ä»¶å†…å®¹åŒºåŸŸ
 */
function renderPluginContent(group, nodeData, contentY, width, height, titleHeight, isDisabled) {
    const contentHeight = height - titleHeight;
    const pluginConfig = getPluginTypeConfig(nodeData.plugin_type);

    // æ£€æŸ¥æ˜¯å¦éœ€è¦æ˜¾ç¤ºlogo
    const logoInfo = shouldShowLogo(nodeData);

    if (logoInfo.showLogo) {
        // æ˜¾ç¤ºlogoå›¾ç‰‡
        group.addShape('image', {
            attrs: {
                x: -width / 2,
                y: contentY,
                width: width,
                height: contentHeight,
                img: logoInfo.logoPath,
                cursor: !isDisabled ? 'pointer' : 'not-allowed',
                radius: 8,
                opacity: isDisabled ? 0.6 : 1
            },
            name: 'logo-image'
        });
        return;
    }

    // æ ¹æ®æ’ä»¶ç±»å‹æ¸²æŸ“ä¸åŒå†…å®¹
    if (nodeData.plugin_type && nodeData.plugin_type !== 'default') {
        // todo å°±æ¸²æŸ“å¯¹åº”çš„æ–‡æœ¬å°±è¡Œ

    } else {
        // é»˜è®¤å†…å®¹æ¸²æŸ“
        renderDefaultContent(group, nodeData, pluginConfig, contentY, contentHeight, isDisabled);
    }
}

/**
 * æ£€æµ‹æ˜¯å¦ä¸ºHTMLå†…å®¹
 */
function isHtmlContent(content) {
    if (!content) return false;
    const htmlRegex = /<[^>]+>/;
    return htmlRegex.test(content);
}




/**
 * æ¸²æŸ“é»˜è®¤å†…å®¹
 */
function renderDefaultContent(group, nodeData, pluginConfig, contentY, contentHeight, isDisabled) {
    let displayText = '';
    if (nodeData.pld === 0) {
        displayText = 'é»˜è®¤å†…å®¹';
    } else {
        displayText = nodeData.content ?
            (nodeData.content.length > 25 ? nodeData.content.substring(0, 25) + '...' : nodeData.content) :
            'æ— å†…å®¹';
    }

    group.addShape('text', {
        attrs: {
            x: 0,
            y: contentY + contentHeight / 2,
            text: displayText,
            fontSize: (objdata.pointType === 'H5' || objdata.isMobile) ? 9 : 11,
            fill: isDisabled ? '#999' : pluginConfig.textColor,
            textAlign: 'center',
            textBaseline: 'middle',
            cursor: 'pointer',
        },
        name: 'content-text'
    });
}

function renderNodeTitle(group, cfg, width, height, titleHeight, strokeColor, hasPermission, isDisabled) {
    // èŠ‚ç‚¹åç§°èƒŒæ™¯
    group.addShape('rect', {
        attrs: {
            x: -width / 2,
            y: height / 2 - titleHeight,
            width: width,
            height: titleHeight,
            cursor: hasPermission && !isDisabled ? 'pointer' : 'not-allowed',
            stroke: strokeColor,
            opacity: isDisabled || !hasPermission ? 0.6 : 1
        },
        name: 'name-bg'
    });

    // èŠ‚ç‚¹åç§°æ–‡æœ¬
    group.addShape('text', {
        attrs: {
            x: 0,
            y: height / 2 - titleHeight / 2,
            text: cfg.label,
            fontSize: (objdata.pointType === 'H5' || objdata.isMobile) ? 10 : 12,
            fontWeight: 'bold',
            fill: isDisabled || !hasPermission ? '#999' : '#0a0a0a',
            textAlign: 'center',
            textBaseline: 'middle',
            cursor: hasPermission && !isDisabled ? 'pointer' : 'not-allowed'
        },
        name: 'name-text'
    });
}

/**
 * åˆ›å»ºèŠ‚ç‚¹å…³ç³»å›¾
 */
function createNodeRelationGraph(G6, data) {
    const container = $('#nodeGraphContainer');

    // é”€æ¯ç°æœ‰å›¾è¡¨å®ä¾‹
    if (objdata.currentGraph && !objdata.currentGraph.destroyed) {
        objdata.currentGraph.destroy();
    }

    // æ³¨å†Œè‡ªå®šä¹‰èŠ‚ç‚¹
    G6.registerNode('custom-node', {
        draw(cfg, group) {
            const nodeData = cfg.nodeData;
            const size = cfg.size || [220, 180];
            const width = size[0];
            const height = size[1];

            // èŠ‚ç‚¹çŠ¶æ€
            const isDisabled = nodeData.status !== 0;
            const hasPermission = checkNodePermission(nodeData);
            const isClicked = objdata.clickedNodes.has(nodeData.id.toString());

            // åˆ›å»ºä¸»å®¹å™¨
            const shadowColor = isClicked ? 'rgba(82, 196, 26, 0.8)' : 'rgba(24, 144, 255, 0.6)';
            const strokeColor = isDisabled || !hasPermission ? '#e8e8e8' : '#12ecb2';

            const mainRect = group.addShape('rect', {
                attrs: {
                    x: -width / 2,
                    y: -height / 2,
                    width: width,
                    height: height,
                    fill: isDisabled || !hasPermission ? '#f5f5f5' : '#fff',
                    stroke: strokeColor,
                    strokeWidth: 1,
                    cursor: hasPermission && !isDisabled ? 'pointer' : 'not-allowed',
                    shadowColor: shadowColor,
                    shadowBlur: 8,
                    shadowOffsetX: 2,
                    shadowOffsetY: 2,
                    radius: 4,
                    opacity: isDisabled || !hasPermission ? 0.8 : 1
                },
                name: 'main-rect'
            });

            // å†…å®¹åŒºåŸŸ
            const contentY = -height / 2;
            const titleHeight = (objdata.pointType === 'H5' || objdata.isMobile) ? 25 : 30;

            group.addShape('rect', {
                attrs: {
                    x: -width / 2,
                    y: contentY,
                    width: width,
                    height: height - titleHeight,
                    strokeWidth: 1,
                    cursor: hasPermission && !isDisabled ? 'pointer' : 'not-allowed',
                    textAlign: 'center',
                },
                name: 'content-bg'
            });

            // æ¸²æŸ“æ’ä»¶å†…å®¹
            renderPluginContent(group, nodeData, contentY, width, height, titleHeight, isDisabled || !hasPermission);
            // æ¸²æŸ“èŠ‚ç‚¹åç§°
            renderNodeTitle(group, cfg, width, height, titleHeight, strokeColor, hasPermission, isDisabled);

            // å¦‚æœæ²¡æœ‰æƒé™ï¼Œæ·»åŠ é”å®šå›¾æ ‡
            if (!hasPermission) {
                group.addShape('text', {
                    attrs: {
                        x: width / 2 - 10,
                        y: -height / 2 + 10,
                        text: 'ğŸ”’',
                        fontSize: (objdata.pointType === 'H5' || objdata.isMobile) ? 20 : 26,
                        textAlign: 'center',
                        textBaseline: 'middle',
                    },
                    name: 'lock-icon'
                });
            }

            return mainRect;
        }
    });

    // è·å–å›¾è¡¨é…ç½® - ä¿æŒåŸæœ‰Canvasæ¸²æŸ“
    const graphConfig = getGraphConfig(container);

    // åˆ›å»º G6 å›¾å®ä¾‹
    const graph = new G6.Graph(graphConfig);

    // å­˜å‚¨å›¾è¡¨å®ä¾‹
    objdata.currentGraph = graph;

    // ç»‘å®šäº‹ä»¶
    bindGraphEvents(graph);

    // æ¸²æŸ“æ•°æ®
    graph.data(data);
    graph.render();

    // å»¶è¿Ÿæ‰§è¡Œè‡ªé€‚åº”ç”»å¸ƒ
    setTimeout(() => {
        if (graph && !graph.destroyed) {
            graph.fitView(30);
        }
    }, 300);

    // å“åº”å¼å¤„ç†
    initGraphResize(graph);
}

/**
 * è·å–å›¾è¡¨é…ç½®
 */
function getGraphConfig(container) {
    const isMobileDevice = objdata.pointType === 'H5' || objdata.isMobile;

    return {
        container: container[0],
        width: container[0].clientWidth || 800,
        height: container[0].clientHeight || 600,
        renderer: 'canvas',  // ä¿æŒCanvasæ¸²æŸ“
        pixelRatio: window.devicePixelRatio || 2,
        modes: {
            default: isMobileDevice ? [
                'drag-canvas',
                'zoom-canvas'
            ] : [
                'drag-canvas',
                'zoom-canvas',
                'drag-node'  // ä¿æŒèŠ‚ç‚¹æ‹–æ‹½åŠŸèƒ½
            ]
        },
        defaultNode: {
            type: 'custom-node',
            size: isMobileDevice ? [180, 120] : [220, 120]
        },
        defaultEdge: {
            type: 'polyline',
            style: {
                stroke: '#1890ff',
                lineWidth: 2,
                strokeOpacity: 0.8,
                endArrow: {
                    path: 'M 0,0 L 8,4 L 8,-4 Z',
                    fill: '#1890ff'
                }
            }
        },
        layout: {
            type: 'dagre',
            rankdir: objdata.pointType === 'H5' ? 'TB': 'LR' ,
            align: 'DL',
            nodesep: isMobileDevice ? 60 : 80,
            ranksep: isMobileDevice ? 80 : 120
        },
        fitView: true,
        fitViewPadding: isMobileDevice ? [20, 20, 20, 20] : [30, 30, 30, 30]
    };
}

/**
 * ç»‘å®šå›¾è¡¨äº‹ä»¶
 */
function bindGraphEvents(graph) {
    // èŠ‚ç‚¹ç‚¹å‡»äº‹ä»¶ - ä¼˜åŒ–ç§»åŠ¨ç«¯æ”¯æŒ
    const clickEvent = objdata.isTouch ? 'node:touchstart' : 'node:click';

    graph.on(clickEvent, function(e) {
        // é¿å…æ‹–æ‹½æ—¶è§¦å‘ç‚¹å‡» - å¢åŠ æ—¶é—´åˆ¤æ–­
        const timeSinceDragStart = Date.now() - objdata.dragStartTime;
        if (objdata.isDragging && timeSinceDragStart > 200) return;

        const nodeModel = e.item.getModel();
        const nodeData = nodeModel.nodeData;

        // æ£€æŸ¥æƒé™
        const hasPermission = checkNodePermission(nodeData);
        if (!hasPermission) {
            layer.msg('æ‚¨æ²¡æœ‰æƒé™è®¿é—®æ­¤èŠ‚ç‚¹');
            return;
        }

        // æ£€æŸ¥èŠ‚ç‚¹çŠ¶æ€
        if (nodeData.status !== 0) {
            layer.msg('è¯¥èŠ‚ç‚¹æš‚ä¸å¯ç”¨');
            return;
        }

        selectedNode(nodeData, e.item);
    });

    // ç»Ÿä¸€å¤„ç†æ‹–æ‹½äº‹ä»¶ï¼ˆPCç«¯å’Œç§»åŠ¨ç«¯ï¼‰
    graph.on('node:dragstart', function() {
        objdata.isDragging = true;
        objdata.dragStartTime = Date.now();
    });

    graph.on('node:dragend', function() {
        // å»¶è¿Ÿé‡ç½®æ‹–æ‹½çŠ¶æ€ï¼Œé¿å…ç‚¹å‡»äº‹ä»¶è¯¯è§¦å‘
        setTimeout(() => {
            objdata.isDragging = false;
        }, 150);
    });

    // ç§»åŠ¨ç«¯ç‰¹æ®Šå¤„ç†
    if (objdata.isTouch) {
        // é˜²æ­¢é•¿æŒ‰é€‰æ‹©æ–‡æœ¬
        graph.on('node:touchstart', function(e) {
            e.preventDefault();
        });

        // å¤„ç†åŒå‡»ç¼©æ”¾
        let lastTapTime = 0;
        graph.on('canvas:touchstart', function(e) {
            const currentTime = Date.now();
            const tapLength = currentTime - lastTapTime;
            if (tapLength < 500 && tapLength > 0) {
                // åŒå‡»ç¼©æ”¾
                const point = { x: e.canvasX, y: e.canvasY };
                const currentZoom = graph.getZoom();
                const targetZoom = currentZoom < 1.5 ? 2 : 1;
                graph.zoomTo(targetZoom, point);
            }
            lastTapTime = currentTime;
        });
    }

    // ç”»å¸ƒæ‹–æ‹½ä¼˜åŒ–
    graph.on('canvas:dragstart', function() {
        objdata.isDragging = true;
    });

    graph.on('canvas:dragend', function() {
        setTimeout(() => {
            objdata.isDragging = false;
        }, 100);
    });
}

/**
 * é€‰æ‹©èŠ‚ç‚¹
 */
function selectedNode(nodeData, nodeItem) {
    // è®°å½•èŠ‚ç‚¹è¢«ç‚¹å‡»è¿‡
    objdata.clickedNodes.add(nodeData.id.toString());

    // æ›´æ–°é€‰ä¸­çŠ¶æ€ï¼ˆå¦‚æœéœ€è¦çš„è¯ï¼‰
    if (objdata.currentGraph) {
        // é‡ç½®æ‰€æœ‰èŠ‚ç‚¹æ ·å¼
        objdata.currentGraph.getNodes().forEach(node => {
            objdata.currentGraph.updateItem(node, {
                style: {
                    stroke: '#e8e8e8',
                    strokeWidth: 1
                }
            });
        });

        // é«˜äº®é€‰ä¸­èŠ‚ç‚¹
        objdata.currentGraph.updateItem(nodeItem, {
            style: {
                stroke: '#1890ff',
                strokeWidth: 3
            }
        });

        // é‡æ–°æ¸²æŸ“ä»¥æ›´æ–°èŠ‚ç‚¹çš„é˜´å½±é¢œè‰²
        setTimeout(() => {
            objdata.currentGraph.refresh();
        }, 100);
    }

    // å­˜å‚¨ç‚¹å‡»æ—¥å¿—
    saveNodeClickLog(nodeData);

    // è·³è½¬å¤„ç†æ ¹æ®ä¸åŒç±»å‹èŠ‚ç‚¹è¿›è¡Œä¸åŒæ“ä½œ
    handleNodeAction(nodeData);

    // å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ æ›´å¤šçš„èŠ‚ç‚¹é€‰æ‹©é€»è¾‘
    showNodeDetails(nodeData);
}

function saveNodeClickLog(nodeData) {
    $.sm(function (re, err) {
        if (err) {
            console.log(err);
        } else {
            console.log(re);
        }
    }, ["node_click_log.add", JSON.stringify({
        agent_id: nodeData.agent_id,
        node_id: nodeData.id,
        oprid: "",
    })]);
}

/**
 * æ ¹æ®èŠ‚ç‚¹ç±»å‹å¤„ç†ä¸åŒçš„æ“ä½œ
 */
function handleNodeAction(nodeData) {
    switch (nodeData.plugin_type) {
        case 'superlink':
            if (nodeData.url) {
                // window.open(nodeData.url, '_blank');
            } else {
                layer.msg('è¯¥è¶…é“¾æ¥èŠ‚ç‚¹æš‚æ— URLé…ç½®');
            }
            break;

        case 'http':
            if (nodeData.api_url || nodeData.url) {
                const url = nodeData.api_url || nodeData.url;
                layer.confirm('æ˜¯å¦è¦è®¿é—®æ­¤HTTPæ¥å£ï¼Ÿ<br>' + url, {
                    icon: 3,
                    title: 'HTTPè¯·æ±‚'
                }, function(index) {
                    // window.open(url, '_blank');
                    layer.close(index);
                });
            } else {
                // showNodeDetails(nodeData);
            }
            break;

        case 'code':
            if (nodeData.url) {
                // window.open(nodeData.url, '_blank');
            } else {
                showCodeDetails(nodeData);
            }
            break;

        case 'function':
            if (nodeData.url) {
                // window.open(nodeData.url, '_blank');
            } else {
                showFunctionDetails(nodeData);
            }
            break;

        default:
            if (nodeData.url) {
                // window.open(nodeData.url, '_blank');
            } else {
                layer.msg('è¯¥èŠ‚ç‚¹æš‚æ— é…ç½®æ“ä½œ');
            }
            break;
    }
}

/**
 * æ˜¾ç¤ºèŠ‚ç‚¹è¯¦æƒ… - å¯æ‰©å±•åŠŸèƒ½åç»­çœ‹ä¸šåŠ¡éœ€ä¸éœ€è¦
 */
function showNodeDetails(nodeData) {
    // å¯ä»¥åœ¨è¿™é‡Œå®ç°èŠ‚ç‚¹è¯¦æƒ…å¼¹çª—ç­‰åŠŸèƒ½
    // console.log('èŠ‚ç‚¹è¯¦æƒ…:', nodeData);
}

/**
 * æ˜¾ç¤ºä»£ç è¯¦æƒ… - æ”¯æŒHTMLå†…å®¹æ˜¾ç¤º
 */
function showCodeDetails(nodeData) {
    const content = nodeData.content || 'æ— ä»£ç å†…å®¹';
    const isHtml = isHtmlContent(content);

    const contentHtml = `
        <div style="padding: 15px;">
            <h4>ä»£ç èŠ‚ç‚¹è¯¦æƒ…</h4>
            <p><strong>èŠ‚ç‚¹åç§°ï¼š</strong>${nodeData.node_name || 'æœªå‘½å'}</p>
            <p><strong>ç¼–ç¨‹è¯­è¨€ï¼š</strong>${nodeData.language || nodeData.code_language || 'æœªæŒ‡å®š'}</p>
            <p><strong>å†…å®¹ç±»å‹ï¼š</strong>${isHtml ? 'HTMLå†…å®¹' : 'ä»£ç å†…å®¹'}</p>
            <p><strong>${isHtml ? 'HTML' : 'ä»£ç '}å†…å®¹ï¼š</strong></p>
            <div style="
                background: #f5f5f5; 
                padding: 10px; 
                border-radius: 4px; 
                max-height: 300px; 
                overflow-y: auto;
                ${isHtml ? '' : 'font-family: monospace;'}
            ">
                ${isHtml ? content : content.replace(/</g, '&lt;').replace(/>/g, '&gt;')}
            </div>
        </div>
    `;

    layer.open({
        type: 1,
        title: 'ä»£ç èŠ‚ç‚¹',
        area: (objdata.pointType === 'H5' || objdata.isMobile) ? ['90%', '70%'] : ['600px', '450px'],
        content: contentHtml
    });
}

/**
 * æ˜¾ç¤ºå‡½æ•°è¯¦æƒ…
 */
function showFunctionDetails(nodeData) {
    const content = `
        <div style="padding: 15px;">
            <h4>å‡½æ•°èŠ‚ç‚¹è¯¦æƒ…</h4>
            <p><strong>èŠ‚ç‚¹åç§°ï¼š</strong>${nodeData.node_name || 'æœªå‘½å'}</p>
            <p><strong>å‡½æ•°åç§°ï¼š</strong>${nodeData.function_name || nodeData.func_name || 'æœªæŒ‡å®š'}</p>
            <p><strong>å‡½æ•°æè¿°ï¼š</strong></p>
            <div style="background: #f5f5f5; padding: 10px; border-radius: 4px; max-height: 200px; overflow-y: auto;">
                ${nodeData.content || nodeData.description || 'æ— å‡½æ•°æè¿°'}
            </div>
        </div>
    `;

    layer.open({
        type: 1,
        title: 'å‡½æ•°èŠ‚ç‚¹',
        area: (objdata.pointType === 'H5' || objdata.isMobile) ? ['90%', '60%'] : ['500px', '350px'],
        content: content
    });
}

/**
 * å›¾è¡¨å“åº”å¼å¤„ç†
 */
function initGraphResize(graph) {
    const resizeHandler = () => {
        if (!graph || graph.destroyed) return;

        const container = $('#nodeGraphContainer')[0];
        if (!container || !container.clientWidth || !container.clientHeight) return;

        graph.changeSize(container.clientWidth, container.clientHeight);
        graph.fitView(30);
    };

    window.addEventListener('resize', resizeHandler);

    // é¡µé¢å¸è½½æ—¶æ¸…ç†
    $(window).on('beforeunload', function() {
        window.removeEventListener('resize', resizeHandler);
        if (graph && !graph.destroyed) {
            graph.destroy();
        }
    });
}

/**
 * åˆå§‹åŒ–äº‹ä»¶ç›‘å¬å™¨
 */
function initEventListeners() {
    // çª—å£å¤§å°æ”¹å˜æ—¶é‡æ–°è®¡ç®—å¸ƒå±€
    $(window).on('resize', function() {
        if (objdata.currentGraph && !objdata.currentGraph.destroyed) {
            const container = $('#nodeGraphContainer')[0];
            if (container) {
                objdata.currentGraph.changeSize(container.clientWidth, container.clientHeight);
                objdata.currentGraph.fitView(30);
            }
        }
    });
}

/**
 * é¡µé¢çŠ¶æ€ç®¡ç†å‡½æ•°
 */

function showLoading() {
    objdata.isLoading = true;
    $('#loadingOverlay').show();
}

function hideLoading() {
    objdata.isLoading = false;
    $('#loadingOverlay').hide();
}

function showEmptyState(message = 'æš‚æ— èŠ‚ç‚¹æ•°æ®') {
    $('#emptyState').show();
    $('#emptyState .empty-text').text(message);
    updateNodeCount();
}

function hideEmptyState() {
    $('#emptyState').hide();
}

function updateNodeCount() {
    const count = objdata.allNodeData ? objdata.allNodeData.length : 0;
    const name = objdata.pointType === 'H5' ?  'æµç¨‹':'èŠ‚ç‚¹' ;
    $('#nodeCount').text(`å…± ${count} ä¸ª ${name}`);
}
```

### é€‚é…5ç‰ˆæœ¬çš„G6

















